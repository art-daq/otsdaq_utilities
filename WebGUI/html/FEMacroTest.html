<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>FE Macros</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<style type="text/css">			

		/*fix margin for this page in Multi-Select (must have changed because of font/font-size)*/ 
		.multiselectbox input, textarea {
			margin: 			14px 5px 5px 12px;
		}

		/* make buttons and inputs have a hand cursor */
		input, button, select, a {
			cursor: 			pointer;
		}
	
		#popUpDialog {
			position: 			absolute;
			z-index: 			1000;    
			border: 			1px solid #770000;
		    background-color: 	#efeaea;
		    text-align: 		center;
		    padding: 			10px;
		}
		

		#clearDiv {
			clear: 				both;
		}
		
		#display {
			padding: 			0;
		}
		
		#macroModulesTable, .macroModuleTable {
			border:				0;
		}
		.macroModule {
			border:				1px solid grey;
			padding:			10px;
		}
		
		td {
			white-space: 		nowrap;
			vertical-align:		top;
		}
		
		.macroOutputName, .macroInputName  {
			font-weight:		bold;
		}
		
		
	</style>
	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	
	<script>		
		
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:		
			//htmlOpen(tag,attObj,innerHTML,closeTag)
			//htmlClearDiv()	
			//init()	
			//runMacro(r,c)
			//getDateString(date)
			//redraw()
			//handleSelectedFEClass(r,c)
			//handleSelectedFEUID(r,c)
			//handleSelectedMacroType(r,c)
			//handleSelectedMacroName(r,c)

		var feClassToFEsMap_; 	//map of FE Classes to FE UIDs
		var feToMacrosMap_;		//map of FE UIDs to FE Macro structure 
			//{requiredPermissions,inputs,outputs,supervisor,lid, feClass}
		var publicMacros_;		//map of macro name to macro structure
			//{requiredPermissions,inputs,outputs}
		var privateMacros_;		//map of macro name to macro structure
			//{requiredPermissions,inputs,outputs}
		
		var macroModuleLayoutString_ = "" ; //row,
											//col,
											//class or *,
											//UID or *,
											//macroType:=fe|public|private:username,
											//macroName;
		//macroModuleLayoutString_ += "0,1,DTCFrontEndInterface,ExampleInterface0,fe,ROC_Read;";
		//macroModuleLayoutString_ += "1,0,DTCFrontEndInterface,*,private,testPrivate;";
		
		macroModuleLayoutString_ += "0,0,*,*,fe,;";
		macroModuleLayoutString_ += "1,0,*,*,fe,;";
		macroModuleLayoutString_ += "0,1,*,*,fe,;";
		macroModuleLayoutString_ += "1,1,*,*,fe,;";
		
		var macroModules_; //row col to module struct
			//			macroModules_[r][c]["feClassSelected"] = feClassSelected;
			//			macroModules_[r][c]["feUIDSelected"] = feUIDSelected;
			//			macroModules_[r][c]["feMacroTypeSelected"] = feMacroTypeSelected;
			//			macroModules_[r][c]["feMacroNameSelected"] = feMacroNameSelected;
		var layoutMaxRow_, layoutMaxCol_;

		var MACRO_TYPE_FE_ 			= "fe";
		var MACRO_TYPE_PUBLIC_ 		= "public";
		var MACRO_TYPE_PRIVATE_ 	= "private";
		var MACRO_TYPES_ = {
				"FE Macro Function" : 			MACRO_TYPE_FE_,
				"Public MacroMaker Macro" : 	MACRO_TYPE_PUBLIC_,
				"Private MacroMaker Macro" :	MACRO_TYPE_PRIVATE_,
		};
		var MAP_FROM_LAYOUT_TO_MACRO_TYPES_ = {}
		MAP_FROM_LAYOUT_TO_MACRO_TYPES_[MACRO_TYPE_FE_] 		= 0;
		MAP_FROM_LAYOUT_TO_MACRO_TYPES_[MACRO_TYPE_PUBLIC_] 	= 1;
		MAP_FROM_LAYOUT_TO_MACRO_TYPES_[MACRO_TYPE_PRIVATE_] 	= 2;
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////


		//=====================================================================================
		//htmlOpen ~~		
		//	tab name and attribute/value map object
		function htmlOpen(tag,attObj,innerHTML,doCloseTag)
		{
			var str = "";
			var attKeys = attObj?Object.keys(attObj):[]; 
			str += "<" + tag + " ";
			for(var i=0;i<attKeys.length;++i)
				str += " " + attKeys[i] + "='" +
				attObj[attKeys[i]] + "' ";
			str += ">";
			if(innerHTML) str += innerHTML;
			if(doCloseTag)
				str += "</" + tag + ">";
			return str;
		} // end htmlOpen()

		//=====================================================================================
		//htmlClearDiv ~~		
		function htmlClearDiv()
		{
			return "<div id='clearDiv'></div>";
		} //end htmlClearDiv()
		
		
		//=====================================================================================
		//init ~~
		//init called once body has loaded
		function init() 
		{			
	
			Debug.log("CfgGUI init ");
	
	
			//get FE Macros
			DesktopContent.XMLHttpRequest("Request?RequestType=getFEMacroList", "", 
					function (req) 
					{			

				var str = "";

				//var user = DesktopContent.getXMLValue(req,"UserDisplayName");
				//Debug.log("user = " + user);

				var macroVar;
				var macroInArgs, macroOutArgs;
				var FEMACROS_HEADER_FIELDS = 4;
	
				feClassToFEsMap_ 	= {}; //reset
				feToMacrosMap_ 		= {}; //reset
				publicMacros_ 		= {}; //reset
				privateMacros_ 		= {}; //reset

				/////////////////////
				//FE Macros			
				var feMacros = req.responseXML.getElementsByTagName("FEMacros");
				Debug.log("feMacros.length = " + feMacros.length);	
				for(var i=0;i<feMacros.length;++i)
				{
					macroVar = feMacros[i].getAttribute("value");
					Debug.log(macroVar);
					macroVar = macroVar.split(":");

					var supervisor = macroVar[0];
					var lid = macroVar[1];
					var feClass = macroVar[2];
					var feUID = macroVar[3];
					
					if(macroVar.length > FEMACROS_HEADER_FIELDS) //at least one function, so display name
					{
						//add FE UID to FE Class in global map ---------------
						if(!feClassToFEsMap_[feClass])
						{
							Debug.log("Need to create FE Class to FE map entry.");							
							feClassToFEsMap_[feClass] = [];
						}
						feClassToFEsMap_[feClass].push(feUID);
					}

					var c = FEMACROS_HEADER_FIELDS;
					while(c < macroVar.length)
					{					
						var macroName = macroVar[c];

						//add FE Macro name to FE in global map ---------------
						if(!feToMacrosMap_[feUID])
						{
							Debug.log("Need to create FE to FE Macro map entry.");							
							feToMacrosMap_[feUID] = {};
						}
						feToMacrosMap_[feUID][macroName] = 
						{
								"requiredPermissions": 	macroVar[c+1],
								"inputs": 				[],
								"outputs": 				[],
								"supervisor": 			supervisor,
								"lid": 					lid,
								"feClass":				feClass,
						};
						c += 2;
						for(var j=0;j<(macroVar[c]|0);++j)							
							feToMacrosMap_[feUID][macroName].inputs.push(macroVar[c+1+j]);
						c += 1 + (macroVar[c]|0);
						for(var j=0;j<(macroVar[c]|0);++j)
							feToMacrosMap_[feUID][macroName].outputs.push(macroVar[c+1+j]);																

							
						c += 1 + (macroVar[c]|0);
					} //end FE macro loop
 
				} //end FE supervisor loop
				
				/////////////////////
				//Public Macros			
				FEMACROS_HEADER_FIELDS = 2;
				var publicMacros = req.responseXML.getElementsByTagName("PublicMacro");
				Debug.log("publicMacros.length = " + publicMacros.length);	
				for(var i=0;i<publicMacros.length;++i)
				{
					macroVar = publicMacros[i].getAttribute("value");
					Debug.log(macroVar);
					macroVar = macroVar.split(":");

					var macroName = macroVar[0];
					var requiredPermissions = macroVar[1];

					publicMacros_[macroName] = 
					{
							"requiredPermissions": 	requiredPermissions,
							"inputs": 				[],
							"outputs": 				[],
					};


					var c = FEMACROS_HEADER_FIELDS;
					for(var j=0;j<(macroVar[c]|0);++j)							
						publicMacros_[macroName].inputs.push(macroVar[c+1+j]);
					c += 1 + (macroVar[c]|0);
					for(var j=0;j<(macroVar[c]|0);++j)
						publicMacros_[macroName].outputs.push(macroVar[c+1+j]);						
				} //end public macro loop

				/////////////////////
				//Private Macros		
				var privateMacros = req.responseXML.getElementsByTagName("PrivateMacro");
				Debug.log("privateMacros.length = " + privateMacros.length);	
				for(var i=0;i<privateMacros.length;++i)
				{
					macroVar = privateMacros[i].getAttribute("value");
					Debug.log(macroVar);
					macroVar = macroVar.split(":");

					var macroName = macroVar[0];
					var requiredPermissions = macroVar[1];

					privateMacros_[macroName] = 
					{
							"requiredPermissions": 	requiredPermissions,
							"inputs": 				[],
							"outputs": 				[],
					};


					var c = FEMACROS_HEADER_FIELDS;
					for(var j=0;j<(macroVar[c]|0);++j)							
						privateMacros_[macroName].inputs.push(macroVar[c+1+j]);
					c += 1 + (macroVar[c]|0);
					for(var j=0;j<(macroVar[c]|0);++j)
						privateMacros_[macroName].outputs.push(macroVar[c+1+j]);						
				} //end public macro loop
				

				console.log("feClassToFEsMap_",feClassToFEsMap_);
				console.log("feToMacrosMap_",feToMacrosMap_);
				console.log("privateMacros_",privateMacros_);
				console.log("publicMacros_",publicMacros_);
				

				if(Object.keys(feClassToFEsMap_).length == 0)
				{
					Debug.log("No FE Macros were found, have you Configured the State Machine? " +
							"Try configuring and then <a onclick='init()'>Refresh</a> this window.",
							Debug.WARN_PRIORITY);
				}

				//construct macro module layout
				console.log("macroModuleLayoutString_",macroModuleLayoutString_);

				macroModules_ = {}; //reset
				layoutMaxRow_ = 0;
				layoutMaxCol_ = 0;
				var layoutModules = macroModuleLayoutString_.split(';');
				for(var i=0;i<layoutModules.length;++i)
				{
					var layoutArgs = layoutModules[i].split(',');
					if(layoutArgs.length != 6)
						continue;
					console.log(i,":","layoutArgs",layoutArgs);

					//layout args:
					//			row,
					//			col,
					//			class or *,
					//			UID or *,
					//			macroType:=fe|public|private:username,
					//			macroName;
					var r = layoutArgs[0] | 0;
					var c = layoutArgs[1] | 0;
					var feClassSelected = layoutArgs[2];
					var feUIDSelected = layoutArgs[3];
					var feMacroTypeSelected = layoutArgs[4];
					var feMacroNameSelected = layoutArgs[5];

					if(r > layoutMaxRow_)
						layoutMaxRow_ = r;
					if(c > layoutMaxCol_)
						layoutMaxCol_ = c;

					if(!macroModules_[r])
						macroModules_[r] = {};
					if(!macroModules_[r][c])
						macroModules_[r][c] = {};
					macroModules_[r][c]["feClassSelected"] = feClassSelected;
					macroModules_[r][c]["feUIDSelected"] = feUIDSelected;
					macroModules_[r][c]["feMacroTypeSelected"] = feMacroTypeSelected;
					macroModules_[r][c]["feMacroNameSelected"] = feMacroNameSelected;

				} //end macro module extraction loop


				console.log("macroModules_",macroModules_);

				redraw();
				return;
				
				
				
				
				
				

				var feMacros = req.responseXML.getElementsByTagName("FEMacros");
				Debug.log("feMacros.length = " + feMacros.length);	
				if(!feMacros.length)
					str += "No FE Macros found.";
				for(var i=0;i<feMacros.length;++i)
				{
					macroVar = feMacros[i].getAttribute("value");
					Debug.log(macroVar);
					macroVar = macroVar.split(":");

					if(macroVar.length > FEMACROS_HEADER_FIELDS) //at least one function, so display name
					{
						str += "<b>Type:" + macroVar[2] + 
								" Supervisor(" + macroVar[0] + ":" + macroVar[1] + 
								") UID:" + macroVar[3] + "</b><br>" + 
								"<div style='margin-left:30px;'>";

						//add FE UID to FE Class in global map ---------------
						if(!feClassToFEsMap_[macroVar[2]])
						{
							Debug.log("Need to create FE Class to FE map entry.");							
							feClassToFEsMap_[macroVar[2]] = [];
						}
						feClassToFEsMap_[macroVar[2]].push(macroVar[3]);
					}

					var c = FEMACROS_HEADER_FIELDS;
					while(c < macroVar.length)
					{					
						var macroName = macroVar[c];

						//add FE Macro name to FE in global map ---------------
						if(!feToMacrosMap_[macroVar[3]])
						{
							Debug.log("Need to create FE to FE Macro map entry.");							
							feToMacrosMap_[macroVar[3]] = {};
						}
						feToMacrosMap_[macroVar[3]][macroName] = 
						{
								"requiredPermissions": macroVar[c+1],
								"inputs": [],
								"outputs": [],
								"supervisor" : macroVar[0],
								"lid" : macroVar[1],
						};



						str += "&quot;" + macroName + "()&quot; RequiredPermissions=" + 
								macroVar[c+1] + "<br>" +
								"&nbsp;&nbsp;&nbsp; Inputs:" +
								"<div style='margin-left:60px;'>";
						c += 2;
						var inputArgs = [];

						//create input text boxes
						if(macroVar[c]|0)
						{							
							str += "<table>";
							for(var j=0;j<(macroVar[c]|0);++j)
							{
								feToMacrosMap_[macroVar[3]][macroName].inputs.push(macroVar[c+1+j]);

								inputArgs.push(macroVar[c+1+j]);								
								str += "<tr><td>";
								str += macroVar[c+1+j];
								str += "</td><td>";
								str +=
										" = <input type='text' id='" + 
										macroVar[1] + "-" + macroVar[3] + "-" + macroName + "-" + macroVar[c+1+j] +
										"' class='" + 
										macroVar[1] + "-" + macroVar[3] + "-" + macroName + "-in" +
										"'value='Default'>";
								str += "</td></tr>";
							}
							str += "</table>";
						}
						else
							str += " No inputs.";

						str += "</div>";	

						c += 1 + (macroVar[c]|0);

						str += "&nbsp;&nbsp;&nbsp; Outputs:" +
								"<div id='" +
								macroVar[1] + "-" + macroVar[3] + "-" + macroName + "-out" +								
								"' style='margin-left:60px;'>";

						//create output place holders
						if(macroVar[c]|0)
						{		
							for(var j=0;j<(macroVar[c]|0);++j)
							{
								feToMacrosMap_[macroVar[3]][macroName].outputs.push(macroVar[c+1+j]);																

								str += macroVar[c+1+j] + "<br>";
							}
						}
						else
							str += " No outputs.<br>";

						str += "</div>";

						//create hidden div that will have output args persistently
						str += "<div id='" +
								macroVar[1] + "-" + macroVar[3] + "-" + macroName + "-outArgs" +								
								"' style='display:none'>";

						for(var j=0;j<(macroVar[c]|0);++j)
							str += macroVar[c+1+j] + "<br>";

						str += "</div>";

						str += "<a onclick='callFEMacro(\"" +					
								macroVar[1] + "\",\"" +
								macroVar[3] + "\",\"" + 
								macroName + "\",[";
						//give array of input args

						for(var j=0;j<inputArgs.length;++j)
						{
							if(j) str += ",";
							str += "\"" + inputArgs[j] + "\"";
						}
						str += "])'>Run</a>";

						str += "<br><br>";
						c += 1 + (macroVar[c]|0);
					}

					if(macroVar.length > FEMACROS_HEADER_FIELDS) //at least one function, so close div
						str += "</div>"; 
				}
				str += "<br><br>";


				/////////////////////
				//Public Macros
				str += "<b>Public Macros</b>";	
				str += "<br><br>";	

				var hugeStringOfPublicMacros = DesktopContent.getXMLValue(req,"returnPublicStr");
				var namesOfAllMacros = [];
				if (hugeStringOfPublicMacros && hugeStringOfPublicMacros.length > 0)
				{
					var publicMacrosArray = hugeStringOfPublicMacros.split("@");
					//each macro is separated by an "@"
					//	and given as a JSON string
					//					{
					//						name:
					//						sequence:
					//						time:
					//						notes:
					//						LSBF:
					//					}
					for(var i = 0; i < publicMacrosArray.length; i++) 
					{						
						var arr = JSON.parse(publicMacrosArray[i]);

						publicMacros_[arr.name] = arr;

						console.log(arr);
						namesOfAllMacros.push(arr.name);
						str += arr.name + "<br>";

						arr = arr.sequence.split(",");
						var macroVariableNames = []; //holds unique names for the variable names in macro
						//for each command get variable names
						for(var j=0;j<arr.length;++j)
						{
							var splitArr = arr[j].split(":");
							while(splitArr.length<4) splitArr.push(""); //force 4 parameters

							if(splitArr[2].length && //check if variable name
									(splitArr[2][0] == '$' || isNaN("0x"+splitArr[2])))
								macroVariableNames[splitArr[2]] = 1;
							if(splitArr[3].length && //check if variable name
									(splitArr[3][0] == '$' || isNaN("0x"+splitArr[3])))
								macroVariableNames[splitArr[3]] = 1;
						}

						str += "<div style='margin-left:30px;'>";
						for(var varName in macroVariableNames)
						{
							str += varName + 
									" = <input type='text' id='" + 
									"user-" + arr.name + "-" + varName +
									"' class='" + 
									"user-" + arr.name + "-in" +
									"'value='Default'>" +
									"<br>";
						}
						str += "</div><br><br>";
					}
				}
				else 
					str += "No Public Macros found.<br><br>";





				/////////////////////
				//User Macros
				str += "<b>User Macros</b>";	
				str += "<br><br>";	
				var hugeStringOfMacros = DesktopContent.getXMLValue(req,"returnMacroStr");

				privateMacros_ = {};
				if (hugeStringOfMacros && hugeStringOfMacros.length > 0)
				{
					var macrosArray = hugeStringOfMacros.split("@");
					//var out = "";
					//var finalOutput = "";
					for(var i = 0; i < macrosArray.length; i++) 
					{
						var arr = JSON.parse(macrosArray[i]);

						privateMacros_[arr.name] = arr;

						console.log(arr);
						namesOfAllMacros.push(arr.name);
						str += arr.name + "<br>";

						arr = arr.sequence.split(",");
						var macroVariableNames = []; //holds unique names for the variable names in macro
						//for each command get variable names
						for(var j=0;j<arr.length;++j)
						{
							var splitArr = arr[j].split(":");
							while(splitArr.length<4) splitArr.push(""); //force 4 parameters

							if(splitArr[2].length && //check if variable name
									(splitArr[2][0] == '$' || isNaN("0x"+splitArr[2])))
								macroVariableNames[splitArr[2]] = 1;
							if(splitArr[3].length && //check if variable name
									(splitArr[3][0] == '$' || isNaN("0x"+splitArr[3])))
								macroVariableNames[splitArr[3]] = 1;
						}

						str += "<div style='margin-left:30px;'>";
						for(var varName in macroVariableNames)
						{
							str += varName + 
									" = <input type='text' id='" + 
									"user-" + arr.name + "-" + varName +
									"' class='" + 
									"user-" + arr.name + "-in" +
									"'value='Default'>" +
									"<br>";
						}
						str += "</div><br><br>";

						//						var macroString = arr.sequence.split(",");
						//						var forDisplay = []; //getting rid of the first element (macroIndex) for all and the last ";" of reads for display 
						//						for (var j = 0; j < macroString.length; j++) //because users don't need to see that
						//							forDisplay.push(macroString[j].split(":").slice(1).filter(Boolean).join(":")); 
						//
						//						stringOfAllMacros[MACROINDEX] = macroString;
						//						out += "<div title='Sequence: " + forDisplay.join(",") + "\nNotes: "
						//								+ arr.notes + "\nCreated: " + arr.time + "\nLSBF: " + arr.LSBF
						//								+ "\' class='macroDiv' data-id=\"" + arr.name + "\" data-sequence=\"" 
						//								+ macroString + "\" data-notes=\"" + arr.notes + "\" data-time=\"" 
						//								+ arr.time + "\" data-LSBF=\"" + arr.LSBF
						//								+ "\" onclick='dealWithVariables(stringOfAllMacros[" 
						//								+ MACROINDEX + "],\"" + arr.name + "\",\"" + arr.LSBF + "\")'><b>" + arr.name + "</b></br></div>"; 
						//						MACROINDEX++;
					}
					//finalOutput = decodeURI(out);
					//document.getElementById("listOfPrivateMacros").innerHTML = finalOutput;
				}
				else 
					str += "No User Macros found.<br><br>";	

				Debug.log(namesOfAllMacros);

				// done, finish up

				var el = document.getElementById("display");
				//el.innerHTML = str;


				console.log("feClassToFEsMap_",feClassToFEsMap_);
				console.log("feToMacrosMap_",feToMacrosMap_);
				console.log("privateMacros_",privateMacros_);
				console.log("publicMacros_",publicMacros_);

				if(Object.keys(feClassToFEsMap_).length == 0)
				{
					Debug.log("No FE Macros were found, have you Configured the State Machine? " +
							"Try configuring and then <a onclick='init()'>Refresh</a> this window.",
							Debug.WARN_PRIORITY);
				}

				//construct macro module layout
				console.log("macroModuleLayoutString_",macroModuleLayoutString_);

				macroModules_ = {}; //reset
				layoutMaxRow_ = 0;
				layoutMaxCol_ = 0;
				var layoutModules = macroModuleLayoutString_.split(';');
				for(var i=0;i<layoutModules.length;++i)
				{
					var layoutArgs = layoutModules[i].split(',');
					if(layoutArgs.length != 6)
						continue;
					console.log(i,":","layoutArgs",layoutArgs);

					//layout args:
					//			row,
					//			col,
					//			class or *,
					//			UID or *,
					//			macroType:=fe|public|private:username,
					//			macroName;
					var r = layoutArgs[0] | 0;
					var c = layoutArgs[1] | 0;
					var feClassSelected = layoutArgs[2];
					var feUIDSelected = layoutArgs[3];
					var feMacroTypeSelected = layoutArgs[4];
					var feMacroNameSelected = layoutArgs[5];

					if(r > layoutMaxRow_)
						layoutMaxRow_ = r;
					if(c > layoutMaxCol_)
						layoutMaxCol_ = c;

					macroModules_[r] = {};
					macroModules_[r][c] = {};
					macroModules_[r][c]["feClassSelected"] = feClassSelected;
					macroModules_[r][c]["feUIDSelected"] = feUIDSelected;
					macroModules_[r][c]["feMacroTypeSelected"] = feMacroTypeSelected;
					macroModules_[r][c]["feMacroNameSelected"] = feMacroNameSelected;

				} //end macro module extraction loop



					}); //end getFEMacroList handler
		} //end init()
	
		//=====================================================================================
		//runMacro ~~
		function runMacro(r, c)
		{
			Debug.log("runMacro(" + r + "," + c + ")");
			

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			
			var feClassSelected = macroModules_[r][c].feClassSelected;	
			var feUIDSelected = macroModules_[r][c].feUIDSelected;	
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			var macroName = macroModules_[r][c].feMacroNameSelected;
			
			var macroObj = feMacroTypeSelected == MACRO_TYPE_FE_?
								feToMacrosMap_[feUIDSelected][macroName]
								:
								(feMacroTypeSelected == MACRO_TYPE_PUBLIC_?
										publicMacros_[macroName] 
										:
										privateMacros_[macroName]
										 );
			
			var inputsArr 	= macroObj.inputs;
			var outputsArr 	= macroObj.outputs;
			
			var inEls = document.getElementsByClassName(
					"macroInput-row-" + r + "-col-" + c
			);
			var postData = "";
			
			postData += "inputArgs=";
			for(var i=0;i<inputsArr.length;++i)
			{
				Debug.log("inputArgs " + inputsArr[i]);
				Debug.log("inputArgs.value " + inEls[i].value);
				if(i) postData += ";";
				postData += inputsArr[i] + "," + inEls[i].value;
			}
			
			postData += "&outputArgs=";
			for(var i=0;i<outputsArr.length;++i)
			{
				Debug.log("outputArgs " + outputsArr[i]);
				if(i) postData += ",";
				postData += outputsArr[i];
			}
			
			console.log("postData",postData);
			
			var str = "";
			str += "Launched... " + getDateString(new Date) + 
					".. waiting for response...";
			var el = document.getElementById(
					"macroResults-row-" + r + "-col-" + c);
			el.innerHTML = str;

			DesktopContent.XMLHttpRequest("Request?RequestType=runFEMacro" +					
					//"&feSupervisorID=" + feSupervisorID +
					"&feClassSelected=" + feClassSelected +
					"&feUID=" + feUIDSelected +
					"&macroType=" + feMacroTypeSelected +
					"&macroName=" + macroName
					, postData, 
					function (req) {
				
				var outputArgNames = req.responseXML.getElementsByTagName("outputArgs_name");
				var outputArgValues = req.responseXML.getElementsByTagName("outputArgs_value");
				Debug.log("outputArgNames.length = " + outputArgNames.length);	
				
				var str = "";
				str += "Last ran... " + getDateString(new Date);
				str += "<br>";
				for(var i=0;i<outputArgNames.length;++i)
					str += outputArgNames[i].getAttribute("value") + " = " + 
					outputArgValues[i].getAttribute("value") + "<br>";
				
				el.innerHTML = str;
			});
		} //end runMacro()

		//=====================================================================================
		//getDateString ~~
		var dayArr_ = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
		var monthArr_ = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		function getDateString(date)
		{
			var dateStr = "";

			dateStr += dayArr_[date.getDay()];
			dateStr += " ";
			dateStr += monthArr_[date.getMonth()];
			dateStr += " ";
			dateStr += date.getDate();
			dateStr += " ";
			dateStr += date.getHours();
			dateStr += ":";
			dateStr += ((date.getMinutes()<10)?"0":"") + date.getMinutes();
			dateStr += ":";
			dateStr += ((date.getSeconds()<10)?"0":"") + date.getSeconds();
			dateStr += " ";
			dateStr += date.getFullYear();
			dateStr += " ";
			dateStr += date.toLocaleTimeString([],{timeZoneName: "short"}).split(" ")[2];
			return dateStr;
		} //end getDateString()
		
		//=====================================================================================
		//redraw ~~
		function redraw()
		{
			Debug.log("redraw()");

			var maxRow = layoutMaxRow_;
			var maxCol = layoutMaxCol_;
						
			console.log("maxRow",maxRow);
			console.log("maxCol",maxCol);
			
			//make module grid
			var str = "";
			str += htmlOpen("table",
					{
							"id": "macroModulesTable",
					});
			for(var c=0;c<=maxCol;++c)
			{
				str += htmlOpen("tr");
				for(var r=0;r<=maxRow;++r)
				{
					str += htmlOpen(
							"td",
							{
								"id": "macroModule-row-" + r + "-col-" + c,
								"class":"macroModule",
							},
						"" /*innerHTML*/,true /*doCloseTag*/);
				}
				str += "</tr>";
			}
			str += "</table>";
			

			var el = document.getElementById("display");
			el.innerHTML = str;
			
			for(var row in macroModules_)
				for(var col in macroModules_[row])
				{					
					//layout args:
					//			row,
					//			col,
					//			class or *,
					//			UID or *,
					//			macroType:=fe|public|private:username,
					//			macroName;
					var r = row | 0;
					var c = col | 0;
					var feClassSelected = macroModules_[r][c].feClassSelected;
					var feUIDSelected = macroModules_[r][c].feUIDSelected;
					var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
					var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

					//make drop down for class, UID
					//	then inputs and outpus

					str = "";

					str += htmlOpen("table", //start macro module table
							{
									"class": "macroModuleTable",
							});
					{ //FE Class html
						str += htmlOpen("tr"); //start row for FE Class
						str += htmlOpen("td",{},"<b>FE Type:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += htmlOpen("td");
						{
							str += htmlOpen(
									"select",
									{
											"id": "feClassSelect-row-" + r + "-col-" + c,
											"class":"feClassSelect",
											"onchange":"handleSelectedFEClass(" +
											r + "," + c + ");",
									});
							str +=  htmlOpen(
									"option" + ("*"==feClassSelected?" selected":""),
									{},
									"*" /*innerHTML*/,true /*doCloseTag*/);
							for(var feClass in feClassToFEsMap_) //go through class keys
							{
								console.log(feClass);
								str +=  htmlOpen(
										"option" + (feClass==feClassSelected?" selected":""),
										{},
										feClass /*innerHTML*/,true /*doCloseTag*/);
							} //end class key loop
							str += "</select>";
						}
						str += "</td></tr>"; //end row for FE Class
					} //end FE Class html

					{ //FE UID html
						str += htmlOpen("tr"); //start row for FE UID
						str += htmlOpen("td",{},"<b>FE Target UID:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += htmlOpen("td");
						{
							str += htmlOpen(
									"select",
									{
											"id": "feUIDSelect-row-" + r + "-col-" + c,
											"class":"feUIDSelect",
											"onchange":"handleSelectedFEUID(" +
											r + "," + c + ");",
									});
							str += "</select>";
						}
						str += "</td></tr>"; //end row for FE Class
					} //end FE Class html
					
					{ //Macro Type html
						str += htmlOpen("tr"); //start row for Macro Type 
						str += htmlOpen("td",{},"<b>Macro Type:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += htmlOpen("td");
						{
							str += htmlOpen(
									"select",
									{
											"id": "macroTypeSelect-row-" + r + "-col-" + c,
											"class":"macroTypeSelect",
											"onchange":"handleSelectedMacroType(" +
											r + "," + c + ");",
									});
							
							for(var macroType in MACRO_TYPES_) //go through class keys
							{
								console.log(macroType);
								str +=  htmlOpen(
										"option" + (MACRO_TYPES_[macroType]==
												feMacroTypeSelected?" selected":""),
										{},
										macroType /*innerHTML*/,true /*doCloseTag*/);
							} //end class key loop
							str += "</select>";
						}
						str += "</td></tr>"; //end row for Macro Type 
					} //end Macro Type html

					{ //Macro Name html
						str += htmlOpen("tr"); //start row for Macro Name
						str += htmlOpen("td",{},"<b>Macro Name:</b>" /*innerHTML*/,true /*doCloseTag*/);
						str += htmlOpen("td");
						{
							str += htmlOpen(
									"select",
									{
											"id": "macroNameSelect-row-" + r + "-col-" + c,
											"class":"macroNameSelect",
											"onchange":"handleSelectedMacroName(" +
											r + "," + c + ");",
									});
							str += "</select>";
						}
						str += "</td></tr>"; //end row for Macro Name
					} //end Macro Name html
					
					{ //Macro Detail html
						str += htmlOpen("tr"); //start row for Macro Detail
						str += htmlOpen("td",{
								"colspan":"2",
								"id": "macroDetail-row-" + r + "-col-" + c,
								"class":"macroDetail",
								},"" /*innerHTML*/,true /*doCloseTag*/);
						str += "</tr>"; //end row for Macro Detail
					} //end Macro Detail html

					el = document.getElementById("macroModule-row-" + 
							r + "-col-" + c);
					el.innerHTML = str;

					handleSelectedFEClass(r,c);
				} //end macro module loop
			
		} //end redraw()

		//=====================================================================================
		//handleSelectedFEClass ~~		
		function handleSelectedFEClass(r,c)
		{
			Debug.log("handleSelectedFEClass(" + r + "," + c + ")");
			
			var feClassSelected = document.getElementById("feClassSelect-row-" + 
					r + "-col-" + c).value;
			console.log("feClassSelected",feClassSelected);

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(feClassSelected != "*" && !feClassToFEsMap_[feClassSelected])
			{
				Debug.log("Invalid FE Class '" + feClassSelected + "' specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("feClassToFEsMap_",feClassToFEsMap_);
				return;
			}
			
			macroModules_[r][c].feClassSelected = feClassSelected;
			var feUIDSelected = macroModules_[r][c].feUIDSelected;
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

			console.log("feUIDSelected",feUIDSelected);
			
			var str = "";
			
			str +=  htmlOpen(
					"option",
					{},
					"*" /*innerHTML*/,true /*doCloseTag*/);
			
			var selectedIndex = 0;
			var i = 1;
			var feUIDObject = feClassSelected == "*"?
					feToMacrosMap_:feClassToFEsMap_[feClassSelected];
			for(var feUIDptr in feUIDObject) //go through FE UIDs
			{
				var feUID = feClassSelected == "*"?
						feUIDptr:feClassToFEsMap_[feClassSelected][feUIDptr];
				
				console.log(feUID);
				str +=  htmlOpen(
						"option" ,
						{},
						feUID /*innerHTML*/,true /*doCloseTag*/);
				
				if(feUID == feUIDSelected)
					selectedIndex = i;
				++i;
			} //end FE UID loop		
			
			if(feUIDSelected != "*" && selectedIndex == 0)
			{
				Debug.log("Invalid FE UID '" + feUIDSelected + "' specified for layout module.",
						Debug.WARN_PRIORITY);
				console.log("feUIDObject",feUIDObject);
			}			
			
			el = document.getElementById("feUIDSelect-row-" + 
					r + "-col-" + c);
			el.innerHTML = str;			
			
			el.selectedIndex =  selectedIndex;
			
			handleSelectedFEUID(r,c);
		} //end handleSelectedFEClass()

		//=====================================================================================
		//handleSelectedFEUID ~~		
		function handleSelectedFEUID(r,c)
		{
			Debug.log("handleSelectedFEUID(" + r + "," + c + ")");
			
			var feUIDSelected = document.getElementById("feUIDSelect-row-" + 
					r + "-col-" + c).value;
			console.log("feUIDSelected",feUIDSelected);

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(feUIDSelected != "*" && !feToMacrosMap_[feUIDSelected])
			{
				Debug.log("Invalid FE UID '" + feUIDSelected + "' specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("feToMacrosMap_",feToMacrosMap_);
				return;
			}
			
			macroModules_[r][c].feUIDSelected = feUIDSelected;
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

			console.log("feMacroTypeSelected",feMacroTypeSelected);
			console.log("feMacroNameSelected",feMacroNameSelected);
			
			if(MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected] === undefined)
			{
				Debug.log("Invalid Macro Type '" + feMacroTypeSelected + "' specified for layout module.",
						Debug.WARN_PRIORITY);
				console.log("MAP_FROM_LAYOUT_TO_MACRO_TYPES_",MAP_FROM_LAYOUT_TO_MACRO_TYPES_);
			}	
			
			var selectedIndex = 
					MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected];
					
			selectedIndex = selectedIndex|0; //force to int
			Debug.log("Macro Type selected index: " + selectedIndex);
			
			el = document.getElementById("macroTypeSelect-row-" + 
					r + "-col-" + c);
			el.selectedIndex =  selectedIndex;

			handleSelectedMacroType(r,c);

		} //end handleSelectedFEUID

		//=====================================================================================
		//handleSelectedMacroType ~~		
		function handleSelectedMacroType(r,c)
		{
			Debug.log("handleSelectedMacroType(" + r + "," + c + ")");
			

			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			
			var feMacroTypeSelected = document.getElementById("macroTypeSelect-row-" + 
					r + "-col-" + c).value;			
			feMacroTypeSelected = MACRO_TYPES_[feMacroTypeSelected]; //convert from readable to encoded macro type
			console.log("feMacroTypeSelected",feMacroTypeSelected);
			if(MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected] === undefined)
			{
				Debug.log("Invalid Macro Type '" + feMacroTypeSelected + "' specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("MAP_FROM_LAYOUT_TO_MACRO_TYPES_",MAP_FROM_LAYOUT_TO_MACRO_TYPES_);
				return;
			}

			macroModules_[r][c].feMacroTypeSelected = feMacroTypeSelected;	
			var feClassSelected = macroModules_[r][c].feClassSelected;
			var feUIDSelected = macroModules_[r][c].feUIDSelected;	
			var feMacroNameSelected = macroModules_[r][c].feMacroNameSelected;

			console.log("feMacroNameSelected",feMacroNameSelected);
			
			var str = "";

			var selectedIndex = -1;
			var i = 0;
			var macroNameObject = feMacroTypeSelected == MACRO_TYPE_FE_?
					feToMacrosMap_[feUIDSelected]:
					(feMacroTypeSelected == MACRO_TYPE_PUBLIC_?
							publicMacros_:privateMacros_);
			for(var macroName in macroNameObject) //go through Macro Names
			{
//				var macroName = feMacroTypeSelected == MACRO_TYPE_FE_?
//						feToMacrosMap_[feUIDSelected][macroNamePtr]:
//						(feMacroTypeSelected == MACRO_TYPE_PUBLIC_?
//								macroNamePtr:macroNamePtr);

				console.log(macroName);
				str +=  htmlOpen(
						"option" ,
						{},
						macroName /*innerHTML*/,true /*doCloseTag*/);

				if(macroName == feMacroNameSelected)
					selectedIndex = i;
				++i;
			} //end Macro Names loop		

			if(feMacroNameSelected != "" && selectedIndex == -1)
			{
				Debug.log("Invalid Macro Name '" + feMacroNameSelected + "' specified for layout module.",
						Debug.WARN_PRIORITY);
				console.log("macroNameObject",macroNameObject);
				selectedIndex = 0;
			}			

			el = document.getElementById("macroNameSelect-row-" + 
					r + "-col-" + c);
			el.innerHTML = str;			

			el.selectedIndex =  selectedIndex;

			handleSelectedMacroName(r,c);
						
		} //end handleSelectedMacroType

		//=====================================================================================
		//handleSelectedMacroName ~~		
		function handleSelectedMacroName(r,c)
		{
			Debug.log("handleSelectedMacroName(" + r + "," + c + ")");

			
			if(!macroModules_[r])
			{
				Debug.log("Invalid row " + r + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			if(!macroModules_[r][c])
			{
				Debug.log("Invalid column " + c + " specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroModules_",macroModules_);
				return;
			}
			
			var feClassSelected = macroModules_[r][c].feClassSelected;
			var feUIDSelected = macroModules_[r][c].feUIDSelected;	
			var feMacroTypeSelected = macroModules_[r][c].feMacroTypeSelected;
			
			var feMacroNameSelected = document.getElementById("macroNameSelect-row-" + 
					r + "-col-" + c).value;		
			macroModules_[r][c].feMacroNameSelected = feMacroNameSelected;
			console.log("feMacroNameSelected",feMacroNameSelected);

			var macroNameObject = feMacroTypeSelected == MACRO_TYPE_FE_?
					feToMacrosMap_[feUIDSelected]:
					(feMacroTypeSelected == MACRO_TYPE_PUBLIC_?
							publicMacros_:privateMacros_);
			
			if(!feMacroNameSelected || feMacroNameSelected == "")
			{
				Debug.log("No macro name selected.");
				return;
			}
			
			if(macroNameObject == undefined ||
					macroNameObject[feMacroNameSelected] === undefined)
			{
				Debug.log("Invalid Macro Name '" + feMacroNameSelected + "' specified for layout module.",
						Debug.HIGH_PRIORITY);
				console.log("macroNameObject",macroNameObject);
				return;
			}
			
			//have macro specified now.. so display inputs/outputs/details
			
			var macroName = feMacroNameSelected;
			
			var macroObj = feMacroTypeSelected == MACRO_TYPE_FE_?
								feToMacrosMap_[feUIDSelected][macroName]
								:
								(feMacroTypeSelected == MACRO_TYPE_PUBLIC_?
										publicMacros_[macroName] 
										:
										privateMacros_[macroName]
										 );
			
			var requiredPermissions = macroObj.requiredPermissions;			
			var inputsArr 	= macroObj.inputs;
			var outputsArr 	= macroObj.outputs;
			//var supervisor 	= macroObj.supervisor;
			//var lid 		= macroObj.lid;
			
			var str = "";


			//====================== create Inputs
			str += "<br>"
			str += "<b>&quot;" + macroName + "()&quot;</b> RequiredPermissions=" + 
					requiredPermissions + "<br>" +
					"&nbsp;&nbsp;&nbsp; <b>Inputs (count=" + 
					inputsArr.length + "):</b>" +
					"<div style='margin-left:60px;'>";

			//create input text boxes
			if(inputsArr.length)
			{							
				str += "<table>";
				for(var i=0;i<inputsArr.length;++i)
				{													
					str += "<tr><td class='macroInputName'>";
					str += inputsArr[i] + ":";
					str += "</td><td>";
					str += htmlOpen("input",{
							"type": "text",
							"id": "macroInput-row-" + r + "-col-" + c +
								"-i-" + i,
							"class":"macroInput " + "macroInput-row-" + r + "-col-" + c,
							"value":"Default",
					},"" /*innerHTML*/,true /*doCloseTag*/);							
					str += "</td></tr>";
				}
				str += "</table>";
			}
			else
				str += " No inputs.";

			str += "</div>";	//end inputs
			

			//====================== create Outputs
			str += "&nbsp;&nbsp;&nbsp; <b>Outputs (count=" + 
					outputsArr.length + "):</b>";

			str += htmlOpen("div",{
					"id": "macroOutputs-row-" + r + "-col-" + c,
					"class":"macroOutputs",
					"style": "margin-left:60px;",
			});

			//create output representatives
			if(outputsArr.length)
			{			
				for(var i=0;i<outputsArr.length;++i)
				{			
					str += "<label class='macroOutputName'>" +
							outputsArr[i] + "</label><br>";				
				}
			}
			else
				str += " No outputs.<br>";

			str += "</div>"; 		//end outputs
			
			//====================== create Run button
			//create hidden div that will have output args persistently		

			var targetString = "";
			if(feClassSelected == "*" && feUIDSelected == "*")
				targetString = "all front-ends.";
			else if(feUIDSelected == "*")
				targetString = "all front-ends of type &apos;" +
					feClassSelected + ".&apos;";
			else if(feMacroTypeSelected == MACRO_TYPE_FE_)
				targetString = "FE &apos;" + feUIDSelected + "&apos; of type &apos;" +
					macroObj.feClass + ".&apos;";
			else
				targetString = "FE &apos;" + feUIDSelected + ".&apos;";

			str += "<br>";
			str += htmlOpen("input",{
					"id": "runMacroButton-row-" + r + "-col-" + c,
					"class":"runMacroButton",
					"type":"button",					
					"onclick": "runMacro(" +					
						r + "," + c + ");",
					"value": "Run",
					"title": "Run the " + 
						Object.keys(MACRO_TYPES_)[MAP_FROM_LAYOUT_TO_MACRO_TYPES_[feMacroTypeSelected]] + 
						" &apos;" + macroName + "&apos; on " + targetString,
			},"" /*innerHTML*/,true /*doCloseTag*/);
			
//			str += htmlOpen("input",{
//					"id": "outputMacroToFile-row-" + r + "-col-" + c,
//					"class":"outputMacroToFile",
//					"type":"checkbox",
//					"title": "When checked, output from Macro will be saved to file.",
//			},"Save output to file" /*innerHTML*/,true /*doCloseTag*/);
			
			//end Run button
			
			str += htmlOpen("div",{
					"id": "macroResults-row-" + r + "-col-" + c,
					"class":"macroResults",
			},"" /*innerHTML*/,true /*doCloseTag*/);
			
			
			el = document.getElementById("macroDetail-row-" + 
					r + "-col-" + c);
			el.innerHTML = str;
		} //end handleSelectedMacroName
		</script>
</head>
	

<body onload='Javascript:init();'>	
		
	<h1>Front-End Macros</h1>
		<div style='width:550px'></div>		

	<!--<a onclick='init();'>Refresh</a>
		<br>-->
	<div id='display'></div>
	
</body>
	
</html>
