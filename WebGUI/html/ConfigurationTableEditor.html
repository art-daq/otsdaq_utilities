<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>ConfigurationGUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">
	
	<style type="text/css">		
	
		.fixedChoiceAdd	{
			text-decoration: none;
			font-size: 30px;
			font-weight: bold;
			color: rgb(15, 152, 76);
		}


		.treeNode-deleteIcon {			
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCan.png);
			width: 				16px;
			height: 			20px;
			border: 			0;
			margin: 			-9px 0 -10px 0px;
		}
		.treeNode-deleteIcon:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
			cursor: 			pointer;
		}
		
		preloadImage {			
			width: 				24px;
			height: 			20px;
			position:			absolute;
			left: 				-100px;
			top: 				0;
		}
		#preloadImage-treeEditTrashIcon {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCan.png);
		}
		#preloadImage-treeEditTrashIconHover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
		}
		
		#popUpDialog {
			position: absolute;
			z-index: 1000;    
			border: 1px solid #770000;
			background-color: #efeaea;
			text-align: center;
			padding: 10px;
			overflow: hidden;
		}
		
	</style>
	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>

	<script>		
		
	
		var _CONFIG_TYPE_ROW_OFFSET = 1;
		var _CONFIG_DATA_COL_OFFSET = 0;
		var _CONFIG_FIXED_CELLS = 3;
	

		var _typeArray = ["Data","UniqueData","FixedChoiceData", //"MultilineData", FIXME when multiline data is functional
						  "OnOff","TrueFalse","YesNo","ChildLinkUID","ChildLinkGroupID","ChildLink","GroupID"];
		var _dataTypeArray = ["VARCHAR2","NUMBER","TIMESTAMP WITH TIMEZONE"];
		var _defaultArray = {};
				
		var _editingCell = false;
		var _editingCellEl, _editingCellElOldValue;
		var _editingCellPos = [-1,-1];	
		var _srcName;
		var _colHdrArr, _colTypeArr, _colDataTypeArr, _colChoicesArr;
		var _tableDescription;
		var _tableIsTransposed = false;
		
		var _mouseIsSelecting = false;	//to block switching cells when selecting text
	
		var _bitMapFieldsArr = ["Number of Rows",
								"Number of Columns",
								"Cell Bit-field Size",
								"Min-value Allowed",
								"Max-value Allowed",
								"Value step-size Allowed",
								"Display Aspect H:W",
								"Min-value Cell Color",
								"Mid-value Cell Color",
								"Max-value Cell Color",
								"Absolute Min-value Cell Color",
								"Absolute Max-value Cell Color",
								"Display Rows in Ascending Order",
								"Display Columns in Ascending Order",
								"Snake Double Rows",
								"Snake Double Columns"];
		var _bitMapFieldTypesArr = [ //types => 0:string, 1:bool (default no), 
									 	 //2:bool (default yes), 3:color 
									 0,//"Number of Rows",
									 0,//"Number of Columns",
									 0,//"Cell Bit-field Size",
									 0,//"Min-value Allowed",
									 0,//"Max-value Allowed",
									 0,//"Value step-size Allowed",
									 0,//"Display Aspect H:W",
									 3,//"Min-value Cell Color",
									 3,//"Mid-value Cell Color",
									 3,//"Max-value Cell Color",
									 3,//"Absolute Min-value Cell Color",
									 3,//"Absolute Max-value Cell Color",
									 1,//"Display Rows in Ascending Order",
									 2,//"Display Columns in Ascending Order",
									 1,//"Snake Double Rows",
									 1];//"Snake Double Columns"];

		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:			
			//init()			
			//setupTableEditor(req)
			//saveTable()
			//loadTable()
			//verifyDeleteTable()
			//deleteTable()
			//setupSpecificConfig(configName, version)		//setup editor for specific configuration table
			//specificConfigRequestHandler(req)
			//setupEmptyTable();
			//setupTable(srcName,colHdrs,colTypes,colDataTypes,colChoices,tableDescription)
			//selectThisCell(r,c,el)
			//setCaretPosition(el,start,stop)
			//editCellCancel()
			//keyHandler(e)
			//editCellOK()
			//addColumn(c)
			//deleteColumn(c)
			//transposeTable()
			//createEditTableMenu(event)
			//setupFindAndReplace()
			//configReplace()
		
			//addFixedChoice(c)
			//deleteSelectedFixedChoice(c)
			//downloadFixedChoices(c)
			//popUpUploadFixedChoicesForm(c)
			//uploadFixedChoices(c)
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
						
		
		//init ~
		//	init called once body has loaded
		function init() {			
			Debug.log("CfgTableEditor init");
			
			DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurations&refresh=1&allowIllegalColumns=1", "",
					setupTableEditor);
			DesktopContent.XMLHttpRequest("Request?RequestType=getColumnTypes", "",
					function(req) {

				var colTypes = req.responseXML.getElementsByTagName("columnTypeForGUI");
				var colDataTypes = req.responseXML.getElementsByTagName("columnDataTypeForGUI");								
				var defDataType = req.responseXML.getElementsByTagName("columnDefaultDataType");
				var defTypeFilter = req.responseXML.getElementsByTagName("columnDefaultTypeFilter");
				var defValue = req.responseXML.getElementsByTagName("columnDefaultValue");
				
				if(colTypes.length)
					_typeArray = []; //clear and take from data
				for(var i=0;i<colTypes.length;++i)
					_typeArray.push(colTypes[i].getAttribute("value"));
				
				Debug.log("colTypes.length = " + colTypes.length);

				if(colDataTypes.length)
					_dataTypeArray = []; //clear and take from data
				for(var i=0;i<colDataTypes.length;++i)
					_dataTypeArray.push(colDataTypes[i].getAttribute("value"));				
				
				_defaultArray = {};
				var dVal;
				for(var i=0;i<_dataTypeArray.length;++i)
				{
					_defaultArray[_dataTypeArray[i]] = {};
					for(var j=0;j<_typeArray.length;++j)
					{
						//search through default dataTypes and type filter pairs
						var found = false;
						for(var a=0;a<defDataType.length;++a)
						{
							if(_dataTypeArray[i] == 
									defDataType[a].getAttribute("value"))
							{
								if("*" == 
										defTypeFilter[a].getAttribute("value"))
								{
									found = true;
									dVal = defValue[a].getAttribute("value");
									break;
								}
								else if(_typeArray[j] == 
										defTypeFilter[a].getAttribute("value"))
								{
									found = true;
									dVal = defValue[a].getAttribute("value");
									break;
								}
							}
						}
						
						if(!found)
						{
							Debug.log("Impossible error occured!... Looking for " +
									_dataTypeArray[i] + " and " + _typeArray[j] + ".",
									Debug.HIGH_PRIORITY);
							return;
						}
						
						_defaultArray[_dataTypeArray[i]]
									  [_typeArray[j]]
									  = dVal;						
					}
				}
				Debug.log("default array = " + _defaultArray);
				
			},0,0,0,true  //parameter, progressHandler, callHandlerOnErr, showLoadingOverlay
			);
			
			setupEmptyTable();

			window.onmouseup = function(event) {	
				editCellOK();//editCellCancel();  
				_mouseIsSelecting = false; 
				//Debug.log(_mouseIsSelecting);
			};		
		}
		
		//setupTableEditor(req) ~
		function setupTableEditor(req)
		{
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				//attemp to power through
			}

			var configNames = req.responseXML.getElementsByTagName("ConfigurationName");
			var configVersionHdr = req.responseXML.getElementsByTagName("ConfigurationVersions");

			//Save Column Info as...
			//	Configuration Name:
			//	
			//Load Column Info from...
			//	Configuration Name: ____^

			var str = "";

			str += "Load Column Info from... "; 
			str += " <input type='button' onmouseup='loadTable()' value='Load'/>";
			str += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Delete Table... "; 			
			str += " <input type='button' onmouseup='verifyDeleteTable()' value='Delete'/>";
			str += " <input id='reallyDeleteButton' type='button' style='display:none' onmouseup='deleteTable()' value='Really Delete!'/>";
			
			str += "<br>&nbsp;&nbsp;Configuration Name:";

			str += "<select id='loadFromConfigName' " +
					"onchange='document.getElementById(\"reallyDeleteButton\").style.display = \"none\";' " +
					">";

			var configName;

			Debug.log("CfgTableEditor requestHandler configNames.length " + configNames.length);
			for(var i=0;i<configNames.length;++i)
			{			
				configName = configNames[i].getAttribute("value");

				str += "<option value='" + configName + "'>";
				str += configName;	//can display however
				str += "</option>";
			}				
			str += "</select>";

			str += "<br><br>";
			str += "Save Column Info as...";
			str += " <input id='overwriteButton' style='display:none' type='button' onmouseup='saveTable(1)' value='Overwrite'/>";
			str += "<br>&nbsp;&nbsp;Configuration Name:";							
			str += "<input type='text' id='SaveAsConfigName' " + 
					"onchange='document.getElementById(\"overwriteButton\").style.display = \"none\";' " +
					"style='margin:-4px -2px -4px -1px; width:310px' value=''>";
			str += " <input type='button' onmouseup='saveTable(0)' value='Save'/>";
			
			
			
			var el = document.getElementById("controls");
			el.innerHTML = str;
			
		}

		//handleTypeSelect ~
		function handleTypeSelect()
		{
			var sel = document.getElementById("selectCellTypeSelect");
			var selVal = sel.options[sel.selectedIndex].value;
			Debug.log("CfgTableEditor handleTypeSelect = " + selVal);

			var specTypeArray = ["GroupID","ChildLink","ChildLinkUID","ChildLinkGroupID"];
					
			var found = false;
			for(var i=0;i<specTypeArray.length;++i)
				if(selVal == specTypeArray[i]) { found = true; break; }

			var el = document.getElementById("selectCellSpecTypeID");
			
			el.style.display = found?"block":"none";	
			
		}
		
		//loadTable ~
		function loadTable()
		{
			var sel = document.getElementById("loadFromConfigName");
			var configName = sel.options[sel.selectedIndex].value;
			
			Debug.log("CfgTableEditor loadTable from " + configName);

			//load mockup for chosen table
			setupSpecificConfig(configName, -1);
		}
		
		//saveTable ~
		function saveTable(allowOverwrite)
		{
			var configName = document.getElementById("SaveAsConfigName").value;
			
			Debug.log("CfgTableEditor saveTable=" + configName);
			_colHdrArr, _colTypeArr, _colDataTypeArr;

			//	write new info file for configName based CSV column info
			//			data="type,name,dataType;type,name,dataType;..."
			
			var data = "";
			for(var i=0;i<_colHdrArr.length;++i)
				data += _colTypeArr[i] + "," + encodeURIComponent(_colHdrArr[i].trim()) + "," + _colDataTypeArr[i] + ";";
			
			//handle table description
			var tableDescription = document.getElementById("table-description").value.trim();			
			if(tableDescription.length)
				tableDescription = encodeURIComponent(tableDescription);
			else
				tableDescription = "No description.";
			
			//col choices are CSV for each column and ; separated columns
			//	if col type is BitMap extract the input values
			var colChoicesData = "";
			for(var i=0;i<_colChoicesArr.length;++i)
			{
				if(_colTypeArr[i] == "BitMap")
				{
					Debug.log("BitMap saving " + i);					
					//extract fields into col choice array
					for(var j=0;j<_bitMapFieldsArr.length;++j) 
					{
						var el = document.getElementById("bitmapFieldInput-" + i + "-" + j);
						if(j) colChoicesData += ",";
						colChoicesData += encodeURIComponent(el.value);
					}
					colChoicesData += ";";	
				}
				else
					colChoicesData += _colChoicesArr[i] + ";";
			}
			
			
			DesktopContent.XMLHttpRequest("Request?RequestType=saveConfigurationInfo" +
				"&configName=" + configName + 
				"&allowOverwrite="+allowOverwrite, 
				"columnCSV=" + data + 
				"&tableDescription=" + tableDescription +
				"&columnChoicesCSV=" + colChoicesData, specificConfigRequestHandler, 1);	
		}
		

		//verifyDeleteTable ~
		function verifyDeleteTable()
		{
			var sel = document.getElementById("loadFromConfigName");
			var configName = sel.options[sel.selectedIndex].value;
			
			Debug.log("CfgTableEditor verifyDeleteTable from " + configName);
			
			Debug.log("Are you sure you want to delete the " +
					"configuration '" +  configName + 
					"'? If so, click the 'Really Delete!' button.",
					Debug.WARN_PRIORITY);
			document.getElementById("reallyDeleteButton").style.display = "inline";			
		}
		
		//deleteTable ~
		function deleteTable()
		{
			var sel = document.getElementById("loadFromConfigName");
			var configName = sel.options[sel.selectedIndex].value;			
			Debug.log("CfgTableEditor deleteTable from " + configName);

			document.getElementById("reallyDeleteButton").style.display = "none";
			DesktopContent.XMLHttpRequest("Request?RequestType=deleteConfigurationInfo" +
				"&configName=" + configName, "",
				function(req)
				{
					var err = DesktopContent.getXMLValue(req,"Error");
					if(err) 
					{	
						Debug.log(err,Debug.HIGH_PRIORITY);
						return;
					}

					//on success reload all configurations
					DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurations" +
							"&refresh=1&allowIllegalColumns=1", "",
							setupTableEditor);					
				} //end of delete handler		
			);
		}

		//setupSpecificConfig ~
		//	undefined version gives latest
		function setupSpecificConfig(configName,version) {
			var v = "";
			if(version) v = "&version="+version;
			document.getElementById("SaveAsConfigName").value = configName;
			DesktopContent.XMLHttpRequest("Request?RequestType=getSpecificConfiguration&allowIllegalColumns=1" + "&dataOffset=0&chunkSize=0" +  
				"&configName=" + configName + v, "", specificConfigRequestHandler);		
		}		
		
		//setupEmptyTable
		function setupEmptyTable() {
			
			var colTypes = ["UID","Comment","Author","Timestamp"];
			var colDataTypes = ["VARCHAR2","VARCHAR2","VARCHAR2","TIMESTAMP WITH TIMEZONE"];
			var colHdrs = ["UID","CommentDescription","Author","RecordInsertionTime"];
			
			setupTable("Empty Table Template",colHdrs,colTypes,colDataTypes,0,"No description.");
		}

		//specificConfigRequestHandler
		function specificConfigRequestHandler(req, isFromSaveReq) {

			var configName = DesktopContent.getXMLValue(req,"ConfigurationName");
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{				
				var writeErr = DesktopContent.getXMLValue(req,"OverwriteError");
				if(writeErr) //overwrite rejection
				{
					Debug.log(err,Debug.WARN_PRIORITY);
					Debug.log("Are you sure you want to overwrite the " +
							"configuration '" +  configName + 
							"'? If so, click the 'Overwrite' button.",
							Debug.WARN_PRIORITY);
					document.getElementById("overwriteButton").style.display = "inline";
					return;
				}
				else
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					//try to power through
				}
			}
			else if(configName != "")
				Debug.log("Column info for table '" + configName + "' was successfully loaded!",
						Debug.INFO_PRIORITY);
				
			document.getElementById("overwriteButton").style.display = "none";						
			
			if(isFromSaveReq && !err)
				Debug.log("Successful response to save request of Info for '" + configName + "'",Debug.INFO_PRIORITY);
			
			if(!req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0])
				return;
			
			var colHdrs = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnHeader");
			var colTypes = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnType");
			var colDataTypes = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnDataType");
			var colChoices = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnChoices");

			var tableDescription = DesktopContent.getXMLValue(req,"ConfigurationDescription");
			
			var colHdrsArr = [];
			for(var i=0;i<colHdrs.length;++i)
				colHdrsArr.push(colHdrs[i].getAttribute("value"));
			var colTypesArr = [];
			for(var i=0;i<colTypes.length;++i)
				colTypesArr.push(colTypes[i].getAttribute("value"));
			var colDataTypesArr = [];
			for(var i=0;i<colDataTypes.length;++i)
				colDataTypesArr.push(colDataTypes[i].getAttribute("value"));
			var colChoicesArr = [];
			for(var i=0;i<colChoices.length;++i)
			{
				var colChoiceArr = colChoices[i].getElementsByTagName("ColumnChoice");
				var csvStr = "";
				for(var j=0;j<colChoiceArr.length;++j)
				{
					if(j) csvStr += ",";
					csvStr += encodeURIComponent(colChoiceArr[j].getAttribute("value"));
				}
				Debug.log("csvStr col=" + i + " csvChoices=" + csvStr);
				colChoicesArr.push(csvStr);
			}
			
			if(!isFromSaveReq)
				document.getElementById('SaveAsConfigName').value = configName;
			
			Debug.log("tableDescription = " + tableDescription);
			setupTable(configName,colHdrsArr,colTypesArr,colDataTypesArr,colChoicesArr,tableDescription);
		}
		
		//setupTable ~
		function setupTable(srcName,colHdrs,colTypes,colDataTypes,colChoices,tableDescription)
		{
			//handle use of cached _srcName
			if(!srcName)
				srcName = _srcName;
			else
				_srcName = srcName;
					 
			//cache data for add/delete ease
			if(!colHdrs)
				colHdrs = _colHdrArr;
			else
				_colHdrArr = colHdrs;
			if(!colTypes)
				colTypes = _colTypeArr;
			else
				_colTypeArr = colTypes;
			if(!colDataTypes)
				colDataTypes = _colDataTypeArr;
			else
				_colDataTypeArr = colDataTypes;	
			if(!colChoices)
				colChoices = _colChoicesArr;
			else
				_colChoicesArr = colChoices;	
			if(!tableDescription)
				tableDescription = _tableDescription;
			else
				_tableDescription = tableDescription;			

			//force proper comment name
			colHdrs[colHdrs.length-3] = "CommentDescription";
			_colHdrArr[colHdrs.length-3] = "CommentDescription";
			
						
			var str = "";
			
			str += "Starting point was...<br>";

			//display edit menu
			str +=
					"<div class='tableView-Menu' onmousedown='createEditTableMenu(event);' title='Edit Menu'>" +
					"<div class='gotoNavDiv'></div>" +
					"</div>"; //end context menu link div

			str += "<div style='float:left;'>";
			str += "<b>" + srcName + "</b> (Mockup-View)";
			str += "</div>";
			

			str += "<div id='clearDiv'></div>";						
			str += "<div id='findAndReplace'></div>";
			
			//display table
			str += "<table id='SubSystemTable' border='1' cellspacing='5' cellpadding='1'>";
			
			
			var localDisplayPixelMaskInputs = function() {

				Debug.log("BitMap col=" + c + " colTypes[c]=" + colTypes[c]);

				str += "<td>";				

				var colChoicesArr = colChoices[c].split(',');
				var bitMapFieldValues = [];
				for(var f=0;f<colChoicesArr.length;++f)
					if(colChoicesArr[f] == "") continue; //skip empty values
					else
						bitMapFieldValues.push(decodeURIComponent(colChoicesArr[f]));	

				function localAddBitmapFieldInput(i) {
					str += "<tr>";
					str += "<td style='white-space:nowrap; text-align:right; margin-right:5px;'>";
					str += _bitMapFieldsArr[i] + ":";
					str += "</td>";
					str += "<td>";
					
					if(_bitMapFieldTypesArr[i] == 0) //string
					{
						str += "<input type='text' id='bitmapFieldInput-" + c + "-" + i + 
								"' value='" + 
								(i<bitMapFieldValues.length?bitMapFieldValues[i]:"DEFAULT") +
								"' " +
								"onmouseup='event.stopPropagation();' " +
								"onclick='event.stopPropagation();" +
								"setCaretPosition(this,0,this.value.length);' " +
								"style='width:150px' />";
					}
					else if(_bitMapFieldTypesArr[i] == 1 || 
							_bitMapFieldTypesArr[i] == 2) //bool yes/no
					{
						var boolVals = ["No","Yes"];
						str += "<select " +
								"style='margin:0;' id='bitmapFieldInput-" + c + "-" + i + 
								"'>";
						for(var b=0;b<boolVals.length;++b)
						{			
							str += "<option value='" + boolVals[b] + "' ";
							
							if(boolVals[b] == 
									(i<bitMapFieldValues.length?
											bitMapFieldValues[i]:
											(_bitMapFieldTypesArr[i]==2?"Yes":"No")))
								str += "selected";									
							str += " >";
							str += boolVals[b];	//can display however
							str += "</option>";					
						}			
						str += "</select>";
					}
					else if(_bitMapFieldTypesArr[i] == 3) //color, (FIXME make color selector) string for now
					{
						str += "<input type='text' id='bitmapFieldInput-" + c + "-" + i + 
								"' value='" + 
								(i<bitMapFieldValues.length?bitMapFieldValues[i]:"DEFAULT") +
								"' " +
								"onmouseup='event.stopPropagation();' " +
								"onclick='event.stopPropagation();" +
								"setCaretPosition(this,0,this.value.length);' " +
								"style='width:150px' />";
					}
					str += "</td>";							
					str += "</tr>";
				}
				
				str += "<table style='float:right;'>";
				for(var i=0;i<3;++i)
					localAddBitmapFieldInput(i);
				
				str += "</table>";
				
				str += "<div id='clearDiv'></div>";
				
				//create hidden optional fields
				str += "<a href='#' onclick='javascript:" +
						"if(this.textContent.indexOf(\"Show\") == 0) " +
						"{ document.getElementById(\"bitmapFieldInput-optional\").style.display = \"block\";" +
						"this.innerHTML = \"Hide Optional Fields\";}" +
						"else " + 
						"{ document.getElementById(\"bitmapFieldInput-optional\").style.display = \"none\";" +
						"this.innerHTML = \"Show Optional Fields\";}" +
						"' style='float:right;'>" +
						"Show Optional Fields</a>";
				
				str += "<div id='clearDiv'></div>";
				
				str += "<table id='bitmapFieldInput-optional' style='display:none' style='float:right;'>";
				for(var i=3;i<_bitMapFieldsArr.length;++i)
					localAddBitmapFieldInput(i);
				str += "</table>";

				str += "</td>";

			}

			//:::::
			function localInsertAddDeleteCell(c)
			{
				str += "<td>";					
				//show +/- columns where possible to add/delete
				if(c <= colTypes.length - _CONFIG_FIXED_CELLS)					
				{
					str += " <a href='javascript:addColumn(" + c + ");'>";
					str += "+";
					str += "</a>";

					if(c < colTypes.length - _CONFIG_FIXED_CELLS && colTypes[c] != "UID")
					{
						str += "/<a href='javascript:deleteColumn(" + c + ");'>";
						str += "-";
						str += "</a>";
					}
				}
				str += "</td>";
			}

			//:::::
			function localInsertTypeCell(c)
			{
				str += "<td onmouseup='selectThisCell(" + _CONFIG_TYPE_ROW_OFFSET + "," +
						c + ",this,event);' style='width:100px'>";
				str += "<div style='font-size:12px' title='";		
				str += colTypes[c];
				str += " &#60;" + colDataTypes[c] + "&#62;";
				str += "'>";
				str += colTypes[c];
				str += "<br>&#60;" + colDataTypes[c] + "&#62;";
				str += "</div>";
				str += "</td>";	
			}
			
			//:::::
			function localInsertColumnNameCell(c)
			{
				str += "<th onmouseup='selectThisCell(" + (_CONFIG_TYPE_ROW_OFFSET+1) + "," +
						c + ",this,event);'>";
				str += colHdrs[c];
				str += "</th>";
			}
			
			//:::::
			function localInsertTypeParameters(c)
			{
				//add data choices if type = FixedChoiceData
				//add bitmap info fields if type = BitMap
				if(colTypes[c] != "FixedChoiceData" && 
						colTypes[c] != "BitMap") 
				{
					str += "<td style='border:0; background-color:transparent;'></td>";
				}
				else if(colTypes[c] == "BitMap")
				{
					localDisplayPixelMaskInputs();
				}
				else	//if(colTypes[c] == "FixedChoiceData")
				{
					Debug.log("FixedChoiceData col=" + c + " colTypes[c]=" + colTypes[c]);
					str += "<td>";

					str += "<table cellpadding='2px' cellspacing='2px' border='0' >"; //open table
					str += "<tr><td>";
					str += "<input type='text' id='newChoiceInput-" + c + "' value='My New Choice' " +
							"onmouseup='event.stopPropagation();' " +
							"onclick='event.stopPropagation();" +
							"setCaretPosition(this,0,this.value.length);' " +
							"style='width:150px' />";
					str += "</td><td style='white-space:nowrap' >";
					str += "<a class='fixedChoiceAdd' onclick='addFixedChoice(" + c + "); return false;' " +
							"title='Add text as a new fixed choice option for this column.\"'" +
							">";
					str += "+";
					str += "</a>";
					str += "</td></tr>";


					str += "<tr><td>";

					str += "<select style='width:150px' id='fixedChoicesSelect-" + c + "' " +
							"onchange='document.getElementById(\"newChoiceInput-" + c + 
							"\").value = this.value;'" +
							">";
					var colChoicesArr = colChoices[c].split(',');

					//always show default first
					str += "<option>" +
							decodeURIComponent(_defaultArray[colDataTypes[c]][colTypes[c]]) +
							"</option>";					

					for(var f=0;f<colChoicesArr.length;++f)	
						if(colChoicesArr[f] == "") continue; //skip empty values
						else
							str += "<option>" +
							decodeURIComponent(colChoicesArr[f]) +
							"</option>";		

					str += "</select>";

					str += "</td><td>";
					str += 
							"<div class='treeNode-deleteIcon' " + 
							"onmouseup='event.stopPropagation();' " +
							"onclick='event.stopPropagation();" +
							"deleteSelectedFixedChoice(" + c + ");' " +
							"title='Delete the currently selected choice for this column.' " +
							"></div>";

					

					str += "</td></tr>";
					str += "</table>";
					
					str += "<br>";
					str += "<center>";
					str += "<a onclick='downloadFixedChoices(" + c + "); return false;' " +
							"title='Dowload choices as CSV data file.\"'" +
							">";
					str += "Download";
					str += "</a>";
					str += "&nbsp;&nbsp;&nbsp;";

					str += "<a onclick='popUpUploadFixedChoicesForm(" + c + "); return false;' " +
							"title='Upload choices as CSV data file.\"'" +
							">";
					str += "Upload";
					str += "</a>";
					str += "</center>";
										
					str += "</td>";			

				}
			}
			
			if(_tableIsTransposed)
			{
				//for each column, make a row		
				for(var c=0;c<colTypes.length;++c)
				{
					///// open row
					str += "<tr class='SubSystemTableRow'>";
					
					/////////////////////////////////
					//+/- column links
					localInsertAddDeleteCell(c);
					
					/////////////////////////////////
					//type and data type row
					localInsertTypeCell(c);
					
					/////////////////////////////////
					//col name type row
					localInsertColumnNameCell(c);

					/////////////////////////////////
					//col parameters
					localInsertTypeParameters(c);
					
					///// close row
					str += "</tr>";
				}
			}
			else
			{
				//+/- column row
				str += "<tr class='SubSystemTableRow'>";					
				for(var c=0;c<colTypes.length;++c)
				{
					/////////////////////////////////
					//+/- column links
					localInsertAddDeleteCell(c);
				}
				str += "</tr>";
				
				//type and data type row
				str += "<tr class='SubSystemTableRow'>";	
				for(var c=0;c<colTypes.length;++c)
				{
					/////////////////////////////////
					//type and data type row
					localInsertTypeCell(c)		
				}
				
				str += "</tr>";
				str += "<tr class='SubSystemTableRow'>";
				for(var c=0;c<colHdrs.length;++c)
				{
					/////////////////////////////////
					//col name type row
					localInsertColumnNameCell(c);	
				}
				str += "</tr>";							

				//add data choices if type = FixedChoiceData
				str += "<tr class='SubSystemTableRow'>";	
				for(var c=0;c<colTypes.length;++c)
				{
					/////////////////////////////////
					//col parameters
					localInsertTypeParameters(c);
				}
				str += "</tr>";
			}

			str += "</table>";		

			
			//add table description editing
			if(!tableDescription || tableDescription == "")
				tableDescription = "No description.";
			str += "<br><br>";
			str += "Table Description (Changes will be saved with the column info.";
			
			str += " <a href='#' id='table-description-preview-link',Debug.INFO_PRIORITY);'>" +
					"Preview</a>):";
			
			str += "<br>";
			str += "<textarea id='table-description' rows='6' cols='60'>";			 
			str += tableDescription;
			str += "</textarea>";
			
			var el = document.getElementById("display");
			el.innerHTML = str;	
			el = document.getElementById("table-description-preview-link");
			el.onclick = function(){
				DesktopContent.tooltip("ALWAYS",
						"<center>Preview of " + srcName + " Tooltip</center><br>" +
						tableDescription);
			}
		}
		


		//selectThisCell ~~
		function selectThisCell(r,c,el,event) 
		{		
			if(event) //stop the body from also calling onmouseup and cancelling select
			{
				event.stopPropagation();

				Debug.log(_mouseIsSelecting);
				if(_mouseIsSelecting) //block select if mouse is selecting text currently 
				{
					_mouseIsSelecting = false;
					Debug.log(_mouseIsSelecting);
					return; 							
				}
			}

			if(_editingCell) //already have the edit box open, cancel it
			{
				if(_editingCellEl == el) //if same cell do nothing
					return false;
				editCellOK(); //editCellCancel(); //if new cell cancel
			}			
			
			//NOTE!!!! 
			// editCellOK() may redraw table, by calling setupTable().. 
			//	this means el can not be trusted to still exist!!
			// so use r,c to recover element
			
			//if column is Author or Timestamp, don't allow select
			var tableEl = document.getElementById("SubSystemTable");
			var rows = tableEl.getElementsByClassName("SubSystemTableRow");//getElementsByTagName("tr");
			var typeCell; //cols = []; //just need target column info, not all columns			
			var colType;
			
			//get col type cell and tartget cell (transposed or not)
			if(_tableIsTransposed)
			{
				//transpose all
				//var tcols;
				//for(var i=0;i<rows.length;++i)
				//{ i = c
					//tcols = rows[i].getElementsByTagName("td");					
					//cols[i] = tcols[_CONFIG_TYPE_ROW_OFFSET];
						
				//}
				typeCell = rows[_CONFIG_DATA_COL_OFFSET+c].getElementsByTagName("td")[_CONFIG_TYPE_ROW_OFFSET];
				if(r == 2) //use header cells
					el = rows[_CONFIG_DATA_COL_OFFSET+c].getElementsByTagName("th")[0];
				else if(r > 2) //special row
					el = rows[_CONFIG_DATA_COL_OFFSET+c].getElementsByTagName("td")[2];
				else //r < 2
					el = rows[_CONFIG_DATA_COL_OFFSET+c].getElementsByTagName("td")[r];
			}
			else
			{
				//cols = rows[_CONFIG_TYPE_ROW_OFFSET].getElementsByTagName("td");
				typeCell = rows[_CONFIG_TYPE_ROW_OFFSET].getElementsByTagName("td")[_CONFIG_DATA_COL_OFFSET+c];
				el = rows[r].getElementsByTagName("td")[_CONFIG_DATA_COL_OFFSET+c];
				if(!el) //if failed try header cells
					el = rows[r].getElementsByTagName("th")[_CONFIG_DATA_COL_OFFSET+c];
			}
			
			//colType = cols[_CONFIG_DATA_COL_OFFSET+c].childNodes[0].innerHTML.split('<')[0]; //type text is in a div for smaller font
			colType = typeCell.childNodes[0].innerHTML.split('<')[0]; //type text is in a div for smaller font
			if(colType == "Author" || 
					colType == "Timestamp"|| 
					colType == "Comment" )//|| 
					//(r == _CONFIG_TYPE_ROW_OFFSET && colType == "UID"))
			{
				Debug.log("This cell is fixed. Users can not edit cells of type '" +
						colType + ".'",Debug.WARN_PRIORITY)
				return false;
			}
			
			
			_editingCell = true;
			_editingCellEl = el;
			_editingCellPos = [r,c];			

			//var colDataType = cols[_CONFIG_DATA_COL_OFFSET+c].childNodes[0].innerHTML.split('>')[1]; //type text is in a div for smaller font
			var colDataType = typeCell.childNodes[0].innerHTML.split('>')[1]; //type text is in a div for smaller font
			
			_editingCellElOldValue = el.innerHTML;
			
			var startingLinkId = "0";
			if(colType.indexOf('-') != -1)
				startingLinkId = colType.substr(colType.indexOf('-')+1);
			Debug.log("startingLinkId=" + startingLinkId);
			
			var str = "";			
			var typeOptionIndex = -1;
			var dataTypeOptionIndex = -1;
			
			if(r == _CONFIG_TYPE_ROW_OFFSET) //column type and data types
			{
				//do not allow type change if UID type
				if(colType != "UID")
				{
					str += "<select  onkeydown='keyHandler(event)' onchange='handleTypeSelect()' id='selectCellTypeSelect' style='float:left'>";
					for(var i=0;i<_typeArray.length;++i)
					{			
						str += "<option value='" + _typeArray[i] + "'>";
						str += _typeArray[i];	//can display however
						str += "</option>";
						
						if(typeOptionIndex == -1 && //only take first match
								el.getElementsByTagName("div")[0].innerHTML.indexOf(_typeArray[i]) == 0) 
							typeOptionIndex = i; //get starting sel index for type
					}				
					str += "</select>";
				}
				else
				{
					str += "UID ";
					str += "<input id='selectCellTypeSelect' value='UID' style='display:none'></input>";
				}
				str += "<input type='text' id='selectCellSpecTypeID' onkeydown='keyHandler(event)' " +
						"style='display:none; width:40px; float:left; height: 13px' value='" + 
						startingLinkId;
				str += "' onmousedown='_mouseIsSelecting = true; Debug.log(_mouseIsSelecting);' " +
						"onmouseup='_mouseIsSelecting = false; Debug.log(_mouseIsSelecting);' " +
						">";

				str += "<div id='clearDiv'></div>";				
				str += "<select onkeydown='keyHandler(event)'  id='selectCellDataTypeSelect'>";
				for(var i=0;i<_dataTypeArray.length;++i)
				{			
					str += "<option value='" + _dataTypeArray[i] + "'>";
					str += "&lt;" + _dataTypeArray[i] + "&gt;";	//can display however
					str += "</option>";
					if(dataTypeOptionIndex == -1 && //only take first match
							_editingCellElOldValue.indexOf("&lt;" + _dataTypeArray[i] + "&gt;") >= 0)
						dataTypeOptionIndex = i; //get starting sel index for data type
				}				
				str += "</select>";
			}
			else // column header names
			{
				str += "<input type='text' onkeydown='keyHandler(event)' " + 
						"style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + 
						"px; height:" + (el.offsetHeight-8) + "px' value='";
				str += _editingCellElOldValue;
				str += "' onmousedown='_mouseIsSelecting = true; Debug.log(_mouseIsSelecting);' " +
						"onmouseup='_mouseIsSelecting = false; Debug.log(_mouseIsSelecting);' " +
						">";
			}

			str += "<div style='padding:5px;background-color:#eeeeee;border:1px solid #555555;position:relative;" + 
					"width:105px;height:20px;margin:0 -122px -32px 10px;text-size: 16px;'>";
			str += "<a href='javascript:editCellOK("+r+","+c+");' style='color:green'>" +
					"<b style='color:green'>OK</b></a> | " +
					"<a href='javascript:editCellCancel();' style='color:red'>" + 
					"<b style='color:red'>Cancel</b></a>";
			str += "</div>";
			
			el.innerHTML = str;
			
			if(r == _CONFIG_TYPE_ROW_OFFSET) //select dropdown menu
			{
				//Debug.log("typeOptionIndex=" + typeOptionIndex +
				//		" dataTypeOptionIndex=" + dataTypeOptionIndex);
				
				if(colType != "UID")
				{
					el.getElementsByTagName("select")[0].selectedIndex = typeOptionIndex;
					el.getElementsByTagName("select")[1].selectedIndex = dataTypeOptionIndex;
					el.getElementsByTagName("select")[0].focus();
					handleTypeSelect();
				}
				else
				{
					el.getElementsByTagName("select")[0].selectedIndex = dataTypeOptionIndex;
					el.getElementsByTagName("select")[0].focus();
				}
					
			}
			else //select text box
				setCaretPosition(el.getElementsByTagName("input")[0],0,_editingCellElOldValue.length);
			
			return true;
		}
		
		//setCaretPosition
		function setCaretPosition(elem, caretPos, endPos) {
            elem.focus();
            elem.setSelectionRange(caretPos, endPos);
		}
		
		//keyHandler
		function keyHandler(e) 
		{
			var TABKEY = 9;
			var ENTERKEY = 13;
			var UPKEY = 38;
			var DNKEY = 40;
			var ESCKEY = 27;
			//Debug.log("key " + e.keyCode);
			
			var shiftIsDown;
			if (window.event) 
			{
				key = window.event.keyCode;
				shiftIsDown = !!window.event.shiftKey; // typecast to boolean
			} 
			else
			{
				key = e.which;
				shiftIsDown = !!e.shiftKey;	// typecast to boolean
			}
			//Debug.log("shift=" + shiftIsDown);
			
			//tab key jumps to next cell with a CANCEL
			//	(enter key does same except saves/OKs value)
			//	shift is reverse jump
			if(e.keyCode == TABKEY || e.keyCode == ENTERKEY || 
					e.keyCode == UPKEY || e.keyCode == DNKEY) 				
			{
				//this.value += "    ";
				if(e.preventDefault) 
					e.preventDefault();

				editCellOK();

				if(e.keyCode == ENTERKEY) //dont move to new cell
					return false;
							
				//jump forward (tab/enter) or backward (tab/enter+shift)
				//	or up or down.
				//get number of rows and cols
				//	to determine next row and col to jump to
				
				
				var newRow = _editingCellPos[0];
				var newCol = _editingCellPos[1];
				var el = document.getElementById("SubSystemTable");
				var rows = el.getElementsByTagName("tr");
				var numOfRows = _CONFIG_TYPE_ROW_OFFSET + 2;
				var numOfCols = _colHdrArr.length; //rows[_CONFIG_TYPE_ROW_OFFSET+1].getElementsByTagName("th").length - 
						//_CONFIG_DATA_COL_OFFSET;
				var cols;
				do
				{					
					if(e.keyCode == TABKEY || e.keyCode == ENTERKEY)
						newCol += (shiftIsDown?-1:1);
					else if(e.keyCode == UPKEY)
						--newRow;
					else if(e.keyCode == DNKEY)
						++newRow;
					
					//new position is chosen! now make it happen (in a clean way)	
									
					if(newCol == numOfCols)	{ ++newRow; newCol = 0;	}
					if(newRow == numOfRows) newRow = _CONFIG_TYPE_ROW_OFFSET;
					if(newCol < 0) {--newRow; newCol = numOfCols-1; }
					if(newRow < _CONFIG_TYPE_ROW_OFFSET) newRow = numOfRows-1;					

					cols = [];
					if(_tableIsTransposed)
					{
						//transpose all
						var tcols;
						for(var i=0;i<rows.length;++i)
						{	
							if(newRow == _CONFIG_TYPE_ROW_OFFSET)
							{
								tcols = rows[i].getElementsByTagName("td");	
								cols[i] = tcols[newRow];
							}
							else	//th is always the last newRow, so above works
							{
								tcols = rows[i].getElementsByTagName("th");
								cols[i] = tcols[0];
							}
						}
					}
					else
					{
						if(newRow == _CONFIG_TYPE_ROW_OFFSET)
							cols = rows[newRow].getElementsByTagName("td");
						else
							cols = rows[newRow].getElementsByTagName("th")
					}

					el = cols[_CONFIG_DATA_COL_OFFSET+newCol];
					
				} while(!selectThisCell(newRow,newCol,el));

				//Debug.log("newRow=" + newRow + " newCol=" + newCol);
				
				return false;
			}
			else if(e.keyCode == ESCKEY) 
			{				
				if(e.preventDefault) 
					e.preventDefault();
				editCellCancel();
				return false;
			}
		}
		
		//editCellOK
		function editCellOK() 
		{				
			if(!_editingCellEl) return;
			
			var r = _editingCellPos[0];
			var c = _editingCellPos[1];
			
			var str;
			
			try
			{
				if(r == _CONFIG_TYPE_ROW_OFFSET) //type and dataType
				{
					Debug.log("CfgTBL editCellOK editing r,c:" + r + "," + c);
					//get type and data type from select boxes (and input field for link ID)
					var sel = document.getElementById("selectCellTypeSelect");				
					var colType = sel.selectedIndex?sel.options[sel.selectedIndex].value:
							sel.value; //the else is case should be UID
					sel = document.getElementById("selectCellDataTypeSelect");
					var colDataType = sel.options[sel.selectedIndex].value;
					
					if(colType != "UID")
					{
						var specTypeArray = ["GroupID","ChildLink","ChildLinkUID","ChildLinkGroupID"];
								
						//if child link special type, append special type ID
						for(var i=0;i<specTypeArray.length;++i)
							if(colType == specTypeArray[i])
								colType += "-" + document.getElementById("selectCellSpecTypeID").value;
					}
										
					Debug.log("CfgTBL editCellOK editing colType,colDataType:" + 
							colType + "," + colDataType);
					
					_colTypeArr[c] = colType;
					_colDataTypeArr[c] = colDataType;
					setupTable();
					
					//show tooltips
					if(colType == "BitMap")
						DesktopContent.tooltip("BitMapType",
								"The BitMap type represents a 2-dimensional array of cells, " +
								"where each cell has a bit-field. The aspect ratio is optional. " +
								"The color fields are optional. " +
								"Optional fields you can leave as DEFAULT. \n\n" +
								"The aspect ratio should be entered as <Height>:<Width>; for example, " +
								"if you have a pixel chip with pixel size 100 microns by 150 microns you " +
								"may want your display to reflect that - you should enter &quot;100:150&quot (without the quotes)."
								);
					else if(colType == "FixedChoiceData")
						DesktopContent.tooltip("FixedChoiceDataType",
								"The FixedChoiceData type represents a list of choices that constrain " +
								"the allowed values for a field. " +
								"The DEFAULT value must always be one of the choices. "
								);
				}			
				else //colHdr row
				{
					Debug.log("CfgTBL editCellOK editing r,c:" + r + "," + c + 
							" = " + _editingCellEl.getElementsByTagName("input")[0].value);
					str = _editingCellEl.getElementsByTagName("input")[0].value;
					_colHdrArr[c] = str;
					_editingCellEl.innerHTML = "";
					_editingCellEl.appendChild(document.createTextNode(str));				
				}
			}
			catch(err)
			{
				Debug.log("Error was caught! Error: " + err, Debug.HIGH_PRIORITY);
			}
			

			_editingCell = false;
			_editingCellEl = 0;
		}
		
		//editCellCancel
		function editCellCancel() 
		{	
			if(_editingCellEl)
				_editingCellEl.innerHTML = _editingCellElOldValue;
			
			_editingCell = false;
			_editingCellEl = 0;
		}
		

		//addColumn ~~
		// adds col to position c (relative to view on page)
		// absolute col is _dataOffset + c
		function addColumn(c) 
		{
			Debug.log("CfgTBL addColumn " + c);
			
			_colHdrArr.splice(c,0,"DefaultColumnName");
			_colTypeArr.splice(c,0,"Data");
			_colDataTypeArr.splice(c,0,"VARCHAR2");
			_colChoicesArr.splice(c,0,"");
			
			setupTable(0,_colHdrArr,_colTypeArr,_colDataTypeArr,_colChoicesArr);
		}
		
		//deleteColumn ~~
		// deletes col to position c (relative to view on page)
		// absolute col is _dataOffset + c
		function deleteColumn(c) 
		{
			Debug.log("CfgTBL deleteColumn " + c);
			
			_colHdrArr.splice(c,1);
			_colTypeArr.splice(c,1);
			_colDataTypeArr.splice(c,1);
			_colChoicesArr.splice(c,1);
			
			setupTable(0,_colHdrArr,_colTypeArr,_colDataTypeArr,_colChoicesArr);
		}

		//transposeTable ~~
		function transposeTable()
		{
			_tableIsTransposed = !_tableIsTransposed;
			Debug.log("CfgTBL transposeTable " + _tableIsTransposed);
			
			setupTable();
		}
		

		//createEditTableMenu ~~
		function createEditTableMenu(event)
		{
			var menuItems = [
							 "Find and Replace",							 
							 "Transpose Table View"
									 ];
			var menuItemHandlers = [
							 "setupFindAndReplace()",
							 "transposeTable()"							 							 
									 ];
			Debug.log("createEditTableMenu()");
			SimpleContextMenu.createMenu(
					menuItems,
					menuItemHandlers,
					"editTableMenu",					//element ID
					event.pageX-1,event.pageY-1, 	//top left position
					"rgb(220, 187, 165)", 			//primary color
					"rgb(130, 51, 51)"				//secondary color
			);
		}
		

		//setupFindAndReplace
		function setupFindAndReplace()
		{			 
			var el;
			
			//if there were any other types of controls, clear them 
			//	here {}
			
			el = document.getElementById('findAndReplace'); 
			if(el.innerHTML != "") { el.innerHTML = ""; return; } //hide if already shown
			
			_lastFindRow = _lastFindCol = -1; //initialize find location
			var str = "";
			str += "Search in all column names for text... <br>";			
			str += "<input type='text' id='findAndReplaceNeedle' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value=''>";
			str += "<br>";
			str += "Replace with... <br>";
			str += "<input type='text' id='findAndReplaceWith' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value=''>";
			
			//make div for translating innerHTML and value
			str += "<div id='findAndReplaceHTML' style='display:none'></div>";
			
			str += "<br><br>";
			//			str += "<input type='button' onmouseup='configFind()' value='Find' title='" +
			//					"Find every occurance of \'For text...\" in the Column(s) specified by \'Search in column.\'" +
			//					"'/>";
			//			str += " ";
			str += "<input type='button' onmouseup='configReplace()' value='Replace' title='" +
					"Replace every occurance of \'For text...\" in the Column(s) specified by \'Search in column\' with the string specified in \'Replace with...\'" +
					"'/>";			
			str += "<br><br>";
			el.innerHTML = str;						
		}

		//configReplace ~~
		function configReplace()
		{			
			editCellCancel();			
			var needle = document.getElementById("findAndReplaceNeedle").value;
			var convertEl = document.getElementById("findAndReplaceHTML");
			
			//convert needle to HTML for search
			convertEl.innerHTML = "";
			convertEl.appendChild(document.createTextNode(needle));
			needle = convertEl.innerHTML; //converted text
			
			var replaceStr = document.getElementById("findAndReplaceWith").value;
			
			//convert replaceStr to HTML for search
			convertEl.innerHTML = "";
			convertEl.appendChild(document.createTextNode(replaceStr));
			replaceStr = convertEl.innerHTML; //converted text
			
			Debug.log("configReplace '" + needle + "' with '" + replaceStr + "'");
			
			//change hdrs and types 
			var cellStr;
			
			for(var c=0;c<_colHdrArr.length-3;++c) //skip last 3 fixed columns
			{
				cellStr = _colHdrArr[c];
				tmpStr = cellStr;
				Debug.log("[" + c + "]=" + cellStr);
				needleStartIndex = 0;
				while(cellStr.indexOf(needle,needleStartIndex) >= 0)
				{
					cellStr = cellStr.replace(needle,replaceStr);
					if(cellStr == tmpStr) break; //in case replace is same as needle
					Debug.log("REPLACED=" + cellStr);		
					needleStartIndex += replaceStr.length;
				}
				_colHdrArr[c] = cellStr;
			}

			var linkIdIndex, linkType;
			for(var c=0;c<_colTypeArr.length-3;++c) //skip last 3 fixed columns
			{
				cellStr = _colTypeArr[c];
				linkIdIndex = cellStr.indexOf('-');
				if(linkIdIndex < 0) continue; //skip all non-link cells
				
				linkType = cellStr.substr(0,++linkIdIndex);
				cellStr = cellStr.substr(linkIdIndex);
				
				tmpStr = cellStr;
				Debug.log("[" + c + "]=" + cellStr);
				needleStartIndex = 0;
				while(cellStr.indexOf(needle,needleStartIndex) >= 0)
				{
					cellStr = cellStr.replace(needle,replaceStr);
					if(cellStr == tmpStr) break; //in case replace is same as needle
					Debug.log("REPLACED=" + cellStr);		
					needleStartIndex += replaceStr.length;
				}
				_colTypeArr[c] = linkType + cellStr;
			}
			
			setupTable();
						
		}
		
		//addFixedChoice ~~
		//	for column c
		function addFixedChoice(c)
		{
			//if not already in choices, add it		
			
			var val = document.getElementById("newChoiceInput-" + c).value;
			Debug.log("addFixedChoice Value = " + val);
			var defaultVal = _defaultArray[_colDataTypeArr[c]][_colTypeArr[c]];
			Debug.log("deleteSelectedFixedChoice defaultVal = " + defaultVal);

			if(encodeURIComponent(val) == defaultVal)
			{
				Debug.log("Value '" + val + "' is the default value for column '" + 
					_colHdrArr[c] + "' and so it is always a fixed choice option. " +
							"No need to add it to the list.",
						Debug.HIGH_PRIORITY);
				return;
			}
			
			if(c >= _colChoicesArr.length)
			{
				Debug.log("Invalid column '" + c + "' given.",
						Debug.HIGH_PRIORITY);
				return;
			}
				
			var colChoicesArr = _colChoicesArr[c].split(',');
			var found = false;
			for(var i=0;i<colChoicesArr.length;++i)
				if(colChoicesArr[i] == val)
				{	found = true; break; }
			
			if(found)
			{
				Debug.log("Value '" + val + "' is already a fixed choice option for column '" + 
					_colHdrArr[c] + "'",
						Debug.HIGH_PRIORITY);
				return;
			}

			if(_colChoicesArr[c].length) //other values exist
				_colChoicesArr[c] += "," + encodeURIComponent(val);
			else						//first value
				_colChoicesArr[c] = encodeURIComponent(val);
			
			setupTable();
			Debug.log("Value '" + val + 
					"' was successfully added as a fixed choice option for column '" + 
					_colHdrArr[c] + "'",
					Debug.INFO_PRIORITY);
		}
		
		//deleteSelectedFixedChoice ~~
		//	for column c
		function deleteSelectedFixedChoice(c)
		{
			//find the value in choices, and remove it

			if(c >= _colChoicesArr.length)
			{
				Debug.log("Invalid column '" + c + "' given.",
						Debug.HIGH_PRIORITY);
				return;
			}

			var val = document.getElementById("fixedChoicesSelect-" + c).value;
			Debug.log("deleteSelectedFixedChoice Value = " + val);
			val = encodeURIComponent(val);
			var colChoicesArr = _colChoicesArr[c].split(',');
			var defaultVal = _defaultArray[_colDataTypeArr[c]][_colTypeArr[c]];
			Debug.log("deleteSelectedFixedChoice defaultVal = " + defaultVal);
			
			
			var found = -1;
			var deletedDefault = false;
			for(var i=0;i<colChoicesArr.length;++i)
				if(colChoicesArr[i] == defaultVal) //do not allow defaultVal to be in the list	
				{
					colChoicesArr[i] = ""; //clear value, default value is implied as first in list always
					deletedDefault = true;
				}
				else if(colChoicesArr[i] == val)
				{	found = i; break; }

			
			//rebuild choices string
			if(found != -1 || deletedDefault)
			{
				_colChoicesArr[c] = "";
				var cnt = 0;
				for(var i=0;i<colChoicesArr.length;++i)
				{
					if(i == found) continue; //skip one to be removed
					if(colChoicesArr[i] == "") continue; //skip empty values
					
					if(cnt)
						_colChoicesArr[c] += "," + colChoicesArr[i];
					else	//first choice added
						_colChoicesArr[c] = colChoicesArr[i];
					
					++cnt;					
				}
				setupTable();
			}

			//finish up with message to user

			if(deletedDefault)
			{
				Debug.log("Deafult Value '" + decodeURIComponent(defaultVal) + 
						"' was found multiple times in the list of choices. " +
						"The fixed choice options were cleaned up for column '" + 
					_colHdrArr[c] + "'",
						Debug.INFO_PRIORITY);
			}
			
			if(found == -1)
			{
				if(val == defaultVal)
				{
					Debug.log("Value '" + decodeURIComponent(val) + 
							"' is the default value for column '" + 
						_colHdrArr[c] + "' and can not be removed from the fixed choice options.",
							Debug.HIGH_PRIORITY);
				}
				
				Debug.log("Value '" + decodeURIComponent(val) + 
						"' was not found in existing fixed choice options for column '" + 
					_colHdrArr[c] + "'",
						Debug.HIGH_PRIORITY);
				return;
			}
			
			Debug.log("Value '" + decodeURIComponent(val) + 
					"' was successfully removed from the fixed choice options for column '" + 
					_colHdrArr[c] + "'",
					Debug.INFO_PRIORITY);
		}
		

		//downloadFixedChoices ~~
		//	for column c
		//
		// online people complain that this doesn't work for big files.
		// Note: if files are too big, could have server create csv file
		//	then link to <a href='/WebPath/download.csv' download></a>
		//	Note: href must be  encodeURI(dataStr) if data not already encoded
		function downloadFixedChoices(c)
		{
			editCellOK(); //editCellCancel();
			Debug.log("TableEditor downloadFixedChoices ");
			
			var configName = document.getElementById("SaveAsConfigName").value;

			var colChoicesArr = _colChoicesArr[c].split(',');
			
			//create CSV data string from html table
			var dataStr = "data:text/csv;charset=utf-8,";
			for(var i=0;i<colChoicesArr.length;++i)
			{
				if(i)
					dataStr += encodeURI("\n"); //encoded \n //each choice is a column
				dataStr += colChoicesArr[i];
			}
			
			Debug.log("CfgGUI downloadTableAsCSV dataStr=" + dataStr);

			
			var link = document.createElement("a");
			link.setAttribute("href", dataStr); //double encode, so encoding remains in CSV
			link.setAttribute("style", "display:none");
			link.setAttribute("download", configName + "_" + 
					_colHdrArr[c] + "_fixedChoices_download.csv");
			document.body.appendChild(link); // Required for FF

			link.click(); // This will download the data file named "my_data.csv"

			link.parentNode.removeChild(link);
		}

		//popUpUploadFixedChoicesForm ~~
		//	for column c
		var _dataUploadStr;
		function popUpUploadFixedChoicesForm(c)
		{			
			Debug.log("ConfigurationAPI.bitMapDialog.locaPopupUploadCSV");	
			_dataUploadStr = ""; //clear previous upload

			var str = "";

			var pel = document.getElementById("popUpDialog");
			if(!pel)
			{
				pel = document.createElement("div");			
				pel.setAttribute("id", "popUpDialog");
			}
			pel.style.display = "none";

			//set position and size
			var w = 380;
			var h = 195;
			ConfigurationAPI.setPopUpPosition(pel,w /*w*/,h /*h*/);
			
			var str = "<a id='" + 
					"popUpDialog" + //clear upload string on cancel!
					"-header' onclick='javascript:_dataUploadStr = \"\"; var pel = document.getElementById(" +
					"\"popUpDialog\"); if(pel) pel.parentNode.removeChild(pel); return false;'>Cancel</a><br><br>";

			str += "<div id='popUpDialog-div'>";	

			str += "Please choose a properly formatted CSV data file (i.e. fixed choices, in one column, separated by new lines) " +
					"to upload:<br><br>";

			str += "<center>";

			str += "<input type='file' id='popUpDialog-fileUpload' " + 
					"accept='.csv' enctype='multipart/form-data' />";			
		
			// done with special handling
			// continue with pop-up prompt
			str += "</center></div><br><br>"; //close main popup div

			var onmouseupJS = "";
			onmouseupJS += "document.getElementById(\"popUpDialog-submitButton\").disabled = true;";
			onmouseupJS += "uploadFixedChoices(" + c + ");";			

			str += "<input id='popUpDialog-submitButton' disabled type='button' onmouseup='" + 
					onmouseupJS + "' " +
					"value='Upload File' title='" +
					"Upload the chosen file to replace the row,col data in the current bitmap." +					
					"'/>";

			pel.innerHTML = str;
			document.body.appendChild(pel); //add element to body
			pel.style.display = "block";

			document.getElementById('popUpDialog-fileUpload').addEventListener(
					'change', function(evt) {
				var files = evt.target.files;
				var file = files[0];           
				var reader = new FileReader();
				reader.onload = function() {
					//store uploaded file and enable button
					_dataUploadStr = this.result;
					Debug.log("_dataUploadStr = " + _dataUploadStr);							
					document.getElementById('popUpDialog-submitButton').disabled = false;
				}
				reader.readAsText(file);
			}, false);
		
		}
		
		//uploadFixedChoices ~~
		//	for column c
		function uploadFixedChoices(c)
		{
			Debug.log("uploadFixedChoices _dataUploadStr = " + _dataUploadStr);
			var src = _dataUploadStr.split('\n');
			console.log(src);
			
			_colChoicesArr[c] = ""; //clear

			for(var i=0;i<src.length;++i)
			{				
				if(i) _colChoicesArr[c]	+= ",";
				_colChoicesArr[c] += encodeURIComponent(src[i]);
			}
			setupTable();

			//on succes remove popup
			el = document.getElementById("popUpDialog"); 
			if(el) el.parentNode.removeChild(el);
			
			Debug.log("Fixed choices were successfully uploaded!",
					Debug.INFO_PRIORITY);
		}
		
		
	</script>
		
</head>
	

<body onload='Javascript:init();'>	
		
	<h1>Configuration Table Editor</h1>

	<div style='width:550px'>	
	<a href='javascript:init()'>Refresh Window</a> 	&nbsp;&nbsp;
	<a href='javascript:setupEmptyTable()'>Clear Table</a> 	&nbsp;&nbsp;

	<a style='margin-left:300px' target="_blank" 
			href="https://cdcvs.fnal.gov/redmine/projects/otsdaq/search?utf8=%E2%9C%93&wiki_pages=1&q=table+editor&all_words=1&issues=1&documents=1" 
					title="Click to open ots documentation">
	<img src="/WebPath/images/dashboardImages/icon-Help.png"></a>
	</div>
	
	<hr>
	
	<div id='controls'></div>
	<div id='display'></div>

	<div class='preloadImage' id='preloadImage-treeEditTrashIcon'></div>
	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
</body>
	
</html>
