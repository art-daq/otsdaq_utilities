<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>ConfigurationGUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<style type="text/css">			
		
		body {
			/*overflow: hidden; /* scrolling only happens in left and right panes */			
		}

		/* make buttons have a hand cursor */
		input[type="button"], button {
			cursor: pointer;
		}
		
		.pane {
			border: 0;
			position: absolute;
		}

		#topPane {
			overflow-y: auto;
			overflow-x: hidden;
		}

		#midPane {
			/*background-color : rgb(241, 231, 231);*/
			overflow-x: auto;
			overflow-y: auto;
			margin-top: 40px;
		    border-top: 1px solid rgb(224, 196, 196);
			width: 100%;
						
		}

    	/* for mouse over highlighting */
		.myOption:hover 
		{
            background-color : rgb(241, 231, 231);
		}    
		#recordMultiSelect .optionhighlighted:hover,
		.groupFilterMultiSelect .optionhighlighted:hover
		{
			background-color : rgb(11, 66, 138);
		}
		
		.recordAdd {
			text-decoration: none;
			font-size: 30px;
			font-weight: bold;
			color: rgb(15, 152, 76);
		}
		.recordAdd:hover {
			text-decoration: none;
			color: rgb(16, 204, 16);
		}
		
		#recordsNameDiv {
			float: left;
			font-size: 20px;
		}
		
		#copyRecordsDiv {
	    	margin: 			-7px 10px 0px 15px;
			float: 				left;
		}
		#copyRecordsDiv:hover {
			cursor:				pointer;
		}
		#copyRecordsDiv * {
			border: 			2px solid rgb(106, 100, 125);
			width:				10px;
			height:				11px;
			float: 				left;
		    border-radius: 		2px;
		}
		#copyRecordsDiv:hover * {
			border: 			2px solid rgb(119, 126, 204);			
		}
		#copyRecordsDiv:hover #copyRecordsSubdiv2 {
			background-color:	white;		
		}
		#copyRecordsSubdiv1 {
			margin: 			6px 0px -20px -10px;
		}
		#copyRecordsSubdiv2 {
			margin: 			10px 0px -20px -19px;
			background-color:	rgb(200,200,200);	
		}
		#editRecordNameDiv {
			margin: 			-1px 10px 4px 29px;
			float: 				left;
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEdit.png);
			width: 				24px;
			height: 			20px;
		}	
		#editRecordNameDiv:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEditHover.png);
			cursor: 			pointer;
		}
		#recordAddDiv {
	    	margin: 			-7px 16px 0 10px;
			float: 				left;
		}
		#recordDeleteDiv{
			margin: 			-1px 20px 0 0;
			float: 				left;
		}
		
		.treeNode-deleteIcon {			
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCan.png);
			width: 				16px;
			height: 			20px;
			border: 			0;
			margin: 			-9px 0 -10px 10px;
		}
		.treeNode-deleteIcon:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
			cursor: 			pointer;
		}

		.preloadImage {			
			width: 				24px;
			height: 			20px;
			position:			absolute;
			left: 				-100px;
			top: 				0;
		}
		#preloadImage-treeEditTrashIconHover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
		}

		.formHeader * {
			line-height: 40px;
		}

		.formHeader .label {
			float: left;
			font-size: 18px;
			font-weight: bold;

		}

		/* expand button */
		.expand {
			background-image: 	url(/WebPath/images/windowContentImages/SlowControlsDashboardFileTree-toggle-small-expand.png);
			background-size: contain;
			width: 				48px;
			height: 			40px;
			float: right;
		}

		.expand:hover {
			cursor: pointer;
			opacity: 0.8;
		}

		/* collapse button */
		.collapse {
			background-image: 	url(/WebPath/images/windowContentImages/SlowControlsDashboardFileTree-toggle-small.png);
			background-size: contain;
			width: 				48px;
			height: 			40px;
			float: right;
			display: none;
		}

		.collapse:hover {
			cursor: pointer;
			opacity: 0.8;
		}

		hr {
			width: 100%;
		}
		
	</style>
	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopContent.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>
	
	<script>
	
		// TODO: write the new description
		//	Description of Configuration-FHiCL Functionality/Behavior:
		//	
		//	GET parameters:
		//		<subsetBasePath> = Records at this path are the target of this GUI, e.g. “FEInterfaceConfiguration”
		//		<groupingFieldList> = CSV list of tree paths relative to <baseTable>, e.g. “LinkToFETypeConfiguration,FEInterfacePluginName”
		//									- these are the fields that can be used to filter UID records by (and these will cause grouping in square-view)	
		//		<editableFieldList> = empty string or "DEFAULT" for all, or CSV list of fields to show for editing
		//		<recordPreFilterList> = CSV list (of forced filter) of tree paths relative to <baseTable> and = value, e.g. "LinkToFETypeConfiguration=NIMPlus,FEInterfacePluginName=NIMPlusPlugin"
		//									- this is like a pre-filter (filter on records UID that user can not control)
		//		<recordsAlias> = Records display name, e.g. "Front-ends"
		//
		//	- Requires user to have LOCK
		//
		//	- Top Pane:
		//		* for header info (e.g. subsetBasePath)
		//
		//	- Split remaining window into two panes: Left and Right; Left is fixed width and hideable.	
		//	
		//	- Left Pane:
		//		* Fixed width, vertical auto scroll, hideable.
		//		* Filter icon that toggles display of multi-select boxes for each <subLevelGrouping>. 
		//		* Filtering:
		//		 	- AND/OR option if multiple sublevels
		//			- multi-select for each <subLevelGrouping>
		//		* Icon to toggle record representation (Multi-select or Square Grid groupings)
		//		* Record UID Selector:
		//			- Multi-select box for selection of UID (based on sublevelgrouping filters)
		//		* Alternatively can represent the detectors as squares (with mouse over UID names)
		//			- Squares will be grouped by SubLevel using AND logic with a sublevel-label
		//					
		//	- Right Pane:
		//		* Show toggle Left Pane link
		//		* Show fields that are common based on SubLevelGrouping filters
		//			- E.g. if *,* then can only show SlowControls fields
		//			- Challenge: show all common fields, even through links
		//			- Allow editing the field (based on type) .. same as tree edit, but like already clicked
		//			- A field becomes the "selected" field when clicked
		//				= the selected field should survive resizing, and get reset on filtering
		//			- A field enters edit mode when pencil is clicked
		//			- TAB and SHIFT+TAB should jump to next field for editing
		//		* Buttons at top and bottom: Read All, Write All, Read Selected, Write Selected.
		//		
		//	- Save functionality should be same as saving tree	
		//		* TODO:: If admin, could give options to target a certain system alias.. Etc.
		//		* Else assume saving to currently active groups

		
				
		var _TABLE_BOOL_TYPE_TRUE_COLOR = "rgb(201, 255, 201)";
		var _TABLE_BOOL_TYPE_FALSE_COLOR = "rgb(255, 178, 178)";
		
		
		var _mainPane, _topPane;
		// var _leftPaneHidden = false;
		
		// var _rightPaneFields;
		// var _RIGHT_PANE_RW_BTN_HEIGHT = 48;
		
		var eventListenersCreated = false;
		
		//global vars for GET params
		var _subsetBasePath;			
		var _groupingFieldList;	
		// var _editableFieldList;			
		// var _recordPreFilterList;
		var _recordsAlias;
		
		var _mapOfGroupFieldToLinkIndex = {};
		// var _selectedGroupFieldValues;	
		// var _selectedGroupIDs;	
		// var _selectedRecords;	
		
		//global vars for multiselects				
		var _valsObj; //for each filter MultiSelect (one for each grouping field), an array of filter values
		var _subsetUIDs; //array of UIDs defined by the subset selected filterVals in multiselects (based on _subsetBasePath and _recordPreFilterList)
		// var _filterTimer;
		MultiSelectBox.REQUIRE_CTRL_MULTI_CLICK = true; //require control
		
		//global vars for fields
		var _selectedFieldIndex = -1;
		var _editFieldIndex = -1;	
		var _fields;
		
		//global vars for saving tables
		var _modifiedTables;
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:			
			//init()
			//paint() 
			//extractGETParameters()
			//initSubsetGlobalData()
			//runFilter(selectFirstRecord,loadSelectedRecord)
			//updateRecordsAndFields(selectFirstRecord,loadSelectedRecord)
		
			//createTopPaneContent()
			//createLeftPaneContent(leftW)
			//		localCreateGroupingFieldFilters()
			//		localCreateRecordsSelector()
			//groupFilterSelectionHandler(el)
			//createRightPaneContent()
			//		localAddReadWriteButtons(cel)
		
			//		getSelectedRecords(forceOne)
			//btnActionReadAllFields()
			//btnActionReadOneField()
			//btnActionWriteAllFields()
			//btnActionWriteOneField()
		
			//deleteRecords()
			//	localProceedWithDelete()
			//addRecord()
			//	localFinishSave()
			//renameRecord()
			//	localFinishSave()
			//copyRecords()
			//	localProceedWithCopy()
		
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
				

		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init() 
		{									
			Debug.log("CfgGUI_FHiCL_editor init ");			
			
			//extract get parameters
			if(!extractGETParameters())
			{
				Debug.log("Illegal GET parameters. Aborting.", Debug.HIGH_PRIORITY);
				return;
			}

			// prepare the info for the page tooltip
			var windowTooltip = "Welcome to the Configuration-FHiCL GUI targeting " + _recordsAlias +
				". Here you can manipulate the fields of a FHiCL file. \n\n" +
				"The organization of the Configuration-FHiCL GUI is in the form where you can directly edit the fields.\n\n";

			DesktopContent.tooltip("Configuration-FHiCL GUI Introduction", windowTooltip);
			DesktopContent.setWindowTooltip(windowTooltip);

			// get subset record uids and 
			//	filter values for all possible grouping fields
			//	calls paint() and adds resize listener when done
			initSubsetGlobalData();						
		} //end init()
		
		//=====================================================================================
		//paint ~~
		//	positiong left and right panes based on window size
		function paint() 
		{				
			if(!_mainPane && !_topPane)
			{
				//first time create elements
				createTopPaneContent();
				createMainPaneContent();				
				updateRecordsAndFields();
			}						
		}	//end paint()

		//=====================================================================================
		//updateRecordsAndFields ~~
		//	update records selector display
		//		based on _subsetUIDs
		function updateRecordsAndFields() 
		{
			var el = document.getElementById("mainForm");
			if(!el) 
			{
				Debug.log("Error: updateRecordsSelector null"); 
				return; 
			} 
			
			
			var vals = _subsetUIDs;
			var keys = [];
			var types = [];
			for(var  j = 0; j < vals.length; ++j)
			{
				keys.push(j);
				types.push("record");								
			}
			
			var str = "";
			el.innerHTML = "";
			for (const val of vals) 
			{
				var header = document.createElement("div");
				header.setAttribute("class", "formHeader");
				header.setAttribute("id", "recordsNameDiv-" + val);

				// label
				var label = document.createElement("span");
				label.setAttribute("class", "label");
				label.textContent = val;
				header.appendChild(label);

				// expand button
				var expand = document.createElement("span");
				expand.setAttribute("class", "expand");
				expand.onclick = () => handleExpand(val);
				header.appendChild(expand);
				// collapse button
				var collapse = document.createElement("span");
				collapse.setAttribute("class", "collapse");
				collapse.onclick = () => handleCollapse(val);
				header.appendChild(collapse);

				// separator
				header.appendChild(document.createElement("hr"));
				el.appendChild(header);
			}


			// //write MultiSelectBox to a particular div
			// MultiSelectBox.createSelectBox(
			// 		el,
			// 		"RecordsGroupBox",
			// 		str,
			// 		vals,keys,types,groupFilterSelectionHandler,noMultiSelect,
			// 		0 /* mouseOverHandler */,
			// 		0 /* iconURLs */,
			// 		0 /* mouseDownHandler */,
			// 		0 /* mouseUpHandler */,
			// 		true /* requireCtrlMultiClick */);

				
			// MultiSelectBox.initMySelectBoxes(!maintainPreviousSelections);

			// if(selectFirstRecord && vals.length)
			// { //do after first init, otherwise does not seem to work
			// 	Debug.log("Selecting first record...");
			// 	MultiSelectBox.setSelectionElementByIndex(el,0,true);
			// 	MultiSelectBox.initMySelectBoxes(); //update display
			// }
			// else if(loadSelectedRecord) //apply selectRecords
			// {
			// 	var selectRecords = _selectedRecords.split(',');
			// 	Debug.log("selectRecords length " + selectRecords.length);
			// 	var selArr = MultiSelectBox.getSelectionArray(el);
			// 	if(selectRecords.length && selectRecords[0].length)
			// 	{
			// 		for(var j=0;j<selectRecords.length;++j)
			// 		{
			// 			//find select UID in multi-select values

			// 			for(var k=0;k<selArr.length;++k)
			// 			{
			// 				if(selectRecords[j] ==
			// 						MultiSelectBox.getSelectionElementByIndex(el,k).innerText)
			// 				{
			// 					Debug.log("Found pre-select record " + 
			// 							selectRecords[j]);
			// 					MultiSelectBox.setSelectionElementByIndex(el,k,true /*selected*/);								
			// 				}
			// 			}
			// 		} //end record search loop
			// 	}
				
			// 	MultiSelectBox.initMySelectBoxes(); //update display of all multi-select boxes
									
			// }
			
			//get grouping field values
			//	for record list
			// _rightPaneFields.innerHTML = ""; //clear any existing fields
			
			// if(!vals.length)
			// {
			// 	Debug.log("No records match filters, so not proceeding with field lookup.");
			// 	return;
			// }
			
			

		} //end updateRecordsAndFields()

		//=====================================================================================
		//hendleExpand ~~
		function handleExpand(target) {
			// get the target DOM object
			var el = document.getElementById("recordsNameDiv-" + target);
			// change the buttons
			for (child of el.children){
				if (child.className === "expand") {
					child.style.display = "none";
				} else if (child.className === "collapse") {
					child.style.display = "block";
				}
			}
			// TODO: show the rlative form
			var form = document.getElementById("form-" + target);
			if (!form)	// we have to load it
			{
				form = document.createElement("div");
				form.setAttribute("id", "form-" + target);
				form.setAttribute("class", "field-form");

				ConfigurationAPI.getFieldsOfRecords(
					_subsetBasePath,
					target,
					_editableFieldList,
					1 /*maxDepth*/,
					function(recordFields)
					{				
                        _fields = recordFields;
                        Debug.log("recordFields found = " + recordFields.length);
                        console.log("recordFields", recordFields);

                        if(!recordFields.length)
                        {
                            Debug.log("No common fields found among current set of records! " +
                                    "Something is wrong - check. the window input parameters.",
                                    Debug.HIGH_PRIORITY);
                            return;
                        }
					}, //end getFieldsOfRecords handler
					 _modifiedTables);
				// // load the fields od the form
				// ConfigurationAPI.getFieldValuesForRecords(
				// 	_subsetBasePath,
				// 	[target],
				// 	_fields,
				// 	function(fieldValues) {
				// 		console.log(fieldValues);
				// 	},
				// 	_modifiedTables
				// );
			}

			// show the hidden form
			form.style.display = "block";
		}

		//=====================================================================================
		//hendleCollapse ~~
		function handleCollapse(target) {
			// get the target DOM object
			var el = document.getElementById("recordsNameDiv-" + target);
			// change the buttons
			for (child of el.children){
				if (child.className === "expand") {
					child.style.display = "block";
				} else if (child.className === "collapse") {
					child.style.display = "None";
				}
			}
			// hide the view of the form
			var form = document.getElementById("form-" + target);
			form.style.display = "none";
			
		}
		//=====================================================================================
		//extractGETParameters ~~
		//	return false, if illegal params
		// TODO: check the parameter that are actually needed
		function extractGETParameters() 
		{
			//extract get parameters (most optional)
			//		<subsetBasePath> 		= Records at this path are the target of this GUI, e.g. "FEInterfaceConfiguration"
			//		<groupingFieldList> 	= CSV list of tree paths relative to <baseTable>, e.g. "LinkToFETypeConfiguration,FEInterfacePluginName"
			//		<selectedGroupFieldValues>	= Pre-chosen selections for grouping field filters
			//		<editableFieldList> 	= empty string or "DEFAULT" for all, or CSV list of fields to show for editing
			//		<recordPreFilterList> 	= semicolon-separated list (of forced filter) of tree paths relative to <baseTable> and = value (CSV for multiple values), e.g. "LinkToFETypeConfiguration=NIMPlus;FEInterfacePluginName=NIMPlusPlugin,FEOtsUDPTemplateInterface"
			//		<selectedRecords> 		= CSV list of pre-chosen record UID selections (this will override default behavior of selecting the first record,.. if only one record is chosen, that record will be loaded) 
			//		<recordsAlias> 			= PLURAL Records display name, e.g. "Front-ends"
			
			_subsetBasePath	= DesktopContent.getParameter(0,"subsetBasePath");//"FEInterfaceConfiguration"; //DesktopContent.getParameter(0,"subsetBasePath");			
			_groupingFieldList = DesktopContent.getParameter(0,"groupingFieldList"); //"LinkToFETypeConfiguration,FEInterfacePluginName"; //DesktopContent.getParameter(0,"groupingFieldList");			
			// _editableFieldList	= DesktopContent.getParameter(0,"editableFieldList");//"";//DesktopContent.getParameter(0,"editableFieldList");			
			// _recordPreFilterList= DesktopContent.getParameter(0,"recordPreFilterList"); //"";//FEInterfacePluginName=myNewInterface";//DesktopContent.getParameter(0,"recordPreFilterList");
			_recordsAlias = DesktopContent.getParameter(0,"recordAlias"); //"Front-ends"; //default to records
			
			// _selectedGroupFieldValues = DesktopContent.getParameter(0,"selectedGroupFieldValues"); //"ParameterGroupID=myNewInterfaceParameters,myNewInterfaceParameters;FEInterfacePluginName=myNewInterface""; 
			// _selectedGroupIDs 	= DesktopContent.getParameter(0,"selectedGroupIDs"); //"ParameterGroupID=myNewInterfaceParameters,myNewInterfaceParameters;FEInterfacePluginName=myNewInterface""; 
			// _selectedRecords	= DesktopContent.getParameter(0,"selectedRecords"); //"myNewInterface,myNewInterface2";
									
			
			if(!_subsetBasePath)
			{
				Debug.log("Missing required GET parameter 'subsetBasePath.'", Debug.HIGH_PRIORITY);
				return false;
			}
			if(!_groupingFieldList) _groupingFieldList = "";
			// if(!_editableFieldList) _editableFieldList = "";
			// if(!_recordPreFilterList) _recordPreFilterList = "";
			if(!_recordsAlias) _recordsAlias = "Records";
			
			// if(!_selectedGroupFieldValues) _selectedGroupFieldValues = "";
			// if(!_selectedGroupIDs) _selectedGroupIDs = "";
			// if(!_selectedRecords) _selectedRecords = "";

			Debug.logv({_subsetBasePath});
			Debug.logv({_groupingFieldList});
			// Debug.logv({_editableFieldList});
			// Debug.logv({_recordPreFilterList});
			Debug.logv({_recordsAlias});

			// Debug.logv({_selectedGroupFieldValues});
			// Debug.logv({_selectedGroupIDs});
			// Debug.logv({_selectedRecords});
			return true;
		}	//end extractGETParameters()
		
		//=====================================================================================
		//initSubsetGlobalData ~~
		//	fills _subsetUIDs
		//		array of UIDs defined by the subset (based on _subsetBasePath and _recordPreFilterList)
		//	fills _valsObj
		//		for each filter MultiSelect (one for each grouping field), an array of filter values
		function initSubsetGlobalData() 
		{
			//get list of records that match <subsetBasePath> AND <recordPreFilterList>
			_subsetUIDs = []; //reset
			_valsObj = {}; //reset
			_fields = undefined; //reset
			_modifiedTables = undefined; //reset
			_mapOfGroupFieldToLinkIndex = {}; //reset
			
			// if the view is already loaded I have to reset it
			if(_mainPane && _topPane)
			{
				_topPane.innerHTML = ""; //clear
				_mainPane.innerHTML = ""; //clear
				_topPane.parentNode.removeChild(_topPane); //remove element
				_mainPane.parentNode.removeChild(_mainPane); //remove element
			}

			_topPane = undefined; //reset
			_mainPane = undefined; //reset
						
			// window.clearTimeout(_filterTimer); 
			_selectedFieldIndex = -1;
			_editFieldIndex = -1;
			
			ConfigurationAPI.getSubsetRecords(
					_subsetBasePath,
					"",	// no filter
					function(records)
					{
                        _subsetUIDs = records;
                        Debug.log("records found = " + records.length);
						
                        //groupingFieldList = AUTO is special key word
                        //	if AUTO, then server picks filter fields (usually 3, with preference
                        //	for GroupID, On/Off, and FixedChoice fields.
                        console.log("_groupingFieldList = " + _groupingFieldList);
				
                        ConfigurationAPI.getUniqueFieldValuesForRecords(
                                _subsetBasePath,
                                records,
                                _groupingFieldList,
                                function(uniqueValues)
                                {
                                    _valsObj = uniqueValues;
                                    Debug.log("uniqueValue sets found = " + uniqueValues.length);
                                    console.log("uniqueValues", uniqueValues);
					
                                    if(_groupingFieldList == "AUTO")
                                    {
                                        //groupingFieldList = AUTO is special key word
                                        //need to extract the automatically chosen fields
                                        //int the CSV list
                                        Debug.log("Extracting auto fields...");
                                        _groupingFieldList = "";
                                        for(var i = 0; i < uniqueValues.length; ++i)
                                        {
                                            if(i) _groupingFieldList += ",";
                                            _groupingFieldList += uniqueValues[i].fieldName;
                                        }
                                        Debug.log("_groupingFieldList converted from auto: " + _groupingFieldList);
                                    }
					
                                    //create map of group field to child link index
                                    for(var i = 0; i < _valsObj.length; ++i)
                                        if(_valsObj[i].childLinkIndex)
                                            _mapOfGroupFieldToLinkIndex[_valsObj[i].fieldName] = _valsObj[i].childLinkIndex;
                                    console.log("_mapOfGroupFieldToLinkIndex",_mapOfGroupFieldToLinkIndex);
					
					                paint();
									
                                    // redesign the page
                                    if(!eventListenersCreated)
                                    {
                                        window.addEventListener("resize", paint);
                                        eventListenersCreated = true; //prevent multiple event creation
                                    }
					
                                    // localApplyFilterPreSelections();
                                    return;
					
                                    // //now apply filter selections, if any
                                    // function localApplyFilterPreSelections()
                                    // {
                                    //     Debug.log("localApplyFilterPreSelections()");
                            
                                    //     var groups = _groupingFieldList.split(',');
                                    //     Debug.log("groups length " + groups.length);
                            
                                    //     //handle group filter pre-selects
                                    //     var groupSelects = _selectedGroupFieldValues.split(';');
                                    //     Debug.log("groupSelects length " + groupSelects.length);
						
                                    //     for(var i = 0; i < groupSelects.length; ++i)
                                    //     {
                                    //         var fieldArr = groupSelects[i].split('=');
                                            
                                    //         if(fieldArr.length < 2) continue; //skip empty selects
                                            
                                    //         //find group box
                                    //         for(var g = 0; g < groups.length; ++g)
                                    //         {
                                    //             if(groups[g] == fieldArr[0])
                                    //             {
                                    //                 Debug.log("Found pre-select group " + g);
                                                    
                                                    
                                    //                 var el = document.getElementById("groupFilterMultiSelect-" + g);
                                                    
                                    //                 var selectValues = fieldArr[1].split(',');
                                    //                 console.log("selectValues",selectValues);
                                    //                 for(var j = 0; j < selectValues.length; ++j)
                                    //                 {
                                    //                     //find select val in multi-select values
                                    //                     var selectVal = decodeURIComponent(selectValues[j]);
                                    //                     for(var k = 0; k < _valsObj[g].fieldUniqueValueArray.length; ++k)
                                    //                     {
                                    //                         if(selectVal == _valsObj[g].fieldUniqueValueArray[k])
                                    //                         {
                                    //                             Debug.log("Found pre-select value " + selectVal);
                                    //                             MultiSelectBox.setSelectionElementByIndex(el, k, true /*selected*/);
                                    //                         }
                                    //                     }
                                    //                 }
                                    //                 break;
                                    //             }
                                    //         }
                                    //     } //end group pre-selects search loop
                                    
                                    //     //handle GroupID filter pre-selects
                                    //     var groupIDSelects = _selectedGroupIDs.split(';');
                                    //     Debug.log("groupIDSelects length " + groupIDSelects.length);

                                    //     for(var i = 0; i < groupIDSelects.length; ++i)
                                    //     {
                                    //         var fieldArr = groupIDSelects[i].split('=');

                                    //         if(fieldArr.length < 2) continue; //skip empty selects

                                    //         //find group box
                                    //         for(var g = 0; g < groups.length; ++g)
                                    //         {
                                    //             //match by child link index
                                    //             if(_mapOfGroupFieldToLinkIndex[groups[g]] == fieldArr[0])
                                    //             {
                                    //                 Debug.log("Found pre-select groupID " + g);

                                    //                 var el = document.getElementById("groupFilterMultiSelect-" + g);

                                    //                 var selectValues = fieldArr[1].split(',');
                                    //                 console.log("groupID selectValues",selectValues);
                                    //                 for(var j=0;j<selectValues.length;++j)
                                    //                 {
                                    //                     //find select val in multi-select values
                                    //                     var selectVal = decodeURIComponent(selectValues[j]);
                                    //                     for(var k=0;k<_valsObj[g].fieldUniqueValueArray.length;++k)
                                    //                     {
                                    //                         if(selectVal == _valsObj[g].fieldUniqueValueArray[k])
                                    //                         {
                                    //                             Debug.log("Found pre-select groupID value " + selectVal);
                                    //                             MultiSelectBox.setSelectionElementByIndex(el, k, true /*selected*/);
                                    //                         }
                                    //                     }
                                    //                 }
                                    //                 break;
                                    //             }
                                    //         }
                                    //     } //end group pre-selects search loop
                                    
                                    
                                    //     //now consider record pre-selects 
                                    //     var selectRecords = _selectedRecords.split(',');
                                    //     Debug.log("selectRecords length " + selectRecords.length);
                                    //     var loadSelectedRecord = true;
                                    //     var selectFirstRecord = true;
                                    
                                    //     el = document.getElementById("recordMultiSelect");
                                    //     var currentSelectedRecordsCount = MultiSelectBox.getSelectedCount(el);
						
                                    //     if(currentSelectedRecordsCount == 0 && selectRecords.length && selectRecords[0].length)
                                    //     {
                                            
                                    //         loadSelectedRecord = selectRecords.length == 1; //only load record if one chosen

                                    //         for(var j = 0; j < selectRecords.length; ++j)
                                    //         {
                                    //             //find select UID in multi-select values
                                    //             for(var k = 0; k < _subsetUIDs.length; ++k)
                                    //             {
                                    //                 if(selectRecords[j] == _subsetUIDs[k])
                                    //                 {
                                    //                     Debug.log("Found pre-select record " + selectRecords[j]);
                                    //                     MultiSelectBox.setSelectionElementByIndex(el,k,true /*selected*/);
                                    //                     selectFirstRecord = false; //use record selection instead, and use as indication that a record was found in search
                                    //                 }
                                    //             }
                                    //         } //end record search loop
                                            
                                    //         if(selectFirstRecord) //error! no record found, but parameter had data
                                    //         {
                                    //             Debug.log("Error! Parameter '_selectedRecords' was not empty, " +
                                    //                     "but no records matched selection criteria '" + _selectedRecords,
                                    //                     Debug.HIGH_PRIORITY);
                                    //             selectFirstRecord = false; //force false anyway, to show more errors
                                    //         }
                                            
                                    //     } //end record pre-select handling
                                    //     else if(currentSelectedRecordsCount == 1) //leave and load currect selection
                                    //         selectFirstRecord = false;
                                    //     else if(currentSelectedRecordsCount > 1) //leave current selections
                                    //     {
                                    //         selectFirstRecord = false;
                                    //         loadSelectedRecord = false;
                                    //     }

                                    //     MultiSelectBox.initMySelectBoxes(); //update display of all multi-select boxes
                                    
                                    //     Debug.log("selectFirstRecord,loadSelectedRecord = " + 
                                    //             selectFirstRecord + "," + loadSelectedRecord);
                                        
                                    //     runFilter(selectFirstRecord, loadSelectedRecord);
                                    // } //end localApplyFilterPreSelections
						
                                }, //end getUniqueFieldValuesForRecords handler
                                _modifiedTables);
				
					});
			console.warn("end initSubsetGlobalData()");
		}	//end initSubsetGlobalData()
		
		//=====================================================================================
		//createTopPaneContent ~~
		function createTopPaneContent() 
		{
			_topPane = document.createElement("div");
			_topPane.setAttribute("class", "pane");
			_topPane.setAttribute("id", "topPane");			
			
			var el;
			var str;
			
			el = document.createElement("div");
			str = "";
			//str += "<a href='#' onclick='initSubsetGlobalData()'>Refresh</a>";
			el.innerHTML = str;
			_topPane.appendChild(el);			

			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_topPane.appendChild(el);
			
			el = document.createElement("div");
			el.setAttribute("id", "topPane-header");
			str = "Targeting ";
			
			// if(_recordPreFilterList != "")
			// 	str += "<b>" + _recordsAlias + "</b> ";
			// else
			str += "<b>" + _recordsAlias + "</b> ";
		
			str += "at path '/" + _subsetBasePath + "'. ";
			
			// if(_selectedGroupFieldValues != "")
			// 	str += "and filter pre-selections '" + _selectedGroupFieldValues + "' ";
			// if(_selectedGroupIDs != "")
			// 	str += "and GroupID pre-selections '" + _selectedGroupIDs + "' ";

			
			el.innerHTML = str;
			_topPane.appendChild(el);			
			
			document.body.appendChild(_topPane);			
		}	//end createTopPaneContent()
		
		//=====================================================================================
		//createMainPaneContent ~~
		function createMainPaneContent()
		{
			_mainPane = document.createElement("div");
			_mainPane.setAttribute("class", "pane");
			_mainPane.setAttribute("id", "midPane");
			
			var el = document.createElement("div");
			el.setAttribute("id", "mainForm");
			// el.setAttribute("style", //"height:200px; width:250px;" +
			// 		//);
			// 		//"margin-bottom: 0px;" +
			// 		"margin: -15px 0 -10px 0;" +
			// 		"height:" + H + "px;" + 
			// 		"width:" + (leftW-25) + "px;");

			_mainPane.appendChild(el);

			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_mainPane.appendChild(el);

			document.body.appendChild(_mainPane);
		}

		//=====================================================================================
		//runFilter ~~
		// function runFilter(selectFirstRecord,loadSelectedRecord) 
		// {
		// 	Debug.log("Run Filter");
			
		// 	var groups = _groupingFieldList.split(',');
		// 	Debug.log("groups length " + groups.length);
			
		// 	var selArr;
			
		// 	var filterStr = "";
		// 	var subFilterStr;
		// 	for(var i = 0; i < groups.length; ++i)
		// 	{
		// 		subFilterStr = "";
				
		// 		selArr = MultiSelectBox.getSelectionArray(
		// 				document.getElementById("groupFilterMultiSelect-" + i));
		// 		for(var s in selArr)
		// 		{
		// 			MultiSelectBox.dbg("filter " + i + 
		// 					" selected [" + s + "]: ",
		// 					selArr[s], 
		// 					_valsObj[i].fieldUniqueValueArray[s|0]);
					
		// 			//if selected, add value to filter string
		// 			if(selArr[s])
		// 				subFilterStr += (subFilterStr.length?",":"") +
		// 					encodeURIComponent(_valsObj[i].fieldUniqueValueArray[s|0])
		// 		}
				
		// 		//if any values selected then add to filter string				
		// 		if(subFilterStr.length)
		// 			filterStr += encodeURIComponent(groups[i]) + 
		// 				"=" + subFilterStr + ";";
		// 	}
			
		// 	//append global filters 
		// 	// filterStr += _recordPreFilterList;
		// 	Debug.log("filterStr " + filterStr);
			
		// 	ConfigurationAPI.getSubsetRecords(
		// 			_subsetBasePath,
		// 			filterStr,
		// 			function(records)
		// 			{
        //                 _subsetUIDs = records;
        //                 Debug.log("records found = " + records.length);
        //                 console.log(records);
				
        //                 updateRecordsAndFields(selectFirstRecord,loadSelectedRecord);
        //             }, //end getSubsetRecords handler
        //             _modifiedTables);
		// } // end runFilter()
		
		//=====================================================================================
		//getSelectedRecords ~~
		//	returns index of selected records
		//	if forceOne
		//		only allow one selected record
		//		else -1 on error
		//	else if not forceOne
		//		return array of selected records
		//		else return empty array
		// function getSelectedRecords(forceOne) 
		// {
		// 	var selArr = 
		// 			MultiSelectBox.getSelectionArray(
		// 					document.getElementById("recordMultiSelect"));
		// 	var cntSelected = 0;
		// 	var selectedIndices = [];
		// 	for(var s in selArr)
		// 	{
		// 		//MultiSelectBox.dbg("record selected [" + s + "]: ",
		// 		//		selArr[s], 
		// 		//		_subsetUIDs[s|0]);

		// 		if(selArr[s]) 
		// 		{
		// 			++cntSelected;
		// 			selectedIndices.push(s|0);

		// 			if((s|0) < 0 || (s|0) >= _subsetUIDs.length)
		// 			{
		// 				Debug.log("Invalid record index '" + (s|0) + 
		// 						"' should be impossible. Please notify developers " +
		// 						"as to how you got here!", Debug.HIGH_PRIORITY);						
		// 				return forceOne?-1:[];
		// 			}
		// 		}
		// 	}

		// 	if(forceOne)
		// 	{
		// 		if(cntSelected != 1)
		// 		{
		// 			Debug.log("Error! Please choose one and only one target from the list of " +
		// 					_recordsAlias + " in the Left Pane.", Debug.HIGH_PRIORITY);						
		// 			return -1;
		// 		}
		// 		return selectedIndices[0];
		// 	}
		// 	else
		// 		return selectedIndices;
			
		// }	//end getSelectedRecords()

		//=====================================================================================
		//btnActionReadAllFields ~~
		//	read all fields for one record
		function btnActionReadAllFields() 
		{
			var selectedIndex = getSelectedRecords(true);
			if(selectedIndex < 0) return;
							
			Debug.log("btnActionReadAllFields target record = " + _subsetUIDs[selectedIndex]);
			
			ConfigurationAPI.getFieldValuesForRecords(
					_subsetBasePath,
					[_subsetUIDs[selectedIndex]], //array of size 1
					_fields,
					function(recFieldValues)
					{
						console.log(recFieldValues);
						
						//for each field, set value
						for(var i=0;i<recFieldValues.length;++i)
						{
							ConfigurationAPI.setEditableFieldValue(
									_fields[i],
									recFieldValues[i].fieldValue,
									i);
						}
					}, //end getFieldValuesForRecord handler
					 _modifiedTables);
			
		}	//end btnActionReadAllFields()

		
		//=====================================================================================
		//btnActionReadOneField ~~
		// read one field from one record
		function btnActionReadOneField() 
		{
			var selectedIndex = getSelectedRecords(true);
			if(selectedIndex < 0) return;
			
			var selectedFieldIndex = ConfigurationAPI.getSelectedEditableFieldIndex();
			if(selectedFieldIndex < 0) 
			{
				Debug.log("Error! There is no selected field. In order to read " +
						"a field please toggle selection of the target field by " +
						"clicking on the name of the " +
						"field in the Right Pane.", Debug.HIGH_PRIORITY);
				return;
			}

			Debug.log("btnActionReadOneField target record = " + 
					_subsetUIDs[selectedIndex]);

			ConfigurationAPI.getFieldValuesForRecords(
					_subsetBasePath,
					[_subsetUIDs[selectedIndex]], //array of size 1
					[_fields[selectedFieldIndex]], //array of size 1
					function(recFieldValues)
					{
						console.log(recFieldValues);

						//for each field, set value
						//	SHOULD only be one field value returned
						for(var i=0;i<recFieldValues.length;++i)
						{
							ConfigurationAPI.setEditableFieldValue(
									_fields[selectedFieldIndex],
									recFieldValues[i].fieldValue,
									selectedFieldIndex);
						}
					}, //end getFieldValuesForRecord handler
					 _modifiedTables);
			
		}	//end btnActionReadOneField()
		
		//=====================================================================================
		//btnActionWriteAllFields ~~
		//	write all fields for all selected records
		function btnActionWriteAllFields() 
		{
			var selectedIndices = getSelectedRecords();
			if(selectedIndices.length == 0)
			{
				Debug.log("Error! There are no selected " + _recordsAlias + 
						". In order to write " +
						"the fields to one or more " + _recordsAlias + "," +
						" please make selections in the Left Pane.", Debug.HIGH_PRIORITY);
				return;
			}
			
			Debug.log("btnActionWriteAllFields target record length = " + 
					selectedIndices.length);
			
			//make array of all field values
			var valueArr = [];
			
			//for each field, get value
			for(var i=0;i<_fields.length;++i)			
				valueArr.push(ConfigurationAPI.getEditableFieldValue(
						_fields[i],
						i));

			Debug.log("btnActionWriteAllFields values length = " + 
					valueArr.length);
			Debug.log("btnActionWriteAllFields fields length = " + 
					_fields.length);
			
			//make array of target records
			var recordArr = [];
			for(var i=0;i<selectedIndices.length;++i)	
				recordArr.push(_subsetUIDs[selectedIndices[i]]);
						
			ConfigurationAPI.setFieldValuesForRecords(
					_subsetBasePath,
					recordArr, 	//recordArr
					_fields, 	//fieldArr
					valueArr, 	//valueArr
					function(modifiedTables)
					{
				Debug.log("modifiedTables length " + modifiedTables.length);
								
				if(!modifiedTables.length)
				{
					Debug.log("There was an error while writing the values.",
							Debug.HIGH_PRIORITY);
					return;					
				}
									
				_modifiedTables = modifiedTables;
				
				//proceed to save (quietly) tables, groups, aliases
				ConfigurationAPI.saveModifiedTables(_modifiedTables,
						function(savedTables, savedGroups, savedAliases)
						{
					if(!savedTables.length)
					{
						Debug.log("There was an error while saving the values.",
								Debug.HIGH_PRIORITY);
						return;					
					}
					
					Debug.log("The values for each field were successfully written to the targeted " +
							_recordsAlias + " (target count = " + selectedIndices.length + ")!",
							Debug.INFO_PRIORITY);
					
					_modifiedTables = undefined; //clear after save
					
						}); //end saveModifiedTables handler
				
					}, //end setFieldValuesForRecords handler
					 _modifiedTables);			

		}	//end btnActionWriteAllFields()
		
		//=====================================================================================
		//btnActionWriteOneField ~~
		//	write the selected field for all selected records
		function btnActionWriteOneField() 
		{
			var selectedIndices = getSelectedRecords();
			if(selectedIndices.length == 0)
			{
				Debug.log("Error! There are no selected " + _recordsAlias + 
						". In order to write " +
						"the fields to one or more " + _recordsAlias + "," +
						" please make selections in the Left Pane.", Debug.HIGH_PRIORITY);
				return;
			}

			Debug.log("btnActionWriteOneField target record length = " + 
					selectedIndices.length);
			
			var selectedFieldIndex = ConfigurationAPI.getSelectedEditableFieldIndex();
			if(selectedFieldIndex < 0) 
			{
				Debug.log("Error! There is no selected field. In order to read " +
						"a field please toggle selection of the target field by " +
						"clicking on the name of the " +
						"field in the Right Pane.", Debug.HIGH_PRIORITY);
				return;
			}

			//make array of all field values
			var valueArr = [];

			//for each field, set value
			valueArr.push(ConfigurationAPI.getEditableFieldValue(
					_fields[selectedFieldIndex],
					selectedFieldIndex));

			Debug.log("btnActionWriteOneField values length = " + 
					valueArr.length);
			
			//make array of target records
			var recordArr = [];
			for(var i=0;i<selectedIndices.length;++i)	
				recordArr.push(_subsetUIDs[selectedIndices[i]]);
			
			//
			
			ConfigurationAPI.setFieldValuesForRecords(
					_subsetBasePath,
					recordArr, 	//recordArr
					[_fields[selectedFieldIndex]], 	//fieldArr of size 1
					valueArr, 	//valueArr of size 1
					/////////////////////
					function(modifiedTables)
					{
				Debug.log("modifiedTables length " + modifiedTables.length);

				if(!modifiedTables.length)
				{
					Debug.log("There was an error while writing the values.",
							Debug.HIGH_PRIORITY);
					return;					
				}

				_modifiedTables = modifiedTables;

				//proceed to save (quietly) tables, groups, aliases
				ConfigurationAPI.saveModifiedTables(_modifiedTables,
						/////////////////////
						function(savedTables, savedGroups, savedAliases)
						{
					if(!savedTables.length)
					{
						Debug.log("There was an error while saving the values.",
								Debug.HIGH_PRIORITY);
						return;					
					}

					Debug.log("The value for the selected field was successfully written to the targeted " +
							_recordsAlias + " (target count = " + selectedIndices.length + ")!",
							Debug.INFO_PRIORITY);

					_modifiedTables = undefined; //clear after save

						}); //end saveModifiedTables handler

					}, //end setFieldValuesForRecords handler
					_modifiedTables);	
			
		}	//end btnActionWriteOneField()
		

		//=====================================================================================
		//deleteRecords ~~
		//	delete the selected records
		function deleteRecords() 
		{
			var selectedIndices = getSelectedRecords();
			if(selectedIndices.length == 0)
			{
				Debug.log("Error! There are no selected " + _recordsAlias + 
						" records. In order to delete " +
						"one or more " + _recordsAlias + " records," +
						" please make selections in the Left Pane.", Debug.HIGH_PRIORITY);
				return;
			}

			Debug.log("deleteRecords target record length = " + 
					selectedIndices.length);	


			//make array of target records
			var recordArr = [];
			var recordStr = "";
			for(var i=0;i<selectedIndices.length;++i)	
			{
				if(i) recordStr += ", ";
				recordStr += decodeURIComponent(_subsetUIDs[selectedIndices[i]]);
				recordArr.push(_subsetUIDs[selectedIndices[i]]);
			}			

			DesktopContent.popUpVerification(
					"Are you sure you want to remove the following " + _recordsAlias + 
					" records from the table?<br><br>" +
					"Here are the records (count = " + recordArr.length + 
					") that will be deleted:<br> <b>" + recordStr + "</b>",
					localProceedWithDelete							
					,0,"#efeaea",0,"#770000");
			
			/////////////////////
			function localProceedWithDelete()
			{

				ConfigurationAPI.deleteSubsetRecords(_subsetBasePath,recordArr,
						/////////////////////
						function(modifiedTables) //start deleteSubsetRecords handler
						{
					Debug.log("modifiedTables length " + modifiedTables.length);

					if(!modifiedTables.length)
					{
						Debug.log("There was an error while removing the record(s).",
								Debug.HIGH_PRIORITY);
						return;					
					}

					_modifiedTables = modifiedTables;

					//proceed to save (quietly) tables, groups, aliases
					ConfigurationAPI.saveModifiedTables(_modifiedTables,
							/////////////////////
							function(savedTables, savedGroups, savedAliases)
							{
						if(!savedTables.length)
						{
							Debug.log("There was an error while removing the record(s).",
									Debug.HIGH_PRIORITY);
							return;					
						}

						Debug.log("The following " +
								_recordsAlias + " records (count = " +
								selectedIndices.length + ") "+ 
								"were successfully removed: " + recordStr + ".",
								Debug.INFO_PRIORITY);

						_modifiedTables = undefined; //clear after save
						// _selectedRecords = ""; //clear after save

						runFilter(); //updates records and fields, and applies filter

							}); //end saveModifiedTables handler


						}, //end deleteSubsetRecords handler
						_modifiedTables);	
			} //end localProceedWithDelete()
		} //end deleteRecords()
		
		//=====================================================================================
		//addRecord ~~
		//	create new record
		function addRecord() 
		{
			var newRowUID = prompt("Please enter the UID for the new " + 
					_recordsAlias + " record:");
			if(newRowUID)
				newRowUID = newRowUID.trim();
			else //prompt was cancelled
				return;

			//unselect current record selections, so new record will be selected in aftermath
			var el = document.getElementById("recordMultiSelect");
			MultiSelectBox.setSelectionElementByIndex(el,-1 /*all*/,false /*selected*/);
													
			
			ConfigurationAPI.addSubsetRecords(_subsetBasePath,newRowUID,
					/////////////////////
					function(modifiedTables) //start addSubsetRecords handler
					{
				Debug.log("modifiedTables length " + modifiedTables.length);

				if(!modifiedTables.length)
				{
					Debug.log("There was an error while creating the record.",
							Debug.HIGH_PRIORITY);
					return;					
				}

				_modifiedTables = modifiedTables;

				
				//if there is just one selected group ID, apply it to record
				{
					var groupIDSelects = [];
					if(_selectedGroupIDs)
						groupIDSelects = _selectedGroupIDs.split(';');
					
					Debug.log("groupIDSelects length " + groupIDSelects.length);
					
					var fieldArr = [];
					if(groupIDSelects.length == 1)
						fieldArr = groupIDSelects[0].split('=');
					
					if(_selectedGroupIDs && 
							groupIDSelects.length == 1 &&
							fieldArr.length == 2)
					{
						 Debug.log("Have group ID to apply '" +
								 fieldArr[1] + "'");
						 
						 for(var field in _mapOfGroupFieldToLinkIndex)
							 if(_mapOfGroupFieldToLinkIndex[field] ==
									 fieldArr[0])
							 {
								 Debug.log("Applying to field '" +
										 field + "'");
								 
								 ConfigurationAPI.setFieldValuesForRecords(
										 _subsetBasePath,
										 newRowUID, 	//recordArr
										 field, 	//fieldArr
										 fieldArr[1], 	//valueArr
										 function(modifiedTables)
										 {
									 Debug.log("modifiedTables length " + modifiedTables.length);

									 if(!modifiedTables.length)
									 {
										 Debug.log("There was an error while writing the values.",
												 Debug.HIGH_PRIORITY);
										 return;					
									 }

									 _modifiedTables = modifiedTables;
									 
									 localFinishSave();

										 }, //end setFieldValuesForRecords handler
										 _modifiedTables);
								 
								 return;
							 } //end applying group ID handling
						 
					}
					
					//if did not go groupID path, then finish save
					localFinishSave();
					
				} //end record modification or not handling

					}, //end addSubsetRecords handler
					_modifiedTables);		
			
			return;
			
			//=====================
			function localFinishSave()
			{
				Debug.log("localFinishSave()");
				
				//proceed to save (quietly) tables, groups, aliases
				ConfigurationAPI.saveModifiedTables(_modifiedTables,
						/////////////////////
						function(savedTables, savedGroups, savedAliases)
						{
					if(!savedTables.length)
					{
						Debug.log("There was an error while creating the record.",
								Debug.HIGH_PRIORITY);
						return;					
					}

					Debug.log("The new " +
							_recordsAlias + " record '" + 
							decodeURIComponent(newRowUID) + 
							"' was successfully created!",
							Debug.INFO_PRIORITY);

					_modifiedTables = undefined; //clear after save
					// _selectedRecords = newRowUID; //select new record after init
					
					//runFilter(); //updates records and fields, and applies filter
					initSubsetGlobalData();

						}); //end saveModifiedTables handler
				
			} //end localFinishSave()
			
		} //end addRecord()
		
		//=====================================================================================
		//renameRecord ~~
		//	edit selected record name
		function renameRecord() 
		{
			var selectedIndices = getSelectedRecords();
			if(selectedIndices.length != 1)
			{
				Debug.log("Error! There are " + 
						selectedIndices.length + " selected " + _recordsAlias + 
						" records. To edit a name, you must select " +
						"one " + _recordsAlias + 
						" record to target in the Left Pane.", Debug.HIGH_PRIORITY);
				return;
			}
			
			var originalRecord = decodeURIComponent(_subsetUIDs[selectedIndices[0]]);
						Debug.log("renameRecord target record = " + 
								originalRecord);
						
			DesktopContent.popUpVerification(
					"Please enter the new UID to rename the " + 
					_recordsAlias + " record:?<br><br>",
					localProceedWithRename							
					,0, //val
					"#efeaea",0,"#770000", //bgColor, textColor, borderColor, 
					true /*getUserInput*/, 
					0,0,// dialogWidth, cancelFunc, 
					"Rename" /*yesButtonText*/,
					true /*noAutoComplete*/,
					originalRecord /*defaultUserInputValue*/);
			
			return;

			/////////////////////
			function localProceedWithRename(newRowUID)
			{

				if(newRowUID)
					newRowUID = newRowUID.trim();

				Debug.log("localProceedWithRename() " + newRowUID);

				ConfigurationAPI.renameSubsetRecords(_subsetBasePath,
						originalRecord,newRowUID,
						/////////////////////
						function(modifiedTables) //start addSubsetRecords handler
						{
					Debug.log("modifiedTables length " + modifiedTables.length);

					if(!modifiedTables.length)
					{
						Debug.log("There was an error while renaming the record.",
								Debug.HIGH_PRIORITY);
						return;					
					}

					_modifiedTables = modifiedTables;

					//then finish save
					localFinishSave(newRowUID);

						}, //end addSubsetRecords handler
						_modifiedTables);		
			} //end localProceedWithRename()

			//=====================
			function localFinishSave(newRowUID)
			{
				Debug.log("localFinishSave()");

				//proceed to save (quietly) tables, groups, aliases
				ConfigurationAPI.saveModifiedTables(_modifiedTables,
						/////////////////////
						function(savedTables, savedGroups, savedAliases)
						{
					if(!savedTables.length)
					{
						Debug.log("There was an error while renaming the record.",
								Debug.HIGH_PRIORITY);
						return;					
					}

					Debug.log("The " +
							_recordsAlias + " record was renamed to '" + 
							decodeURIComponent(newRowUID) + 
							"' successfully!",
							Debug.INFO_PRIORITY);

					_modifiedTables = undefined; //clear after save
					// _selectedRecords = ""; //clear after save

					//runFilter(); //updates records and fields, and applies filter
					initSubsetGlobalData();

						}); //end saveModifiedTables handler

			} //end localFinishSave()

		} //end renameRecord()
		
		//=====================================================================================
		//copyRecords ~~
		//	edit selected record name
		function copyRecords() 
		{
			var selectedIndices = getSelectedRecords();
			if(selectedIndices.length == 0)
			{
				Debug.log("Error! There are no selected " + _recordsAlias + 
						" records. In order to copy " +
						"one or more " + _recordsAlias + " records," +
						" please make selections in the Left Pane.", Debug.HIGH_PRIORITY);
				return;
			}

			Debug.log("copyRecords target record length = " + 
					selectedIndices.length);	


			//make array of target records
			var recordArr = [];
			var recordStr = "";
			for(var i=0;i<selectedIndices.length;++i)	
			{
				if(i) recordStr += ", ";
				recordStr += decodeURIComponent(_subsetUIDs[selectedIndices[i]]);
				recordArr.push(_subsetUIDs[selectedIndices[i]]);
			}			

			DesktopContent.popUpVerification(
					"How many copies do you want of the following " + _recordsAlias + 
					" records from the table?<br><br>" +
					"Here are the records (count = " + recordArr.length + 
					") that will be copied:<br> <b>" + recordStr + "</b>",
					localProceedWithCopy							
					,0, //val
					"#efeaea",0,"#770000", //bgColor, textColor, borderColor, 
					true /*getUserInput*/, 
					0,0,// dialogWidth, cancelFunc, 
					"Copy" /*yesButtonText*/,
					true /*noAutoComplete*/,
					1 /*defaultUserInputValue*/);

			/////////////////////
			function localProceedWithCopy(copies)
			{
				Debug.log("localProceedWithCopy() " + copies);


				ConfigurationAPI.copySubsetRecords(_subsetBasePath,
						recordArr,copies,
						/////////////////////
						function(modifiedTables) //start copySubsetRecords handler
						{
					Debug.log("modifiedTables length " + modifiedTables.length);

					if(!modifiedTables.length)
					{
						Debug.log("There was an error while copying the record(s).",
								Debug.HIGH_PRIORITY);
						return;					
					}

					_modifiedTables = modifiedTables;

					//proceed to save (quietly) tables, groups, aliases
					ConfigurationAPI.saveModifiedTables(_modifiedTables,
							/////////////////////
							function(savedTables, savedGroups, savedAliases)
							{
						if(!savedTables.length)
						{
							Debug.log("There was an error while copying the record(s).",
									Debug.HIGH_PRIORITY);
							return;					
						}

						Debug.log("The following " +
								_recordsAlias + " records (count = " +
								selectedIndices.length + ") "+ 
								"were successfully copied " + 
								copies + "x: " + recordStr + ".",
								Debug.INFO_PRIORITY);

						_modifiedTables = undefined; //clear after save

						runFilter(); //updates records and fields, and applies filter

							}); //end saveModifiedTables handler


						}, //end copySubsetRecords handler
						_modifiedTables);	

			} //end localProceedWithCopy()

		} //end copyRecords()
		
		
		</script> 
</head>
	

<body onload='//init() called by DesktopContent.js'>	
	<h1>FHiCL Editor</h1>
	<!-- body content populated by javascript paint(), etc. -->

	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
</body>
	
</html>
