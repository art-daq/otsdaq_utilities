<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>ConfigurationGUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<style type="text/css">			
		
		body {
			/*overflow: hidden; /* scrolling only happens in left and right panes */			
		}

		/* make buttons have a hand cursor */
		input[type="button"], button {
			cursor: pointer;
		}
		
		.pane {
			border: 0;
			position: absolute;
		}

		#topPane {
			overflow-y: auto;
			overflow-x: hidden;
		}
		
		#bottomPane {
			background-color : rgb(241, 231, 231);
			overflow: auto;

			box-shadow: 		inset rgba(255,254,255,0.6) 0 0.3em .3em,
					inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
					rgba(200, 200, 200,0.6) 0 .1em 3px,
					rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
					rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
			border-radius: 3px;	
		}
		

		/* =============== start plan selector ================ */
		.recordAdd,
		.recordAdd:hover {
			text-decoration: none;
			font-size: 30px;
			font-weight: bold;
			color: rgb(15, 152, 76);
		}
		
		#recordAddDiv {
	    	margin: -2px 16px -10px 0;
			float: left;
		}
		#recordDeleteDiv {
			margin: 4px 0 0 0;
			float: left;
		}
		
		.treeNode-deleteIcon {			
			background-image: 	url(..//images/windowContentImages/ConfigurationGUI-trashCan.png);
			width: 				16px;
			height: 			20px;
			border: 			0;
			margin: 			-9px 0 -10px 10px;
		}
		.treeNode-deleteIcon:hover {
			background-image: 	url(..//images/windowContentImages/ConfigurationGUI-trashCanHover.png);
			cursor: 			pointer;
		}

		.preloadImage {			
			width: 				24px;
			height: 			20px;
			position:			absolute;
			left: 				-100px;
			top: 				0;
		}
		#preloadImage-treeEditTrashIconHover {
			background-image: 	url(..//images/windowContentImages/ConfigurationGUI-trashCanHover.png);
		}

		#planSelector {
			margin: 20px 0 0 20px;
		}
				
		#planSelectDiv {
			float: left;
			margin-right: 20px;
		}
		
		#planSelect {
			height: 30px;
			width: 210px;
		}
		
		/* =============== end plan selector ================ */		
		

		/* =============== start plan detail ================ */
		
		#planDetail {
			margin:			10px 10px 10px 0;
		    padding-left: 	10px;
			overflow: 		hidden;
		}
			
		#plan-planName {
			margin-bottom: 15px;
		}
		
		.plan-depthBar {
			padding-left: 	10px;
			border-left: 	20px solid rgb(218, 194, 194);
			margin-left: 	0px;
		}
		
		.plan-command-overlay {
			position:		absolute;
			height:			15px;
			width:			100%;			
			left: 			-30px;			
		}
		
		.plan-command-upOverlay {
			top: 			-5px;
			/*background-color: rgba(255, 0, 0, 0.2);*/
		}
		.plan-command-dnOverlay {
			top: 			10px;
			/*background-color: rgba(0, 0, 255, 0.2);*/
		}

		.plan-command-addCommand {
		    display: 			block;
		    width: 				100%;
		    background-color: 	rgb(218, 194, 194);
		    height: 			1px;
		    position: 			absolute;
		    top: 				0;
		    left: 				0;
		}
		
		.plan-command-addCommand-button,
		.plan-command-addCommand-button:hover {
			text-decoration: 	none;
			font-size: 			30px;
			font-weight: 		bold;
			color: 				rgb(15, 152, 76);
			cursor: 			pointer;
			
		    position: 			absolute;
		    top: 				-16px;
		    border: 			1px solid rgb(6, 82, 9);
		    border-radius: 		15px;
		    padding: 			0px 7px 0px 7px;
		    left: 				-36px;
		    height: 			32px;
		}

		.plan-command-addCommand-button {
		    background-color: 	rgb(195, 230, 193);			
		}
		.plan-command-addCommand-button:hover {
		    background-color: 	rgb(215, 255, 213);			
		}

		.plan-command-name {
			float: 				left;		
			position: 			relative;
		    z-index: 			1000;		/* to keep on top and hoverable */	
		    cursor:				pointer; 	/* for dragging */
		    padding-right:		10px; 		/* to force overlap with delete for mouseover continuity */
		    width:				260px;		/* to lineup parameters display */
		}
		
		.plan-command-deleteWrapper{
			float: 				left;	
			width: 				16px;
			height: 			20px;
			border: 			0;
			position: 			relative;
		    z-index: 			1000;		/* to keep on top and clickable */	
		    margin-left:		-10px; 		/* to force overlap with name for mouseover continuity */
		}
		.plan-command-delete {	
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCan.png);
			width: 				16px;
			height: 			20px;
			border: 			0;	    
		}
		.plan-command-delete:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
			cursor: 			pointer;
		}
		
		.plan-command-params {
			float: 				left;
			margin: 			2px 0 0 0;
			white-space: 		nowrap;
			width:				5px; 		/* to force on the same line as command name*/
			position: 			relative;
		    z-index: 			1000;		/* to keep on top and hoverable */
		    padding-left:		15px;		/* to allow for mouse region to bring-up param display */
		}
		
		#plan-command-parameterDisplay {
			position: 			absolute;
			z-index: 			2000;		/* to keep on top of everything */
			background-color: 	rgb(218, 194, 194);			
		    border-radius: 		10px 10px 0 0; /* square bottom because scrollbar looks weird otherwise */
		    padding: 			10px;
		    border: 			2px solid rgb(160, 102, 102);		
		    overflow-x:			auto;
		}		

		/* =============== end plan detail ================ */
		
		#popUp-paramControls {
			margin-top: 		20px;
			text-align:			left;
		}
		
		.popUp-param {
			height: 			17px;
			width: 				200px;
		}
		
	</style>
	
	
	<script type="text/JavaScript" src="..//js/Globals.js"></script>	
	<script type="text/JavaScript" src="..//js/Debug.js"></script>	
	<script type="text/JavaScript" src="..//js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="..//js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="..//js/js_lib/ConfigurationAPI.js"></script>
	
	<script>		
	
		//Iterate desktop icon from:
		//	http://clipart-library.com/purple-spider-cliparts.html
	
		
		//	Description of Iterate Functionality/Behavior:
		//	
		//	GET parameters:
		//		<forceSavingModifiedGroups> = Do not provide user with option in command sequence to use the temporary group for modified groups
		//		<forceUseOfAliases> = Do not provide user with option in command sequence to use an arbitrary group
		//		<forceGroupsOnly> = Do not provide user with option in command sequence to use Macros
		//		
		//
		//	- Requires user to have LOCK
		//
		//	- Top Pane:
		//		* Refresh
		//		* Iteration Plan: <name> and  > || |_|  controls and "Status: Inactive"
		//		* when modified, do not show > || |_| controls.. 
		//			instead show Save and Discard Changes buttons
		//
		//	- Bottom Pane:
		//		* Similar functionality to GUI subset.. in that it edits the 
		//			the currently active Iteration group. (If a user wants to change the active
		//			Iteration group, they must do so in the Config GUI)
		//
		//		* Very top of "tree-view" choose the Iteration Plan name
		//			* Then default to simple plan, e.g.:
		//				- BEGIN_LABEL 0 (hide index from user - show by indent)
		//				- Configure Configuration Group/System Alias
		//				- REPEAT_LABEL 0 ( 0 times - when 0 show as END LOOP)
		//				- In GUI, show END (no representation in table)
		//					
		//		* Create Rows in table that match sequence
		//
		//		* Row Types
		//			- BEGIN_LABEL <label>
		//			- REPEAT_LABEL <label> <number of times to repeat 0-to-N>
		//				#note: must have a matching BEGIN_LABEL
		//			- CHOOSE_STATE_MACHINE <fsm name> #by default ""
		//			- CONFIGURE_ALIAS <alias name>
		//			- CONFIGURE_GROUP <group name> <group key>
		//			- MODIFY_ACTIVE_GROUP <bool:do save new group #else use temporary group> 
		//				<relative path from FE> <start value> <iteration step size>
		//				<target Group #which can span multiple FE-Managers or whatever> 
		//				#note: always must (so that macro things work) have a CONFIGURE_ACTIVE_GROUP after a MODIFY_ACTIVE_GROUP
		//				#	but can group modifies together and do one CONFIGURE_ACTIVE_GROUP.	
		//			- CONFIGURE_ACTIVE_GROUP
		//			- EXECUTE_MACRO <macro name> <target Group #which can span multiple FE-Managers or whatever>
		//				<parameter group of name, value, iteration step size to adjust in macro> 
		//				#note: must be a public macro
		//			- EXECUTE_FE_MACRO <FE macro name> <target Group #which can span multiple FE-Managers or whatever>
		//				<parameter group of name, value, iteration step size to adjust in inputs to FE macro>
		//			- RUN	<dump type> <bool: wait for all FEs to complete running thread else use time> 
		//				<seconds for run>		
		//
		//		
		//	- Save functionality should be same as saving tree	
		//		* If admin, could give options to target a certain system alias.. Etc.
		//		* Else assume saving to currently active groups
		//
		//
		//	- Interactions with Server
		//		* App must have access to Configuration GUI Supervisor, Gateway Supervisor,
		//				MacroMaker Supervisor (Macro Maker can run FE Macros) 
		//			-- this means primary urn to GUI Supervisor, secondary to Gateway Supervisor,
		//				and special handshaking (from Gateway Supervisor) with MacroMaker Supervisors
		//		
		//		* Requests:
		//				= from Configuration GUI Supervisor =
		//			-- Get Iteration Plan Names
		//			-- Load Iteration Plan
		//			-- Save Iteration Plan
		//
		//				= from Gateway Supervisor =
		//			-- Play/Resume Iteration Plan (implications for MacroMaker, coordinated by Gateway)
		//			-- Pause Iteration Plan
		//			-- Stop/Reset Iteration Plan
		//			-- Get Active Iteration Plan Status (status could be: inactive, running, paused)
		
		//	Gateway Server Iterator 
		//		- Iterator to manage iterating -- separate thread
		//		- Commands:
		//			- stateMachineXgiHandler/PlayIterationPlan:
		//				- if not running, launches thread (if all state machines are halted)
		//					and starts playing iteration plan.
		//			- stateMachineXgiHandler/PauseIterationPlan:
		//				- if running, pauses iteration plan.
		//			- stateMachineXgiHandler/HaltIterationPlan:
		//				- if running, halts/resets iteration plan. Lose progress. Halts FSM.
		//			- stateMachineXgiHandler/getIterationPlanStatus:
		//				- returns status (status could be: inactive, running, paused)
		//					and FSM state and isTransitioning,
		//					and which iteration plan command.
		//		
		
	
	
	
		//
		//	- Iteration Plan Configuration Tree
		//		* Iterate
		//			- records of 'Iteration Plans'
		//		|* Iteration Plans
		//			- group of 'Iteration Plan Commands' defining an 'Iteration Plan Sequence' 
		//		||* Specific Command-Type (a table for each type)
		//			- definition of parameters associated with the command type
		//		|||* Iteration Targets
		//			- group of links to UIDs to be targeted
		
		
		var _topPane, _bottomPane;
		var _updateTimer = 0;
		var _UPDATE_TIMER_PERIOD = 1000; //ms
		var _old_active_plan_status;
		var _need_plan_complete = false;
		var _need_plan_halted = false;
		var _need_plan_paused = false;
		
		var _eventListenersCreated = false;
		
		//global vars for GET params
		var _forceSavingModifiedGroups;// = Do not provide user with option to use the temporary group for modified groups
		var _forceUseOfAliases;// = Do not provide user with option to use an arbitrary group
		var _forceGroupsOnly;//= Do not provide user with option to use Macros
		
		var _ITERATE_BASE_PATH = "IterateConfiguration";	
		var _PLAN_BASE_PATH = "IterationPlanConfiguration";	
		var _recordsAlias = "Iteration Plan";
		
		//global vars for iteration plan records
		var _planUIDs; //array of UIDs in the currently active Iterate group
		var _targetPlan = "";
				
		//global vars for saving tables
		var _modifiedTables;
		
		//global vars for editing plans
		var _configGroupAliases = []; //array of objects:{alias,name,key,groupComment,aliasComment}, only configuration groups
		var _fsmNames = [];	//array of names
		var _configGroups = []; //array of objects:{name,key,groupComment}, only configuration groups
        var _commands = [];
        
		var _COMMAND_TYPES = {}; //for now, keys are same as value, but value is (intended to be) display name
		_COMMAND_TYPES.BEGIN_LABEL 				= "BEGIN_LABEL";
		_COMMAND_TYPES.CHOOSE_FSM 				= "CHOOSE_FSM";
		_COMMAND_TYPES.CONFIGURE_ACTIVE_GROUP 	= "CONFIGURE_ACTIVE_GROUP";
		_COMMAND_TYPES.CONFIGURE_ALIAS 			= "CONFIGURE_ALIAS";
		_COMMAND_TYPES.CONFIGURE_GROUP 			= "CONFIGURE_GROUP";
		_COMMAND_TYPES.EXECUTE_FE_MACRO 		= "EXECUTE_FE_MACRO";
		_COMMAND_TYPES.EXECUTE_MACRO 			= "EXECUTE_MACRO";
		_COMMAND_TYPES.MODIFY_ACTIVE_GROUP 		= "MODIFY_ACTIVE_GROUP";
		_COMMAND_TYPES.REPEAT_LABEL 			= "REPEAT_LABEL";
		_COMMAND_TYPES.RUN 						= "RUN";
		
		var _COMMAND_PARAMS = {}; //NOTE!!! Fields must be in same order as the tables (in the future could ask server for this order, or not) 
		_COMMAND_PARAMS[_COMMAND_TYPES.BEGIN_LABEL] 			= ["Label"];
		_COMMAND_PARAMS[_COMMAND_TYPES.CHOOSE_FSM] 				= ["NameOfStateMachine"];
		_COMMAND_PARAMS[_COMMAND_TYPES.CONFIGURE_ACTIVE_GROUP] 	= [];
		_COMMAND_PARAMS[_COMMAND_TYPES.CONFIGURE_ALIAS] 		= ["SystemAlias"];
		_COMMAND_PARAMS[_COMMAND_TYPES.CONFIGURE_GROUP] 		= ["GroupName","GroupKey"];
		_COMMAND_PARAMS[_COMMAND_TYPES.EXECUTE_FE_MACRO] 		= ["CSVTargetTables","CSVTargetUIDs","FEMacroName","LinkToFEMacroParameterGroup","LinkToFEMacroParameterGroupID"];
		_COMMAND_PARAMS[_COMMAND_TYPES.EXECUTE_MACRO] 			= ["CSVTargetTables","CSVTargetUIDs","MacroName","LinkToFEMacroParameterGroup","LinkToFEMacroParameterGroupID"];
		_COMMAND_PARAMS[_COMMAND_TYPES.MODIFY_ACTIVE_GROUP] 	= ["CSVTargetTables","CSVTargetUIDs","DoTrackGroupChanges","RelativePathToField","FieldStartValue","FieldIterationStepSize"];
		_COMMAND_PARAMS[_COMMAND_TYPES.REPEAT_LABEL] 			= ["Label","NumberOfRepetitions"];
		_COMMAND_PARAMS[_COMMAND_TYPES.RUN] 					= ["WaitForAllFrontEndsRunningThread","DurationInSeconds"];
        
        
        var _DEBUG_WOUT_SERVER = 0;
        
        var _shownAddCommandIndex = -1;
        var _shownDeleteCommandIndex = -1;
        var _planIsModified = false;
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:			
			//init()
			//paint() 
			//extractGETParameters()
			//initIterateData()
        	//		localCompleteInit()
        	//		localGetGroups()	
        	//		localGetNamesOfFSMs()
			//getIterationPlans(responseHandler)
		
			//createTopPaneContent()
			//createBottomPaneContent()
			//updateIterationPlanContent()
		
				//Plan Editing:
			//createEmptyIterateGroup()
			//getIterationPlans()
			//createIterationPlan(useTargetPlanName,useCommandsFromGUI)
			//deleteIterationPlan()
        	//showAddCommandDialog(insertIndex)
        	//	localShowParamControls(commandKey)
			//addCommand(type,params)
			//deleteCommand(i)
			//savePlanCommandSequence(plan,commands,respsonseHandler)
		
				//Plan Control:
			//startTargetIterationPlan
			//haltTargetIterationPlan
			//pauseTargetIterationPlan
			
				//Helpers:
			//saveModifiedTables(successMsg,failureMsg)        	
		
				//Display:
            //drawIterationPlan(plan)
            //  localExtractTree(tree)
            //  localDrawIterationPlan()        	
        	//		localCreateSaveButton()
        	//handlePlanOverlayMouseMove(addIndex,event)
        	//handlePlanNameMouseMove(deleteIndex,event)
    		//handlePlanParamsMouseMove(i,event)
        	//updateIterateStatus()	
        	//bodyMouseMoveHandler()
        	//openDiv(idStr,classStr,styleStr,mouseupStr,mousemoveStr,titleStr,mousedownStr)
    		//clearDiv()
		
				//Input Handlers:
			//handleMouseOver(type,id) 
			//handleEndMouseOver() 
			//handlePlanSelect() 
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
				

		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init() 
		{									
			Debug.log("Iterate init ");
			DesktopContent.tooltip("Iterate Introduction",
					"Welcome to the Iterate GUI. Here you can create 'Iteration Plans' that can facilitate "+
					"calibrations or complex run plans. \n\n" +
					
					"For an example calibration case, you might create an Iteration Plan to step through " +
					"a register value from 0 to 50, counting by 10.\n\n" +
					
					"For an example run plan case, you might create an Iteration Plan to take 5 runs for " +
					"10 minutes each.\n\n" +
					
					"The organization of the Iterate GUI is in the form of two panes, a top and bottom.\n\n" +
					
					"Briefly, here is a description of the two panes: " +
					"<INDENT> " +
					"- <b>Top Pane</b>\n" +
					"<INDENT> The 'Top Pane' is for controlling the selected Iteration Plan. " +
					"You can Play, Pause, or Stop the Iteration Plan. Or if you make modifications " +
					"you can Save or Discard them." +
					"</INDENT>" +
					"</INDENT>" + 
					"<INDENT> " +
					"- <b>Bottom Pane</b>\n" +
					"<INDENT> The 'Bottom Pane' is for viewing and modifying the selected Iteration Plan. " +
					"</INDENT>" +
					"</INDENT>"
			);
			
			//extract get parameters
			if(!extractGETParameters())
			{
				Debug.log("Illegal GET parameters. Aborting.",
						Debug.HIGH_PRIORITY);
				return;
			}


			//get subset record uids and 
			//	calls paint() and adds resize listener when done
			initIterateData();
			

			//be careful to not override the window.onmousemove DesktopContent action
			DesktopContent.mouseMoveSubscriber(bodyMouseMoveHandler);
						
		} //end init()
		
		//=====================================================================================
		//paint ~~
		//	positiong left and right panes based on window size
		function paint() 
		{	
			var w = DesktopContent.getWindowWidth();
			var h = DesktopContent.getWindowHeight();
			//Debug.log("paint w,h=" + w + "," +h);

			var MIN_H = 280;
			var MIN_W = 580;
			if(w < MIN_W)
				w = MIN_W;
			if(h < MIN_H)
				h = MIN_H;
			
			Debug.log("paint w,h=" + w + "," +h);

			var TOP_H = 85;//56;
			var BORDER_SZ = 0;			
			var MARGIN = 5;
			
			if(!_bottomPane && !_topPane)
			{
				//first time create elements
				createTopPaneContent();
				createBottomPaneContent();
				
				updateIterationPlanContent();
			}

			
			var y = MARGIN;
			var x = MARGIN;
			w -= 2*MARGIN;
			h -= 2*MARGIN;
			
			_topPane.style.left = x + "px";
			_topPane.style.top = y + "px";
			_topPane.style.width = (w - 2*BORDER_SZ) + "px";
			_topPane.style.height = (TOP_H - 2*BORDER_SZ) + "px";
			
			y += TOP_H + MARGIN;
			h -= TOP_H + MARGIN;

			//set bottom pane sizes
			h -= 2*BORDER_SZ + MARGIN;
			
			_bottomPane.style.left = x + "px";
			_bottomPane.style.top = y + "px";
			_bottomPane.style.width = w + "px";
			_bottomPane.style.height = h + "px";
						
		}	//end paint()

		//=====================================================================================
		//updateIterationPlanContent ~~
		function updateIterationPlanContent() 
		{	
			var el = document.getElementById("planSelector");
			if(!el) {Debug.log("Error: updateIterationPlanContent null"); return; } 
			
			var optionIndex = -1;
			
			str = "";

			str += "<div id='planSelectDiv'>";
			str += "<b>Choose an Iteration Plan: </b>";
			if(_planUIDs.length == 0)
			{
				str += "No plans found. Create one here ==> ";
			}
			else
			{
				str += "<select id='planSelect' onchange='handlePlanSelect();'>";
				for(var i=0;i<_planUIDs.length;++i)
				{
					str += "<option value='" + i + "'>";
					str += _planUIDs[i];	//can display however
					str += "</option>";
					
					if(_planUIDs[i] == _targetPlan)
						optionIndex = i;
				}
				str += "</select>";
			}
			str += "</div>"; //end planSelectDiv

			str += "<div id='recordAddDiv' ";
			if(_planUIDs.length == 0)
				str += "style='margin: -4px 16px -10px 0;' ";
			else 
				str += "style='margin: -2px 16px -10px 0;' ";
			str += "'>";			
			str += "<a class='recordAdd' onclick='createIterationPlan(); return false;' ";			
			str += "title='Create a new " + _recordsAlias + ".'" +
					">";
			str += "+";
			str += "</a>";
			str += "</div>";

			str += "<div id='recordDeleteDiv' class='treeNode-deleteIcon' ";
			if(_planUIDs.length == 0) str += "style='display:none' ";
			str += "onclick='deleteIterationPlan(); return false;' " +
					"title='Delete the selected " + _recordsAlias + ".'" +					
					">";
			str += "</div>";

			el.innerHTML = str;
			
			//if no target plan and plans exist, load the first one
			if(_targetPlan == "")
			{
				if(_planUIDs.length)
					drawIterationPlan(_planUIDs[0]);
				else
					drawIterationPlan();					
			}
			else
			{
				var sel = document.getElementById("planSelect");				

				if(optionIndex >= 0)
				{
					sel.selectedIndex = optionIndex;
					sel.focus();
				}
				
				drawIterationPlan(_targetPlan);
			}
			
		} //end updateIterationPlanContent()
		

		//=====================================================================================
		//drawIterationPlan ~~
        //  if plan then request commands from server, otherwise use current _targetPlan and
        //      existing _commands.
		function drawIterationPlan(plan) 
		{
			if(plan !== undefined)
            {
				_targetPlan = plan;
                
				if(!_DEBUG_WOUT_SERVER)
                ConfigurationAPI.getTree(_ITERATE_BASE_PATH + "/" + plan,
                                         6, //down through command parameters
										 _modifiedTables,
                                         localExtractTree
                                         );
            }
			else
				plan = _targetPlan;
			
			Debug.log("drawIterationPlan " + plan);
			
			//load plan and display detail
			//	get command sequence
			
            if(_DEBUG_WOUT_SERVER)
            {
                //bypass server request and fake data
                var children = document.createElement("div");
                var commands = [];
                commands.push({ 	//BEGIN_LABEL
                "type" : _COMMAND_TYPES.BEGIN_LABEL,
                "param" : {"Label":"Main"},
                });
                commands.push({ 	//CHOOSE_FSM
                "type" : _COMMAND_TYPES.CHOOSE_FSM,
                "param" : {"NameOfStateMachine":(_fsmNames.length? //use first name, if any exist
                		_fsmNames[0]
                        :"")},
                });
                commands.push({		//CONFIGURE_ALIAS aliasMap[0]
                "type" : _COMMAND_TYPES.CONFIGURE_ALIAS,
                "param" : {"SystemAlias":(_configGroupAliases.length? //use first alias, if any exist
                		_configGroupAliases[0].alias
						:"")},
                });
                commands.push({		//RUN 5 minutes
                "type" : _COMMAND_TYPES.RUN,
                "param" : {"WaitForAllFrontEndsRunningThread":0,
					"DurationInSeconds": 5*60},
                });
                commands.push({ 	//REPEAT_LABEL
                "type" : _COMMAND_TYPES.REPEAT_LABEL,
                "param" : {"Label":"Main", "NumberOfRepetitions":0},
                });
                
                _commands = commands;
                
                localDrawIterationPlan();
                return;
            }
            else
                localDrawIterationPlan();
            	
            
            
            //::::::::::::::::::::::::::::::::::::
            //localExtractTree ~
            //	extract tree into the _commands object
            function localExtractTree(tree)
            {
                if(!tree && !_DEBUG_WOUT_SERVER)
                {
                    Debug.log("Invalid tree xml object.");
                    return;
                }
                
                _commands = []; //clear
                
                //try for any errors in format
                try
                {
                	var nodes = tree.children;
                	var nodeChildren;
                	var commandChildren;
                	var commandFieldsChildren;
                	var parameterChildren;
                	var parameterName;
                	var targetTableCSVStr,targetUIDCSVStr;
                	var targetChildren;
                	var countCommands = 0;

                	var type,params; //to make command

                	//for each plan field
                	//	find link to command group
                	//		for each command
                	//			fill command type
                	//			find link to parameters
                	//				fill parameters
                	for(var i=0;i<nodes.length;++i)
                	{                    
                		nodeChildren = nodes[i].children;

                		if(nodeChildren[0].nodeName != "value")    //asssume this is group link to commands
                		{
                			for(var j=0;j<nodeChildren.length;++j)
                			{
                				if(nodeChildren[j].nodeName == "node")
                				{
                					//found child node -- command UID level                            	
                					commandChildren = nodeChildren[j].children;

                					for(var k=0;k<commandChildren.length;++k)
                					{   	
                						if(commandChildren[k].nodeName == "node")
                						{
                							//found child node -- command field
                							if(commandChildren[k].getAttribute("value") == "CommandType")
                							{
                								type = commandChildren[k].children[0].getAttribute("value");
                								params = [];
                							}
                							else if(commandChildren[k].getAttribute("value") == "LinkToCommandConfiguration")
                							{
                								parameterChildren = commandChildren[k].children;

                								for(var l=0;l<parameterChildren.length;++l)
                								{   	
                									if(parameterChildren[l].nodeName == "node")
                									{
                										//found child node -- parameter field
                										// take as parameter until the comment field is reached

                										parameterName = parameterChildren[l].getAttribute("value");
                										if(parameterName == "CommentDescription")
                											break;

                										Debug.log("parameter name = " + parameterName);

                										if(parameterName == "LinkToTargets")
                										{
                											//extract targets
                											Debug.log("getting targets");
                											targetTableCSVStr = "";
                											targetUIDCSVStr = "";

                											targetChildren = parameterChildren[l].children;

                											for(var m=0;m<targetChildren.length;++m)
                											{   	
                												if(targetChildren[m].nodeName == "node")
                												{
                													//found target record
                													//	second record is link
                													//		first two nodes are uid and table
                													targetUIDCSVStr += 
                															targetChildren[m].children[1].getElementsByTagName(
                																	"UID")[0].getAttribute("value");
                													targetTableCSVStr += 
                															targetChildren[m].children[1].getElementsByTagName(
                																	"LinkConfigurationName")[0].getAttribute("value");                                                            	
                												}
                											} //end target loop

                											params.push(targetTableCSVStr);
                											params.push(targetUIDCSVStr);
                										}
                										else                                                
                											params.push(parameterChildren[l].children[0].getAttribute("value"));

                										Debug.log("parameter value = " + params[params.length-1]);                                                	
                									}
                								} //end parameter loop
                							}
                						}

                					}

                					//at this point, have command type and params
                					console.log(type);	
                					console.log(params); 
                					addCommand(type,params);
                				}
                			}

                			Debug.log("countCommands = " + _commands.length);
                		}
                	}
                } //end try
                catch(e)
                {
                	Debug.log("Invalid iteration plan loaded: " + e);
                	_commands = []; //clear
                }
				
                _planIsModified = false; //because just loaded
                localDrawIterationPlan();
                
            } // end localExtractTree()
            
            //::::::::::::::::::::::::::::::::::::
            //draw based on _commands
            function localDrawIterationPlan()
            {
                if(!_commands)
                {
                    Debug.log("Invalid commands object.");
                    return;
                }
                
                var el = document.getElementById("planDetail");
                if(!el) {Debug.log("Error: updateIterationPlanContent null"); return; }
                
                el.innerHTML = ""; //clear
                
                if(!plan || plan == "")
                	return;                 
                
                var str = "";
                
                //Display Concept:
                //  Plan name at top left
                //      Vertical bar extending down inset off left edge of name
                //      Each Loop
                //          New vertical bar extending down inset off BEGIN_LABEL command

                if(_planIsModified)
                	str += localCreateSaveButton();
                
                str += openDiv('plan-planName');                	
                str += "<b>Plan Name:</b> " + plan;
                str += "</div>";

                //show created time
        		//ConfigurationAPI.getDateString(date)

                str += clearDiv();

                var commands = _commands;
                var depth = 0;
                var paramKeys;
                var i;
                //make first vertical bar					
                str += openDiv("plan-depthBar-" + depth,
                		"plan-depthBar");                  
                {	//start depth 0 span -----------										
                	for(i=0;i<commands.length;++i)
                	{
                		str += clearDiv();

                		//get command parameter keys
                		paramKeys = Object.keys(commands[i].param); 
                		
                		//each command should have a half up/down overlay
                		//	for showing add command +

                		str += openDiv(	//start i command ----------- 
                				"plan-command-" + i,
								"plan-command",
								"position:relative");                  		

                		//command name
                		str += openDiv(
                				"plan-command-name-" + i,
								"plan-command-name",
								0 /*style*/,
								0 /*mouseup*/,
								"handlePlanNameMouseMove(" + i + ",event)" /*mousemove*/);
                		str += "<b>" + (i+1) + ". " + commands[i].type + 
                				(paramKeys.length?":":".") + //show period if params
								"</b> ";
                		str += "</div>";

                		//delete command button
                		str += openDiv(0,"plan-command-deleteWrapper");
                		str += openDiv(
                				"plan-command-delete-" + i,
								"plan-command-delete",
								"display:none" /*style*/,
								"deleteCommand(" + i + ");" /*mouseup*/,
								"handlePlanOverlayMouseMove(-1,event);" /*mousemove*/, //trick, to hide add icon and stop event propagation
								"Delete this command." /*title*/);
                		str += "";
                		str += "</div>";
                		str += "</div>";

                		//command params
                		str += openDiv(
                				"plan-command-params-" + i,
								"plan-command-params",
								0 /*style*/,
								0 /*mouseup*/,
								"handlePlanParamsMouseMove(" + i + ",event);" /*mousemove*/);
                		for(var j=0;j<paramKeys.length;++j)
                			str += " " + paramKeys[j] + "=" + 
							commands[i].param[paramKeys[j]];
                		str += "</div>";

                		//up overlay
                		str += openDiv(
                				"plan-command-upOverlay-" + i,
								"plan-command-overlay plan-command-upOverlay",
								0 /*style*/,
								0 /*mouseup*/,
								"handlePlanOverlayMouseMove(" + i + ",event)"/*mousemove*/);
                		str += "</div>";

                		//dn overlay
                		str += openDiv(
                				"plan-command-dnOverlay-" + i,
								"plan-command-overlay plan-command-dnOverlay",
								0 /*style*/,
								0 /*mouseup*/,
								"handlePlanOverlayMouseMove(" + (i+1) + ",event)"/*mousemove*/);
                		str += "</div>";

                		//add command control
                		str += openDiv( //start add i command ----------- 
                				"plan-command-addCommand-" + i,
								"plan-command-addCommand",
								"display:none" /*style*/,
								0 /*mouseup*/,
								"event.stopPropagation();"/*mousemove*/);
                		{
                			//start add command button
                			str += openDiv(  
                					"plan-command-addCommand-button" + i,
									"plan-command-addCommand-button",
									0 /*style*/,
									"showAddCommandDialog(" + i + ")" /*mouseup*/,
									"event.stopPropagation();"/*mousemove*/, 
									"Insert new command" /*title*/ );
                			str += "+";
                			str += "</div>";
                		}
                		str += "</div>"; //end add i command -----------

                		str += "</div>"; //close i command ----------- 
                	}

                	//finished with commands, add "End" indicator
                	//add last command control
                	{
                		str += clearDiv();

                		str += openDiv(	//start end command ----------- 
                				"plan-command-" + i,
								"plan-command",
								"position:relative");  

                		str += "<b>" + (i+1) + ". PLAN_END." + "</b> ";

                		//up overlay
                		str += openDiv(
                				"plan-command-upOverlay-" + i,
								"plan-command-overlay plan-command-upOverlay",
								0 /*style*/,
								0 /*mouseup*/,
								"handlePlanOverlayMouseMove(" + i + ",event)"/*mousemove*/);
                		str += "</div>";                	

                		//add command control
                		str += openDiv( //start add end command ----------- 
                				"plan-command-addCommand-" + i,
								"plan-command-addCommand",
								"display:none" /*style*/,
								0 /*mouseup*/,
								"event.stopPropagation();"/*mousemove*/);
                		{
                			//start add command button
                			str += openDiv(  
                					"plan-command-addCommand-button" + i,
									"plan-command-addCommand-button",
									0 /*style*/,
									0 /*mouseup*/,
									"event.stopPropagation();"/*mousemove*/,
									"Insert a new command.");
                			str += "+";
                			str += "</div>";
                		} str += "</div>"; //end add end command -----------
                		 
                		str += "</div>"; //close end command -----------
                	} //end last command span

                } str += "</div>";  //end depth 0 span -----------


                if(_planIsModified)
                {
                	str += clearDiv();
                	str += "<br><br>";
                	str += localCreateSaveButton();
                }
                
                //done with assembling display string                
                el.innerHTML = str;    
                

                //::::::::::::::::::::::::::::::::::::
                function localCreateSaveButton()
                {
                	str = "";
                	str += "<input type='button'" +
                			" onmouseup='" + 
							"createIterationPlan(true /*useTargetPlanName*/,true /*useCommandsFromGUI*/);" +							
							"' " + 
                			" value='Save'" +
							" title='" +
							"Save the current modified Iteration Plan." +
							"'/>";
                	str += "&nbsp;&nbsp;&nbsp;"
                	str += "<input type='button'" +
                			" onmouseup='" + 
							"createIterationPlan(false /*useTargetPlanName*/,true /*useCommandsFromGUI*/);" + 						
							"' " + 
                			" value='Save as...'" +
							" title='" +
							"Save the current modified Iteration Plan." +
							"'/>";
                	str += "<br><br>";
                	return str;
                } //end localCreateSaveButton()
                
            } //end localDrawIterationPlan()
            

			
		} //end drawIterationPlan()

		//=====================================================================================
		//openDiv ~~		
		function openDiv(idStr,classStr,styleStr,mouseupStr,mousemoveStr,
				titleStr,mousedownStr)
		{
			return "<div " + 
					(idStr?("id='" + idStr + "' "):"") + 
					(classStr?(" class='" + classStr + "' "):"") +
					(styleStr?(" style='" + styleStr + "' "):"") +
					(mouseupStr?(" onmouseup='" + mouseupStr + "' "):"") + 
					(mousemoveStr?(" onmousemove='" + mousemoveStr + "' "):"") + 
					(titleStr?(" title='" + titleStr + "' "):"") + 
					(mousedownStr?(" onmousedown='" + mousedownStr + "' "):"") + 						
					">";
		} //end openDiv
		
		//=====================================================================================
		//clearDiv ~~		
		function clearDiv()
		{
			return "<div id='clearDiv'></div>";
		} //end clearDiv
		
		//=====================================================================================
		//handlePlanNameMouseMove ~~		
		function handlePlanNameMouseMove(deleteIndex,event)
		{
			//Debug.log("handlePlanNameMouseMove " + deleteIndex);
			
			//pass along event
			handlePlanOverlayMouseMove(deleteIndex,event);

			//remove all previous param displays
			handlePlanParamsMouseMove(-1);
			
			if(_shownDeleteCommandIndex == deleteIndex)
				return;
			
			//if not current, then hide current and show new

			try //try to hide, and ignore errors
			{
				if(_shownDeleteCommandIndex != -1)
					document.getElementById("plan-command-delete-" + 
							_shownDeleteCommandIndex).style.display = "none";
			}
			catch(e){} //ignore

			_shownDeleteCommandIndex = deleteIndex;
			if(_shownDeleteCommandIndex != -1)
				document.getElementById("plan-command-delete-" + 
					_shownDeleteCommandIndex).style.display = "block";
		} //end handlePlanNameMouseMove()
		
		//=====================================================================================
		//handlePlanOverlayMouseMove ~~		
		function handlePlanOverlayMouseMove(addIndex,event)
		{
			//show add + command icon in right place
			
			event.stopPropagation();
			
			//Debug.log("handlePlanOverlayMouseMove " + addIndex);
			
			if(_shownAddCommandIndex == addIndex)
				return;
			
			//if not current, then hide current and show new			

			try //try to hide, and ignore errors
			{
				if(_shownAddCommandIndex != -1)
					document.getElementById("plan-command-addCommand-" + 
							_shownAddCommandIndex).style.display = "none";
			}
			catch(e){} //ignore
			
			_shownAddCommandIndex = addIndex;
			
			if(_shownAddCommandIndex != -1)
				document.getElementById("plan-command-addCommand-" + 
						_shownAddCommandIndex).style.display = "block";
		} //end handlePlanOverlayMouseMove()
		
		//=====================================================================================
		//handlePlanOverlayMouseMove ~~		
		function handlePlanParamsMouseMove(i,event)
		{
			if(event) event.stopPropagation();
			
			//show parameters in easy to read fashion
			
			//remove all previous param displays
			var el;
			do
			{
				el = document.getElementById("plan-command-parameterDisplay");
				if(el) el.parentNode.removeChild(el);
			} while(el);
			
			if(i == -1) return;
			
			
			if(document.getElementById("DesktopContent-verifyPopUp"))
				return; //do not show if there is a popup

			//Debug.log("handlePlanParamsMouseMove " + i);
			
    		//get command parameter keys
			var paramKeys = Object.keys(_commands[i].param);

			el = document.createElement("div");
			el.setAttribute("id","plan-command-parameterDisplay");
			var str = "";
			
			str += "<b>" + (i+1) + ". " + _commands[i].type +					
					"</b>";
			//str += "<br>";
			//str += "Time Created: ";
			str += "<br>";
			str += "Parameter Count: " + paramKeys.length;
			str += "<br>";
			str += "<br>";
			str += "<table>";		
			
			for(var j=0;j<paramKeys.length;++j)
			{
				str += "<tr>";
				str += "<td>";
				str += "<b>" + paramKeys[j] + ":</b> ";
				str += "</td>";
				str += "<td style='padding-right:10px'>"; 	//for nice spacing after scroll right
				str += _commands[i].param[paramKeys[j]];
				str += "</td>";
				str += "</tr>";
			}
			str += "</table>";	
			
			el.innerHTML = str;
			
			//get x, y from offset parents
			var parentEl = document.getElementById("plan-command-params-" + i);
					
			var top = 0;
			var left = 0;
			var offsetParent; //save last valid offsetParent
			
			//accumulate parents
			while(parentEl)
				{top += parentEl.offsetTop; left += parentEl.offsetLeft;
				offsetParent = parentEl; //save last valid offsetParent
				parentEl = parentEl.offsetParent;}
			
			el.style.top = (top-15) + "px";
			el.style.left = (left+15) + "px";

			el.style.width = "";

			var width = _bottomPane.offsetWidth - left - 25;
			
			el.onmousemove = function(event) {event.stopPropagation();} //prevent disappearing act from body mousemove
			
			//add child to offsetParent so that position is correct
			offsetParent.appendChild(el);
			
			//make sure width is on screen
			if(el.offsetWidth > width)
				el.style.width = width + "px";			
		} //end handlePlanParamsMouseMove()
		
		//=====================================================================================
		//bodyMouseMoveHandler ~~
		//	handles mouse movements on window body
		function bodyMouseMoveHandler() 
		{
			//try hiding add command and ignore errors
			if(_shownAddCommandIndex != -1)
			{
				try
				{
					document.getElementById("plan-command-addCommand-" + 
						_shownAddCommandIndex).style.display = "none";
				}
				catch(e){}
				_shownAddCommandIndex = -1; //clear
			}
			
			//try hiding delete command and ignore errors
			if(_shownDeleteCommandIndex != -1)
			{
				try
				{
					document.getElementById("plan-command-delete-" + 
							_shownDeleteCommandIndex).style.display = "none";
				}
				catch(e){}
				_shownDeleteCommandIndex = -1; //clear
			}
			
			//remove all previous param displays
			handlePlanParamsMouseMove(-1);
		} //end bodyMouseMoveHandler()
		
		//=====================================================================================
		//extractGETParameters ~~
		//	return false, if illegal params
		function extractGETParameters() 
		{
			//extract get parameters
			
			_forceSavingModifiedGroups	= DesktopContent.getParameter(0,"forceSavingModifiedGroups");			
			_forceUseOfAliases		 	= DesktopContent.getParameter(0,"forceUseOfAliases");			
			_forceGroupsOnly			= DesktopContent.getParameter(0,"forceGroupsOnly");			
			
			//setup defaults
			if(_forceSavingModifiedGroups === undefined) 	_forceSavingModifiedGroups = false;
			if(_forceUseOfAliases === undefined) 			_forceUseOfAliases = false;
			if(_forceGroupsOnly === undefined) 				_forceGroupsOnly = false;
			
			Debug.log("_forceSavingModifiedGroups " + _forceSavingModifiedGroups);
			Debug.log("_forceUseOfAliases " + _forceUseOfAliases);
			Debug.log("_forceGroupsOnly " + _forceGroupsOnly);
			
			return true;
		}	//end extractGETParameters()
		
		//=====================================================================================
		//initIterateData ~~
		//	fills _planUIDs
		//		array of UIDs defined by the subset (based on _subsetBasePath and _recordPreFilterList)
		//	fills _filterValsObj
		//		for each filter MultiSelect (one for each grouping field), an array of filter values
		function initIterateData() 
		{
			window.clearTimeout(_updateTimer);
					
			//get list of records that match <subsetBasePath> AND <recordPreFilterList>
			_planUIDs = []; //reset
			_filterValsObj = {}; //reset
			_fields = undefined; //reset
			_modifiedTables = undefined; //reset
            
            _targetPlan = ""; //reset
            _commands = []; //reset
			

			if(_bottomPane && _topPane)
			{
				_topPane.innerHTML = ""; //clear
				_bottomPane.innerHTML = ""; //clear
				_topPane.parentNode.removeChild(_topPane); //remove element
				_bottomPane.parentNode.removeChild(_bottomPane); //remove element
				
			}
			_topPane = undefined; //reset
			_bottomPane = undefined; //reset
            
            
            if(_DEBUG_WOUT_SERVER)
            {
                //bypass server and give example iterate plan
                
                _planUIDs = ["test 1", "testB"];
                
                localCompleteInit();
                return;
            }

						
			ConfigurationAPI.getActiveGroups(
					function(groups)
					{
				if(!groups || !groups.Iterate || 
						groups.Iterate.groupKey === undefined ||
						(groups.Iterate.groupKey|0) == -1)
				{
					Debug.log("No active Iterate group.");
					
					//create an empty active group
					createEmptyIterateGroup(
							function(params)
							{
						if(params === undefined)
						{
							Debug.log("Creation of empty Iterate Group failed. Giving up. Call a system admin.",
									Debug.HIGH_PRIORITY);
							return;
						}
						getIterationPlans(localCompleteInit);
							});
					return;
				}
				
				Debug.log("Active Iterate group is " +
						groups.Iterate.groupName + " (" +
						groups.Iterate.groupKey + ").");

				getIterationPlans(localCompleteInit);
				

					}); //end getActiveGroups handler

			//::::::::::::::::::::::::::::::::::::
			function localCompleteInit()
			{
				Debug.log("localCompleteInit -- Wrapping up init.");
				paint();
				if(!_eventListenersCreated)
				{
					window.addEventListener("resize",paint);
					_eventListenersCreated = true; //prevent multiple event creation
				}	
				
				updateIterateStatus();
			} //end localCompleteInit()

						

			//::::::::::::::::::::::::::::::::::::
			//localGetGroups ~
			//	get groups and aliases
			function localGetGroups() 
			{
				Debug.log("localGetGroups");
				DesktopContent.XMLHttpRequest("Request?RequestType=getGroupAliases" + 
						"", //end get data 
						"", //end post data
						function(req)
						{
	
					Debug.log("getGroupAliases handler");
	
					var groupAliases = req.responseXML.getElementsByTagName("GroupAlias");
					var groupNames = req.responseXML.getElementsByTagName("GroupName");
					var groupKeys = req.responseXML.getElementsByTagName("GroupKey");
					var groupComments = req.responseXML.getElementsByTagName("GroupComment");
					var groupTypes = req.responseXML.getElementsByTagName("GroupType");
					var aliasComments = req.responseXML.getElementsByTagName("AliasComment");
	
					_configGroupAliases = [];
					for(var i=0;i<groupAliases.length;++i) 
						if(groupTypes[i].getAttribute('value') == "Configuration")
							_configGroupAliases.push({
									"alias" : groupAliases[i].getAttribute('value'),
									"name" : groupNames[i].getAttribute('value'),
									"key" : groupKeys[i].getAttribute('value'),
									"groupComment" : groupComments[i].getAttribute('value'),
									"aliasComment" : aliasComments[i].getAttribute('value')
						});
	
					console.log("_configGroupAliases",_configGroupAliases);
	
	
						}, //handler
						0, //handler param
						0,false,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
						false /*targetSupervisor*/);
				
				
				DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurationGroups"
						+"&doNotReturnMembers=1", //end get data 
						"", //end post data
						function(req)
						{
					Debug.log("getConfigurationGroups handler");
					
					var groupNames = req.responseXML.getElementsByTagName("ConfigurationGroupName");
					var groupKeys = req.responseXML.getElementsByTagName("ConfigurationGroupKey");
					var groupTypes = req.responseXML.getElementsByTagName("ConfigurationGroupType");
					var groupComments = req.responseXML.getElementsByTagName("ConfigurationGroupComment");
					
					_configGroups = [];
					for(var i=0;i<groupNames.length;++i) 
						if(groupTypes[i].getAttribute('value') == "Configuration")
							_configGroups.push({								
									"name" : groupNames[i].getAttribute('value'),
									"key" : groupKeys[i].getAttribute('value'),
									"groupComment" : groupComments[i].getAttribute('value')
						});
					
					console.log("_configGroups",_configGroups);
					
						}, //handler
						0, //handler param
						0,false,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
						false /*targetSupervisor*/);
			} //end localGetGroups()
			localGetGroups();
			
			
			//::::::::::::::::::::::::::::::::::::
			//localGetNamesOfFSMs ~
			//	get groups and aliases
			function localGetNamesOfFSMs() 
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=getStateMachineNames" + 
						"", //end get data 
						"", //end post data
						function(req)
						{

					Debug.log("getStateMachineNames handler");

					var names = req.responseXML.getElementsByTagName("stateMachineName");

					_fsmNames = [];
					for(var i=0;i<names.length;++i) 
						_fsmNames.push(names[i].getAttribute('value'))

					console.log("_fsmNames",_fsmNames);

						}, //handler
						0, //handler param
						0,false,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
						true /*targetSupervisor*/);
			} //end localGetNamesOfFSMs()
			localGetNamesOfFSMs(); 
			
			
		}	//end initIterateData()

		//=====================================================================================
		//createEmptyIterateGroup ~~
		function createEmptyIterateGroup(responseHandler) 
		{
			Debug.log("createEmptyIterateGroup");
			
			//create a group with each table in group key -1 (to use empty mockup table)
			//  on failure, give up and assume there are existing groups that admin could activate
					
			ConfigurationAPI.getGroupTypeMemberNames("Iterate",
					function(members)
					{
				Debug.log("getGroupTypeMemberNames handler");				
				var configMapStr = "configList=";
				for(var i=0;i<members.length;++i)
					configMapStr += members[i] + ",-1,";
				ConfigurationAPI.saveGroupAndActivate(
						"iterateDefaultGroup",
						configMapStr,
						responseHandler, //pass handler to be called
						true /*doReturnParams*/						
						)			
					}); // end getGroupTypeMemberNames handler
	

		}	//end createEmptyIterateGroup()
		
		//=====================================================================================
		//getIterationPlans ~~
		function getIterationPlans(responseHandler) 
		{
			Debug.log("getIterationPlans");
			
			//get existing iteration plans
			ConfigurationAPI.getSubsetRecords(
					_ITERATE_BASE_PATH,
					"",
					function(records)
					{
				_planUIDs = records;
				Debug.log("iteration plans found = " + records.length);
				console.log(records);

				if(responseHandler) responseHandler();
				
					});	//end getSubsetRecords handler	
			
		}	//end getIterationPlans()	
		
		//=====================================================================================
		//createTopPaneContent ~~
		function createTopPaneContent() 
		{
			_topPane = document.createElement("div");
			_topPane.setAttribute("class", "pane");
			_topPane.setAttribute("id", "topPane");			
			
			var el;
			var str;
			
			el = document.createElement("div");
			str = "";
			str += "<a href='#' onclick='initIterateData()'>Refresh</a>";
			el.innerHTML = str;
			_topPane.appendChild(el);			

			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_topPane.appendChild(el);
			
			el = document.createElement("div");
			el.setAttribute("id", "topPane-header");
			_topPane.appendChild(el);			
			
			document.body.appendChild(_topPane);			
		}	//end createTopPaneContent()
		
		//=====================================================================================
		//createBottomPaneContent ~~
		function createBottomPaneContent(leftW) 
		{
			_bottomPane = document.createElement("div");
			_bottomPane.setAttribute("class", "pane");
			_bottomPane.setAttribute("id", "bottomPane");
			

			//	- Bottom Pane:
			//		* Similar functionality to GUI subset.. in that it edits the 
			//			the currently active Iteration group. (If a user wants to change the active
			//			Iteration group, they must do so in the Config GUI)
			//
			//		* Very top of "tree-view" choose the Iteration Plan name
			//			* Then default to
			//				- START LOOP 0 (hide index from user - show by indent)
			//				- Configure Configuration Group/System Alias
			//				- REPEAT LOOP 0 ( 0 times - when 0 show as END LOOP)
			//				- In GUI, show END (no representation in table)
			//					
			//		* Create Rows in table that match sequence
			
			var el;
			var str;
						
						
						
			//create target plan selector div: dropdown with + / TRASH
			el = document.createElement("div");
			el.setAttribute("id", "planSelector");			
			_bottomPane.appendChild(el);	
			
			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_bottomPane.appendChild(el);
			
			//create plan detail div
			el = document.createElement("div");
			el.setAttribute("id", "planDetail");			
			_bottomPane.appendChild(el);	

			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_bottomPane.appendChild(el);		
						
			document.body.appendChild(_bottomPane);
						
		}	//end createBottomPaneContent()


		//=====================================================================================
		//createIterationPlan ~~
		function createIterationPlan(useTargetPlanName,useCommandsFromGUI)
		{
			var planName;
			
			if(!useTargetPlanName)
			{
				planName = prompt("Please enter a name for the new " +
						_recordsAlias + ":");
				if(planName)
					planName = planName.trim();
				else //prompt was cancelled
					return;	//do nothing
			}
			else 
				planName = _targetPlan;
			
			Debug.log("createIterationPlan " + planName);

			localCreateIterationPlan();
			return;
			
			//::::::::::::::::::::::::::::::::::::::::::
			//localCreateIterationPlan ~
			function localCreateIterationPlan()
			{
				//new default iteration plan 

				//steps:
				//	create new record
				//	edit record (status=On, groupLinkId=uid + "plan)
				//	save
				//	refresh

				/////////////////////
				ConfigurationAPI.addSubsetRecords(_ITERATE_BASE_PATH,planName,
						/////////////////////
						function(modifiedTables,err) //start addSubsetRecords handler
						{
					Debug.log("modifiedTables length " + modifiedTables.length);

					if(!modifiedTables.length)
					{
						if(err && err.indexOf("Entries in UID are not unique.") >= 0)
						{
							//not really an error, can use existing plan
							Debug.log("Using existing plan name.", Debug.INFO_PRIORITY);							
						}
						else
						{
							//really an error
							Debug.log("There was an error while creating the " + _recordsAlias + " '" + 
									planName  + ".'",
									Debug.HIGH_PRIORITY);
							return;
						}
					}

					_modifiedTables = modifiedTables;

					var fieldArr = ["Status",
									"LinkToIterationPlanConfiguration",
									"LinkToIterationPlanGroupID",
									"CommentDescription"
									];

					var valueArr = ["1",//"Status",
									_PLAN_BASE_PATH,//"LinkToIterationPlanConfiguration",
									planName+"-Plan",//"LinkToIterationPlanGroupID",
									"Generated by Iterate app"//"CommentDescription"
									];

					/////////////////////
					ConfigurationAPI.setFieldValuesForRecords(
							_ITERATE_BASE_PATH,
							[planName], 	//recordArr
							fieldArr, 	//fieldArr
							valueArr, 	//valueArr
							/////////////////////
							function(modifiedTables) //start setFieldValuesForRecords
							{
						Debug.log("modifiedTables length " + modifiedTables.length);

						if(!modifiedTables.length)
						{
							Debug.log("There was an error while creating the " + _recordsAlias + " '" + 
									planName  + ".'",
									Debug.HIGH_PRIORITY);
							return;					
						}

						_modifiedTables = modifiedTables;

						//create DEFAULT commands:
						//	BEGIN_LABEL			
						//	CHOOSE_FSM	fsmNames[0]
						//	CONFIGURE_ALIAS aliasMap[0]
						//	RUN 5 minutes
						// 	REPEAT_LABEL
						if(!useCommandsFromGUI)
						{
							_commands = []; //clear
							addCommand(_COMMAND_TYPES.BEGIN_LABEL,
									["Main"]);
							addCommand(_COMMAND_TYPES.CHOOSE_FSM,
									[(_fsmNames.length? //use first name, if any exist
											_fsmNames[0]
													  :"")]);
							addCommand(_COMMAND_TYPES.CONFIGURE_ALIAS,
									[(_configGroupAliases.length? //use first alias, if any exist
											_configGroupAliases[0].alias
											:"")]);//"SystemAlias"
							addCommand(_COMMAND_TYPES.RUN,
									[0, //"WaitForAllFrontEndsRunningThread"
									 5*60]); //"DurationInSeconds"
							addCommand(_COMMAND_TYPES.REPEAT_LABEL,
									["Main",
									 0]); //"NumberOfRepetitions"
						}		
						
						//FOR DEBUGGING
						//FOR DEBUGGING
						//FOR DEBUGGING
						if(0)
						{
							_commands = []; //clear
							addCommand(_COMMAND_TYPES.BEGIN_LABEL,
									["Main"]);
							addCommand(_COMMAND_TYPES.CHOOSE_FSM,
									[(_fsmNames.length? //use first name, if any exist
											_fsmNames[0]
													  :"")]);
							addCommand(_COMMAND_TYPES.MODIFY_ACTIVE_GROUP,
									[								
									 "FEInterfaceConfiguration",//"Tables":params[0],
									 "ExampleInterface0",//"UIDs":params[1],
									 0,//"DoTrackGroupChanges":params[2], 
									 "LinkToFETypeConfiguration/FirmwareVersion",//"RelativePathToField":params[3],
									 5,//"FieldStartValue":params[4],
									 3]);//"FieldIterationStepSize":params[5]);
							addCommand(_COMMAND_TYPES.CONFIGURE_ACTIVE_GROUP);
							//addCommand(_COMMAND_TYPES.RUN,[1,0]);
							addCommand(_COMMAND_TYPES.REPEAT_LABEL,
									["Main",5]);
						}
						
						savePlanCommandSequence(planName,_commands,
								/////////////////////
								function()
								{
							//only arrive here on success
							
							_targetPlan = planName;														
							
							saveModifiedTables(									
									"The new " +
									_recordsAlias + " '" + 
									planName +
									"' was successfully created!",

									"There was an error while creating the " + _recordsAlias + " '" + 
									planName  + ".'");
							
								}); //end savePlanCommandSequence handler
						
							}, //end setFieldValuesForRecords handler
							_modifiedTables);
					
						}, //end addSubsetRecords handler
						_modifiedTables,
						true /*silenceErrors*/);
					
			} //end localCreateIterationPlan()			
			
		}	//end createIterationPlan()
		
		//=====================================================================================
		//saveModifiedTables ~~
		function saveModifiedTables(successMsg,failureMsg)
		{
			//proceed to save (quietly) tables, groups, aliases
			ConfigurationAPI.saveModifiedTables(_modifiedTables,
					/////////////////////
					function(savedTables, savedGroups, savedAliases)
					{
				if(!savedTables.length)
				{
					Debug.log(failureMsg,
							Debug.HIGH_PRIORITY);
					return;					
				}

				Debug.log(successMsg, Debug.INFO_PRIORITY);

				_modifiedTables = undefined; //clear after save
				
				_planIsModified = false;
				 
				getIterationPlans(updateIterationPlanContent); //updates plans display

					}); //end saveModifiedTables handler
			
		} 	//end saveModifiedTables()
		
		//=====================================================================================
		//deleteIterationPlan ~~		
		function deleteIterationPlan()
		{	
			var uid = document.getElementById("planSelect").value;
			uid = _planUIDs[uid];
			
			Debug.log("deleteIterationPlan " + uid);

			if(_targetPlan == uid)
				_targetPlan = ""; //clear target plan if being deleted
			
			DesktopContent.popUpVerification( 
					"Are you sure you want to delete the iteration plan named '" +
					uid, localHandleDeleteIterationPlan,
					0,"#efeaea",0,"#770000");
			return;
						

			/////////////////////
			//localHandleDeleteIterationPlan ~~
			function localHandleDeleteIterationPlan()
			{

				//Steps:
				//	delete plan
				//	delete command sequence

				/////////////////////
				//addSubsetRecords opposite is deleteSubsetRecords
				ConfigurationAPI.deleteSubsetRecords(_ITERATE_BASE_PATH,uid,
						/////////////////////
						function(modifiedTables) //start deleteSubsetRecords handler
						{
					Debug.log("modifiedTables length " + modifiedTables.length);

					if(!modifiedTables.length)
					{
						Debug.log("There was an error while deleted the " + _recordsAlias + " '" + 
								uid  + ".'",
								Debug.HIGH_PRIORITY);
						return;					
					}

					_modifiedTables = modifiedTables;

					//delete command sequence
					//	by saving empty sequence	
					savePlanCommandSequence(uid,[],
							function()
							{
						Debug.log("Done deleting command sequence.");

						//only arrive here on success
						saveModifiedTables(
								"The " +
								_recordsAlias + " '" + 
								uid +
								"' was successfully deleted!",

								"There was an error while deleting the " + _recordsAlias + " '" + 
								uid  + ".'");

							});

						}, //end deleteSubsetRecords handler
						_modifiedTables);


			} //end localHandleDeleteIterationPlan
			
			
			
			
		}	//end deleteIterationPlan()

		//=====================================================================================
		//showAddCommandDialog ~~		
		function showAddCommandDialog(insertIndex)
		{
			Debug.log("showAddCommandDialog");	

			var str = "";

			var el = document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID);
			if(!el)
			{
				el = document.createElement("div");			
				el.setAttribute("id", ConfigurationAPI._POP_UP_DIALOG_ID);
			}
			el.style.display = "none";

			//set position and size
			var w = 480;
			var h = 200; //25 for each parameter
			ConfigurationAPI.setPopUpPosition(el,w /*w*/,h /*h*/);
			
			//build display string
			var str = "";
			{
				str += "<a id='" + 
						ConfigurationAPI._POP_UP_DIALOG_ID + 
						"-cancel' href='#'>Cancel</a><br><br>";

				str += openDiv(
						ConfigurationAPI._POP_UP_DIALOG_ID + 
						"-div"); //start main div ----------- 

				str += "Insert a new command at position #" + (insertIndex+1) + 
						" in the current Iteration Plan."; 
				str += "<br>";
				str += "<br>";
						
				//show dropdown for command type
				//and then edit boxes for each parameter
				
				str += "<table>";
				
				//type dropdown
				str += "<tr><td>Command Type:</td><td>";
				str += "<select " +												
						"id='popUp-commandType' " +						
						">";
				var commandKeys = Object.keys(_COMMAND_TYPES);
				var defaultType = 0;
				for(var i=0;i<commandKeys.length;++i)
				{
					str += "<option " + (i==defaultType?"selected":"") + ">";
					str += _COMMAND_TYPES[commandKeys[i]];
					str += "</option>";					
				}
				str += "</select>";
				str += "</td></tr>";
				str += "</table>";
				

				//parameter edit control
				// added when type selected
				str += openDiv("popUp-paramControls");
				str += "</div>";
				
				
				
				str += "</table>";
				
				//then Add/Cancel button
				
				str += "</div>"; //close main div ----------- 
				
				str += "<br>";
				str += "<input id='" + ConfigurationAPI._POP_UP_DIALOG_ID + 
						"-submitButton' type='button' " + 
						"value='Add Command' title='" +
						"Insert new command at position #" + (insertIndex+1) + 
						" in the current Iteration Plan." + 
						"'/>";
				
			} //end build display string

			el.innerHTML = str;
			document.body.appendChild(el); //add element to display div
			el.style.display = "block";
			
			//now element is there, so setup finishing touches
			
			//block mousemove from affecting display below
			el.onmousemove = function(event) {event.stopPropagation();} 
			
			//setup default choice parameters
			localShowParamControls(commandKeys[defaultType]);			


			//::::::::::::::::::::::::::::::::::::
			function localShowParamControls(commandKey)
			{
				Debug.log("localShowParamControls " +commandKey);
				var el = document.getElementById("popUp-paramControls");
				var str = "";
				str += "<b>" +  
						"Parameter(s) [count = " + 
						_COMMAND_PARAMS[commandKey].length + 
						"]</b><br>";
				
				str += "<center>";
				str += "<table>";
				
				//type dropdown
				for(var i=0;i<_COMMAND_PARAMS[commandKey].length;++i)
				{
					str += "<tr><td>";
					str += _COMMAND_PARAMS[commandKey][i] + ": ";
					str += "</td><td>";
					
					str += "<input type='text' " +
							" id='popUp-param-" + i + "'" +
							" class='popUp-param'" +
							"/>";	
					
					str += "</td></tr>";				
				}
				str += "</select>";
				str += "</table>";		
				str += "</center>";				

				//set new popup height
				//	25px for each parameter
				var popEl = document.getElementById("" + ConfigurationAPI._POP_UP_DIALOG_ID + "");
				popEl.style.height = (h + 25*_COMMAND_PARAMS[commandKey].length) + "px";
				
				el.innerHTML = str;
			} //end localShowParamControls()
			
			//::::::::::::::::::::::::::::::::::::
			//create cancel onclick handler
			document.getElementById(
					"popUp-commandType").onchange = function(event) {
				Debug.log("Selected " + this.value);
				localShowParamControls(this.value);				
			}; //end submit onmouseup handler	
			
            //::::::::::::::::::::::::::::::::::::
			//create cancel onclick handler
			document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID + 
					"-cancel").onclick = function(event) {
				Debug.log("Cancel click");
				var el = document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID);
				if(el) el.parentNode.removeChild(el); //close popup
				return false;
			}; //end submit onmouseup handler	


            //::::::::::::::::::::::::::::::::::::
			//create submit onmouseup handler
			document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID + 
					"-submitButton").onmouseup = function() {
				Debug.log("Submit mouseup");
				this.disabled = true;
				

				var type = document.getElementById(
						"popUp-commandType").value;
				var params = [];
				
				for(var i=0;i<_COMMAND_PARAMS[type].length;++i)
				{
					params.push(document.getElementById(
							"popUp-param-" + i).value);				
				}
				addCommand(type,params,insertIndex);
				drawIterationPlan();				

				var el = document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID);
				if(el) el.parentNode.removeChild(el); //close popup	

			}; //end submit onmouseup handler	
			
		} //end showAddCommandDialog()
		
		//=====================================================================================
		//addCommand ~~
		//	push to _commands object
		function addCommand(type,params,insertPos)
		{
			Debug.log("addCommand type = " + type);
			
			if(_COMMAND_PARAMS.hasOwnProperty(type))
			{
				_planIsModified = true;
				
				//valid command, so add
				var cmdIndex;
				if(insertPos == undefined || 
						insertPos >= _commands.length || 
						insertPos < 0) //if invalid, add to end
				{
					_commands.push({"param": {} });
					cmdIndex = _commands.length-1;
				}
				else
				{
					cmdIndex = insertPos;
					_commands.splice(cmdIndex, 0, {"param": {} });
				}
				Debug.log("addCommand at #" + (cmdIndex+1));
				
				_commands[cmdIndex].type = type;
				
				//fill parameters 
				for(var i=0;i<_COMMAND_PARAMS[type].length;++i)
					_commands[cmdIndex].param
						[_COMMAND_PARAMS[type][i]] = params[i];
			}
			
//			if(type == _COMMAND_TYPES.BEGIN_LABEL)
//			{
//				_commands.push({
//					"param": {
//						"Label":params[0]},
//				});
//			}
//			else if(type == _COMMAND_TYPES.CHOOSE_FSM)
//			{
//				_commands.push({
//					"param": {
//						"NameOfStateMachine":params[0]},		
//				});
//			}
//			else if(type == _COMMAND_TYPES.CONFIGURE_ACTIVE_GROUP)
//			{
//				_commands.push({
//					"param": {},
//				});
//			}
//			else if(type == _COMMAND_TYPES.CONFIGURE_ALIAS)
//			{
//				_commands.push({
//					"param": {
//						"SystemAlias":params[0]},
//				});
//			}
//			else if(type == _COMMAND_TYPES.CONFIGURE_GROUP)
//			{
//				_commands.push({
//					"param": {
//						"GroupName":params[0], 
//						"GroupKey":params[1]},
//				});
//			}
//			else if(type == _COMMAND_TYPES.EXECUTE_FE_MACRO)
//			{
//				_commands.push({
//					"param": {
//						"CSVTargetTables":params[0], 
//						"CSVTargetUIDs":params[1],
//						"FEMacroName":params[2],
//						"LinkToFEMacroParameterGroup":params[3],
//						"LinkToFEMacroParameterGroupID":params[4]
//					},
//				});
//			}
//			else if(type == _COMMAND_TYPES.EXECUTE_MACRO)
//			{
//				_commands.push({
//					"param": {
//						"CSVTargetTables":params[0], 
//						"CSVTargetUIDs":params[1],
//						"MacroName":params[2],
//						"LinkToMacroParameterGroup":params[3],
//						"LinkToMacroParameterGroupID":params[4]
//					},
//				});
//			}
//			else if(type == _COMMAND_TYPES.MODIFY_ACTIVE_GROUP)
//			{
//				_commands.push({
//					"param": {
//						"CSVTargetTables":params[0], 
//						"CSVTargetUIDs":params[1],
//						"DoTrackGroupChanges":params[2], 
//						"RelativePathToField":params[3],
//						"FieldStartValue":params[4],
//						"FieldIterationStepSize":params[5]
//					},
//				});
//			}
//			else if(type == _COMMAND_TYPES.REPEAT_LABEL)
//			{
//				_commands.push({
//					"param": {
//						"Label":params[0], 
//						"NumberOfRepetitions":params[1]},
//				});
//			}
//			else if(type == _COMMAND_TYPES.RUN)
//			{
//				_commands.push({
//					"param": {
//						"WaitForAllFrontEndsRunningThread":params[0], 
//						"DurationInSeconds":params[1]
//					},
//				});
//			}
			else
			{
				Debug.log("Fatal error. Unknown command attempted!", Debug.HIGH_PRIORITY);
				return;
			}
			
			
		}	//end addCommand()

		//=====================================================================================
		//deleteCommand ~~
		function deleteCommand(i)
		{
			Debug.log("deleteCommand " + i);
			
			DesktopContent.popUpVerification(
					"Are you sure you want to delete the command <br>" +
					(i+1) + ". " + _commands[i].type + "?",
					localDelete,
					0,"#efeaea",0,"#770000");

            //::::::::::::::::::::::::::::::::::::
            function localDelete()
            {
            	Debug.log("localDelete " + i);

            	_planIsModified = true;
            	_commands.splice(i,1);
            	
            	drawIterationPlan(); //update display
            }
			
		}	//end deleteCommand()

		//=====================================================================================
		//savePlanCommandSequence ~~
		function savePlanCommandSequence(plan,commands,responseHandler)
		{
			Debug.log("savePlanCommandSequence " + plan);
			
			plan = encodeURIComponent(plan);
			
			//; separated commands and comma separated params
			var cmdStr = "";
			var pkeys;
			for(var i=0;i<commands.length;++i)
			{
				cmdStr += "type," + encodeURIComponent(commands[i].type);
				pkeys = Object.keys(commands[i].param);

				for(var j=0;j<pkeys.length;++j)
					cmdStr += "," + pkeys[j] + "," +
						encodeURIComponent(commands[i].param[pkeys[j]]);

				cmdStr += ";"; //end command
			}
			Debug.log("cmdStr = " + cmdStr);	
			
			var modifiedTablesListStr = "";
			for(var i=0;_modifiedTables && i<_modifiedTables.length;++i)
			{
				if(i) modifiedTablesListStr += ",";
				modifiedTablesListStr += _modifiedTables[i].tableName + "," +
						_modifiedTables[i].tableVersion;
			}
			
			DesktopContent.XMLHttpRequest("Request?RequestType=savePlanCommandSequence" +
					"&planName=" + plan, //end get data 
					"commands=" + cmdStr +
					"&modifiedTables=" + modifiedTablesListStr, //end post data
					function(req)
					{

				Debug.log("savePlanCommandSequence handler");

				_modifiedTables = [];
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					responseHandler();
					return;
				}

				//console.log(req);

				//modifiedTables
				var tableNames = req.responseXML.getElementsByTagName("NewActiveTableName");
				var tableVersions = req.responseXML.getElementsByTagName("NewActiveTableVersion");
				var tableComments = req.responseXML.getElementsByTagName("NewActiveTableComment");
				var tableVersion;

				//add only temporary version
				for(var i=0;i<tableNames.length;++i)
				{
					tableVersion = DesktopContent.getXMLValue(tableVersions[i])|0; //force integer
					if(tableVersion >= -1) continue; //skip unless temporary
					var obj = {};
					obj.tableName = DesktopContent.getXMLValue(tableNames[i]);
					obj.tableVersion = DesktopContent.getXMLValue(tableVersions[i]);
					obj.tableComment = DesktopContent.getXMLValue(tableComments[i]);
					_modifiedTables.push(obj);
				}
				console.log("_modifiedTables",_modifiedTables);
				responseHandler();

					}, //handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					false /*targetSupervisor*/);
			
		}	//end savePlanCommandSequence()
		
		//=====================================================================================
		//handleMouseOver ~~
		//	based on type and id, handle what should happen during mouseover
		//	
		//	e.g.:
		//		* when over iteration plan, show author, time, etc.
		//		* when over a command, show edit icon and any parameters
		//		* when between commands, show add command icon
		function handleMouseOver(type,id)
		{
			Debug.log("handleMouseOver type=" + type + " id=" + id);
		} // end handleMouseOver()

		//=====================================================================================
		//handleEndMouseOver ~~
		// end mouse over visible things
		function handleEndMouseOver()
		{
			Debug.log("handleEndMouseOver");
		}	//end handleEndMouseOver()
		
		//=====================================================================================
		//handlePlanSelect ~~
		function handlePlanSelect()
		{
			Debug.log("handlePlanSelect");
			
			var sel = document.getElementById("planSelect");

			Debug.log("Selected plan: " + sel.value + " " + _planUIDs[sel.value|0]);
			
			drawIterationPlan(_planUIDs[sel.value|0]);
			
		}	//end handlePlanSelect()
		
		
		//=====================================================================================
		//startTargetIterationPlan ~~
		function startTargetIterationPlan() 
		{
			Debug.log("startTargetIterationPlan " + _targetPlan);

			window.clearTimeout(_updateTimer);
			

			DesktopContent.XMLHttpRequest("StateMachineXgiHandler?" + 
					"&StateMachine=iteratePlay" +
					"&fsmWindowName=" + encodeURIComponent(_targetPlan), //end get data 
					"", //end post data
					function(req) //start handler
					{
				Debug.log("startTargetIterationPlan handler ");
				
				//resume updating
				_updateTimer = window.setTimeout(updateIterateStatus,_UPDATE_TIMER_PERIOD);
				
				var error_message		= DesktopContent.getXMLValue(req,"error_message");
				if(error_message && error_message != "")
					Debug.log(error_message,Debug.HIGH_PRIORITY);
				else
				{
					_old_active_plan_status = ""; //clear for new action
					Debug.log("Successfully started the iteration plan '" + _targetPlan + ".'",
							Debug.INFO_PRIORITY);
					_need_plan_complete = true;
				}
				
					}, //end handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end startTargetIterationPlan
		
		//=====================================================================================
		//pauseTargetIterationPlan ~~
		function pauseTargetIterationPlan() 
		{
			Debug.log("pauseTargetIterationPlan " + _targetPlan);
			

			DesktopContent.XMLHttpRequest("StateMachineXgiHandler?" + 
					"StateMachine=iteratePause", //end get data 
					"", //end post data
					function(req) //start handler
					{
				Debug.log("pauseTargetIterationPlan handler ");

				var error_message		= DesktopContent.getXMLValue(req,"error_message");
				if(error_message && error_message != "")
					Debug.log(error_message,Debug.HIGH_PRIORITY);
				else
				{
					_old_active_plan_status = ""; //clear for new action

					Debug.log("Successfully attempted to pause the iteration plan '" + _targetPlan + ".'",
							Debug.INFO_PRIORITY);
					
					_need_plan_paused = true;
				}
				
					}, //end handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end pauseTargetIterationPlan
		
		//=====================================================================================
		//haltTargetIterationPlan ~~
		function haltTargetIterationPlan() 
		{
			Debug.log("haltTargetIterationPlan " + _targetPlan);

			_need_plan_complete = false; //prevent "complete" message, which might be confusing (depend on the error message

			DesktopContent.XMLHttpRequest("StateMachineXgiHandler?" + 
					"StateMachine=iterateHalt", //end get data 
					"", //end post data
					function(req) //start handler
					{
				Debug.log("haltTargetIterationPlan handler ");

				var error_message		= DesktopContent.getXMLValue(req,"error_message");
				if(error_message && error_message != "")
					Debug.log(error_message,Debug.HIGH_PRIORITY);
				else
				{
					_old_active_plan_status = ""; //clear for new action

					Debug.log("Successfully attempted to halt the iteration plan '" + 
							_targetPlan + "'...",
							Debug.INFO_PRIORITY);
					
					_need_plan_halted = true;
				}
				
					}, //end handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end haltTargetIterationPlan

		//=====================================================================================
		//updateIterateStatus ~~
		function updateIterateStatus() 
		{
			//Debug.log("updateIterateStatus");

			DesktopContent.XMLHttpRequest("Request?" + 
					"RequestType=getIterationPlanStatus", //end get data 
					"", //end post data
					function(req,ignoreParam,errStr) //start handler
					{
				
				if(errStr)
				{
					Debug.log("getIterationPlanStatus ERROR handler ");
					let str = "";
					str += "Disconnected. Click Refresh to attempt to reconnect.";
					document.getElementById('topPane-header').innerHTML = str;
					return;
				} //end error case handler
				
				//Debug.log("getIterationPlanStatus handler ");
				

				var current_state 		= DesktopContent.getXMLValue(req,"current_state");
				var in_transition 		= DesktopContent.getXMLValue(req,"in_transition");
				var transition_progress = DesktopContent.getXMLValue(req,"transition_progress");
				var time_in_state 		= DesktopContent.getXMLValue(req,"time_in_state");
				
				var command_duration 	= DesktopContent.getXMLValue(req,"current_command_duration");
				var command_index		= DesktopContent.getXMLValue(req,"current_command_index");
				var active_plan_status	= DesktopContent.getXMLValue(req,"active_plan_status");
				var active_plan			= DesktopContent.getXMLValue(req,"active_plan");
				var last_started_plan	= DesktopContent.getXMLValue(req,"last_started_plan");
				var last_finished_plan	= DesktopContent.getXMLValue(req,"last_finished_plan");
				var error_message		= DesktopContent.getXMLValue(req,"error_message");
				
				if(_need_plan_complete && 
						active_plan_status == "Inactive")
				{
					Debug.log("Iteration plan was completed.",
							Debug.INFO_PRIORITY);
					_need_plan_complete = false;
				}
				else if(_need_plan_halted && 
						active_plan_status == "Inactive")
				{
					Debug.log("Iteration plan was halted.",
							Debug.INFO_PRIORITY);
					_need_plan_halted = false;
				}
				else if(_need_plan_paused && 
						active_plan_status == "Paused")
				{
					Debug.log("Iteration plan was paused.",
							Debug.INFO_PRIORITY);
					_need_plan_paused = false;
				}
				
				if(active_plan_status == "Error" && 
						_old_active_plan_status != active_plan_status)
					Debug.log(error_message,Debug.HIGH_PRIORITY);
				
				_old_active_plan_status = active_plan_status;
				
				// "Running""Paused""Inactive"
				//Debug.log("_targetPlan = " + _targetPlan);
				//Debug.log("active_plan = " + active_plan);
				//Debug.log("active_plan_status = " + active_plan_status);
				
				
				//========================================
				//top controls and status

				{
					let str = "";

					str += "Target Iteration Plan: ";
					if(active_plan_status == "Inactive")
						str += _targetPlan;
					else
						str += active_plan;
					str += " | ";
					str += "<a onclick='startTargetIterationPlan()'>Start</a> ";
					str += "<a onclick='pauseTargetIterationPlan()'>Pause</a> ";
					str += "<a onclick='haltTargetIterationPlan()'>Halt</a> ";
					
					str += "<br>";
					str += "| active_plan_status = " + active_plan_status;
					str += "| current_command_index = " + command_index;
					str += "| current_command_duration = " + command_duration;
					str += "| current_state = " + current_state;
					str += "| in_transition = " + in_transition;
					str += "| transition_progress = " + transition_progress;
					str += "| time_in_state = " + time_in_state;
					str += "|";

					document.getElementById('topPane-header').innerHTML = str;
				}
				
				_updateTimer = window.setTimeout(updateIterateStatus,_UPDATE_TIMER_PERIOD);
				
				
					}, //end handler
					0, //handler param
					0,true,false, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end updateIterateStatus
		
		
		
		</script>
</head>
	

<body onload='Javascript:init();'>	
		
	<!-- body content populated by javascript paint(), etc. -->

	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
</body>
	
</html>
