<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>ConfigurationGUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<style type="text/css">			
		
		body {
			/*overflow: hidden; /* scrolling only happens in left and right panes */			
		}

		/* make buttons have a hand cursor */
		input[type="button"], button {
			cursor: pointer;
		}
		
		.pane {
			border: 0;
			position: absolute;
		}

		#topPane {
			overflow-y: auto;
			overflow-x: hidden;
		}
		
		#bottomPane {
			background-color : rgb(241, 231, 231);
			overflow: auto;

			box-shadow: 		inset rgba(255,254,255,0.6) 0 0.3em .3em,
					inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
					rgba(200, 200, 200,0.6) 0 .1em 3px,
					rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
					rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
			border-radius: 3px;	
		}
		

		/* =============== plan selector ================ */
		.recordAdd,
		.recordAdd:hover {
			text-decoration: none;
			font-size: 30px;
			font-weight: bold;
			color: rgb(15, 152, 76);
		}
		
		#recordAddDiv {
	    	margin: -2px 16px -10px 0;
			float: left;
		}
		#recordDeleteDiv {
			margin: 4px 0 0 0;
			float: left;
		}
		
		.treeNode-deleteIcon {			
			background-image: 	url(..//images/windowContentImages/ConfigurationGUI-trashCan.png);
			width: 				16px;
			height: 			20px;
			border: 			0;
			margin: 			-9px 0 -10px 10px;
		}
		.treeNode-deleteIcon:hover {
			background-image: 	url(..//images/windowContentImages/ConfigurationGUI-trashCanHover.png);
			cursor: 			pointer;
		}

		.preloadImage {			
			width: 				24px;
			height: 			20px;
			position:			absolute;
			left: 				-100px;
			top: 				0;
		}
		#preloadImage-treeEditTrashIconHover {
			background-image: 	url(..//images/windowContentImages/ConfigurationGUI-trashCanHover.png);
		}

		#planSelector {
			margin: 20px 0 0 20px;
		}
				
		#planSelectDiv {
			float: left;
			margin-right: 20px;
		}
		
		#planSelect {
			height: 30px;
			width: 210px;
		}
		/* =============== end plan selector ================ */
		
		
		
	</style>
	
	
	<script type="text/JavaScript" src="..//js/Globals.js"></script>	
	<script type="text/JavaScript" src="..//js/Debug.js"></script>	
	<script type="text/JavaScript" src="..//js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="..//js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="..//js/js_lib/ConfigurationAPI.js"></script>
	
	<script>		
	
		//Iterate desktop icon from:
		//	http://clipart-library.com/purple-spider-cliparts.html
	
		
		//	Description of Iterate Functionality/Behavior:
		//	
		//	GET parameters:
		//		<forceSavingModifiedGroups> = Do not provide user with option in command sequence to use the temporary group for modified groups
		//		<forceUseOfAliases> = Do not provide user with option in command sequence to use an arbitrary group
		//		<forceGroupsOnly> = Do not provide user with option in command sequence to use Macros
		//		
		//
		//	- Requires user to have LOCK
		//
		//	- Top Pane:
		//		* Refresh
		//		* Iteration Plan: <name> and  > || |_|  controls and "Status: Inactive"
		//		* when modified, do not show > || |_| controls.. 
		//			instead show Save and Discard Changes buttons
		//
		//	- Bottom Pane:
		//		* Similar functionality to GUI subset.. in that it edits the 
		//			the currently active Iteration group. (If a user wants to change the active
		//			Iteration group, they must do so in the Config GUI)
		//
		//		* Very top of "tree-view" choose the Iteration Plan name
		//			* Then default to
		//				- BEGIN_LABEL 0 (hide index from user - show by indent)
		//				- Configure Configuration Group/System Alias
		//				- REPEAT_LABEL 0 ( 0 times - when 0 show as END LOOP)
		//				- In GUI, show END (no representation in table)
		//					
		//		* Create Rows in table that match sequence
		//
		//		* Row Types
		//			- BEGIN_LABEL <label>
		//			- REPEAT_LABEL <label> <number of times to repeat 0-to-N>
		//				#note: must have a matching BEGIN_LABEL
		//			- CHOOSE_STATE_MACHINE <fsm name> #by default ""
		//			- CONFIGURE_ALIAS <alias name>
		//			- CONFIGURE_GROUP <group name> <group key>
		//			- MODIFY_ACTIVE_GROUP <bool:do save new group #else use temporary group> 
		//				<relative path from FE> <start value> <iteration step size>
		//				<target FE Group #which can span multiple FE-Managers> 
		//				#note: always must (so that macro things work) have a CONFIGURE_ACTIVE_GROUP after a MODIFY_ACTIVE_GROUP
		//				#	but can group modifies together and do one CONFIGURE_ACTIVE_GROUP.	
		//			- CONFIGURE_ACTIVE_GROUP
		//			- EXECUTE_MACRO <macro name> <target FE Group #which can span multiple FE-Managers>
		//				<parameter group of name, value, iteration step size to adjust in macro> 
		//				#note: must be a public macro
		//			- EXECUTE_FE_MACRO <FE macro name> <target FE Group #which can span multiple FE-Managers>
		//				<parameter group of name, value, iteration step size to adjust in inputs to FE macro>
		//			- RUN	<dump type> <bool: wait for all FEs to complete running thread else use time> 
		//				<seconds for run>		
		//
		//		
		//	- Save functionality should be same as saving tree	
		//		* If admin, could give options to target a certain system alias.. Etc.
		//		* Else assume saving to currently active groups
		//
		//
		//	- Interactions with Server
		//		* App must have access to Configuration GUI Supervisor, Gateway Supervisor,
		//				MacroMaker Supervisor (Macro Maker can run FE Macros) 
		//			-- this means primary urn to GUI Supervisor, secondary to Gateway Supervisor,
		//				and special handshaking (from Gateway Supervisor) with MacroMaker Supervisors
		//		
		//		* Requests:
		//				= from Configuration GUI Supervisor =
		//			-- Get Iteration Plan Names
		//			-- Load Iteration Plan
		//			-- Save Iteration Plan
		//
		//				= from Gateway Supervisor =
		//			-- Play/Resume Iteration Plan (implications for MacroMaker, coordinated by Gateway)
		//			-- Pause Iteration Plan
		//			-- Stop/Reset Iteration Plan
		//			-- Get Active Iteration Plan Status (status could be: inactive, running, paused)
		
		//	Gateway Server Iterator 
		//		- Iterator to manage iterating -- separate thread
		//		- Commands:
		//			- stateMachineXgiHandler/PlayIterationPlan:
		//				- if not running, launches thread (if all state machines are halted)
		//					and starts playing iteration plan.
		//			- stateMachineXgiHandler/PauseIterationPlan:
		//				- if running, pauses iteration plan.
		//			- stateMachineXgiHandler/HaltIterationPlan:
		//				- if running, halts/resets iteration plan. Lose progress. Halts FSM.
		//			- stateMachineXgiHandler/getIterationPlanStatus:
		//				- returns status (status could be: inactive, running, paused)
		//					and FSM state and isTransitioning,
		//					and which iteration plan command.
		//		
		
	
	
	
		//
		//	- Iteration Plan Configuration Tree
		//		* Iterate
		//			- records of 'Iteration Plans'
		//		|* Iteration Plans
		//			- group of 'Iteration Plan Commands' defining an 'Iteration Plan Sequence' 
		//		||* Specific Command-Type (a table for each type)
		//			- definition of parameters associated with the command type
		
		
		var _topPane, _bottomPane;
		var _updateTimer = 0;
		var _UPDATE_TIMER_PERIOD = 1000; //ms
		
		var _eventListenersCreated = false;
		
		//global vars for GET params
		var _forceSavingModifiedGroups;// = Do not provide user with option to use the temporary group for modified groups
		var _forceUseOfAliases;// = Do not provide user with option to use an arbitrary group
		var _forceGroupsOnly;//= Do not provide user with option to use Macros
		
		var _ITERATE_BASE_PATH = "IterateConfiguration";	
		var _PLAN_BASE_PATH = "IterationPlanConfiguration";	
		var _recordsAlias = "Iteration Plan";
		
		//global vars for iteration plan records
		var _planUIDs; //array of UIDs in the currently active Iterate group
		var _targetPlan = "";
				
		//global vars for saving tables
		var _modifiedTables;
		
		//global vars for editing plans
		var _configGroupAliases = []; //array of objects:{alias,name,key,groupComment,aliasComment}, only configuration groups
		var _fsmNames = [];	//array of names
		var _configGroups = []; //array of objects:{name,key,groupComment}, only configuration groups
        var _commands = [];
        
		var _COMMAND_TYPES = {};
		_COMMAND_TYPES.BEGIN_LABEL 				= "BEGIN_LABEL";
		_COMMAND_TYPES.CHOOSE_FSM 				= "CHOOSE_FSM";
		_COMMAND_TYPES.CONFIGURE_ACTIVE_GROUP 	= "CONFIGURE_ACTIVE_GROUP";
		_COMMAND_TYPES.CONFIGURE_ALIAS 			= "CONFIGURE_ALIAS";
		_COMMAND_TYPES.CONFIGURE_GROUP 			= "CONFIGURE_GROUP";
		_COMMAND_TYPES.EXECUTE_FE_MACRO 		= "EXECUTE_FE_MACRO";
		_COMMAND_TYPES.EXECUTE_MACRO 			= "EXECUTE_MACRO";
		_COMMAND_TYPES.MODIFY_ACTIVE_GROUP 		= "MODIFY_ACTIVE_GROUP";
		_COMMAND_TYPES.REPEAT_LABEL 			= "REPEAT_LABEL";
		_COMMAND_TYPES.RUN 						= "RUN";
        
        
        var _DEBUG_WOUT_SERVER = 0;
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:			
			//init()
			//paint() 
			//extractGETParameters()
			//initIterateData()
        	//		localCompleteInit()
        	//		localGetGroups()	
        	//		localGetNamesOfFSMs()
			//getIterationPlans(responseHandler)
		
			//createTopPaneContent()
			//createBottomPaneContent()
			//updateIterationPlanContent()
		
				//Plan Editing:
			//createEmptyIterateGroup()
			//getIterationPlans()
			//addIterationPlan()
			//deleteIterationPlan()
			//addCommand(type,params)
			//deleteCommand()
			//savePlanCommandSequence(plan,commands,respsonseHandler)
		
				//Plan Control:
			//startTargetIterationPlan
			//haltTargetIterationPlan
			//pauseTargetIterationPlan
			
				//Helpers:
			//saveModifiedTables(successMsg,failureMsg)        	
		
				//Display:
            //drawIterationPlan(plan)
            //  localExtractTree(tree)
            //  localDrawIterationPlan()
        	//updateIterateStatus()	
		
				//Input Handlers:
			//handleMouseOver(type,id) 
			//handleEndMouseOver() 
			//handlePlanSelect() 
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
				

		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init() 
		{									
			Debug.log("Iterate init ");
			DesktopContent.tooltip("Iterate Introduction",
					"Welcome to the Iterate GUI. Here you can create 'Iteration Plans' that can facilitate "+
					"calibrations or complex run plans. \n\n" +
					
					"For an example calibration case, you might create an Iteration Plan to step through " +
					"a register value from 0 to 50, counting by 10.\n\n" +
					
					"For an example run plan case, you might create an Iteration Plan to take 5 runs for " +
					"10 minutes each.\n\n" +
					
					"The organization of the Iterate GUI is in the form of two panes, a top and bottom.\n\n" +
					
					"Briefly, here is a description of the two panes: " +
					"<INDENT> " +
					"- <b>Top Pane</b>\n" +
					"<INDENT> The 'Top Pane' is for controlling the selected Iteration Plan. " +
					"You can Play, Pause, or Stop the Iteration Plan. Or if you make modifications " +
					"you can Save or Discard them." +
					"</INDENT>" +
					"</INDENT>" + 
					"<INDENT> " +
					"- <b>Bottom Pane</b>\n" +
					"<INDENT> The 'Bottom Pane' is for viewing and modifying the selected Iteration Plan. " +
					"</INDENT>" +
					"</INDENT>"
			);
			
			//extract get parameters
			if(!extractGETParameters())
			{
				Debug.log("Illegal GET parameters. Aborting.",
						Debug.HIGH_PRIORITY);
				return;
			}


			//get subset record uids and 
			//	calls paint() and adds resize listener when done
			initIterateData();
						
		} //end init()
		
		//=====================================================================================
		//paint ~~
		//	positiong left and right panes based on window size
		function paint() 
		{	
			var w = DesktopContent.getWindowWidth();
			var h = DesktopContent.getWindowHeight();
			//Debug.log("paint w,h=" + w + "," +h);

			var MIN_H = 280;
			var MIN_W = 580;
			if(w < MIN_W)
				w = MIN_W;
			if(h < MIN_H)
				h = MIN_H;
			
			Debug.log("paint w,h=" + w + "," +h);

			var TOP_H = 85;//56;
			var BORDER_SZ = 0;			
			var MARGIN = 5;
			
			if(!_bottomPane && !_topPane)
			{
				//first time create elements
				createTopPaneContent();
				createBottomPaneContent();
				
				updateIterationPlanContent();
			}

			
			var y = MARGIN;
			var x = MARGIN;
			w -= 2*MARGIN;
			h -= 2*MARGIN;
			
			_topPane.style.left = x + "px";
			_topPane.style.top = y + "px";
			_topPane.style.width = (w - 2*BORDER_SZ) + "px";
			_topPane.style.height = (TOP_H - 2*BORDER_SZ) + "px";
			
			y += TOP_H + MARGIN;
			h -= TOP_H + MARGIN;

			//set bottom pane sizes
			h -= 2*BORDER_SZ + MARGIN;
			
			_bottomPane.style.left = x + "px";
			_bottomPane.style.top = y + "px";
			_bottomPane.style.width = w + "px";
			_bottomPane.style.height = h + "px";
						
		}	//end paint()

		//=====================================================================================
		//updateIterationPlanContent ~~
		function updateIterationPlanContent() 
		{	
			var el = document.getElementById("planSelector");
			if(!el) {Debug.log("Error: updateIterationPlanContent null"); return; } 
			
			var optionIndex = -1;
			
			str = "";

			str += "<div id='planSelectDiv'>";
			str += "<b>Choose an Iteration Plan: </b>";
			if(_planUIDs.length == 0)
			{
				str += "No plans found. Create one here ==> ";
			}
			else
			{
				str += "<select id='planSelect' onchange='handlePlanSelect();'>";
				for(var i=0;i<_planUIDs.length;++i)
				{
					str += "<option value='" + i + "'>";
					str += _planUIDs[i];	//can display however
					str += "</option>";
					
					if(_planUIDs[i] == _targetPlan)
						optionIndex = i;
				}
				str += "</select>";
			}
			str += "</div>"; //end planSelectDiv

			str += "<div id='recordAddDiv' ";
			if(_planUIDs.length == 0)
				str += "style='margin: -4px 16px -10px 0;' ";
			else 
				str += "style='margin: -2px 16px -10px 0;' ";
			str += "'>";			
			str += "<a class='recordAdd' onclick='addIterationPlan(); return false;' ";			
			str += "title='Create a new " + _recordsAlias + ".'" +
					">";
			str += "+";
			str += "</a>";
			str += "</div>";

			str += "<div id='recordDeleteDiv' class='treeNode-deleteIcon' ";
			if(_planUIDs.length == 0) str += "style='display:none' ";
			str += "onclick='deleteIterationPlan(); return false;' " +
					"title='Delete the selected " + _recordsAlias + ".'" +					
					">";
			str += "</div>";

			el.innerHTML = str;
			
			//if no target plan and plans exist, load the first one
			if(_targetPlan == "")
			{
				if(_planUIDs.length)
					drawIterationPlan(_planUIDs[0]);
				else
					drawIterationPlan();					
			}
			else
			{
				var sel = document.getElementById("planSelect");				

				if(optionIndex >= 0)
				{
					sel.selectedIndex = optionIndex;
					sel.focus();
				}
				
				drawIterationPlan(_targetPlan);
			}
			
		} //end updateIterationPlanContent()
		

		//=====================================================================================
		//drawIterationPlan ~~
        //  if plan then request commands from server, otherwise use current _targetPlan and
        //      existing _commands.
		function drawIterationPlan(plan) 
		{
			if(plan !== undefined)
            {
				_targetPlan = plan;
                
				if(!_DEBUG_WOUT_SERVER)
                ConfigurationAPI.getTree(_ITERATE_BASE_PATH + "/" + plan,
                                         4, //down through command parameters
										 _modifiedTables,
                                         localExtractTree
                                         );
            }
			else
				plan = _targetPlan;
			
			Debug.log("drawIterationPlan " + plan);
			
			//load plan and display detail
			//	get command sequence
			
            if(_DEBUG_WOUT_SERVER)
            {
                //by pass server request and fake data
                var children = document.createElement("div");
                var commands = [];
                commands.push({ 	//BEGIN_LABEL
                "type" : _COMMAND_TYPES.BEGIN_LABEL,
                "param" : {"Label":"Main"},
                });
                commands.push({ 	//CHOOSE_FSM
                "type" : _COMMAND_TYPES.CHOOSE_FSM,
                "param" : {"NameOfStateMachine":(_fsmNames.length? //use first name, if any exist
                		_fsmNames[0]
                        :"")},
                });
                commands.push({		//CONFIGURE_ALIAS aliasMap[0]
                "type" : _COMMAND_TYPES.CONFIGURE_ALIAS,
                "param" : {"SystemAlias":(_configGroupAliases.length? //use first alias, if any exist
                		_configGroupAliases[0].alias
						:"")},
                });
                commands.push({		//RUN 5 minutes
                "type" : _COMMAND_TYPES.RUN,
                "param" : {"DurationInSeconds": 5*60},
                });
                commands.push({ 	//REPEAT_LABEL
                "type" : _COMMAND_TYPES.REPEAT_LABEL,
                "param" : {"Label":"Main", "NumberOfRepetitions":0},
                });
                
                _commands = commands;
                
                localDrawIterationPlan();
                return;
            }
            else
                localDrawIterationPlan();
            	
            
            
            //::::::::::::::::::::::::::::::::::::
            //localExtractTree ~
            //	extract tree into the _commands object
            function localExtractTree(tree)
            {
                if(!tree && !_DEBUG_WOUT_SERVER)
                {
                    Debug.log("Invalid tree xml object.");
                    return;
                }
                
                _commands = []; //clear
                
                var nodes = tree.children;
                var nodeChildren;
                var commandChildren;
                var commandFieldsChildren;
                var parameterChildren;
                var countCommands = 0;
                
                var type,params; //to make command
                
                //for each plan field
                //	find link to command group
                //		for each command
                //			fill command type
                //			find link to parameters
                //				fill parameters
                for(var i=0;i<nodes.length;++i)
                {                    
                    nodeChildren = nodes[i].children;
                    
                    if(nodeChildren[0].nodeName != "value")    //asssume this is group link to commands
                    {
                        for(var j=0;j<nodeChildren.length;++j)
                        {
                            if(nodeChildren[j].nodeName == "node")
                            {
                                //found child node -- command UID level                            	
                            	commandChildren = nodeChildren[j].children;

                                for(var k=0;k<commandChildren.length;++k)
                                {   	
                                    if(commandChildren[k].nodeName == "node")
                                    {
                                    	//found child node -- command field
                                    	if(commandChildren[k].getAttribute("value") == "CommandType")
                                    	{
                                    		type = commandChildren[k].children[0].getAttribute("value");
                                    		params = [];
                                    	}
                                    	else if(commandChildren[k].getAttribute("value") == "LinkToCommandConfiguration")
                                    	{
                                    		parameterChildren = commandChildren[k].children;

                                            for(var l=0;l<parameterChildren.length;++l)
                                            {   	
                                                if(parameterChildren[l].nodeName == "node")
                                                {
                                                	//found child node -- parameter field
                                                	// take as parameter until the comment field is reached
                                                	
                                                	if(parameterChildren[l].getAttribute("value") == "CommentDescription")
                                                		break;
                                                	
                                                	Debug.log("parameter name = " + parameterChildren[l].getAttribute("value"));
                                                	                                                	
                                                	params.push(parameterChildren[l].children[0].getAttribute("value"));
                                                	
                                                	Debug.log("parameter value = " + params[params.length-1]);                                                	
                                                }
                                            }
                                    	}
                                    }

                                }

                                //at this point, have command type and params
                                console.log(type);	
                                console.log(params); 
                                addCommand(type,params);
                            }
                        }
                        
                        Debug.log("countCommands = " + _commands.length);
                    }
                    
                    /*
                    str += "<b>" + nodes[i].getAttribute("value") + ":</b> ";
                    
                    //ConfigurationAPI.getDateString(date)
                    nodeChildren = nodes[i].children;
                    if(nodeChildren[0].nodeName == "value") //value node
                    str += nodeChildren[0].getAttribute("value");
                    else //asssume group link to commands
                    {
                        for(var j=0;j<nodeChildren.length;++j)
                        {
                            if(nodeChildren[j].nodeName == "node")
                            {
                                //found child node
                                
                                str += "<br>";
                                str += "<b>" + nodes[i].getAttribute("value") + "/" +
                                nodeChildren[j].getAttribute("value") + "</b>";
                                ++countCommands;
                            }
                        }
                        
                        Debug.log("countCommands = " + countCommands);
                        
                        str += "<br>";
                        str += "Number of Commands = " + countCommands;
                    }
                    str += "<br>";*/
                }
                
                localDrawIterationPlan();
                
            } // end localExtractTree()
            
            //::::::::::::::::::::::::::::::::::::
            //draw based on _commands
            function localDrawIterationPlan()
            {
                if(!_commands)
                {
                    Debug.log("Invalid commands object.");
                    return;
                }
                
                var el = document.getElementById("planDetail");
                if(!el) {Debug.log("Error: updateIterationPlanContent null"); return; }
                
                el.innerHTML = ""; //clear
                
                if(!plan || plan == "")
                	return;
                 
                var str = "";
                
                //Display Concept:
                //  Plan name at top left
                //      Blue vertical bar extending down inset off left edge of name
                //      Each Loop
                //          New vertical bar extending down inset off BEGIN_LABEL command
                
                
                
                str += "Plan: " + plan;
                str += "<br>";str += "<br>";
                
                var commands = _commands;
                var depth = 0;
                var paramKeys;
                
                //make first vertical bar
                str += "<div id='clearDiv'></div>";
                str += "<div class='depthBar' id='depthBar-" + depth + "'>";
                
                for(var i=0;i<commands.length;++i)
                {
                    str += "<div id='clearDiv'></div>";
                    
                    str += "<div class='command' id='command-" + i + "'>";
                    
                    str += "<b>" + commands[i].type + ":</b> ";
                    
                    //show properties
                    paramKeys = Object.keys(commands[i].param);

                    for(var j=0;j<paramKeys.length;++j)
                    	str += " " + paramKeys[j] + "=" + 
							commands[i].param[paramKeys[j]];
                                        
                    
                    //ConfigurationAPI.getDateString(date)
                                        
                    str += "<br>";
                }
                
                el.innerHTML = str;
                              
                
            } //end localDrawIterationPlan()
			
			
		} //end drawIterationPlan()
		
		//=====================================================================================
		//extractGETParameters ~~
		//	return false, if illegal params
		function extractGETParameters() 
		{
			//extract get parameters
			
			_forceSavingModifiedGroups	= DesktopContent.getParameter(0,"forceSavingModifiedGroups");			
			_forceUseOfAliases		 	= DesktopContent.getParameter(0,"forceUseOfAliases");			
			_forceGroupsOnly			= DesktopContent.getParameter(0,"forceGroupsOnly");			
			
			//setup defaults
			if(_forceSavingModifiedGroups === undefined) 	_forceSavingModifiedGroups = false;
			if(_forceUseOfAliases === undefined) 			_forceUseOfAliases = false;
			if(_forceGroupsOnly === undefined) 				_forceGroupsOnly = false;
			
			Debug.log("_forceSavingModifiedGroups " + _forceSavingModifiedGroups);
			Debug.log("_forceUseOfAliases " + _forceUseOfAliases);
			Debug.log("_forceGroupsOnly " + _forceGroupsOnly);
			
			return true;
		}	//end extractGETParameters()
		
		//=====================================================================================
		//initIterateData ~~
		//	fills _planUIDs
		//		array of UIDs defined by the subset (based on _subsetBasePath and _recordPreFilterList)
		//	fills _filterValsObj
		//		for each filter MultiSelect (one for each grouping field), an array of filter values
		function initIterateData() 
		{
			window.clearTimeout(_updateTimer);
					
			//get list of records that match <subsetBasePath> AND <recordPreFilterList>
			_planUIDs = []; //reset
			_filterValsObj = {}; //reset
			_fields = undefined; //reset
			_modifiedTables = undefined; //reset
            
            _targetPlan = ""; //reset
            _commands = []; //reset
			

			if(_bottomPane && _topPane)
			{
				_topPane.innerHTML = ""; //clear
				_bottomPane.innerHTML = ""; //clear
				_topPane.parentNode.removeChild(_topPane); //remove element
				_bottomPane.parentNode.removeChild(_bottomPane); //remove element
				
			}
			_topPane = undefined; //reset
			_bottomPane = undefined; //reset
            
            
            if(_DEBUG_WOUT_SERVER)
            {
                //bypass server and give example iterate plan
                
                _planUIDs = ["test 1", "testB"];
                
                localCompleteInit();
                return;
            }

						
			ConfigurationAPI.getActiveGroups(
					function(groups)
					{
				if(!groups || !groups.Iterate || 
						groups.Iterate.groupKey === undefined ||
						(groups.Iterate.groupKey|0) == -1)
				{
					Debug.log("No active Iterate group.");
					
					//create an empty active group
					createEmptyIterateGroup(
							function(params)
							{
						if(params === undefined)
						{
							Debug.log("Creation of empty Iterate Group failed. Giving up. Call a system admin.",
									Debug.HIGH_PRIORITY);
							return;
						}
						getIterationPlans(localCompleteInit);
							});
					return;
				}
				
				Debug.log("Active Iterate group is " +
						groups.Iterate.groupName + " (" +
						groups.Iterate.groupKey + ").");

				getIterationPlans(localCompleteInit);
				

					}); //end getActiveGroups handler

			//::::::::::::::::::::::::::::::::::::
			function localCompleteInit()
			{
				Debug.log("localCompleteInit -- Wrapping up init.");
				paint();
				if(!_eventListenersCreated)
				{
					window.addEventListener("resize",paint);
					_eventListenersCreated = true; //prevent multiple event creation
				}	
				
				updateIterateStatus();
			} //end localCompleteInit()

						

			//::::::::::::::::::::::::::::::::::::
			//localGetGroups ~
			//	get groups and aliases
			function localGetGroups() 
			{
				Debug.log("localGetGroups");
				DesktopContent.XMLHttpRequest("Request?RequestType=getGroupAliases" + 
						"", //end get data 
						"", //end post data
						function(req)
						{
	
					Debug.log("getGroupAliases handler");
	
					var groupAliases = req.responseXML.getElementsByTagName("GroupAlias");
					var groupNames = req.responseXML.getElementsByTagName("GroupName");
					var groupKeys = req.responseXML.getElementsByTagName("GroupKey");
					var groupComments = req.responseXML.getElementsByTagName("GroupComment");
					var groupTypes = req.responseXML.getElementsByTagName("GroupType");
					var aliasComments = req.responseXML.getElementsByTagName("AliasComment");
	
					_configGroupAliases = [];
					for(var i=0;i<groupAliases.length;++i) 
						if(groupTypes[i].getAttribute('value') == "Configuration")
							_configGroupAliases.push({
									"alias" : groupAliases[i].getAttribute('value'),
									"name" : groupNames[i].getAttribute('value'),
									"key" : groupKeys[i].getAttribute('value'),
									"groupComment" : groupComments[i].getAttribute('value'),
									"aliasComment" : aliasComments[i].getAttribute('value')
						});
	
					console.log("_configGroupAliases",_configGroupAliases);
	
	
						}, //handler
						0, //handler param
						0,false,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
						false /*targetSupervisor*/);
				
				
				DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurationGroups"
						+"&doNotReturnMembers=1", //end get data 
						"", //end post data
						function(req)
						{
					Debug.log("getConfigurationGroups handler");
					
					var groupNames = req.responseXML.getElementsByTagName("ConfigurationGroupName");
					var groupKeys = req.responseXML.getElementsByTagName("ConfigurationGroupKey");
					var groupTypes = req.responseXML.getElementsByTagName("ConfigurationGroupType");
					var groupComments = req.responseXML.getElementsByTagName("ConfigurationGroupComment");
					
					_configGroups = [];
					for(var i=0;i<groupNames.length;++i) 
						if(groupTypes[i].getAttribute('value') == "Configuration")
							_configGroups.push({								
									"name" : groupNames[i].getAttribute('value'),
									"key" : groupKeys[i].getAttribute('value'),
									"groupComment" : groupComments[i].getAttribute('value')
						});
					
					console.log("_configGroups",_configGroups);
					
						}, //handler
						0, //handler param
						0,false,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
						false /*targetSupervisor*/);
			} //end localGetGroups()
			localGetGroups();
			
			
			//::::::::::::::::::::::::::::::::::::
			//localGetNamesOfFSMs ~
			//	get groups and aliases
			function localGetNamesOfFSMs() 
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=getStateMachineNames" + 
						"", //end get data 
						"", //end post data
						function(req)
						{

					Debug.log("getStateMachineNames handler");

					var names = req.responseXML.getElementsByTagName("stateMachineName");

					_fsmNames = [];
					for(var i=0;i<names.length;++i) 
						_fsmNames.push(names[i].getAttribute('value'))

					console.log("_fsmNames",_fsmNames);

						}, //handler
						0, //handler param
						0,false,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
						true /*targetSupervisor*/);
			} //end localGetNamesOfFSMs()
			localGetNamesOfFSMs(); 
			
			
		}	//end initIterateData()

		//=====================================================================================
		//createEmptyIterateGroup ~~
		function createEmptyIterateGroup(responseHandler) 
		{
			Debug.log("createEmptyIterateGroup");
			
			//create a group with each table in group key -1 (to use empty mockup table)
			//  on failure, give up and assume there are existing groups that admin could activate
					
			ConfigurationAPI.getGroupTypeMemberNames("Iterate",
					function(members)
					{
				Debug.log("getGroupTypeMemberNames handler");				
				var configMapStr = "configList=";
				for(var i=0;i<members.length;++i)
					configMapStr += members[i] + ",-1,";
				ConfigurationAPI.saveGroupAndActivate(
						"iterateDefaultGroup",
						configMapStr,
						responseHandler, //pass handler to be called
						true /*doReturnParams*/						
						)			
					}); // end getGroupTypeMemberNames handler
	

		}	//end createEmptyIterateGroup()
		
		//=====================================================================================
		//getIterationPlans ~~
		function getIterationPlans(responseHandler) 
		{
			Debug.log("getIterationPlans");
			
			//get existing iteration plans
			ConfigurationAPI.getSubsetRecords(
					_ITERATE_BASE_PATH,
					"",
					function(records)
					{
				_planUIDs = records;
				Debug.log("iteration plans found = " + records.length);
				console.log(records);

				if(responseHandler) responseHandler();
				
					});	//end getSubsetRecords handler	
			
		}	//end getIterationPlans()	
		
		//=====================================================================================
		//createTopPaneContent ~~
		function createTopPaneContent() 
		{
			_topPane = document.createElement("div");
			_topPane.setAttribute("class", "pane");
			_topPane.setAttribute("id", "topPane");			
			
			var el;
			var str;
			
			el = document.createElement("div");
			str = "";
			str += "<a href='#' onclick='initIterateData()'>Refresh</a>";
			el.innerHTML = str;
			_topPane.appendChild(el);			

			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_topPane.appendChild(el);
			
			el = document.createElement("div");
			el.setAttribute("id", "topPane-header");
			_topPane.appendChild(el);			
			
			document.body.appendChild(_topPane);			
		}	//end createTopPaneContent()
		
		//=====================================================================================
		//createBottomPaneContent ~~
		function createBottomPaneContent(leftW) 
		{
			_bottomPane = document.createElement("div");
			_bottomPane.setAttribute("class", "pane");
			_bottomPane.setAttribute("id", "bottomPane");
			

			//	- Bottom Pane:
			//		* Similar functionality to GUI subset.. in that it edits the 
			//			the currently active Iteration group. (If a user wants to change the active
			//			Iteration group, they must do so in the Config GUI)
			//
			//		* Very top of "tree-view" choose the Iteration Plan name
			//			* Then default to
			//				- START LOOP 0 (hide index from user - show by indent)
			//				- Configure Configuration Group/System Alias
			//				- REPEAT LOOP 0 ( 0 times - when 0 show as END LOOP)
			//				- In GUI, show END (no representation in table)
			//					
			//		* Create Rows in table that match sequence
			
			var el;
			var str;
						
						
						
			//create target plan selector div: dropdown with + / TRASH
			el = document.createElement("div");
			el.setAttribute("id", "planSelector");			
			_bottomPane.appendChild(el);	
			
			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_bottomPane.appendChild(el);
			
			//create plan detail div
			el = document.createElement("div");
			el.setAttribute("id", "planDetail");			
			_bottomPane.appendChild(el);	

			el = document.createElement("div");
			el.setAttribute("id", "clearDiv");
			_bottomPane.appendChild(el);		
						
			document.body.appendChild(_bottomPane);
						
		}	//end createBottomPaneContent()


		//=====================================================================================
		//addIterationPlan ~~
		function addIterationPlan()
		{
			Debug.log("addIterationPlan");
			
			var newRowUID = prompt("Please enter a name for the new " + 
					_recordsAlias + ":");
			if(newRowUID)
				newRowUID = newRowUID.trim();
			else //prompt was cancelled
				return;


			localCreateIterationPlan();
			return;
			
			//::::::::::::::::::::::::::::::::::::::::::
			//localCreateIterationPlan ~
			function localCreateIterationPlan()
			{
				//new default iteration plan 

				//steps:
				//	create new record
				//	edit record (status=On, groupLinkId=uid + "plan)
				//	save
				//	refresh

				/////////////////////
				ConfigurationAPI.addSubsetRecords(_ITERATE_BASE_PATH,newRowUID,
						/////////////////////
						function(modifiedTables) //start addSubsetRecords handler
						{
					Debug.log("modifiedTables length " + modifiedTables.length);

					if(!modifiedTables.length)
					{
						Debug.log("There was an error while creating the " + _recordsAlias + " '" + 
								newRowUID  + ".'",
								Debug.HIGH_PRIORITY);
						return;					
					}

					_modifiedTables = modifiedTables;

					var fieldArr = ["Status",
									"LinkToIterationPlanConfiguration",
									"LinkToIterationPlanGroupID",
									"CommentDescription"
									];

					var valueArr = ["1",//"Status",
									_PLAN_BASE_PATH,//"LinkToIterationPlanConfiguration",
									newRowUID+"-Plan",//"LinkToIterationPlanGroupID",
									"Generated by Iterate app"//"CommentDescription"
									];

					/////////////////////
					ConfigurationAPI.setFieldValuesForRecords(
							_ITERATE_BASE_PATH,
							[newRowUID], 	//recordArr
							fieldArr, 	//fieldArr
							valueArr, 	//valueArr
							/////////////////////
							function(modifiedTables) //start setFieldValuesForRecords
							{
						Debug.log("modifiedTables length " + modifiedTables.length);

						if(!modifiedTables.length)
						{
							Debug.log("There was an error while creating the " + _recordsAlias + " '" + 
									newRowUID  + ".'",
									Debug.HIGH_PRIORITY);
							return;					
						}

						_modifiedTables = modifiedTables;

						//create DEFAULT commands:
						//	BEGIN_LABEL						
						//	CONFIGURE_ALIAS aliasMap[0]
						//	RUN 5 minutes
						// 	REPEAT_LABEL
						
						var commands = [];
						commands.push({ 	//BEGIN_LABEL
							"type" : _COMMAND_TYPES.BEGIN_LABEL,
							"param" : {"Label":"Main"},							
						});
						commands.push({		//CONFIGURE_ALIAS aliasMap[0]
							"type" : _COMMAND_TYPES.CHOOSE_FSM,
							"param" : {"NameOfStateMachine":(_fsmNames.length? //use first name, if any exist
									_fsmNames[0]
									:"")},							
						});
						commands.push({		//CONFIGURE_ALIAS aliasMap[0]
							"type" : _COMMAND_TYPES.CONFIGURE_ALIAS,
							"param" : {"SystemAlias":(_configGroupAliases.length? //use first alias, if any exist
									_configGroupAliases[0].alias
									:"")},							
						});
						commands.push({		//RUN 5 minutes
							"type" : _COMMAND_TYPES.RUN,
							"param" : {"WaitForAllFrontEndsRunningThread":0,
								"DurationInSeconds": 5*60,
								"ConfigurationDumpType":"All"},							
						});
						commands.push({ 	//REPEAT_LABEL
							"type" : _COMMAND_TYPES.REPEAT_LABEL,
							"param" : {"Label":"Main", "NumberOfRepetitions" : 0},							
						});
						
						savePlanCommandSequence(newRowUID,commands,
								/////////////////////
								function()
								{
							//only arrive here on success
							
							_targetPlan = newRowUID;														
							
							saveModifiedTables(									
									"The new " +
									_recordsAlias + " '" + 
									newRowUID +
									"' was successfully created!",

									"There was an error while creating the " + _recordsAlias + " '" + 
									newRowUID  + ".'");
							
								}); //end savePlanCommandSequence handler
						
							}, //end setFieldValuesForRecords handler
							_modifiedTables);
					
						}, //end addSubsetRecords handler
						_modifiedTables);
					
			} //end localCreateIterationPlan()
			
			
		}	//end addIterationPlan()

		//=====================================================================================
		//saveModifiedTables ~~
		//	parameter newRowUID is just used for success/error messages
		//	e.g. actionWord = "the creation"
		function saveModifiedTables(successMsg,failureMsg)
		{
			//proceed to save (quietly) tables, groups, aliases
			ConfigurationAPI.saveModifiedTables(_modifiedTables,
					/////////////////////
					function(savedTables, savedGroups, savedAliases)
					{
				if(!savedTables.length)
				{
					Debug.log(failureMsg,
							Debug.HIGH_PRIORITY);
					return;					
				}

				Debug.log(successMsg, Debug.INFO_PRIORITY);

				_modifiedTables = undefined; //clear after save

				getIterationPlans(updateIterationPlanContent); //updates plans display

					}); //end saveModifiedTables handler
			
		} 	//end saveModifiedTables()
		
		//=====================================================================================
		//deleteIterationPlan ~~		
		function deleteIterationPlan()
		{	
			var uid = document.getElementById("planSelect").value;
			uid = _planUIDs[uid];
			
			Debug.log("deleteIterationPlan " + uid);

			if(_targetPlan == uid)
				_targetPlan = ""; //clear target plan if being deleted
			
			DesktopContent.popUpVerification( 
					"Are you sure you want to delete the iteration plan named '" +
					uid, localHandleDeleteIterationPlan,
					0,"#efeaea",0,"#770000");
			return;
						

			/////////////////////
			//localHandleDeleteIterationPlan ~~
			function localHandleDeleteIterationPlan()
			{

				//Steps:
				//	delete plan
				//	delete command sequence

				/////////////////////
				//addSubsetRecords opposite is deleteSubsetRecords
				ConfigurationAPI.deleteSubsetRecords(_ITERATE_BASE_PATH,uid,
						/////////////////////
						function(modifiedTables) //start deleteSubsetRecords handler
						{
					Debug.log("modifiedTables length " + modifiedTables.length);

					if(!modifiedTables.length)
					{
						Debug.log("There was an error while deleted the " + _recordsAlias + " '" + 
								uid  + ".'",
								Debug.HIGH_PRIORITY);
						return;					
					}

					_modifiedTables = modifiedTables;

					//delete command sequence
					//	by saving empty sequence	
					savePlanCommandSequence(uid,[],
							function()
							{
						Debug.log("Done deleting command sequence.");

						//only arrive here on success
						saveModifiedTables(
								"The " +
								_recordsAlias + " '" + 
								uid +
								"' was successfully deleted!",

								"There was an error while deleting the " + _recordsAlias + " '" + 
								uid  + ".'");

							});

						}, //end deleteSubsetRecords handler
						_modifiedTables);


			} //end localHandleDeleteIterationPlan
			
			
			
			
		}	//end deleteIterationPlan()

		//=====================================================================================
		//addCommand ~~
		//	push to _commands object
		function addCommand(type,params)
		{
			Debug.log("addCommand type = " + type);
			
			if(type == _COMMAND_TYPES.BEGIN_LABEL)
			{
				_commands.push({
					"param": {
						"Label":params[0]},
				});
			}
			else if(type == _COMMAND_TYPES.CHOOSE_FSM)
			{
				_commands.push({
					"param": {
						"NameOfStateMachine":params[0]},		
				});
			}
			else if(type == _COMMAND_TYPES.CONFIGURE_ACTIVE_GROUP)
			{
				_commands.push({
					"param": {},
				});
			}
			else if(type == _COMMAND_TYPES.CONFIGURE_ALIAS)
			{
				_commands.push({
					"param": {
						"SystemAlias":params[0]},
				});
			}
			else if(type == _COMMAND_TYPES.CONFIGURE_GROUP)
			{
				_commands.push({
					"param": {
						"GroupName":params[0], 
						"GroupKey":params[1]},
				});
			}
			else if(type == _COMMAND_TYPES.EXECUTE_FE_MACRO)
			{
				_commands.push({
					"param": {
						"LinkToTargetFrontEnds":params[0], 
						"LinkToTargetFrontEndsGroupID":params[1],
						"FEMacroName":params[2],
						"LinkToFEMacroParameterGroup":params[3],
						"LinkToFEMacroParameterGroupID":params[4]
					},
				});
			}
			else if(type == _COMMAND_TYPES.EXECUTE_MACRO)
			{
				_commands.push({
					"param": {
						"LinkToTargetFrontEnds":params[0], 
						"LinkToTargetFrontEndsGroupID":params[1],
						"MacroName":params[2],
						"LinkToMacroParameterGroup":params[3],
						"LinkToMacroParameterGroupID":params[4]
					},
				});
			}
			else if(type == _COMMAND_TYPES.MODIFY_ACTIVE_GROUP)
			{
				_commands.push({
					"param": {
						"DoTrackGroupChanges":params[0], 
						"LinkToTargetFrontEnds":params[1],
						"LinkToTargetFrontEndsGroupID":params[2],
						"RelativePathToField":params[3],
						"FieldStartValue":params[4],
						"FieldIterationStepSize":params[5]
					},
				});
			}
			else if(type == _COMMAND_TYPES.REPEAT_LABEL)
			{
				_commands.push({
					"param": {
						"Label":params[0], 
						"NumberOfRepetitions":params[1]},
				});
			}
			else if(type == _COMMAND_TYPES.RUN)
			{
				_commands.push({
					"param": {
						"WaitForAllFrontEndsRunningThread":params[0], 
						"DurationInSeconds":params[1],
						"ConfigurationDumpType":params[2]
					},
				});
			}
			else
			{
				Debug.log("Fatal error. Unknown command attempted!", Debug.HIGH_PRIORITY);
				return;
			}
			
			_commands[_commands.length-1].type = type;
			
		}	//end addCommand()

		//=====================================================================================
		//deleteCommand ~~
		//	TODO
		function deleteCommand()
		{
			Debug.log("deleteCommand");
		}	//end deleteCommand()

		//=====================================================================================
		//savePlanCommandSequence ~~
		function savePlanCommandSequence(plan,commands,responseHandler)
		{
			Debug.log("savePlanCommandSequence");
			
			plan = encodeURIComponent(plan);
			
			//; separated commands and comma separated params
			var cmdStr = "";
			var pkeys;
			for(var i=0;i<commands.length;++i)
			{
				cmdStr += "type," + encodeURIComponent(commands[i].type);
				pkeys = Object.keys(commands[i].param);

				for(var j=0;j<pkeys.length;++j)
					cmdStr += "," + pkeys[j] + "," +
						encodeURIComponent(commands[i].param[pkeys[j]]);

				cmdStr += ";"; //end command
			}
			Debug.log("cmdStr = " + cmdStr);	
			
			var modifiedTablesListStr = "";
			for(var i=0;_modifiedTables && i<_modifiedTables.length;++i)
			{
				if(i) modifiedTablesListStr += ",";
				modifiedTablesListStr += _modifiedTables[i].tableName + "," +
						_modifiedTables[i].tableVersion;
			}
			
			DesktopContent.XMLHttpRequest("Request?RequestType=savePlanCommandSequence" +
					"&planName=" + plan, //end get data 
					"commands=" + cmdStr +
					"&modifiedTables=" + modifiedTablesListStr, //end post data
					function(req)
					{

				Debug.log("savePlanCommandSequence handler");

				_modifiedTables = [];
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					responseHandler();
					return;
				}

				//console.log(req);

				//modifiedTables
				var tableNames = req.responseXML.getElementsByTagName("NewActiveTableName");
				var tableVersions = req.responseXML.getElementsByTagName("NewActiveTableVersion");
				var tableComments = req.responseXML.getElementsByTagName("NewActiveTableComment");
				var tableVersion;

				//add only temporary version
				for(var i=0;i<tableNames.length;++i)
				{
					tableVersion = DesktopContent.getXMLValue(tableVersions[i])|0; //force integer
					if(tableVersion >= -1) continue; //skip unless temporary
					var obj = {};
					obj.tableName = DesktopContent.getXMLValue(tableNames[i]);
					obj.tableVersion = DesktopContent.getXMLValue(tableVersions[i]);
					obj.tableComment = DesktopContent.getXMLValue(tableComments[i]);
					_modifiedTables.push(obj);
				}
				console.log("_modifiedTables",_modifiedTables);
				responseHandler();

					}, //handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					false /*targetSupervisor*/);
			
		}	//end savePlanCommandSequence()
		
		//=====================================================================================
		//handleMouseOver ~~
		//	based on type and id, handle what should happen during mouseover
		//	
		//	e.g.:
		//		* when over iteration plan, show author, time, etc.
		//		* when over a command, show edit icon and any parameters
		//		* when between commands, show add command icon
		function handleMouseOver(type,id)
		{
			Debug.log("handleMouseOver type=" + type + " id=" + id);
		} // end handleMouseOver()

		//=====================================================================================
		//handleEndMouseOver ~~
		// end mouse over visible things
		function handleEndMouseOver()
		{
			Debug.log("handleEndMouseOver");
		}	//end handleEndMouseOver()
		
		//=====================================================================================
		//handlePlanSelect ~~
		function handlePlanSelect()
		{
			Debug.log("handlePlanSelect");
			
			var sel = document.getElementById("planSelect");

			Debug.log("Selected plan: " + sel.value + " " + _planUIDs[sel.value|0]);
			
			drawIterationPlan(_planUIDs[sel.value|0]);
			
		}	//end handlePlanSelect()
		
		
		//=====================================================================================
		//startTargetIterationPlan ~~
		function startTargetIterationPlan() 
		{
			Debug.log("startTargetIterationPlan " + _targetPlan);

			DesktopContent.XMLHttpRequest("StateMachineXgiHandler?" + 
					"&StateMachine=iteratePlay" +
					"&fsmWindowName=" + encodeURIComponent(_targetPlan), //end get data 
					"", //end post data
					function(req) //start handler
					{
				Debug.log("startTargetIterationPlan handler ");
					}, //end handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end startTargetIterationPlan
		
		//=====================================================================================
		//pauseTargetIterationPlan ~~
		function pauseTargetIterationPlan() 
		{
			Debug.log("pauseTargetIterationPlan " + _targetPlan);

			DesktopContent.XMLHttpRequest("StateMachineXgiHandler?" + 
					"&StateMachine=iteratePause", //end get data 
					"", //end post data
					function(req) //start handler
					{
				Debug.log("pauseTargetIterationPlan handler ");
					}, //end handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end pauseTargetIterationPlan
		
		//=====================================================================================
		//haltTargetIterationPlan ~~
		function haltTargetIterationPlan() 
		{
			Debug.log("haltTargetIterationPlan " + _targetPlan);

			DesktopContent.XMLHttpRequest("StateMachineXgiHandler?" + 
					"&StateMachine=iterateHalt", //end get data 
					"", //end post data
					function(req) //start handler
					{
				Debug.log("haltTargetIterationPlan handler ");
					}, //end handler
					0, //handler param
					0,0,true, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end haltTargetIterationPlan

		//=====================================================================================
		//updateIterateStatus ~~
		function updateIterateStatus() 
		{
			//Debug.log("updateIterateStatus");

			DesktopContent.XMLHttpRequest("StateMachineXgiHandler?" + 
					"&StateMachine=getIterationPlanStatus", //end get data 
					"", //end post data
					function(req,ignoreParam,errStr) //start handler
					{
				
				if(errStr)
				{
					Debug.log("getIterationPlanStatus ERROR handler ");
					let str = "";
					str += "Disconnected. Click Refresh to attempt to reconnect.";
					document.getElementById('topPane-header').innerHTML = str;
					return;
				} //end error case handler
				
				//Debug.log("getIterationPlanStatus handler ");
				

				var current_state 		= DesktopContent.getXMLValue(req,"current_state");
				var in_transition 		= DesktopContent.getXMLValue(req,"in_transition");
				var transition_progress = DesktopContent.getXMLValue(req,"transition_progress");
				var time_in_state 		= DesktopContent.getXMLValue(req,"time_in_state");
				
				var command_duration 	= DesktopContent.getXMLValue(req,"current_command_duration");
				var command_index		= DesktopContent.getXMLValue(req,"current_command_index");
				var active_plan_status	= DesktopContent.getXMLValue(req,"active_plan_status");
				var active_plan			= DesktopContent.getXMLValue(req,"active_plan");
				var last_started_plan	= DesktopContent.getXMLValue(req,"last_started_plan");
				var last_finished_plan	= DesktopContent.getXMLValue(req,"last_finished_plan");
				
				// "Running""Paused""Inactive"
				//Debug.log("_targetPlan = " + _targetPlan);
				//Debug.log("active_plan = " + active_plan);
				//Debug.log("active_plan_status = " + active_plan_status);
				
				
				//========================================
				//top controls and status

				{
					let str = "";

					str += "Target Iteration Plan: ";
					if(active_plan_status == "Inactive")
						str += _targetPlan;
					else
						str += active_plan;
					str += " | ";
					str += "<a onclick='startTargetIterationPlan()'>Start</a> ";
					str += "<a onclick='pauseTargetIterationPlan()'>Pause</a> ";
					str += "<a onclick='haltTargetIterationPlan()'>Halt</a> ";
					
					str += "<br>";
					str += "| active_plan_status = " + active_plan_status;
					str += "| current_command_index = " + command_index;
					str += "| current_command_duration = " + command_duration;
					str += "| current_state = " + current_state;
					str += "| in_transition = " + in_transition;
					str += "| transition_progress = " + transition_progress;
					str += "| time_in_state = " + time_in_state;
					str += "|";

					document.getElementById('topPane-header').innerHTML = str;
				}
				
				_updateTimer = window.setTimeout(updateIterateStatus,_UPDATE_TIMER_PERIOD);
				
				
					}, //end handler
					0, //handler param
					0,true,false, //progressHandler, callHandlerOnErr, showLoadingOverlay
					true /*targetSupervisor*/);
		} //end updateIterateStatus
		
		
		
		</script>
</head>
	

<body onload='Javascript:init();'>	
		
	<!-- body content populated by javascript paint(), etc. -->

	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
</body>
	
</html>
