<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>artdaq ConfigurationGUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<style type="text/css">			
		
		body {
			background-color: 		white; 
		}
		
		/* make buttons and links have a hand cursor */
		input[type="button"], button, a {
			cursor: 				pointer;
		}
		
		.controlsPane {
			position:				absolute;			
			top:					-2px;
			z-index:				1002;
		}
		
		.controlsButton {
			-webkit-user-select: 	none;
			-moz-user-select: 		none;
			user-select:			none;
			
			overflow: 				hidden;				
			cursor: 				pointer;
			width: 					34px;
			height: 				36px;
			
			background-color: 		rgb(202, 204, 210);
			
			
			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
					inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
					rgb(150,150,150) 0 .1em 3px,
					rgb(175,175,175) 0 .2em 1px, /* color border */
					rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
		}

		.controlsButton:hover,
		.controlsButton:focus {
			background-color: 		rgb(225, 227, 233);
		}

		.controlsButton:active {
			background-color: 		rgb(202, 204, 210);
			-webkit-transform: 		translateY(.1em);
			-moz-transform: 		translateY(.1em);
			transform: 				translateY(.1em);
		}
		
		#directoryNavToggleTop {
			float: 					left;
			width: 					10px;
			height: 				4px;
			margin: 				6px 3px 0px 6px;
			border-right: 			3px solid transparent;
			border-bottom: 			4px solid white;
		}
		#directoryNavToggleBottom {
			background-color: 		white;
			float: 					left;
			width: 					24px;
			height: 				15px;
			margin: 				0px 3px 0px 5px;
		}

		#saveFileMain {
			border:					1px solid white;
			border-radius:			2px;
			float: 					left;
			width: 					21px;
			height: 				21px;
			margin: 				8px 3px 0px 6px;
		}
		#saveFileMainTop {
			border:					1px solid white;
			float: 					left;
			width: 					13px;
			height: 				10px;
			margin: 				-23px 0px 0px 10px;
		}
		#saveFileMainBottom {
			border:					1px solid white;
			float: 					left;
			width: 					7px;
			height: 				5px;
			margin: 				-7px 0px 0px 13px;
		}
				
		#theGridCanvas, #theCanvas, #theActionCanvas, #preCanvas, #postCanvas {
			position: 				absolute;
			left: 					0;
			top: 					0;
		}
		#theCanvas, #theActionCanvas {
			z-index:				1000;			
		}
		.node-point /*place on top of the canvas*/ {
			z-index:				1001;
		}
				
		.node {
			position:				absolute;
			cursor:					pointer;			
		}
		
		.node-box {
			background-color : 		rgb(241, 231, 231);			

			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
									inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
									rgba(200, 200, 200,0.6) 0 .1em 3px,
									rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
									rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
			border-radius: 			3px;	
			
			position:				absolute;
			cursor:					pointer;
		}
		
		.node-box:hover {

			background-color: 		rgb(230, 201, 201);

			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
									inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
									rgba(200, 200, 200,0.6) 0 .1em 3px,
									rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
									rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
		}		
		
		.node-point {
			background-color : 		rgb(206, 148, 148);
			border:					3px solid rgb(132, 92, 92);
			border-radius: 			9px;	
			width:					9px;
			height:					9px;

			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
									inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
									rgba(200, 200, 200, 0.6) 0 0 3px,
									rgba(200, 200, 200, 0.6) 0 0 1px,  /* color border */
									rgba(0,0,0,0.2) 0 0 5px;	/* drop shadow */
			
			position:				absolute;
			cursor:					pointer;
			display:				none;
		}
			
		.node-point:hover {
			background-color: 		rgb(230, 201, 201);
		}
		
		.node-boxText {
			width: 					100%;
			text-align: 			center;
			color: 					black;

			-webkit-user-select: 	none;
			-moz-user-select: 		none;
			user-select:			none;
			
			margin-top: 			43px;
		}
		
		.node-headerText {		
			-webkit-user-select: 	none;
			-moz-user-select: 		none;
			user-select:			none;
			
			text-align: 			center;
			color: 					black;			
			font-size: 				10px;
			position: 				absolute;
			
			white-space:			nowrap;
			overflow:				hidden;
		}
		
		#createNodeDiv {
			background-color: 		rgb(195, 230, 193);	
			cursor:					pointer;
			width: 					32px;
			height: 				32px;
			border-radius: 			32px;
			border: 				0px solid rgb(6, 82, 9);
			
			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
									inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
									rgba(200, 200, 200,0.6) 0 .1em 3px,
									rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
									rgba(0,0,0,0.2) 0 .3em 5px;	/* drop shadow */
			
			left:					-1000px;			
			position: 				absolute;
		    z-index:				2000; 	/* to place on top of everything */
		}
		
		#createNodeDiv:hover {
			background-color: 		rgb(215, 255, 213);			
		}

		#createNode {
			margin: 				1px 16px -10px 8px;
			float:					left;
			
			text-decoration: 		none;			
			font-size: 				30px;
			font-weight: 			bold;
			color: 					rgb(15, 152, 76);
		}
		
		#selectionBoxDiv {
			border:					1px dashed gray;
			
			left:					-1000px;			
			position: 				absolute;
			z-index:				2000;
		}

		.node-icon {
			position:			absolute;
			display:			none;	
			z-index:			1001; /* same as node anchor points */
		}
				
		.node-editIcon {			
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEdit.png);
			width: 				24px;
			height: 			20px;
			float: 				left;
			border: 			0;
			margin: 			-9px 0 -7px -4px;
		}
		.node-editIcon:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEditHover.png);
			cursor: 			pointer;
		}
		
		.node-deleteIcon {			
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCan.png);
			width: 				16px;
			height: 			20px;
			border: 			0;
			margin: 			-8px 0 -10px 6px;
		}
		.node-deleteIcon:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
			cursor: 			pointer;
		}
		
		.node-viewFclIcon {
		    border: 			2px solid rgb(202, 204, 210);
		    width: 				16px;
		    height: 			20px;
		    border-radius: 		2px;
		    margin: 			-10px 0 0 2px;
		}
		.node-viewFclIcon:hover {
			border: 			2px solid rgb(101, 173, 199);
		}
		.node-viewFclIcon:hover * {
			border-color: 		rgb(101, 173, 199);
		}
		.node-viewFclIcon-line {
			border-top: 		2px solid rgb(202, 204, 210);
			border-bottom: 		2px solid rgb(202, 204, 210);
			height: 			2px;			    
			width:				12px;
			float:				left;
			margin:				3px 0 -1px 2px;
		}    

		.grid-plusMinusArrows {
			position:			absolute;
			z-index:			1001;
			display:			none;
		}
		.grid-plusMinusArrows-arrow {
			cursor:				pointer;
		}
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-down-body, 
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-up-body, 
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-left-body, 
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-right-body {
			background-color:	rgb(101, 173, 199);
		}
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-down-point {
			border-top-color:	rgb(101, 173, 199);
		}
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-up-point {
			border-bottom-color:rgb(101, 173, 199);
		}
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-left-point {
			border-right-color:	rgb(101, 173, 199);
		}
		.grid-plusMinusArrows-arrow:hover 
		.grid-plusMinusArrows-right-point {
			border-left-color:	rgb(101, 173, 199);
		}

		.grid-plusMinusArrows-upDown {
			width:				100px;
			height:				30px;
		}
		.grid-plusMinusArrows-leftRight {
			width:				30px;
			height:				100px;
		}
		.grid-plusMinusArrows-down {
			float:				left;
		}
		.grid-plusMinusArrows-up {
			float:				right;
			margin-top:			-6px;
		}
		.grid-plusMinusArrows-left {
			float:				left;
		}
		.grid-plusMinusArrows-right {
			float:				left;
			margin:				50px -6px 0 6px;
		}
		.grid-plusMinusArrows-down-body,
		.grid-plusMinusArrows-up-body {
			display: 			block; 
			margin-left: 		5px; 
			height:				16px;
			width: 				14px; 
			background-color: 	rgb(202, 204, 210);
		} 
		.grid-plusMinusArrows-down-point {
			display: 			block; 
			width: 				0; 
			height: 			0;
			border-left: 		12px solid transparent; 
			border-right: 		12px solid transparent; 
			border-top: 		14px solid rgb(202, 204, 210);
		}
		.grid-plusMinusArrows-up-point {
			display: 			block; 
			width: 				0; 
			height: 			0;
			border-left: 		12px solid transparent; 
			border-right: 		12px solid transparent; 
			border-bottom: 		14px solid rgb(202, 204, 210);
		}
		.grid-plusMinusArrows-left-body,
		.grid-plusMinusArrows-right-body {
			display: 			block;
			float:				left;
			margin-top: 		5px; 
			height:				14px;
			width: 				16px;
			background-color: 	rgb(202, 204, 210);
		} 
		.grid-plusMinusArrows-left-point {
			display: 			block; 
			float:				left;
			width: 				0; 
			height: 			0;
			border-top: 		12px solid transparent; 
			border-bottom: 		12px solid transparent; 
			border-right: 		14px solid rgb(202, 204, 210);
		}
		.grid-plusMinusArrows-right-point {
			display: 			block; 
			float:				left;
			width: 				0; 
			height: 			0;
			border-top: 		12px solid transparent; 
			border-bottom: 		12px solid transparent; 
			border-left: 		14px solid rgb(202, 204, 210);
		}
		
		.preloadImage {			
			width: 				24px;
			height: 			20px;
			position:			absolute;
			left: 				-100px;
			top: 				0;
		}
		#preloadImage-treeEditTrashIconHover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
		}
		#preloadImage-treeEditIconHover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEditHover.png);
		}
		
	</style>
	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ArtdaqConfigurationAPI.js"></script>
	
	<script>		
		
		//	Description of Configuration-artdaq Functionality/Behavior:
		//	
		//	- Requires user to have LOCK
		//
		//	- Grid always stretches to full window size
		//	and defines scale (allow adding row/col of dots at either side)
		//		
		//	- Save functionality should be same as saving tree	
		//		* If admin, could give options to target a certain system alias.. Etc.
		//		* Else assume saving to currently active groups
		//	- Save/Load positioning maps to filename based on active Context group.
		//
		//	- On load, get active groups artdaq modules.. allow editing, deleting, adding.. 
		//	and connecting sources and destinations
		
	
		//paint globals -------------		
		var _NODE_SIZE; //everything else should be sized off of this, and grid steps
		var _CANVAS_MARGIN		= 0;
		var _GRID_MARGIN		= 100;
		var _CANVAS_COLOR 		= "rgba(255,255,255,0)";
		var _GRID_COLOR 		= "rgb(218, 194, 194)";
		var _ARROW_COLOR 		= "rgb(70, 67, 67)";
		var _SHADOW_COLOR 		= "gray";
		var _GRID_ROW_MIN		= 2;
		var _GRID_COL_MIN		= 3;
		
		var _gridCanvas, _gridContext, _canvas, _context, _actionCanvas, _actionContext;
		var _preCanvas, _postCanvas;
		var _addNodeEl;
		var _w, _h;		
		
		//object globals -------------
		var _grid = { //size of grid, rows and cols can be added or removed
				"rows": _GRID_ROW_MIN, 	"cols": _GRID_COL_MIN, 
				"x0": 	0, 	"y0": 	0, 
				"xstep":0, 	"ystep":0}; 
		var _nodes = []; 	// array of node objects (can be multi-node vector at location)
							//	node: 	{type,name,x-grid,y-grid,node-count}
		var _arrows = {}; 	//multi-dim map of arrow objects 
							//	arrow:	[i0][i1] = {p0,p1} (start and end i,p - where i := node index, p := 1 of 4 positions starting from top going clock-wise)
		
		var _nodesByType = {};		
		var _selectedNodes = {}; //selected nodes get highlighted in paint()
		
		var _subsystems = {}; //object describing artdaq subsystems
		
		//constant globals -------------
		var _NODE_TYPE_READER 		= 0;
		var _NODE_TYPE_BUILDER 		= 1;
		var _NODE_TYPE_LOGGER 		= 2;
		var _NODE_TYPE_DISPATCHER 	= 3;
		var _NODE_TYPE_MONITOR 		= 4;
		
		var _MMM_NONE				= 0;
		var _MMM_ARROW_DRAG			= 1;
		var _MMM_NODE_DRAG			= 2;
		var _MMM_SELECT_BOX			= 3;
		
		//mousemove globals -------------
		var _mouseMoveMode = _MMM_NONE;
		var _mouseMoveStart = [0,0,0,0]; //x,y,i,p start (i,p are optional)
		var _mouseHoverNode = -1;

		//configuration globals -------------
		var _modifiedTables;
		var _systemGroups = {};
		var _firstInit = true;
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////

		//=====================================================================================
		//htmlOpen ~~		
		//	tab name and attribute/value map object
		function htmlOpen(tag,attObj,innerHTML,doCloseTag)
		{
			var str = "";
			var attKeys = Object.keys(attObj); 
			str += "<" + tag + " ";
			for(var i=0;i<attKeys.length;++i)
				str += " " + attKeys[i] + "='" +
				attObj[attKeys[i]] + "' ";
			str += ">";
			if(innerHTML) str += innerHTML;
			if(doCloseTag)
				str += "</" + tag + ">";
			return str;
		} // end htmlOpen()

		//=====================================================================================
		//htmlClearDiv ~~		
		function htmlClearDiv()
		{
			return "<div id='clearDiv'></div>";
		} //end htmlClearDiv()
		
		//functions:
			//htmlOpen()
			//htmlClearDiv()
			//init()	
		
			//openActiveGroupsDialog()
			//nodeLayoutHasChanged()
			//addArrow(startNodeIndex, startNodePointIndex, endNodeIndex, endNodePointIndex)
					
			//paint()
			//drawGrid() 
			//drawNode(i,xoff,yoff) 
			//drawArrow() 
		
			//getNodePoint(i,p)
			//doNodeHover(i)
			//getTypeIndex(typeName)
			//getTypeName(typeIndex)
			//getEmptyGridSpot(type)
			//plusMinusGrid(isPlus,directionIndex)
		
			//handleNodeMouseOver(e)
			//handleMouseMove(e)
			//handleMouseUp(e)
			//handleMouseDown(e)
			//handlePointMouseUp(i,p)
			//handlePointMouseDown(i,p)
				
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
				

		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init() 
		{									
			Debug.log("CfgGUI_artdaq init ");			
			
			

			//			DesktopContent.tooltip("Configuration-Subset GUI Introduction",
			//					"Welcome to the Configuration-Subset GUI targeting " + _recordsAlias + 
			//					". Here you can manipulate the fields "+
			//					"of a subset of your <i>otsdaq</i> system. \n\n" +
			//					"The organization of the Configuration-Subset GUI is in the form of two panes, a left and right.\n\n" +
			//
			//					"Briefly, here is a description of the two panes: " +
			//					"\n\t- 'Left Pane' is for selecting one or many records to target." +
			//					"\n\t- 'Right Pane' is for modifying the common fields associated with the selected records."
			//			);

			if(0) //example nodes and arrows
			{
				var x = 0;
				var y = 0;
				_nodes.push({"type":_NODE_TYPE_READER,	"x":x++, 	"y":y});			
				_nodes.push({"type":_NODE_TYPE_BUILDER,	"x":x++, 	"y":y, "nodeCount": 5});			
				_nodes.push({"type":_NODE_TYPE_LOGGER,	"x":x++, 	"y":y, "nodeCount": 2});
				x = 0;
				y++;
				_nodes.push({"type":_NODE_TYPE_MONITOR,	"x":x, 	"y":y});			
				_nodes.push({"type":_NODE_TYPE_DISPATCHER,	"x":x++, 	"y":y});

				_arrows[1] = {};
				_arrows[1][0] = {"p0":1,"p1":0};

			}
						
			
			//init configuration members
			_modifiedTables = undefined; //reset
			
			_grid = { //size of grid, rows and cols can be added or removed
							"rows": _GRID_ROW_MIN, 	"cols": _GRID_COL_MIN, 
							"x0": 	0, 	"y0": 	0, 
							"xstep":0, 	"ystep":0}; 
			
			_nodes = []; 
			_arrows = {};
			_nodesByType = {};
			_selectedNodes = {};
			_subsystems = {};
			
			//////////////
			ArtdaqConfigurationAPI.getArtdaqNodes(
					function(artdaqObj)
					{
				console.log("artdaqObj",artdaqObj);
				
				//get active configuration group
				DesktopContent.XMLHttpRequest("Request?RequestType=loadArtdaqNodeLayout",
						"", //end post data, 
						function(req) 
						{
					//Steps:
					//	if layout, 
					//		for each matching node in layout, place, delete from artdaqObj 
					//  for each remaining node, then use default behavior to place nodes
					
					// build _nodes and _nodesByType
					
					// Then, get artdaqSourcesAndDestinations
					
					var rows = DesktopContent.getXMLValue(req,"grid-rows");
					var cols = DesktopContent.getXMLValue(req,"grid-cols");
					
					if(!rows || rows == "" || !cols || cols == "")
					{
						//setup default grid
						rows = Math.ceil(Math.sqrt(artdaqObj.nodeCount));
						cols = rows + 1;
					}
					_grid.rows = rows | 0;
					_grid.cols = cols | 0;
					if(_grid.rows < _GRID_ROW_MIN)
						_grid.rows = _GRID_ROW_MIN;
					if(_grid.cols < _GRID_COL_MIN)
						_grid.cols = _GRID_COL_MIN;
					
					console.log("_grid",_grid);
					
					var layoutNodesType = req.responseXML.getElementsByTagName("node-type");
					var layoutNodesName = req.responseXML.getElementsByTagName("node-name");
					var layoutNodesX 	= req.responseXML.getElementsByTagName("node-x");
					var layoutNodesY	= req.responseXML.getElementsByTagName("node-y");
					
					//for every type, node match.. add to _nodes.. and delete from artdaqObj
					for(var i=0;i<layoutNodesType.length;++i)
					{
						var type = layoutNodesType[i].getAttribute('value');
						var name = layoutNodesName[i].getAttribute('value');
						if(artdaqObj[type] && 
								artdaqObj[type][name])
						{
							Debug.log("Found " + name);
							
							//add to nodes
							_nodes.push({
								"type": 		getTypeIndex(type),
								"name": 		name,
								"hostname":		artdaqObj[type][name].hostname,
								"subsystemId":	artdaqObj[type][name].subsystemId,
								"x":			layoutNodesX[i].getAttribute('value')|0,
								"y":			layoutNodesY[i].getAttribute('value')|0});
							
							//remove from nodes object to keep remainder accurate 
							delete artdaqObj[type][name];
							
						}
						else //not found, so do not represent anymore
							Debug.log("Not Found " + name);
					}
					
					console.log("nodes in layout",_nodes);
					
					//now add remaining nodes to layout automatically
					
					for(var t in ArtdaqConfigurationAPI.NODE_TYPES)
					{
						t = ArtdaqConfigurationAPI.NODE_TYPES[t];
						console.log("Type",t);

						for(var n in artdaqObj[t])
						{	
							console.log("Type",t,"Name",n);

							var typeIndex = getTypeIndex(t);
							var xy = getEmptyGridSpot(typeIndex);
							//add to nodes
							_nodes.push({
								"type": 		typeIndex,
								"name": 		n,	
								"hostname":		artdaqObj[t][n].hostname,
								"subsystemId":	artdaqObj[t][n].subsystemId,
								"x":			xy[0],
								"y":			xy[1]});
						}
					}
					
					console.log("all nodes",_nodes);
					
					_subsystems = artdaqObj.subsystems;
					
					console.log("all subsystems",_subsystems);
					
					localFinishInit();
						} //end loadArtdaqNodeLayout handler
				); //end loadArtdaqNodeLayout call
				
					}, //end getArtdaqApps handler
					_modifiedTables); //end getArtdaqApps call
			
			return;
			

			//=================
			function localFinishInit()
			{				
				//only continue if the first time in init()
				if(!_firstInit) 
				{
					paint();
					return;
				}		
				//else first time!
				
				_firstInit = false; //only finish init once
	
				_preCanvas = document.getElementById("preCanvas");
				_postCanvas = document.getElementById("postCanvas");
				_addNodeEl = document.getElementById("createNodeDiv");
	
				_canvas = document.getElementById("theCanvas");
				_canvas.style.backgroundColor = _CANVAS_COLOR;
				_context = _canvas.getContext('2d');
				_actionCanvas = document.getElementById("theActionCanvas");
				_actionCanvas.style.backgroundColor = _CANVAS_COLOR;
				_actionContext = _actionCanvas.getContext('2d');
				_gridCanvas = document.getElementById("theGridCanvas");
				_gridCanvas.style.backgroundColor = _CANVAS_COLOR;
				_gridContext = _gridCanvas.getContext('2d');
	
				paint();
				window.addEventListener("resize",paint);
	
				//DesktopContent.mouseMoveSubscriber(handleMouseMove); //causes problems because of this.style.cursor handling 
				document.body.addEventListener("mousemove",handleMouseMove);
				document.body.addEventListener("mouseup",handleMouseUp);
				document.body.addEventListener("mousedown",handleMouseDown);
				document.body.addEventListener("keydown",handleMouseMove);
				document.body.addEventListener("keyup",handleMouseMove);
			} //end localFinishInit()									
			
		} //end init()	
		
		//=====================================================================================
		//getTypeIndex ~~
		function getTypeIndex(typeName)
		{
			Debug.log("getTypeIndex " + typeName);
			t = typeName == ArtdaqConfigurationAPI.NODE_TYPES[_NODE_TYPE_READER]		?_NODE_TYPE_READER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[_NODE_TYPE_BUILDER]	?_NODE_TYPE_BUILDER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[_NODE_TYPE_LOGGER]	?_NODE_TYPE_LOGGER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[_NODE_TYPE_DISPATCHER]?_NODE_TYPE_DISPATCHER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[_NODE_TYPE_MONITOR]	?_NODE_TYPE_MONITOR:-1))));
			
			if(t < 0)
			{	
				Debug.log("Illegal type name " + typeName + 
						". Tell admins how you got here!", Debug.HIGH_PRIORITY);
				return; 
			}
			return t;
		} //end getTypeIndex()
		
		//=====================================================================================
		//getTypeName ~~
		function getTypeName(typeIndex)
		{
			Debug.log("getTypeName " + typeIndex);
			
			if(ArtdaqConfigurationAPI.NODE_TYPES[typeIndex] === undefined)
			{	
				Debug.log("Illegal type index " + typeIndex + 
						". Tell admins how you got here!", Debug.HIGH_PRIORITY);
				return; 
			}
			return ArtdaqConfigurationAPI.NODE_TYPES[typeIndex];
		} //end getTypeName()	

		//=====================================================================================
		//getEmptyGridSpot ~~
		//	return empty x,y grid spot
		//	handle types differently.. 
		//	i.e. readers to left, builders in middle, dataLoggers and dispatchers to right
		function getEmptyGridSpot(type)
		{
			var x = type == _NODE_TYPE_READER?0:
					(type == _NODE_TYPE_BUILDER?((_grid.cols/2)|0):
					_grid.cols-1); //else dataLoggers and dispatchers on right
			var d = type == _NODE_TYPE_READER?1:-1; //direction of search in x
			var y = 0; //start at top-ish
			
			//search _nodes for conflict
			var tries = 0;
			do
			{
				var conflict = false;
				
				//if too many conflicts, add row to top
				if(tries > _grid.cols*_grid.rows/2)
				{
					plusMinusGrid(true /*isPlus*/,0 /*directionIndex*/); //add row to top

					var x = type == _NODE_TYPE_READER?0:
							(type == _NODE_TYPE_BUILDER?((_grid.cols/2)|0):
							_grid.cols-1); //else dataLoggers and dispatchers on right
					y = 0;
				}

				for(var i=0;i<_nodes.length;++i)
				{
					if(_nodes[i].x == x && _nodes[i].y == y)
					{
						conflict = true;
						//try new value
						++y;
						if(y >= _grid.cols)
						{
							//handle y wraparound
							y = 0;
							x = (x + d) % _grid.cols;
						}
						
						break;
					}
				}
				++tries;
			} while(conflict);
			
			Debug.log("Position found at x,y " + 
					x + "," + y);
			
			return [x,y];
			
		} //end getEmptyGridSpot()

		//=====================================================================================
		//handleNodeMouseOver ~~
		function handleNodeMouseOver(e)
		{
			var id = this.id.split('-')[1] | 0;
			Debug.log("MouseOver Node id = " + id);
			
		} //end handleNodeMouseOver()
		
		//=====================================================================================
		//paint ~~
		//	paint grid and nodes based on 
		//	_grid and _nodes global variable and window size
		function paint() 
		{	
			_w = DesktopContent.getWindowWidth();
			_h = DesktopContent.getWindowHeight();
			
			console.log("_grid",_grid);
			console.log("_nodes",_nodes);
			console.log("_arrows",_arrows);

			var MIN_H = 280;
			var MIN_W = 280;
			if(_w < MIN_W)
				_w = MIN_W;
			if(_h < MIN_H)
				_h = MIN_H;
			
			Debug.log("paint w,h=" + _w + "," + _h);

			_canvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_canvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_canvas.width = (_w - _CANVAS_MARGIN*2);
			_canvas.height = (_h - _CANVAS_MARGIN*2);
			_context.clearRect(0, 0, _canvas.width, _canvas.height);
			
			_actionCanvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.width = (_w - _CANVAS_MARGIN*2);
			_actionCanvas.height = (_h - _CANVAS_MARGIN*2);
			_actionContext.clearRect(0, 0, _canvas.width, _canvas.height);

			_gridCanvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_gridCanvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_gridCanvas.width = (_w - _CANVAS_MARGIN*2);
			_gridCanvas.height = (_h - _CANVAS_MARGIN*2);
			_gridContext.clearRect(0, 0, _canvas.width, _canvas.height);

			drawGrid();

			//determine node size and then draw			
			_NODE_SIZE = _grid.xstep*0.5;
			if(_NODE_SIZE > _grid.ystep*0.5)
				_NODE_SIZE = _grid.ystep*0.5;
			
			_grid.rowColMap = {};
			for(var i=0;i<_nodes.length;++i)							
				drawNode(i);
			
			drawArrows();
			
		} //end paint()

		//=====================================================================================
		//drawGrid ~~
		function drawGrid() 
		{	
			if(_grid.cols < _GRID_COL_MIN) 
			{
				Debug.log("Not enough columns, defaulting.");
				_grid.cols = _GRID_COL_MIN;
			}
			if(_grid.rows < _GRID_ROW_MIN) 
			{
				Debug.log("Not enough rows, defaulting.");
				_grid.rows = _GRID_ROW_MIN;
			}
			
			//determine grid spacing
			_grid.xstep = (_w - 2*_GRID_MARGIN)/_grid.cols;			
			_grid.ystep = (_h - 2*_GRID_MARGIN)/_grid.rows;
			
			if(_grid.xstep < 0 || _grid.ystep < 0)
			{
				Debug.log("Window size is too small!",Debug.HIGH_PRIORITY);
				return;
			}
						
			_grid.x0 = _GRID_MARGIN + _grid.xstep/2;
			_grid.y0 = _GRID_MARGIN + _grid.ystep/2;
			
			//shrink margin if window is small
			if(_grid.x0 > _grid.xstep * 2)
			{
				_grid.x0 = _grid.xstep;
				_grid.xstep = (_w - 2*_grid.x0)/_grid.cols;	
				_grid.x0 = _grid.x0 + _grid.xstep/2;
			}
			if(_grid.y0 > _grid.ystep * 2)
			{
				_grid.y0 = _grid.ystep;		
				_grid.ystep = (_h - 2*_grid.ystep)/_grid.rows;
				_grid.y0 = _grid.y0 + _grid.ystep/2;
			}

			console.log("drawGrid _grid",_grid);
			
			//draw grid +/- arrows
			//if node exists, get element
			var el = document.getElementById("grid-plusMinusArrowsContainer");
			if(!el) //else create it
			{
				el = document.createElement("div"); 
				el.setAttribute("id", "grid-plusMinusArrowsContainer");
				
				var str = "";
				
				//make 4 sets of +/- arrows
				var a = 0;
				//top set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-upDown'>";
				{ //make top up/down arrows
					str += "<div class='grid-plusMinusArrows-down grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' onmouseup='plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a row from the canvas grid.' >" +
								//make up arrow
								"<div class='grid-plusMinusArrows-down-body'></div>" +
								"<div class='grid-plusMinusArrows-down-point'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-up grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' onmouseup='plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a row to the canvas grid.' >" +
								//make down arrow
								"<div class='grid-plusMinusArrows-up-point'></div>" +
								"<div class='grid-plusMinusArrows-up-body'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//right set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-leftRight'>";
				{ //make right left/right arrows
					str += "<div class='grid-plusMinusArrows-left grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' onmouseup='plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a column from the canvas grid.' >" +
							//make left arrow
							"<div class='grid-plusMinusArrows-left-point'></div>" +
							"<div class='grid-plusMinusArrows-left-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-right grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' onmouseup='plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a column to the canvas grid.' >" +
							//make right arrow
							"<div class='grid-plusMinusArrows-right-body'></div>" +
							"<div class='grid-plusMinusArrows-right-point'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//bottom set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-upDown'>";
				{ //make bottom up/down arrows
					str += "<div class='grid-plusMinusArrows-up grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' onmouseup='plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a row to the canvas grid.' >" +
								//make up arrow
								"<div class='grid-plusMinusArrows-up-point'></div>" +
								"<div class='grid-plusMinusArrows-up-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-down grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' onmouseup='plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a row to the canvas grid.' >" +
								//make down arrow
								"<div class='grid-plusMinusArrows-down-body'></div>" +
								"<div class='grid-plusMinusArrows-down-point'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//left set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-leftRight'>";
				{ //make left left/right arrows
					str += "<div class='grid-plusMinusArrows-left grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' onmouseup='plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a column to the canvas grid.' >" +
							//make left arrow
							"<div class='grid-plusMinusArrows-left-point'></div>" +
							"<div class='grid-plusMinusArrows-left-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-right grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' onmouseup='plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a column from the canvas grid.' >" +
							//make right arrow
							"<div class='grid-plusMinusArrows-right-body'></div>" +
							"<div class='grid-plusMinusArrows-right-point'></div>" +										
							"</div>";
				}				
				str += "</div>"; //close top +/- set collection
				el.innerHTML = str;
				_postCanvas.appendChild(el);	
			}

			var arrows = el.getElementsByClassName("grid-plusMinusArrows");
			sz = 100;
			vsz = 30;
			arrows[0].style.left 	= ((_w/2 - sz/2)|0) + "px";
			arrows[0].style.top 	= (((_GRID_MARGIN-vsz)/2)|0) + "px";
			arrows[1].style.left 	= ((_w - (_GRID_MARGIN-sz)/2 - sz)|0) + "px";
			arrows[1].style.top 	= ((_h/2 - vsz/2)|0) + "px";
			arrows[2].style.left 	= ((_w/2 - sz/2)|0) + "px";
			arrows[2].style.top 	= ((_h - (_GRID_MARGIN-vsz)/2 - vsz)|0) + "px";
			arrows[3].style.left 	= (((_GRID_MARGIN-vsz)/2)|0) + "px";
			arrows[3].style.top 	= ((_h/2 - vsz/2)|0) + "px";

			//draw grid dots			
			_gridContext.save();
			_gridContext.fillStyle   	= _GRID_COLOR;
			_gridContext.shadowOffsetX 	= 2;
			_gridContext.shadowOffsetY 	= 2;
			_gridContext.shadowBlur    	= 5;
			_gridContext.shadowColor	= _SHADOW_COLOR;
			
			//_context.fillRect(10,10,100,100);
					
			var r,c;
			for(r=0;r<_grid.rows;++r)
				for(c=0;c<_grid.cols;++c)
					_gridContext.fillRect(
							(_grid.x0 + c*_grid.xstep)|0,
							(_grid.y0 + r*_grid.ystep)|0,							
							3,3 /*size w,h in pixels*/);
			
			_gridContext.restore();
		} //end drawGrid()

		//=====================================================================================
		//plusMinusGrid ~~
		//	add or subtract row/col, and adjust nodes
		// directionIndex := 0-3 := top, right, bottom, left
		function plusMinusGrid(isPlus,directionIndex)
		{
			Debug.log("plusMinusGrid isPlus=" + 
					isPlus + " directionIndex=" +
					directionIndex);
			
			if(!isPlus) //then deleting row/col
			{
				if(directionIndex == 0 || 
						directionIndex == 2)
				{
					//dealing with a row
					
					var y = directionIndex == 0?
							0:_grid.rows-1;

					if(_grid.rows <= _GRID_ROW_MIN)
					{
						Debug.log("Can not delete row " + y +
								"; " + _GRID_ROW_MIN +
								" rows is the minimum!",
								Debug.HIGH_PRIORITY);
						return;
					}
					
					//check for conflict
					for(var i=0;i<_nodes.length;++i)
						if(_nodes[i].y == y)
						{
							Debug.log("Can not delete row " + y +
									" while still occupied!",
									Debug.HIGH_PRIORITY);
							return;
						}
					
					//remove row 
					--_grid.rows;
					
					//move all nodes if row-0 was removed
					if(directionIndex == 0)
						for(var i=0;i<_nodes.length;++i)
							--_nodes[i].y;					
				}
				else if(directionIndex == 1 || 
						directionIndex == 3)
				{
					//dealing with a column
					
					var x = directionIndex == 3?
							0:_grid.cols-1;

					if(_grid.cols <= _GRID_COL_MIN)
					{
						Debug.log("Can not delete column " + x +
								"; " + _GRID_COL_MIN + 
								" columns is the minimum!",
								Debug.HIGH_PRIORITY);
						return;
					}

					//check for conflict
					for(var i=0;i<_nodes.length;++i)
						if(_nodes[i].x == x)
						{
							Debug.log("Can not delete column " + x +
									" while still occupied!",
									Debug.HIGH_PRIORITY);
							return;
						}

					//remove column 
					--_grid.cols;

					//move all nodes if col-0 was removed
					if(directionIndex == 3)
						for(var i=0;i<_nodes.length;++i)
							--_nodes[i].x;
				}
				else
				{	
					Debug.log("Unrecognized direction index - should be impossible!",
							Debug.HIGH_PRIORITY);
				}
				
				//re-paint adjustments
				paint(); 
				
				return;
			} //end minus handling
			
			//if here, then add handling
			
			if(directionIndex == 0 || 
					directionIndex == 2)
			{
				//dealing with a row
				++_grid.rows;
				
				//move all nodes if row-0 was added
				if(directionIndex == 0)
					for(var i=0;i<_nodes.length;++i)
						++_nodes[i].y;
			}
			else if(directionIndex == 1 || 
					directionIndex == 3)
			{
				//dealing with a column
				++_grid.cols;

				//move all nodes if col-0 was removed
				if(directionIndex == 3)
					for(var i=0;i<_nodes.length;++i)
						++_nodes[i].x;
			}
			else
			{	
				Debug.log("Unrecognized direction index - should be impossible!",
						Debug.HIGH_PRIORITY);
			}
			
			//re-paint adjustments
			paint(); 
			
		} //end plusMinusGrid()

		//=====================================================================================
		//handleSelectionBox ~~
		//	draw selection box,	and handle identifying
		//	nodes within selection area.
		function handleSelectionBox(e)
		{
			var box = [
			   _mouseMoveStart[0] < e.clientX?
					   _mouseMoveStart[0]:e.clientX,
			   _mouseMoveStart[1] < e.clientY?
					   _mouseMoveStart[1]:e.clientY,
			   _mouseMoveStart[0] < e.clientX?
					   e.clientX:_mouseMoveStart[0],
			   _mouseMoveStart[1] < e.clientY?
					   e.clientY:_mouseMoveStart[1]
			 ]; //box top-left ==> bot-right
			
			console.log("box",box);
			
			var el = document.getElementById("selectionBoxDiv");
			el.style.left 	= box[0] + "px";
			el.style.top 	= box[1] + "px";
			el.style.width 	= (box[2]-box[0]) + "px";
			el.style.height = (box[3]-box[1]) + "px";
			
			//determine temporary selected nodes
			_mouseMoveStart[2] = {}; //store selected nodes here
			var nodeBox = [
			   ((box[0] - _grid.x0 + _grid.xstep/2)/_grid.xstep),
			   ((box[1] - _grid.y0 + _grid.ystep/2)/_grid.ystep),
			   ((box[2] - _grid.x0 + _grid.xstep/2)/_grid.xstep),
			   ((box[3] - _grid.y0 + _grid.ystep/2)/_grid.ystep)			   
				];
			for(var i=0;i<4;++i) //clip to -1 and integer
				if(nodeBox[i] < 0) nodeBox[i] = -1;
				else nodeBox[i] |= 0;
			
			if(box[0] > 
					_grid.x0 + nodeBox[0]  * _grid.xstep + _NODE_SIZE/2)
				++nodeBox[0]; //lose selection
			if(box[1] > 
					_grid.y0 + nodeBox[1]  * _grid.ystep + _NODE_SIZE/2)
				++nodeBox[1]; //lose selection
			if(box[2] <
					_grid.x0 + nodeBox[2]  * _grid.xstep - _NODE_SIZE/2)
				--nodeBox[2]; //lose selection
			if(box[3] < 
					_grid.y0 + nodeBox[3]  * _grid.ystep - _NODE_SIZE/2)
				--nodeBox[3]; //lose selection
			
			console.log("node box selection",nodeBox);
			
			for(var xg=nodeBox[0];xg<=nodeBox[2];++xg)
				for(var yg=nodeBox[1];yg<=nodeBox[3];++yg)
					if(_grid.rowColMap[xg] !== undefined &&
							_grid.rowColMap[xg][yg] !== undefined)
					{
						Debug.log("Found selected node " +
								_grid.rowColMap[xg][yg]);
						_mouseMoveStart[2][_grid.rowColMap[xg][yg]] = 1;
					}

			console.log("nodes in box selection",_mouseMoveStart[2]);

			paint();
		} //end handleSelectionBox()

		//=====================================================================================
		//drawNode ~~
		//	draw a node of specified by node index 
		function drawNode(i,xoff,yoff)
		{
			var type = _nodes[i].type;
			var x = _nodes[i].x;
			var y = _nodes[i].y;
			
			//add to _grid.rowColMap
			if(_grid.rowColMap[x] == undefined) 
				_grid.rowColMap[x] = {};
			_grid.rowColMap[x][y] = i; //fill x,y position
			
			var nodeid = "node-" + i;
						
			var sz = _NODE_SIZE | 0; 
			x = (_grid.x0 + x * _grid.xstep - sz/2) | 0;
			y = (_grid.y0 + y * _grid.ystep - sz/2) | 0;
			
			if(xoff) x += xoff;
			if(yoff) y += yoff;
			
			Debug.log("x,y,sz = " + x + "," + y + "," + sz);
			
			var typeClass = 
					type == _NODE_TYPE_READER? 		"nodeReader":
					type == _NODE_TYPE_BUILDER? 	"nodeBuilder":
					type == _NODE_TYPE_LOGGER? 		"nodeLogger":
					type == _NODE_TYPE_DISPATCHER? 	"nodeDispatcher":"nodeMonitor";

			var typeName = 
					type == _NODE_TYPE_READER? 		"Reader":
					type == _NODE_TYPE_BUILDER? 	"Builder":
					type == _NODE_TYPE_LOGGER? 		"Logger":
					type == _NODE_TYPE_DISPATCHER? 	"Dispatcher":"Monitor";
			var typeAcronym = 
					type == _NODE_TYPE_READER? 		"BR":
					type == _NODE_TYPE_BUILDER? 	"EB":
					type == _NODE_TYPE_LOGGER? 		"DL":
					type == _NODE_TYPE_DISPATCHER? 	"Di":"Mo";
						
			
			Debug.log("nodeid = " + nodeid + "; typeClass = " + typeClass);

			//if node exists, get element
			var el = document.getElementById(nodeid);
			if(!el) //else create it
			{
				el = document.createElement("div"); 
				el.setAttribute("class", "node " + typeClass);
				el.setAttribute("id", nodeid);
								
				//draw box, connect points, pencil, and trashcan
				var str = "";
										
				//box
				var count = _nodes[i].nodeCount?_nodes[i].nodeCount:1;
				if(count > 4) count = 4; //cap at 4
				console.log(i,count);				
				for(var p=count-1;p>=0;--p)
				{
					str += "<div id='" + nodeid + 
						"-box' class='node-box' " +
						"style='top:" + (-p*5) + "px;" +
						"left:" + (-p*5) + "px;' " +
						">";
					if(p == 0)
					{
						str += "<div id='" + nodeid + 
							"-boxText' class='node-boxText'>" +
							typeAcronym +
							"</div>";
					}
					str += "</div>";
				}
				
				//connect points
				for(var p=0;p<4;++p)
					str += "<div id='" + nodeid + 
						"-point" + p + 
						"' class='node-point" + p +
						" node-point node-point-open' " +
						" onmouseup='handlePointMouseUp(" + 
						i + "," + p + ",event);'" +
						" onmousedown='handlePointMouseDown(" + 
						i + "," + p + ",event);'" +
						"></div>";
				
				//header text
				str += "<div id='" + nodeid + 
					"-headerText' class='node-headerText'>" +
					typeName + ": " + _nodes[i].name +
					htmlClearDiv() + 
					_nodes[i].hostname + ":" +
					_subsystems[_nodes[i].subsystemId].label +				
					"</div>";
				
				//add edit pencil icon
				str += "<div id='" + nodeid + 
						"-editIcon' class='node-icon node-editIcon' " +
						"title='Edit the configuration of this node.' " +
						"></div>";
				//add view fcl icon
				str += "<div id='" + nodeid + 
						"-viewFclIcon' class='node-icon node-viewFclIcon' " +
						"title='View the generated FHiCL of this node.' " +
						">" +
						"<div class='node-viewFclIcon-line'></div>" +
						"<div class='node-viewFclIcon-line'></div>" +
						"</div>";
				//add delete trash can icon
				str += "<div id='" + nodeid + 
						"-deleteIcon' class='node-icon node-deleteIcon' " +
						"title='Delete this node.' " +
						"></div>";
				
				el.innerHTML = str;
				_postCanvas.appendChild(el);	
				el.onmouseover = handleNodeMouseOver;	
			}			
			
			var boxes = el.getElementsByClassName("node-box");
			for(var p=0;p<boxes.length;++p)
			{
				boxes[p].style.width  = sz + "px";
				boxes[p].style.height = sz + "px";
			}		
			
			if(_selectedNodes[i] !== undefined || 
					(_mouseMoveMode == _MMM_SELECT_BOX &&
							_mouseMoveStart[2][i] !== undefined))
			{ //selected node
				boxes[0].style.border = "3px solid green";
			}
			else
				boxes[0].style.border = "0";
			
			el.style.left 	= x + "px";
			el.style.top 	= y + "px";		
			
			var pointSz = 12;
			var points = el.getElementsByClassName("node-point");
			var pxy;
			for(var p=0;p<4;++p)
			{
				pxy = getNodePoint(i,p);
				points[p].style.left 	= (pxy[0] - x - pointSz/2) + "px";
				points[p].style.top 	= (pxy[1] - y - pointSz/2) + "px";
			}
			
			var fontSz = sz/10;
			if(fontSz < 6) fontSz = 6;
			el = document.getElementById(nodeid + "-headerText");
			el.style.left = (- (_grid.xstep-sz)/2) + "px";
			el.style.fontSize = ((fontSz)|0) + "px";
			el.style.top = ((-fontSz*3-10)|0) + "px";
			el.style.height = ((fontSz*3)|0) + "px";
			el.style.width = (_grid.xstep) + "px";
			
			fontSz = sz/5;
			if(fontSz < 6) fontSz = 6;
			el = document.getElementById(nodeid + "-boxText");
			el.style.fontSize = ((fontSz)|0) + "px";
			el.style.marginTop = ((sz/2 - fontSz/2)|0) + "px";			
						
			el = document.getElementById(nodeid + "-editIcon");
			el.style.left = (-10) + "px";
			el.style.top = (sz+32) + "px";
			el = document.getElementById(nodeid + "-viewFclIcon");
			el.style.left = (((sz/2)|0)-10) + "px";
			el.style.top = (sz+32) + "px";
			el = document.getElementById(nodeid + "-deleteIcon");
			el.style.left = (sz-10) + "px";
			el.style.top = (sz+32) + "px";
			
		} //end drawNode()

		//=====================================================================================
		//drawArrows ~~
		function drawArrows() 
		{	
			var xy0,xy1;
			for(var i in _arrows)
				for(var j in _arrows[i])
				{
					xy0 = getNodePoint(i|0,_arrows[i][j].p0);
					xy1 = getNodePoint(j|0,_arrows[i][j].p1);
					console.log("xy01",xy0,xy1);
					drawArrow(xy0[0],xy0[1],xy1[0],xy1[1]);
				}
			
		} //end drawArrows()
		
		//=====================================================================================
		//drawArrow ~~
		function drawArrow(x0,y0,x,y,isActionCanvas) 
		{	
			//console.log("drawArrow x0,y0,x,y,isActionCanvas ",
			//		x0,y0,x,y,isActionCanvas);
			
			if(isActionCanvas) //assume one at a time in action
				_actionContext.clearRect(0, 0, _canvas.width, _canvas.height);
			
			var context = isActionCanvas?_actionContext:_context;
			
			context.save();
			
			var HEAD_SZ = 10;
			var LINE_SZ = 2;
			
			//make arrow slightly shorter than full distance
			
            var angle = Math.atan2(y-y0,x-x0);
            
            x -= HEAD_SZ*Math.cos(angle);
            y -= HEAD_SZ*Math.sin(angle);

            //starting path of the arrow from the start square to the end square and drawing the stroke
            context.beginPath();
            context.moveTo(x0, y0);
            context.lineTo(x, y);
            context.strokeStyle = _ARROW_COLOR;
            context.lineWidth = LINE_SZ;
            context.stroke();

            //starting a new path from the head of the arrow to one of the sides of the point
            context.beginPath();
            context.moveTo(x, y);
            context.lineTo(x-HEAD_SZ*Math.cos(angle-Math.PI/7),y-HEAD_SZ*Math.sin(angle-Math.PI/7));

            //path from the side point of the arrow, to the other side point
            context.lineTo(x-HEAD_SZ*Math.cos(angle+Math.PI/7),y-HEAD_SZ*Math.sin(angle+Math.PI/7));

            //path from the side point back to the tip of the arrow, and then again to the opposite side point
            context.lineTo(x, y);
            context.lineTo(x-HEAD_SZ*Math.cos(angle-Math.PI/7),y-HEAD_SZ*Math.sin(angle-Math.PI/7));

            //draws the paths created above
            context.strokeStyle = _ARROW_COLOR;
            context.lineWidth = LINE_SZ;
            context.stroke();
            context.fillStyle = _ARROW_COLOR;
            context.fill();
            
			context.restore();
		} //end drawArrow()		

		//=====================================================================================
		//handleMouseMove ~~
		function handleMouseMove(e) 
		{	
			if(document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID))
				return; //disable while popup
				
    		var x = e.clientX;//- this.offsetLeft - _CANVAS_MARGIN - 2;
    		var y = e.clientY;//- this.offsetTop - _CANVAS_MARGIN - 2;
			
    		if(x == undefined) //handle as a key press
    		{
    			x = DesktopContent.getMouseX();				
    			y = DesktopContent.getMouseY();
    		}
    		//console.log("mousemove x,y",x,y);
    		
    		//debug visually
    		//_context.fillRect((x)|0,(y)|0,3,3 );
    		
    		//steps:
    		//	if mousedown, draw arrow or dragging object
    		//	else if over empty grid position, show + 
    		//	else if over node show node decription/options
    		
    		
    		//----------------------------
    		//if mouse 'down' move handling
    		if(_mouseMoveMode != _MMM_NONE)
    		{
    			//handle mousemove mode
    			
    			//hide +
    			_addNodeEl.style.left = "-1000px"; //off screen
    			
    			switch(_mouseMoveMode)
    			{
    			case _MMM_ARROW_DRAG:
    				//console.log("arrow drag x,y",x,y);
    				drawArrow(
    						_mouseMoveStart[0],
							_mouseMoveStart[1],
							x,y, true /*isActionCanvas*/);
    				//continue on
    				break;    
    			case _MMM_NODE_DRAG:
    				//console.log("node drag x,y",x,y);
    				drawNode(
    						_mouseMoveStart[2],
    						x - _mouseMoveStart[0],
							y - _mouseMoveStart[1]);							
    				return;
    			case _MMM_SELECT_BOX:
    				//console.log("select box",x,y);
    				handleSelectionBox(e);							
    				return;
    			default:
    				Debug.log("Illegal _mouseMoveMode = " + _mouseMoveMode, 
    						Debug.HIGH_PRIORITY);
    				return; //do not continue on
    			}
    			
    			//for some modes, continue on to show mouse over nodes while dragging
    			
    		} //end handle mousemove mode

    		
			var xg = ((x - _grid.x0 + _grid.xstep/2)/_grid.xstep);
			var yg = ((y - _grid.y0 + _grid.ystep/2)/_grid.ystep);			
			
			if(xg < 0) xg = -1; //clip to -1 for +/- icons
			else xg |= 0;
			if(yg < 0) yg = -1; //clip to -1 for +/- icons			
			else yg |= 0;
			

			//console.log("mousemove x,y",x,y,
			//		"mousemove xg,yg",xg,yg);
			
			if(xg >= 0 && yg >= 0 && 
					xg < _grid.cols && 
					yg < _grid.rows)
			{
				if(_grid.rowColMap[xg] !== undefined &&
					_grid.rowColMap[xg][yg] !== undefined)
				{
					//----------------------------
					//	if over node show node decription/options
									
					Debug.log("Node over " + xg + "," + yg);
					
					//if over a filled spot, remove +			
					_addNodeEl.style.left = "-1000px"; //off screen
					
					doNodeHover(_grid.rowColMap[xg][yg]);
					
					//if directly over node-box, show grabbable hand
					var pxy = [ _grid.x0 + xg * _grid.xstep,
								_grid.y0 + yg * _grid.ystep];
					var overNodeBox = false;
					if(x > pxy[0] - _NODE_SIZE/2 && 
							x < pxy[0] + _NODE_SIZE/2 &&
							y > pxy[1] - _NODE_SIZE/2 &&
							y < pxy[1] + _NODE_SIZE/2) 
						overNodeBox = true;
					
					if(overNodeBox)
					{
						if(e.shiftKey) //indicate toggle selection
							this.style.cursor = "pointer";
						else
							this.style.cursor = "grab";
					}
					else
						this.style.cursor = "default";

					return;
				}
				else // else there is no node
				{		
					//----------------------------
					//if over empty grid position, show +
					
					//do not show + if for mouse move modes
					if(_mouseMoveMode != _MMM_NONE) return;
					
					Debug.log("Place + at " + xg + "," + yg);
	
					var sz = 32;
					_addNodeEl.style.left =
							((_grid.x0 + xg * _grid.xstep - sz/2) | 0) + "px";
					_addNodeEl.style.top =
							((_grid.y0 + yg * _grid.ystep - sz/2) | 0) + "px";					
				}
			}
			else
			{
				//if not handled, remove +			
				_addNodeEl.style.left = "-1000px"; //off screen
				
				//add +/- row column icons
				if(yg < 0) 
					doNodeHover(-10); //show top icons
				else if(xg >= _grid.cols)
					doNodeHover(-11); //show right icons
				else if(yg >= _grid.rows)
					doNodeHover(-12); //show top icons
				else if(xg < 0)
					doNodeHover(-13); //show left icons
				
				return;
			}
			
			//undo cursor changes if any
			this.style.cursor = "default";	
				
			//undo hover node, if any
			if(_mouseHoverNode != -1)
				doNodeHover(_mouseHoverNode,true /*undoHover*/);
			
		} //end handleMouseMove()

		//=====================================================================================
		//handleMouseUp ~~
		function handleMouseUp(e) 
		{	
			e.stopPropagation();
			
    		var x = e.clientX;
    		var y = e.clientY;
			
    		console.log("mouseup x,y",x,y);
    		    		
    		//debug visually
    		//_context.fillRect((x)|0,(y)|0,3,3 );
    		
    		if(_mouseMoveMode != _MMM_NONE)
    		{
    			switch(_mouseMoveMode)
    			{
    			case _MMM_ARROW_DRAG:
    				console.log("done arrow drag NO VALID END x,y",x,y);
    				_mouseMoveMode = _MMM_NONE;
    				break;    
    			case _MMM_NODE_DRAG:
    				
    				//end mousemove
    				_mouseMoveMode = _MMM_NONE;
    				
    				//see if node drag ended in open spot
    				var xg = ((x - _grid.x0 + _grid.xstep/2)/_grid.xstep);
    				var yg = ((y - _grid.y0 + _grid.ystep/2)/_grid.ystep);			

    				if(xg < 0) xg = -1; //clip to -1 for +/- icons
    				else xg |= 0;
    				if(yg < 0) yg = -1; //clip to -1 for +/- icons			
    				else yg |= 0;
    				
    				if(xg >= 0 && yg >= 0 && 
    						xg < _grid.cols && 
							yg < _grid.rows &&
							(
								_grid.rowColMap[xg] === undefined ||
								_grid.rowColMap[xg][yg] === undefined
							))
    				{
    					Debug.log("Node drag to new open spot " + 
    							xg + "," + yg);
    					_nodes[_mouseMoveStart[2]].x = xg;
    					_nodes[_mouseMoveStart[2]].y = yg;
    					
    					nodeLayoutHasChanged();
    				}
    				else
    					console.log("done node drag NO VALID END x,y",x,y);
    				
    				//re-paint to clear move
    				paint();
    				break;   

    			case _MMM_SELECT_BOX:
    				console.log("done select box",x,y);
    				_mouseMoveMode = _MMM_NONE;
    				var el = document.getElementById("selectionBoxDiv");
    				el.style.left 	= (-1000) + "px";
    				el.style.width 	= (0) + "px";
    				
    				if(!e.shiftKey)
    					_selectedNodes = {}; //clear selected nodes
    				
    				//transfer selected nodes from temporary
    				for(var n in _mouseMoveStart[2])
    					_selectedNodes[n] = 1;
    				_mouseMoveStart[2] = {}; //clear temporary selected nodes
    				paint();
    				break; 				
    			default:
    				Debug.log("Illegal mouseup _mouseMoveMode = " +
    						_mouseMoveMode, 
    						Debug.HIGH_PRIORITY);
    			}
    		} //end mousemove mode handling
    		
		} //end handleMouseUp()

		//=====================================================================================
		//handleMouseDown ~~
		function handleMouseDown(e) 
		{	
			e.stopPropagation();

    		var x = e.clientX;
    		var y = e.clientY;
    		
    		console.log("mousedown x,y",x,y);
    		
    		
			if(_mouseMoveMode == _MMM_NONE && 
					_mouseHoverNode >= 0) 
			{ //start node dragging
				var pxy = [ _grid.x0 + _nodes[_mouseHoverNode].x * _grid.xstep,
							_grid.y0 + _nodes[_mouseHoverNode].y * _grid.ystep];
				if(
						x > pxy[0] - _NODE_SIZE/2 && 
						x < pxy[0] + _NODE_SIZE/2 &&
						y > pxy[1] - _NODE_SIZE/2 &&
						y < pxy[1] + _NODE_SIZE/2) 
				{
					//shift key chooses toggling nodes
					if(e.shiftKey)
					{
						Debug.log("Toggling node select " + _mouseHoverNode);
						
						if(_selectedNodes[_mouseHoverNode] === undefined)
							_selectedNodes[_mouseHoverNode] = 1;
						else
							delete _selectedNodes[_mouseHoverNode];
						paint();
						return;
					}
					
					Debug.log("Starting node drag " + _mouseHoverNode);
					this.style.cursor = "grabbing";
					_mouseMoveMode = _MMM_NODE_DRAG;

					//start movement
					_mouseMoveStart = [ //x,y,i,p start (i,p are optional)
								x,y,_mouseHoverNode]; 
					
					//unhover node
					doNodeHover(_mouseHoverNode,true /*undoHover*/);
					
					return;
				}
			}
			
			
			if(_mouseMoveMode == _MMM_NONE)
			{ //start node selection box
				
				Debug.log("Starting select box ");
				
				//start selection box anchor
				_mouseMoveStart = [ //x,y,temp-selection-node-map
									x,y,{}]; 
				_mouseMoveMode = _MMM_SELECT_BOX;
				handleSelectionBox(e);
			}
			
		} //end handleMouseDown()
			
		//=====================================================================================
		//getNodePoint ~~
		//	returns x,y center of node point
		function getNodePoint(i,p) 
		{
			var x = _nodes[i].x;
			var y = _nodes[i].y;
			var sz = _NODE_SIZE | 0; 

			var x = (_grid.x0 + x * _grid.xstep - sz/2) | 0;
			var y = (_grid.y0 + y * _grid.ystep - sz/2) | 0;

			switch(p)
			{
			case 0: //top
				return [(x + sz/2)|0,
						(y)|0];
			case 1: //right
				return [(x + sz)|0,
						(y + sz/2)|0];
			case 2: //bottom
				return [(x + sz/2)|0,
						(y + sz - 1)|0];
			case 3: //left
				return [(x - 1)|0,
						(y + sz/2)|0];
			default:
				Debug.log("illegal point request! " + p,
						Debug.HIGH_PRIORITY);
			}
		} //end getNodePoint()
		
		//=====================================================================================
		//doNodeHover ~~
		//	handle mouse hover display of node
		function doNodeHover(i,undoHover) 
		{					
			//if attempting to hover then... 
			if(!undoHover)
			{
				//if already hovering, done
				if(_mouseHoverNode == i) return;
				//if another node was hovering, unhover it
				if(_mouseHoverNode != -1)
					doNodeHover(_mouseHoverNode,true /*undoHover*/);
				
				_mouseHoverNode = i;
			}
			else 
				_mouseHoverNode = -1; //clear mouse hover
			
			Debug.log((undoHover?"Hide ":"") + 
					"Mouse over node " + i);
			
			if(i < -1)
			{
				//do not show for mouse move modes
				if(!undoHover && _mouseMoveMode != _MMM_NONE) return; 
				
				Debug.log("This is +/- icon " + (3-(i+13)));
				document.getElementsByClassName(
						"grid-plusMinusArrows")[(3-(i+13))].style.display = 
								undoHover?"none":"block";
				return;
			}
			
			var nodeid = "node-" + i;
			var el = document.getElementById(nodeid);	
			
			//handle points
			var points = el.getElementsByClassName("node-point");		
			for(var p=0;p<4;++p)
				points[p].style.display = undoHover?"none":"block";
			
			//do not show icons for mouse move modes
			if(!undoHover && _mouseMoveMode != _MMM_NONE) return;
			
			el = document.getElementById(nodeid + "-editIcon");
			el.style.display = undoHover?"none":"block";
			el = document.getElementById(nodeid + "-viewFclIcon");
			el.style.display = undoHover?"none":"block";
			el = document.getElementById(nodeid + "-deleteIcon");
			el.style.display = undoHover?"none":"block";
			
		} //end doNodeHover()

		//=====================================================================================
		//handlePointMouseDown ~~
		function handlePointMouseDown(i,p,e) 
		{	   
			e.stopPropagation();

			Debug.log("mousedown-point i,p = " +
					i + "," + p);
			
			if(_mouseMoveMode == _MMM_NONE)
			{
				Debug.log("Starting arrow drag mouseup-point i,p = " +
						i + "," + p);
				_mouseMoveMode = _MMM_ARROW_DRAG;
				_mouseMoveStart = getNodePoint(i,p);
				_mouseMoveStart[2] = i;
				_mouseMoveStart[3] = p;
			}
			
		} //end handlePointMouseDown()
		
		//=====================================================================================
		//handlePointMouseUp ~~
		function handlePointMouseUp(i,p,e) 
		{	   
			e.stopPropagation();
			
    		Debug.log("mouseup-point i,p = " +
    				i + "," + p);

    		var x = e.clientX;
    		var y = e.clientY;
    		
    		if(_mouseMoveMode != _MMM_NONE && //dragging arrow
    				i != _mouseMoveStart[2]) //and not at same starting point
    		{
				console.log("done arrow drag end-point i,p",i,p);
				_mouseMoveMode = _MMM_NONE;    	
				
				addArrow(
						_mouseMoveStart[2] /*startNodeIndex*/,
						_mouseMoveStart[3] /*startNodePointIndex*/, 
						i /*endNodeIndex*/,
						p /*endNodePointIndex*/);
    		}
    		
		} //end handlePointMouseUp()

		//=====================================================================================
		//openActiveGroupsDialog ~~
		//	show update group options to activate
		function openActiveGroupsDialog()
		{
			//undo hover node, if any
			if(_mouseHoverNode != -1)
				doNodeHover(_mouseHoverNode,true /*undoHover*/);
			
			Debug.log("openActiveGroupsDialog()");

			_systemGroups = {}; //reset			

			//	get groups and aliases
			ConfigurationAPI.getAliasesAndGroups(
					function(retObj)
					{
				_systemGroups = retObj;
				console.log("_systemGroups",_systemGroups);
				console.log("ConfigurationAPI._activeGroups",ConfigurationAPI._activeGroups);

				localOpenActiveGroupsDialog();
					}); //end getAliasesAndGroups
			return;

			function localOpenActiveGroupsDialog()
			{	
				Debug.log("localOpenActiveGroupsDialog()");

				var ctrlStr = "";
				ctrlStr += htmlOpen("input",
						{
								"class": "closeButton",
								"type": "button",
								"style": "margin:20px;",
								"value": "Close",
								"title": "Close this dialog."
						},
						0 /*html*/, true /*closeTag*/);	

				var str = "";

				var groupTypes = ["Context","Configuration"];
				var stepString;

				for(var g=0;g<groupTypes.length;++g)
				{
					stepString = "chooseActiveGroups" + "-" +
							groupTypes[g] + "-";

					str += "Choose a '" + groupTypes[g] +
							"' group to activate (either a System Alias or specific group):";

					str += htmlClearDiv();

					str += "<center><br>";
					str += "Current active '" + groupTypes[g] +
							"' group: <b>" + 
							_systemGroups.activeGroups[groupTypes[g]].groupName + 
							"(" + 
							_systemGroups.activeGroups[groupTypes[g]].groupKey +
							")</b>";
					str += htmlClearDiv();
					str += "<br><table style='margin-bottom: 10px;'>";
					if(_systemGroups.aliases[groupTypes[g]].length)
					{
						str += "<tr><td><b>System Aliases:</b></td><td>";
						{ //start aliases
							str += htmlOpen("select",
									{
											"id" :		stepString + "aliases",
									});

							for(var i=0;i<_systemGroups.aliases[groupTypes[g]].length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.aliases[groupTypes[g]]
															  [i].alias /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end aliases dropdown
							str += htmlOpen("input",
									{
											"id": stepString + "activateAlias",
											"type": "button",
											"value": "Activate Alias",
											"title": "Activate chosen System Alias.",
									},
									0 /*html*/, true /*closeTag*/);	
						} //end aliases
						str += "</td></tr>";
					}
					else
						str += "<tr><td colspan='2'>No system aliases of type Context found.</td></tr>";

					var groupNames = Object.keys(_systemGroups.groups[groupTypes[g]]);
					if(groupNames.length)
					{
						str += "<tr><td><b>Group Names:</b></td><td>";
						{ //start groups
							str += htmlOpen("select",
									{
											"id" :		stepString + "groupNames",
									});

							for(var i=0;i<groupNames.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										groupNames[i] /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end group name dropdown

						} //end groups
						str += "</td></tr>";
					}
					else
						str += "<tr><td colspan='2'>No groups of type Context found.</td></tr>";

					if(groupNames.length)
					{
						str += "<tr><td><b>Group Keys:</b></td><td>";
						{ //start keys
							str += htmlOpen("select",
									{
											"id" :		stepString + "groupKeys",
									});

							for(var i=0;i<_systemGroups.groups[groupTypes[g]]
															   [groupNames[0]].keys.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.groups[groupTypes[g]]
															 [groupNames[0]].keys[i] /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end group keys dropdown
							str += htmlOpen("input",
									{
											"id": stepString + "activateGroup",
											"type": "button",
											"value": "Activate Group",
											"title": "Activate chosen Group and Key pair.",
									},
									0 /*html*/, true /*closeTag*/);	
						} //end keys
						str += "</td></tr>";
					}
					str += "</table>";
					str += "</center>";
				} //end group type loop

				//remove all existing dialogs
				ConfigurationAPI.removeAllPopUps();

				//make popup element
				el = document.createElement("div");			
				el.setAttribute("id", ConfigurationAPI._POP_UP_DIALOG_ID);

				ConfigurationAPI.setPopUpPosition(el,
						undefined /*w*/,
						undefined /*h*/, 
						undefined /*padding*/, 
						undefined /*border*/,
						50 /*margin*/);

				el.innerHTML = ctrlStr + htmlClearDiv() + 
						str + htmlClearDiv() + ctrlStr;
				document.body.appendChild(el);

				localAddHandlers();

				return;

				//==========
				function localAddHandlers()
				{ //start localAddHandlers			

					var closeButtons = document.getElementsByClassName("closeButton");
					for(var b=0;b<closeButtons.length;++b)
						closeButtons[b].onclick = 
								localCloseButtonHandler;

					/////////////////////////////////
					function localCloseButtonHandler()
					{
						Debug.log("localCloseButtonHandler()");

						//remove all existing dialogs
						ConfigurationAPI.removeAllPopUps();

					} //end localCloseButtonHandler()

					var stepString;
					for(var g=0;g<groupTypes.length;++g)
					{
						stepString = "chooseActiveGroups-" + 
								groupTypes[g] + "-";
						/////////////////////////////////
						document.getElementById(stepString + "activateAlias").onclick = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//activate alias then go back to record name
							var alias = document.getElementById(localStepString +
									"aliases").value;
							Debug.log("activateAlias " + alias);

							//find associated aliasObj
							var aliasObj;
							for(var i=0;i<
							_systemGroups.aliases[localGroupType].length;++i)
								if(_systemGroups.aliases[localGroupType][i].alias == 
										alias)
								{
									aliasObj = _systemGroups.aliases[localGroupType][i];
									break;						
								}

							Debug.log("activateAlias group " + aliasObj.name + 
									"-" + aliasObj.key);

							ConfigurationAPI.activateGroup(aliasObj.name, aliasObj.key, 
									true /*ignoreWarnings*/, 
									/*doneHandler*/
									function()
									{
								Debug.log("The System Alias '" + alias + 
										"' (" + aliasObj.name + " (" + 
										aliasObj.key + ")) was successfully activated!", Debug.INFO_PRIORITY);

								init();
									}); //end activate group handler
								}; //end activate alias handler

						/////////////////////////////////
						document.getElementById(stepString + "groupNames").onchange = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//fill keys drop down
							Debug.log("Filling dropdown with keys for " + this.value);
							var str = "";
							for(var i=0;i<_systemGroups.groups[localGroupType]
															   [this.value].keys.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.groups[localGroupType]
															 [this.value].keys[i] /*innerHTML*/, true /*closeTag*/);
							}
							document.getElementById(localStepString + "groupKeys").innerHTML = 
									str;
								}; //end group names dropdown handler

						/////////////////////////////////
						document.getElementById(stepString + "activateGroup").onclick = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//activate alias then go back to record name
							var name = document.getElementById(localStepString + "groupNames").value;
							var key = document.getElementById(localStepString + "groupKeys").value;

							Debug.log("activateGroup " + name + 
									"-" + key);

							ConfigurationAPI.activateGroup(name, key, 
									true /*ignoreWarnings*/, 
									/*doneHandler*/
									function()
									{
								Debug.log("The Group '" + name + " (" + 
										key + ") was successfully activated!", Debug.INFO_PRIORITY);

								init();
									}); //end activate group handler
								}; //end activate alias handler

					}
				} //end localAddHandlers

			} //end localOpenActiveGroupsDialog()
		} //end openActiveGroupsDialog()
		
		//====================================================================================
		//nodeLayoutHasChanged ~~
		//	handle when node layout has changed
		//	for now, auto-save layout for active group
		function nodeLayoutHasChanged()
		{
			Debug.log("nodeLayoutHasChanged()");

			var postData = "layout=";
			
			//post data format:
			// grid rows, cols
			// 4-field nodes (type,name,x,y)
			
			postData += _grid.rows;
			postData += "," + _grid.cols;
			
			for(var i=0;i<_nodes.length;++i)
			{
				postData += "," + getTypeName(_nodes[i].type);
				postData += "," + _nodes[i].name;
				postData += "," + _nodes[i].x;
				postData += "," + _nodes[i].y;				
			}
			
			Debug.log("postData = " + postData);
			
			//get active configuration group
			DesktopContent.XMLHttpRequest(
					"Request?RequestType=saveArtdaqNodeLayout",
					postData
					);
			
		} //end nodeLayoutHasChanged()
		
		//====================================================================================
		//addArrow ~~
		function addArrow(startNodeIndex, startNodePointIndex, endNodeIndex, endNodePointIndex)
		{
			Debug.log("addArrow " + startNodeIndex + "-" +
					startNodePointIndex + " to " + 
					endNodeIndex + "-" + endNodePointIndex);
			
			//add arrow to array if new
			if(_arrows[startNodeIndex] === undefined)				
				_arrows[startNodeIndex] = {};
			if(_arrows[startNodeIndex][endNodeIndex] === undefined)
			{
				_arrows[startNodeIndex][endNodeIndex] = 
					{
							"p0":startNodePointIndex,
							"p1":endNodePointIndex
					}; //arrow made
				paint();
			}
			else
			{
				Debug.log("Connection already exists!",
						Debug.HIGH_PRIORITY);
			}
		} //end addArrow()
		
		</script>
</head>
	

<body onload='Javascript:init();'>	
		
	<!-- body content populated by javascript paint(), etc. -->

	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
	<div class='preloadImage' id='preloadImage-treeEditIconHover'></div>

	<canvas id='theGridCanvas'></canvas>
	<div id='preCanvas'></div>
	<canvas id='theCanvas'></canvas>
	<canvas id='theActionCanvas'></canvas>
	<div id='postCanvas'></div>
		
	<div id='createNodeDiv'>
		<a id='createNode' onclick='createNode(); return false;'
				title='Create a new node'>+</a>
	</div>
		
	<div id='selectionBoxDiv'></div>
		
	<!-- Controls pane, Copied from Code Editor -->
	<div class="controlsPane">
		<div 	id="directoryNavToggle" 
				class="controlsButton"						
				style="float:left"
				onclick="event.stopPropagation(); openActiveGroupsDialog();" 
				title="Choose the active configuration (Ctrl + D)">
			<div 	id="directoryNavToggleTop"></div>
			<div 	id="directoryNavToggleBottom"></div>
		</div>
		<div 	id="saveFile"
				class="controlsButton" 
				style="float:left;" 
				onclick="event.stopPropagation(); save();"
				title="Click to Save changes to the active configuration (Ctrl + S)">
			<div 	id="saveFileMain"></div>
			<div 	id="saveFileMainTop"></div>
			<div 	id="saveFileMainBottom"></div>
		</div>
	</div>
	<!-- End controls pane, Copied from Code Editor -->
		
</body>
	
</html>
