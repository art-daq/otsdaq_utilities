<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>artdaq ConfigurationGUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<style type="text/css">			
		
		/* CSS Reset */
		html{color:white;background:#FFF}
		body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,code,form,fieldset,legend,input,textarea,p,blockquote,th,td{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}address,caption,cite,code,dfn,em,strong,th,var{font-style:normal;font-weight:normal}ol,ul{list-style:none}caption,th{text-align:left}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:normal}q:before,q:after{content:''}abbr,acronym{border:0;font-variant:normal}sup{vertical-align:text-top}sub{vertical-align:text-bottom}input,textarea,select{font-family:inherit;font-size:inherit;font-weight:inherit;*font-size:100%}
		legend{color:#000}	
		* {
			margin: 				0;
			spacing: 				0;
			padding: 				0;
			border: 				0;
			color: 					white;
			-webkit-user-select: 	none; /* prevent highlight selection (does not stop ghost images, must use el.ondragstart = function() {return false;}; */
			-moz-user-select: 		none;
			user-select:			none;
			outline: 				none;  /* to stop firefox selection*/	
			font-family: 			'Comfortaa', serif; /*'Donegal One', serif;*/		
			font-size: 				20px;
		}
		
		/* make buttons and links have a hand cursor */
		input[type="button"], button, a {
			cursor: pointer;
		}
		
		#theCanvas, #theActionCanvas, #preCanvas, #postCanvas {
			position: 				absolute;
			left: 					0;
			top: 					0;
		}
		
		.node {
			position:				absolute;
			cursor:					pointer;			
		}
		
		.node-box {
			background-color : 		rgb(241, 231, 231);
			overflow: 				auto;

			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
									inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
									rgba(200, 200, 200,0.6) 0 .1em 3px,
									rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
									rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
			border-radius: 			3px;	
			
			position:				relative;
			cursor:					pointer;
		}
		
		.node:hover .node-box{

			background-color: 		rgb(230, 201, 201);

			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
									inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
									rgba(200, 200, 200,0.6) 0 .1em 3px,
									rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
									rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
		}		
		
		#recordAddDiv {
			background-color: 		rgb(195, 230, 193);	
			cursor:					pointer;
			width: 					32px;
			height: 				32px;
			border-radius: 			32px;
			border: 				1px solid rgb(6, 82, 9);
			
			box-shadow: 			inset rgba(255,254,255,0.6) 0 0.3em .3em,
									inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
									rgba(200, 200, 200,0.6) 0 .1em 3px,
									rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
									rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
			
			left:					10px;
			top:					10px;
			position: 				absolute;
		    z-index:				2000; 	/* to place on top of everything */
		}
		
		#recordAddDiv:hover {
			background-color: 		rgb(215, 255, 213);			
		}

		#recordAdd {
			margin: 				1px 16px -10px 8px;
			float:					left;
			
			text-decoration: 		none;			
			font-size: 				30px;
			font-weight: 			bold;
			color: 					rgb(15, 152, 76);
		}
		
		
		.treeNode-Value-editIcon {			
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEdit.png);
			width: 				24px;
			height: 			20px;
			float: 				left;
			border: 			0;
			margin: 			-2px 0 -7px 10px;
			display:			none;
		}
		.treeNode-Value-editIcon:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEditHover.png);
			cursor: 			pointer;
		}
		
		.treeNode-deleteIcon {			
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCan.png);
			width: 				16px;
			height: 			20px;
			border: 			0;
			margin: 			-9px 0 -10px 10px;
		}
		.treeNode-deleteIcon:hover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
			cursor: 			pointer;
		}
    	

		.preloadImage {			
			width: 				24px;
			height: 			20px;
			position:			absolute;
			left: 				-100px;
			top: 				0;
		}
		#preloadImage-treeEditTrashIconHover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-trashCanHover.png);
		}
		#preloadImage-treeEditIconHover {
			background-image: 	url(/WebPath/images/windowContentImages/ConfigurationGUI-pencilEditHover.png);
		}
		
	</style>
	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>
	
	<script>		
		
		//	Description of Configuration-artdaq Functionality/Behavior:
		//	
		//	- Requires user to have LOCK
		//
		//	- Grid always stretches to full window size
		//	and defines scale (allow adding row/col of dots at either side)
		//		
		//	- Save functionality should be same as saving tree	
		//		* If admin, could give options to target a certain system alias.. Etc.
		//		* Else assume saving to currently active groups
		//	- Save/Load positioning maps to filename based on active Context group.
		//
		//	- On load, get active groups artdaq modules.. allow editing, deleting, adding.. 
		//	and connecting sources and destinations
		
	
		//paint globals -------------
		var _SCALE; //controls the zoom and look of everything	
		var _NODE_SIZE;
		var _CANVAS_MARGIN		= 0;
		var _GRID_MARGIN		= 100;
		var _CANVAS_COLOR 		= "rgba(255,255,255,0)";
		var _GRID_COLOR 		= "rgb(218, 194, 194)";
		var _SHADOW_COLOR 		= "gray";
		var _canvas, _context, _actionCanvas, _actionContext;
		var _preCanvas, _postCanvas;
		var _w, _h;		
		
		//object globals -------------
		var _grid = { //size of grid, rows and cols can be added or removed
				"rows": 4, 	"cols": 3, 
				"x0": 	0, 	"y0": 	0, 
				"xstep":0, 	"ystep":0}; 
		var _nodes = []; 	// array of node objects
							//	node: 	{type,x-grid,y-grid}
		var _arrows = []; 	//array of arrow objects 
							//	arrow:	{x0,y0,p0, x1,y1,p1} (start and end x,y,p - where p is one of 4 positions starting from top going clock-wise)
				
		//constant globals -------------
		var _NODE_TYPE_READER 		= 0;
		var _NODE_TYPE_BUILDER 		= 1;
		var _NODE_TYPE_LOGGER 		= 2;
		var _NODE_TYPE_MONITOR 		= 3;
		var _NODE_TYPE_DISPATCHER 	= 4;
		
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:			
			//init()
			//paint()
			//drawGrid() 
			//drawNode() 
			//contextAddContextShadow() 
			
			//handleNodeMouseOver(e)
			//handleMouseMove(e)
			//handleMouseUp(e)
				
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
				

		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init() 
		{									
			Debug.log("CfgGUI_artdaq init ");			
			
			

			//			DesktopContent.tooltip("Configuration-Subset GUI Introduction",
			//					"Welcome to the Configuration-Subset GUI targeting " + _recordsAlias + 
			//					". Here you can manipulate the fields "+
			//					"of a subset of your <i>otsdaq</i> system. \n\n" +
			//					"The organization of the Configuration-Subset GUI is in the form of two panes, a left and right.\n\n" +
			//
			//					"Briefly, here is a description of the two panes: " +
			//					"\n\t- 'Left Pane' is for selecting one or many records to target." +
			//					"\n\t- 'Right Pane' is for modifying the common fields associated with the selected records."
			//			);

			var x = 0;
			var y = 0;
			_nodes.push({"type":_NODE_TYPE_READER,	"x":x++, 	"y":y});			
			_nodes.push({"type":_NODE_TYPE_BUILDER,	"x":x++, 	"y":y});			
			_nodes.push({"type":_NODE_TYPE_LOGGER,	"x":x++, 	"y":y});
			x = 0;
			y++;
			_nodes.push({"type":_NODE_TYPE_MONITOR,	"x":x, 	"y":y});			
			_nodes.push({"type":_NODE_TYPE_DISPATCHER,	"x":x++, 	"y":y});
				
			_arrows.push({	"x0":0,"y0":2,"p0":1,
							"x1":3,"y1":3,"p0":0,});
									

			_preCanvas = document.getElementById("preCanvas");
			_postCanvas = document.getElementById("postCanvas");
			
			_canvas = document.getElementById("theCanvas");
			_canvas.style.backgroundColor = _CANVAS_COLOR;
			_context = _canvas.getContext('2d');
			_actionCanvas = document.getElementById("theActionCanvas");
			_actionCanvas.style.backgroundColor = _CANVAS_COLOR;
			_actionContext = _actionCanvas.getContext('2d');
			
			paint();
			window.addEventListener("resize",paint);
			
			DesktopContent.mouseMoveSubscriber(handleMouseMove);
			document.body.addEventListener("mouseup",handleMouseUp);
						
		} //end init()		

		//=====================================================================================
		//handleNodeMouseOver ~~
		function handleNodeMouseOver(e)
		{
			var id = this.id.split('-')[1] | 0;
			Debug.log("MouseOver Node id = " + id);
			
		} //end handleNodeMouseOver()
		
		//=====================================================================================
		//paint ~~
		//	paint grid and nodes based on 
		//	_grid and _nodes global variable and window size
		function paint() 
		{	
			_w = DesktopContent.getWindowWidth();
			_h = DesktopContent.getWindowHeight();
			
			console.log("_grid",_grid);
			console.log("_nodes",_nodes);
			console.log("_arrows",_arrows);

			var MIN_H = 280;
			var MIN_W = 280;
			if(_w < MIN_W)
				_w = MIN_W;
			if(_h < MIN_H)
				_h = MIN_H;
			
			Debug.log("paint w,h=" + _w + "," + _h);

			_canvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_canvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_canvas.width = (_w - _CANVAS_MARGIN*2);
			_canvas.height = (_h - _CANVAS_MARGIN*2);
			_context.clearRect(0, 0, _canvas.width, _canvas.height);
			
			_actionCanvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.width = (_w - _CANVAS_MARGIN*2);
			_actionCanvas.height = (_h - _CANVAS_MARGIN*2);
			_actionContext.clearRect(0, 0, _canvas.width, _canvas.height);

			drawGrid();

			//determine node size and then draw
			_SCALE = 1;
			_NODE_SIZE = _grid.xstep*0.5;
			if(_NODE_SIZE > _grid.ystep*0.5)
				_NODE_SIZE = _grid.ystep*0.5;
			
			for(var i=0;i<_nodes.length;++i)							
				drawNode(i);
			
		} //end paint()

		//=====================================================================================
		//drawGrid ~~
		function drawGrid() 
		{	
			//determine grid spacing
			_grid.xstep = (_w - 2*_GRID_MARGIN)/_grid.cols;			
			_grid.ystep = (_h - 2*_GRID_MARGIN)/_grid.rows;
			
			if(_grid.xstep < 0 || _grid.ystep < 0)
			{
				Debug.log("Window size is too small!",Debug.HIGH_PRIORITY);
				return;
			}
						
			_grid.x0 = _GRID_MARGIN + _grid.xstep/2;
			_grid.y0 = _GRID_MARGIN + _grid.ystep/2;

			console.log("drawGrid _grid",_grid);
			
			_context.save();
			_context.fillStyle   	= _GRID_COLOR;
			contextAddContextShadow();
			
			//_context.fillRect(10,10,100,100);
					
			var r,c;
			for(r=0;r<_grid.rows;++r)
				for(c=0;c<_grid.cols;++c)
					_context.fillRect(
							(_grid.x0 + c*_grid.xstep)|0,
							(_grid.y0 + r*_grid.ystep)|0,							
							3,3 /*size w,h in pixels*/);
			
			_context.restore();
		} //end drawGrid()

		//=====================================================================================
		//drawNode ~~
		//	draw a node of specified by node index 
		function drawNode(i)
		{
			var type = _nodes[i].type;
			var x = _nodes[i].x;
			var y = _nodes[i].y;
			
			var nodeid = "node-" + i;
						
			var sz = (_NODE_SIZE*_SCALE)|0; 
			x = (_grid.x0 + x * _grid.xstep - sz/2) | 0;
			y = (_grid.y0 + y * _grid.ystep - sz/2) | 0;
			
			Debug.log("x,y,sz = " + x + "," + y + "," + sz);
			
			var typeClass = 
					type == _NODE_TYPE_READER? "nodeReader":
					type == _NODE_TYPE_READER? "nodeBuilder":
					type == _NODE_TYPE_READER? "nodeLogger":
					type == _NODE_TYPE_READER? "nodeMonitor": "nodeDispatcher";
			
			Debug.log("nodeid = " + nodeid + "; typeClass = " + typeClass);

			//if node exists, get element
			var el = document.getElementById(nodeid);	
			var boxEl;
			if(!el) //else create it
			{
				el = document.createElement("div"); 
				el.setAttribute("class", "node " + typeClass);
				el.setAttribute("id", "node-" + nodeid);
								
				//draw connect source, pencil, and trashcan
				var str = "";
				str += "<div id='" + nodeid + "-box' class='node-box'></div>";
				el.innerHTML = str;
				_postCanvas.appendChild(el);	
				el.onmouseover = handleNodeMouseOver;	
			}			
			
			boxEl = document.getElementById(nodeid + "-box");
		
			boxEl.style.width  = sz + "px";
			boxEl.style.height = sz + "px";
			el.style.left 	= x + "px";
			el.style.top 	= y + "px";			
			
		} //end drawNode()
		
		//=====================================================================================
		//contextAddContextShadow ~~
		function contextAddContextShadow() 
		{	
			//_context.strokeStyle  	= _GRID_COLOR;
			//_context.lineWidth     	= 2;
			_context.shadowOffsetX 	= 4;
			_context.shadowOffsetY 	= 4;
			_context.shadowBlur    	= 7;
			_context.shadowColor	= _SHADOW_COLOR;
			
		} //end contextAddContextShadow()

		//=====================================================================================
		//handleMouseMove ~~
		function handleMouseMove(e) 
		{	
    		var x = e.clientX;//- this.offsetLeft - _CANVAS_MARGIN - 2;
    		var y = e.clientY;//- this.offsetTop - _CANVAS_MARGIN - 2;
			
    		//console.log("mousemove x,y",x,y);
    		
    		//debug visually
    		//_context.fillRect((x)|0,(y)|0,3,3 );
    		
    		//steps:
    		//	if over empty grid, show + 
    		//	if mousedown, draw arrow or dragging object
    		
		} //end handleMouseMove()

		//=====================================================================================
		//handleMouseUp ~~
		function handleMouseUp(e) 
		{	
    		var x = e.clientX;//- this.offsetLeft - _CANVAS_MARGIN - 2;
    		var y = e.clientY;//- this.offsetTop - _CANVAS_MARGIN - 2;
			
    		console.log("mouseup x,y",x,y);
    		
    		//debug visually
    		_context.fillRect((x)|0,(y)|0,3,3 );
    		
		} //end handleMouseUp()
		
		</script>
</head>
	

<body onload='Javascript:init();'>	
		
	<!-- body content populated by javascript paint(), etc. -->

	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
	<div class='preloadImage' id='preloadImage-treeEditIconHover'></div>

	<div id='preCanvas'></div>
	<canvas id='theCanvas'></canvas>
	<canvas id='theActionCanvas'></canvas>
	<div id='postCanvas'></div>
	
	<div id='recordAddDiv'>
		<a id='recordAdd' onclick='createNode(); return false;'
				title='Create a new node'>+</a>
	</div>
</body>
	
</html>
