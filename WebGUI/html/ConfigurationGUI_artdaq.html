<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>artdaq Configuration GUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI_artdaq.css">
	
	<style type="text/css">
	/* do not use html style -- instead use ConfigurationGUI_artdaq.css (for readability)*/
	</style>	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ArtdaqConfigurationAPI.js"></script>
	
	<script>		
		
		//	Description of Configuration-artdaq Functionality/Behavior:
		//	
		//	- Requires user to have LOCK
		//
		//	- Grid always stretches to full window size
		//	and defines scale (allow adding row/col of dots at either side)
		//		
		//	- Save functionality should be same as saving tree	
		//		* If admin, could give options to target a certain system alias.. Etc.
		//		* Else assume saving to currently active groups
		//	- Save/Load positioning maps to filename based on active Context group.
		//
		//	- On load, get active groups artdaq modules.. allow editing, deleting, adding.. 
		//	and connecting sources and destinations
		
	
		//paint globals -------------		
		var _NODE_SIZE; //everything else should be sized off of this, and grid steps
		var _CANVAS_MARGIN		= 0;
		var _GRID_MARGIN		= 100;
		var _CANVAS_COLOR 		= "rgba(255,255,255,0)";
		var _GRID_COLOR 		= "rgb(218, 194, 194)";
		var _ARROW_COLOR 		= "rgb(70, 67, 67)";
		var _SHADOW_COLOR 		= "gray";
		var _GRID_ROW_MIN		= 2;
		var _GRID_COL_MIN		= 3;

		var _MENU_PRIMARY_COLOR = "rgb(220, 220, 220)";
		var _MENU_SECONDARY_COLOR = _ARROW_COLOR;
		
		var _gridCanvas, _gridContext, _canvas, _context, _actionCanvas, _actionContext;
		var _preCanvas, _postCanvas;
		var _addNodeEl;
		var _w, _h;		
		
		//object globals -------------
		var _grid = { //size of grid, rows and cols can be added or removed
				"rows": _GRID_ROW_MIN, 	"cols": _GRID_COL_MIN, 
				"x0": 	0, 	"y0": 	0, 
				"xstep":0, 	"ystep":0}; 
		var _nodes = []; 	// array of node objects (can be multi-node vector at location, using nodeCount and nodeVectorIndexArr
							//	node: 	{type, name, hostname, subsystemId, originalName, xGrid, yGrid, nodeCount, nodeVectorIndexArr, nodeVectorIndexReverseMap, nodeVectorIndexString, hostnameVectorIndexArr, hostnameVectorIndexReverseMap, hostnameVectorIndexString, hostnameFixedWidth}
		var _arrows = {}; 	//multi-dim map of arrow objects 
							//	arrow:	[i0][i1] = {p0,p1} (start and end i,p - where i := node index, p := 1 of 4 positions starting from top going clock-wise)
		
		var _nodesByType = {};		
		var _selectedNodes = {}; //selected nodes get highlighted with paint()
		
		var _subsystems = {}; //object describing artdaq subsystems
						// id: {label, sourcesCount, destinationId}
		
		var _hostnames = {}; //set of hostnames (i.e. map to 1)
		
		//constant globals -------------		
		var _MMM_NONE				= 0;
		var _MMM_ARROW_DRAG			= 1;
		var _MMM_NODE_DRAG			= 2;
		var _MMM_SELECT_BOX			= 3;
		var _MMM_POPUP_DIALOG		= 4;
		
		//mousemove globals -------------
		var _mouseMoveMode = _MMM_NONE;
		var _mouseMoveStart = [0,0,0,0]; //x,y,i,p start (i,p are optional)
		var _mouseHoverNode = -1;

		//configuration globals -------------
		var _modifiedTables;
		var _systemGroups = {};
		var _firstInit = true;
		var _codeEditorAppId = 0; //to open fcl in code editor
		var _layoutHasChanged = false;
		var _nodesHaveChanged = false;
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////

		//=====================================================================================
		//htmlOpen ~~		
		//	tab name and attribute/value map object
		function htmlOpen(tag,attObj,innerHTML,doCloseTag)
		{
			var str = "";
			var attKeys = Object.keys(attObj); 
			str += "<" + tag + " ";
			for(var i=0;i<attKeys.length;++i)
				if(attKeys[i] == "selected") str += (attObj[attKeys[i]]|0)?" selected ":""; //no value
				else if(attKeys[i] == "checked") str += (attObj[attKeys[i]]|0)?" checked ":""; //no value
				else if(attKeys[i] == "") continue; //skip empty key
				else
					str += " " + attKeys[i] + "='" +
					attObj[attKeys[i]] + "' ";
			str += ">";
			if(innerHTML) str += innerHTML;
			if(doCloseTag)
				str += "</" + tag + ">";
			return str;
		} // end htmlOpen()

		//=====================================================================================
		//htmlClearDiv ~~		
		function htmlClearDiv()
		{
			return "<div id='clearDiv'></div>";
		} //end htmlClearDiv()
		
		//functions:
			//htmlOpen()
			//htmlClearDiv()
			//init()	
			//initArrows()
			//save()
			//saveLayout(completionHandler)
		
			//openActiveGroupsDialog()
			//nodeLayoutHasChanged()
			//nodesHaveChanged(hasChanged)
			//addArrow(startNodeIndex, startNodePointIndex, endNodeIndex, endNodePointIndex)
					
			//paint()
			//drawGrid() 
			//drawNode(i,xoff,yoff) 
			//drawArrow() 
		
			//getNodePoint(i,p)
			//doNodeHover(i)
			//getTypeIndex(typeName)
			//getTypeName(typeIndex)
			//getEmptyGridSpot(type)
			//plusMinusGrid(isPlus,directionIndex)
			//getNodeFontSize()
		
			//handleNodeMouseOver(e)
			//handleMouseMove(e)
			//handleMouseUp(e)
			//handleMouseDown(e)
		
			//handlePointMouseUp(i,p,e)
			//		localHandleCleanup()
			//handlePointMouseDown(i,p,e)
		
			//handleEditIconMouseUp(i,e)
			//handleEditIconMenuSelection(i)
			//launchEditNodeDialog(i)
			//		localCloseButtonHandler()
			//		getElementById("ediNode-" + "saveNode").onclick()
			//handleEditNodeDialogMultiNodeCheckbox(i)
			//handleEditNodeDialogHostnameArrayCheckbox(i)
			//handleEditNodeDialogHostnameFixedWidthCheckbox(i)
			//handleEditNodeSelectEditIcon(t)
		
			//handleFclIconMouseUp(i,e)
			//handleDeleteIconMouseUp(i,e)
		
			//getSubsystemColor(subsystemId)
				
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
				

		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init() 
		{									
			Debug.log("CfgGUI_artdaq init ");			
			
			var windowTooltip = "Welcome to the <i>artdaq</i> Configuration GUI. Here you can manipulate every configuration " +
					"parameter associated with the <i>artdaq</i> nodes in your system. \n\n" +
					"The organization of the <i>artdaq</i> Configuration GUI is as follows: " +
					"there are control buttons at the top-left of the window, and the body of the window" +
					" is an interactive grid for editing the <i>artdaq</i> nodes in your system. \n\n" +
					"There are two control buttons at the top-left of the window, along with a status string: \n\n" +
					"\n\t- <b>Choose Active Configuration:</b>\n<INDENT>This button opens a dialog to select the active Context and Configuration group, which together fully define the <i>artdaq</i> nodes in your system.</INDENT>" +
					"\n\t- <b>Save Changes:</b>\n<INDENT>This buttons saves any changes your make to the <i>artdaq</i> node topology and settings, and will create and activate new a Context and Configuration group depending on the changes made.</INDENT>" +
					"\n\t- <b>Status string:</b>\n<INDENT>A multi-color status string will appear, next to the buttons, in context with user actions.</INDENT>" +
					"\n\n" +
					"The remaining body of the window is a canvas for visualizing and manipulating <i>artdaq</i> nodes. Briefly, here is a description of the main canvas: \n\n" +
					"\n\t- <b>Grid:</b>\n<INDENT>The grid is an X,Y coordinate plane purely for visualization convenience. <i>artdaq</i> nodes can be create, dragged, and placed at each X,Y coordinate. The grid can be re-sized by adding rows and columns using the arrows at each edge of the grid..</INDENT>" +
					"\n\t- <b>Nodes:</b>\n<INDENT>Each <i>artdaq</i> node or multi-node is represented by a square at an X,Y coordinate position on the grid. Hovering your mouse cursor over a node will bring up icons for manipulating the node. Nodes can be repositioned by dragging the node. Nodes can be connected to other nodes by dragging from one of the four anchors to another node's anchor. Making arrow connections has implications on subsystem topology; also, only certain node types are valid connections. Pop-up context errors and info will validate attempted user connections.</INDENT>" +
					"\n\t- <b>Subsystems:</b>\n<INDENT>The subsystem concept in <i>artdaq</i> defines the rules for data transfer between node types. Subsystem are color coordinated in the <artdaq> Configuration GUI.</INDENT>" +
					"\n\t- <b>Arrows:</b>\n<INDENT>Arrows indicate data flow from one node to another, and from one subsystem to another.</INDENT>" +
					"\n\n" +
					"";


			DesktopContent.tooltip("artdaq Configuration GUI Introduction",
					windowTooltip
			);
			DesktopContent.setWindowTooltip(windowTooltip);

		
			if(0) //example nodes and arrows
			{
				var x = 0;
				var y = 0;
				_nodes.push({"type":ArtdaqConfigurationAPI.NODE_TYPE_READER,	"x":x++, 	"y":y});			
				_nodes.push({"type":ArtdaqConfigurationAPI.NODE_TYPE_BUILDER,	"x":x++, 	"y":y, "nodeCount": 5});			
				_nodes.push({"type":ArtdaqConfigurationAPI.NODE_TYPE_LOGGER,	"x":x++, 	"y":y, "nodeCount": 2});
				x = 0;
				y++;
				_nodes.push({"type":ArtdaqConfigurationAPI.NODE_TYPE_MONITOR,	"x":x, 	"y":y});			
				_nodes.push({"type":ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER,	"x":x++, 	"y":y});

				_arrows[1] = {};
				_arrows[1][0] = {"p0":1,"p1":0};

			}
						
			
			//init configuration members
			_modifiedTables = undefined; //reset
			
			_grid = { //size of grid, rows and cols can be added or removed
							"rows": _GRID_ROW_MIN, 	"cols": _GRID_COL_MIN, 
							"x0": 	0, 	"y0": 	0, 
							"xstep":0, 	"ystep":0}; 
			
			_nodes = []; 
			_arrows = {};
			_nodesByType = {};
			_selectedNodes = {};
			_subsystems = {};
			_hostnames = {};
			
			
			//fill in CodeEditor appId
			DesktopContent.XMLHttpRequest("Request?RequestType=getAppId" + 
					"&classNeedle=ots::CodeEditorSupervisor",
					"", //end post data, 
					function(req) 
					{
				_codeEditorAppId = DesktopContent.getXMLValue(req,"id") | 0;
				Debug.log("_codeEditorAppId " + _codeEditorAppId);
					}, //end handler
					0, 0, 0,//reqParam, progressHandler, callHandlerOnErr, 
					false,//doNotShowLoadingOverlay,
					true //targetSupervisor
			); //end getAppId request
			
			
			//////////////
			ArtdaqConfigurationAPI.getArtdaqNodes(
					function(artdaqObj)
					{
				console.log("artdaqObj",artdaqObj);
				
				//get active configuration group
				DesktopContent.XMLHttpRequest("Request?RequestType=loadArtdaqNodeLayout",
						"", //end post data, 
						function(req) 
						{
					//Steps:
					//	if layout, 
					//		for each matching node in layout, place, delete from artdaqObj 
					//  for each remaining node, then use default behavior to place nodes
					
					// build _nodes and _nodesByType
					
					// Then, get artdaqSourcesAndDestinations
					
					var rows = DesktopContent.getXMLValue(req,"grid-rows");
					var cols = DesktopContent.getXMLValue(req,"grid-cols");
					
					if(!rows || rows == "" || !cols || cols == "")
					{
						//setup default grid
						rows = Math.ceil(Math.sqrt(artdaqObj.nodeCount));
						cols = rows + 1;
					}
					_grid.rows = rows | 0;
					_grid.cols = cols | 0;
					if(_grid.rows < _GRID_ROW_MIN)
						_grid.rows = _GRID_ROW_MIN;
					if(_grid.cols < _GRID_COL_MIN)
						_grid.cols = _GRID_COL_MIN;
					
					console.log("_grid",_grid);
					
					var layoutNodesType = req.responseXML.getElementsByTagName("node-type");
					var layoutNodesName = req.responseXML.getElementsByTagName("node-name");
					var layoutNodesX 	= req.responseXML.getElementsByTagName("node-x");
					var layoutNodesY	= req.responseXML.getElementsByTagName("node-y");
					
					//for every type, node match.. add to _nodes.. and delete from artdaqObj
					for(var i=0;i<layoutNodesType.length;++i)
					{
						var type = layoutNodesType[i].getAttribute('value');
						var name = layoutNodesName[i].getAttribute('value');
						if(artdaqObj[type] && 
								artdaqObj[type][name])
						{
							Debug.log("Found " + name);

							//enter in hostnames
							_hostnames[artdaqObj[type][name].hostname] = 1;
									   
							//add to nodes
							_nodes.push({
								"type": 		getTypeIndex(type),
								"name": 		name,
								"originalName": name, //useful when saving
								"hostname":		artdaqObj[type][name].hostname,
								"subsystemId":	artdaqObj[type][name].subsystemId,
								"x":			layoutNodesX[i].getAttribute('value')|0,
								"y":			layoutNodesY[i].getAttribute('value')|0});
							
							//remove from nodes object to keep remainder accurate 
							delete artdaqObj[type][name];
							
						}
						else //not found, so do not represent anymore
							Debug.log("Not Found " + name);
					}
					
					console.log("nodes in layout",_nodes);
					
					//now add remaining nodes to layout automatically
					
					for(var t in ArtdaqConfigurationAPI.NODE_TYPES)
					{
						t = ArtdaqConfigurationAPI.NODE_TYPES[t];
						console.log("Type",t);

						for(var n in artdaqObj[t])
						{	
							console.log("Type",t,"Name",n);

							var typeIndex = getTypeIndex(t);
							var xy = getEmptyGridSpot(typeIndex);

							//enter in hostnames
							_hostnames[artdaqObj[t][n].hostname] = 1;
									   							
							//add to nodes
							_nodes.push({
								"type": 		typeIndex,
								"name": 		n,	
								"originalName": n, //useful when saving
								"hostname":		artdaqObj[t][n].hostname,
								"subsystemId":	artdaqObj[t][n].subsystemId,
								"x":			xy[0],
								"y":			xy[1]});
						}
					}
					
					console.log("all nodes",_nodes);
					
					_subsystems = artdaqObj.subsystems;
					
					console.log("all subsystems",_subsystems);
					
					
					//build arrow connections now
					initArrows();
					
					localFinishInit();
						} //end loadArtdaqNodeLayout handler
				); //end loadArtdaqNodeLayout call
				
					}, //end getArtdaqApps handler
					_modifiedTables); //end getArtdaqApps call
			
			return;
			

			//=================
			function localFinishInit()
			{				
				//only continue if the first time in init()
				if(!_firstInit) 
				{
					paint();
					return;
				}		
				//else first time!
				
				_firstInit = false; //only finish init once
	
				_preCanvas = document.getElementById("preCanvas");
				_postCanvas = document.getElementById("postCanvas");
				_addNodeEl = document.getElementById("createNodeDiv");
	
				_canvas = document.getElementById("theCanvas");
				_canvas.style.backgroundColor = _CANVAS_COLOR;
				_context = _canvas.getContext('2d');
				_actionCanvas = document.getElementById("theActionCanvas");
				_actionCanvas.style.backgroundColor = _CANVAS_COLOR;
				_actionContext = _actionCanvas.getContext('2d');
				_gridCanvas = document.getElementById("theGridCanvas");
				_gridCanvas.style.backgroundColor = _CANVAS_COLOR;
				_gridContext = _gridCanvas.getContext('2d');
	
				paint();
				window.addEventListener("resize",paint);
	
				//DesktopContent.mouseMoveSubscriber(handleMouseMove); //causes problems because of this.style.cursor handling 
				document.body.addEventListener("mousemove",handleMouseMove);
				document.body.addEventListener("mouseup",handleMouseUp);
				document.body.addEventListener("mousedown",handleMouseDown);
				document.body.addEventListener("keydown",handleMouseMove);
				document.body.addEventListener("keyup",handleMouseMove);
			} //end localFinishInit()									
			
		} //end init()	

		//=====================================================================================
		//save ~~
		function save()
		{
			Debug.log("save()");
			
			//create node object by type for save function from _nodes array
			//		nodeObj := {}
			//			nodeObj.<nodeType> = {}
			//			nodeObj.<nodeType>.<nodeName> = {originalName,hostname,subsystemName,(nodeArrString),(hostnameArrString),(hostnameFixedWidth)}
			//
			// <nodeType> = ArtdaqConfigurationAPI.NODE_TYPES := reader, builder, aggregator, dispatcher, monitor
			//
			//		subsystemObj = {}
			//			subsystemObj.<subsystemName> = {destinationName}
			var nodesObj = {};
			var subsystemsObj = {};

			var types = ArtdaqConfigurationAPI.NODE_TYPES;

			for(var i=0;i<types.length;++i)
				nodesObj[types[i]] = {};
			
			var type,name,node;
			for(var i=0;i<_nodes.length;++i)
			{
				node = _nodes[i];				
				type = types[node.type];

				name = node.name;
				nodesObj[type][name] = {};
				nodesObj[type][name].originalName = node.originalName;
				nodesObj[type][name].hostname = node.hostname;
				nodesObj[type][name].subsystemName = _subsystems[node.subsystemId].label;
				if(node.nodeCount > 1)
				{
					Debug.log("Saving multi-node...");
					nodesObj[type][name].nodeArrString = node.nodeVectorIndexString;
					
					if(node.hostname.indexOf('*') >= 0)
					{
						nodesObj[type][name].hostnameArrString = node.hostnameVectorIndexString;
						if(node.hostnameFixedWidth && node.hostnameFixedWidth > 1)
							nodesObj[type][name].hostnameFixedWidth = node.hostnameFixedWidth;							
					}					
				} //end multi-node handling
			
				subsystemsObj[_subsystems[node.subsystemId].label] = {};
				if(subsystemsObj[_subsystems[node.subsystemId].label].destinationName !== undefined &&
						subsystemsObj[_subsystems[node.subsystemId].label].destinationName != 
								_subsystems[_subsystems[node.subsystemId].destinationId].label)
				{
					//should never have a destination mismatch
					Debug.log("Illegal destination mismatch! Notify admins.", Debug.HIGH_PRIORITY);
					return;
				}
				subsystemsObj[_subsystems[node.subsystemId].label].destinationName =
						_subsystems[_subsystems[node.subsystemId].destinationId].label;
			}
			
			ArtdaqConfigurationAPI.saveArtdaqNodes(nodesObj, subsystemsObj,
					function(response)
					{
				console.log("response",response);
				
				Debug.log("save() complete");				
				nodesHaveChanged(false);
				
				//always save layout just in case
				saveLayout(function()
						{
					Debug.log("Changes have been successfully saved!",
							Debug.INFO_PRIORITY);							
						}); //end saveLayout completion handler
					}); //end saveArtdaqNodes response handler
		} //end save()	
		
		//=====================================================================================
		//initArrows ~~
		function initArrows()
		{
			Debug.log("initArrows()");
			_arrows = {}; //reset
			
			//	 .. arrows should get generated at startup based on subsystem settings.
			//	Readers -> all builders of same subsystem
			//	Builders -> all loggers of same subsystem AND builders of destination subsystem
			//	Loggers -> all dispatchers of same subsystem

			for(var i=0;i<_nodes.length;++i)
			{
				if(_nodes[i].type == ArtdaqConfigurationAPI.NODE_TYPE_READER)
				{
					//connect to all board readers at destination
					for(var j=0;j<_nodes.length;++j)
						if(_nodes[j].type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found reader-builder connection at nodes " + 
									i + " ==> " + j);
							
							addArrow(i,j);
						}
				}
				else if(_nodes[i].type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER)
				{
					var destinationId = _subsystems[_nodes[i].subsystemId].destinationId|0;
					
					//connect to all board readers at destination
					for(var j=0;j<_nodes.length;++j)
						if(_nodes[j].type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found builder-logger connection at nodes " + 
									i + " ==> " + j);

							addArrow(i,j);
						}
						else if(_nodes[j].type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER && 
								_nodes[j].subsystemId == destinationId)
						{
							Debug.log("Found builder-connection connection at nodes " + 
									i + " ==> " + j);

							addArrow(i,j);
						}
				}
				else if(_nodes[i].type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER)
				{
					//connect to all board readers at destination
					for(var j=0;j<_nodes.length;++j)
						if(_nodes[j].type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found logger-dispatcher connection at nodes " + 
									i + " ==> " + j);
							
							addArrow(i,j);
						}
				}
			}
			
		} //end initArrows()
		
		//=====================================================================================
		//getTypeIndex ~~
		function getTypeIndex(typeName)
		{
			Debug.log("getTypeIndex " + typeName);
			t = typeName == ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_READER]		?ArtdaqConfigurationAPI.NODE_TYPE_READER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_BUILDER]	?ArtdaqConfigurationAPI.NODE_TYPE_BUILDER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_LOGGER]	?ArtdaqConfigurationAPI.NODE_TYPE_LOGGER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER]?ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER:
					(typeName == ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_MONITOR]	?ArtdaqConfigurationAPI.NODE_TYPE_MONITOR:-1))));
			
			if(t < 0)
			{	
				Debug.log("Illegal type name " + typeName + 
						". Tell admins how you got here!", Debug.HIGH_PRIORITY);
				return; 
			}
			return t;
		} //end getTypeIndex()
		
		//=====================================================================================
		//getTypeName ~~
		function getTypeName(typeIndex)
		{
			Debug.log("getTypeName " + typeIndex);
			
			if(ArtdaqConfigurationAPI.NODE_TYPES[typeIndex] === undefined)
			{	
				Debug.log("Illegal type index " + typeIndex + 
						". Tell admins how you got here!", Debug.HIGH_PRIORITY);
				return; 
			}
			return ArtdaqConfigurationAPI.NODE_TYPES[typeIndex];
		} //end getTypeName()	

		//=====================================================================================
		//getEmptyGridSpot ~~
		//	return empty x,y grid spot
		//	handle types differently.. 
		//	i.e. readers to left, builders in middle, dataLoggers and dispatchers to right
		function getEmptyGridSpot(type)
		{
			var x = type == ArtdaqConfigurationAPI.NODE_TYPE_READER?0:
					(type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER?((_grid.cols/2)|0):
					_grid.cols-1); //else dataLoggers and dispatchers on right
			var d = type == ArtdaqConfigurationAPI.NODE_TYPE_READER?1:-1; //direction of search in x
			var y = 0; //start at top-ish
			
			//search _nodes for conflict
			var tries = 0;
			do
			{
				var conflict = false;
				
				//if too many conflicts, add row to top
				if(tries > _grid.cols*_grid.rows/2)
				{
					plusMinusGrid(true /*isPlus*/,0 /*directionIndex*/); //add row to top

					var x = type == ArtdaqConfigurationAPI.NODE_TYPE_READER?0:
							(type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER?((_grid.cols/2)|0):
							_grid.cols-1); //else dataLoggers and dispatchers on right
					y = 0;
				}

				for(var i=0;i<_nodes.length;++i)
				{
					if(_nodes[i].x == x && _nodes[i].y == y)
					{
						conflict = true;
						//try new value
						++y;
						if(y >= _grid.cols)
						{
							//handle y wraparound
							y = 0;
							x = (x + d) % _grid.cols;
						}
						
						break;
					}
				}
				++tries;
			} while(conflict);
			
			Debug.log("Position found at x,y " + 
					x + "," + y);
			
			return [x,y];
			
		} //end getEmptyGridSpot()
		
		//=====================================================================================
		//getSubsystemColor ~~
		function getSubsystemColor(subsystemId)
		{			
			//default: rgb(241, 231, 231);
			var rgb = [241,231,231];
			var i = (subsystemId-1)*70;
			var j = 0;
			while(i>0) //drain color counter
			{
				rgb[j] += i>50?50:i;
				if(rgb[j] > 255)
					rgb[j] = 180 + (rgb[j] - 255); //let 180 be minimum
				
				i -= (i>50?50:i);
				
				if(++j >= 3) j = 0; //wraparound
			}
			
			//do not let the color get to white
			j=0;
			for(i=0;i<3;++i)
				if(rgb[i] > 230) ++j;
			if(j == 3)
				rgb[subsystemId%3] = 150; 
			
			//console.log("color sub",subsystemId,rgb);
			
			return "rgb(" + rgb[0] + "," + rgb[1] + "," + 
					rgb[2] + ")";
		} //end getSubsystemColor()
		
		//=====================================================================================
		//handleNodeMouseOver ~~
		function handleNodeMouseOver(e)
		{
			var id = this.id.split('-')[1] | 0;
			//Debug.log("MouseOver Node id = " + id);
			
		} //end handleNodeMouseOver()
		
		//=====================================================================================
		//paint ~~
		//	paint grid and nodes based on 
		//	_grid and _nodes global variable and window size
		function paint() 
		{	
			_w = DesktopContent.getWindowWidth();
			_h = DesktopContent.getWindowHeight();
			
			console.log("_grid",_grid);
			console.log("_nodes",_nodes);
			console.log("_arrows",_arrows);

			var MIN_H = 280;
			var MIN_W = 280;
			if(_w < MIN_W)
				_w = MIN_W;
			if(_h < MIN_H)
				_h = MIN_H;
			
			Debug.log("paint w,h=" + _w + "," + _h);

			_canvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_canvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_canvas.width = (_w - _CANVAS_MARGIN*2);
			_canvas.height = (_h - _CANVAS_MARGIN*2);
			_context.clearRect(0, 0, _canvas.width, _canvas.height);
			
			_actionCanvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.width = (_w - _CANVAS_MARGIN*2);
			_actionCanvas.height = (_h - _CANVAS_MARGIN*2);
			_actionContext.clearRect(0, 0, _canvas.width, _canvas.height);

			_gridCanvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_gridCanvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_gridCanvas.width = (_w - _CANVAS_MARGIN*2);
			_gridCanvas.height = (_h - _CANVAS_MARGIN*2);
			_gridContext.clearRect(0, 0, _canvas.width, _canvas.height);

			drawGrid();

			//determine node size and then draw			
			_NODE_SIZE = _grid.xstep*0.5;
			if(_NODE_SIZE > _grid.ystep*0.5)
				_NODE_SIZE = _grid.ystep*0.5;
			
			_grid.rowColMap = {};
			for(var i=0;i<_nodes.length;++i)							
				drawNode(i);
			
			drawArrows();
			
		} //end paint()

		//=====================================================================================
		//drawGrid ~~
		function drawGrid() 
		{	
			if(_grid.cols < _GRID_COL_MIN) 
			{
				Debug.log("Not enough columns, defaulting.");
				_grid.cols = _GRID_COL_MIN;
			}
			if(_grid.rows < _GRID_ROW_MIN) 
			{
				Debug.log("Not enough rows, defaulting.");
				_grid.rows = _GRID_ROW_MIN;
			}
			
			//determine grid spacing
			_grid.xstep = (_w - 2*_GRID_MARGIN)/_grid.cols;			
			_grid.ystep = (_h - 2*_GRID_MARGIN)/_grid.rows;
			
			if(_grid.xstep < 0 || _grid.ystep < 0)
			{
				Debug.log("Window size is too small!",Debug.HIGH_PRIORITY);
				return;
			}
						
			_grid.x0 = _GRID_MARGIN + _grid.xstep/2;
			_grid.y0 = _GRID_MARGIN + _grid.ystep/2;
			
			//shrink margin if window is small
			if(_grid.x0 > _grid.xstep * 2)
			{
				_grid.x0 = _grid.xstep;
				_grid.xstep = (_w - 2*_grid.x0)/_grid.cols;	
				_grid.x0 = _grid.x0 + _grid.xstep/2;
			}
			if(_grid.y0 > _grid.ystep * 2)
			{
				_grid.y0 = _grid.ystep;		
				_grid.ystep = (_h - 2*_grid.ystep)/_grid.rows;
				_grid.y0 = _grid.y0 + _grid.ystep/2;
			}

			console.log("drawGrid _grid",_grid);
			
			//draw grid +/- arrows
			//if node exists, get element
			var el = document.getElementById("grid-plusMinusArrowsContainer");
			if(!el) //else create it
			{
				el = document.createElement("div"); 
				el.setAttribute("id", "grid-plusMinusArrowsContainer");
				
				var str = "";
				
				//make 4 sets of +/- arrows
				var a = 0;
				//top set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-upDown'>";
				{ //make top up/down arrows
					str += "<div class='grid-plusMinusArrows-down grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a row from the canvas grid.' >" +
								//make up arrow
								"<div class='grid-plusMinusArrows-down-body'></div>" +
								"<div class='grid-plusMinusArrows-down-point'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-up grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a row to the canvas grid.' >" +
								//make down arrow
								"<div class='grid-plusMinusArrows-up-point'></div>" +
								"<div class='grid-plusMinusArrows-up-body'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//right set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-leftRight'>";
				{ //make right left/right arrows
					str += "<div class='grid-plusMinusArrows-left grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a column from the canvas grid.' >" +
							//make left arrow
							"<div class='grid-plusMinusArrows-left-point'></div>" +
							"<div class='grid-plusMinusArrows-left-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-right grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a column to the canvas grid.' >" +
							//make right arrow
							"<div class='grid-plusMinusArrows-right-body'></div>" +
							"<div class='grid-plusMinusArrows-right-point'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//bottom set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-upDown'>";
				{ //make bottom up/down arrows
					str += "<div class='grid-plusMinusArrows-up grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a row to the canvas grid.' >" +
								//make up arrow
								"<div class='grid-plusMinusArrows-up-point'></div>" +
								"<div class='grid-plusMinusArrows-up-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-down grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " + 
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a row to the canvas grid.' >" +
								//make down arrow
								"<div class='grid-plusMinusArrows-down-body'></div>" +
								"<div class='grid-plusMinusArrows-down-point'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//left set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-leftRight'>";
				{ //make left left/right arrows
					str += "<div class='grid-plusMinusArrows-left grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " + 
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a column to the canvas grid.' >" +
							//make left arrow
							"<div class='grid-plusMinusArrows-left-point'></div>" +
							"<div class='grid-plusMinusArrows-left-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-right grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " + 
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a column from the canvas grid.' >" +
							//make right arrow
							"<div class='grid-plusMinusArrows-right-body'></div>" +
							"<div class='grid-plusMinusArrows-right-point'></div>" +										
							"</div>";
				}				
				str += "</div>"; //close top +/- set collection
				el.innerHTML = str;
				_postCanvas.appendChild(el);	
			}

			var arrows = el.getElementsByClassName("grid-plusMinusArrows");
			sz = 100;
			vsz = 30;
			arrows[0].style.left 	= ((_w/2 - sz/2)|0) + "px";
			arrows[0].style.top 	= (((_GRID_MARGIN-vsz)/2)|0) + "px";
			arrows[1].style.left 	= ((_w - (_GRID_MARGIN-vsz)/2 - vsz)|0) + "px";
			arrows[1].style.top 	= ((_h/2 - sz/2)|0) + "px";
			arrows[2].style.left 	= ((_w/2 - sz/2)|0) + "px";
			arrows[2].style.top 	= ((_h - (_GRID_MARGIN-vsz)/2 - vsz)|0) + "px";
			arrows[3].style.left 	= (((_GRID_MARGIN-vsz)/2)|0) + "px";
			arrows[3].style.top 	= ((_h/2 - sz/2)|0) + "px";

			//draw grid dots			
			_gridContext.save();
			_gridContext.fillStyle   	= _GRID_COLOR;
			_gridContext.shadowOffsetX 	= 2;
			_gridContext.shadowOffsetY 	= 2;
			_gridContext.shadowBlur    	= 5;
			_gridContext.shadowColor	= _SHADOW_COLOR;
			
			//_context.fillRect(10,10,100,100);
					
			var r,c;
			for(r=0;r<_grid.rows;++r)
				for(c=0;c<_grid.cols;++c)
					_gridContext.fillRect(
							(_grid.x0 + c*_grid.xstep)|0,
							(_grid.y0 + r*_grid.ystep)|0,							
							3,3 /*size w,h in pixels*/);
			
			_gridContext.restore();
		} //end drawGrid()

		//=====================================================================================
		//plusMinusGrid ~~
		//	add or subtract row/col, and adjust nodes
		// directionIndex := 0-3 := top, right, bottom, left
		function plusMinusGrid(isPlus,directionIndex)
		{
			Debug.log("plusMinusGrid isPlus=" + 
					isPlus + " directionIndex=" +
					directionIndex);
			
			if(!isPlus) //then deleting row/col
			{
				if(directionIndex == 0 || 
						directionIndex == 2)
				{
					//dealing with a row
					
					var y = directionIndex == 0?
							0:_grid.rows-1;

					if(_grid.rows <= _GRID_ROW_MIN)
					{
						Debug.log("Can not delete row " + y +
								"; " + _GRID_ROW_MIN +
								" rows is the minimum!",
								Debug.HIGH_PRIORITY);
						return;
					}
					
					//check for conflict
					for(var i=0;i<_nodes.length;++i)
						if(_nodes[i].y == y)
						{
							Debug.log("Can not delete row " + y +
									" while still occupied!",
									Debug.HIGH_PRIORITY);
							return;
						}
					
					//remove row 
					--_grid.rows;
					
					//move all nodes if row-0 was removed
					if(directionIndex == 0)
						for(var i=0;i<_nodes.length;++i)
							--_nodes[i].y;					
				}
				else if(directionIndex == 1 || 
						directionIndex == 3)
				{
					//dealing with a column
					
					var x = directionIndex == 3?
							0:_grid.cols-1;

					if(_grid.cols <= _GRID_COL_MIN)
					{
						Debug.log("Can not delete column " + x +
								"; " + _GRID_COL_MIN + 
								" columns is the minimum!",
								Debug.HIGH_PRIORITY);
						return;
					}

					//check for conflict
					for(var i=0;i<_nodes.length;++i)
						if(_nodes[i].x == x)
						{
							Debug.log("Can not delete column " + x +
									" while still occupied!",
									Debug.HIGH_PRIORITY);
							return;
						}

					//remove column 
					--_grid.cols;

					//move all nodes if col-0 was removed
					if(directionIndex == 3)
						for(var i=0;i<_nodes.length;++i)
							--_nodes[i].x;
				}
				else
				{	
					Debug.log("Unrecognized direction index - should be impossible!",
							Debug.HIGH_PRIORITY);
				}
				
				//re-paint adjustments
				paint(); 
				
				return;
			} //end minus handling
			
			//if here, then add handling
			
			if(directionIndex == 0 || 
					directionIndex == 2)
			{
				//dealing with a row
				++_grid.rows;
				
				//move all nodes if row-0 was added
				if(directionIndex == 0)
					for(var i=0;i<_nodes.length;++i)
						++_nodes[i].y;
			}
			else if(directionIndex == 1 || 
					directionIndex == 3)
			{
				//dealing with a column
				++_grid.cols;

				//move all nodes if col-0 was removed
				if(directionIndex == 3)
					for(var i=0;i<_nodes.length;++i)
						++_nodes[i].x;
			}
			else
			{	
				Debug.log("Unrecognized direction index - should be impossible!",
						Debug.HIGH_PRIORITY);
			}
			
			//re-paint adjustments
			paint(); 
			
		} //end plusMinusGrid()

		//=====================================================================================
		//getNodeFontSize ~~
		function getNodeFontSize()
		{
			var fontSz = _NODE_SIZE/10;
			return (fontSz < 6)?6:fontSz;
		} //end getNodeFontSize()
		
		//=====================================================================================
		//handleSelectionBox ~~
		//	draw selection box,	and handle identifying
		//	nodes within selection area.
		function handleSelectionBox(e)
		{
			var box = [
			   _mouseMoveStart[0] < e.clientX?
					   _mouseMoveStart[0]:e.clientX,
			   _mouseMoveStart[1] < e.clientY?
					   _mouseMoveStart[1]:e.clientY,
			   _mouseMoveStart[0] < e.clientX?
					   e.clientX:_mouseMoveStart[0],
			   _mouseMoveStart[1] < e.clientY?
					   e.clientY:_mouseMoveStart[1]
			 ]; //box top-left ==> bot-right
			
			console.log("box",box);
			
			var el = document.getElementById("selectionBoxDiv");
			el.style.left 	= box[0] + "px";
			el.style.top 	= box[1] + "px";
			el.style.width 	= (box[2]-box[0]) + "px";
			el.style.height = (box[3]-box[1]) + "px";
			
			//determine temporary selected nodes
			_mouseMoveStart[2] = {}; //store selected nodes here
			var nodeBox = [
			   ((box[0] - _grid.x0 + _grid.xstep/2)/_grid.xstep),
			   ((box[1] - _grid.y0 + _grid.ystep/2)/_grid.ystep),
			   ((box[2] - _grid.x0 + _grid.xstep/2)/_grid.xstep),
			   ((box[3] - _grid.y0 + _grid.ystep/2)/_grid.ystep)			   
				];
			for(var i=0;i<4;++i) //clip to -1 and integer
				if(nodeBox[i] < 0) nodeBox[i] = -1;
				else nodeBox[i] |= 0;
			
			if(box[0] > 
					_grid.x0 + nodeBox[0]  * _grid.xstep + _NODE_SIZE/2)
				++nodeBox[0]; //lose selection
			if(box[1] > 
					_grid.y0 + nodeBox[1]  * _grid.ystep + _NODE_SIZE/2)
				++nodeBox[1]; //lose selection
			if(box[2] <
					_grid.x0 + nodeBox[2]  * _grid.xstep - _NODE_SIZE/2)
				--nodeBox[2]; //lose selection
			if(box[3] < 
					_grid.y0 + nodeBox[3]  * _grid.ystep - _NODE_SIZE/2)
				--nodeBox[3]; //lose selection
			
			console.log("node box selection",nodeBox);
			
			for(var xg=nodeBox[0];xg<=nodeBox[2];++xg)
				for(var yg=nodeBox[1];yg<=nodeBox[3];++yg)
					if(_grid.rowColMap[xg] !== undefined &&
							_grid.rowColMap[xg][yg] !== undefined)
					{
						Debug.log("Found selected node " +
								_grid.rowColMap[xg][yg]);
						_mouseMoveStart[2][_grid.rowColMap[xg][yg]] = 1;
					}

			console.log("nodes in box selection",_mouseMoveStart[2]);

			paint();
		} //end handleSelectionBox()

		//=====================================================================================
		//drawNode ~~
		//	draw a node of specified by node index 
		function drawNode(i,xoff,yoff)
		{
			var type = _nodes[i].type;
			var x = _nodes[i].x;
			var y = _nodes[i].y;
			
			//add to _grid.rowColMap
			if(_grid.rowColMap[x] == undefined) 
				_grid.rowColMap[x] = {};
			_grid.rowColMap[x][y] = i; //fill x,y position
			
			var nodeid = "node-" + i;
						
			var sz = _NODE_SIZE | 0; 
			x = (_grid.x0 + x * _grid.xstep - sz/2) | 0;
			y = (_grid.y0 + y * _grid.ystep - sz/2) | 0;
			
			if(xoff) x += xoff;
			if(yoff) y += yoff;
			
			//Debug.log("x,y,sz = " + x + "," + y + "," + sz);
			
			var typeClass = 
					type == ArtdaqConfigurationAPI.NODE_TYPE_READER? 		"nodeReader":
					type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER? 		"nodeBuilder":
					type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER? 		"nodeLogger":
					type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER? 	"nodeDispatcher":"nodeMonitor";

			var typeName = 
					type == ArtdaqConfigurationAPI.NODE_TYPE_READER? 		"Reader":
					type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER? 		"Builder":
					type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER? 		"Logger":
					type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER? 	"Dispatcher":"Monitor";
			var typeAcronym = 
					type == ArtdaqConfigurationAPI.NODE_TYPE_READER? 		"BR":
					type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER? 		"EB":
					type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER? 		"DL":
					type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER? 	"Di":"Mo";
						
			
			//Debug.log("nodeid = " + nodeid + "; typeClass = " + typeClass);

			//if node exists, get element
			var el = document.getElementById(nodeid);
			if(!el) //else create it
			{
				el = document.createElement("div"); 
				el.setAttribute("class", "node " + typeClass);
				el.setAttribute("id", nodeid);
								
				//draw box, connect points, pencil, and trashcan
				var str = "";
										
				//box
				var count = _nodes[i].nodeCount?_nodes[i].nodeCount:1;
				
				var nodeName = _nodes[i].name;
				var hostname = _nodes[i].hostname;
				if(count > 1)
				{
					//special multi-node name handling
					
					nodeName = nodeName.replace(new RegExp("\\*",'g'), 
							"[" + 
							_nodes[i].nodeVectorIndexString + 
							"]"); 
				}
				if(hostname.indexOf('*') >= 0)
				{
					//special hostname array handling
					
					hostname = hostname.replace(new RegExp("\\*",'g'), 
							"[" + 
							_nodes[i].hostnameVectorIndexString + 
							"]"); 
				}
				
				if(count > 4) count = 4; //cap at 4
				//console.log("i,count",i,count);				
				
				for(var p=count-1;p>=0;--p)
				{
					str += "<div id='" + nodeid + 
						"-box' class='node-box' " +
						"style='top:" + (-p*5) + "px;" +
						"background-color: " + getSubsystemColor(_nodes[i].subsystemId) + ";" +
						"left:" + (-p*5) + "px;' " +
						">";
					if(p == 0)
					{
						str += "<div id='" + nodeid + 
							"-boxText' class='node-boxText'>" +
							typeAcronym +
							"</div>";
					}
					str += "</div>";
				}
				
				//connect points
				for(var p=0;p<4;++p)
					str += "<div id='" + nodeid + 
						"-point" + p + 
						"' class='node-point" + p +
						" node-point node-point-open' " +
						"title='Use these anchors to modify or create connection arrows with other nodes.' " +
						" onmouseup='handlePointMouseUp(" + 
						i + "," + p + ",event);'" +
						" onmousedown='handlePointMouseDown(" + 
						i + "," + p + ",event);'" +
						"></div>";
				
				//header text
				str += "<div id='" + nodeid + 
						"-headerText' class='node-headerText'>" +
						typeName + "::" + nodeName +
						htmlClearDiv() + 
						_subsystems[_nodes[i].subsystemId].label + 
						" @ " + hostname +			
					"</div>";
				
				//add edit pencil icon
				str += "<div id='" + nodeid + 
						"-editIcon' class='node-icon node-editIcon' " +
						"title='Edit the configuration of this node.' " +
						" onmouseup='handleEditIconMouseUp(" + 
						i + ",event);'" +
						" onmousedown='event.stopPropagation() /* mousedown do nothing */;'" +
						"></div>";
				//add view fcl icon
				str += "<div id='" + nodeid + 
						"-viewFclIcon' class='node-icon node-viewFclIcon' " +
						"title='View the generated FHiCL of this node.' " +
						" onmouseup='handleFclIconMouseUp(" + 
						i + ",event);'" +
						" onmousedown='event.stopPropagation() /* mousedown do nothing */;'" +
						">" +
						"<div class='node-viewFclIcon-line'></div>" +
						"<div class='node-viewFclIcon-line'></div>" +
						"</div>";
				//add delete trash can icon
				str += "<div id='" + nodeid + 
						"-deleteIcon' class='node-icon node-deleteIcon' " +
						" onmouseup='handleDeleteIconMouseUp(" + 
						i + ",event);'" +
						" onmousedown='event.stopPropagation() /* mousedown do nothing */;'" +
						"title='Delete this node.' " +
						"></div>";
				
				el.innerHTML = str;
				_postCanvas.appendChild(el);	
				el.onmouseover = handleNodeMouseOver;	
			}			
			
			var boxes = el.getElementsByClassName("node-box");
			for(var p=0;p<boxes.length;++p)
			{
				boxes[p].style.width  = sz + "px";
				boxes[p].style.height = sz + "px";
			}		
			
			if(_selectedNodes[i] !== undefined || 
					(_mouseMoveMode == _MMM_SELECT_BOX &&
							_mouseMoveStart[2][i] !== undefined))
			{ //selected node
				boxes[0].style.border = "3px solid green";
			}
			else
				boxes[0].style.border = "0";
			
			el.style.left 	= x + "px";
			el.style.top 	= y + "px";		
			
			var pointSz = 12;
			var points = el.getElementsByClassName("node-point");
			var pxy;
			for(var p=0;p<4;++p)
			{
				pxy = getNodePoint(i,p);
				points[p].style.left 	= (pxy[0] - x - pointSz/2) + "px";
				points[p].style.top 	= (pxy[1] - y - pointSz/2) + "px";
			}
			
			var fontSz = getNodeFontSize();
			var count = (_nodes[i].nodeCount && _nodes[i].nodeCount > 4)?4:(_nodes[i].nodeCount|0);		
									
			el = document.getElementById(nodeid + "-headerText");
			el.style.left = (- (_grid.xstep*2-sz)/2 - (count?(count-1)*2:0)) + "px";
			el.style.fontSize = ((fontSz)|0) + "px";
			el.style.top = ((-fontSz*3-fontSz/2 - (count?(count-1)*5:0))|0) + "px";
			el.style.height = ((fontSz*3)|0) + "px";
			el.style.width = (_grid.xstep*2) + "px";
			
			fontSz = sz/5;
			if(fontSz < 6) fontSz = 6;
			el = document.getElementById(nodeid + "-boxText");
			el.style.fontSize = ((fontSz)|0) + "px";
			el.style.marginTop = ((sz/2 - fontSz/2)|0) + "px";			
						
			el = document.getElementById(nodeid + "-editIcon");
			el.style.left = (-10) + "px";
			el.style.top = (sz+32) + "px";
			el = document.getElementById(nodeid + "-viewFclIcon");
			el.style.left = (((sz/2)|0)-10) + "px";
			el.style.top = (sz+32) + "px";
			el = document.getElementById(nodeid + "-deleteIcon");
			el.style.left = (sz-10) + "px";
			el.style.top = (sz+32) + "px";
			
		} //end drawNode()

		//=====================================================================================
		//drawArrows ~~
		function drawArrows() 
		{	
			var xy0,xy1;
			for(var i in _arrows)
				for(var j in _arrows[i])
				{
					xy0 = getNodePoint(i|0,_arrows[i][j].p0);
					xy1 = getNodePoint(j|0,_arrows[i][j].p1);
					//console.log("xy01",xy0,xy1);
					drawArrow(xy0[0],xy0[1],xy1[0],xy1[1]);
				}
			
		} //end drawArrows()
		
		//=====================================================================================
		//drawArrow ~~
		function drawArrow(x0,y0,x,y,isActionCanvas) 
		{	
			//console.log("drawArrow x0,y0,x,y,isActionCanvas ",
			//		x0,y0,x,y,isActionCanvas);
			
			if(isActionCanvas) //assume one at a time in action
				_actionContext.clearRect(0, 0, _canvas.width, _canvas.height);
			
			var context = isActionCanvas?_actionContext:_context;
			
			context.save();
			
			var HEAD_SZ = 10;
			var LINE_SZ = 2;
			
			//make arrow slightly shorter than full distance
			
            var angle = Math.atan2(y-y0,x-x0);
            
            x -= HEAD_SZ*Math.cos(angle);
            y -= HEAD_SZ*Math.sin(angle);

            //starting path of the arrow from the start square to the end square and drawing the stroke
            context.beginPath();
            context.moveTo(x0, y0);
            context.lineTo(x, y);
            context.strokeStyle = _ARROW_COLOR;
            context.lineWidth = LINE_SZ;
            context.stroke();

            //starting a new path from the head of the arrow to one of the sides of the point
            context.beginPath();
            context.moveTo(x, y);
            context.lineTo(x-HEAD_SZ*Math.cos(angle-Math.PI/7),y-HEAD_SZ*Math.sin(angle-Math.PI/7));

            //path from the side point of the arrow, to the other side point
            context.lineTo(x-HEAD_SZ*Math.cos(angle+Math.PI/7),y-HEAD_SZ*Math.sin(angle+Math.PI/7));

            //path from the side point back to the tip of the arrow, and then again to the opposite side point
            context.lineTo(x, y);
            context.lineTo(x-HEAD_SZ*Math.cos(angle-Math.PI/7),y-HEAD_SZ*Math.sin(angle-Math.PI/7));

            //draws the paths created above
            context.strokeStyle = _ARROW_COLOR;
            context.lineWidth = LINE_SZ;
            context.stroke();
            context.fillStyle = _ARROW_COLOR;
            context.fill();
            
			context.restore();
		} //end drawArrow()		

		//=====================================================================================
		//handleMouseMove ~~
		function handleMouseMove(e) 
		{	
			if(document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID))
				return; //disable while popup
				
    		var x = e.clientX;//- this.offsetLeft - _CANVAS_MARGIN - 2;
    		var y = e.clientY;//- this.offsetTop - _CANVAS_MARGIN - 2;
			
    		if(x == undefined) //handle as a key press
    		{
    			x = DesktopContent.getMouseX();				
    			y = DesktopContent.getMouseY();
    		}
    		//console.log("mousemove x,y",x,y);
    		
    		//debug visually
    		//_context.fillRect((x)|0,(y)|0,3,3 );
    		
    		//steps:
    		//	if mousedown, draw arrow or dragging object
    		//	else if over empty grid position, show + 
    		//	else if over node show node decription/options
    		
    		
    		//----------------------------
    		//if mouse 'down' move handling
    		if(_mouseMoveMode != _MMM_NONE)
    		{
    			//handle mousemove mode
    			
    			//hide +
    			_addNodeEl.style.left = "-1000px"; //off screen
    			
    			switch(_mouseMoveMode)
    			{
    			case _MMM_ARROW_DRAG:
    				//console.log("arrow drag x,y",x,y);
    				drawArrow(
    						_mouseMoveStart[0],
							_mouseMoveStart[1],
							x,y, true /*isActionCanvas*/);
    				//continue on
    				break;    
    			case _MMM_NODE_DRAG:
    				//console.log("node drag x,y",x,y);
    				drawNode(
    						_mouseMoveStart[2],
    						x - _mouseMoveStart[0],
							y - _mouseMoveStart[1]);							
    				return;
    			case _MMM_SELECT_BOX:
    				//console.log("select box",x,y);
    				handleSelectionBox(e);							
    				return;
    			case _MMM_POPUP_DIALOG: //ignore mouse move during popup
    				return;
    			default:
    				Debug.log("Illegal _mouseMoveMode = " + _mouseMoveMode, 
    						Debug.HIGH_PRIORITY);
    				return; //do not continue on
    			}
    			
    			//for some modes, continue on to show mouse over nodes while dragging
    			
    		} //end handle mousemove mode

    		
			var xg = ((x - _grid.x0 + _grid.xstep/2)/_grid.xstep);
			var yg = ((y - _grid.y0 + _grid.ystep/2)/_grid.ystep);			
			
			if(xg < 0) xg = -1; //clip to -1 for +/- icons
			else xg |= 0;
			if(yg < 0) yg = -1; //clip to -1 for +/- icons			
			else yg |= 0;
			

			//console.log("mousemove x,y",x,y,
			//		"mousemove xg,yg",xg,yg);
			
			if(xg >= 0 && yg >= 0 && 
					xg < _grid.cols && 
					yg < _grid.rows)
			{
				if(_grid.rowColMap[xg] !== undefined &&
					_grid.rowColMap[xg][yg] !== undefined)
				{
					//----------------------------
					//	if over node show node decription/options
									
					//Debug.log("Node over " + xg + "," + yg);
					
					//if over a filled spot, remove +			
					_addNodeEl.style.left = "-1000px"; //off screen
					
					doNodeHover(_grid.rowColMap[xg][yg]);
					
					//if directly over node-box, show grabbable hand
					var pxy = [ _grid.x0 + xg * _grid.xstep,
								_grid.y0 + yg * _grid.ystep];
					var overNodeBox = false;
					if(x > pxy[0] - _NODE_SIZE/2 && 
							x < pxy[0] + _NODE_SIZE/2 &&
							y > pxy[1] - _NODE_SIZE/2 &&
							y < pxy[1] + _NODE_SIZE/2) 
						overNodeBox = true;
					
					if(overNodeBox)
					{
						if(e.shiftKey) //indicate toggle selection
							this.style.cursor = "pointer";
						else
							this.style.cursor = "grab";
					}
					else
						this.style.cursor = "default";

					return;
				}
				else // else there is no node
				{		
					//----------------------------
					//if over empty grid position, show +
					
					//do not show + if for mouse move modes
					if(_mouseMoveMode != _MMM_NONE) return;
					
					//Debug.log("Place + at " + xg + "," + yg);
	
					var sz = 32;
					_addNodeEl.style.left =
							((_grid.x0 + xg * _grid.xstep - sz/2) | 0) + "px";
					_addNodeEl.style.top =
							((_grid.y0 + yg * _grid.ystep - sz/2) | 0) + "px";					
				}
			}
			else
			{
				//if not handled, remove +			
				_addNodeEl.style.left = "-1000px"; //off screen
				
				//add +/- row column icons
				if(yg < 0) 
					doNodeHover(-10); //show top icons
				else if(xg >= _grid.cols)
					doNodeHover(-11); //show right icons
				else if(yg >= _grid.rows)
					doNodeHover(-12); //show top icons
				else if(xg < 0)
					doNodeHover(-13); //show left icons
				
				return;
			}
			
			//undo cursor changes if any
			this.style.cursor = "default";	
				
			//undo hover node, if any
			if(_mouseHoverNode != -1)
				doNodeHover(_mouseHoverNode,true /*undoHover*/);
			
		} //end handleMouseMove()

		//=====================================================================================
		//handleMouseUp ~~
		function handleMouseUp(e) 
		{	
			e.stopPropagation();
			
    		var x = e.clientX;
    		var y = e.clientY;
			
    		//console.log("mouseup x,y",x,y);
    		    		
    		//debug visually
    		//_context.fillRect((x)|0,(y)|0,3,3 );
    		
    		if(_mouseMoveMode != _MMM_NONE)
    		{
    			switch(_mouseMoveMode)
    			{
    			case _MMM_ARROW_DRAG:
    				console.log("done arrow drag NO VALID END x,y",x,y);
    				_mouseMoveMode = _MMM_NONE;
    				
    				Debug.log("The destination end-point was invalid! Make sure you end the operation " +
    						"by hovering over a valid anchor with your cursor.",
    						Debug.HIGH_PRIORITY);
    				
    				//re-paint to clear invalid move
    				paint();    				
    				break;    
    			case _MMM_NODE_DRAG:
    				
    				//end mousemove
    				_mouseMoveMode = _MMM_NONE;
    				
    				//see if node drag ended in open spot
    				var xg = ((x - _grid.x0 + _grid.xstep/2)/_grid.xstep);
    				var yg = ((y - _grid.y0 + _grid.ystep/2)/_grid.ystep);			

    				if(xg < 0) xg = -1; //clip to -1 for +/- icons
    				else xg |= 0;
    				if(yg < 0) yg = -1; //clip to -1 for +/- icons			
    				else yg |= 0;
    				
    				if(xg >= 0 && yg >= 0 && 
    						xg < _grid.cols && 
							yg < _grid.rows &&
							(
								_grid.rowColMap[xg] === undefined ||
								_grid.rowColMap[xg][yg] === undefined
							))
    				{
    					Debug.log("Node drag to new open spot " + 
    							xg + "," + yg);
    					_nodes[_mouseMoveStart[2]].x = xg;
    					_nodes[_mouseMoveStart[2]].y = yg;
    					
    					nodeLayoutHasChanged();
    				}
    				else
    					console.log("done node drag NO VALID END x,y",x,y);
    				
    				//re-paint to clear invalid move
    				paint();
    				break;   

    			case _MMM_SELECT_BOX:
    				console.log("done select box",x,y);
    				_mouseMoveMode = _MMM_NONE;
    				var el = document.getElementById("selectionBoxDiv");
    				el.style.left 	= (-1000) + "px";
    				el.style.width 	= (0) + "px";
    				
    				if(!e.shiftKey)
    					_selectedNodes = {}; //clear selected nodes
    				
    				//transfer selected nodes from temporary
    				for(var n in _mouseMoveStart[2])
    					_selectedNodes[n] = 1;
    				_mouseMoveStart[2] = {}; //clear temporary selected nodes
    				paint();
    				break; 	
    			case _MMM_POPUP_DIALOG: //ignore mouse up during popup
    				return;			
    			default:
    				Debug.log("Illegal mouseup _mouseMoveMode = " +
    						_mouseMoveMode, 
    						Debug.HIGH_PRIORITY);
    			}
    		} //end mousemove mode handling
    		
		} //end handleMouseUp()

		//=====================================================================================
		//handleMouseDown ~~
		function handleMouseDown(e) 
		{	
			e.stopPropagation();

    		var x = e.clientX;
    		var y = e.clientY;
    		
    		//console.log("mousedown x,y",x,y);
    		
    		
			if(_mouseMoveMode == _MMM_NONE && 
					_mouseHoverNode >= 0) 
			{ //start node dragging
				var pxy = [ _grid.x0 + _nodes[_mouseHoverNode].x * _grid.xstep,
							_grid.y0 + _nodes[_mouseHoverNode].y * _grid.ystep];
				if(
						x > pxy[0] - _NODE_SIZE/2 && 
						x < pxy[0] + _NODE_SIZE/2 &&
						y > pxy[1] - _NODE_SIZE/2 &&
						y < pxy[1] + _NODE_SIZE/2) 
				{
					//shift key chooses toggling nodes
					if(e.shiftKey)
					{
						Debug.log("Toggling node select " + _mouseHoverNode);
						
						if(_selectedNodes[_mouseHoverNode] === undefined)
							_selectedNodes[_mouseHoverNode] = 1;
						else
							delete _selectedNodes[_mouseHoverNode];
						paint();
						return;
					}
					
					Debug.log("Starting node drag " + _mouseHoverNode);
					this.style.cursor = "grabbing";
					_mouseMoveMode = _MMM_NODE_DRAG;

					//start movement
					_mouseMoveStart = [ //x,y,i,p start (i,p are optional)
								x,y,_mouseHoverNode]; 
					
					//unhover node
					doNodeHover(_mouseHoverNode,true /*undoHover*/);
					
					return;
				}
			}
			
			
			if(_mouseMoveMode == _MMM_NONE)
			{ //start node selection box
				
				Debug.log("Starting select box ");
				
				//start selection box anchor
				_mouseMoveStart = [ //x,y,temp-selection-node-map
									x,y,{}]; 
				_mouseMoveMode = _MMM_SELECT_BOX;
				handleSelectionBox(e);
			}
			
		} //end handleMouseDown()
			
		//=====================================================================================
		//getNodePoint ~~
		//	returns x,y center of node point
		function getNodePoint(i,p) 
		{
			var x = _nodes[i].x;
			var y = _nodes[i].y;
			var sz = _NODE_SIZE | 0; 

			var x = (_grid.x0 + x * _grid.xstep - sz/2) | 0;
			var y = (_grid.y0 + y * _grid.ystep - sz/2) | 0;

			switch(p)
			{
			case 0: //top
				return [(x + sz/2)|0,
						(y)|0];
			case 1: //right
				return [(x + sz)|0,
						(y + sz/2)|0];
			case 2: //bottom
				return [(x + sz/2)|0,
						(y + sz - 1)|0];
			case 3: //left
				return [(x - 1)|0,
						(y + sz/2)|0];
			default:
				Debug.log("illegal point request! " + p,
						Debug.HIGH_PRIORITY);
			}
		} //end getNodePoint()
		
		//=====================================================================================
		//doNodeHover ~~
		//	handle mouse hover display of node
		function doNodeHover(i,undoHover) 
		{					
			//if attempting to hover then... 
			if(!undoHover)
			{
				//if already hovering, done
				if(_mouseHoverNode == i) return;
				//if another node was hovering, unhover it
				if(_mouseHoverNode != -1)
					doNodeHover(_mouseHoverNode,true /*undoHover*/);
				
				_mouseHoverNode = i;
			}
			else 
				_mouseHoverNode = -1; //clear mouse hover
			
			//Debug.log((undoHover?"Hide ":"") + "Mouse over node " + i);
			
			if(i < -1 || (i == -1 && undoHover))
			{
				//do not show for mouse move modes
				if(!undoHover && _mouseMoveMode != _MMM_NONE) return; 
				
				//Debug.log("This is +/- icon " + (3-(i+13)));
				document.getElementsByClassName(
						"grid-plusMinusArrows")[(3-(i+13))].style.display = 
								undoHover?"none":"block";
				return;
			}
			
			var nodeid = "node-" + i;
			var el = document.getElementById(nodeid);	
			
			//handle points
			var points = el.getElementsByClassName("node-point");		
			for(var p=0;p<4;++p)
				points[p].style.display = undoHover?"none":"block";
			
			//do not show icons for mouse move modes
			if(!undoHover && _mouseMoveMode != _MMM_NONE) return;
			
			el = document.getElementById(nodeid + "-editIcon");
			el.style.display = undoHover?"none":"block";
			el = document.getElementById(nodeid + "-viewFclIcon");
			el.style.display = undoHover?"none":"block";
			el = document.getElementById(nodeid + "-deleteIcon");
			el.style.display = undoHover?"none":"block";
			
			var fontSz = getNodeFontSize();
			fontSz = undoHover?fontSz:fontSz*2;			
			var count = (_nodes[i].nodeCount && _nodes[i].nodeCount > 4)?4:(_nodes[i].nodeCount|0);		
						
			el = document.getElementById(nodeid + "-headerText");
			
			if(undoHover)
			{
				ConfigurationAPI.removeClass(el,"node-headerTextHover");
				el.style.top = ((-fontSz*3-fontSz/2 - (count?(count-1)*5:0))|0) + "px";
			}
			else
			{
				ConfigurationAPI.addClass(el,"node-headerTextHover");
				el.style.top = ((-fontSz*3-fontSz/2 -13 - (count?(count-1)*5:0))|0) + "px";
			}
			el.style.left = (- (_grid.xstep*2-_NODE_SIZE)/2 - (count?(count-1)*2:0)) + "px";
			el.style.fontSize = ((fontSz)|0) + "px";
			
			el.style.height = ((fontSz*3)|0) + "px";
			el.style.width = (_grid.xstep*2) + "px";
		} //end doNodeHover()

		//=====================================================================================
		//handlePointMouseDown ~~
		function handlePointMouseDown(i,p,e) 
		{	   
			e.stopPropagation();

			Debug.log("mousedown-point i,p = " +
					i + "," + p);
			
			if(_mouseMoveMode == _MMM_NONE)
			{
				Debug.log("Starting arrow drag mouseup-point i,p = " +
						i + "," + p);
				_mouseMoveMode = _MMM_ARROW_DRAG;
				_mouseMoveStart = getNodePoint(i,p);
				_mouseMoveStart[2] = i;
				_mouseMoveStart[3] = p;
			}
			
		} //end handlePointMouseDown()
		
		//=====================================================================================
		//handlePointMouseUp ~~
		function handlePointMouseUp(i,p,e) 
		{	   
			e.stopPropagation();
			
    		Debug.log("mouseup-point i,p = " +
    				i + "," + p);

    		var x = e.clientX;
    		var y = e.clientY;
    		
    		if(_mouseMoveMode != _MMM_NONE && //dragging arrow
    				i != _mouseMoveStart[2]) //and not at same starting point
    		{
				console.log("done arrow drag end-point i,p",i,p);
				_mouseMoveMode = _MMM_NONE;    	
				
				
				var starti = _mouseMoveStart[2];
				var endi = i;

				//				addArrow(
				//						_mouseMoveStart[2] /*startNodeIndex*/,
				//						i /*endNodeIndex*/,
				//						_mouseMoveStart[3] /*startNodePointIndex*/, 
				//						p /*endNodePointIndex*/);
				
				//validate connection
				//	 .. arrows follow rules based on subsystem settings:
				//	Readers -> all builders of same subsystem
				//	Builders -> all loggers of same subsystem AND builders of destination subsystem
				//	Loggers -> all dispatchers of same subsystem
				
				if(_nodes[starti].type == ArtdaqConfigurationAPI.NODE_TYPE_READER)
				{
					//for reader, check that destination is builder
					if(_nodes[endi].type != ArtdaqConfigurationAPI.NODE_TYPE_BUILDER)
					{
						Debug.log("Error! Destination node was type '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[_nodes[endi].type] + "'... " + 
								"The destination for a '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[_nodes[starti].type] + 
								" must be type '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_BUILDER] +
								".'",
								Debug.HIGH_PRIORITY);
						localHandleCleanup();
						return;
					}
					
					//destination is correct
					//	if destination is in current subsystem give error
					// 	else change destination subsystem
					
					if(_nodes[starti].subsystemId == _nodes[endi].subsystemId)
					{
						Debug.log("Error! Destination node is already in the same subsystem, so connection alread exists!",
								Debug.HIGH_PRIORITY);
						localHandleCleanup();
						return;
					}
					
					//else valid, so change start node subsystem
					
					Debug.log("The reader '" + 
							_nodes[starti].name + 
							"' was successfully moved from subsystem '" +
							_subsystems[_nodes[starti].subsystemId].label + "' to '" +
							_subsystems[_nodes[endi].subsystemId].label + 
							"!'", Debug.INFO_PRIORITY);
					
					_nodes[starti].subsystemId = _nodes[endi].subsystemId;

					//===== propagate change correctly
					initArrows();
					
					console.log("_nodes[starti]",_nodes[starti]);
					nodesHaveChanged();

					//delete element to force new paint
					var nodeid = "node-" + starti;
					var el = document.getElementById(nodeid);
					el.parentNode.removeChild(el);
					
					paint();
					return;
				} //end reader start-node handling
				else if(_nodes[starti].type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER)
				{
					//for builder, only logger of same subsytem or 
					//	builder of different subsystem is valid
					
					if(_nodes[endi].type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER)
					{
						if(_nodes[starti].subsystemId == _nodes[endi].subsystemId)
						{
							Debug.log("Error! Destination node is in the same subsystem, so connection is invalid!",
									Debug.HIGH_PRIORITY);
							localHandleCleanup();
							return;
						}
						
						//else valid, so change subsystem destinationId			
						
						_subsystems[_nodes[starti].subsystemId].destinationId = 
								_nodes[endi].subsystemId;
						
						Debug.log("The subsystem '" + 
								_subsystems[_nodes[starti].subsystemId].label + 
								"' destination was successfully changed to subsystem '" +
								_subsystems[_nodes[endi].subsystemId].label + 
								"!'", Debug.INFO_PRIORITY);
						
						//===== propagate change correctly
						initArrows();

						console.log("_subsystems[*starti]",_subsystems[_nodes[starti].subsystemId]);
						nodesHaveChanged();
						
						paint();
						return;
					}
					else if(_nodes[endi].type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER)
					{
						if(_nodes[starti].subsystemId == _nodes[endi].subsystemId)
						{
							Debug.log("Error! Destination node is in the same subsystem, so connection already exists!",
									Debug.HIGH_PRIORITY);
							localHandleCleanup();
							return;
						}
						
						//else valid, so change end node subsystem		
						
						Debug.log("The logger '" + 
								_nodes[endi].name + 
								"' was successfully moved from subsystem '" +
								_subsystems[_nodes[endi].subsystemId].label + "' to '" +
								_subsystems[_nodes[starti].subsystemId].label + 
								"!'", Debug.INFO_PRIORITY);

						_nodes[endi].subsystemId = _nodes[starti].subsystemId;						

						//===== propagate change correctly
						initArrows();

						console.log("_nodes[endi]",_nodes[endi]);
						nodesHaveChanged();

						//delete element to force new paint
						var nodeid = "node-" + endi;
						var el = document.getElementById(nodeid);
						el.parentNode.removeChild(el);

						paint();
						return;
					}
					else
					{
						Debug.log("Error! Destination node was type '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[_nodes[endi].type] + "'... " + 
								"The destination for a '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[_nodes[starti].type] + 
								" must be type '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_BUILDER] +
								"' or '" +
								ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_LOGGER] +
								".'",
								Debug.HIGH_PRIORITY);
						localHandleCleanup();
						return;
					}
					
					
				} //end builder start-node handling
				else if(_nodes[starti].type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER)
				{
					//for logger, can only go to dispatcher in same subsystem					

					//for reader, check that destination is builder
					if(_nodes[endi].type != ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER)
					{
						Debug.log("Error! Destination node was type '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[_nodes[endi].type] + "'... " + 
								"The destination for a '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[_nodes[starti].type] + 
								" must be type '" + 
								ArtdaqConfigurationAPI.NODE_TYPES[ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER] +
								".'",
								Debug.HIGH_PRIORITY);
						localHandleCleanup();
						return;
					}
					
					//destination is correct
					//	if destination is in current subsystem give error
					// 	else change destination subsystem
					
					if(_nodes[starti].subsystemId == _nodes[endi].subsystemId)
					{
						Debug.log("Error! Destination node is already in the same subsystem, so connection alread exists!",
								Debug.HIGH_PRIORITY);
						localHandleCleanup();
						return;
					}
					
					//else valid, so change end node subsystem		

					Debug.log("The dispatcher '" + 
							_nodes[endi].name + 
							"' was successfully moved from subsystem '" +
							_subsystems[_nodes[endi].subsystemId].label + "' to '" +
							_subsystems[_nodes[starti].subsystemId].label + 
							"!'", Debug.INFO_PRIORITY);

					_nodes[endi].subsystemId = _nodes[starti].subsystemId;						

					//===== propagate change correctly
					initArrows();

					console.log("_nodes[endi]",_nodes[endi]);
					nodesHaveChanged();

					//delete element to force new paint
					var nodeid = "node-" + endi;
					var el = document.getElementById(nodeid);
					el.parentNode.removeChild(el);

					paint();
					return;
				
				} //end logger start-node handling
				else if(_nodes[starti].type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER)
				{
					Debug.log("Error! Dispatcher's currently can not have destinations!",
							Debug.HIGH_PRIORITY);
					localHandleCleanup();
					return;
				}
				else
				{
					Debug.log("Impossible! Notify admins how you got here!", Debug.HIGH_PRIORITY);
					localHandleCleanup();
					return;
				}
				
    		}
    		
    		return;

    		//============
    		function localHandleCleanup()
    		{
    			Debug.log("localHandleCleanup()");
				paint();
    			
    		} //end localHandleCleanup()
    		
		} //end handlePointMouseUp()

		//=====================================================================================
		//handleEditIconMouseUp ~~
		function handleEditIconMouseUp(i,e,x) 
		{	   
			if(e) e.stopPropagation();
		
			if(x == undefined && _nodes[i].nodeCount && _nodes[i].nodeCount > 1)
			{
				Debug.log("Showing multi-node menu");
				
				//handle node vector level first
				var menuItems = [];
				var menuItemHandlers = [];

				menuItems.push("Edit <b><u>Multi-Node</u></b> (i.e. name, subsystem, host, instances)");
				menuItemHandlers.push("launchEditNodeDialog(" + i + ")");
				
				for(var j=0;j<_nodes[i].nodeCount;++j)
				{
					menuItems.push( "Edit <b><u>node[" + j +
							"]</u></b>");
					menuItemHandlers.push("handleEditIconMouseUp(" +
							i + ", undefined /*e*/, " +
							(event.pageX - 10) + " /*x*/" +
							")");
				}

				SimpleContextMenu.createMenu(
						menuItems,
						menuItemHandlers,
						"openFclMenuForArtdaqNode",		//element ID
						event.pageX - 10, event.pageY - 10, 		//top left position
						_MENU_PRIMARY_COLOR,
						_MENU_SECONDARY_COLOR,
						true /*defaultHighlighting*/
				);	
				
				return;
			}
			//else handle single node
			
			var type = _nodes[i].type;
						
			var typeName = 
				type == ArtdaqConfigurationAPI.NODE_TYPE_READER? 		"Reader":
				type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER? 		"Builder":
				type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER? 		"Logger":
				type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER? 	"Dispatcher":"Monitor";
			
			
			Debug.log("mouseup-edit i = " + i + " - " +
					typeName + "::" +
					_nodes[i].name);
			
			var editTypes = [						 
							 "Top-level Parameters"
							 ];			
			
			if(type == ArtdaqConfigurationAPI.NODE_TYPE_READER)
			{
				editTypes.push("DAQ Parameters");
				editTypes.push("DAQ Metrics");				
			}
			else if(type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER)
			{
				editTypes.push("Preamble Parameters");
				editTypes.push("DAQ Parameters");
				editTypes.push("DAQ Metrics");	
				editTypes.push("ART Physics Analyzers");
				editTypes.push("ART Physics Producers");
				editTypes.push("ART Physics Filters");	
				editTypes.push("ART Physics Other Parameters");		
				editTypes.push("Add-on Parameters");				
			}
			
			
			var menuItems = [];
			var menuItemHandlers = [];
			
			menuItems.push("Edit <b><u>Node</u></b> (i.e. name, subsystem, host, instances)");
			menuItemHandlers.push("launchEditNodeDialog(" + i + ")");
			
			for(var t=0;t<editTypes.length;++t)
			{
				menuItems.push( "Edit <b><u>" + editTypes[t] +
						"</u></b> of " + typeName + "::" + 
						_nodes[i].name);
				menuItemHandlers.push("handleEditIconMenuSelection(" +
						i + "," + t + ", undefined /*newTab*/, " +
						(event.pageX - 10) + ", " +
						(event.pageY - 10) + ", " 
						+ "\"" + editTypes[t]  + "\"" +
						")");
			} //end edit type loop
						
			SimpleContextMenu.createMenu(
					menuItems,
					menuItemHandlers,
					"openFclMenuForArtdaqNode",		//element ID
					(x?x:(event.pageX - 10)),
					event.pageY - 10, 		//top left position
					_MENU_PRIMARY_COLOR,
					_MENU_SECONDARY_COLOR,
					true /*defaultHighlighting*/
			);			
			
		} // end handleEditIconMouseUp()

		//=====================================================================================
		//handleEditIconMenuSelection ~~
		//	handle menu selection for node i
		//	based on editType
		function handleEditIconMenuSelection(i,editType, newTab, x, y, editTypeString) 
		{	   
			
			Debug.log("handleEditIconMenuSelection " + i + "-" + 
					editType + "-" + newTab);
			

			var type = _nodes[i].type;
			
			var typeName = 
				type == ArtdaqConfigurationAPI.NODE_TYPE_READER? 		"Reader":
				type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER? 		"Builder":
				type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER? 		"Logger":
				type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER? 	"Dispatcher":"Monitor";
			
			var typeBaseTable = 
				type == ArtdaqConfigurationAPI.NODE_TYPE_READER? 		"ARTDAQBoardReaderTable":
				type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER? 		"ARTDAQBuilderTable":
				type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER? 		"ARTDAQDataLoggerTable":
				type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER? 	"ARTDAQDispatcherTable":"ARTDAQMonitorTable";

			var subsetName = editTypeString;
//			switch(editType)
//			{
//			case 0: //top-level parameters
//				subsetName = "Top-level Parameters";
//				break;
//			case 1:
//				if(type == ArtdaqConfigurationAPI.NODE_TYPE_READER)
//					subsetName = "DAQ Parameters";
//				break;
//			case 2:
//				if(type == ArtdaqConfigurationAPI.NODE_TYPE_READER)
//					subsetName = "DAQ Metrics";
//				break;
//			default:
//				Debug.log("Unknown impossible (notify admins) editType = " + editType, Debug.HIGH_PRIORITY);
//				return;
//			}

			if(newTab === undefined)
			{
				//create menu to choose new tab or not
				var menuItems = [];
				var menuItemHandlers = [];

				menuItems.push( "Edit <b><u>" + subsetName +
						"</u></b> of " + typeName + "::" + 
						_nodes[i].name);
				menuItemHandlers.push("handleEditIconMenuSelection(" +
						i + "," + editType + ", false /*newTab*/)");
				menuItems.push( "Edit <b><u>" + subsetName +
						"</u></b> of " + typeName + "::" + 
						_nodes[i].name + 
						" in a <label style='color:rgb(251, 128, 67);font-weight:bold;'>new browser tab</font>");
				menuItemHandlers.push("handleEditIconMenuSelection(" +
						i + "," + editType + ", true /*newTab*/)");


				SimpleContextMenu.createMenu(
						menuItems,
						menuItemHandlers,
						"openFclMenuForArtdaqNode",		//element ID
						x, event.pageY - 10, 		//top left position
						_MENU_PRIMARY_COLOR,
						_MENU_SECONDARY_COLOR,
						true /*defaultHighlighting*/
				);			
				return;
			}
			
			var newWindowStr;
			
			switch(editType)
			{
			case 0: //top-level parameters

				
				newWindowStr = "/WebPath/html/ConfigurationGUI_subset.html?urn=" +
					DesktopContent._localUrnLid +
					"&subsetBasePath=" + typeBaseTable +
					"&groupingFieldList=AUTO" +
					"&recordAlias=" + typeName + "s" +
					"&editableFieldList=" + "!*CommentDescription";
				
				//for unique link, presect UID record							
				newWindowStr += "&selectedRecords=" + _nodes[i].name;
				
				localLaunchWindow();
				
				break;

			case 1: 

				if(type == ArtdaqConfigurationAPI.NODE_TYPE_READER)
				{
					//Reader DAQ parameters
					Debug.log("Reader DAQ parameters");
					

					newWindowStr = "/WebPath/html/ConfigurationGUI_subset.html?urn=" +
						DesktopContent._localUrnLid +
						"&subsetBasePath=" + "ARTDAQDaqParameterTable" +
						"&groupingFieldList=AUTO" +
						"&recordAlias=" + encodeURIComponent(typeName + " " + subsetName) +
						"&editableFieldList=" + "!*CommentDescription";
										
					localGetLinkId("daqParametersLink",
							function(childLinkIndex, linkId)
							{
						Debug.log("daqParametersLink childLinkIndex = '" +
								childLinkIndex + "' linkId = '" + 
								linkId + "'");

						//for group link, pre-select GroupID value							
						newWindowStr += "&selectedGroupIDs=" +
								encodeURIComponent(
										childLinkIndex + "=" +
										linkId);

						localLaunchWindow();
						
							}); //end localGetLinkId handler
				}

				break;
			case 2: 

				if(type == ArtdaqConfigurationAPI.NODE_TYPE_READER)
				{
					//Reader DAQ Metrics
					Debug.log("Reader DAQ Metrics");
					
					newWindowStr = "/WebPath/html/ConfigurationGUI_subset.html?urn=" +
							DesktopContent._localUrnLid +
							"&subsetBasePath=" + "ARTDAQMetricTable" +
							"&groupingFieldList=AUTO" +
							"&recordAlias=" + encodeURIComponent(typeName + " " + subsetName) +
							"&editableFieldList=" + "!*CommentDescription";

					localGetLinkId("daqMetricsLink",
							function(childLinkIndex, linkId)
							{
						Debug.log("daqMetricsLink childLinkIndex = '" +
								childLinkIndex + "' linkId = '" + 
								linkId + "'");

						//for group link, pre-select GroupID value							
						newWindowStr += "&selectedGroupIDs=" +
								encodeURIComponent(
										childLinkIndex + "=" +
										linkId);

						localLaunchWindow();

							}); //end localGetLinkId handler
				}
				break;
			default:
				Debug.log("Unknown impossible (notify admins) editType = " + editType, Debug.HIGH_PRIORITY);
			}

			return;
			
			//===============
			function localLaunchWindow(fieldPath, handler)
			{
				Debug.log("newWindowStr " + newWindowStr);
				if(newTab)
					DesktopContent.openNewBrowserTab(
						typeName + " " + subsetName,
						"",
						newWindowStr, false /*unique*/);
				else
					DesktopContent.openNewWindow(
						typeName + " " + subsetName,
						"",
						newWindowStr, false /*unique*/);
			} //end localLaunchWindow()
						

			//===============
			function localGetLinkId(fieldPath, handler)
			{
				Debug.log("localGetLinkId");
				
				//ConfigurationAPI.getFieldsOfRecords(
				//	subsetBasePath,recordArr,fieldList,
				//		maxDepth,responseHandler,modifiedTables)
				ConfigurationAPI.getFieldsOfRecords(
						typeBaseTable,
						_nodes[i].name,
						fieldPath,
						1,
						function(fieldRetObj)
						{
					console.log("localGetLinkId getFieldsOfRecords",fieldRetObj);

					if(fieldRetObj[0].fieldColumnType.indexOf("ChildLink-") != 0 ||
							fieldRetObj.length != 2)
					{
						Debug.log("Invalid link to get '" + fieldPath +
								"' - notify admins! (returned field objects = " +
								fieldRetObj.length + ")", Debug.HIGH_PRIORITY);
						return;
					}
					

					//ConfigurationAPI.getFieldValuesForRecords(
					//	subsetBasePath,recordArr,fieldObjArr,
					//	responseHandler,modifiedTables)
					ConfigurationAPI.getFieldValuesForRecords(
							typeBaseTable,
							_nodes[i].name,
							fieldRetObj[1].fieldRelativePath + 
							fieldRetObj[1].fieldColumnName,
							function(retObj)
							{
						console.log("localGetLinkId getFieldValuesForRecords",retObj);
						
						//pass link index and link ID to handler
						handler(
								fieldRetObj[0].fieldColumnType.split('-')[1], 
								retObj[0].fieldValue);

							}); //end ConfigurationAPI.getFieldValuesForRecords() call
					
						}); //end ConfigurationAPI.getFieldsOfRecords() call

			} //end localGetLinkId()
			
		} // end handleEditIconMenuSelection()

		//=====================================================================================
		//launchEditNodeDialog ~~
		function launchEditNodeDialog(i) 
		{	   
			Debug.log("launchEditNodeDialog node size " + _nodes[i].nodeCount);

			var type = _nodes[i].type;
			var typeName = 
				type == ArtdaqConfigurationAPI.NODE_TYPE_READER? 		"Reader":
				type == ArtdaqConfigurationAPI.NODE_TYPE_BUILDER? 		"Builder":
				type == ArtdaqConfigurationAPI.NODE_TYPE_LOGGER? 		"Logger":
				type == ArtdaqConfigurationAPI.NODE_TYPE_DISPATCHER? 	"Dispatcher":"Monitor";
		
			
			//undo hover node, if any
			if(_mouseHoverNode != -1)
				doNodeHover(_mouseHoverNode,true /*undoHover*/);

			_mouseMoveMode = _MMM_POPUP_DIALOG;
			Debug.log("openActiveGroupsDialog()");
			
			var ctrlStr = "";
			ctrlStr += htmlOpen("input",
					{
							"class": "closeButton",
							"type": "button",
							"style": "margin:20px;",
							"value": "Close",
							"title": "Close this dialog."
					},
					0 /*html*/, true /*closeTag*/);	

			var str = "";
			
			str += "You are editing the node originally named " + 
					typeName + "::" + _nodes[i].name + "..."; 
					
			var isMultiNode = _nodes[i].name.indexOf('*') >= 0;
			var isHostnameArray = _nodes[i].hostname.indexOf('*') >= 0;
			var isHostnameFixedWidth = _nodes[i].hostnameFixedWidthSize && _nodes[i].hostnameFixedWidthSize > 1;

			str += htmlClearDiv();
			str += "<br><table style='margin-bottom: 10px;'>";
			str += "<tr><td><b>Node Name:</b></td><td>";
			str += htmlOpen("input",
					{
							"id": "ediNode-" + "nodeName",
							"type": "text",
							"value": _nodes[i].name,
							"title": "Set the node name template with * syntax.",
					},
					0 /*html*/, true /*closeTag*/);	
			str += "</td></tr>";
			
			str += "<tr><td colspan='2'>";

			str += htmlOpen("input",
					{
							"type": "checkbox",
							"id": "enableMultiNodeCheckbox",
							"class": "enableMultiNodeCheckbox",
							"checked": (isMultiNode?1:0),
							"onclick": "handleEditNodeDialogMultiNodeCheckbox(" + i + ",this);",
							"title": "Enable multi-node instances using printer syntax.",
					},
					htmlOpen("a",
							{
									"style": "text-decoration:none;color:black;",
									"onclick": "var el = document.getElementsByClassName(\"enableMultiNodeCheckbox\");" +
									"var forFirefox = (el[0].checked = !el[0].checked); " +
									"handleEditNodeDialogMultiNodeCheckbox(" + i + ",el[0]);"
									,
									"title": "Enable multi-node instances using printer syntax.",
							},
							"Enable Multi-node Instances" /*innerHTML*/,
							true /*doCloseTag*/
					) /*innerHTML*/,
					true /*doCloseTag*/);
			str += "</td></tr>";
			str += "</table>";

			str += htmlClearDiv();
			str += "<div id='multiNodeSettings' style='display:" + 
				(isMultiNode?"block":"none") + "'>";
			{ //start multi-node
				str += "Set the size of the multi-node by using 'printer page syntax' and one or many * characters." + 

						"<br>" + 
						"For example, to make 4 nodes named reader0_east, reader4_east, reader5_east, reader6_east, " + 
						"Set the node name to 'reader*_east' and set the multi-node indices to '" +
						"0,4-6'" +
						"<br>";

				str += htmlClearDiv();
				str += "<br><table style='margin-bottom: 10px;'>";
						

				str += "<tr><td><b>Multi-Node Indices:</b></td><td>";
				str += htmlOpen("input",
						{
								"id": "ediNode-" + "nodeIndices",
								"type": "text",
								"value": (_nodes[i].nodeVectorIndexString?_nodes[i].nodeVectorIndexString:""),
								"title": "Set the multi-node indices with printer page syntax.",
						},
						0 /*html*/, true /*closeTag*/);	
				str += "</td></tr>";



				str += "</table>";
				
				str += htmlOpen("input",
						{
								"type": "checkbox",
								"id": "enableHostnameArrayCheckbox",
								"class": "enableHostnameArrayCheckbox",
								"checked": (isHostnameArray?1:0),
								"onclick": "handleEditNodeDialogHostnameArrayCheckbox(" + i + ",this);",
								"title": "Enable associating the nodes with an array of hostnames.",
						},
						htmlOpen("a",
								{
										"style": "text-decoration:none;color:black;",
										"onclick": "var el = document.getElementsByClassName(\"enableHostnameArrayCheckbox\");" +
										"var forFirefox = (el[0].checked = !el[0].checked); " +
										"handleEditNodeDialogHostnameArrayCheckbox(" + i + ",el[0]);"
										,
										"title": "Enable associating the nodes with an array of hostnames.",
								},
								"Associate multi-node instances with an array of hostnames." /*innerHTML*/,
								true /*doCloseTag*/
						) /*innerHTML*/,
						true /*doCloseTag*/);
				
			} //end multi-node
			str += "</div>"; //close multi-node settings div
			
			str += htmlClearDiv();
			
			str += "<div id='hostnameArraySettings' style='display:" + 
					(isHostnameArray?"block":"none") + "'>";
			{ //start hostnameArraySettings 
				str += "<br>Use 'printer page syntax' and *'s for the hostnames too!" +
						"<br>(Do not forget to add the * to the hostname field.)" +
						"<br>";

				str += htmlClearDiv();
				str += "<br><table style='margin-bottom: 10px;'>";


				str += "<tr><td><b>Hostname Indices:</b></td><td>";
				str += htmlOpen("input",
						{
								"id": "ediNode-" + "hostnameIndices",
								"type": "text",
								"value": (_nodes[i].hostnameVectorIndexString?_nodes[i].hostnameVectorIndexString:""),
								"title": "Set the hostname indices with printer page syntax.",
						},
						0 /*html*/, true /*closeTag*/);	
				str += "</td></tr>";



				str += "</table>";

				str += htmlOpen("input",
						{
								"type": "checkbox",
								"id": "enableHostnameFixedWidthCheckbox",
								"class": "enableHostnameFixedWidthCheckbox",
								"checked": (isHostnameFixedWidth?1:0),
								"onclick": "handleEditNodeDialogHostnameFixedWidthCheckbox(" + i + ",this);",
						},
						htmlOpen("a",
								{
										"style": "text-decoration:none;color:black;",
										"onclick": "var el = document.getElementsByClassName(\"enableHostnameFixedWidthCheckbox\");" +
										"var forFirefox = (el[0].checked = !el[0].checked); " +
										"handleEditNodeDialogHostnameFixedWidthCheckbox(" + i + ",el[0]);"
										,
								},
								"Enable Fixed-Width Hostnames" /*innerHTML*/,
								true /*doCloseTag*/
						) /*innerHTML*/,
						true /*doCloseTag*/);
				
			} //end hostnameArraySettings
			str += "</div>"; //close hostnameArray settings div

			str += htmlClearDiv();
			str += "<div id='hostnameFixedWidthSettings' style='display:" + 
					(isHostnameFixedWidth?"block":"none") + "'>";
			{ //start hostname fixed-width
				str += "<br>Force the number of digits to a fixed-width within" +
						" each hostname (e.g. 3 would yield numbers like 001, 002, etc.)." +
						"<br>";

				str += htmlClearDiv();
				str += "<br><table style='margin-bottom: 10px;'>";


				str += "<tr><td><b>Fixed-width Size:</b></td><td>";
				str += htmlOpen("input",
						{
								"id": "ediNode-" + "hostnameFixedWidth",
								"type": "text",
								"style": "width:50px;",
								"value": (_nodes[i].hostnameFixedWidthSize?_nodes[i].hostnameFixedWidthSize:2),
								"title": "Set the number of digits for fixed-width numbering in the hostname.",
						},
						0 /*html*/, true /*closeTag*/);	
				str += "</td></tr>";

				str += "</table>";
				
			} //end hostname fixed-width
			str += "</div>"; //close hostname fixed-width settings div
			
			str += htmlClearDiv();
			
			str += "<br><table style='margin-bottom: 10px;'>";
			str += "<tr><td style='text-align:right'><b>Subsystem Name:</b></td><td>";
			{ //start subsystems
				str += htmlOpen("select",
						{
								"id": "ediNode-" + "subsystem",
								"style": "float: left; margin: 7px;",
						});

				for(var j in _subsystems)
				{
					if(j == 0) continue; //skip null destination subsystem
					
					str += "<option " + 	
							(j == _nodes[i].subsystemId?"selected":"") + ">" +
							_subsystems[j].label + 
							"</option>";
				}
				str += "</select>"; //end aliases dropdown

				str += htmlOpen("input",
						{
								"id": "ediNode-" + "subsystemText",
								"style": "display:none; float: left;",
								"type": "text",
								"value": "",
								"title": "Set the subsystem for this node.",
						},
						0 /*html*/, true /*closeTag*/);	

				str += htmlOpen("div",
						{
								"id": "subsystem-editIcon",
								"class": "node-editIcon",
								"style": "display:block; float:right; margin: 6px 0 0 1px",
								"onclick": "handleEditNodeSelectEditIcon(0);",
								"title": "Toggle free-form hostname editing",
						},
						0 /*html*/, true /*closeTag*/);	
			} //end subsystems
			str += "</td></tr>";
			

			str += "<tr><td style='text-align:right'><b>Hostname:</b></td><td>";
			{ //start hostnames
				str += htmlOpen("select",
						{
								"id": "ediNode-" + "hostname",
								"style": "float: left; margin: 7px;",
						});

				for(var j in _hostnames)
				{
					str += "<option " + 	
							(j == _nodes[i].hostname?"selected":"") + ">" +
							j + 
							"</option>";					
				}
				str += "</select>"; //end aliases dropdown

				str += htmlOpen("input",
						{
								"id": "ediNode-" + "hostnameText",
								"style": "display:none; float: left;",
								"type": "text",
								"value": "",
								"title": "Set the hostname for this node.",
						},
						0 /*html*/, true /*closeTag*/);	

				str += htmlOpen("div",
						{
								"id": "hostname-editIcon",
								"class": "node-editIcon",
								"style": "display:block; float:right; margin: 6px 0 0 1px",
								"onclick": "handleEditNodeSelectEditIcon(1);",
								"title": "Toggle free-form hostname editing",
						},
						0 /*html*/, true /*closeTag*/);	
				
			} //end hostnames
			str += "</td></tr>";
			str += "</table>";

			str += htmlClearDiv();

			
			str += htmlOpen("input",
					{
							"id": "ediNode-" + "saveNode",
							"type": "button",
							"value": "Save Node Settings",
							"title": "Save the settings for this node."
					},
					0 /*html*/, true /*closeTag*/);	
			
			//remove all existing dialogs
			ConfigurationAPI.removeAllPopUps();

			//make popup element
			el = document.createElement("div");			
			el.setAttribute("id", ConfigurationAPI._POP_UP_DIALOG_ID);

			ConfigurationAPI.setPopUpPosition(el,
					undefined /*w*/,
					undefined /*h*/, 
					undefined /*padding*/, 
					undefined /*border*/,
					50 /*margin*/);

			el.innerHTML = ctrlStr + htmlClearDiv() + 
					str + htmlClearDiv(); // + ctrlStr;
			document.body.appendChild(el);

			localAddHandlers();

			return;
			
			//==========
			function localAddHandlers()
			{ //start localAddHandlers			

				var closeButtons = document.getElementsByClassName("closeButton");
				for(var b=0;b<closeButtons.length;++b)
					closeButtons[b].onclick = 
							localCloseButtonHandler;

				/////////////////////////////////
				function localCloseButtonHandler()
				{
					Debug.log("localCloseButtonHandler()");

					//remove all existing dialogs
					ConfigurationAPI.removeAllPopUps();

					_mouseMoveMode = _MMM_NONE;
				} //end localCloseButtonHandler()

				/////////////////////////////////
				document.getElementById("ediNode-" + "saveNode").onclick = 
						function()
						{
					//since multiple, use id to identify
					Debug.log("Saving multi-node settings for node " + i);
					
					
					var nodeNameTemplate = document.getElementById("ediNode-" + "nodeName").value;
					var nodeIndices = document.getElementById("ediNode-" + "nodeIndices").value;					
					var subsystem = document.getElementById("ediNode-" + 
							"subsystem").style.display == "none"?
									document.getElementById("ediNode-" + "subsystemText").value:
									document.getElementById("ediNode-" + "subsystem").value;
					var hostname = document.getElementById("ediNode-" + 
							"hostname").style.display == "none"?
									document.getElementById("ediNode-" + "hostnameText").value:
									document.getElementById("ediNode-" + "hostname").value;
					
					var hostnameIndices = document.getElementById("ediNode-" + "hostnameIndices").value;					
					var hostnameFixedWidth = document.getElementById("ediNode-" + "hostnameFixedWidth").value | 0;					
																
					
					Debug.log("Node name template = " + nodeNameTemplate);
					
					var el = document.getElementsByClassName("enableMultiNodeCheckbox");
					if(el.length && !el[0].checked) 
						nodeIndices = ""; //clear multi-node string if not checked
					el = document.getElementsByClassName("enableHostnameArrayCheckbox");
					if(el.length && !el[0].checked) 
					{
						//clear hostnameIndices string and hostnameFixedWidth if not checked
						hostnameIndices = ""; 
						hostnameFixedWidth = 0;
					}
					el = document.getElementsByClassName("enableHostnameFixedWidthCheckbox");
					if(el.length && !el[0].checked) 
						hostnameFixedWidth = 0; //clear hostnameFixedWidth if not checked

					Debug.log("Node indices = " + nodeIndices);
					Debug.log("Hostname indices = " + hostnameIndices);
					Debug.log("hostnameFixedWidth = " + hostnameFixedWidth);
					
					var nodeVectorIndexString = nodeIndices;
					var nodeVectorIndexArr = []; //reset
					var nodeVectorIndexReverseMap = {}; //reset
					
					nodeIndices = nodeIndices.split(',');
					var nodeCount = 0;
					for(var j=0;j<nodeIndices.length;j++)
					{
						var nodeSubindices = nodeIndices[j].split('-');
						
						if(nodeSubindices.length == 1)
						{
							var index = nodeSubindices[0].trim();
							
							if(nodeVectorIndexReverseMap[index])
							{
								Debug.log("Illegal Node Indices - repeat indices (i.e. '" +
										index + "') are not allowed.",
										Debug.HIGH_PRIORITY);
								return;								
							}
							nodeVectorIndexReverseMap[index] = nodeCount++;
							nodeVectorIndexArr.push(index);							
						}
						else if(nodeSubindices.length == 2)
						{
							var hi = nodeSubindices[1].trim() | 0;
							var lo = nodeSubindices[0].trim() | 0;
							if(hi <= lo)
							{
								Debug.log("Illegal Node Indices - please use printer page syntax (e.g. '0,4-6').",
										Debug.HIGH_PRIORITY);
								return;
							}
							
							for(var k=lo;k<=hi;++k)
							{
								if(nodeVectorIndexReverseMap[k])
								{
									Debug.log("Illegal Node Indices - repeat indices (i.e. '" +
											k + "') are not allowed.",
											Debug.HIGH_PRIORITY);
									return;								
								}
								nodeVectorIndexReverseMap[k] = nodeCount++;
								nodeVectorIndexArr.push(k);								
							}
						}
						else
						{
							Debug.log("Illegal Node Indices - please use printer page syntax (e.g. '0,4-6').",
									Debug.HIGH_PRIORITY);
							return;
						}
					} //end extract node indices
					console.log("nodeCount",nodeCount); 
					console.log("nodeVectorIndexArr",nodeVectorIndexArr); 
					console.log("nodeVectorIndexReverseMap",nodeVectorIndexReverseMap); 
					
					if(nodeCount> 1 && 
							nodeNameTemplate.indexOf('*') < 0)
					{
						Debug.log("Illegal Node Name for multi-node - please use * to indicate where the instance index should be (e.g. 'reader*' to make reader0, reader1, etc..).",
								Debug.HIGH_PRIORITY);
						return;
					}
					

					var hostnameVectorIndexString = hostnameIndices;
					var hostnameVectorIndexArr = []; //reset
					var hostnameVectorIndexReverseMap = {}; //reset
					

					hostnameIndices = hostnameIndices.split(',');
					var hostnameCount = 0;
					for(var j=0;j<hostnameIndices.length;j++)
					{
						var hostnameSubindices = hostnameIndices[j].split('-');
						
						if(hostnameSubindices.length == 1)
						{
							var index = hostnameSubindices[0].trim();
							
							if(hostnameVectorIndexReverseMap[index])
							{
								Debug.log("Illegal Hostname Indices - repeat indices (i.e. '" +
										index + "') are not allowed.",
										Debug.HIGH_PRIORITY);
								return;								
							}
							hostnameVectorIndexReverseMap[index] = hostnameCount++;
							hostnameVectorIndexArr.push(index);							
						}
						else if(hostnameSubindices.length == 2)
						{
							var hi = hostnameSubindices[1].trim() | 0;
							var lo = hostnameSubindices[0].trim() | 0;
							if(hi <= lo)
							{
								Debug.log("Illegal Hostname Indices - please use printer page syntax (e.g. '0,4-6').",
										Debug.HIGH_PRIORITY);
								return;
							}
							
							for(var k=lo;k<=hi;++k)
							{
								if(hostnameVectorIndexReverseMap[k])
								{
									Debug.log("Illegal Hostname Indices - repeat indices (i.e. '" +
											k + "') are not allowed.",
											Debug.HIGH_PRIORITY);
									return;								
								}
								hostnameVectorIndexReverseMap[k] = hostnameCount++;
								hostnameVectorIndexArr.push(k);								
							}
						}
						else
						{
							Debug.log("Illegal Hostname Indices - please use printer page syntax (e.g. '0,4-6').",
									Debug.HIGH_PRIORITY);
							return;
						}
					} //end extract node indices
					console.log("hostnameCount",hostnameCount); 
					console.log("hostnameVectorIndexArr",hostnameVectorIndexArr); 
					console.log("hostnameVectorIndexReverseMap",hostnameVectorIndexReverseMap); 
					
					if(hostnameCount> 1 && 
							hostname.indexOf('*') < 0)
					{
						Debug.log("Illegal Hostname for associating an array of hostnames to multiple " +
								"node instances - please use * in the hostname (click the pencil to type in the hostname field) to indicate where the hostname index should be (e.g. 'host*' to make host0, host1, etc..).",
								Debug.HIGH_PRIORITY);
						return;
					}
					if(hostnameCount> 1 && 
							hostnameCount != nodeCount)
					{
						Debug.log("Illegal array of hostnames. Size " + hostnameCount +
								" is not equal to the number of node instances which is " +
								nodeCount + " - there must be a one-to-one correspondence " +
								"between hostname and node, or else all nodes must be placed on the same host.",
								Debug.HIGH_PRIORITY);
						return;
					}
					
					
					//at this point, the change has been verified!
					// so set node values
					_nodes[i].nodeCount = nodeCount;
					_nodes[i].nodeVectorIndexString = nodeVectorIndexString;
					_nodes[i].nodeVectorIndexArr = nodeVectorIndexArr;
					_nodes[i].nodeVectorIndexReverseMap = nodeVectorIndexReverseMap;
					_nodes[i].name = nodeNameTemplate;

					_nodes[i].hostnameVectorIndexString = hostnameVectorIndexString;
					_nodes[i].hostnameVectorIndexArr = hostnameVectorIndexArr;
					_nodes[i].hostnameVectorIndexReverseMap = hostnameVectorIndexReverseMap;
					_nodes[i].hostnameFixedWidth = hostnameFixedWidth;
					//handle hostname change
					if(_nodes[i].hostname != hostname)
					{
						//enter in hostnames
						_hostnames[hostname] = 1;
						_nodes[i].hostname = hostname;
					}

					//handle subsystem change
					var subsystemId = 0;
					for(var j in _subsystems)
						if(_subsystems[j].label == subsystem)
						{
							subsystemId = j;
							break;
						}
					if(subsystemId == 0 && 
							subsystem != ArtdaqConfigurationAPI.NULL_SUBSYSTEM)
					{
						//create new subsystem
						subsystemId = j+2;
						Debug.log("Creating subsystem " + 
								subsystemId + ":" + subsystem);
						_subsystems[subsystemId] = {"label" : subsystem};
						console.log("_subsystems",_subsystems);
					}
					
					if(_nodes[i].subsystemId != subsystemId)
					{
						Debug.log("handling subsystem change from " + 
								_nodes[i].subsystemId + ":" + 
								_subsystems[j].label + " to " +
								_nodes[subsystemId].subsystemId + ":" + 
								_subsystems[subsystemId].label)
														
						_nodes[i].subsystemId = subsystemId;
						
						//subsystem change liekly affects arrows, so update
						initArrows();
					}
					
					console.log("_nodes[i]",_nodes[i]);
					nodesHaveChanged();
					
					//delete element to force new paint
					var nodeid = "node-" + i;
					var el = document.getElementById(nodeid);
					el.parentNode.removeChild(el);
					
					paint();
					
					//remove all existing dialogs
					ConfigurationAPI.removeAllPopUps();

					_mouseMoveMode = _MMM_NONE;
					
						}; //end saveMultiNode click handler
				
			} //end localAddHandlers()
			
		} // end launchEditNodeDialog()
				
		//=====================================================================================
		//handleEditNodeDialogMultiNodeCheckbox ~~
		function handleEditNodeDialogMultiNodeCheckbox(i,obj) 
		{
			Debug.log("handleEditNodeDialogMultiNodeCheckbox " + i + 
					" - " + obj.checked);
			
				
			document.getElementById("multiNodeSettings").style.display =
					obj.checked?"block":"none";
			
			if(!obj.checked)
			{
				var nodeNameValue = _nodes[i].originalName;
				if(nodeNameValue.indexOf('*') >= 0) //remove all *
					nodeNameValue = nodeNameValue.replace(new RegExp("\\*",'g'), 
													'0');
				document.getElementById("ediNode-" + "nodeName").value = 
						nodeNameValue;	
				return;
			}
			
			//else try to place * for user
			
			var nodeNameValue = _nodes[i].name;
			if(nodeNameValue.indexOf('*') < 0)
			{
				//check for a number in the name to help with default wildcard placement
				//	from back
				for(var j=nodeNameValue.length-1;j >= 0; --j)
				{
					if(nodeNameValue[j] >= '0' && nodeNameValue[j] <= '9')
					{
						//found first number, see if it continues
						var k = j;
						for(j=j-1;j >= 0; --j)
							if(nodeNameValue[j] < '0' || nodeNameValue[j] > '9')
							{
								//done with number, so set value

								nodeNameValue = 
										nodeNameValue.substr(0,j+1) + '*' +
										nodeNameValue.substr(k+1);
								break;
							}
						break;
					}
				}
			}
			if(nodeNameValue.indexOf('*') < 0) //if still no *, add
				nodeNameValue += '*';
			
			document.getElementById("ediNode-" + "nodeName").value = nodeNameValue;
			
		} //end handleEditNodeDialogMultiNodeCheckbox()
				
		//=====================================================================================
		//handleEditNodeDialogHostnameArrayCheckbox ~~
		function handleEditNodeDialogHostnameArrayCheckbox(i,obj) 
		{
			Debug.log("handleEditNodeDialogHostnameArrayCheckbox " + i + 
					" - " + obj.checked);
			
				
			document.getElementById("hostnameArraySettings").style.display =
					obj.checked?"block":"none";			
			
		} //end handleEditNodeDialogHostnameArrayCheckbox()

		//=====================================================================================
		//handleEditNodeDialogHostnameFixedWidthCheckbox
		function handleEditNodeDialogHostnameFixedWidthCheckbox(i,obj) 
		{
			Debug.log("handleEditNodeDialogHostnameFixedWidthCheckbox " + i + 
					" - " + obj.checked);
			
				
			document.getElementById("hostnameFixedWidthSettings").style.display =
					obj.checked?"block":"none";			
			
		} //end handleEditNodeDialogHostnameFixedWidthCheckbox()
		
		//=====================================================================================
		//handleEditNodeSelectEditIcon ~~
		function handleEditNodeSelectEditIcon(t) 
		{	   
			Debug.log("handleEditNodeSelectEditIcon " + t);
			
			var sel, tel;
			if(t == 0) //toggle subsystem select/text
			{
				sel = document.getElementById("ediNode-" + "subsystem");
				tel = document.getElementById("ediNode-" + "subsystemText");				
			}
			else if(t == 1) //toggle hostname select/text
			{
				sel = document.getElementById("ediNode-" + "hostname");
				tel = document.getElementById("ediNode-" + "hostnameText");
			}

			Debug.log("sel.style.display  " + sel.style.display);
			if (sel.style.display == "none") 
			{
				sel.style.display = "block";
				tel.style.display = "none";
			}
			else 
			{
				tel.style.width = ((sel.offsetWidth > 200 ? sel.offsetWidth : 200) - 8) + "px";
				sel.style.display = "none";
				tel.style.display = "block";
				if(tel.value == "")
					tel.value = sel.value; //take value from select
				ConfigurationAPI.setCaretPosition(tel, 0, tel.value.length);
			}
		} //end handleEditNodeSelectEditIcon()
		
		//=====================================================================================
		//handleFclIconMouseUp ~~
		function handleFclIconMouseUp(i,e) 
		{	   
			e.stopPropagation();
		
			if(!_codeEditorAppId)
			{
				Debug.log("No active Code Editor Supervisor found. Can not open files without a Code Editor Supervisor. " + 
						"Please edit the Context group to include a Code Editor Supervisor and relaunch ots.",
						Debug.HIGH_PRIORITY);
				return;
			}
					
			Debug.log("mouseup-fcl i = " + i + " - " + 
					_nodes[i].name);				   
		
			var menuItems = [
							 "Open FHiCL for " + _nodes[i].name + " in a desktop window",
							 "Open FHiCL for " + _nodes[i].name + " in a new browser tab"
									 ];
			var menuItemHandlers = [];

			var filename = "/$USER_DATA/ARTDAQConfigurations/" + 
					ArtdaqConfigurationAPI.NODE_TYPES[_nodes[i].type] + "-" +
					_nodes[i].name + ".fcl";
			console.log("filename",filename);
			

			//Call like this: DesktopContent.openNewBrowserTab(name,subname,windowPath,unique)

			//url should look like this:
			//http://correlator2.fnal.gov:2015/urn:xdaq-application:lid=290/
			//	Verify?code=fa37&requestingWindowId=1001&
			//	windowName=Code%20Editor&windowSubname=&
			//	windowUnique=0&windowPath=/WebPath/html/CodeEditor.html?urn=240&
			//	startFilePrimary=/$USER_DATA/ARTDAQConfigurations/builder-builder1.fcl#0

			var newwindowJS;
			var newWindowStr;
			
			newWindowStr = "/WebPath/html/CodeEditor.html?" +
					"urn=" + _codeEditorAppId +
					"&readOnlyMode=1" +
					"&startFilePrimary=" + filename;
						
			newWindowStr = newWindowStr.replace(/"/g, "\\\"");
			
			Debug.log("newWindowStr = " + newWindowStr);
			
			newwindowJS = "DesktopContent.openNewWindow(" +
					"\"Code Editor\" /*name*/," + 
					"\"\" /*subname*/,\"" +
					newWindowStr + "\"," +
					"false /*unique*/);";
			
			Debug.log("newwindowJS = " + newwindowJS);

			menuItemHandlers.push(newwindowJS);
			
			newwindowJS = "DesktopContent.openNewBrowserTab(" +
					"\"Code Editor\" /*name*/," + 
					"\"\" /*subname*/,\"" +
					newWindowStr + "\"," +
					"false /*unique*/);";

			Debug.log("newwindowJS = " + newwindowJS);

			menuItemHandlers.push(newwindowJS);
//			DesktopContent.openNewBrowserTab(
//					"Code Editor", //must match desktop icon to look up URN (?)
//					"" /*subname*/,
//					newWindowStr /*windowPath*/,
//					0 /*unique*/
//			);
			
			
			
			SimpleContextMenu.createMenu(
					menuItems,
					menuItemHandlers,
					"openFclMenuForArtdaqNode",		//element ID
					event.pageX - 1, event.pageY - 1, 		//top left position
					_MENU_PRIMARY_COLOR,
					_MENU_SECONDARY_COLOR,
					true /*defaultHighlighting*/
			);			
			
		} // end handleFclIconMouseUp()
		
		//=====================================================================================
		//handleDeleteIconMouseUp ~~
		function handleDeleteIconMouseUp(i,e) 
		{	   
			e.stopPropagation();
		
			Debug.log("mouseup-delete i = " + i);
			
			
		} // end handleDeleteIconMouseUp()
		
		//=====================================================================================
		//openActiveGroupsDialog ~~
		//	show update group options to activate
		function openActiveGroupsDialog()
		{
			//undo hover node, if any
			if(_mouseHoverNode != -1)
				doNodeHover(_mouseHoverNode,true /*undoHover*/);
			
			_mouseMoveMode = _MMM_POPUP_DIALOG;
			Debug.log("openActiveGroupsDialog()");

			_systemGroups = {}; //reset			

			//	get groups and aliases
			ConfigurationAPI.getAliasesAndGroups(
					function(retObj)
					{
				_systemGroups = retObj;
				console.log("_systemGroups",_systemGroups);
				console.log("ConfigurationAPI._activeGroups",ConfigurationAPI._activeGroups);

				localOpenActiveGroupsDialog();
					}); //end getAliasesAndGroups
			return;

			function localOpenActiveGroupsDialog()
			{	
				Debug.log("localOpenActiveGroupsDialog()");

				var ctrlStr = "";
				ctrlStr += htmlOpen("input",
						{
								"class": "closeButton",
								"type": "button",
								"style": "margin:20px;",
								"value": "Close",
								"title": "Close this dialog."
						},
						0 /*html*/, true /*closeTag*/);	

				var str = "";

				var groupTypes = ["Context","Configuration"];
				var stepString;

				for(var g=0;g<groupTypes.length;++g)
				{
					stepString = "chooseActiveGroups" + "-" +
							groupTypes[g] + "-";

					str += "Choose a '" + groupTypes[g] +
							"' group to activate (either a System Alias or specific group):";

					str += htmlClearDiv();

					str += "<center><br>";
					str += "Current active '" + groupTypes[g] +
							"' group: <b>" + 
							_systemGroups.activeGroups[groupTypes[g]].groupName + 
							"(" + 
							_systemGroups.activeGroups[groupTypes[g]].groupKey +
							")</b>";
					str += htmlClearDiv();
					str += "<br><table style='margin-bottom: 10px;'>";
					if(_systemGroups.aliases[groupTypes[g]].length)
					{
						str += "<tr><td><b>System Aliases:</b></td><td>";
						{ //start aliases
							str += htmlOpen("select",
									{
											"id" :		stepString + "aliases",
									});

							for(var i=0;i<_systemGroups.aliases[groupTypes[g]].length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.aliases[groupTypes[g]]
															  [i].alias /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end aliases dropdown
							str += htmlOpen("input",
									{
											"id": stepString + "activateAlias",
											"type": "button",
											"value": "Activate Alias",
											"title": "Activate chosen System Alias.",
									},
									0 /*html*/, true /*closeTag*/);	
						} //end aliases
						str += "</td></tr>";
					}
					else
						str += "<tr><td colspan='2'>No system aliases of type Context found.</td></tr>";

					var groupNames = Object.keys(_systemGroups.groups[groupTypes[g]]);
					if(groupNames.length)
					{
						str += "<tr><td><b>Group Names:</b></td><td>";
						{ //start groups
							str += htmlOpen("select",
									{
											"id" :		stepString + "groupNames",
									});

							for(var i=0;i<groupNames.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										groupNames[i] /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end group name dropdown

						} //end groups
						str += "</td></tr>";
					}
					else
						str += "<tr><td colspan='2'>No groups of type Context found.</td></tr>";

					if(groupNames.length)
					{
						str += "<tr><td><b>Group Keys:</b></td><td>";
						{ //start keys
							str += htmlOpen("select",
									{
											"id" :		stepString + "groupKeys",
									});

							for(var i=0;i<_systemGroups.groups[groupTypes[g]]
															   [groupNames[0]].keys.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.groups[groupTypes[g]]
															 [groupNames[0]].keys[i] /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end group keys dropdown
							str += htmlOpen("input",
									{
											"id": stepString + "activateGroup",
											"type": "button",
											"value": "Activate Group",
											"title": "Activate chosen Group and Key pair.",
									},
									0 /*html*/, true /*closeTag*/);	
						} //end keys
						str += "</td></tr>";
					}
					str += "</table>";
					str += "</center>";
				} //end group type loop

				//remove all existing dialogs
				ConfigurationAPI.removeAllPopUps();

				//make popup element
				el = document.createElement("div");			
				el.setAttribute("id", ConfigurationAPI._POP_UP_DIALOG_ID);

				ConfigurationAPI.setPopUpPosition(el,
						undefined /*w*/,
						undefined /*h*/, 
						undefined /*padding*/, 
						undefined /*border*/,
						50 /*margin*/);

				el.innerHTML = ctrlStr + htmlClearDiv() + 
						str + htmlClearDiv() + ctrlStr;
				document.body.appendChild(el);

				localAddHandlers();

				return;

				//==========
				function localAddHandlers()
				{ //start localAddHandlers			

					var closeButtons = document.getElementsByClassName("closeButton");
					for(var b=0;b<closeButtons.length;++b)
						closeButtons[b].onclick = 
								localCloseButtonHandler;

					/////////////////////////////////
					function localCloseButtonHandler()
					{
						Debug.log("localCloseButtonHandler()");

						//remove all existing dialogs
						ConfigurationAPI.removeAllPopUps();

						_mouseMoveMode = _MMM_NONE;
					} //end localCloseButtonHandler()

					var stepString;
					for(var g=0;g<groupTypes.length;++g)
					{
						stepString = "chooseActiveGroups-" + 
								groupTypes[g] + "-";
						/////////////////////////////////
						document.getElementById(stepString + "activateAlias").onclick = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//activate alias then go back to record name
							var alias = document.getElementById(localStepString +
									"aliases").value;
							Debug.log("activateAlias " + alias);

							//find associated aliasObj
							var aliasObj;
							for(var i=0;i<
							_systemGroups.aliases[localGroupType].length;++i)
								if(_systemGroups.aliases[localGroupType][i].alias == 
										alias)
								{
									aliasObj = _systemGroups.aliases[localGroupType][i];
									break;						
								}

							Debug.log("activateAlias group " + aliasObj.name + 
									"-" + aliasObj.key);

							ConfigurationAPI.activateGroup(aliasObj.name, aliasObj.key, 
									true /*ignoreWarnings*/, 
									/*doneHandler*/
									function()
									{
								Debug.log("The System Alias '" + alias + 
										"' (" + aliasObj.name + " (" + 
										aliasObj.key + ")) was successfully activated!", Debug.INFO_PRIORITY);

								init();
									}); //end activate group handler
								}; //end activate alias handler

						/////////////////////////////////
						document.getElementById(stepString + "groupNames").onchange = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//fill keys drop down
							Debug.log("Filling dropdown with keys for " + this.value);
							var str = "";
							for(var i=0;i<_systemGroups.groups[localGroupType]
															   [this.value].keys.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.groups[localGroupType]
															 [this.value].keys[i] /*innerHTML*/, true /*closeTag*/);
							}
							document.getElementById(localStepString + "groupKeys").innerHTML = 
									str;
								}; //end group names dropdown handler

						/////////////////////////////////
						document.getElementById(stepString + "activateGroup").onclick = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//activate alias then go back to record name
							var name = document.getElementById(localStepString + "groupNames").value;
							var key = document.getElementById(localStepString + "groupKeys").value;

							Debug.log("activateGroup " + name + 
									"-" + key);

							ConfigurationAPI.activateGroup(name, key, 
									true /*ignoreWarnings*/, 
									/*doneHandler*/
									function()
									{
								Debug.log("The Group '" + name + " (" + 
										key + ") was successfully activated!", Debug.INFO_PRIORITY);

								init();
									}); //end activate group handler
								}; //end activate alias handler

					}
				} //end localAddHandlers

			} //end localOpenActiveGroupsDialog()
		} //end openActiveGroupsDialog()

		//====================================================================================
		//saveLayout ~~
		function saveLayout(completionHandler)
		{
			Debug.log("saveLayout()");

			var postData = "layout=";
			
			//post data format:
			// grid rows, cols
			// 4-field nodes (type,name,x,y)
			
			postData += _grid.rows;
			postData += "," + _grid.cols;
			
			for(var i=0;i<_nodes.length;++i)
			{
				postData += "," + getTypeName(_nodes[i].type);
				postData += "," + _nodes[i].name;
				postData += "," + _nodes[i].x;
				postData += "," + _nodes[i].y;				
			}
			
			Debug.log("postData = " + postData);
			
			//get active configuration group
			DesktopContent.XMLHttpRequest(
					"Request?RequestType=saveArtdaqNodeLayout",
					postData,
					function()
					{
				Debug.log("saveLayout() complete");				
				_layoutHasChanged = false;
				
				if(completionHandler) completionHandler();
					}
					);
		} //end saveLayout()
		
		//====================================================================================
		//nodeLayoutHasChanged ~~
		//	handle when node layout has changed
		//	for now, auto-save layout for active group
		function nodeLayoutHasChanged()
		{
			Debug.log("nodeLayoutHasChanged()");
			
			initArrows(); //always regenerate arrows			
			
			if(_nodesHaveChanged)
			{
				//do not save layout, until nodes are saved
				_layoutHasChanged = true;
				return;
			}
			
			saveLayout();
			
		} //end nodeLayoutHasChanged()

		//====================================================================================
		//nodeLayoutHasChanged ~~
		function nodesHaveChanged(haveChanged)
		{
			Debug.log("nodesHaveChanged");
			
			_nodesHaveChanged = (haveChanged==undefined)?true:haveChanged;
						
			var el = document.getElementById("Status");
			el.innerHTML = _nodesHaveChanged?"( Unsaved Changes! )":"";
						
		} //end nodesHaveChanged()
		
		
		//====================================================================================
		//addArrow ~~
		function addArrow(startNodeIndex, endNodeIndex, startNodePointIndex, endNodePointIndex)
		{
			Debug.log("addArrow " + startNodeIndex + "-" +
					startNodePointIndex + " to " + 
					endNodeIndex + "-" + endNodePointIndex);
			
			var fromUserDraw = true;
			if(startNodePointIndex == undefined || endNodePointIndex == undefined)
			{
				fromUserDraw = false;
				
				//auto select points on nodes			
				
				if(_nodes[endNodeIndex].x == //arrow directly above or below
						_nodes[startNodeIndex].x)
				{
					//arrow directly above or below
					startNodePointIndex = (_nodes[endNodeIndex].y <
							_nodes[startNodeIndex].y)?0:2;
					endNodePointIndex = (_nodes[endNodeIndex].y <
							_nodes[startNodeIndex].y)?2:0;
				}
				else //arrow to left or right
				{
					startNodePointIndex = (_nodes[endNodeIndex].x < //arrow to left
							_nodes[startNodeIndex].x)?3:1;
					endNodePointIndex = (_nodes[endNodeIndex].x < //arrow to left
							_nodes[startNodeIndex].x)?1:3;
				}
				
			} //end auto point index handling
			
			//add arrow to array if new
			if(_arrows[startNodeIndex] === undefined)				
				_arrows[startNodeIndex] = {};
			if(_arrows[startNodeIndex][endNodeIndex] === undefined)
			{
				_arrows[startNodeIndex][endNodeIndex] = 
					{
							"p0":startNodePointIndex,
							"p1":endNodePointIndex
					}; //arrow made
				if(fromUserDraw && _canvas) paint();
			}
			else
			{
				Debug.log("Connection already exists!",
						Debug.HIGH_PRIORITY);
			}
		} //end addArrow()
		
		</script>
</head>
	

<body onload='Javascript:init();'>	
		
	<!-- body content populated by javascript paint(), etc. -->

	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
	<div class='preloadImage' id='preloadImage-treeEditIconHover'></div>

	<canvas id='theGridCanvas'></canvas>
	<div id='preCanvas'></div>
	<canvas id='theCanvas'></canvas>
	<canvas id='theActionCanvas'></canvas>
	<div id='postCanvas'></div>
		
	<div id='createNodeDiv'>
		<a id='createNode' 
				onclick='createNode(); return false;'
				onmouseup="event.stopPropagation();" 
				onmousedown="event.stopPropagation();" 
				title='Create a new node'>+</a>
	</div>
		
	<div id='selectionBoxDiv'></div>
		
	<!-- Controls pane, Copied from Code Editor -->
	<div class="controlsPane">
		<div 	id="directoryNavToggle" 
				class="controlsButton"						
				style="float:left"
				onclick="event.stopPropagation(); openActiveGroupsDialog();" 
				onmouseup="event.stopPropagation();" 
				onmousedown="event.stopPropagation();" 
				title="Choose the active configuration (Ctrl + D)">
			<div 	id="directoryNavToggleTop"></div>
			<div 	id="directoryNavToggleBottom"></div>
		</div>
		<div 	id="saveFile"
				class="controlsButton" 
				style="float:left;" 
				onclick="event.stopPropagation(); save();"
				onmouseup="event.stopPropagation();" 
				onmousedown="event.stopPropagation();" 
				title="Click to Save changes to the active configuration (Ctrl + S)">
			<div 	id="saveFileMain"></div>
			<div 	id="saveFileMainTop"></div>
			<div 	id="saveFileMainBottom"></div>
		</div>
		<div 	id="Status" 					
				style="float:left; margin: 12px 0 0 10px; color: red;"></div>		
	</div>
	<!-- End controls pane, Copied from Code Editor -->
		
</body>
	
</html>
