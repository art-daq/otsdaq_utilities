<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>artdaq Configuration GUI</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI.css">
	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationAPI.css">

	<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
	<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
	<script type="text/JavaScript" src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

	<link rel="stylesheet" type="text/css" href="/WebPath/css/ConfigurationGUI_artdaq.css">
	
	<style type="text/css">
	/* do not use html style -- instead use ConfigurationGUI_artdaq.css (for readability)*/
	</style>	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ARTDAQConfigurationAPI.js"></script>
	
	<script>		
		
		//	Description of Configuration-artdaq Functionality/Behavior:
		//	
		//	- Requires user to have LOCK
		//
		//	- Grid always stretches to full window size
		//	and defines scale (allow adding row/col of dots at either side)
		//		
		//	- Save functionality should be same as saving tree	
		//		* If admin, could give options to target a certain system alias.. Etc.
		//		* Else assume saving to currently active groups
		//	- Save/Load positioning maps to filename based on active Context group.
		//
		//	- On load, get active groups artdaq modules.. allow editing, deleting, adding.. 
		//	and connecting sources and destinations
		
	
		//paint globals -------------		
		var _NODE_SIZE; //everything else should be sized off of this, and grid steps
		var _CANVAS_MARGIN		= 0;
		var _GRID_MARGIN		= 100;
		var _CANVAS_COLOR 		= "rgba(255,255,255,0)";
		var _GRID_COLOR 		= "rgb(218, 194, 194)";
		var _ARROW_COLOR 		= "rgb(70, 67, 67)";
		var _OFF_COLOR 			= "rgb(210, 210, 210)";
		var _SHADOW_COLOR 		= "gray";
		var _GRID_ROW_MIN		= 2;
		var _GRID_COL_MIN		= 3;

		var _MENU_PRIMARY_COLOR = "rgb(220, 220, 220)";
		var _MENU_SECONDARY_COLOR = _ARROW_COLOR;
		
		var _gridCanvas, _gridContext, _canvas, _context, _actionCanvas, _actionContext;
		var _preCanvas, _postCanvas;
		var _addNodeEl;
		var _w, _h;		
		
		//object globals -------------
		var _grid = { //size of grid, rows and cols can be added or removed
				"rows": _GRID_ROW_MIN, 	"cols": _GRID_COL_MIN, 
				"x0": 	0, 	"y0": 	0, 
				"xstep":0, 	"ystep":0}; 
		var _nodes = []; 	// array of node objects (can be multi-node vector at location, using nodeCount and nodeVectorIndexArr
							//	node: 	{type, name, status, hostname, subsystemId, 
							//		originalName, x, y, nodeCount, 
							//		nodeVectorIndexArr, nodeVectorIndexReverseMap, 
							//		nodeVectorIndexString, nodeNameFixedWidth,
							//		hostnameVectorIndexArr, hostnameVectorIndexReverseMap, 
							//		hostnameVectorIndexString, hostnameFixedWidth}
		var _arrows = {}; 	//multi-dim map of arrow objects 
							//	arrow:	[i0][i1] = {p0,p1,color} (start and end i,p - where i := node index, p := 1 of 4 positions starting from top going clock-wise)
		
		var _nodesByType = {};		
		var _selectedNodes = {}; //selected nodes get highlighted with paint()
		
		var _subsystems = {}; //object describing artdaq subsystems
						// id: {label, sourcesCount, destinationId}
		
		var _hostnames = {}; //set of hostnames (i.e. map to 1)
		
		//constant globals -------------		
		var _MMM_NONE				= 0;
		var _MMM_ARROW_DRAG			= 1;
		var _MMM_NODE_DRAG			= 2;
		var _MMM_SELECT_BOX			= 3;
		var _MMM_POPUP_DIALOG		= 4;
		
		//mousemove globals -------------
		var _mouseMoveMode = _MMM_NONE;
		var _mouseMoveStart = [0,0,0,0]; //x,y,i,p start (i,p are optional)
		var _mouseHoverNode = -1;

		//configuration globals -------------
		var _modifiedTables;
		var _systemGroups = {};
		var _firstInit = true;
		var _codeEditorAppId = 0; //to open fcl in code editor
		var _layoutHasChanged = false;
		var _nodesHaveChanged = false;
		
		var _checkActiveGroupsTimer = 0;
		var _CHECK_ACTIVE_GROUPS_PERIOD = 5000; //ms
		var _lastActiveGroups = [];
		
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////

		//=====================================================================================
		//htmlOpen ~~		
		//	tab name and attribute/value map object
		function htmlOpen(tag,attObj,innerHTML,doCloseTag)
		{
			var str = "";
			var attKeys = Object.keys(attObj); 
			str += "<" + tag + " ";
			for(var i=0;i<attKeys.length;++i)
				if(attKeys[i] == "selected") str += (attObj[attKeys[i]]|0)?" selected ":""; //no value
				else if(attKeys[i] == "checked") str += (attObj[attKeys[i]]|0)?" checked ":""; //no value
				else if(attKeys[i] == "") continue; //skip empty key
				else
					str += " " + attKeys[i] + "='" +
					attObj[attKeys[i]] + "' ";
			str += ">";
			if(innerHTML) str += innerHTML;
			if(doCloseTag)
				str += "</" + tag + ">";
			return str;
		} // end htmlOpen()

		//=====================================================================================
		//htmlClearDiv ~~		
		function htmlClearDiv()
		{
			return "<div id='clearDiv'></div>";
		} //end htmlClearDiv()
		
		//functions:
			//htmlOpen()
			//htmlClearDiv()
			//init()	
			//	localFinishInit()
			//initArtdaqNodes(doneHandler)
			//handleOptionalNodeParameters(node,nodeNameTemplate,nodeVectorIndexString,nodeNameFixedWidth,hostname,hostnameVectorIndexString,hostnameFixedWidth)
			//initArrows()
			//save()
			//saveLayout(completionHandler)
		
			//openActiveGroupsDialog()
			//nodeLayoutHasChanged()
			//nodesHaveChanged(hasChanged)
			//createNode()
			//	localAddHandlers()
			//validateNewArrow(startNodeIndex, endNodeIndex)		
			//addArrow(startNodeIndex, endNodeIndex, startNodePointIndex, endNodePointIndex)
								
			//paint()
			//drawGrid() 
			//drawNode(i,xoff,yoff) 
			//drawArrows()
			//drawArrow(x0,y0,x,y,isActionCanvas,color) 
		
			//getNodePoint(i,p)
			//doNodeHover(i)
			//getEmptyGridSpot(type)
			//plusMinusGrid(isPlus,directionIndex)
			//getNodeFontSize()
			//getGridX(x)
			//getGridY(y)
			//getGridPointXY(xg,yg)
			//isOverNodeBox(x,y,xg,yg)
		
			//handleNodeMouseOver(e)
			//handleMouseMove(e)
			//handleMouseUp(e)
			//handleMouseDown(e)
			//handleNodeHeaderMouseDown(e)
		
			//handlePointMouseUp(i,p,e)
			//		localHandleCleanup()
			//handlePointMouseDown(i,p,e)
		
			//handleEditIconMouseUp(i,e,x,y,subi)
			//handleEditIconMenuSelection(i,editType, newTab, x, y, editTypeString, subi)
			//launchEditNodeDialog(i)
			//		localCloseButtonHandler()
			//		getElementById("ediNode-" + "saveNode").onclick()
			//handleEditNodeDialogMultiNodeCheckbox(i)
			//handleEditNodeDialogHostnameArrayCheckbox(i)
			//handleEditNodeDialogHostnameFixedWidthCheckbox(i)
			//handleEditNodeDialogNodeNameFixedWidthCheckbox(i)
			//handleEditNodeSelectEditIcon(t)
		
			//handleFclIconMouseUp(i,e,x,y,subi)
			//handleDeleteIconMouseUp(i,e)
			//	localDeleteNode();
		
			//getSubsystemColor(subsystemId)
			//getMultiNodeName(i,subi)
			//getPrinterSyntaxStringWithWidth(s,w)
		
			//checkForActiveGroupChange(init)
			//	localHandleChange(activeConfigGroups)
				
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
				

		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init() 
		{									
			Debug.log("CfgGUI_artdaq init ");			
			
			var windowTooltip = "Welcome to the <i>artdaq</i> Configuration GUI. Here you can manipulate every configuration " +
					"parameter associated with the <i>artdaq</i> nodes in your system. \n\n" +
					"The organization of the <i>artdaq</i> Configuration GUI is as follows: " +
					"there are control buttons at the top-left of the window, and the body of the window" +
					" is an interactive grid for editing the <i>artdaq</i> nodes in your system. \n\n" +
					"There are two control buttons at the top-left of the window, along with a status string: \n\n" +
					"\n\t- <b>Choose Active Configuration:</b>\n<INDENT>This button opens a dialog to select the active Context and Configuration group, which together fully define the <i>artdaq</i> nodes in your system.</INDENT>" +
					"\n\t- <b>Save Changes:</b>\n<INDENT>This buttons saves any changes your make to the <i>artdaq</i> node topology and settings, and will create and activate new a Context and Configuration group depending on the changes made.</INDENT>" +
					"\n\t- <b>Status string:</b>\n<INDENT>A multi-color status string will appear, next to the buttons, in context with user actions.</INDENT>" +
					"\n\n" +
					"The remaining body of the window is a canvas for visualizing and manipulating <i>artdaq</i> nodes. Briefly, here is a description of the main canvas: \n\n" +
					"\n\t- <b>Grid:</b>\n<INDENT>The grid is an X,Y coordinate plane purely for visualization convenience. <i>artdaq</i> nodes can be create, dragged, and placed at each X,Y coordinate. The grid can be re-sized by adding rows and columns using the arrows at each edge of the grid..</INDENT>" +
					"\n\t- <b>Nodes:</b>\n<INDENT>Each <i>artdaq</i> node or multi-node is represented by a square at an X,Y coordinate position on the grid. Hovering your mouse cursor over a node will bring up icons for manipulating the node. Nodes can be repositioned by dragging the node. Nodes can be connected to other nodes by dragging from one of the four anchors to another node's anchor. Making arrow connections has implications on subsystem topology; also, only certain node types are valid connections. Pop-up context errors and info will validate attempted user connections.</INDENT>" +
					"\n\t- <b>Subsystems:</b>\n<INDENT>The subsystem concept in <i>artdaq</i> defines the rules for data transfer between node types. Subsystem are color coordinated in the <artdaq> Configuration GUI.</INDENT>" +
					"\n\t- <b>Arrows:</b>\n<INDENT>Arrows indicate data flow from one node to another, and from one subsystem to another.</INDENT>" +
					"\n\n" +
					"";


			DesktopContent.tooltip("artdaq Configuration GUI Introduction",
					windowTooltip
			);
			DesktopContent.setWindowTooltip(windowTooltip);

		
			if(0) //example nodes and arrows
			{
				var x = 0;
				var y = 0;
				_nodes.push({"type":ARTDAQConfigurationAPI.NODE_TYPE_READER,	"x":x++, 	"y":y});			
				_nodes.push({"type":ARTDAQConfigurationAPI.NODE_TYPE_BUILDER,	"x":x++, 	"y":y, "nodeCount": 5});			
				_nodes.push({"type":ARTDAQConfigurationAPI.NODE_TYPE_LOGGER,	"x":x++, 	"y":y, "nodeCount": 2});
				x = 0;
				y++;
				_nodes.push({"type":ARTDAQConfigurationAPI.NODE_TYPE_MONITOR,	"x":x, 	"y":y});			
				_nodes.push({"type":ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER,	"x":x++, 	"y":y});

				_arrows[1] = {};
				_arrows[1][0] = {"p0":1,"p1":0};

			}
			
			initArtdaqNodes();
			
		} //end init()
		
		//=====================================================================================
		//initArtdaqNodes ~~
		//	init called once body has loaded
		function initArtdaqNodes(doneHandler) 
		{				
			Debug.log("initArtdaqNodes()");
					
			//init configuration members
			_modifiedTables = undefined; //reset
			
			_grid = { //size of grid, rows and cols can be added or removed
							"rows": _GRID_ROW_MIN, 	"cols": _GRID_COL_MIN, 
							"x0": 	0, 	"y0": 	0, 
							"xstep":0, 	"ystep":0}; 
			
			_nodes = []; 
			_arrows = {};
			_nodesByType = {};
			_selectedNodes = {};
			_subsystems = {};
			_hostnames = {};
			
			//clear all nodes from display
			{
				var nodeEls;
				//Note: indices and parents get messed up if deleting with for loop
				while((nodeEls = document.getElementsByClassName("node")) &&
						nodeEls.length) 
					nodeEls[0].parentNode.removeChild(nodeEls[0]);
			}			
			
			//fill in CodeEditor appId
			DesktopContent.XMLHttpRequest("Request?RequestType=getAppId" + 
					"&classNeedle=ots::CodeEditorSupervisor",
					"", //end post data, 
					function(req) 
					{
				_codeEditorAppId = DesktopContent.getXMLValue(req,"id") | 0;
				Debug.log("_codeEditorAppId " + _codeEditorAppId);
					}, //end handler
					0, 0, 0,//reqParam, progressHandler, callHandlerOnErr, 
					false,//doNotShowLoadingOverlay,
					true //targetSupervisor
			); //end getAppId request

			if(_checkActiveGroupsTimer)
			{
				window.clearTimeout(_checkActiveGroupsTimer);
				_checkActiveGroupsTimer = 0;
			}
			
			//////////////
			ARTDAQConfigurationAPI.getArtdaqNodes(
					function(artdaqObj)
					{
				console.log("artdaqObj",artdaqObj);
				
				//get active configuration group
				DesktopContent.XMLHttpRequest("Request?RequestType=loadArtdaqNodeLayout",
						"", //end post data, 
						function(req) 
						{
					//Steps:
					//	if layout, 
					//		for each matching node in layout, place, delete from artdaqObj 
					//  for each remaining node, then use default behavior to place nodes
					
					// build _nodes and _nodesByType
					
					// Then, get artdaqSourcesAndDestinations
					
					var rows = DesktopContent.getXMLValue(req,"grid-rows");
					var cols = DesktopContent.getXMLValue(req,"grid-cols");
					
					if(!rows || rows == "" || !cols || cols == "")
					{
						//setup default grid
						rows = Math.ceil(Math.sqrt(artdaqObj.nodeCount));
						cols = rows + 1;
					}
					_grid.rows = rows | 0;
					_grid.cols = cols | 0;
					if(_grid.rows < _GRID_ROW_MIN)
						_grid.rows = _GRID_ROW_MIN;
					if(_grid.cols < _GRID_COL_MIN)
						_grid.cols = _GRID_COL_MIN;
					
					console.log("_grid",_grid);
					
					var layoutNodesType = req.responseXML.getElementsByTagName("node-type");
					var layoutNodesName = req.responseXML.getElementsByTagName("node-name");
					var layoutNodesX 	= req.responseXML.getElementsByTagName("node-x");
					var layoutNodesY	= req.responseXML.getElementsByTagName("node-y");
					
					//for every type, node match.. add to _nodes.. and delete from artdaqObj
					for(var i=0;i<layoutNodesType.length;++i)
					{
						var type = layoutNodesType[i].getAttribute('value');
						var name = layoutNodesName[i].getAttribute('value');
						if(artdaqObj[type] && 
								artdaqObj[type][name])
						{
							console.log("Type",type,"Name",name);
							
							//handle ARTDAQ Supervisor in a special way
							if(type == 
									ARTDAQConfigurationAPI.NODE_TYPES[
										ARTDAQConfigurationAPI.NODE_TYPE_SUPERVISOR])
							{
								//add to nodes
								_nodes.push({
									"type": 			ARTDAQConfigurationAPI.getTypeIndex(type),
									"name": 			name,
									"status":			(artdaqObj[type][name].status === undefined?true:((artdaqObj[type][name].status|0)?true:false)), //default status to true
									"originalName": 	name, //useful when saving
									"contextAddress":	artdaqObj[type][name].contextAddress,
									"contextPort":		artdaqObj[type][name].contextPort,
									"x":				layoutNodesX[i].getAttribute('value')|0,
									"y":				layoutNodesY[i].getAttribute('value')|0});

							} //end supervisor node handling
							else
							{

								//enter in hostnames
								_hostnames[artdaqObj[type][name].hostname] = 1;
										   
								//add to nodes
								_nodes.push({
									"type": 		ARTDAQConfigurationAPI.getTypeIndex(type),
									"name": 		name,
									"status":		(artdaqObj[type][name].status === undefined?true:((artdaqObj[type][name].status|0)?true:false)), //default status to true
									"originalName": name, //useful when saving
									"hostname":		artdaqObj[type][name].hostname,
									"subsystemId":	artdaqObj[type][name].subsystemId,
									"x":			layoutNodesX[i].getAttribute('value')|0,
									"y":			layoutNodesY[i].getAttribute('value')|0});
	
								//add optional parameters
								handleOptionalNodeParameters(
										_nodes[_nodes.length-1],
										_nodes[_nodes.length-1].name,
										artdaqObj[type][name].multiNodeString,
										artdaqObj[type][name].nodeFixedWidth,
										_nodes[_nodes.length-1].hostname,
										artdaqObj[type][name].hostArrayString,
										artdaqObj[type][name].hostFixedWidth);
								
								//modify original node name to give full multi-node description
								if(_nodes[_nodes.length-1].nodeCount > 1)
								{
									_nodes[_nodes.length-1].originalName = 
											":" + (_nodes[_nodes.length-1].nodeNameFixedWidth?
													_nodes[_nodes.length-1].nodeNameFixedWidth:1) +
											":" + _nodes[_nodes.length-1].nodeVectorIndexString + ":" +
											_nodes[_nodes.length-1].name;
								}
							} //end non-supervisor node handling
								
							//remove from nodes object to keep remainder accurate 
							delete artdaqObj[type][name];
							
							if(_nodes[_nodes.length-1].y >= _grid.rows)
								_grid.rows = _nodes[_nodes.length-1].y + 1;
							if(_nodes[_nodes.length-1].x >= _grid.cols)
								_grid.cols = _nodes[_nodes.length-1].x + 1;
							
						}
						else //not found, so do not represent anymore
							Debug.log("Not Found " + name);
					}
					
					console.log("nodes in layout",_nodes);
					
					//now add remaining nodes to layout automatically
					
					for(var t=0;t<ARTDAQConfigurationAPI.NODE_TYPES.length;++t)
					{
						var type = ARTDAQConfigurationAPI.NODE_TYPES[t];
						console.log("Type",type);

						for(var name in artdaqObj[type])
						{	
							console.log("Type",type,"Name",name);

							var xy = getEmptyGridSpot(t);

							//handle ARTDAQ Supervisor in a special way
							if(type == 
									ARTDAQConfigurationAPI.NODE_TYPES[
										ARTDAQConfigurationAPI.NODE_TYPE_SUPERVISOR])
							{
								//add to nodes
								_nodes.push({
									"type": 			t,
									"name": 			name,
									"originalName": 	name, //useful when saving
									"status":			(artdaqObj[type][name].status === undefined?true:((artdaqObj[type][name].status|0)?true:false)), //default status to true
									"contextAddress":	artdaqObj[type][name].contextAddress,
									"contextPort":		artdaqObj[type][name].contextPort,
									"x":				xy[0],
									"y":				xy[1]});

							} //end supervisor node handling
							else
							{
								//enter in hostnames
								_hostnames[artdaqObj[type][name].hostname] = 1;
																	
								//add to nodes
								_nodes.push({
									"type": 		t,
									"name": 		name,	
									"originalName": name, //useful when saving
									"status":		(artdaqObj[type][name].status === undefined?true:((artdaqObj[type][name].status|0)?true:false)), //default status to true
									"hostname":		artdaqObj[type][name].hostname,
									"subsystemId":	artdaqObj[type][name].subsystemId,
									"x":			xy[0],
									"y":			xy[1]});
								
								//add optional parameters
								handleOptionalNodeParameters(
										_nodes[_nodes.length-1],
										_nodes[_nodes.length-1].name,
										artdaqObj[type][name].multiNodeString,
										artdaqObj[type][name].nodeFixedWidth,
										_nodes[_nodes.length-1].hostname,
										artdaqObj[type][name].hostArrayString,
										artdaqObj[type][name].hostFixedWidth);
								
	
								//modify original node name to give full multi-node description
								if(_nodes[_nodes.length-1].nodeCount > 1)
								{
									_nodes[_nodes.length-1].originalName = 
											":" + (_nodes[_nodes.length-1].nodeNameFixedWidth?
													_nodes[_nodes.length-1].nodeNameFixedWidth:1) +
											":" + _nodes[_nodes.length-1].nodeVectorIndexString + ":" +
											_nodes[_nodes.length-1].name;
								}
							} //end non-supervisor node handling
						} //end artdaqObj node type loop
					} //end type loop
					
					console.log("all nodes",_nodes);
					
					_subsystems = artdaqObj.subsystems;
					if(_subsystems === undefined) 
						_subsystems = {}; //define for null case
					if(_subsystems[0] === undefined)
						_subsystems[0] = {"label": ARTDAQConfigurationAPI.NULL_SUBSYSTEM, destinationId:0}; //define for null destination
					
					console.log("all subsystems",_subsystems);
					
					
					//build arrow connections now
					initArrows();
					
					localFinishInit();	
					
					if(doneHandler) doneHandler();
					
					
						} //end loadArtdaqNodeLayout handler
				); //end loadArtdaqNodeLayout call
				
					}, //end getArtdaqApps handler
					_modifiedTables); //end getArtdaqApps call
			
			return;
			

			//=================
			function localFinishInit()
			{				
				checkForActiveGroupChange(true /*init*/); //force group update

				//only continue if the first time in init()
				if(!_firstInit) 
				{
					paint();
					return;
				}		
				//else first time!
				
				_firstInit = false; //only finish init once
	
				_preCanvas = document.getElementById("preCanvas");
				_postCanvas = document.getElementById("postCanvas");
				_addNodeEl = document.getElementById("createNodeDiv");
	
				_canvas = document.getElementById("theCanvas");
				_canvas.style.backgroundColor = _CANVAS_COLOR;
				_context = _canvas.getContext('2d');
				_actionCanvas = document.getElementById("theActionCanvas");
				_actionCanvas.style.backgroundColor = _CANVAS_COLOR;
				_actionContext = _actionCanvas.getContext('2d');
				_gridCanvas = document.getElementById("theGridCanvas");
				_gridCanvas.style.backgroundColor = _CANVAS_COLOR;
				_gridContext = _gridCanvas.getContext('2d');
	
				paint();
				window.addEventListener("resize",paint);
	
				//DesktopContent.mouseMoveSubscriber(handleMouseMove); //causes problems because of this.style.cursor handling 
				document.body.addEventListener("mousemove",handleMouseMove);
				document.body.addEventListener("mouseup",handleMouseUp);
				document.body.addEventListener("mousedown",handleMouseDown);
				document.body.addEventListener("keydown",handleMouseMove);
				document.body.addEventListener("keyup",handleMouseMove);
			} //end localFinishInit()									
			
		} //end initArtdaqNodes()	

		//=====================================================================================
		//handleOptionalNodeParameters ~~
		//	return false on failure/error, true on success
		//	On success, the node object is modified!
		function handleOptionalNodeParameters(node,
				nodeNameTemplate,
				nodeVectorIndexString,nodeNameFixedWidth,
				hostname,
				hostnameVectorIndexString,hostnameFixedWidth)
		{
			var nodeCount = 0;
			if(nodeVectorIndexString !== undefined)
			{
				var nodeVectorIndexArr = []; //reset
				var nodeVectorIndexReverseMap = {}; //reset
	
				var nodeIndices = nodeVectorIndexString.split(',');
				for(var j=0;j<nodeIndices.length;j++)
				{
					var nodeSubindices = nodeIndices[j].split('-');
	
					if(nodeSubindices.length == 1)
					{
						var index = nodeSubindices[0].trim();
	
						if(nodeVectorIndexReverseMap[index])
						{
							Debug.log("Illegal Node Indices for node '" +
									node.name + "' - repeat indices (i.e. '" +
									index + "') are not allowed.",
									Debug.HIGH_PRIORITY);
							return false;								
						}
						nodeVectorIndexReverseMap[index] = nodeCount++;
						nodeVectorIndexArr.push(index);							
					}
					else if(nodeSubindices.length == 2)
					{
						var hi = nodeSubindices[1].trim() | 0;
						var lo = nodeSubindices[0].trim() | 0;
						if(hi <= lo)
						{
							Debug.log("Illegal Node Indices for node '" +
									node.name + "' - please use printer page syntax (e.g. '0,4-6').",
									Debug.HIGH_PRIORITY);
							return false;
						}
	
						for(var k=lo;k<=hi;++k)
						{
							if(nodeVectorIndexReverseMap[k])
							{
								Debug.log("Illegal Node Indices for node '" +
									node.name + "' - repeat indices (i.e. '" +
										k + "') are not allowed.",
										Debug.HIGH_PRIORITY);
								return false;								
							}
							nodeVectorIndexReverseMap[k] = nodeCount++;
							nodeVectorIndexArr.push(k);								
						}
					}
					else
					{
						Debug.log("Illegal Node Indices for node '" +
									node.name + "' - please use printer page syntax (e.g. '0,4-6').",
								Debug.HIGH_PRIORITY);
						return false;
					}
				} //end extract node indices
				console.log("nodeCount",nodeCount); 
				console.log("nodeVectorIndexArr",nodeVectorIndexArr); 
				console.log("nodeVectorIndexReverseMap",nodeVectorIndexReverseMap); 
	
				if(nodeCount> 1 && 
						nodeNameTemplate.indexOf('*') < 0)
				{
					Debug.log("Illegal Node Name for multi-node for node '" +
									node.name + "' - please use * to indicate where the instance index should be (e.g. 'reader*' to make reader0, reader1, etc..).",
							Debug.HIGH_PRIORITY);
					return false;
				}
			}
			else if(nodeNameTemplate.indexOf('*') >= 0)
			{
				Debug.log("Illegal Node Name for multi-node for node '" +
								node.name + "' - * found without printer syntax indices.",
						Debug.HIGH_PRIORITY);
				return false;
			}

			if(hostnameVectorIndexString !== undefined)
			{
				var hostnameVectorIndexArr = []; //reset
				var hostnameVectorIndexReverseMap = {}; //reset


				hostnameIndices = hostnameVectorIndexString.split(',');
				var hostnameCount = 0;
				for(var j=0;j<hostnameIndices.length;j++)
				{
					var hostnameSubindices = hostnameIndices[j].split('-');

					if(hostnameSubindices.length == 1)
					{
						var index = hostnameSubindices[0].trim();

						if(hostnameVectorIndexReverseMap[index])
						{
							Debug.log("Illegal Hostname Indices for node '" +
									node.name + "' - repeat indices (i.e. '" +
									index + "') are not allowed.",
									Debug.HIGH_PRIORITY);
							return false;								
						}
						hostnameVectorIndexReverseMap[index] = hostnameCount++;
						hostnameVectorIndexArr.push(index);							
					}
					else if(hostnameSubindices.length == 2)
					{
						var hi = hostnameSubindices[1].trim() | 0;
						var lo = hostnameSubindices[0].trim() | 0;
						if(hi <= lo)
						{
							Debug.log("Illegal Hostname Indices for node '" +
									node.name + "' - please use printer page syntax (e.g. '0,4-6').",
									Debug.HIGH_PRIORITY);
							return false;
						}

						for(var k=lo;k<=hi;++k)
						{
							if(hostnameVectorIndexReverseMap[k])
							{
								Debug.log("Illegal Hostname Indices for node '" +
										node.name + "' - repeat indices (i.e. '" +
										k + "') are not allowed.",
										Debug.HIGH_PRIORITY);
								return false;								
							}
							hostnameVectorIndexReverseMap[k] = hostnameCount++;
							hostnameVectorIndexArr.push(k);								
						}
					}
					else
					{
						Debug.log("Illegal Hostname Indices for node '" +
								node.name + "' - please use printer page syntax (e.g. '0,4-6').",
								Debug.HIGH_PRIORITY);
						return false;
					}
				} //end extract node indices
				console.log("hostnameCount",hostnameCount); 
				console.log("hostnameVectorIndexArr",hostnameVectorIndexArr); 
				console.log("hostnameVectorIndexReverseMap",hostnameVectorIndexReverseMap); 

				if(hostnameCount> 1 && 
						hostname.indexOf('*') < 0)
				{
					Debug.log("Illegal Hostname for node '" +
							node.name + "' for associating an array of hostnames to multiple " +
							"node instances - please use * in the hostname (click the pencil to type in the hostname field) to indicate where the hostname index should be (e.g. 'host*' to make host0, host1, etc..).",
							Debug.HIGH_PRIORITY);
					return false;
				}
				if(hostnameCount> 1 && 
						hostnameCount != nodeCount)
				{
					Debug.log("Illegal array of hostnames for node '" +
							node.name + ".' Size " + hostnameCount +
							" is not equal to the number of node instances which is " +
							nodeCount + " - there must be a one-to-one correspondence " +
							"between hostname and node, or else all nodes must be placed on the same host.",
							Debug.HIGH_PRIORITY);
					return false;
				}
			}
			else if(hostname.indexOf('*') >= 0)
			{
				Debug.log("Illegal Host Name for multi-node for node '" +
								node.name + "' - * found without printer syntax indices.",
						Debug.HIGH_PRIORITY);
				return false;
			}
			


			//at this point, the change has been verified!
			// so set node values
			node.nodeCount = nodeCount;
			node.nodeVectorIndexString = nodeVectorIndexString;
			node.nodeVectorIndexArr = nodeVectorIndexArr;
			node.nodeVectorIndexReverseMap = nodeVectorIndexReverseMap;
			node.nodeNameFixedWidth = nodeNameFixedWidth;
			node.name = nodeNameTemplate;

			node.hostnameVectorIndexString = hostnameVectorIndexString;
			node.hostnameVectorIndexArr = hostnameVectorIndexArr;
			node.hostnameVectorIndexReverseMap = hostnameVectorIndexReverseMap;
			node.hostnameFixedWidth = hostnameFixedWidth;

			//handle hostname change
			if(node.hostname != hostname)
			{
				//enter in hostnames
				_hostnames[hostname] = 1;
				node.hostname = hostname;
			}		
			
			
			return true;
		} //end handleOptionalNodeParameters()
		
		//=====================================================================================
		//save ~~
		function save()
		{
			Debug.log("save()");
		
			//kill configuration change checking during (possibly long) saving time
			//	checking will return when a successful save occurs and initArtdaqNodes() is called!
			if(_checkActiveGroupsTimer)
			{
				window.clearTimeout(_checkActiveGroupsTimer);
				_checkActiveGroupsTimer = 0;
			}
			
			//create node object by type for save function from _nodes array
			//		nodeObj := {}
			//			nodeObj.<nodeType> = {}
			//			nodeObj.<nodeType>.<nodeName> = 
			//				{originalName,status,hostname,subsystemName,
			//				(nodeArrString),(hostnameArrString),(nodeNameFixedWidth),(hostnameFixedWidth)}
			//
			// <nodeType> = ARTDAQConfigurationAPI.NODE_TYPES := reader, builder, aggregator, dispatcher, monitor
			//
			//		subsystemObj = {}
			//			subsystemObj.<subsystemName> = {destinationName}
			var nodesObj = {};
			var subsystemsObj = {};

			var types = ARTDAQConfigurationAPI.NODE_TYPES;

			for(var i=0;i<types.length;++i)
				if(i != ARTDAQConfigurationAPI.NODE_TYPE_SUPERVISOR)					
					nodesObj[types[i]] = {};
			
			var type,name,node;
			for(var i=0;i<_nodes.length;++i)
			{	
				node = _nodes[i];
				
				if(node.type == ARTDAQConfigurationAPI.NODE_TYPE_SUPERVISOR)
					continue; //skip supervisor type.. it is handled automatically
			
				type = types[node.type];

				name = node.name;
				nodesObj[type][name] = {};
				nodesObj[type][name].originalName = node.originalName;
				nodesObj[type][name].status = node.status;
				nodesObj[type][name].hostname = node.hostname;
				nodesObj[type][name].subsystemName = _subsystems[node.subsystemId].label;
				if(node.nodeCount > 1)
				{
					Debug.log("Saving multi-node...");
					
					nodesObj[type][name].nodeArrString = node.nodeVectorIndexString;
					if(node.nodeNameFixedWidth && node.nodeNameFixedWidth > 1)
						nodesObj[type][name].nodeNameFixedWidth = node.nodeNameFixedWidth;							
										
					if(node.hostname.indexOf('*') >= 0)
					{
						nodesObj[type][name].hostnameArrString = node.hostnameVectorIndexString;
						if(node.hostnameFixedWidth && node.hostnameFixedWidth > 1)
							nodesObj[type][name].hostnameFixedWidth = node.hostnameFixedWidth;							
					}					
				} //end multi-node handling
			
				subsystemsObj[_subsystems[node.subsystemId].label] = {};
				if(subsystemsObj[_subsystems[node.subsystemId].label].destinationName !== undefined &&
						subsystemsObj[_subsystems[node.subsystemId].label].destinationName != 
								_subsystems[_subsystems[node.subsystemId].destinationId].label)
				{
					//should never have a destination mismatch
					Debug.log("Illegal destination mismatch! Notify admins.", Debug.HIGH_PRIORITY);
					return;
				}
								
				subsystemsObj[_subsystems[node.subsystemId].label].destinationName =
						_subsystems[_subsystems[node.subsystemId].destinationId | 0].label;
			} //end node loop
			
			////////// now save nodes and subsystems objects
			ARTDAQConfigurationAPI.saveArtdaqNodes(nodesObj, subsystemsObj,
					function(req)
					{
				console.log("response",req);
				
				Debug.log("save() complete");				
				nodesHaveChanged(false);
				
				var activeConfigGroups = [
					  DesktopContent.getXMLValue(req, "Context-ActiveGroupName"),
					  DesktopContent.getXMLValue(req, "Context-ActiveGroupKey"),
					  DesktopContent.getXMLValue(req, "Configuration-ActiveGroupName"),
					  DesktopContent.getXMLValue(req, "Configuration-ActiveGroupKey")];
				
				//always save layout just in case
				saveLayout(function()
						{
					Debug.log("Changes have been successfully saved!",
							Debug.INFO_PRIORITY);		
					
					

					Debug.log("Now the active Context group is '" +
							activeConfigGroups[0] + "(" +
							activeConfigGroups[1] + 
							") and the active Configuration group is " + 
							activeConfigGroups[2] + "(" +
							activeConfigGroups[3] + ")" + 
							"!",
							Debug.INFO_PRIORITY);	
					
					initArtdaqNodes(); //completely reload
					
						}); //end saveLayout completion handler
					}); //end saveArtdaqNodes response handler
		} //end save()	
		
		//=====================================================================================
		//initArrows ~~
		function initArrows()
		{
			Debug.log("initArrows()");
			_arrows = {}; //reset
			
			// NOTE: status is considered, OFF nodes are not included in arrow paths
			//
			//	 .. arrows should get generated at startup based on subsystem settings.
			//	Readers -> all builders of same subsystem
			//	Builders -> all loggers of same subsystem AND builders of destination subsystem
			//	Loggers -> all dispatchers of same subsystem

			for(var i=0;i<_nodes.length;++i)
			{
				if(!_nodes[i].status) continue; //skip OFF nodes
				
				if(_nodes[i].type == ARTDAQConfigurationAPI.NODE_TYPE_READER)
				{
					//connect to all ON board readers at destination
					for(var j=0;j<_nodes.length;++j)
						if(_nodes[j].status &&
								_nodes[j].type == ARTDAQConfigurationAPI.NODE_TYPE_BUILDER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found reader-builder connection at nodes " + 
									i + " ==> " + j);
							
							addArrow(i,j);
						}
				}
				else if(_nodes[i].type == ARTDAQConfigurationAPI.NODE_TYPE_BUILDER)
				{
					var destinationId = _subsystems[_nodes[i].subsystemId].destinationId|0;
					
					//connect to all ON board readers at destination
					for(var j=0;j<_nodes.length;++j)
						if(_nodes[j].status &&
								_nodes[j].type == ARTDAQConfigurationAPI.NODE_TYPE_LOGGER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found builder-logger connection at nodes " + 
									i + " ==> " + j);

							addArrow(i,j);
						}
						else if(_nodes[j].status &&
								_nodes[j].type == ARTDAQConfigurationAPI.NODE_TYPE_BUILDER && 
								_nodes[j].subsystemId == destinationId)
						{
							Debug.log("Found builder-connection connection at nodes " + 
									i + " ==> " + j);

							addArrow(i,j);
						}
				}
				else if(_nodes[i].type == ARTDAQConfigurationAPI.NODE_TYPE_LOGGER)
				{
					//connect to all ON board readers at destination
					for(var j=0;j<_nodes.length;++j)
						if(_nodes[j].status &&
								_nodes[j].type == ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found logger-dispatcher connection at nodes " + 
									i + " ==> " + j);
							
							addArrow(i,j);
						}
				}
				else if(_nodes[i].type == ARTDAQConfigurationAPI.NODE_TYPE_ROUTER)
				{
					//connect from all ON event builders in subsystem
					//	and to all ON board readers in subsystem
					for(var j=0;j<_nodes.length;++j)
						if(_nodes[j].status &&
								_nodes[j].type == ARTDAQConfigurationAPI.NODE_TYPE_BUILDER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found builder-reader connection at nodes " + 
									i + " ==> " + j);

							addArrow(j,i,undefined,undefined,"rgb(220,220,220)");
						}
						else if(_nodes[j].status &&
								_nodes[j].type == ARTDAQConfigurationAPI.NODE_TYPE_READER && 
								_nodes[j].subsystemId == _nodes[i].subsystemId)
						{
							Debug.log("Found router-reader connection at nodes " + 
									i + " ==> " + j);

							addArrow(i,j,undefined,undefined,"rgb(220,220,220)");
						}
				}
			} //end node loop
			
		} //end initArrows()
				

		//=====================================================================================
		//getEmptyGridSpot ~~
		//	return empty x,y grid spot
		//	handle types differently.. 
		//	i.e. readers to left, builders in middle, dataLoggers and dispatchers to right
		function getEmptyGridSpot(type)
		{
			var x = type == ARTDAQConfigurationAPI.NODE_TYPE_READER?0:
					(type == ARTDAQConfigurationAPI.NODE_TYPE_BUILDER?((_grid.cols/2)|0):
					_grid.cols-1); //else dataLoggers and dispatchers on right
			var d = type == ARTDAQConfigurationAPI.NODE_TYPE_READER?1:-1; //direction of search in x
			var y = 0; //start at top-ish
			
			//search _nodes for conflict
			var tries = 0;
			do
			{
				var conflict = false;
				
				//if too many conflicts, add row to top
				if(tries > _grid.cols*_grid.rows/2)
				{
					plusMinusGrid(true /*isPlus*/,0 /*directionIndex*/); //add row to top

					var x = type == ARTDAQConfigurationAPI.NODE_TYPE_READER?0:
							(type == ARTDAQConfigurationAPI.NODE_TYPE_BUILDER?((_grid.cols/2)|0):
							_grid.cols-1); //else dataLoggers and dispatchers on right
					y = 0;
				}

				for(var i=0;i<_nodes.length;++i)
				{
					if(_nodes[i].x == x && _nodes[i].y == y)
					{
						conflict = true;
						//try new value
						++y;
						if(y >= _grid.cols)
						{
							//handle y wraparound
							y = 0;
							x = (x + d) % _grid.cols;
						}
						
						break;
					}
				}
				++tries;
			} while(conflict);
			
			Debug.log("Position found at x,y " + 
					x + "," + y);
			
			if(y >= _grid.rows)
				_grid.rows = y + 1;
			if(x >= _grid.cols)
				_grid.cols = x + 1;
			
			return [x,y];
			
		} //end getEmptyGridSpot()
		
		//=====================================================================================
		//getSubsystemColor ~~
		function getSubsystemColor(subsystemId)
		{			
			//default: rgb(241, 231, 231);
			var rgb = [241,231,231];
			var i = (subsystemId-1)*70;
			var j = 0;
			while(i>0) //drain color counter
			{
				rgb[j] += i>50?50:i;
				if(rgb[j] > 255)
					rgb[j] = 180 + (rgb[j] - 255); //let 180 be minimum
				
				i -= (i>50?50:i);
				
				if(++j >= 3) j = 0; //wraparound
			}
			
			//do not let the color get too white
			j=0;
			for(i=0;i<3;++i)
				if(rgb[i] > 230) ++j;
			if(j == 3)
				rgb[subsystemId%3] = 150; 
			
			//console.log("color sub",subsystemId,rgb);
			
			return "rgb(" + rgb[0] + "," + rgb[1] + "," + 
					rgb[2] + ")";
		} //end getSubsystemColor()
		
		//=====================================================================================
		//handleNodeMouseOver ~~
		function handleNodeMouseOver(e)
		{
			var id = this.id.split('-')[1] | 0;
			//Debug.log("MouseOver Node id = " + id);
			
		} //end handleNodeMouseOver()
		
		//=====================================================================================
		//paint ~~
		//	paint grid and nodes based on 
		//	_grid and _nodes global variable and window size
		function paint() 
		{	
			_w = DesktopContent.getWindowWidth();
			_h = DesktopContent.getWindowHeight();
			
			//console.log("_grid",_grid);
			//console.log("_nodes",_nodes);
			//console.log("_arrows",_arrows);

			var MIN_H = 280;
			var MIN_W = 280;
			if(_w < MIN_W)
				_w = MIN_W;
			if(_h < MIN_H)
				_h = MIN_H;
			
			//Debug.log("paint w,h=" + _w + "," + _h);

			_canvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_canvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_canvas.width = (_w - _CANVAS_MARGIN*2);
			_canvas.height = (_h - _CANVAS_MARGIN*2);
			_context.clearRect(0, 0, _canvas.width, _canvas.height);
			
			_actionCanvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_actionCanvas.width = (_w - _CANVAS_MARGIN*2);
			_actionCanvas.height = (_h - _CANVAS_MARGIN*2);
			_actionContext.clearRect(0, 0, _canvas.width, _canvas.height);

			_gridCanvas.style.width = (_w - _CANVAS_MARGIN*2) + "px";
			_gridCanvas.style.height = (_h - _CANVAS_MARGIN*2) + "px";
			_gridCanvas.width = (_w - _CANVAS_MARGIN*2);
			_gridCanvas.height = (_h - _CANVAS_MARGIN*2);
			_gridContext.clearRect(0, 0, _canvas.width, _canvas.height);

			drawGrid();

			//determine node size and then draw			
			_NODE_SIZE = _grid.xstep*0.5;
			if(_NODE_SIZE > _grid.ystep*0.5)
				_NODE_SIZE = _grid.ystep*0.5;
			
			_grid.rowColMap = {};
			for(var i=0;i<_nodes.length;++i)							
				drawNode(i);
			
			drawArrows();
			
			//if selected nodes, offer delete
			if(Object.keys(_selectedNodes).length)
			{
				Debug.log("Offering deletion of selected nodes...");
				var el = document.getElementById("Status");
				var str = "";	//el.innerHTML;
				
				str += htmlClearDiv();
				
				//add delete trash can icon
				str += "<div id='allNodes" +  
						"-deleteIcon' class='node-icon node-deleteIcon' " +
						" onmouseup='handleDeleteIconMouseUp(-1 /*all nodes*/,event);'" +
						" onmousedown='event.stopPropagation() /* mousedown do nothing */;'" +
						"title='Delete the selected nodes.' " +
						"style='display:block; margin-top: -2px;' " +
						"></div>";
				str += "&nbsp;&nbsp;&nbsp;&nbsp;";
				str += "&lt;== Delete the selected nodes";
				el.innerHTML = str;
				el.style.display = "block";
			}
			else //re-apply _nodesHaveChanged status
				nodesHaveChanged(_nodesHaveChanged); 
			
		} //end paint()

		//=====================================================================================
		//drawGrid ~~
		function drawGrid() 
		{	
			if(_grid.cols < _GRID_COL_MIN) 
			{
				Debug.log("Not enough columns, defaulting.");
				_grid.cols = _GRID_COL_MIN;
			}
			if(_grid.rows < _GRID_ROW_MIN) 
			{
				Debug.log("Not enough rows, defaulting.");
				_grid.rows = _GRID_ROW_MIN;
			}
			
			//determine grid spacing
			_grid.xstep = (_w - 2*_GRID_MARGIN)/_grid.cols;			
			_grid.ystep = (_h - 2*_GRID_MARGIN)/_grid.rows;
			
			if(_grid.xstep < 0 || _grid.ystep < 0)
			{
				Debug.log("Window size is too small!",Debug.HIGH_PRIORITY);
				return;
			}
						
			_grid.x0 = _GRID_MARGIN + _grid.xstep/2;
			_grid.y0 = _GRID_MARGIN + _grid.ystep/2;
			
			//shrink margin if window is small
			if(_grid.x0 > _grid.xstep * 2)
			{
				_grid.x0 = _grid.xstep;
				_grid.xstep = (_w - 2*_grid.x0)/_grid.cols;	
				_grid.x0 = _grid.x0 + _grid.xstep/2;
			}
			if(_grid.y0 > _grid.ystep * 2)
			{
				_grid.y0 = _grid.ystep;		
				_grid.ystep = (_h - 2*_grid.ystep)/_grid.rows;
				_grid.y0 = _grid.y0 + _grid.ystep/2;
			}

			//console.log("drawGrid _grid",_grid);
			
			//draw grid +/- arrows
			//if node exists, get element
			var el = document.getElementById("grid-plusMinusArrowsContainer");
			if(!el) //else create it
			{
				el = document.createElement("div"); 
				el.setAttribute("id", "grid-plusMinusArrowsContainer");
				
				var str = "";
				
				//make 4 sets of +/- arrows
				var a = 0;
				//top set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-upDown'>";
				{ //make top up/down arrows
					str += "<div class='grid-plusMinusArrows-down grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a row from the canvas grid.' >" +
								//make up arrow
								"<div class='grid-plusMinusArrows-down-body'></div>" +
								"<div class='grid-plusMinusArrows-down-point'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-up grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a row to the canvas grid.' >" +
								//make down arrow
								"<div class='grid-plusMinusArrows-up-point'></div>" +
								"<div class='grid-plusMinusArrows-up-body'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//right set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-leftRight'>";
				{ //make right left/right arrows
					str += "<div class='grid-plusMinusArrows-left grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a column from the canvas grid.' >" +
							//make left arrow
							"<div class='grid-plusMinusArrows-left-point'></div>" +
							"<div class='grid-plusMinusArrows-left-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-right grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a column to the canvas grid.' >" +
							//make right arrow
							"<div class='grid-plusMinusArrows-right-body'></div>" +
							"<div class='grid-plusMinusArrows-right-point'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//bottom set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-upDown'>";
				{ //make bottom up/down arrows
					str += "<div class='grid-plusMinusArrows-up grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " +
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a row to the canvas grid.' >" +
								//make up arrow
								"<div class='grid-plusMinusArrows-up-point'></div>" +
								"<div class='grid-plusMinusArrows-up-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-down grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " + 
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a row to the canvas grid.' >" +
								//make down arrow
								"<div class='grid-plusMinusArrows-down-body'></div>" +
								"<div class='grid-plusMinusArrows-down-point'></div>" +										
							"</div>";
				}				
				str += "</div>\n\n\n"; //close top +/- set collection
				
				++a;
				//left set
				str += "<div class='grid-plusMinusArrows grid-plusMinusArrows-leftRight'>";
				{ //make left left/right arrows
					str += "<div class='grid-plusMinusArrows-left grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-plus' " + 
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(true /*isPlus*/, " +
							a + ")' title='Add a column to the canvas grid.' >" +
							//make left arrow
							"<div class='grid-plusMinusArrows-left-point'></div>" +
							"<div class='grid-plusMinusArrows-left-body'></div>" +										
							"</div>";
					str += "<div class='grid-plusMinusArrows-right grid-plusMinusArrows-arrow' " +
							"id='grid-plusMinusArrows" + a +
							"-minus' " + 
							"onmousedown='event.stopPropagation();' " +
							"onmouseup='event.stopPropagation();" + 
							"plusMinusGrid(false /*isPlus*/, " +
							a + ")' title='Remove a column from the canvas grid.' >" +
							//make right arrow
							"<div class='grid-plusMinusArrows-right-body'></div>" +
							"<div class='grid-plusMinusArrows-right-point'></div>" +										
							"</div>";
				}				
				str += "</div>"; //close top +/- set collection
				el.innerHTML = str;
				_postCanvas.appendChild(el);	
			}

			var arrows = el.getElementsByClassName("grid-plusMinusArrows");
			sz = 100;
			vsz = 30;
			arrows[0].style.left 	= ((_w/2 - sz/2)|0) + "px";
			arrows[0].style.top 	= (((_GRID_MARGIN-vsz)/2)|0) + "px";
			arrows[1].style.left 	= ((_w - (_GRID_MARGIN-vsz)/2 - vsz)|0) + "px";
			arrows[1].style.top 	= ((_h/2 - sz/2)|0) + "px";
			arrows[2].style.left 	= ((_w/2 - sz/2)|0) + "px";
			arrows[2].style.top 	= ((_h - (_GRID_MARGIN-vsz)/2 - vsz)|0) + "px";
			arrows[3].style.left 	= (((_GRID_MARGIN-vsz)/2)|0) + "px";
			arrows[3].style.top 	= ((_h/2 - sz/2)|0) + "px";

			//draw grid dots			
			_gridContext.save();
			_gridContext.fillStyle   	= _GRID_COLOR;
			_gridContext.shadowOffsetX 	= 2;
			_gridContext.shadowOffsetY 	= 2;
			_gridContext.shadowBlur    	= 5;
			_gridContext.shadowColor	= _SHADOW_COLOR;
			
			//_context.fillRect(10,10,100,100);
					
			var r,c;
			for(r=0;r<_grid.rows;++r)
				for(c=0;c<_grid.cols;++c)
					_gridContext.fillRect(
							(_grid.x0 + c*_grid.xstep)|0,
							(_grid.y0 + r*_grid.ystep)|0,							
							3,3 /*size w,h in pixels*/);
			
			_gridContext.restore();
		} //end drawGrid()

		//=====================================================================================
		//plusMinusGrid ~~
		//	add or subtract row/col, and adjust nodes
		// directionIndex := 0-3 := top, right, bottom, left
		function plusMinusGrid(isPlus,directionIndex)
		{
			Debug.log("plusMinusGrid isPlus=" + 
					isPlus + " directionIndex=" +
					directionIndex);
			
			if(!isPlus) //then deleting row/col
			{
				if(directionIndex == 0 || 
						directionIndex == 2)
				{
					//dealing with a row
					
					var y = directionIndex == 0?
							0:_grid.rows-1;

					if(_grid.rows <= _GRID_ROW_MIN)
					{
						Debug.log("Can not delete row " + y +
								"; " + _GRID_ROW_MIN +
								" rows is the minimum!",
								Debug.HIGH_PRIORITY);
						return;
					}
					
					//check for conflict
					for(var i=0;i<_nodes.length;++i)
						if(_nodes[i].y == y)
						{
							Debug.log("Can not delete row " + y +
									" while still occupied!",
									Debug.HIGH_PRIORITY);
							return;
						}
					
					//remove row 
					--_grid.rows;
					
					//move all nodes if row-0 was removed
					if(directionIndex == 0)
						for(var i=0;i<_nodes.length;++i)
							--_nodes[i].y;					
				}
				else if(directionIndex == 1 || 
						directionIndex == 3)
				{
					//dealing with a column
					
					var x = directionIndex == 3?
							0:_grid.cols-1;

					if(_grid.cols <= _GRID_COL_MIN)
					{
						Debug.log("Can not delete column " + x +
								"; " + _GRID_COL_MIN + 
								" columns is the minimum!",
								Debug.HIGH_PRIORITY);
						return;
					}

					//check for conflict
					for(var i=0;i<_nodes.length;++i)
						if(_nodes[i].x == x)
						{
							Debug.log("Can not delete column " + x +
									" while still occupied!",
									Debug.HIGH_PRIORITY);
							return;
						}

					//remove column 
					--_grid.cols;

					//move all nodes if col-0 was removed
					if(directionIndex == 3)
						for(var i=0;i<_nodes.length;++i)
							--_nodes[i].x;
				}
				else
				{	
					Debug.log("Unrecognized direction index - should be impossible!",
							Debug.HIGH_PRIORITY);
				}

				nodeLayoutHasChanged();
				
				//re-paint adjustments
				paint(); 
				
				return;
			} //end minus handling
			
			//if here, then add handling
			
			if(directionIndex == 0 || 
					directionIndex == 2)
			{
				//dealing with a row
				++_grid.rows;
				
				//move all nodes if row-0 was added
				if(directionIndex == 0)
					for(var i=0;i<_nodes.length;++i)
						++_nodes[i].y;
			}
			else if(directionIndex == 1 || 
					directionIndex == 3)
			{
				//dealing with a column
				++_grid.cols;

				//move all nodes if col-0 was removed
				if(directionIndex == 3)
					for(var i=0;i<_nodes.length;++i)
						++_nodes[i].x;
			}
			else
			{	
				Debug.log("Unrecognized direction index - should be impossible!",
						Debug.HIGH_PRIORITY);
			}

			nodeLayoutHasChanged();
			
			//re-paint adjustments
			paint(); 
			
		} //end plusMinusGrid()

		//=====================================================================================
		//getNodeFontSize ~~
		function getNodeFontSize()
		{
			var fontSz = _NODE_SIZE/10;
			return (fontSz < 6)?6:fontSz;
		} //end getNodeFontSize()
		
		//=====================================================================================
		//handleSelectionBox ~~
		//	draw selection box,	and handle identifying
		//	nodes within selection area.
		function handleSelectionBox(e)
		{
			var box = [
			   _mouseMoveStart[0] < e.clientX?
					   _mouseMoveStart[0]:e.clientX,
			   _mouseMoveStart[1] < e.clientY?
					   _mouseMoveStart[1]:e.clientY,
			   _mouseMoveStart[0] < e.clientX?
					   e.clientX:_mouseMoveStart[0],
			   _mouseMoveStart[1] < e.clientY?
					   e.clientY:_mouseMoveStart[1]
			 ]; //box top-left ==> bot-right
			
			//console.log("box",box);
			
			var el = document.getElementById("selectionBoxDiv");
			
			el.style.left 	= box[0] + "px";
			el.style.top 	= box[1] + "px";
			el.style.width 	= (box[2]-box[0]) + "px";
			el.style.height = (box[3]-box[1]) + "px";
			
			//determine temporary selected nodes
			_mouseMoveStart[2] = {}; //store selected nodes here
			var nodeBox = [
			   ((box[0] - _grid.x0 + _grid.xstep/2)/_grid.xstep),
			   ((box[1] - _grid.y0 + _grid.ystep/2)/_grid.ystep),
			   ((box[2] - _grid.x0 + _grid.xstep/2)/_grid.xstep),
			   ((box[3] - _grid.y0 + _grid.ystep/2)/_grid.ystep)			   
				];
			for(var i=0;i<4;++i) //clip to -1 and integer
				if(nodeBox[i] < 0) nodeBox[i] = -1;
				else nodeBox[i] |= 0;
			
			if(box[0] > 
					_grid.x0 + nodeBox[0]  * _grid.xstep + _NODE_SIZE/2)
				++nodeBox[0]; //lose selection
			if(box[1] > 
					_grid.y0 + nodeBox[1]  * _grid.ystep + _NODE_SIZE/2)
				++nodeBox[1]; //lose selection
			if(box[2] <
					_grid.x0 + nodeBox[2]  * _grid.xstep - _NODE_SIZE/2)
				--nodeBox[2]; //lose selection
			if(box[3] < 
					_grid.y0 + nodeBox[3]  * _grid.ystep - _NODE_SIZE/2)
				--nodeBox[3]; //lose selection
			
			//console.log("node box selection",nodeBox);
			
			for(var xg=nodeBox[0];xg<=nodeBox[2];++xg)
				for(var yg=nodeBox[1];yg<=nodeBox[3];++yg)
					if(_grid.rowColMap[xg] !== undefined &&
							_grid.rowColMap[xg][yg] !== undefined)
					{
						Debug.log("Found selected node " +
								_grid.rowColMap[xg][yg]);
						_mouseMoveStart[2][_grid.rowColMap[xg][yg]] = 1;
					}

			//console.log("nodes in box selection",_mouseMoveStart[2]);

			paint();
		} //end handleSelectionBox()

		//=====================================================================================
		//drawNode ~~
		//	draw a node of specified by node index 
		function drawNode(i,xoff,yoff)
		{
			var type = _nodes[i].type;
			var x = _nodes[i].x;
			var y = _nodes[i].y;
			
			//add to _grid.rowColMap
			if(_grid.rowColMap[x] == undefined) 
				_grid.rowColMap[x] = {};
			_grid.rowColMap[x][y] = i | 0; //fill x,y position
			
			var nodeid = "node-" + i;
						
			var sz = _NODE_SIZE | 0; 
			x = (_grid.x0 + x * _grid.xstep - sz/2) | 0;
			y = (_grid.y0 + y * _grid.ystep - sz/2) | 0;
			
			if(xoff) x += xoff;
			if(yoff) y += yoff;
			
			//Debug.log("x,y,sz = " + x + "," + y + "," + sz);

			var typeName = ARTDAQConfigurationAPI.getShortTypeName(type);
			var typeClass = "node" + typeName;
			var typeAcronym = ARTDAQConfigurationAPI.NODE_TYPE_ACRONYM[type];
									
			//Debug.log("nodeid = " + nodeid + "; typeClass = " + typeClass);

			//if node exists, get element
			var el = document.getElementById(nodeid);
			if(!el) //else create it
			{
				el = document.createElement("div"); 
				el.setAttribute("class", "node " + typeClass);
				el.setAttribute("id", nodeid);
								
				//draw box, connect points, pencil, and trashcan
				var str = "";
										
				//box
				var count = _nodes[i].nodeCount?_nodes[i].nodeCount:1;
				
				var nodeName = _nodes[i].name;
				var hostname;
				
				if(type == ARTDAQConfigurationAPI.NODE_TYPE_SUPERVISOR)
				{
					hostname = _nodes[i].contextAddress + ":" +
							_nodes[i].contextPort;
				} //end supervisor handling
				else // non-supervisor node handling
				{
					hostname = _nodes[i].hostname;
					if(count > 1)
					{
						//special multi-node name handling
						
						nodeName = nodeName.replace(new RegExp("\\*",'g'), 
								"[" + 
								getPrinterSyntaxStringWithWidth(
								_nodes[i].nodeVectorIndexString,
								_nodes[i].nodeNameFixedWidth)
								+ 
								"]"); 
					}
					if(hostname.indexOf('*') >= 0)
					{
						//special hostname array handling
						
						hostname = hostname.replace(new RegExp("\\*",'g'), 
								"[" + 
								getPrinterSyntaxStringWithWidth(
								_nodes[i].hostnameVectorIndexString,
								_nodes[i].hostnameFixedWidth) + 
								"]"); 
					}
					
					if(count > 4) count = 4; //cap at 4
					//console.log("i,count",i,count);	
				} //end non-supervisor handling
				
				for(var p=count-1;p>=0;--p)
				{
					str += "<div id='" + nodeid + 
						(p == 0?"":("-multi" + p)) + "-box' class='node-box' " +
						"style='top:" + (-p*5) + "px;" +
						"background-color: " + 
						(_nodes[i].status? //if off, show as gray
							getSubsystemColor(_nodes[i].subsystemId):
							_OFF_COLOR)+ ";" +
						"left:" + (-p*5) + "px;' " +
						">";
					if(p == 0)
					{
						str += "<div id='" + nodeid + 
							"-boxText' class='node-boxText'>" +
							typeAcronym +
							"</div>";
					}
					str += "</div>";
				}
				
				//connect points
				for(var p=0;p<4;++p)
					str += "<div id='" + nodeid + 
						"-point" + p + 
						"' class='node-point" + p +
						" node-point node-point-open' " +
						"title='Use these anchors to modify or create connection arrows with other nodes.' " +
						" onmouseup='handlePointMouseUp(" + 
						i + "," + p + ",event);'" +
						" onmousedown='handlePointMouseDown(" + 
						i + "," + p + ",event);'" +
						"></div>";
				
				//header text
				str += "<div id='" + nodeid + 
						"-headerText' class='node-headerText' onmousedown='handleNodeHeaderMouseDown' >" +
						(_nodes[i].status?"":"<label style='color:red; font-size:inherit;'>*OFF*</label> ") +
						(count > 1?(_nodes[i].nodeCount + "x "):"") + 
						typeName + "::" + nodeName +
						htmlClearDiv() + 
						(_subsystems[_nodes[i].subsystemId]? //e.g. undefined for artdaq supervisor
								_subsystems[_nodes[i].subsystemId].label:"") + 
						" @ " + hostname +			
					"</div>";
				
				//add edit pencil icon
				str += "<div id='" + nodeid + 
						"-editIcon' class='node-icon node-editIcon' " +
						"title='Edit the configuration of this node.' " +
						" onmouseup='handleEditIconMouseUp(" + 
						i + ",event);'" +
						" onmousedown='event.stopPropagation() /* mousedown do nothing */;'" +
						"></div>";
				//add view fcl icon
				str += "<div id='" + nodeid + 
						"-viewFclIcon' class='node-icon node-viewFclIcon' " +
						"title='View the generated FHiCL of this node.' " +
						" onmouseup='handleFclIconMouseUp(" + 
						i + ",event);'" +
						" onmousedown='event.stopPropagation() /* mousedown do nothing */;'" +
						">" +
						"<div class='node-viewFclIcon-line'></div>" +
						"<div class='node-viewFclIcon-line'></div>" +
						"</div>";
				//add delete trash can icon
				str += "<div id='" + nodeid + 
						"-deleteIcon' class='node-icon node-deleteIcon' " +
						" onmouseup='handleDeleteIconMouseUp(" + 
						i + ",event);'" +
						" onmousedown='event.stopPropagation() /* mousedown do nothing */;'" +
						"title='Delete this node.' " +
						"></div>";
				
				el.innerHTML = str;
				_postCanvas.appendChild(el);	
				el.onmouseover = handleNodeMouseOver;	
			} //end create node element		
			
			var boxes = el.getElementsByClassName("node-box");
			for(var p=0;p<boxes.length;++p)
			{
				boxes[p].style.width  = sz + "px";
				boxes[p].style.height = sz + "px";
			}		
			
			if(_selectedNodes[i] !== undefined || 
					(_mouseMoveMode == _MMM_SELECT_BOX &&
							_mouseMoveStart[2][i] !== undefined))
			{ //selected node
				boxes[boxes.length-1].style.border = "3px solid green";
			}
			else
				boxes[boxes.length-1].style.border = "0";
			
			el.style.left 	= x + "px";
			el.style.top 	= y + "px";		
			
			var pointSz = 12;
			var points = el.getElementsByClassName("node-point");
			var pxy;
			for(var p=0;p<4;++p)
			{
				pxy = getNodePoint(i,p);
				points[p].style.left 	= (pxy[0] - x - pointSz/2) + "px";
				points[p].style.top 	= (pxy[1] - y - pointSz/2) + "px";
			}
			
			var fontSz = getNodeFontSize();
			var count = (_nodes[i].nodeCount && _nodes[i].nodeCount > 4)?4:(_nodes[i].nodeCount|0);		
									
			el = document.getElementById(nodeid + "-headerText");
			el.setAttribute("class","node-headerText"); //reset class in case hovering recently
			el.style.left = ((- (_grid.xstep*1.8-sz)/2 - (count?(count-1)*2:0) - 5)|0) + "px"; //-5 because grid/arrow left is biased to 0 position
			el.style.fontSize = ((fontSz)|0) + "px";
			el.style.top = ((-fontSz*3-fontSz/2 - (count?(count-1)*5:0))|0) + "px";
			el.style.height = ((fontSz*3)|0) + "px";
			el.style.width = ((_grid.xstep*1.8 )|0) + "px";
			
			fontSz = sz/5;
			if(fontSz < 6) fontSz = 6;
			el = document.getElementById(nodeid + "-boxText");
			el.style.fontSize = ((fontSz)|0) + "px";
			el.style.marginTop = ((sz/2 - fontSz/2)|0) + "px";			
						
			el = document.getElementById(nodeid + "-editIcon");
			el.style.left = (-10) + "px";
			el.style.top = (sz+32) + "px";
			el = document.getElementById(nodeid + "-viewFclIcon");
			el.style.left = (((sz/2)|0)-10) + "px";
			el.style.top = (sz+32) + "px";
			el = document.getElementById(nodeid + "-deleteIcon");
			el.style.left = (sz-10) + "px";
			el.style.top = (sz+32) + "px";
			
		} //end drawNode()

		//=====================================================================================
		//drawArrows ~~
		function drawArrows() 
		{	
			var xy0,xy1;
			for(var i in _arrows)
				for(var j in _arrows[i])
				{
					xy0 = getNodePoint(i|0,_arrows[i][j].p0);
					xy1 = getNodePoint(j|0,_arrows[i][j].p1);
					//console.log("xy01",xy0,xy1);
					drawArrow(xy0[0],xy0[1],xy1[0],xy1[1],
							undefined /*isActionCanvas*/,_arrows[i][j].color);
				}
			
		} //end drawArrows()
		
		//=====================================================================================
		//drawArrow ~~
		function drawArrow(x0,y0,x,y,isActionCanvas,color) 
		{	
			//console.log("drawArrow x0,y0,x,y,isActionCanvas ",
			//		x0,y0,x,y,isActionCanvas);
			
			if(isActionCanvas) //assume one at a time in action
				_actionContext.clearRect(0, 0, _canvas.width, _canvas.height);
			
			var context = isActionCanvas?_actionContext:_context;
			
			context.save();
			
			var HEAD_SZ = 10;
			var LINE_SZ = 2;
			
			//make arrow slightly shorter than full distance
			
            var angle = Math.atan2(y-y0,x-x0);
            
            var shortOffset = (getNodeFontSize()*4)|0; //avoid text above
            if(y0 >= y) shortOffset = HEAD_SZ*1;
            
            if(!isActionCanvas)
            {
				x -= shortOffset*Math.cos(angle);
				y -= shortOffset*Math.sin(angle);
            }

            //starting path of the arrow from the start square to the end square and drawing the stroke
            context.beginPath();
            context.moveTo(x0, y0);
            context.lineTo(x, y);
            context.strokeStyle = color?color:_ARROW_COLOR;
            context.lineWidth = LINE_SZ;
            context.stroke();

            //starting a new path from the head of the arrow to one of the sides of the point
            context.beginPath();
            context.moveTo(x, y);
            context.lineTo(x-HEAD_SZ*Math.cos(angle-Math.PI/7),y-HEAD_SZ*Math.sin(angle-Math.PI/7));

            //path from the side point of the arrow, to the other side point
            context.lineTo(x-HEAD_SZ*Math.cos(angle+Math.PI/7),y-HEAD_SZ*Math.sin(angle+Math.PI/7));

            //path from the side point back to the tip of the arrow, and then again to the opposite side point
            context.lineTo(x, y);
            context.lineTo(x-HEAD_SZ*Math.cos(angle-Math.PI/7),y-HEAD_SZ*Math.sin(angle-Math.PI/7));

            //draws the paths created above
            context.strokeStyle = color?color:_ARROW_COLOR;
            context.lineWidth = LINE_SZ;
            context.stroke();
            context.fillStyle = color?color:_ARROW_COLOR;
            context.fill();
            
			context.restore();
		} //end drawArrow()		

		//=====================================================================================
		//handleMouseMove ~~
		function handleMouseMove(e) 
		{	
			if(document.getElementById(ConfigurationAPI._POP_UP_DIALOG_ID) ||
					document.getElementById(DesktopContent._verifyPopUpId) ||					
					!_grid || !_grid.rowColMap)
				return; //disable while popup or initializing
				
		
    		var x = e.clientX;//- this.offsetLeft - _CANVAS_MARGIN - 2;
    		var y = e.clientY;//- this.offsetTop - _CANVAS_MARGIN - 2;
			
    		if(x == undefined) //handle as a key press
    		{
    			x = DesktopContent.getMouseX();				
    			y = DesktopContent.getMouseY();
    		}
    		//console.log("mousemove x,y",x,y);
    		
    		//debug visually
    		//_context.fillRect((x)|0,(y)|0,3,3 );
    		
    		//steps:
    		//	if mousedown, draw arrow or dragging object
    		//	else if over empty grid position, show + 
    		//	else if over node show node decription/options
    		
    		
    		//----------------------------
    		//if mouse 'down' move handling
    		if(_mouseMoveMode != _MMM_NONE)
    		{
    			//handle mousemove mode
    			
    			//hide +
    			_addNodeEl.style.left = "-1000px"; //off screen
    			
    			switch(_mouseMoveMode)
    			{
    			case _MMM_ARROW_DRAG:
    				//console.log("arrow drag x,y",x,y);
    				drawArrow(
    						_mouseMoveStart[0],
							_mouseMoveStart[1],
							x,y, true /*isActionCanvas*/);
    				//continue on
    				break;    
    			case _MMM_NODE_DRAG:
    				//console.log("node drag x,y",x,y);
    				
    				//if node is in selection nodes, then move all of them
    				//else just move node
    				
    				if(_selectedNodes && 
    						_selectedNodes[_mouseMoveStart[2]] !== undefined)
    				{
    					for(var i in _selectedNodes)
        					drawNode(
        						i,
        						x - _mouseMoveStart[0],
    							y - _mouseMoveStart[1]);
    				}
    				else //not in selection
    					drawNode(
    						_mouseMoveStart[2],
    						x - _mouseMoveStart[0],
							y - _mouseMoveStart[1]);
    				
    				return;
    			case _MMM_SELECT_BOX:
    				//console.log("select box",x,y);
    				handleSelectionBox(e);							
    				return;
    			case _MMM_POPUP_DIALOG: //ignore mouse move during popup
    				return;
    			default:
    				Debug.log("Illegal _mouseMoveMode = " + _mouseMoveMode, 
    						Debug.HIGH_PRIORITY);
    				return; //do not continue on
    			}
    			
    			//for some modes, continue on to show mouse over nodes while dragging
    			
    		} //end handle mousemove mode

    		
			var xg = getGridX(x);
			var yg = getGridY(y);			
			
			if(xg < 0) xg = -1; //clip to -1 for +/- icons
			else xg |= 0;
			if(yg < 0) yg = -1; //clip to -1 for +/- icons			
			else yg |= 0;
			

			//console.log("mousemove x,y",x,y,
			//		"mousemove xg,yg",xg,yg);
			
			if(xg >= 0 && yg >= 0 && 
					xg < _grid.cols && 
					yg < _grid.rows)
			{
				//console.log("Node over " + xg + "," + yg);
				
				//if directly over node-box, show grabbable hand				
				var overNodeBox = isOverNodeBox(x,y,xg,yg);

				if(_grid.rowColMap[xg] !== undefined &&
					_grid.rowColMap[xg][yg] !== undefined)
				{
					//----------------------------
					//	if over node show node decription/options
									
					//Debug.log("Node over " + xg + "," + yg);
					
					
					if(overNodeBox)
					{
						//if over a filled spot, remove +			
						_addNodeEl.style.left = "-1000px"; //off screen

						doNodeHover(_grid.rowColMap[xg][yg]);

						if(e.shiftKey) //indicate toggle selection
							this.style.cursor = "pointer";
						else
							this.style.cursor = "grab";
					}
					else
						this.style.cursor = "default";

					return;
				}
				else if(overNodeBox) // else there is no node
				{		
					//----------------------------
					//if over empty grid position, show +
					
					//do not show + if for mouse move modes
					if(_mouseMoveMode != _MMM_NONE) return;
					
					//Debug.log("Place + at " + xg + "," + yg);
	
					//hijack _mouseMoveStart to record + position
					_mouseMoveStart[0] = xg;
					_mouseMoveStart[1] = yg;
					
					var sz = 32;
					_addNodeEl.style.left =
							((_grid.x0 + xg * _grid.xstep - sz/2) | 0) + "px";
					_addNodeEl.style.top =
							((_grid.y0 + yg * _grid.ystep - sz/2) | 0) + "px";					
				}
				else if(_nodes && _mouseHoverNode >= 0 && _mouseHoverNode < _nodes.length &&
						Math.abs(xg - _nodes[_mouseHoverNode].x) <= 1 &&
						Math.abs(yg - _nodes[_mouseHoverNode].y) <= 1 )
					return; //do nothing if close to hover node to avoid losing node edit/delete icons
			}
			else
			{
				//if not handled, remove +			
				_addNodeEl.style.left = "-1000px"; //off screen

				var pxy = getGridPointXY(xg,yg);
				
				//add +/- row column icons
				if(yg == -1 && y < pxy[1] - _NODE_SIZE/2) 
					doNodeHover(-10); //show top icons
				else if(xg >= _grid.cols && x >= pxy[0] + _NODE_SIZE/2)
					doNodeHover(-11); //show right icons
				else if(yg >= _grid.rows && y >= pxy[1] + _NODE_SIZE/2)
					doNodeHover(-12); //show top icons
				else if(xg == -1 && x < pxy[0] - _NODE_SIZE/2)
					doNodeHover(-13); //show left icons
				
				return;
			}
			
			//undo cursor changes if any
			this.style.cursor = "default";	
				
			//undo hover node, if any
			if(_mouseHoverNode != -1)
				doNodeHover(_mouseHoverNode,true /*undoHover*/);
			
		} //end handleMouseMove()

		//=====================================================================================
		//handleMouseUp ~~
		function handleMouseUp(e) 
		{	
			e.stopPropagation();
			
    		var x = e.clientX;
    		var y = e.clientY;
			
    		//console.log("mouseup x,y",x,y);
    		    		
    		//debug visually
    		//_context.fillRect((x)|0,(y)|0,3,3 );
    		
    		if(_mouseMoveMode != _MMM_NONE)
    		{
    			switch(_mouseMoveMode)
    			{
    			case _MMM_ARROW_DRAG:

    				//see if node drag ended in valid spot
    				var xg = getGridX(x)|0;
    				var yg = getGridY(y)|0;	
    				
    				if(_grid.rowColMap[xg] === undefined ||
    						_grid.rowColMap[xg][yg] === undefined)
    				{
													
						console.log("done arrow drag NO VALID END x,y",x,y);
						_mouseMoveMode = _MMM_NONE;
						
						Debug.log("The destination end-point was invalid! Make sure you end the operation " +
								"by hovering over a valid anchor with your cursor.",
								Debug.HIGH_PRIORITY);
						
						//re-paint to clear invalid move
						paint();
    				}
    				else
    				{
    					console.log("done arrow drag end-point x,y",xg,yg);
						
						_mouseMoveMode = _MMM_NONE;   

						validateNewArrow(_mouseMoveStart[2] /*starti*/,
								_grid.rowColMap[xg][yg] /*endi*/);	
    				}
    				break;    
    			case _MMM_NODE_DRAG:
    				
    				//end mousemove
    				_mouseMoveMode = _MMM_NONE;
    				
    				//see if node drag ended in open spot
    				var xg = getGridX(x);
    				var yg = getGridY(y);			

    				if(xg < 0) xg = -1; //clip to -1 for +/- icons
    				else xg |= 0;
    				if(yg < 0) yg = -1; //clip to -1 for +/- icons			
    				else yg |= 0;
    				
    				//copy grid map, so we can invalidate all positions in current group
    				var gridMapCopy = {};
    				for(var i in _grid.rowColMap)
    				{
    					gridMapCopy[i] = {};

    					for(var j in _grid.rowColMap[i])
    						gridMapCopy[i][j] = 1;
    				}
    				//invalidate/delete selected nodes, so the move can go into those spots
    				if(_selectedNodes)
    					for(var i in _selectedNodes)
    						delete gridMapCopy[_nodes[i].x][_nodes[i].y];

    				if(xg >= 0 && yg >= 0 && 
    						xg < _grid.cols && 
							yg < _grid.rows &&
							(
								gridMapCopy[xg] === undefined ||
								gridMapCopy[xg][yg] === undefined
							))
    				{
    					Debug.log("Node drag to new open spot " + 
    							xg + "," + yg);
    					
    					if(_selectedNodes && 
    							_selectedNodes[_mouseMoveStart[2]] !== undefined)
    					{
    						Debug.log("Checking group drag...");
    						
    						var gridStepX = xg - _nodes[_mouseMoveStart[2]].x;
    						var gridStepY = yg - _nodes[_mouseMoveStart[2]].y;
    						
    						var allSpotsOpen = true;
        					for(var i in _selectedNodes)
        					{
        						if(!(_nodes[i].x+gridStepX >= 0 && 
        								_nodes[i].y+gridStepY >= 0 && 
										_nodes[i].x+gridStepX < _grid.cols && 
										_nodes[i].y+gridStepY < _grid.rows &&
										(
									gridMapCopy[_nodes[i].x+gridStepX] === undefined ||
									gridMapCopy[_nodes[i].x+gridStepX][_nodes[i].y+gridStepY] === undefined
        						)))
        						{
        							console.log("done node group drag NO VALID END i,x,y",
        									i,
											_nodes[i].x+gridStepX,_nodes[i].y+gridStepY);
        							            					
        							allSpotsOpen = false;
        							break;
        						}
        					}
        					
        					if(!allSpotsOpen)
        					{
            					console.log("done node group drag NO GROUP VALID END x,y",
            							xg,yg);
            					paint();
            					break;
        					}

        					//success, so apply changes
        					for(var i in _selectedNodes)
        					{
    							_nodes[i].x += gridStepX;
    							_nodes[i].y += gridStepY;
        					}
    					}
    					else
    					{    					
							_nodes[_mouseMoveStart[2]].x = xg;
							_nodes[_mouseMoveStart[2]].y = yg;
    					}
    					
    					nodeLayoutHasChanged();
    				}
    				else
    					console.log("done node drag NO VALID END x,y",x,y);
    				
    				//re-paint to clear invalid move
    				paint();
    				break;   

    			case _MMM_SELECT_BOX:
    				console.log("done select box",x,y);
    				_mouseMoveMode = _MMM_NONE;
    				var el = document.getElementById("selectionBoxDiv");
    				el.style.left 	= (-1000) + "px";
    				el.style.width 	= (0) + "px";
    				
    				if(!e.shiftKey)
    					_selectedNodes = {}; //clear selected nodes
    				
    				//transfer selected nodes from temporary
    				for(var n in _mouseMoveStart[2])
    					_selectedNodes[n] = 1;
    				_mouseMoveStart[2] = {}; //clear temporary selected nodes
    				paint();
    				break; 	
    			case _MMM_POPUP_DIALOG: //ignore mouse up during popup
    				return;		
    			default:
    				Debug.log("Illegal mouseup _mouseMoveMode = " +
    						_mouseMoveMode, 
    						Debug.HIGH_PRIORITY);
    			}
    		} //end mousemove mode handling
    		
		} //end handleMouseUp()

		//=====================================================================================
		//handleNodeHeaderMouseDown ~~
		function handleNodeHeaderMouseDown(e) 
		{	
			Debug.log("header down");
		} //end handleNodeHeaderMouseDown()
				
		//=====================================================================================
		//handleMouseDown ~~
		function handleMouseDown(e) 
		{					
			if(_mouseMoveMode == _MMM_POPUP_DIALOG) return; //ignore!

			console.log("mousedown",_mouseHoverNode);
			e.stopPropagation();

			
    		var x = e.clientX;
    		var y = e.clientY;
    		var xg = getGridX(x) | 0;
    		var yg = getGridY(y) | 0;
    		
    		var isOverNode = false;
    		if(_nodes && _mouseHoverNode >= 0 && _mouseHoverNode < _nodes.length &&
    				xg == _nodes[_mouseHoverNode].x &&
					yg == _nodes[_mouseHoverNode].y)
    		{
    			//check if mouse down is not over node box
    			if(!isOverNodeBox(x,y,xg,yg))
    				return;
    			isOverNode = true;
    		}

    		console.log("mousedown x,y",x,y);
    		
    		
			if(_mouseMoveMode == _MMM_NONE && 
					_mouseHoverNode >= 0) 
			{ //start node dragging
				if(isOverNode) 
				{
					//shift key chooses toggling nodes
					if(e.shiftKey)
					{
						Debug.log("Toggling node select " + _mouseHoverNode);
						
						if(_selectedNodes[_mouseHoverNode] === undefined)
							_selectedNodes[_mouseHoverNode] = 1;
						else
							delete _selectedNodes[_mouseHoverNode];
						paint();
						return;
					}
					
					Debug.log("Starting node drag " + _mouseHoverNode);
					this.style.cursor = "grabbing";
					_mouseMoveMode = _MMM_NODE_DRAG;

					//start movement
					_mouseMoveStart = [ //x,y,i,p start (i,p are optional)
								x,y,_mouseHoverNode]; 
					
					//unhover node
					doNodeHover(_mouseHoverNode,true /*undoHover*/);
					
					return;
				}
			}
			
			
			if(_mouseMoveMode == _MMM_NONE)
			{ //start node selection box
				
				Debug.log("Starting select box ");
				
				//start selection box anchor
				_mouseMoveStart = [ //x,y,temp-selection-node-map
									x,y,{}]; 
				_mouseMoveMode = _MMM_SELECT_BOX;
				handleSelectionBox(e);
			}
			
		} //end handleMouseDown()
			
		//=====================================================================================
		//getNodePoint ~~
		//	returns x,y center of node point
		function getNodePoint(i,p) 
		{
			var x = _nodes[i].x;
			var y = _nodes[i].y;
			var sz = _NODE_SIZE | 0; 

			var x = (_grid.x0 + x * _grid.xstep - sz/2) | 0;
			var y = (_grid.y0 + y * _grid.ystep - sz/2) | 0;

			var count = _nodes[i].nodeCount?_nodes[i].nodeCount:1;
			if(count > 4) count = 4; //cap at 4
			if(count < 1) count = 1; 
			var multiOff = (count-1)*5;
			
			
			switch(p)
			{
			case 0: //top
				return [(x + sz/2)|0,
						(y - multiOff)|0];
			case 1: //right
				return [(x + sz)|0,
						(y + sz/2)|0];
			case 2: //bottom
				return [(x + sz/2)|0,
						(y + sz - 1)|0];
			case 3: //left
				return [(x - 1 - multiOff)|0,
						(y + sz/2)|0];
			default:
				Debug.log("illegal point request! " + p,
						Debug.HIGH_PRIORITY);
			}
		} //end getNodePoint()
		
		//=====================================================================================
		//doNodeHover ~~
		//	handle mouse hover display of node
		function doNodeHover(i,undoHover) 
		{					
			//if attempting to hover then... 
			if(!undoHover)
			{
				//if already hovering, done
				if(_mouseHoverNode == i) return;
				//if another node was hovering, unhover it
				if(_mouseHoverNode != -1)
					doNodeHover(_mouseHoverNode,true /*undoHover*/);
				
				_mouseHoverNode = i;
			}
			else 
				_mouseHoverNode = -1; //clear mouse hover
			
			//Debug.log((undoHover?"Hide ":"") + "Mouse over node " + i);
			
			//if no particular target, undo extraneous
			if(i == -1 && undoHover)
			{
				//remove +			
				_addNodeEl.style.left = "-1000px"; //off screen
				
				var els = document.getElementsByClassName(
						"grid-plusMinusArrows");
				for(var j=0;j<els.length;++j)
					els[j].style.display = "none";

				return;
			}
			
			//if targeting +/- arrows
			if(i < -1)
			{
				//do not show for mouse move modes
				if(!undoHover && _mouseMoveMode != _MMM_NONE) return; 
				
				//Debug.log("This is +/- icon " + (3-(i+13)));
				document.getElementsByClassName(
						"grid-plusMinusArrows")[(3-(i+13))].style.display = 
								undoHover?"none":"block";
				return;
			}
			
			var nodeid = "node-" + i;
			var el = document.getElementById(nodeid);	
			
			if(!el) return; //ignore missing node element
			
			//handle points
			var points = el.getElementsByClassName("node-point");		
			for(var p=0;p<4;++p)
				points[p].style.display = undoHover?"none":"block";
			
			//do not show icons for mouse move modes
			if(!_nodes || i >= _nodes.length ||
					(!undoHover && _mouseMoveMode != _MMM_NONE)) return;
			
			el = document.getElementById(nodeid + "-editIcon");
			el.style.display = undoHover?"none":"block";
			el = document.getElementById(nodeid + "-viewFclIcon");
			el.style.display = undoHover?"none":"block";
			el = document.getElementById(nodeid + "-deleteIcon");
			el.style.display = undoHover?"none":"block";
			
			var fontSz = getNodeFontSize();
			fontSz = undoHover?fontSz:fontSz*2;			
			var count = (_nodes[i].nodeCount && _nodes[i].nodeCount > 4)?4:(_nodes[i].nodeCount|0);		
						
			el = document.getElementById(nodeid + "-headerText");
			
			if(undoHover)
			{
				ConfigurationAPI.removeClass(el,"node-headerTextHover");
				el.style.top = ((-fontSz*3-fontSz/2 - (count?(count-1)*5:0))|0) + "px";
				el.style.zIndex = 1000;
			}
			else
			{
				ConfigurationAPI.addClass(el,"node-headerTextHover");
				el.style.top = ((-fontSz*3-fontSz/2 -13 - (count?(count-1)*5:0))|0) + "px";
				el.style.zIndex = 10000;
			}
			el.style.left = ((- (_grid.xstep*1.8-_NODE_SIZE)/2 - (count?(count-1)*2:0) - 5)|0) + "px"; //-5 because grid/arrow left is biased to 0 position
			el.style.fontSize = ((fontSz)|0) + "px";
			
			el.style.height = ((fontSz*3)|0) + "px";
			el.style.width = ((_grid.xstep*1.8 )|0) + "px";
		} //end doNodeHover()

		//=====================================================================================
		//handlePointMouseDown ~~
		function handlePointMouseDown(i,p,e) 
		{	   
			e.stopPropagation();

			Debug.log("mousedown-point i,p = " +
					i + "," + p);
			
			if(_mouseMoveMode == _MMM_NONE)
			{
				Debug.log("Starting arrow drag mouseup-point i,p = " +
						i + "," + p);
				_mouseMoveMode = _MMM_ARROW_DRAG;
				_mouseMoveStart = getNodePoint(i,p);
				_mouseMoveStart[2] = i;
				_mouseMoveStart[3] = p;
			}
			
		} //end handlePointMouseDown()
		
		//=====================================================================================
		//handlePointMouseUp ~~
		function handlePointMouseUp(i,p,e) 
		{	   
			e.stopPropagation();
			
    		Debug.log("mouseup-point i,p = " +
    				i + "," + p);

    		var x = e.clientX;
    		var y = e.clientY;
    		
    		if(_mouseMoveMode != _MMM_NONE && //dragging arrow
    				i != _mouseMoveStart[2]) //and not at same starting point
    		{
				console.log("done arrow drag end-point i,p",i,p);
				_mouseMoveMode = _MMM_NONE;    	
				
				validateNewArrow(_mouseMoveStart[2] /*starti*/,
						i /*endi*/);				
    		}
    		
		} //end handlePointMouseUp()

		//=====================================================================================
		//handleEditIconMouseUp ~~
		function handleEditIconMouseUp(i,e,x,subi,menuDepth,menuDepthType) 
		{	   
			if(e) e.stopPropagation();
		
			var type = _nodes[i].type;								
			var typeName = ARTDAQConfigurationAPI.getShortTypeName(type);
										
			if(x == undefined && _nodes[i].nodeCount && _nodes[i].nodeCount > 1)
			{
				Debug.log("Showing multi-node menu");
				
				//handle node vector level first
				var menuItems = [];
				var menuItemHandlers = [];

				menuItems.push("Edit <b><u>Multi-Node</u></b> (i.e. name, subsystem, host, instances)");
				menuItemHandlers.push("launchEditNodeDialog(" + i + ")");
				
				for(var j=0;j<_nodes[i].nodeCount;++j)
				{
					menuItems.push( "Edit <b><u>" + typeName + 
							"::" + getMultiNodeName(i,j) +
							"</u></b> node instance");
					menuItemHandlers.push("handleEditIconMouseUp(" +
							i + ", undefined /*e*/, " +
							(e.pageX - 10) + " /*x*/," +
							j + " /*subi*/" +
							")");
				}
				x = event.pageX - 10;
				var y = event.pageY - 10; 
				if(_w - x < 400) x = _w - 405; //move box away from edge
				if(x < 5) x = 5;

				SimpleContextMenu.createMenu(
						menuItems,
						menuItemHandlers,
						"simpleContextMenuPopup",		//element ID
						e.pageX - 10, e.pageY - 10, 		//top left position
						_MENU_PRIMARY_COLOR,
						_MENU_SECONDARY_COLOR,
						true /*defaultHighlighting*/
				);	
				
				return;
			}
			//else handle single node
			
			if(!x) x = event.pageX - 10;
			var y = event.pageY - 10; //always follow mouse -- otherwise menu may become impossible to navigate
			if(_w - x < 400) x = _w - 405; //move box away from edge
			if(x < 5) x = 5;
			
			Debug.log("mouseup-edit i = " + i + "[" + 
					subi + "] - d" + menuDepth + ":" + 
					menuDepthType + " - " +
					typeName + "::" +
					_nodes[i].name);
			
			var editTypes = [];
			var depthTypes = {}; //define depth type if more menu depth
						
			if(!menuDepth) //at 0 depth, all types have top level params
				editTypes.push("Top-level Parameters");
			
			if(type == ARTDAQConfigurationAPI.NODE_TYPE_READER)
			{
				if(!menuDepth)
				{
					editTypes.push("DAQ Parameters");
					editTypes.push("DAQ Metrics");
				}
			} //end reader menu
			if(type == ARTDAQConfigurationAPI.NODE_TYPE_ROUTER)
			{
				if(!menuDepth)
				{
					editTypes.push("Routing Policy Parameters");
					editTypes.push("DAQ Metrics");
				}
			} //end router menu
			else if(type == ARTDAQConfigurationAPI.NODE_TYPE_BUILDER ||
					type == ARTDAQConfigurationAPI.NODE_TYPE_LOGGER ||
					type == ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER )
			{
				if(!menuDepth)
				{			
					editTypes.push("Preamble Parameters");
					editTypes.push("DAQ Settings");
					depthTypes[editTypes.length-1] = 1;
					editTypes.push("ART Settings");
					depthTypes[editTypes.length-1] = 2;	
					editTypes.push("Add-on Parameters");	
				}
				else if(menuDepth == 1 && menuDepthType == 1 /*DAQ Settings*/)
				{
					editTypes.push("DAQ Parameters");
					editTypes.push("DAQ Metrics");						
				}
				else if(menuDepth == 1 && menuDepthType == 2 /*ART Settings*/)
				{
					editTypes.push("ART Physics Analyzers");
					editTypes.push("ART Physics Producers");
					editTypes.push("ART Physics Filters");	
					editTypes.push("ART Physics Other Parameters");						
				}
			} //end builder, logger, dispatcher menu
			
			var menuItems = [];
			var menuItemHandlers = [];
			
			if(!menuDepth) //at 0 depth, all types edit the node
			{
				menuItems.push("Edit <b><u>Node</u></b> (i.e. name, subsystem, host, instances)");
				menuItemHandlers.push("launchEditNodeDialog(" + i + ")");
			}
			
			var nodeName = _nodes[i].name;
			if(subi !== undefined) //dealing with a particular multi-node node
				nodeName = getMultiNodeName(i,subi);
			
			//block configuration menu items if nodes have not been changed
			for(var t=0;!_nodesHaveChanged && t<editTypes.length;++t)
			{
				menuItems.push("Edit <b><u>" + editTypes[t] +
						"</u></b> of " + typeName + "::" + 
						nodeName);
				if(depthTypes[t] !== undefined) //go to next depth menu
					menuItemHandlers.push("handleEditIconMouseUp(" +
							i + ", undefined /*e*/, " +
							(e.pageX - 10) + " /*x*/," +
							j + " /*subi*/," +
							((menuDepth|0)+1) + "," +
							depthTypes[t] + " /*menuDepthType*/" +
							")");
				else //final menu depth (choose window type)
					menuItemHandlers.push("handleEditIconMenuSelection(" +
						i + "," + (menuDepth?menuDepthType:t) + 
						", undefined /*newTab*/, " +
						x + ", " +
						"\"" + editTypes[t]  + "\"," +
						subi + " /*subi*/," +
						(menuDepth|0) + "," +
						(menuDepth?t:0) + " /*menuDepthType*/" +
						")");
			} //end edit type loop
						
			SimpleContextMenu.createMenu(
					menuItems,
					menuItemHandlers,
					"simpleContextMenuPopup",		//element ID
					x,
					y, 		//top left position
					_MENU_PRIMARY_COLOR,
					_MENU_SECONDARY_COLOR,
					true /*defaultHighlighting*/
			);			
			
		} // end handleEditIconMouseUp()

		//=====================================================================================
		//handleEditIconMenuSelection ~~
		//	handle menu selection for node i
		//	based on editType
		//	subi used to index multi-node
		function handleEditIconMenuSelection(i,editType, newTab, 
				x, editTypeString, subi, menuDepth, menuDepthType) 
		{	   
			
			Debug.log("handleEditIconMenuSelection " + i + 
					"[" + subi + "] - d" + menuDepth + ":" + menuDepthType + " " + 
					editType + "-" + newTab);
			
			var type = _nodes[i].type;			
			var typeName = ARTDAQConfigurationAPI.getShortTypeName(type);			
			var typeBaseTable = ARTDAQConfigurationAPI.NODE_TYPE_BASE_TABLE[type]; //use above call for type safety

			var subsetName = editTypeString;
			

			if(!x) x = event.pageX - 10;
			var y = event.pageY - 10; //always follow mouse -- otherwise menu may become impossible to navigate
			
			if(editType>5) y -= 50;
			
			var nodeName = _nodes[i].name;
			if(subi !== undefined) //dealing with a particular multi-node node
				nodeName = getMultiNodeName(i,subi);

			if(newTab === undefined)
			{
				//create menu to choose new tab or not
				var menuItems = [];
				var menuItemHandlers = [];

				menuItems.push( "Edit <b><u>" + subsetName +
						"</u></b> of " + typeName + "::" + 
						nodeName);
				menuItemHandlers.push("handleEditIconMenuSelection(" +
						i + "," + editType + ", false /*newTab*/,"+
						x + ", " +
						"\"" + editTypeString  + "\"," +
						subi + " /*subi*/," +
						(menuDepth|0) + "," +
						(menuDepthType|0) +
						")");
				menuItems.push( "Edit <b><u>" + subsetName +
						"</u></b> of " + typeName + "::" + 
						nodeName + 
						" in a <label style='color:rgb(251, 128, 67);font-weight:bold;'>new browser tab</font>");
				menuItemHandlers.push("handleEditIconMenuSelection(" +
						i + "," + editType + ", true /*newTab*/,"+
						x + ", " +
						"\"" + editTypeString  + "\"," +
						subi + " /*subi*/," +
						(menuDepth|0) + "," +
						(menuDepthType|0) +
						")");


				SimpleContextMenu.createMenu(
						menuItems,
						menuItemHandlers,
						"simpleContextMenuPopup",		//element ID
						x, y, 		//same menu position
						_MENU_PRIMARY_COLOR,
						_MENU_SECONDARY_COLOR,
						true /*defaultHighlighting*/
				);			
				return;
			}
			
			var newWindowStr;
			
			if(!menuDepth && editType == 0)
			{	
				//top-level parameters
				
				newWindowStr = "/WebPath/html/ConfigurationGUI_subset.html?urn=" +
					DesktopContent._localUrnLid +
					"&subsetBasePath=" + typeBaseTable +
					"&groupingFieldList=AUTO" +
					"&recordAlias=" + typeName + "s" +
					"&editableFieldList=" + "!*CommentDescription";
				
				//for unique link, presect UID record							
				newWindowStr += "&selectedRecords=" + nodeName;
				
				localLaunchWindow();
			}
			else //use do map to decide what to do based on type, menuDepth, and editType
			{
				var doMap = {};
				var d;
				var dt;
				
				//------------ start fill READER do map		
				d = 0; //depth 0 //----------------
				dt = 0; 
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_READER] = {}; //depth level
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_READER][d] = {} //menu depth
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_READER][d][dt++] = [{ //at 0 depth, always 0 menu depth type
					"table" : 		ARTDAQConfigurationAPI.DAQ_PARAMETER_TABLE,
					"groupLink"	: 	"daqParametersLink"
				}]; //Reader DAQ parameters
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_READER][d][dt++] = [{ //at 0 depth, always 0 menu depth type
					"table" : 		ARTDAQConfigurationAPI.DAQ_METRIC_TABLE,
					"groupLink"	: 	"daqMetricsLink"
				}]; //Reader DAQ metrics
				//------------ end fill READER do map
				
				//------------ start fill ROUTER do map		
				d = 0; //depth 0 //----------------
				dt = 0; 		
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_ROUTER] = {}; //depth level
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_ROUTER][d] = {} //menu depth
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_ROUTER][d][dt++] = [{ //at 0 depth, always 0 menu depth type
					"table" : 		ARTDAQConfigurationAPI.DAQ_PARAMETER_TABLE,
					"groupLink"	: 	"routingPolicyParametersLink"
				}]; //Routing Policy parameters
				doMap[ARTDAQConfigurationAPI.NODE_TYPE_ROUTER][d][dt++] = [{ //at 0 depth, always 0 menu depth type
					"table" : 		ARTDAQConfigurationAPI.DAQ_METRIC_TABLE,
					"groupLink"	: 	"daqMetricsLink"
				}]; //Reader DAQ metrics
				//------------ end fill ROUTER do map

				//------------ start fill BUILDER,LOGGER,DISPATCHER do map
				var equivalentTypes = [ARTDAQConfigurationAPI.NODE_TYPE_BUILDER,
									   ARTDAQConfigurationAPI.NODE_TYPE_LOGGER,
									   ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER];
				for(var t=0;t<equivalentTypes.length;++t)
				{
					doMap[equivalentTypes[t]] = {};
					
					d = 0; //depth 0 //----------------
					doMap[equivalentTypes[t]][d] = {}; //menu depth
					dt = 0; //Preamble Parameters depth 0 ----------------
					doMap[equivalentTypes[t]][d][dt] = [{ //at 0 depth, always 0 menu depth type					
						"table" : 		ARTDAQConfigurationAPI.DAQ_PARAMETER_TABLE,
						"groupLink"	: 	"preambleParametersLink"
					}]; //Preamble Parameters
					dt = 3; //AddOn Parameters depth 0 ----------------
					doMap[equivalentTypes[t]][d][dt] = [{ //at 0 depth, always 0 menu depth type
						"table" : 		ARTDAQConfigurationAPI.DAQ_PARAMETER_TABLE,
						"groupLink"	: 	"addOnParametersLink"
					}]; //Add-on Parameters
					
					d = 1; //depth 1 //----------------
					doMap[equivalentTypes[t]][d] = {}; //menu depth
					dt = 1; //DAQ depth type //----------------
					doMap[equivalentTypes[t]][d][dt] = []; //menu depth type
					doMap[equivalentTypes[t]][d][dt].push({
						"table" : 		ARTDAQConfigurationAPI.DAQ_PARAMETER_TABLE,
						"groupLink"	: 	"daqLink/daqParametersLink"
					}); //DAQ Parameters
					doMap[equivalentTypes[t]][d][dt].push({
						"table" : 		ARTDAQConfigurationAPI.DAQ_METRIC_TABLE,
						"groupLink"	: 	"daqLink/daqMetricsLink"
					}); //DAQ Metrics 				
					dt = 2; //ART depth type //----------------
					doMap[equivalentTypes[t]][d][dt] = []; //menu depth type
					doMap[equivalentTypes[t]][d][dt].push({
						"table" : 		"ARTDAQPhysicsAnalyzerTable",
						"groupLink"	: 	"artLink/physicsLink/analyzersLink"
					}); //ART Physics Analyzers
					doMap[equivalentTypes[t]][d][dt].push({
						"table" : 		"ARTDAQPhysicsProducerTable",
						"groupLink"	: 	"artLink/physicsLink/producersLink"
					}); //ART Physics Producers
					doMap[equivalentTypes[t]][d][dt].push({
						"table" : 		"ARTDAQPhysicsFilterTable",
						"groupLink"	: 	"artLink/physicsLink/filtersLink"
					}); //ART Physics Filters
					doMap[equivalentTypes[t]][d][dt].push({
						"table" : 		"ARTDAQPhysicsParameterTable",
						"groupLink"	: 	"physicsOtherParametersLink"
					}); //ART Physics Other Parameters
				}
				//------------ end fill BUILDER,LOGGER,DISPATCHER do map

				try
				{
					var table;
					var groupLink;
					
					if(!menuDepth)
						--editType; //because first one is always 'Top-level Parameters'
					
					console.log("type",type,"menuDepth",menuDepth);
					console.log("editType",editType,"menuDepthType",menuDepthType);
					
					//for menuDepth=0, menuDepthType always is 0 (i.e. editType selects)
					table = doMap[type][menuDepth|0][editType][menuDepthType|0].table;
					groupLink = doMap[type][menuDepth|0][editType][menuDepthType|0].groupLink;						
										
					console.log("type",type,"editType",editType,
							"table",table,"groupLink",groupLink);
					
					newWindowStr = "/WebPath/html/ConfigurationGUI_subset.html?urn=" +
							DesktopContent._localUrnLid +
							"&subsetBasePath=" + 
							table +
							"&groupingFieldList=AUTO" +
							"&recordAlias=" + encodeURIComponent(typeName + " " + 
									subsetName) +
									"&editableFieldList=" + "!*CommentDescription";

					//kill configuration change checking during (possibly long) saving time
					//	checking will return when a successful save occurs and initArtdaqNodes() is called!
					if(_checkActiveGroupsTimer)
					{
						window.clearTimeout(_checkActiveGroupsTimer);
						_checkActiveGroupsTimer = 0;
					}

					//Get or make link ID
					
					var uniqueLinks = groupLink.split('/');
					var uniqueLinkDoneCount = 0;
					var uniqueLinkPath = "";
					var u = 0;
					
					localRecursiveUniqueLinkCheck();
					
					return;
					

					//===============
					function localRecursiveUniqueLinkCheck()
					{
						if(u == uniqueLinks.length-1)
						{
							Debug.log("Done checking unique links!");

							//so finish last one
							localHandleLastLinkId();
							return;
						}
					
						uniqueLinkPath += (u?"/":"") + uniqueLinks[u];
						Debug.log("Checking unique link: " + uniqueLinkPath);
												
						localGetLinkId(uniqueLinkPath,
								function(childLinkIndex, linkId)
								{
							Debug.log("Completed check of " + uniqueLinkPath + 
									" childLinkIndex = '" +
									childLinkIndex + "' linkId = '" + 
									linkId + "'");
							
							++u;
							localRecursiveUniqueLinkCheck();
							
								}); //end localGetLinkId handler						
					} //end localRecursiveUniqueLinkCheck()
					
					//===============
					function localHandleLastLinkId()
					{
						Debug.log("localHandleLastLinkId()");
						
						localGetLinkId(groupLink,
								function(childLinkIndex, linkId)
								{
							Debug.log(groupLink + 
									" childLinkIndex = '" +
									childLinkIndex + "' linkId = '" + 
									linkId + "'");
							
							var childLinkIndexArr = childLinkIndex.split(' ');
							if(childLinkIndexArr.length > 1) //if there are multiple indices, choose second one as destination child index
								childLinkIndex = childLinkIndexArr[1];

							//for group link, pre-select GroupID value							
							newWindowStr += "&selectedGroupIDs=" +
									encodeURIComponent(
											childLinkIndex + "=" +
											linkId);

							localLaunchWindow();
							
							//return configuration change check
							if(_checkActiveGroupsTimer)
								window.clearTimeout(_checkActiveGroupsTimer);
							_checkActiveGroupsTimer = window.setTimeout(checkForActiveGroupChange,_CHECK_ACTIVE_GROUPS_PERIOD);


								}); //end localGetLinkId handler
						
					} //end localHandleLastLinkId()
					
				}
				catch(err)
				{
					Debug.log("Unknown impossible error (notify admins)" + 
							" type=" + type +
							" menuDepth=" + menuDepth +
							" editType=" + editType +
							" menuDepthType=" + menuDepthType +
							" @ [Line " + 
							DesktopContent.getExceptionLineNumber(err) + "]: " + err, Debug.HIGH_PRIORITY);
					
					//return configuration change check
					if(_checkActiveGroupsTimer)
						window.clearTimeout(_checkActiveGroupsTimer);
					_checkActiveGroupsTimer = window.setTimeout(checkForActiveGroupChange,_CHECK_ACTIVE_GROUPS_PERIOD);
				}
			}
//			else
//			{
//				Debug.log("Unknown impossible (notify admins) editType = " +
//						editType, Debug.HIGH_PRIORITY);
//			}

			return;
			
			//===============
			function localLaunchWindow(fieldPath, handler)
			{
				Debug.log("newWindowStr " + newWindowStr);
				if(newTab)
					DesktopContent.openNewBrowserTab(
						typeName + " " + subsetName,
						"",
						newWindowStr, false /*unique*/);
				else
					DesktopContent.openNewWindow(
						typeName + " " + subsetName,
						"",
						newWindowStr, false /*unique*/);
			} //end localLaunchWindow()
						

			//===============
			function localGetLinkId(fieldPath, handler)
			{
				Debug.log("localGetLinkId");
				
				//ConfigurationAPI.getFieldsOfRecords(
				//	subsetBasePath,recordArr,fieldList,
				//		maxDepth,responseHandler,modifiedTables)
				ConfigurationAPI.getFieldsOfRecords(
						typeBaseTable,
						nodeName,
						fieldPath,
						5,
						function(fieldRetObj)
						{
					console.log("localGetLinkId getFieldsOfRecords",fieldRetObj);

					if(!fieldRetObj || !fieldRetObj.length ||
							fieldRetObj[0].fieldColumnType.indexOf("ChildLink-") != 0 ||
							fieldRetObj.length != 2)
					{
						Debug.log("Invalid " + typeName + " link to get '" + fieldPath +
								"' - notify admins! (returned field objects = " +
								fieldRetObj.length + ")", Debug.HIGH_PRIORITY);
						return;
					}
					

					//ConfigurationAPI.getFieldValuesForRecords(
					//	subsetBasePath,recordArr,fieldObjArr,
					//	responseHandler,modifiedTables)
					ConfigurationAPI.getFieldValuesForRecords(
							typeBaseTable,
							nodeName,
							fieldRetObj,
							//fieldRetObj[1].fieldRelativePath + 
							//fieldRetObj[1].fieldColumnName,
							function(retObj)
							{
						console.log("localGetLinkId getFieldValuesForRecords",retObj);
						
						
						//check if no link, and prompt user to make one
						if(retObj.length != 2 ||
								retObj[0].fieldValue == "NO_LINK" ||
								retObj[1].fieldValue == "DEFAULT")
						{
							//remake field path with spaces so it displays better in
							//	popup dialog
							var fieldPathArr = fieldPath.split('/');
							fieldPath = "";
							for(var f=0;f<fieldPathArr.length;++f)
								fieldPath += (f?" / ":"") + fieldPathArr[f];
							
							if(fieldRetObj[0].fieldColumnDataChoicesArr &&
									fieldRetObj[0].fieldColumnDataChoicesArr.length > 2)							
								DesktopContent.popUpVerification(
									"A valid link to <b>" + fieldPath +
									"</b> has not been defined for <b>" +
									typeName + "::" +
									nodeName +
									"</b>, do you want to <u><b>create</b></u> it now?",
									localCreateLink /*yes-to-reload handler*/,
									0,0,0,0,0, //val, bgColor, textColor, borderColor, getUserInput, 
									300 /*dialogWidth*/);
							else
								Debug.log("The link to '" + fieldPath +
										"' has not been defined, and no default destination table was found. " +
										"Please manually define the link and try again.",
										Debug.HIGH_PRIORITY);
							
							return;
							
							//===============
							function localCreateLink()
							{
								var valueArr = [];
								
								valueArr.push(fieldRetObj[0].fieldColumnDataChoicesArr[
									fieldRetObj[0].fieldColumnDataChoicesArr.length-1]);
								
								var isUniqueLink = false;
								
								if(fieldRetObj[1].fieldColumnType.indexOf("ChildLinkUID-") >= 0)
								{
									//modify fieldPath into link record name
									fieldPath = uniqueLinks[u].substr(0,
											uniqueLinks[u].indexOf("Link"));
									if(fieldPath.length > 1 && 
											fieldPath[0] >= 'a' && fieldPath[0] <= 'z') //capitalize
										fieldPath = String.fromCharCode(fieldPath.charCodeAt(0)-32) + 
											fieldPath.substr(1);
									valueArr.push(nodeName + fieldPath + "Record");

									Debug.log("Creating unique link " +
											typeBaseTable + "/" +
											uniqueLinkPath +
											" for '" +
											nodeName + 
											"' to " + 
											valueArr[0] + ":" + valueArr[1]);
									isUniqueLink = true;
								} //end unique link value handling
								else //else is a group link
								{
									//modify fieldPath into link groupID
									fieldPath = fieldPath.substr(0,fieldPath.indexOf("Link"));
									if(fieldPath.length > 1 && 
											fieldPath[0] >= 'a' && fieldPath[0] <= 'z') //capitalize
										fieldPath = String.fromCharCode(fieldPath.charCodeAt(0)-32) + fieldPath.substr(1);
									valueArr.push(nodeName + fieldPath + "Group");
									
									Debug.log("localCreateLink() " + typeBaseTable + "/" + 
											fieldPath +
											" for '" +
											nodeName + 
											"' to " + 
											valueArr[0] + ":" + valueArr[1]);
								} //end group link value handling

								//now values are defined for group or unique link
								//	so set the values
								ConfigurationAPI.setFieldValuesForRecords(
										typeBaseTable,
										nodeName, 	//recordArr
										fieldRetObj, 	//fieldArr of size 2
										valueArr, 	//valueArr of size 2
										/////////////////////
										function(modifiedTables)
										{
									Debug.log("modifiedTables length " + modifiedTables.length);

									if(!modifiedTables.length)
									{
										Debug.log("There was an error while writing the values.",
												Debug.HIGH_PRIORITY);
										return;					
									}

									_modifiedTables = modifiedTables;
									
									//add link target table if not in modified tables
									var found = false;
									var tablesToAdd = []
									for(var t=0;t<_modifiedTables.length;++t)
										if(_modifiedTables[t].tableName == valueArr[0])
										{
											found = true;
											break;
										}
									if(!found)
									{
										tablesToAdd.push({											
											"tableName": 	valueArr[0],
											"tableVersion": "-1" //mockup
											});
									}
									
									//proceed to save (quietly) tables, groups, aliases
									ConfigurationAPI.saveModifiedTables(_modifiedTables,
											/////////////////////
											function(savedTables, savedGroups, savedAliases)
											{
										if(!savedTables.length)
										{
											Debug.log("There was an error while saving the values.",
													Debug.HIGH_PRIORITY);
											return;					
										}

										Debug.log("The link to <b>" + valueArr[0] + "/" +
												valueArr[1] +
												"</b> for <b>" +
												typeName + "::" +
												nodeName +
												"</b> has been successfully created!",
												Debug.INFO_PRIORITY);

										_modifiedTables = undefined; //clear after save

										if(!isUniqueLink)
										{
											// DONE! (for group links) ------------------------------------------
											initArtdaqNodes(//pass done handler to initArtdaqNodes()
													//////////////////
													function()
													{
												Debug.log("initArtdaqNodes group link done handler");

												//continue recursion, parameters actually do not matter
												handler( //localGetLinkId's handler calls localRecursiveUniqueLinkCheck()
														valueArr[0], 
														valueArr[1]);

													} //end initArtdaqNodes done handler
											); //re-init and get new active configuration
											// end DONE! (for group links) ------------------------------------------
										}
										else //is unique link, so continue to create record
										{
											ConfigurationAPI.addSubsetRecords(
													valueArr[0], //table path
													valueArr[1], //record UID
													/////////////////////
													function(modifiedTables) //start addSubsetRecords handler
													{
												Debug.log("modifiedTables length " + modifiedTables.length);

												if(!modifiedTables.length)
												{
													Debug.log("There was an error while creating the record. Attempting to proceed anyway...",
															Debug.HIGH_PRIORITY);
													// DONE! (for unique links with error, hoping the record already exists) ------------------------------------------
													initArtdaqNodes( //pass done handler to initArtdaqNodes()
															//////////////////
															function()
															{
														Debug.log("initArtdaqNodes unique link done with error handler");

														//continue recursion, parameters actually do not matter
														handler( //localGetLinkId's handler calls localRecursiveUniqueLinkCheck()
																valueArr[0], 
																valueArr[1]);

															} //end initArtdaqNodes done handler															
													); //re-init and get new active configuration
													// end DONE! (for unique links) ------------------------------------------
													
													return;					
												}

												_modifiedTables = modifiedTables;
												
												//proceed to save (quietly) tables, groups, aliases
												ConfigurationAPI.saveModifiedTables(_modifiedTables,
														/////////////////////
														function(savedTables, savedGroups, savedAliases)
														{
													if(!savedTables.length)
													{
														Debug.log("There was an error while saving the values.",
																Debug.HIGH_PRIORITY);
														return;					
													}
													Debug.log("The unique record <b>" + valueArr[0] + "/" +
															valueArr[1] +
															"</b> for <b>" +
															typeName + "::" +
															nodeName +
															"</b> has been successfully created!",
															Debug.INFO_PRIORITY);

													_modifiedTables = undefined; //clear after save
													
													// DONE! (for unique links) ------------------------------------------
													initArtdaqNodes( //pass done handler to initArtdaqNodes()
															//////////////////
															function()
															{
														Debug.log("initArtdaqNodes unique link done handler");
																												
														//continue recursion, parameters actually do not matter
														handler( //localGetLinkId's handler calls localRecursiveUniqueLinkCheck()
																valueArr[0], 
																valueArr[1]);

															} //end initArtdaqNodes done handler															
													); //re-init and get new active configuration
													// end DONE! (for unique links) ------------------------------------------
													
														}); //end saveModifiedTables handler
												
													}, //end addSubsetRecords handler
													_modifiedTables);
										} //end unique link record creation
										
											}, //end saveModifiedTables handler
											0,0, //doNotIgnoreWarnings,doNotSaveAffectedGroups,
											0,0, //doNotActivateAffectedGroups,doNotSaveAliases,
											0, //doNotIgnoreGroupActivationWarnings,
											0, //doNotKillPopUpEl, 
											tablesToAdd); //end saveModifiedTables() call 

										}, //end setFieldValuesForRecords handler
										_modifiedTables);	
								
							} //end localCreateLink()
						} //end missing link handling
						
						//pass link index and link ID to handler
						handler(
								fieldRetObj[1].fieldColumnType.split('-')[1], 
								retObj[1].fieldValue);

							}, //end getFieldValuesForRecords handler
							0, //modifiedTables
							true //silenceErrors
							); //end ConfigurationAPI.getFieldValuesForRecords() call
					
						}); //end ConfigurationAPI.getFieldsOfRecords() call
				
			} //end localGetLinkId()
			
			
		} // end handleEditIconMenuSelection()

		//=====================================================================================
		//launchEditNodeDialog ~~
		function launchEditNodeDialog(i) 
		{	   
			Debug.log("launchEditNodeDialog node size " + _nodes[i].nodeCount);

			var type = _nodes[i].type;
			var typeName = ARTDAQConfigurationAPI.NODE_SHORT_TYPE_NAMES[type];
					
			//undo hover node
			doNodeHover(_mouseHoverNode,true /*undoHover*/);

			_mouseMoveMode = _MMM_POPUP_DIALOG;
			
			var ctrlStr = "";
			ctrlStr += htmlOpen("input",
					{
							"class": "closeButton",
							"type": "button",
							"style": "margin:20px;",
							"value": "Close",
							"title": "Close this dialog."
					},
					0 /*html*/, true /*closeTag*/);	

			var str = "";
			
			str += "You are editing the node originally named <b>" + 
					typeName + "::" + _nodes[i].name + "</b>..."; 
					
			var isMultiNode = _nodes[i].name.indexOf('*') >= 0;
			var isNodeNameFixedWidth = _nodes[i].nodeNameFixedWidth && _nodes[i].nodeNameFixedWidth > 1;
			var isHostnameArray = _nodes[i].hostname.indexOf('*') >= 0;			
			var isHostnameFixedWidth = _nodes[i].hostnameFixedWidth && _nodes[i].hostnameFixedWidth > 1;

			str += htmlClearDiv();
			
			str += "<br><center><table class='editNodeDialog-table'>";
			
			//======== Subsystem Field
			str += "<tr><td class='editNodeDialog-fieldCol'><b>Subsystem Name:</b></td><td class='editNodeDialog-valueCol'>";
			{ //start subsystems
				str += htmlOpen("select",
						{
								"id": "ediNode-" + "subsystem",
								"style": "float:left; margin:7px; width:187px;",
						});

				for(var j in _subsystems)
				{
					if(j == 0) continue; //skip null destination subsystem

					str += "<option " + 	
							(j == _nodes[i].subsystemId?"selected":"") + ">" +
							_subsystems[j].label + 
							"</option>";
				}
				str += "</select>"; //end aliases dropdown

				str += htmlOpen("input",
						{
								"id": "ediNode-" + "subsystemText",
								"type": "text",
								"style": "display:none; float:left; width:180px;",
								"value": "",
								"title": "Set the subsystem for this node.",
						},
						0 /*html*/, true /*closeTag*/);	

				str += htmlOpen("div",
						{
								"id": "subsystem-editIcon",
								"class": "node-editIcon",
								"style": "display:block; float:right; margin: 6px -30px 0 1px",
								"onclick": "handleEditNodeSelectEditIcon(0);",
								"title": "Toggle free-form hostname editing",
						},
						0 /*html*/, true /*closeTag*/);	
			} //end subsystems
			str += "</td></tr>";
			//======== end Subsystem Field

			//======== Other Node Names Field
			str += "<tr><td class='editNodeDialog-fieldCol'><b>Other Node Names:</b></td><td class='editNodeDialog-valueCol'>";												
			str += htmlOpen("select",
					{
							"id": "ediNode-" + "otherNodeNames",
							"style": "float:left; margin:7px; width:187px; background-color: rgb(183, 178, 178);",
							"title": "This is a read-only field showing all other node names in the system; it is provided for reference while editing this node.",
					});

			for(var j=0;j<_nodes.length;++j)
			{
				if(j == i) continue; //skip this node

				str += "<option >" +
						_nodes[j].name + 
						"</option>";
			}
			str += "</select>"; //end other node names dropdown
			str += "</td></tr>";
			//======== end Other Node Names Field

			//======== Node Name Field
			str += "<tr><td class='editNodeDialog-fieldCol'><b>Node Name:</b></td><td class='editNodeDialog-valueCol'>";						
			str += htmlOpen("input",
					{
							"id": "ediNode-" + "nodeName",
							"type": "text",
							"style": "width:180px;",
							"value": _nodes[i].name,
							"title": "Set the node name template with * syntax.",
					},
					0 /*html*/, true /*closeTag*/);	
			str += "</td></tr>";
			
			str += "<tr><td colspan='2' style='text-align:right'>";

			str += htmlOpen("input",
					{
							"type": "checkbox",
							"id": "enableMultiNodeCheckbox",
							"class": "enableMultiNodeCheckbox",
							"checked": (isMultiNode?1:0),
							"onclick": "handleEditNodeDialogMultiNodeCheckbox(" + i + ",this);",
							"title": "Enable multi-node instances using printer syntax.",
					},
					htmlOpen("a",
							{
									"style": "text-decoration:none;color:black;",
									"onclick": "var el = document.getElementsByClassName(\"enableMultiNodeCheckbox\");" +
									"var forFirefox = (el[0].checked = !el[0].checked); " +
									"handleEditNodeDialogMultiNodeCheckbox(" + i + ",el[0]);"
									,
									"title": "Enable multi-node instances using printer syntax.",
							},
							"<b>Enable Multi-node Instances</b>" /*innerHTML*/,
							true /*doCloseTag*/
					) /*innerHTML*/,
					true /*doCloseTag*/);
			str += "<div style='margin:-5px -28px -30px 0; float:right;'><a onclick='var el = document.getElementsByClassName(\"enableMultiNodeCheckbox\");" +
					"handleEditNodeDialogMultiNodeCheckbox(" + i + ",el[0],1);' " +
					"title='Click for more information on editing multi-node instances.'>" +
					"<img src='/WebPath/images/dashboardImages/icon-Help.png'></a></div>";
			str += "</td></tr>";
			//======== end Node Name Field
			str += "</table>";

			str += htmlClearDiv();
			
			//======== Multi Node Settings
			str += "<div id='multiNodeSettings' style='display:" + 
				(isMultiNode?"block":"none") + "'>";
			{ //start multi-node
				str += "For Multi-Node Instances, use 'printer page syntax' (e.g. '0,4-6'), and * in the Node Name..."
						
				str += htmlClearDiv();
				str += "<br><table class='editNodeDialog-table'>";
						
				//======== Multi Node Settings
				str += "<tr><td class='editNodeDialog-fieldCol'><b>Multi-Node Indices:</b></td><td class='editNodeDialog-valueCol'>";
										
				str += htmlOpen("input",
						{
								"id": "ediNode-" + "nodeIndices",
								"type": "text",
								"value": (_nodes[i].nodeVectorIndexString?_nodes[i].nodeVectorIndexString:""),
								"title": "Set the multi-node indices with printer page syntax.",
						},
						0 /*html*/, true /*closeTag*/);	
				str += "</td></tr>";

				str += "<tr><td colspan='2' style='text-align:right'>";

				//checkbox for node name fixed width settings
				str += htmlOpen("input",
						{
								"type": "checkbox",
								"id": "enableNodeNameFixedWidthCheckbox",
								"class": "enableNodeNameFixedWidthCheckbox",
								"checked": (isNodeNameFixedWidth?1:0),
								"onclick": "handleEditNodeDialogNodeNameFixedWidthCheckbox(" + i + ",this);",
						},
						htmlOpen("a",
								{
										"style": "text-decoration:none;color:black;",
										"onclick": "var el = document.getElementsByClassName(\"enableNodeNameFixedWidthCheckbox\");" +
										"var forFirefox = (el[0].checked = !el[0].checked); " +
										"handleEditNodeDialogNodeNameFixedWidthCheckbox(" + i + ",el[0]);"
										,
								},
								"<b>Enable Fixed-Width Node Names</b>" /*innerHTML*/,
								true /*doCloseTag*/
						) /*innerHTML*/,
						true /*doCloseTag*/);
				str += "</td></tr>";
				str += "</table>";

				str += htmlClearDiv();
				str += "<div id='nodeNameFixedWidthSettings' style='display:" + 
						(isNodeNameFixedWidth?"block":"none") + "'>";
				{ //start node name fixed-width
					str += "<br>Force the number of digits to a fixed-width within" +
							" each Node Name (e.g. 3 would yield numbers like 001, 002, etc.)." +
							"<br>";

					str += htmlClearDiv();
					str += "<br><table class='editNodeDialog-table'>";
					str += "<tr><td class='editNodeDialog-fieldCol'><b>Node Name Fixed-width:</b></td><td class='editNodeDialog-valueCol'>";										
					str += htmlOpen("input",
							{
									"id": "ediNode-" + "nodeNameFixedWidth",
									"type": "text",
									"style": "width:50px;",
									"value": (_nodes[i].nodeNameFixedWidth !== undefined?
											_nodes[i].nodeNameFixedWidth:2),
									"title": "Set the number of digits for fixed-width numbering in the Node Name.",
							},
							0 /*html*/, true /*closeTag*/);	
					str += "</td></tr>";

					str += "</table>";
				} //end node name fixed width settings
				str += "</div>"; //close nodeName Fixed Width Settings
				
				str += htmlClearDiv();
				str += "<br><table class='editNodeDialog-table'>";
				str += "<tr><td style='text-align:right; white-space:nowrap;'>";										

				str += htmlOpen("input",
						{
								"type": "checkbox",
								"id": "enableHostnameArrayCheckbox",
								"class": "enableHostnameArrayCheckbox",
								"checked": (isHostnameArray?1:0),
								"onclick": "handleEditNodeDialogHostnameArrayCheckbox(" + i + ",this);",
								"title": "Enable associating the nodes with an array of hostnames.",
						},
						htmlOpen("a",
								{
										"style": "text-decoration:none;color:black;",
										"onclick": "var el = document.getElementsByClassName(\"enableHostnameArrayCheckbox\");" +
										"var forFirefox = (el[0].checked = !el[0].checked); " +
										"handleEditNodeDialogHostnameArrayCheckbox(" + i + ",el[0]);"
										,
										"title": "Enable associating the nodes with an array of hostnames.",
								},
								"<b>Associate Multi-node Instances with Array of Hostnames</b>" /*innerHTML*/,
								true /*doCloseTag*/
						) /*innerHTML*/,
						true /*doCloseTag*/);
				str += "</td></tr>";
				str += "</table>";
				
			} //end multi-node
			str += "</div>"; //close multi-node settings div
			
			str += htmlClearDiv();

			str += "<br><table class='editNodeDialog-table'>";
			str += "<tr><td class='editNodeDialog-fieldCol'><b>Hostname:</b></td><td class='editNodeDialog-valueCol'>";
			{ //start hostnames
				str += htmlOpen("select",
						{
								"id": "ediNode-" + "hostname",
								"style": "float: left; margin: 7px;",
						});

				for(var j in _hostnames)
				{
					str += "<option " + 	
							(j == _nodes[i].hostname?"selected":"") + ">" +
							j + 
							"</option>";					
				}
				str += "</select>"; //end aliases dropdown

				str += htmlOpen("input",
						{
								"id": "ediNode-" + "hostnameText",
								"style": "display:none; float: left;",
								"type": "text",
								"value": "",
								"title": "Set the hostname for this node.",
						},
						0 /*html*/, true /*closeTag*/);	

				str += htmlOpen("div",
						{
								"id": "hostname-editIcon",
								"class": "node-editIcon",
								"style": "display:block; float:right; margin: 6px -30px 0 1px",
								"onclick": "handleEditNodeSelectEditIcon(1);",
								"title": "Toggle free-form hostname editing",
						},
						0 /*html*/, true /*closeTag*/);	

			} //end hostnames
			str += "</td></tr>";
			str += "</table>";

			str += htmlClearDiv();
			
			
			str += "<div id='hostnameArraySettings' style='display:" + 
					(isHostnameArray?"block":"none") + "'>";
			{ //start hostnameArraySettings 
				str += "Use 'printer page syntax' (e.g. '0,4-6'), and * in the Hostname..."

				str += htmlClearDiv();
				str += "<br><table class='editNodeDialog-table'>";

				str += "<tr><td class='editNodeDialog-fieldCol'><b>Hostname Indices:</b></td><td class='editNodeDialog-valueCol'>";
				str += htmlOpen("input",
						{
								"id": "ediNode-" + "hostnameIndices",
								"type": "text",
								"value": (_nodes[i].hostnameVectorIndexString?_nodes[i].hostnameVectorIndexString:""),
								"title": "Set the hostname indices with printer page syntax.",
						},
						0 /*html*/, true /*closeTag*/);	
				str += "</td></tr>";

				str += "<tr><td colspan='2' style='text-align:right; white-space:nowrap;'>";

				str += htmlOpen("input",
						{
								"type": "checkbox",
								"id": "enableHostnameFixedWidthCheckbox",
								"class": "enableHostnameFixedWidthCheckbox",
								"checked": (isHostnameFixedWidth?1:0),
								"onclick": "handleEditNodeDialogHostnameFixedWidthCheckbox(" + i + ",this);",
						},
						htmlOpen("a",
								{
										"style": "text-decoration:none;color:black;",
										"onclick": "var el = document.getElementsByClassName(\"enableHostnameFixedWidthCheckbox\");" +
										"var forFirefox = (el[0].checked = !el[0].checked); " +
										"handleEditNodeDialogHostnameFixedWidthCheckbox(" + i + ",el[0]);"
										,
								},
								"<b>Enable Fixed-Width Hostnames</b>" /*innerHTML*/,
								true /*doCloseTag*/
						) /*innerHTML*/,
						true /*doCloseTag*/);
				str += "</td></tr>";
				str += "</table>";
				
			} //end hostnameArraySettings
			str += "</div>"; //close hostnameArray settings div

			str += htmlClearDiv();
			str += "<div id='hostnameFixedWidthSettings' style='display:" + 
					(isHostnameFixedWidth?"block":"none") + "'>";
			{ //start hostname fixed-width
				str += "<br>Force the number of digits to a fixed-width within" +
						" each hostname (e.g. 3 would yield numbers like 001, 002, etc.)." +
						"<br>";

				str += htmlClearDiv();
				str += "<br><table class='editNodeDialog-table'>";
				str += "<tr><td class='editNodeDialog-fieldCol'><b>Hostname Fixed-width:</b></td><td class='editNodeDialog-valueCol'>";
				str += htmlOpen("input",
						{
								"id": "ediNode-" + "hostnameFixedWidth",
								"type": "text",
								"style": "width:50px;",
								"value": (_nodes[i].hostnameFixedWidth?_nodes[i].hostnameFixedWidth:2),
								"title": "Set the number of digits for fixed-width numbering in the hostname.",
						},
						0 /*html*/, true /*closeTag*/);	
				str += "</td></tr>";

				str += "</table>";
				
			} //end hostname fixed-width
			str += "</div>"; //close hostname fixed-width settings div
			
			

			str += htmlClearDiv();

			
			str += htmlOpen("input",
					{
							"id": "ediNode-" + "saveNode",
							"type": "button",
							"value": "Save Node Settings",
							"title": "Save the settings for this node."
					},
					0 /*html*/, true /*closeTag*/);	
			
			//remove all existing dialogs
			ConfigurationAPI.removeAllPopUps();

			//make popup element
			el = document.createElement("div");			
			el.setAttribute("id", ConfigurationAPI._POP_UP_DIALOG_ID);

			ConfigurationAPI.setPopUpPosition(el,
					undefined /*w*/,
					undefined /*h*/, 
					undefined /*padding*/, 
					undefined /*border*/,
					50 /*margin*/);

			el.innerHTML = ctrlStr + htmlClearDiv() + 
					str + htmlClearDiv(); // + ctrlStr;
			document.body.appendChild(el);

			localAddHandlers();

			return;
			
			//==========
			function localAddHandlers()
			{ //start localAddHandlers			

				var closeButtons = document.getElementsByClassName("closeButton");
				for(var b=0;b<closeButtons.length;++b)
					closeButtons[b].onclick = 
							localCloseButtonHandler;

				document.getElementById("ediNode-" + "saveNode").onclick =
						localOKButtonHandler;
				
				var inputEls = el.getElementsByTagName("input");
				for(var b=0;b<inputEls.length;++b)
					inputEls[b].onkeydown = 
							localInputKeyHandler;
				document.body.addEventListener("keydown",localInputKeyHandler);
				
					
				/////////////////////////////////
				function localCloseButtonHandler()
				{
					Debug.log("localCloseButtonHandler()");
					
					document.body.removeEventListener("keydown",localInputKeyHandler);

					//remove all existing dialogs
					ConfigurationAPI.removeAllPopUps();
					
					_mouseMoveMode = _MMM_NONE;
				} //end localCloseButtonHandler()

				/////////////////////////////////
				function localInputKeyHandler(event)
				{
					//Debug.log("localInputKeyHandler() " +
					//		this.id);

					//enter is OK, and escape is CANCEL
					if(event.keyCode == 13) // ENTER
					{	
						Debug.log("Accepting enter key");
						event.preventDefault();
						event.stopPropagation(); 
						localOKButtonHandler();
					}
					else if(event.keyCode == 27) // ESC
					{	
						Debug.log("Accepting escape key");
						event.preventDefault();
						event.stopPropagation(); 
						localCloseButtonHandler();				
					}
				} //end localInputKeyHandler()
				
				/////////////////////////////////
				function localOKButtonHandler()
				{
					//since multiple, use id to identify
					Debug.log("Saving multi-node settings for node " + i);
					
					document.body.removeEventListener("keydown",localInputKeyHandler);					
					
					var nodeNameTemplate = document.getElementById("ediNode-" + "nodeName").value;
					var nodeNameFixedWidth = document.getElementById("ediNode-" + "nodeNameFixedWidth").value | 0;
					var nodeIndices = document.getElementById("ediNode-" + "nodeIndices").value;					
					var subsystem = document.getElementById("ediNode-" + 
							"subsystem").style.display == "none"?
									document.getElementById("ediNode-" + "subsystemText").value:
									document.getElementById("ediNode-" + "subsystem").value;
					var hostname = document.getElementById("ediNode-" + 
							"hostname").style.display == "none"?
									document.getElementById("ediNode-" + "hostnameText").value:
									document.getElementById("ediNode-" + "hostname").value;
					
					var hostnameIndices = document.getElementById("ediNode-" + "hostnameIndices").value;					
					var hostnameFixedWidth = document.getElementById("ediNode-" + "hostnameFixedWidth").value | 0;					
																
					
					Debug.log("Node name template = " + nodeNameTemplate);
					Debug.log("nodeNameFixedWidth = " + nodeNameFixedWidth);
					
					var el = document.getElementsByClassName("enableMultiNodeCheckbox");
					if(el.length && !el[0].checked) 
						nodeIndices = ""; //clear multi-node string if not checked
					el = document.getElementsByClassName("enableHostnameArrayCheckbox");
					if(el.length && !el[0].checked) 
					{
						//clear hostnameIndices string and hostnameFixedWidth if not checked
						hostnameIndices = ""; 
						hostnameFixedWidth = 0;
					}
					el = document.getElementsByClassName("enableHostnameFixedWidthCheckbox");
					if(el.length && !el[0].checked) 
						hostnameFixedWidth = 0; //clear hostnameFixedWidth if not checked

					Debug.log("Node indices = " + nodeIndices);
					Debug.log("Hostname indices = " + hostnameIndices);
					Debug.log("hostnameFixedWidth = " + hostnameFixedWidth);
					
					if(!handleOptionalNodeParameters(
							_nodes[i],
							nodeNameTemplate,
							nodeIndices,
							nodeNameFixedWidth,
							hostname,
							hostnameIndices,
							hostnameFixedWidth))
						return; //end progress if failed to handle (function should display error message)
					
					//handle subsystem change
					var subsystemId = 0;
					var maxSubsystemId = 0;
					for(var j in _subsystems)
						if(_subsystems[j].label == subsystem)
						{
							subsystemId = j|0;
							break;
						}
						else if((j|0) > maxSubsystemId)
							maxSubsystemId = j|0; //keep max for new subsystem id, if needed
					
					if(subsystemId == 0 && 
							subsystem != ARTDAQConfigurationAPI.NULL_SUBSYSTEM)
					{
						//create new subsystem
						subsystemId = maxSubsystemId + 2;
						Debug.log("Creating subsystem " + 
								subsystemId + ":" + subsystem);
						_subsystems[subsystemId] = {"label" : subsystem};
						console.log("_subsystems",_subsystems);
					}
					
					if(_nodes[i].subsystemId != subsystemId)
					{
						Debug.log("handling subsystem change from " + 
								_nodes[i].subsystemId + ":" + 
								_subsystems[_nodes[i].subsystemId].label +
								" to " +
								_nodes[subsystemId].subsystemId + ":" + 
								_subsystems[subsystemId].label)
														
						_nodes[i].subsystemId = subsystemId;
						
						//subsystem change liekly affects arrows, so update
						initArrows();
					}
					
					console.log("_nodes[i]",_nodes[i]);
					nodesHaveChanged();
					
					//delete element to force new paint
					var nodeid = "node-" + i;
					var el = document.getElementById(nodeid);
					if(el) el.parentNode.removeChild(el);
					
					paint();
					
					//remove all existing dialogs
					ConfigurationAPI.removeAllPopUps();

					_mouseMoveMode = _MMM_NONE;

				} //end localOKButtonHandler()
				
			} //end localAddHandlers()
			
		} // end launchEditNodeDialog()
				
		//=====================================================================================
		//handleEditNodeDialogMultiNodeCheckbox ~~
		function handleEditNodeDialogMultiNodeCheckbox(i,obj,showtooltip) 
		{
			Debug.log("handleEditNodeDialogMultiNodeCheckbox " + i + 
					" - " + obj.checked);
			
				
			document.getElementById("multiNodeSettings").style.display =
					obj.checked?"block":"none";
			
			if(!obj.checked)
			{
				var nodeNameValue = _nodes[i].originalName;
				if(nodeNameValue.indexOf('*') >= 0) //remove all *
					nodeNameValue = nodeNameValue.replace(new RegExp("\\*",'g'), 
													'0');
				document.getElementById("ediNode-" + "nodeName").value = 
						nodeNameValue;	
				return;
			}
			else 
			{
				//enabled, so show tooltip
				DesktopContent.tooltip(showtooltip?"ALWAYS":"Multi-node Editing",
						"This text provides extra details on how to create a multi-node, which is intended to be multiple " +
						"instances of the same type of <i>artdaq</i> node (i.e. reader, builder, logger, etc.). The most common use case "+
						"is repeating the same node configuration across multiple computers." +
						"\n\n" +						
						"To setup a multi-node, first set the size (i.e. the node count) of the multi-node by using <b>printer page syntax</b>" +
						" in the Multi-Node Indices field, and one or many <b>*</b> characters in the Node Name field." +
						"\n\n" + 
						"For example, you can make 4 nodes named as follows:" +
						"\n\n\t <i>reader0_east</i>" +
						"\n\t <i>reader4_east</i>" +
						"\n\t <i>reader5_east</i>" +
						"\n\t <i>reader6_east</i>" + 
						"\n\nTo achieve the above instances, you would set the following field values:" +
						"\n\n<TAB><table><tr><td style='text-align:right'><b>Node Name:</b></td><td><i>reader*_east</i></td></tr>" +
						"<tr><td style='text-align:right'><b>Multi-Node Indices:</b></td><td><i>0,4-6</i></td></tr></table></TAB>" +
						"\n" + 
						"If you want to go a step further and apply a fixed-width naming scheme (e.g. <i>reader006_east</i>), " +
						"check the <b>Enable Fixed-width Node Names</b> checkbox (e.g. to get <i>006</i>, set the fixed-width value to <i>3</i>)." +
						"\n\n" + 
						"Finally, to associate an array of hostnames with your multi-node instances, enable the <b>Associate Multi-node Instances with an Array of Hostnames</b> checkbox." +
						"You can use same <b>printer page syntax</b> and <b>*</b> characters to create an array of hostnames."
				);
			}
			
			//else try to place * for user
			
			var nodeNameValue = _nodes[i].name;
			if(nodeNameValue.indexOf('*') < 0)
			{
				//check for a number in the name to help with default wildcard placement
				//	from back
				for(var j=nodeNameValue.length-1;j >= 0; --j)
				{
					if(nodeNameValue[j] >= '0' && nodeNameValue[j] <= '9')
					{
						//found first number, see if it continues
						var k = j;
						for(j=j-1;j >= 0; --j)
							if(nodeNameValue[j] < '0' || nodeNameValue[j] > '9')
							{
								//done with number, so set value

								nodeNameValue = 
										nodeNameValue.substr(0,j+1) + '*' +
										nodeNameValue.substr(k+1);
								break;
							}
						break;
					}
				}
			}
			if(nodeNameValue.indexOf('*') < 0) //if still no *, add
				nodeNameValue += '*';
			
			document.getElementById("ediNode-" + "nodeName").value = nodeNameValue;
			
		} //end handleEditNodeDialogMultiNodeCheckbox()
				
		//=====================================================================================
		//handleEditNodeDialogHostnameArrayCheckbox ~~
		function handleEditNodeDialogHostnameArrayCheckbox(i,obj) 
		{
			Debug.log("handleEditNodeDialogHostnameArrayCheckbox " + i + 
					" - " + obj.checked);
			
				
			document.getElementById("hostnameArraySettings").style.display =
					obj.checked?"block":"none";	
			
			if(obj.checked) //enabled, so show tooltip			
				DesktopContent.tooltip("Hostname Array Editing Help",
					"It may be the case that you want your multi-node instances to run on different computer; in this case, " +
					"you will want to make use of the hostname array." +
					"\n\n" +
					"For example, to associate 4 nodes named reader0, reader4, reader5, reader6 to 4 hosts named cpu3.fnal.gov, cpu4.fnal.gov, cpu4.fnal.gov, cpu8.fnal.gov... " +
					"You would enter a Node Name of 'reader*', Multi-node Indices of '0,4-6', Hostname of 'cpu*.fnal.gov', and Hostname Indices of '3,4,4,8'..."																	
			);
			
		} //end handleEditNodeDialogHostnameArrayCheckbox()

		//=====================================================================================
		//handleEditNodeDialogHostnameFixedWidthCheckbox
		function handleEditNodeDialogHostnameFixedWidthCheckbox(i,obj) 
		{
			Debug.log("handleEditNodeDialogHostnameFixedWidthCheckbox " + i + 
					" - " + obj.checked);
			
				
			document.getElementById("hostnameFixedWidthSettings").style.display =
					obj.checked?"block":"none";			

			if(obj.checked) //if checked, select text
			{
				var tel = document.getElementById("ediNode-" + "hostnameFixedWidth");
				ConfigurationAPI.setCaretPosition(tel, 0, tel.value.length);
			}
		} //end handleEditNodeDialogHostnameFixedWidthCheckbox()

		//=====================================================================================
		//handleEditNodeDialogNodeNameFixedWidthCheckbox
		function handleEditNodeDialogNodeNameFixedWidthCheckbox(i,obj) 
		{
			Debug.log("handleEditNodeDialogNodeNameFixedWidthCheckbox " + i + 
					" - " + obj.checked);
			
				
			document.getElementById("nodeNameFixedWidthSettings").style.display =
					obj.checked?"block":"none";		
			
			if(obj.checked) //if checked, select text
			{
				var tel = document.getElementById("ediNode-" + "nodeNameFixedWidth");
				ConfigurationAPI.setCaretPosition(tel, 0, tel.value.length);
			}				
			
		} //end handleEditNodeDialogNodeNameFixedWidthCheckbox()
		
		//=====================================================================================
		//handleEditNodeSelectEditIcon ~~
		function handleEditNodeSelectEditIcon(t) 
		{	   
			Debug.log("handleEditNodeSelectEditIcon " + t);
			
			var sel, tel;
			if(t == 0) //toggle subsystem select/text
			{
				sel = document.getElementById("ediNode-" + "subsystem");
				tel = document.getElementById("ediNode-" + "subsystemText");				
			}
			else if(t == 1) //toggle hostname select/text
			{
				sel = document.getElementById("ediNode-" + "hostname");
				tel = document.getElementById("ediNode-" + "hostnameText");
			}

			Debug.log("sel.style.display  " + sel.style.display);
			if (sel.style.display == "none") 
			{
				sel.style.display = "block";
				tel.style.display = "none";
			}
			else 
			{
				sel.style.display = "none";
				tel.style.display = "block";
				if(tel.value == "")
					tel.value = sel.value; //take value from select
				ConfigurationAPI.setCaretPosition(tel, 0, tel.value.length);
			}
		} //end handleEditNodeSelectEditIcon()
						
		//=====================================================================================
		//handleFclIconMouseUp ~~
		function handleFclIconMouseUp(i,e,x,y,subi) 
		{	   
			if(e) e.stopPropagation();
		
			if(!_codeEditorAppId)
			{
				Debug.log("No active Code Editor Supervisor found. Can not open files without a Code Editor Supervisor. " + 
						"Please edit the Context group to include a Code Editor Supervisor and relaunch ots.",
						Debug.HIGH_PRIORITY);
				return;
			}
			

			var type = _nodes[i].type;								
			var typeName = ARTDAQConfigurationAPI.getShortTypeName(type);
			
			if(x == undefined && _nodes[i].nodeCount && _nodes[i].nodeCount > 1)
			{
				Debug.log("Showing multi-node menu");//handle node vector level first
				var menuItems = [];
				var menuItemHandlers = [];

				
				for(var j=0;j<_nodes[i].nodeCount;++j)
				{
					menuItems.push( "Open FHiCL for <b><u>" + typeName + 
						"::" + getMultiNodeName(i,j) +
						"</u></b>");
					menuItemHandlers.push("handleFclIconMouseUp(" +
							i + ", undefined /*e*/, " +
							(e.pageX - 10) + " /*x*/," +
							j + " /*subi*/" +
							")");
				}

				SimpleContextMenu.createMenu(
						menuItems,
						menuItemHandlers,
						"simpleContextMenuPopup",		//element ID
						e.pageX - 10, e.pageY - 10, 		//top left position
						_MENU_PRIMARY_COLOR,
						_MENU_SECONDARY_COLOR,
						true /*defaultHighlighting*/
				);	
				
				return;
			}
			//else handle single node
			
			if(!x) x = event.pageX - 10;
			var y = event.pageY - 10; //always follow mouse -- otherwise menu may become impossible to navigate
			
			Debug.log("mouseup-fcl i = " + i + 
					"[" + subi + "] - " + 
					_nodes[i].name);	

			var nodeName = _nodes[i].name;
			if(subi !== undefined) //dealing with a particular multi-node node
				nodeName = getMultiNodeName(i,subi);
		
			var menuItems = [
							 "Open FHiCL for " + typeName + 
								"::" + nodeName,
							 "Open FHiCL for " + typeName + 
								"::" + nodeName + " in a " +
								"<label style='color:rgb(251, 128, 67);font-weight:bold;'>" +
								"new browser tab</label>"
									 ];
			var menuItemHandlers = [];

			var filename = "/$USER_DATA/ARTDAQConfigurations/" + 
					ARTDAQConfigurationAPI.NODE_TYPES[type] + "-" +
					nodeName + ".fcl";
			console.log("filename",filename);
			

			//Call like this: DesktopContent.openNewBrowserTab(name,subname,windowPath,unique)

			//url should look like this:
			//http://correlator2.fnal.gov:2015/urn:xdaq-application:lid=290/
			//	Verify?code=fa37&requestingWindowId=1001&
			//	windowName=Code%20Editor&windowSubname=&
			//	windowUnique=0&windowPath=/WebPath/html/CodeEditor.html?urn=240&
			//	startFilePrimary=/$USER_DATA/ARTDAQConfigurations/builder-builder1.fcl#0

			var newwindowJS;
			var newWindowStr;
			
			newWindowStr = "/WebPath/html/CodeEditor.html?" +
					"urn=" + _codeEditorAppId +
					"&readOnlyMode=1" +
					"&startFilePrimary=" + filename;
						
			newWindowStr = newWindowStr.replace(/"/g, "\\\"");
			
			Debug.log("newWindowStr = " + newWindowStr);
			
			newwindowJS = "DesktopContent.openNewWindow(" +
					"\"Code Editor\" /*name*/," + 
					"\"\" /*subname*/,\"" +
					newWindowStr + "\"," +
					"false /*unique*/);";
			
			Debug.log("newwindowJS = " + newwindowJS);

			menuItemHandlers.push(newwindowJS);
			
			newwindowJS = "DesktopContent.openNewBrowserTab(" +
					"\"Code Editor\" /*name*/," + 
					"\"\" /*subname*/,\"" +
					newWindowStr + "\"," +
					"false /*unique*/);";

			Debug.log("newwindowJS = " + newwindowJS);

			menuItemHandlers.push(newwindowJS);
//			DesktopContent.openNewBrowserTab(
//					"Code Editor", //must match desktop icon to look up URN (?)
//					"" /*subname*/,
//					newWindowStr /*windowPath*/,
//					0 /*unique*/
//			);
			
			
			
			SimpleContextMenu.createMenu(
					menuItems,
					menuItemHandlers,
					"simpleContextMenuPopup",		//element ID
					x, y, 		//top left position
					_MENU_PRIMARY_COLOR,
					_MENU_SECONDARY_COLOR,
					true /*defaultHighlighting*/
			);			
			
		} // end handleFclIconMouseUp()
		
		//=====================================================================================
		//handleDeleteIconMouseUp ~~
		function handleDeleteIconMouseUp(i,e) 
		{	   
			e.stopPropagation();
		
			if(!_nodes || i >= _nodes.length) return; //ignore illegal index
						
			Debug.log("mouseup-delete i = " + i);
			
			if(i < 0) //then delete all selected nodes
			{
				var selectedNodeIndices = Object.keys(_selectedNodes);
				DesktopContent.popUpVerification(
						"Are you sure want to <u><b>delete</b></u> the <b>" +
						selectedNodeIndices.length + "</b> selected node(s)?",
						localDeleteNode /*yes-to-reload handler*/					
				);
				return;
			}

			DesktopContent.popUpVerification(
					"Are you sure want to <u><b>delete</b></u> the node <b>" +
					ARTDAQConfigurationAPI.getShortTypeName(_nodes[i].type) + 
					"::" + _nodes[i].name + "</b>?",
					localDeleteNode /*yes-to-reload handler*/					
			);
			
			
			return;
			

			//===========
			function localDeleteNode(activeConfigGroups)
			{
				Debug.log("localDeleteNode() " + i);
				
				if(i < 0) //special selected nodes delete
				{
					console.log("Deleteing selectedNodeIndices",selectedNodeIndices);
					
					//first pass, delete html elements before indices change
					for(var j=0;j<selectedNodeIndices.length;++j)
					{
						i = selectedNodeIndices[j]|0;
						if(i < 0 || i >= _nodes.length)
						{
							Debug.log("Could not find node i=" + i +
									" in nodes! Were the nodes changed?", Debug.HIGH_PRIORITY);
							continue;
						}
						
						//delete element (and all elements after because of reindexing) to
						//	force new paint
						for(var k=i;k<_nodes.length;++k)
						{
							var nodeid = "node-" + k;
							var el = document.getElementById(nodeid);
							if(el) el.parentNode.removeChild(el);
						}
					} //end first pass html element deletion
					
					//second pass, delete from global nodes array, and modify indices into global array
					for(var j=0;j<selectedNodeIndices.length;++j)
					{
						i = selectedNodeIndices[j]|0;
						if(i < 0 || i >= _nodes.length)
						{
							Debug.log("Could not find node i=" + i +
									" in nodes! Were the nodes changed?", Debug.HIGH_PRIORITY);
							continue;
						}
						
						_nodes.splice(i,1);
						
						//fix selectedKeys after deletion
						//	any after that are higher than node index need to be decremented

						for(var k=j+1;k<selectedNodeIndices.length;++k)
							if((selectedNodeIndices[k]|0) > i)
								selectedNodeIndices[k] = (selectedNodeIndices[k]|0)-1;
					} //end deletion of selected node indices loop in global array
				}
				else if(i >= _nodes.length)
				{
					Debug.log("Could not find node i=" + i +
							" in nodes! Were the nodes changed?", Debug.HIGH_PRIORITY);
					return;
				}
				else //normal single node delete	
				{
					//first pass, delete html elements before indices change
					//delete element (and all elements after because of reindexing) to
					//	force new paint
					for(var k=i;k<_nodes.length;++k)
					{
						var nodeid = "node-" + k;
						var el = document.getElementById(nodeid);
						if(el) el.parentNode.removeChild(el);
					}

					_nodes.splice(i,1);
					
				}
				
				//subsystem change liekly affects arrows, so update
				initArrows();

				console.log("_nodes",_nodes);
				nodesHaveChanged();				

				paint();
			} //end localDeleteNode()
			
		} // end handleDeleteIconMouseUp()

		//=====================================================================================
		//getMultiNodeName ~~
		function getMultiNodeName(i,subi) 
		{	
			var namePieces = _nodes[i].name.split('*');
			if(namePieces.length > 1 && 
					subi < _nodes[i].nodeVectorIndexArr.length)
			{
				var nodeName = namePieces[0];
				var nameIndex = _nodes[i].nodeVectorIndexArr[subi] + ""; //make a 'string'
				while(_nodes[i].nodeNameFixedWidth && 
						nameIndex.length < (_nodes[i].nodeNameFixedWidth|0))
					nameIndex = "0" + nameIndex;

				for(var p=1;p<namePieces.length;++p)
					nodeName += nameIndex + namePieces[p];
				
				return nodeName; //on success				
			}
			else
			{
				Debug.log("Invalid multi-node name for node i=" +
						i + " for subi=" + subi,
						Debug.MED_PRIORITY);
				return _nodes[i].name; //on failure
			}			
			
		} //end getMultiNodeName()

		//=====================================================================================
		//getPrinterSyntaxStringWithWidth ~~
		function getPrinterSyntaxStringWithWidth(s,w) 
		{	
			var sarr = s.split(',');
			s = "";
			
			var v;
			var isFirst = true;
			for(var i=0;i<sarr.length;++i)
			{
				var rangeArr = sarr[i].split('-');
				if(!rangeArr.length) continue;
				
				v = rangeArr[0] + ""; //make string
				while(w && v.length < w) v = "0" + v;
				
				s += (isFirst?"":",") + v;
				isFirst = false;
						
				if(rangeArr.length == 1) continue;
				//else range
				
				v = rangeArr[1] + ""; //make string
				while(w && v.length < w) v = "0" + v;
				
				s += "-" + v;
			}
			return s;
		} //end getPrinterSyntaxStringWithWidth()
		
		//=====================================================================================
		//openActiveGroupsDialog ~~
		//	show update group options to activate
		function openActiveGroupsDialog()
		{
			//undo hover node, if any
			if(_mouseHoverNode != -1)
				doNodeHover(_mouseHoverNode,true /*undoHover*/);
			
			_mouseMoveMode = _MMM_POPUP_DIALOG;
			Debug.log("openActiveGroupsDialog()");

			_systemGroups = {}; //reset			

			//	get groups and aliases
			ConfigurationAPI.getAliasesAndGroups(
					function(retObj)
					{
				_systemGroups = retObj;
				console.log("_systemGroups",_systemGroups);
				console.log("ConfigurationAPI._activeGroups",ConfigurationAPI._activeGroups);

				localOpenActiveGroupsDialog();
					}); //end getAliasesAndGroups
			return;

			function localOpenActiveGroupsDialog()
			{	
				Debug.log("localOpenActiveGroupsDialog()");

				var ctrlStr = "";
				ctrlStr += htmlOpen("input",
						{
								"class": "closeButton",
								"type": "button",
								"style": "margin:20px;",
								"value": "Close",
								"title": "Close this dialog."
						},
						0 /*html*/, true /*closeTag*/);	

				var str = "";

				var groupTypes = ["Context","Configuration"];
				var stepString;

				for(var g=0;g<groupTypes.length;++g)
				{
					stepString = "chooseActiveGroups" + "-" +
							groupTypes[g] + "-";

					str += "Choose a '" + groupTypes[g] +
							"' group to activate (either a System Alias or specific group):";

					str += htmlClearDiv();

					str += "<center><br>";
					str += "Current active '" + groupTypes[g] +
							"' group: <b>" + 
							_systemGroups.activeGroups[groupTypes[g]].groupName + 
							"(" + 
							_systemGroups.activeGroups[groupTypes[g]].groupKey +
							")</b>";
					str += htmlClearDiv();
					str += "<br><table style='margin-bottom: 10px;'>";
					if(_systemGroups.aliases[groupTypes[g]] &&
							_systemGroups.aliases[groupTypes[g]].length)
					{
						str += "<tr><td><b>System Aliases:</b></td><td>";
						{ //start aliases
							str += htmlOpen("select",
									{
											"id" :		stepString + "aliases",
									});

							for(var i=0;i<_systemGroups.aliases[groupTypes[g]].length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.aliases[groupTypes[g]]
															  [i].alias /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end aliases dropdown
							str += htmlOpen("input",
									{
											"id": stepString + "activateAlias",
											"type": "button",
											"value": "Activate Alias",
											"title": "Activate chosen System Alias.",
									},
									0 /*html*/, true /*closeTag*/);	
						} //end aliases
						str += "</td></tr>";
					}
					else
						str += "<tr><td colspan='2'>No system aliases of type Context found.</td></tr>";

					var groupNames = Object.keys(_systemGroups.groups[groupTypes[g]]);
					if(groupNames.length)
					{
						str += "<tr><td><b>Group Names:</b></td><td>";
						{ //start groups
							str += htmlOpen("select",
									{
											"id" :		stepString + "groupNames",
									});

							for(var i=0;i<groupNames.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										groupNames[i] /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end group name dropdown

						} //end groups
						str += "</td></tr>";
					}
					else
						str += "<tr><td colspan='2'>No groups of type Context found.</td></tr>";

					if(groupNames.length)
					{
						str += "<tr><td><b>Group Keys:</b></td><td>";
						{ //start keys
							str += htmlOpen("select",
									{
											"id" :		stepString + "groupKeys",
									});

							for(var i=0;i<_systemGroups.groups[groupTypes[g]]
															   [groupNames[0]].keys.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.groups[groupTypes[g]]
															 [groupNames[0]].keys[i] /*innerHTML*/, true /*closeTag*/);
							}
							str += "</select>"; //end group keys dropdown
							str += htmlOpen("input",
									{
											"id": stepString + "activateGroup",
											"type": "button",
											"value": "Activate Group",
											"title": "Activate chosen Group and Key pair.",
									},
									0 /*html*/, true /*closeTag*/);	
						} //end keys
						str += "</td></tr>";
					}
					str += "</table>";
					str += "</center>";
				} //end group type loop

				//remove all existing dialogs
				ConfigurationAPI.removeAllPopUps();

				//make popup element
				el = document.createElement("div");			
				el.setAttribute("id", ConfigurationAPI._POP_UP_DIALOG_ID);

				ConfigurationAPI.setPopUpPosition(el,
						undefined /*w*/,
						undefined /*h*/, 
						undefined /*padding*/, 
						undefined /*border*/,
						50 /*margin*/);

				el.innerHTML = ctrlStr + htmlClearDiv() + 
						str + htmlClearDiv() + ctrlStr;
				document.body.appendChild(el);

				localAddHandlers();

				return;

				//==========
				function localAddHandlers()
				{ //start localAddHandlers			

					var closeButtons = document.getElementsByClassName("closeButton");
					for(var b=0;b<closeButtons.length;++b)
						closeButtons[b].onclick = 
								localCloseButtonHandler;

					/////////////////////////////////
					function localCloseButtonHandler()
					{
						Debug.log("localCloseButtonHandler()");

						//remove all existing dialogs
						ConfigurationAPI.removeAllPopUps();

						_mouseMoveMode = _MMM_NONE;
					} //end localCloseButtonHandler()

					var stepString;
					for(var g=0;g<groupTypes.length;++g)
					{
						stepString = "chooseActiveGroups-" + 
								groupTypes[g] + "-";
						var actionEl = document.getElementById(stepString + "activateAlias");
						if(actionEl) /////////////////////////////////
							actionEl.onclick = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//activate alias then go back to record name
							var alias = document.getElementById(localStepString +
									"aliases").value;
							Debug.log("activateAlias " + alias);

							//find associated aliasObj
							var aliasObj;
							for(var i=0;i<
							_systemGroups.aliases[localGroupType].length;++i)
								if(_systemGroups.aliases[localGroupType][i].alias == 
										alias)
								{
									aliasObj = _systemGroups.aliases[localGroupType][i];
									break;						
								}

							Debug.log("activateAlias group " + aliasObj.name + 
									"-" + aliasObj.key);

							ConfigurationAPI.activateGroup(aliasObj.name, aliasObj.key, 
									true /*ignoreWarnings*/, 
									/*doneHandler*/
									function()
									{
								Debug.log("The System Alias '" + alias + 
										"' (" + aliasObj.name + " (" + 
										aliasObj.key + ")) was successfully activated!", Debug.INFO_PRIORITY);

								initArtdaqNodes();
									}); //end activate group handler
								}; //end activate alias handler

						actionEl = document.getElementById(stepString + "groupNames");
						if(actionEl) //////////////////////////////////////////////////////////////////
							actionEl.onchange = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//fill keys drop down
							Debug.log("Filling dropdown with keys for " + this.value);
							var str = "";
							for(var i=0;i<_systemGroups.groups[localGroupType]
															   [this.value].keys.length;++i)
							{
								str += htmlOpen("option",
										{		
										},
										_systemGroups.groups[localGroupType]
															 [this.value].keys[i] /*innerHTML*/, true /*closeTag*/);
							}
							document.getElementById(localStepString + "groupKeys").innerHTML = 
									str;
								}; //end group names dropdown handler

						actionEl = document.getElementById(stepString + "activateGroup");
						if(actionEl) //////////////////////////////////////////////////////////////////
							actionEl.onclick = 
								function()
								{
							//since multiple, use id to identify
							var idSplit = this.id.split('-');
							var localGroupType = idSplit[1];
							var localStepString = idSplit[0] + "-" +
									idSplit[1] + "-";

							//activate alias then go back to record name
							var name = document.getElementById(localStepString + "groupNames").value;
							var key = document.getElementById(localStepString + "groupKeys").value;

							Debug.log("activateGroup " + name + 
									"-" + key);

							ConfigurationAPI.activateGroup(name, key, 
									true /*ignoreWarnings*/, 
									/*doneHandler*/
									function()
									{
								Debug.log("The Group '" + name + " (" + 
										key + ") was successfully activated!", Debug.INFO_PRIORITY);

								initArtdaqNodes();
									}); //end activate group handler
								}; //end activate alias handler

					}
				} //end localAddHandlers

			} //end localOpenActiveGroupsDialog()
		} //end openActiveGroupsDialog()

		//====================================================================================
		//saveLayout ~~
		function saveLayout(completionHandler)
		{
			Debug.log("saveLayout()");

			var postData = "layout=";
			
			//post data format:
			// grid rows, cols
			// 4-field nodes (type,name,x,y)
			
			postData += _grid.rows;
			postData += "," + _grid.cols;
			
			for(var i=0;i<_nodes.length;++i)
			{
				postData += "," + ARTDAQConfigurationAPI.getTypeName(_nodes[i].type);
				postData += "," + _nodes[i].name;
				postData += "," + _nodes[i].x;
				postData += "," + _nodes[i].y;				
			}
			
			Debug.log("postData = " + postData);
			
			//get active configuration group
			DesktopContent.XMLHttpRequest(
					"Request?RequestType=saveArtdaqNodeLayout",
					postData,
					function()
					{
				Debug.log("saveLayout() complete");				
				_layoutHasChanged = false;
				
				if(completionHandler) completionHandler();
					}
					);
		} //end saveLayout()
		
		//====================================================================================
		//nodeLayoutHasChanged ~~
		//	handle when node layout has changed
		//	for now, auto-save layout for active group
		function nodeLayoutHasChanged()
		{
			Debug.log("nodeLayoutHasChanged()");
			
			initArrows(); //always regenerate arrows			
			
			if(_nodesHaveChanged)
			{
				//do not save layout, until nodes are saved
				_layoutHasChanged = true;
				return;
			}
			
			saveLayout();
			
		} //end nodeLayoutHasChanged()

		//====================================================================================
		//nodeLayoutHasChanged ~~
		function nodesHaveChanged(haveChanged)
		{
			//Debug.log("nodesHaveChanged");
			
			_nodesHaveChanged = (haveChanged==undefined)?true:haveChanged;
						
			var el = document.getElementById("Status");
			if(el)
				el.innerHTML = _nodesHaveChanged?"( Unsaved Changes! Please save before editing node parameters)":"";
						
		} //end nodesHaveChanged()
		
		//====================================================================================
		//createNode ~~
		function createNode()
		{
			Debug.log("createNode() " + 
					_mouseMoveStart[0] + "," + _mouseMoveStart[1]);
			
			//undo hover node
			doNodeHover(_mouseHoverNode,true /*undoHover*/);

			_mouseMoveMode = _MMM_POPUP_DIALOG;

			var ctrlStr = "";
			ctrlStr += htmlOpen("input",
					{
							"class": "closeButton",
							"type": "button",
							"style": "margin:20px;",
							"value": "Close",
							"title": "Close this dialog."
					},
					0 /*html*/, true /*closeTag*/);	

			var str = "";

			str += "Choose the node type to add...";

			str += htmlClearDiv();

			str += "<br><center><table class='editNodeDialog-table'>";
			
			//======== Subsystem Field
			str += "<tr><td class='editNodeDialog-fieldCol'><b>Node Type:</b></td><td class='editNodeDialog-valueCol'>";
			{ //start subsystems
				str += htmlOpen("select",
						{
								"id": "ediNode-" + "nodeType",
								"style": "float:left; margin:7px; width:187px;",
						});

				for(var j=0;j<ARTDAQConfigurationAPI.NODE_FULL_TYPE_NAMES.length;++j)
				{					
					str += "<option >" +	
							ARTDAQConfigurationAPI.NODE_FULL_TYPE_NAMES[j] + 
							"</option>";
				}
				str += "</select>"; //end aliases dropdown

			} //end subsystems
			str += "</td></tr>";
			//======== end Subsystem Field

			str += "</table>";
			

			
			str += htmlOpen("input",
					{
							"id": "ediNode-" + "addNode",
							"type": "button",
							"value": "Add Node",
							"title": "Add the new node."
					},
					0 /*html*/, true /*closeTag*/);	

			//remove all existing dialogs
			ConfigurationAPI.removeAllPopUps();
			
			//make popup element
			el = document.createElement("div");			
			el.setAttribute("id", ConfigurationAPI._POP_UP_DIALOG_ID);

			ConfigurationAPI.setPopUpPosition(el,
					undefined /*w*/,
					undefined /*h*/, 
					undefined /*padding*/, 
					undefined /*border*/,
					50 /*margin*/);

			el.innerHTML = ctrlStr + htmlClearDiv() + 
					str + htmlClearDiv(); // + ctrlStr;
			document.body.appendChild(el);

			localAddHandlers();

			return;
			
			//==========
			function localAddHandlers()
			{ //start localAddHandlers			

				var closeButtons = document.getElementsByClassName("closeButton");
				for(var b=0;b<closeButtons.length;++b)
					closeButtons[b].onclick = 
							localCloseButtonHandler;

				/////////////////////////////////
				function localCloseButtonHandler()
				{
					Debug.log("localCloseButtonHandler()");

					//remove all existing dialogs
					ConfigurationAPI.removeAllPopUps();

					_mouseMoveMode = _MMM_NONE;
				} //end localCloseButtonHandler()

				/////////////////////////////////
				document.getElementById("ediNode-" + "addNode").onclick = 
						function()
						{
					Debug.log("Adding node ");
					
					var type = document.getElementById("ediNode-" + "nodeType").selectedIndex;
					console.log("type",type);
					
					//Steps:
					// 	- create a new node, find index i of new node
					//	- set defaults for _nodes[i] object
					//	- call launchEditNodeDialog(i) for initial editing
					
					_nodes.push({});
					var i = _nodes.length-1;
					
					var n = 0;					
					
					//check for name conflicts
					var conflict;
					do
					{
						conflict = false;
						_nodes[i].name = ARTDAQConfigurationAPI.getTypeName(type) + n;
						for(var j=0;j<i;++j)
							if(_nodes[j].type == type &&
									_nodes[j].name == _nodes[i].name)
							{
								conflict = true;
								++n; //increment name index
							}						
					} while(conflict);
					
					Debug.log("New default name = " + _nodes[i].name);
					
					//guess at hostname
					var keys = Object.keys(_hostnames);
					if(keys.length)
						_nodes[i].hostname = keys[0];
					else
					{
						_nodes[i].hostname = "localhost";
						_hostnames[_nodes[i].hostname] = 1;
					}
					
					//guess at subsystem
					keys = Object.keys(_subsystems);
					if(keys.length > 1)
						_nodes[i].subsystemId = keys[1] | 0;
					else //create a subsystem
					{
						//use 2, because 1 is 'anonymous subsystem'
						_subsystems[2] = {
								"label" : 			"subsystem1", 
								"destinationId" : 	0 /*default to null destination*/ 
						};
						_nodes[i].subsystemId = 2;
					}
					
					_nodes[i].x 		= _mouseMoveStart[0];
					_nodes[i].y 		= _mouseMoveStart[1];
					_nodes[i].type 		= type;
					_nodes[i].status 	= true; //default new nodes to ON
					
					//subsystem change liekly affects arrows, so update
					initArrows();
					
					console.log("_nodes[i]",_nodes[i]);
					nodesHaveChanged();
					
					paint();
					
					launchEditNodeDialog(i);
										
						}; //end addNode click handler
			} //end localAddHandlers()
			
		} //end createNode()
		
		//====================================================================================
		//validateNewArrow ~~
		function validateNewArrow(startNodeIndex, endNodeIndex)
		{
			Debug.log("validateNewArrow " + startNodeIndex + " to " + 
					endNodeIndex);

    		//============
    		function localHandleCleanup()
    		{
    			Debug.log("localHandleCleanup()");
				paint();
    			
    		} //end localHandleCleanup()
    		

			//validate connection
			//	 .. arrows follow rules based on subsystem settings:
			//	Readers -> all builders of same subsystem
			//	Builders -> all loggers of same subsystem AND builders of destination subsystem
			//	Loggers -> all dispatchers of same subsystem
    		//	Router -> all builders or readers of same subsystem
    		{
    			if(_nodes[startNodeIndex].type == 
    					ARTDAQConfigurationAPI.NODE_TYPE_READER)
    			{
    				//for reader, check that destination is builder or router
    				if(_nodes[endNodeIndex].type !=
    						ARTDAQConfigurationAPI.NODE_TYPE_BUILDER &&
							_nodes[endNodeIndex].type !=
									ARTDAQConfigurationAPI.NODE_TYPE_ROUTER)
    				{
    					Debug.log("Error! Destination node was type '<b>" + 
    							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[endNodeIndex].type] + "</b>'... " + 
								"The destination for a '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[_nodes[startNodeIndex].type] + 
								"</b>' must be type '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[ARTDAQConfigurationAPI.NODE_TYPE_BUILDER] +
								"</b>.'",
								Debug.HIGH_PRIORITY);
    					localHandleCleanup();
    					return;
    				}

    				//destination is correct
    				//	if destination is in current subsystem give error
    				// 	else change destination subsystem

    				if(_nodes[startNodeIndex].subsystemId == 
    						_nodes[endNodeIndex].subsystemId)
    				{
    					Debug.log("Error! Destination node is already in the same subsystem, so connection already exists!",
    							Debug.HIGH_PRIORITY);
    					localHandleCleanup();
    					return;
    				}

    				//else valid, so change start node subsystem

    				Debug.log("The reader '<b>" + 
    						_nodes[startNodeIndex].name + 
							"</b>' was successfully moved from subsystem '<b>" +
							_subsystems[_nodes[startNodeIndex].subsystemId].label + 
							"</b>' to the " + 
							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[endNodeIndex].type] + 
							"'s subsystem '<b>" +
							_subsystems[_nodes[endNodeIndex].subsystemId].label + 
							"</b>!'", Debug.INFO_PRIORITY);

    				_nodes[startNodeIndex].subsystemId = _nodes[endNodeIndex].subsystemId;

    				//===== propagate change correctly
    				initArrows();

    				console.log("_nodes[startNodeIndex]",_nodes[startNodeIndex]);
    				nodesHaveChanged();

    				//delete element to force new paint
    				var nodeid = "node-" + startNodeIndex;
    				var el = document.getElementById(nodeid);
    				if(el) el.parentNode.removeChild(el);

    				paint();
    				return;
    			} //end reader start-node handling
    			else if(_nodes[startNodeIndex].type == 
    					ARTDAQConfigurationAPI.NODE_TYPE_BUILDER)
    			{
    				//for builder, only logger/router of same subsytem or 
    				//	builder of different subsystem is valid

    				if(_nodes[endNodeIndex].type == 
    						ARTDAQConfigurationAPI.NODE_TYPE_BUILDER)
    				{
    					if(_nodes[startNodeIndex].subsystemId == 
    							_nodes[endNodeIndex].subsystemId)
    					{
    						Debug.log("Error! Destination node is in the same subsystem, so connection is invalid!",
    								Debug.HIGH_PRIORITY);
    						localHandleCleanup();
    						return;
    					}

    					//else valid, so change subsystem destinationId			

    					_subsystems[_nodes[startNodeIndex].subsystemId].destinationId = 
    							_nodes[endNodeIndex].subsystemId;

    					Debug.log("The builder's subsystem '<b>" + 
    							_subsystems[_nodes[startNodeIndex].subsystemId].label + 
								"</b>' destination was successfully changed to the target builder's subsystem '<b>" +
								_subsystems[_nodes[endNodeIndex].subsystemId].label + 
								"</b>!'", Debug.INFO_PRIORITY);

    					//===== propagate change correctly
    					initArrows();

    					console.log("_subsystems[*startNodeIndex]",
    							_subsystems[_nodes[startNodeIndex].subsystemId]);
    					nodesHaveChanged();

    					paint();
    					return;
    				}
    				else if(_nodes[endNodeIndex].type == 
    						ARTDAQConfigurationAPI.NODE_TYPE_LOGGER ||
							_nodes[endNodeIndex].type == 
									ARTDAQConfigurationAPI.NODE_TYPE_ROUTER)
    				{
    					if(_nodes[startNodeIndex].subsystemId == 
    							_nodes[endNodeIndex].subsystemId)
    					{
    						Debug.log("Error! Destination node is in the same subsystem, so connection already exists!",
    								Debug.HIGH_PRIORITY);
    						localHandleCleanup();
    						return;
    					}

    					//else valid, so change end node subsystem		

    					Debug.log("The " +
    							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[endNodeIndex].type] +
								" '<b>" + 
								_nodes[endNodeIndex].name + 
								"</b>' was successfully moved from subsystem '<b>" +
								_subsystems[_nodes[endNodeIndex].subsystemId].label + 
								"</b>' to the " + 
								ARTDAQConfigurationAPI.NODE_TYPES[_nodes[startNodeIndex].type] + 
								"'s subsystem '<b>" +
								_subsystems[_nodes[startNodeIndex].subsystemId].label + 
								"</b>!'", Debug.INFO_PRIORITY);

    					_nodes[endNodeIndex].subsystemId = _nodes[startNodeIndex].subsystemId;						

    					//===== propagate change correctly
    					initArrows();

    					console.log("_nodes[endNodeIndex]",_nodes[endNodeIndex]);
    					nodesHaveChanged();

    					//delete element to force new paint
    					var nodeid = "node-" + endNodeIndex;
    					var el = document.getElementById(nodeid);
    					if(el) el.parentNode.removeChild(el);

    					paint();
    					return;
    				}
    				else
    				{
    					Debug.log("Error! Destination node was type '<b>" + 
    							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[endNodeIndex].type] + "</b>'... " + 
								"The destination for a '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[_nodes[startNodeIndex].type] + 
								"</b>' must be type '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[ARTDAQConfigurationAPI.NODE_TYPE_BUILDER] +
								"</b>' or '<b>" +
								ARTDAQConfigurationAPI.NODE_TYPES[ARTDAQConfigurationAPI.NODE_TYPE_LOGGER] +
								"</b>.'",
								Debug.HIGH_PRIORITY);
    					localHandleCleanup();
    					return;
    				}


    			} //end builder start-node handling
    			else if(_nodes[startNodeIndex].type == 
    					ARTDAQConfigurationAPI.NODE_TYPE_LOGGER)
    			{
    				//for logger, can only go to dispatcher in same subsystem					

    				if(_nodes[endNodeIndex].type != ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER)
    				{
    					Debug.log("Error! Destination node was type '<b>" + 
    							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[endNodeIndex].type] + "</b>'... " + 
								"The destination for a '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[_nodes[startNodeIndex].type] + 
								"</b>' must be type '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER] +
								"</b>.'",
								Debug.HIGH_PRIORITY);
    					localHandleCleanup();
    					return;
    				}

    				//destination is correct
    				//	if destination is in current subsystem give error
    				// 	else change destination subsystem

    				if(_nodes[startNodeIndex].subsystemId ==
    						_nodes[endNodeIndex].subsystemId)
    				{
    					Debug.log("Error! Destination node is already in the same subsystem, so connection already exists!",
    							Debug.HIGH_PRIORITY);
    					localHandleCleanup();
    					return;
    				}

    				//else valid, so change end node subsystem		

    				Debug.log("The dispatcher '<b>" + 
    						_nodes[endNodeIndex].name + 
							"</b>' was successfully moved from subsystem '<b>" +
							_subsystems[_nodes[endNodeIndex].subsystemId].label +
							"</b>' to the " + 
							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[startNodeIndex].type] + 
							"'s subsystem '<b>" +
							_subsystems[_nodes[startNodeIndex].subsystemId].label + 
							"</b>!'", Debug.INFO_PRIORITY);

    				_nodes[endNodeIndex].subsystemId = _nodes[startNodeIndex].subsystemId;						

    				//===== propagate change correctly
    				initArrows();

    				console.log("_nodes[endNodeIndex]",_nodes[endNodeIndex]);
    				nodesHaveChanged();

    				//delete element to force new paint
    				var nodeid = "node-" + endNodeIndex;
    				var el = document.getElementById(nodeid);
    				if(el) el.parentNode.removeChild(el);

    				paint();
    				return;

    			} //end logger start-node handling
    			else if(_nodes[startNodeIndex].type == 
    					ARTDAQConfigurationAPI.NODE_TYPE_ROUTER)
    			{
    				//for router, allow 'to' reader/builder, although really only to reader					

    				if(_nodes[endNodeIndex].type != 
    						ARTDAQConfigurationAPI.NODE_TYPE_READER &&
							_nodes[endNodeIndex].type != 
									ARTDAQConfigurationAPI.NODE_TYPE_BUILDER)
    				{
    					Debug.log("Error! Destination node was type '<b>" + 
    							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[endNodeIndex].type] + "</b>'... " + 
								"The destination for a '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[_nodes[startNodeIndex].type] + 
								"</b>' must be type '<b>" + 
								ARTDAQConfigurationAPI.NODE_TYPES[ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER] +
								"</b>.'",
								Debug.HIGH_PRIORITY);
    					localHandleCleanup();
    					return;
    				}

    				//destination is correct
    				//	if destination is in current subsystem give error
    				// 	else change destination subsystem

    				if(_nodes[startNodeIndex].subsystemId ==
    						_nodes[endNodeIndex].subsystemId)
    				{
    					Debug.log("Error! Destination node is already in the same subsystem, so connection already exists!",
    							Debug.HIGH_PRIORITY);
    					localHandleCleanup();
    					return;
    				}

    				//else valid, so change end node subsystem		

    				Debug.log("The " + 
    						ARTDAQConfigurationAPI.NODE_TYPES[_nodes[endNodeIndex].type] +
							" '<b>" + 
    						_nodes[endNodeIndex].name + 
							"</b>' was successfully moved from subsystem '<b>" +
							_subsystems[_nodes[endNodeIndex].subsystemId].label + 
							"</b>' to the " + 
							ARTDAQConfigurationAPI.NODE_TYPES[_nodes[startNodeIndex].type] + 
							"'s subsystem '<b>" +
							_subsystems[_nodes[startNodeIndex].subsystemId].label + 
							"</b>!'", Debug.INFO_PRIORITY);

    				_nodes[endNodeIndex].subsystemId = _nodes[startNodeIndex].subsystemId;						

    				//===== propagate change correctly
    				initArrows();

    				console.log("_nodes[endNodeIndex]",_nodes[endNodeIndex]);
    				nodesHaveChanged();

    				//delete element to force new paint
    				var nodeid = "node-" + endNodeIndex;
    				var el = document.getElementById(nodeid);
    				if(el) el.parentNode.removeChild(el);

    				paint();
    				return;

    			} //end router start-node handling
    			else if(_nodes[startNodeIndex].type == ARTDAQConfigurationAPI.NODE_TYPE_DISPATCHER)
    			{
    				Debug.log("Error! Dispatcher's currently can not have destinations!",
    						Debug.HIGH_PRIORITY);
    				localHandleCleanup();
    				return;
    			} //end dispatcher start-node handling
    			else
    			{
    				Debug.log("Impossible! Notify admins how you got here!", Debug.HIGH_PRIORITY);
    				localHandleCleanup();
    				return;
    			}

    		} //end validate connection handling
		} //end validateNewArrow()

		//====================================================================================
		//addArrow ~~
		function addArrow(startNodeIndex, endNodeIndex, 
				startNodePointIndex, endNodePointIndex,
				arrowColor)
		{
			Debug.log("addArrow " + startNodeIndex + "-" +
					startNodePointIndex + " to " + 
					endNodeIndex + "-" + endNodePointIndex + " " +
					arrowColor);


			var fromUserDraw = true;
			if(startNodePointIndex == undefined || endNodePointIndex == undefined)
			{
				fromUserDraw = false;

				//auto select points on nodes			

				if(_nodes[endNodeIndex].x == //arrow directly above or below
						_nodes[startNodeIndex].x)
				{
					//arrow directly above or below
					startNodePointIndex = (_nodes[endNodeIndex].y <
							_nodes[startNodeIndex].y)?0:2;
					endNodePointIndex = (_nodes[endNodeIndex].y <
							_nodes[startNodeIndex].y)?2:0;
				}
				else //arrow to left or right
				{
					startNodePointIndex = (_nodes[endNodeIndex].x < //arrow to left
							_nodes[startNodeIndex].x)?3:1;
					endNodePointIndex = (_nodes[endNodeIndex].x < //arrow to left
							_nodes[startNodeIndex].x)?1:3;
				}
				
			} //end auto point index handling
			
			//add arrow to array if new
			if(_arrows[startNodeIndex] === undefined)				
				_arrows[startNodeIndex] = {};
			if(_arrows[startNodeIndex][endNodeIndex] === undefined)
			{
				_arrows[startNodeIndex][endNodeIndex] = 
					{
							"p0":startNodePointIndex,
							"p1":endNodePointIndex,
							"color":arrowColor,
					}; //arrow made
				if(fromUserDraw && _canvas) paint();
			}
			else
			{
				Debug.log("Connection already exists!",
						Debug.HIGH_PRIORITY);
			}
			
		} //end addArrow()
		

		//=====================================================================================
		//checkForActiveGroupChange ~~
		function checkForActiveGroupChange(doInit)
		{
			//Debug.log("checkForActiveGroupChange() " + doInit);

			if(_checkActiveGroupsTimer)
			{
				window.clearTimeout(_checkActiveGroupsTimer);
				_checkActiveGroupsTimer = 0;
			}
			
			//get active table groups
			DesktopContent.XMLHttpRequest(
					"Request?RequestType=getActiveTableGroups",
					"", function (req) {
								
				if(_checkActiveGroupsTimer)
					window.clearTimeout(_checkActiveGroupsTimer);
				_checkActiveGroupsTimer = window.setTimeout(checkForActiveGroupChange,_CHECK_ACTIVE_GROUPS_PERIOD);
				
				if(!req) return; //ignore disconnected requests
					
				var activeConfigGroups = [
					DesktopContent.getXMLValue(req, "Context-ActiveGroupName"),
					DesktopContent.getXMLValue(req, "Context-ActiveGroupKey"),
					DesktopContent.getXMLValue(req, "Configuration-ActiveGroupName"),
					DesktopContent.getXMLValue(req, "Configuration-ActiveGroupKey")];

				//console.log("activeConfigGroups",activeConfigGroups);
				
				//check for changes
				if(doInit || _lastActiveGroups.length != activeConfigGroups.length)
				{
					if(!doInit && _lastActiveGroups.length) //treat as change
					{
						localHandleChange(activeConfigGroups);
						return;
					}
					else //treat as initializing active groups
						_lastActiveGroups = activeConfigGroups;					
				}
				
				for(var i=0;i<_lastActiveGroups.length && activeConfigGroups.length;++i)
				{
					if(_lastActiveGroups[i] != activeConfigGroups[i])
					{
						localHandleChange(activeConfigGroups);
						return;
					}
				}

			},
			0, 0, true,  //reqParam, progressHandler, callHandlerOnErr
			true /*doNotShowLoadingOverlay*/
			); //end of getActiveTableGroups handler
			
			return;
			
			//===========
			function localHandleChange(activeConfigGroups)
			{
				if(_checkActiveGroupsTimer)
				{
					window.clearTimeout(_checkActiveGroupsTimer);
					_checkActiveGroupsTimer = 0;
				}
				
				console.log("Change detected!... activeConfigGroups",activeConfigGroups,
						"_lastActiveGroups",_lastActiveGroups);
												
				DesktopContent.popUpVerification(
						"A configuration change was detected! " +
						"Do you want to <b>reload</b> the artdaq Configuration GUI (any modifications in this window will be lost!)?",
						initArtdaqNodes /*yes-to-reload handler*/
						,
						0,0,// val [optional], bgColor [optional], 
						0,0,0, //			textColor [optional], borderColor [optional], getUserInput [optional], 
						0, //			dialogWidth [optional], 
						function() /*cancelFunc [optional]*/
						{
							Debug.log("Canceled...");

							if(_checkActiveGroupsTimer)
								window.clearTimeout(_checkActiveGroupsTimer);
							_checkActiveGroupsTimer = window.setTimeout(checkForActiveGroupChange,_CHECK_ACTIVE_GROUPS_PERIOD);

						} //end cancelFunc handler
				);

				//save for next time
				_lastActiveGroups = activeConfigGroups;

			} //end localHandleChange()			
			
		} //end checkForActiveGroupChange()
		
		//=====================================================================================
		//getGridX ~~
		function getGridX(x)
		{
			return ((x - _grid.x0 + _grid.xstep/2)/_grid.xstep);
		} //end getGridX()

		//=====================================================================================
		//getGridY ~~
		function getGridY(y)
		{
			return ((y - _grid.y0 + _grid.ystep/2)/_grid.ystep);
		} //end getGridY()

		//=====================================================================================
		//getGridPointXY ~~
		function getGridPointXY(xg,yg)
		{
			return [ _grid.x0 + xg * _grid.xstep,
						_grid.y0 + yg * _grid.ystep];
		} //end getGridPointXY()

		//=====================================================================================
		//isOverNodeBox ~~
		function isOverNodeBox(x,y,xg,yg)
		{
			var pxy = getGridPointXY(xg,yg);
			return (x > pxy[0] - _NODE_SIZE/2 && 
					x < pxy[0] + _NODE_SIZE/2 &&
					y > pxy[1] - _NODE_SIZE/2 &&
					y < pxy[1] + _NODE_SIZE/2);
		} //end isOverNodeBox()
		
		</script>
</head>
	

<body onload='Javascript:init();'>	
		
	<!-- body content populated by javascript paint(), etc. -->

	<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
	<div class='preloadImage' id='preloadImage-treeEditIconHover'></div>

	<canvas id='theGridCanvas'></canvas>
	<div id='preCanvas'></div>
	<canvas id='theCanvas'></canvas>
	<canvas id='theActionCanvas'></canvas>
	<div id='postCanvas'></div>
		
	<div id='createNodeDiv' 
			onclick='createNode(); event.stopPropagation();'
			onmouseup="event.stopPropagation();" 
			onmousedown="event.stopPropagation();" 
			title='Create a new artdaq node'>
		<div id='createNode' >+</div>
	</div>
		
	<div id='selectionBoxDiv'></div>
		
	<!-- Controls pane, Copied from Code Editor -->
	<div class="controlsPane">
		<div 	id="directoryNavToggle" 
				class="controlsButton"						
				style="float:left"
				onclick="event.stopPropagation(); openActiveGroupsDialog();" 
				onmouseup="event.stopPropagation();" 
				onmousedown="event.stopPropagation();" 
				title="Choose the active configuration (Ctrl + D)">
			<div 	id="directoryNavToggleTop"></div>
			<div 	id="directoryNavToggleBottom"></div>
		</div>
		<div 	id="saveFile"
				class="controlsButton" 
				style="float:left;" 
				onclick="event.stopPropagation(); save();"
				onmouseup="event.stopPropagation();" 
				onmousedown="event.stopPropagation();" 
				title="Click to Save changes to the active configuration (Ctrl + S)">
			<div 	id="saveFileMain"></div>
			<div 	id="saveFileMainTop"></div>
			<div 	id="saveFileMainBottom"></div>
		</div>
		<div 	id="Status" 					
				style="padding: 12px 0 0 80px; color: red;"></div>		
	</div>
	<!-- End controls pane, Copied from Code Editor -->
		
</body>
	
</html>
