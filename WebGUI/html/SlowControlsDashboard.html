
<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Slow Controls Dashboard</title>

		<link rel="stylesheet" type="text/css" href="/WebPath/css/SlowControlsDashboard.css">

		<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/widgetLibrary.js"></script>

		<script>

			//functions:
			//init()

			//top-level scope (global) variables:
			var pvList_ = {};
			var elPointer_ = {};
			var pagesList_ = [];
			var fileBlock_ = {name:"", isHidden:false, el:"", savePopup:""}; // = ["fileBlock", false ];
			var mainBlock_ = {name:"", isHidden:false, el:""}; // = ["mainBlock", false ];
			var editBlock_ = {name:"", isHidden:true, el:""}; // = [false ];
			var EDIT_BLOCK_PEEK_HEIGHT = 30;
			var EDIT_BLOCK_HEIGHT = 300;
			var page_ = page_ || {}; //define the namespace
			var PAGE_POSITIONS_ = 1000; //number of allowed integer locations (e.g. x,y,w,h for widgets) 
			var refreshRate_ = 15000; //set default to refresh every 15 seconds (ms)
			var timerVariable_;
			var UID_ = 0;
			var timeToPoll_ = false;
			var hiddenWidth_;
			var unhiddenWidth_;
			var mailbox_;
			var ADMIN_PERMISSION_THRESHOLD = 255;
			var userPermission = 10;

			//BEGIN
			var xPos_;
			var yPos_;
			//END

			//BEGIN Context Menu
			var menuState_ = 0;
			var menu_;
			var menuDiv_;
			var activeMenu_ = "menu--active";
			//END Context Menu

			var nav_;
			var gridColor_;
			var addPVMenuDiv_;
			var addPVMenu_;
			var isReadOnly_;
			page_.createPage = function(){

				this.name = "MyPage";
				this.widgets = {};
				this.addPV = function(pv){
					console.log("Reached " + pv);
				}
			}

			//BEGIN Drag
			var newWidget_ = false;
			var x_Pos_forDrag_;
			var y_Pos_forDrag_;
			var id_forDrag_;
			var target_forDrag;
			var drawingSelectionRectangle_ = false;
			//END Drag

			//BEGIN Resize
			var resizeLockout_ = false;
			var resizeId_ = "";
			var resizeFrom_ = "";
			var _saveCursorType;
			//END Resize

			var setupForDrawingID_ = undefined;
			hotkey_ = [];
			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////


			//=====================================================================================
			//init called once body has loaded
			function init() {

				Debug.log("init() was called");

				var parameterPageName = DesktopContent.getParameter(0,"page_name");				

				Debug.log("Parameter filename: " + parameterPageName);

				fileBlock_.el = document.getElementById('fileBlock');//red
				fileBlock_.savePopup = document.getElementById('popupSaveControlsPage');
				mainBlock_.el = document.getElementById('mainBlock');//yellow
				editBlock_.el = document.getElementById('editBlock');//green
				page_.createPage;
				widgetLibrary.init;

				fileBlock_.name = fileBlock_.el.id;
				mainBlock_.name = mainBlock_.el.id;
				editBlock_.name = editBlock_.el.id;

				var datalist = document.getElementById("pvDatalist");//document.createElement("datalist");
				isReadOnly_ = false;

				elPointer_["addPVMenu"] = document.getElementById("addPVMenu");
				elPointer_["addPVMenuDiv"] = document.getElementById("addPVMenuDiv");
				elPointer_["editWidgetAttributesPopup-body-pvlist"] = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				elPointer_["editWidgetAttributesPopup-body-attributes"] = document.getElementById("editWidgetAttributesPopup-body-attributes");
				elPointer_["hotkeyMenuDiv"] = document.getElementById("hotkeyMenuDiv");
				elPointer_["hotkeyMenuDiv"].style.display = "none";

				menuDiv_ = document.getElementById("contextMenuDiv");
				menu_= document.getElementById("contextMenu");
				mailbox_ = document.getElementById("mailbox");
				var myTimer = setInterval(checkMailbox, 1000);
				setupForDrawingID_ = undefined;

			 	DesktopContent.XMLHttpRequest(
                                	"Request?RequestType=getPages",
                                         "", 
                                         pagesReqHandler,
                                         0 /*reqParam*/, 
                                         0 /*progressHandler*/, 
                                         0 /*callHandlerOnErr*/, 
                                         true /*doNoShowLoadingOverlay*/);
				pagesList_ = "Loading";
				DesktopContent.XMLHttpRequest(
				                    "Request?RequestType=isUserAdmin",
				                    "",
				                    isUserAdminHandler);

				//get command string if opening a new window
				var cmdStr = DesktopContent.getParameter(2); //from  location.search
				if (cmdStr && cmdStr != "") {
					//do incoming commands!
					Debug.log("cmdStr=" + cmdStr);
					//replace %22 with "
					cmdStr = cmdStr.replace(/%22/g, "\"");
					//evaluateJS(cmdStr);
				}

				//get frame and set some text to loading
				var fileFrame = document.createElement("iframe");
				fileFrame.id = "fileFrame";
				fileFrame.src = "/WebPath/html/SlowControlsDashboardFileTree.html";
				fileFrame.style.height = "inherit";
				fileFrame.style.width = "inherit";
				fileBlock_.el.innerHTML = "";
				fileBlock_.el.style.border = "0";
				fileBlock_.el.appendChild(fileFrame);
				fileBlock_.isHidden = true;

				var editFrame = document.createElement("iframe");
				editFrame.id = "editFrame";
				editFrame.src = "/WebPath/html/SlowControlsDashboardEdit.html";
				editFrame.style.height = "inherit";
				editFrame.style.width = "inherit";
				editBlock_.el.innerHTML = "";
				editBlock_.el.style.border = "0";
				editBlock_.el.appendChild(editFrame);
				
				editBlock_.el.style.zIndex = 50;
				editBlock_.el.addEventListener("mouseover", mouseoverEditBlock, true);
				editBlock_.el.addEventListener("mouseleave", mouseoutEditBlock, true);


				//BEGIN JS Style
				mainBlock_.el.style["background-color"] = "rgb(255, 255, 255)";
				gridColor_ = "rgba(128, 128, 128, 0.3)"
				toggleGrid(true);
				console.log(("-" + fileBlock_.el.style.width));
				fileBlock_.el.style.left = "-4000px"; //hack because the file tree page probably didnt load by now
				editBlock_.el.style.bottom = "-4000px"; //hack because the edit page probably didnt load by now
				backgroundCover_ = "rgba(87,87,87, 0.6)";
				nav_ = document.getElementById("navigationMenu");
				nav_.classList.add("navigationMenu--active");
				//END JS Style

				Debug.log(parameterPageName);	

				//window.onresize = redrawWindow;

				//mainBlock_.el.removeEventListener("mousedown", startDrag, true);
				document.body.addEventListener("mousedown", handleMouseDown); //drawSelectionRectangle(id), false);
				document.body.addEventListener("mouseup", handleMouseUp);
				document.body.addEventListener("mousemove", handleMouseMove);

				redrawWindow(); //redraw window for first time

				if(parameterPageName == undefined)
			    {
                        toggleEditMode();
                }
                else
                {
                	Debug.log("Loading page from url");
                	//loadPage(parameterPageName);
                	loadPhoebusPage(parameterPageName);
                }
			} //end init()


			//=====================================================================================
			function checkMailbox()
			{
				if(mailbox_.innerHTML != "")
				{
					Debug.log("There is new mail: " + mailbox_.innerHTML);
					var msg = mailbox_.innerHTML;
					mailbox_.innerHTML = "";
					handleMail(msg);
				}
			} //end checkMailbox()


			//=====================================================================================
			function handleMail(mail)
			{
                if(mail == "Save") {
                   savePage();
                }
                else
                {
                   Debug.log("Don't know what to do with mail: " + mail);
                }
			} //end  handleMail()


			//=====================================================================================
			function pagesReqHandler(req)
			{

				pagesList_ = []; //overwrite the loading text

				console.log(req.responseText);
				console.log(DesktopContent.getXMLValue(req, "JSON"));
				if(DesktopContent.getXMLValue(req, "JSON") != "[\"None\"]")
				{
					var pagesJSON = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));
					for(var x in pagesJSON)
					{
						//console.log(pagesJSON[x]);
						pagesList_.push(pagesJSON[x]);
					}
				}
				else
				{	
					console.log("No pages found in server!");
				}
			} //end pagesReqHandler()


			//=====================================================================================
			function isUserAdminHandler(req)
			{
				Debug.log("getPermissionHandler() was called. " + req.responseText);//Req: " + req.responseText);

				isAdmin = JSON.parse(decodeURIComponent(DesktopContent.getXMLValue(req, "JSON")))["message"];
				console.log("User Permission: " + isAdmin);
				console.log(isAdmin);

				if(isAdmin == "Yes")
				{
					isReadOnly_ = false;
				}
				else
				{
					isReadOnly_ = true;
				}

				console.log("Interface isReadOnly=" + isReadOnly_);
				redrawWindow();
			} //end isUserAdminHandler()


			//=====================================================================================
			function pvListReqHandler(req)
			{
				console.log("pvListReqHandler: response received!");	
				console.log(req.responseText);
				var datalist = document.getElementById("pvDatalist");
				datalist.innerHTML = "";

				var jsonStr = DesktopContent.getXMLValue(req, "JSON");
				if(!jsonStr || jsonStr == "") return;				
				var pvListJSON;

				//if invalid JSON return
				try {pvListJSON = JSON.parse(jsonStr); }
				catch(e){console.log("Invalid JSON!"); return;}

				console.log(pvListJSON);
				for (var x in pvListJSON)
				{
					pvList_[pvListJSON[x].substring(0,pvListJSON[x].indexOf(":"))] = pvListJSON[x].substring(pvListJSON[x].indexOf(":")+1,pvListJSON[x].length);
					var option = document.createElement("option");
					option.value = pvListJSON[x].substring(0,pvListJSON[x].indexOf(":"));
					datalist.appendChild(option);
				}
			} //end pvListReqHandler()


			//=====================================================================================
			function loadPageReqHandler(req)
			{
				Debug.log("loadPageReqHandler() was called. Req: " + req.responseText);

				for (var widget in page_.widgets)
				{
					delete page_.widgets[widget].el;
					delete page_.widgets[widget];
					var widgetCover = document.getElementById(widget + "-cover");
					mainBlock_.el.removeChild(widgetCover.parentNode);
				}

				clearBlock(mainBlock_.el);
				page_.widgets = {};

				if(!fileBlock_.isHidden)
					toggleFileMenu();

				var time = decodeURIComponent(DesktopContent.getXMLValue(req, "Time"));
				var notes = decodeURIComponent(DesktopContent.getXMLValue(req, "Notes"));
				var page = decodeURIComponent(DesktopContent.getXMLValue(req, "Page"));

				if(notes == "[\"Not Found\"]")
				{
					Debug.log("Page failed to load page(" + decodeURIComponent(page) + ") on server!",
					Debug.HIGH_PRIORITY);
					return;
				}

				if(page.length > 0)
					page_ = JSON.parse(page);

				Debug.log(time);
				Debug.log(notes);
				Debug.log(page);
				console.log(page_);

				for (var widget in page_.widgets)
				{
					console.log(widget + " " + page_.widgets[widget].x + " " + page_.widgets[widget].y + " " + page_.widgets[widget].size_x + " " + page_.widgets[widget].size_y);
					drawWidgetFromFile(widget, page_.widgets[widget].x, page_.widgets[widget].y, page_.widgets[widget].size_x, page_.widgets[widget].size_y, true);
				}

				//updateRefreshInterval();
				setupForDrawingID_ = undefined;
				drawingSelectionRectangle_ = false;

		    	pageOffSetX_ = 0;
				pageOffSetY_ = 0;

				toggleEditMode();
				redrawWindow();
			} //end loadPageReqHandler()


			//=====================================================================================
			var PHOEBUS_MAP = {"textupdate": 0, "table": 1, "meter": 2, "stripchart": 3, "thermometer": 4, "siren": 5, "label": 6, "led": 7, "picture": 8, "root": 9};
			function loadPhoebusPageReqHandler(req)
			{
				Debug.log("loadPageReqHandler() was called. Req: " + req.responseText);

				for (var widget in page_.widgets)
				{
					delete page_.widgets[widget].el;
					delete page_.widgets[widget];
					var widgetCover = document.getElementById(widget + "-cover");
					mainBlock_.el.removeChild(widgetCover.parentNode);
				}

				clearBlock(mainBlock_.el);
				page_.widgets = {};

				if(!fileBlock_.isHidden)
					toggleFileMenu();

				var phoebus = decodeURIComponent(DesktopContent.getXMLValue(req, "PHOEBUS"));
				var xml = ( new window.DOMParser() ).parseFromString(phoebus, "text/xml");
				console.log("loadPhoebusPageReqHandler(): xml document");
				console.log(xml);

				var widgets = xml.getElementsByTagName("widget");
				var groups = {};

				for(i=0; i<widgets.length; ++i)
				{
					var widgetObject = {};
					widgetObject.PVList = {};
					widgetObject.attributes = {};

					var type = PHOEBUS_MAP[ widgets[i].attributes["type"].nodeValue ];
					var group = -1;
					if (widgets[i].attributes["ots_group"] !== undefined) group = widgets[i].attributes["ots_group"].nodeValue;
					
					var Display_Name = widgets[i].getElementsByTagName("name")[0];
					var x = widgets[i].getElementsByTagName("x")[0];
					var y = widgets[i].getElementsByTagName("y")[0];
					var size_x = widgets[i].getElementsByTagName("width")[0];
					var size_y = widgets[i].getElementsByTagName("height")[0];
					var pv = widgets[i].getElementsByTagName("pv_name")[0];

					if (type !== undefined) widgetObject.type = type; else widgetObject.type = 0;
					if (Display_Name !== undefined) widgetObject.Display_Name = Display_Name.innerHTML; else widgetObject.Display_Name = "undefined";
					if (x !== undefined) widgetObject.x = x.innerHTML; else widgetObject.x = 10;
					if (y !== undefined) widgetObject.y = y.innerHTML; else widgetObject.y = 10;
					if (size_x !== undefined) widgetObject.size_x = size_x.innerHTML; else widgetObject.size_x = 50;
					if (size_y !== undefined) widgetObject.size_y = size_y.innerHTML; else widgetObject.size_y = 50;
					if (pv !== undefined)
					{
						var pv_refresh = pv.attributes["refresh_rate"];
						if (pv_refresh !== undefined) widgetObject.PVList[pv.innerHTML] = pv_refresh.nodeValue; else widgetObject.PVList[pv.innerHTML] = 10000;
					}

					if (type == 3)
					{
						var traces = widgets[i].getElementsByTagName("traces")[0];
						if (traces !== undefined)
						{
							var trace = xml.getElementsByTagName("trace");
							for(j=0; j<trace.length; ++j)
							{
								var y_pv = trace[j].getElementsByTagName("y_pv")[0];
								if (y_pv !== undefined)
								{
									var pv_refresh = y_pv.attributes["refresh_rate"];
									if (pv_refresh !== undefined) widgetObject.PVList[y_pv.innerHTML] = pv_refresh.nodeValue; else widgetObject.PVList[y_pv.innerHTML] = 10000;
								}
							}
						}
					}

					//attribute objects
					var label_class = widgets[i].getElementsByTagName("class")[0];
					var border = widgets[i].getElementsByTagName("border")[0];
					var text = widgets[i].getElementsByTagName("text")[0];
					var text_position = widgets[i].getElementsByTagName("text_position")[0];
					var font = widgets[i].getElementsByTagName("font")[0];
					var foreground_color = widgets[i].getElementsByTagName("foreground_color")[0];
					var transparent = widgets[i].getElementsByTagName("transparent")[0];
					var wrap_words = widgets[i].getElementsByTagName("wrap_words")[0];
					var file = widgets[i].getElementsByTagName("file")[0];

					//set attributes
					if (label_class !== undefined) widgetObject.attributes["class"] = label_class.innerHTML;
					if (border !== undefined) widgetObject.attributes["border"] = border.innerHTML;
					if (text !== undefined) widgetObject.attributes["text"] = text.innerHTML;
					if (text_position !== undefined) widgetObject.attributes["text_position"] = text_position.innerHTML;
					if (font !== undefined) widgetObject.attributes["font"] = font.innerHTML;
					if (foreground_color !== undefined) widgetObject.attributes["foreground_color"] = foreground_color.innerHTML;
					if (transparent !== undefined) widgetObject.attributes["transparent"] = transparent.innerHTML;
					if (wrap_words !== undefined) widgetObject.attributes["wrap_words"] = wrap_words.innerHTML;
					if (file !== undefined) widgetObject.attributes["file"] = file.innerHTML;

					widgetObject.loaded = true;
					widgetObject.el = "";

					if (group !== -1)
					{
						for (j=0; j<i; ++j)
						{
							if (   page_.widgets["widget" + j] !== undefined 
								&& page_.widgets["widget" + j].type == widgetObject.type 
							    && page_.widgets["widget" + j].Display_Name == widgetObject.Display_Name
							    && Display_Name !== undefined
							    && groups["widget" + j] == group)
							{
								if (pv !== undefined) page_.widgets["widget" + j].PVList[pv.innerHTML] = 30000;
								groups["widget" + i] = group;
							}
						}
						if (groups["widget" + i] == undefined)
						{
							page_.widgets["widget" + i] = widgetObject;
							groups["widget" + i] = group;
						}
					}
					else
						page_.widgets["widget" + i] = widgetObject;
				}

				var time =  xml.getElementsByTagName("time");
				var notes = xml.getElementsByTagName("notes");

				if(notes.innerHTML == "[\"Not Found\"]")
				{
					Debug.log("Page failed to load page(" + decodeURIComponent(page) + ") on server!",
					Debug.HIGH_PRIORITY);
					return;
				}

				console.log("loadPhoebusPageReqHandler(): page_.widgets");
				console.log(page_.widgets);
				console.log("loadPhoebusPageReqHandler(): groups");
				console.log(groups);

				for (var widget in page_.widgets)
				{
					console.log(widget + " " + page_.widgets[widget].x + " " + page_.widgets[widget].y + " " + page_.widgets[widget].size_x + " " + page_.widgets[widget].size_y);
					drawWidgetFromFile(widget, page_.widgets[widget].x, page_.widgets[widget].y, page_.widgets[widget].size_x, page_.widgets[widget].size_y, true);
				}

				//updateRefreshInterval();
				setupForDrawingID_ = undefined;
				drawingSelectionRectangle_ = false;

		    	pageOffSetX_ = 0;
				pageOffSetY_ = 0;

				toggleEditMode();
				redrawWindow();
			} //end loadPhoebusPageReqHandler()


			//=====================================================================================
			function pollServerHandlerFunction(req)
			{
				Debug.log("pollServerHandlerFunction() was called. Req: " + req.responseText);

 				var jsonStr = DesktopContent.getXMLValue(req, "JSON");
				jsonStr = jsonStr.replace(/\s/g, ''); //hack for removing whitespace 
    			if(!jsonStr || jsonStr == "") 
					return;

				Debug.log(jsonStr);

				var serverResponse;

				serverResponse = JSON.parse(jsonStr);

				Debug.log(serverResponse);

				if(serverResponse.message == "NOT_FOUND")
				{
					console.log("Have to generate new UID!");
					generateUID();
					timeToPoll_ = true;
				}
				else
				{
					for(var pv in serverResponse)//have to use each pv and then loop through
					{	
						console.log("pollServerHandlerFunction: pv" + pv);						
						for (var widget in page_.widgets)
						{
							console.log("pollServerHandlerFunction: " + page_.widgets[widget]);
							for(var dependendentPV in page_.widgets[widget].PVList)
							{
								console.log("poll: " + dependendentPV);
								if(pv == dependendentPV && page_.widgets[widget].loaded != "false")
								{
									console.log("Widget*************", widget, pv);
									document.getElementById(widget).contentWindow.newValue(pv, serverResponse[pv].Value, serverResponse[pv].Timestamp, serverResponse[pv].Status, serverResponse[pv].Severity);
								}
							}
						}
					}
				}
			} //end pollServerHandlerFunction()


			//=====================================================================================
			function generateUIDHandlerFunction(req)
			{
				var uid = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));

				if(uid.message != "-1")
					UID_ = uid.message;
				else
				{
					UID_ = "";
					Debug.log("Unable to generate UID!", Debug.HIGH_PRIORITY);
				}

				if(timeToPoll_)
				{
					timeToPoll_ = false;
					pollServer();
				}
			} //end generateUIDHandlerFunction()


			//=====================================================================================
			function settingsReqHandler(req, passParams)
			{
				var settings = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));				
				var id = passParams[0];
				var parameters = passParams[1];

				console.log("id: " + id + " parameter: " + parameters);

				console.log(req);
				console.log(settings);
				console.log(id);

				//if(newWidget_)
				page_.widgets[id].el.contentWindow.setupPVs(settings);
				page_.widgets[id].el.contentWindow.newWidget(page_.widgets[id], parameters);

			} //end settingsReqHandler()


			//=====================================================================================
			function historyReqHandler(req, passParams) 
			{
				var jsonArr = req.responseXML.getElementsByTagName("JSON");
				console.log(jsonArr);

				for (var i = jsonArr.length - 1; i >= 0; i--){
					var history = JSON.parse(DesktopContent.getXMLValue(jsonArr[i]));				
					var id = passParams[0];
					var parameters = passParams[1];
					console.log("id: " + id + " parameter: " + parameters);

					console.log(req);
					console.log(history);
					console.log(id);
					for (var pv in history) {
						console.log(pv);
						console.log(history[pv].Timestamp + " " + history[pv].Value);
						page_.widgets[id].el.contentWindow.newValue(pv, history[pv].Value, history[pv].Timestamp, history[pv].Status, history[pv].Severity);
					}
				}
			} //end historyReqHandler()


			//=====================================================================================
			function savePageReqHandler(req)
			{
				var response = req.responseText;
				Debug.log(response);
			} //end savePageReqHandler()


			//=====================================================================================
			function createControlsPageHandler(req)
			{
				Debug.log("createControlsPageHandler() was called for " + controlsPageName);// Req: " + req.responseText);
				Debug.log("Your page was succesfully saved!",Debug.INFO_PRIORITY);		
			} //end createControlsPageHandler()


			//=====================================================================================
			function handlerFunction(req) {
				var child1data = DesktopContent.getXMLValue(req,"child");
				var child2data = DesktopContent.getXMLValue(req,"child2");
				Debug.log("--child1data:",child1data," --child2data:",child2data);
			} //end handlerFunction()


			//=====================================================================================
			function pollServer()
			{
				timeToPoll_ = false;
				Debug.log("pollServer: polling server!");
				console.log("pollServer(): " + page_.widgets);
				//console.log("UID is ", UID_);
				if(page_.widgets !== undefined)
				{
					DesktopContent.XMLHttpRequest(
					  "Request?RequestType=poll&uid=" + UID_,
					  "", 
					  pollServerHandlerFunction /*returnHandler*/, 
					  0 /*reqParam*/, 
					  0 /*progressHandler*/, 
					  0 /*callHandlerOnErr*/, 
					  true /*doNoShowLoadingOverlay*/);	
				}
			} //end pollServer()


			//=====================================================================================
			function generateUID()
			{
				//BEGIN Put all pvs in a JSON and send to server
				var pvList = "";
				//console.log("page: ", page_);
				for (var widget in page_.widgets)
				{
					console.log("generateUID: " +  page_.widgets[widget] + " " +  page_.widgets[widget].PVList);

					for(var pv in page_.widgets[widget].PVList)
					{
						pvList += pv + ":"  + page_.widgets[widget].PVList.valueOf()[pv] + ",";
					}
				}

				console.log(pvList);

				//END Put all pvs in a JSON and send to server
				DesktopContent.XMLHttpRequest("Request?RequestType=generateUID","PVList=" + pvList, generateUIDHandlerFunction);//, undefined, undefined, "sequence");
			} //end generateUID()


			//=====================================================================================
			function updateRefreshInterval()
			{
				console.log("updateRefreshInterval.refreshRate_ (ms): " + refreshRate_);
				window.clearInterval(timerVariable_);
				timerVariable_ = setInterval(pollServer, refreshRate_);
			} //end updateRefreshInterval()


			//=====================================================================================
			function loadPage(page)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=loadPage&Page=" + page, "", loadPageReqHandler);//, undefined, undefined, "sequence");
			} //end loadPage()


			//=====================================================================================
			function loadPhoebusPage(page)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=loadPhoebusPage&Page=" + page, "", loadPhoebusPageReqHandler);//, undefined, undefined, "sequence");
			} //end loadPhoebusPage()


			//=====================================================================================
			function loadPageNewWindow(fullPathToPage)
			{
				var newWindowStr = location.pathname + location.search
				+ "&page_name=" + fullPathToPage;

				DesktopContent.openNewWindow("Controls Dashboard", "", newWindowStr, false /*unique*/);
			} //end loadPageNewWindow()


			//=====================================================================================
			function loadPageNewBrowserTab(fullPathToPage)
			{
				var newWindowStr = location.pathname + location.search
				+ "&page_name=" + fullPathToPage;

				DesktopContent.openNewBrowserTab("Controls Dashboard","", newWindowStr ,false /*unique*/);
			} //end loadPageNewBrowserTab()


			//=====================================================================================
			//CreateDesktopIcon page loader~~
			function createDesktopIcon(fullPathToPage)
			{
				DesktopContent.addDesktopIcon(
					fullPathToPage
					,"CTRLS","Slow Control Subsets"
					, false /*unique*/
					, 255 /*permissionsString*/
					, "icon-ControlsDashboard.png" /*imageURL*/
					, "SlowControlsDashboard.html?urn=" /*windowContentURL*/
					, "ots::SlowControlsDashboardSupervisor" /*linkedApp*/
					, /*parameters*/
					"page_name=" + fullPathToPage
					);
			} //end CreateDesktopIcon


			//=====================================================================================
			function savePage() 
			{
				//Conditions to stop page saving e.g. blank page, using illegal pvs, etc Or overwrite?
				if(false)
					Debug.log("No reason to save a blank page!");
    			else
    			{
					console.log("Showing save popup");
		       		fileBlock_.savePopup.style.display = "block";
		       		fileBlock_.savePopup.style["z-index"] = "9000";
					if (userPermission == ADMIN_PERMISSION_THRESHOLD)
			       		document.getElementById("makeControlsPagePublic").style.display = "block";
    			}
			} //end savePage()


			//=====================================================================================
			function hidePopupSaveControlsPage()
			{
		        fileBlock_.savePopup.style.display = "none";
		        fileBlock_.savePopup.style["z-index"] = "0";
		        document.getElementById("controlsPageName").value="";
	            document.getElementById("controlsPageNotes").value="";
		        Debug.log("Controls Page successfully saved!");
			} //end hidePopupSaveControlsPage()


			//=====================================================================================
			function savePageAs()
			{
	            var controlsPageName = document.getElementById("controlsPageName").value;
	            console.log("Here is our name: " + controlsPageName);
	            var Regex = /^[a-zA-Z0-9\_]+$/g;
	            if (!Regex.test(controlsPageName)) 
		        	Debug.log("Illegal characters in name. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
	    		else
	    		{
    		        var controlsPageNotes = document.getElementById("controlsPageNotes").value;
    		        Debug.log(controlsPageNotes);

					if(controlsPageNotes.indexOf("@") >= 0 || controlsPageNotes.indexOf("#") >= 0 || controlsPageNotes.indexOf("..") >= 0)
					{
				         Debug.log("Illegal characters in notes. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
				         return;
					}

	    			var controlsPageLibEl = document.getElementById('listOfPrivateControlsPages');
	    			var isControlsPagePublic = document.getElementById("isControlsPagePublic").checked;

					var windowWidth = DesktopContent.getWindowWidth();
					var windowHeight = DesktopContent.getWindowHeight();
					var pagetosave = Object.assign({}, page_)
	    			for (var widget in pagetosave.widgets)
					{
						pagetosave.widgets[widget].x = page_.widgets[widget].x * windowWidth / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].y = page_.widgets[widget].y * windowHeight / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].size_x = page_.widgets[widget].size_x * windowWidth / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].size_y = page_.widgets[widget].size_y * windowHeight / (PAGE_POSITIONS_) | 0;
					}

	    			var pageString = JSON.stringify(pagetosave);

	        		if(pagesList_.indexOf(controlsPageName) !== -1) //duplicate name
	        		{
	    				Debug.log("ControlsPage name already exists!");

	    				document.getElementById('popupControlsPageAlreadyExistsOverwrite').onclick = function(){ //call edit
	    					DesktopContent.XMLHttpRequest("Request?RequestType=editControlsPage",
	    						//post data
	    						"isPublic=" + isControlsPagePublic +
								"&oldControlsPageName=" + controlsPageName +
								"&newControlsPageName=" + controlsPageName +
								"&Page=" + pageString +
								"&Time=" + Date().toString() +
								"&Notes=" + encodeURIComponent(controlsPageNotes),
								saveChangedControlsPageHandler /*handler*/,
								controlsPageName /*parameter*/);};
	        		}
	        		else
	        		{
				        DesktopContent.XMLHttpRequest("Request?RequestType=createControlsPage",
							//post data
							"isPublic=" + isControlsPagePublic +
							"&Name=" + controlsPageName +
							"&Page=" + pageString +
							"&Time=" + Date().toString() +
							"&Notes=" + encodeURIComponent(controlsPageNotes),
							createControlsPageHandler /*handler*/);

						hidePopupSaveControlsPage();
	        		}
    			}
			} //end savePageAs()


			//=====================================================================================
			function savePhoebusPageAs()
			{
	            var controlsPageName = document.getElementById("controlsPageName").value;
	            console.log("Here is our name: " + controlsPageName);
	            var Regex = /^[a-zA-Z0-9\_]+$/g;
	            if (!Regex.test(controlsPageName)) 
		        	Debug.log("Illegal characters in name. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
	    		else
	    		{
    		        var controlsPageNotes = document.getElementById("controlsPageNotes").value;
    		        Debug.log(controlsPageNotes);

					if(controlsPageNotes.indexOf("@") >= 0 || controlsPageNotes.indexOf("#") >= 0 || controlsPageNotes.indexOf("..") >= 0)
					{
				         Debug.log("Illegal characters in notes. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
				         return;
					}

	    			var controlsPageLibEl = document.getElementById('listOfPrivateControlsPages');
	    			var isControlsPagePublic = document.getElementById("isControlsPagePublic").checked;

					var windowWidth = DesktopContent.getWindowWidth();
					var windowHeight = DesktopContent.getWindowHeight();

					var pageString = document.implementation.createDocument("", "", null);
					var display = pageString.createElement("display");
					var nm = pageString.createElement("name");
					nm.innerHTML = "Display";
					display.appendChild(nm);

					var group = 0;
	    			for (var widg in page_.widgets)
					{
						if(isEmpty(page_.widgets[widg].PVList))
						{
							var widget = pageString.createElement("widget");
							var type = Object.keys(PHOEBUS_MAP).find(key => PHOEBUS_MAP[key] === page_.widgets[widg].type);
							widget.setAttribute("type", type);
							widget.setAttribute("version",	"2.0.0");
							var name = pageString.createElement("name");
							var x = pageString.createElement("x");
							var y = pageString.createElement("y");
							var width = pageString.createElement("width");
							var height = pageString.createElement("height");

							name.innerHTML = page_.widgets[widg].Display_Name;
							widget.appendChild(name);

							//attribute objects
							for (var attr in page_.widgets[widg].attributes)
							{
								var attribute = pageString.createElement(attr);
								attribute.innerHTML = page_.widgets[widg].attributes[attr];
								if (attribute.innerHTML !== "undefined") widget.appendChild(attribute);
							}

							x.innerHTML = page_.widgets[widg].x * windowWidth / (PAGE_POSITIONS_) | 0;
							y.innerHTML = page_.widgets[widg].y * windowHeight / (PAGE_POSITIONS_) | 0;
							width.innerHTML = page_.widgets[widg].size_x * windowWidth / (PAGE_POSITIONS_) | 0;
							height.innerHTML = page_.widgets[widg].size_y * windowHeight / (PAGE_POSITIONS_) | 0;
							widget.appendChild(x);
							widget.appendChild(y);
							widget.appendChild(width);
							widget.appendChild(height);

							display.appendChild(widget);
						}
						else
						{
							var type = Object.keys(PHOEBUS_MAP).find(key => PHOEBUS_MAP[key] === page_.widgets[widg].type);

							if (type =="stripchart")
							{
								var widget = pageString.createElement("widget");
								widget.setAttribute("type", type);
								widget.setAttribute("version",	"2.0.0");

								var name = pageString.createElement("name");
								var x = pageString.createElement("x");
								var y = pageString.createElement("y");
								var width = pageString.createElement("width");
								var height = pageString.createElement("height");
								name.innerHTML = page_.widgets[widg].Display_Name;
								widget.appendChild(name);

								x.innerHTML = page_.widgets[widg].x * windowWidth / (PAGE_POSITIONS_) | 0;
								y.innerHTML = page_.widgets[widg].y * windowHeight / (PAGE_POSITIONS_) | 0;
								width.innerHTML = page_.widgets[widg].size_x * windowWidth / (PAGE_POSITIONS_) | 0;
								height.innerHTML = page_.widgets[widg].size_y * windowHeight / (PAGE_POSITIONS_) | 0;

								widget.appendChild(x);
								widget.appendChild(y);
								widget.appendChild(width);
								widget.appendChild(height);

								var traces = pageString.createElement("traces");

								for (var pv_name in page_.widgets[widg].PVList)
								{
									var trace = pageString.createElement("trace");

									var pv = pageString.createElement("y_pv");
									var pv_refresh = page_.widgets[widg].PVList[pv_name];
									pv.setAttribute("refresh_rate", pv_refresh);
									pv.innerHTML = pv_name;
									trace.appendChild(pv);

									//attribute objects
									for (var attr in page_.widgets[widg].attributes)
									{
										var attribute = pageString.createElement(attr);
										attribute.innerHTML = page_.widgets[widg].attributes[attr];
										if (attribute.innerHTML !== "undefined") trace.appendChild(attribute);
									}

									traces.appendChild(trace);
								}

								widget.appendChild(traces);
								display.appendChild(widget);
							}
							else
							{
							var counter = 0;
							for (var pv_name in page_.widgets[widg].PVList)
								{
									var widget = pageString.createElement("widget");
									widget.setAttribute("type", type);
									widget.setAttribute("version",	"2.0.0");
									if (Object.getOwnPropertyNames(page_.widgets[widg].PVList).length > 1) widget.setAttribute("ots_group", group);
									var name = pageString.createElement("name");
									var pv = pageString.createElement("pv_name");
									var x = pageString.createElement("x");
									var y = pageString.createElement("y");
									var width = pageString.createElement("width");
									var height = pageString.createElement("height");

									name.innerHTML = page_.widgets[widg].Display_Name;
									widget.appendChild(name);
									var pv_refresh = page_.widgets[widg].PVList[pv_name];
									pv.setAttribute("refresh_rate", pv_refresh);
									pv.innerHTML = pv_name;
									widget.appendChild(pv);

									//attribute objects
									for (var attr in page_.widgets[widg].attributes)
									{
										var attribute = pageString.createElement(attr);
										attribute.innerHTML = page_.widgets[widg].attributes[attr];
										if (attribute.innerHTML !== "undefined") widget.appendChild(attribute);
									}

									x.innerHTML = page_.widgets[widg].x * windowWidth / (PAGE_POSITIONS_) | 0;
									y.innerHTML = page_.widgets[widg].y * windowHeight / (PAGE_POSITIONS_) | 0;
									width.innerHTML = page_.widgets[widg].size_x * windowWidth / (PAGE_POSITIONS_) | 0;
									height.innerHTML = page_.widgets[widg].size_y * windowHeight / (PAGE_POSITIONS_) | 0;
									x.innerHTML = parseInt(x.innerHTML) + counter *(parseInt(width.innerHTML) + 2);

									widget.appendChild(x);
									widget.appendChild(y);
									widget.appendChild(width);
									widget.appendChild(height);

									display.appendChild(widget);
									counter++;
								}
								if (Object.getOwnPropertyNames(page_.widgets[widg].PVList).length > 1) group++;
							}
						}
					}

					var controlsPageNotes = document.getElementById("controlsPageNotes").value;

					pageString.appendChild(display);
					var pheobusXml =  "<?xml version='1.0' encoding='UTF-8'?>\n"
									+ "<display version='2.0.0'>\n"
									+ pageString.firstChild.innerHTML + "\n"
									+ "<notes>\n" + controlsPageNotes + "\n"
									+ "</notes>\n"
									+ "<time>\n"
									+ Date().toString() + "\n"
									+ "</time>\n"
									+ "</display>";
					console.log("savePhoebusPageAs():\n",encodeURIComponent(pheobusXml));

					if(pagesList_.indexOf(controlsPageName) !== -1) //duplicate name
					{
						Debug.log("ControlsPage name already exists!");

						document.getElementById('popupControlsPageAlreadyExistsOverwrite').onclick = function(){ //call edit
						DesktopContent.XMLHttpRequest("Request?RequestType=editControlsPage",
									//post data
									"isPublic=" + isControlsPagePublic +
									"&oldControlsPageName=" + controlsPageName +
									"&newControlsPageName=" + controlsPageName +
									"&Page=" + pheobusXml +
									saveChangedControlsPageHandler /*handler*/,
									controlsPageName /*parameter*/);};
					}
					else
					{
						DesktopContent.XMLHttpRequest("Request?RequestType=createPhoebusControlsPage",
									//post data
									"isPublic=" + isControlsPagePublic +
									"&Name=" + controlsPageName +
									"&Page=" + pheobusXml,
									createControlsPageHandler /*handler*/);

						hidePopupSaveControlsPage();
					}
    			}
			} //end savePhoebusPageAs()


			//=====================================================================================
			function setupWidget(id, parameters)
			{
				console.log("setting up widget!");
				page_.widgets[id].loaded = "true";
				page_.widgets[id].el = document.getElementById(id);
				if(typeof page_.widgets[id].attributes == 'undefined')
				{
					page_.widgets[id].attributes = parameters;
				}
				else
				{
					compareAttributes(id, parameters);
				}
				var pvList = "";

				console.log(page_.widgets[id].PVList);
				for(var pv in page_.widgets[id].PVList)
				{
					pvList += pv + ",";
				}

				var passParams = [id, parameters];	
				DesktopContent.XMLHttpRequest("Request?RequestType=getPVSettings",
							//post data 
    						"PVList=" + pvList + 
							"&id=" + id,
							settingsReqHandler /*handler*/,
							 passParams /*parameter*/);

			} //end setupWidget()


			//=====================================================================================
			function setWidgetToolTip(pvName, pvValue, pvTime, pv_settings_)
			{
				var toolTip =
				pvName
				+ "\nlast value "
				+ pvValue
				+ " "
				+ pv_settings_[pvName].Units
				+ " time "
				+ new Date(pvTime*1000)
				+ "\nLower Warning Limit:\t" + Number.parseFloat(pv_settings_[pvName].Lower_Warning_Limit).toExponential(2) + "\n"
			  	+ "Upper Warning Limit:\t"   + Number.parseFloat(pv_settings_[pvName].Upper_Warning_Limit).toExponential(2) + "\n"
			  	+ "Lower Alarm Limit:\t\t"   + Number.parseFloat(pv_settings_[pvName].Lower_Alarm_Limit).toExponential(2)   + "\n"
			  	+ "Upper Alarm Limit:\t\t"   + Number.parseFloat(pv_settings_[pvName].Upper_Alarm_Limit).toExponential(2)   + "\n"
			  	+ "Lower Control Limit:\t"   + Number.parseFloat(pv_settings_[pvName].Lower_Control_Limit).toExponential(2) + "\n"
			  	+ "Upper Control Limit:\t"   + Number.parseFloat(pv_settings_[pvName].Upper_Control_Limit).toExponential(2) + "\n"
			  	+ "Lower Display Limit:\t"   + Number.parseFloat(pv_settings_[pvName].Lower_Display_Limit).toExponential(2) + "\n"
			  	+ "Upper Display Limit:\t"   + Number.parseFloat(pv_settings_[pvName].Upper_Display_Limit).toExponential(2) + "\n";
			  	return toolTip;
			} //end setWidgetToolTip()


			//=====================================================================================
			function getHistory(id, parameters)
			{
				var pvList = "";

				for(var pv in page_.widgets[id].PVList)
				{
					pvList += pv + ",";
				}

				var passParams = [id, parameters];
				DesktopContent.XMLHttpRequest("Request?RequestType=getPVArchiverData",
									//post data 
		    						"PVList=" + pvList + 
									"&id=" + id,
									historyReqHandler /*handler*/,
									 passParams /*parameter*/);
				console.log("get history for widget! pvList: " + pvList);
			} //end getHistory()


			//=====================================================================================
			function addPVToWidget(pv, refreshRate, widgetID, fromAddPV)
			{
				if(fromAddPV){toggleAddPV();}
				page_.widgets[widgetID].PVList[pv] = refreshRate;
				page_.widgets[widgetID].el.contentWindow.init();
				//newWidget_ = true;
			} //end addPVToWidget()


			//=====================================================================================
			function compareAttributes(id, parameters)
			{
				var actionRequired = false;

				for(var attribute = 0; attribute < Object.keys(page_.widgets[id].attributes).length; attribute++)
				{
					if(Object.keys(parameters).indexOf(Object.keys(page_.widgets[id].attributes)[attribute]) == -1)
					{
						//Debug.log("Attribute [" + Object.keys(page_.widgets[id].attributes)[attribute] + "] for " + page_.widgets[id].Display_Name + " is no longer required. No action required.", Debug.HIGH_PRIORITY);
					}
				}

				var attributesNew = {};

				for(attribute = 0; attribute < Object.keys(parameters).length; attribute++)
				{
					if(Object.keys(page_.widgets[id].attributes).indexOf(Object.keys(parameters)[attribute]) != -1)
					{
						attributesNew[Object.keys(parameters)[attribute]] = page_.widgets[id].attributes[Object.keys(parameters)[attribute]];
					}
					else
					{
						actionRequired = true;

						if (parameters[Object.keys(parameters)[attribute]] == "")
							attributesNew[Object.keys(parameters)[attribute]] = 'undefined';
						else
							attributesNew[Object.keys(parameters)[attribute]] = parameters[Object.keys(parameters)[attribute]];

						//Debug.log("Attribute [" + Object.keys(parameters)[attribute] + "] for " + page_.widgets[id].Display_Name + " is now a required attribute. Action Required.", Debug.HIGH_PRIORITY);
					}
				}
				page_.widgets[id].attributes = attributesNew;
				//if(actionRequired)
					//document.getElementById(id).className = "action-required";
			} //end compareAttributes()


			//=====================================================================================
			function setupForDrawSelectionRectangle(id)
			{
				mainBlock_.el.style.cursor = "crosshair";

				Debug.log("setupForDrawSelectionRectangle " + id);

				setupForDrawingID_ = id;
			} //end setupForDrawSelectionRectangle()


			//=====================================================================================
			function drawSelectionRectangle(event)
			{
				if(setupForDrawingID_  === undefined)
				{
					Debug.log("Impossible undefined widget draw id! Notify admins.", Debug.HIGH_PRIORITY);
					return;
				}
				var id = setupForDrawingID_;
				drawingSelectionRectangle_  = true;

				Debug.log("drawSelectionRectangle() " + id);

				xPos_ = event.clientX;
				yPos_ = event.clientY;

				var selectionRectangle = document.getElementById("selectionRectangle");
				selectionRectangle.style.top = event.clientY + "px";
				selectionRectangle.style.left = event.clientX + "px";	

				if(widgetLibrary.dimensions[id])
				{
					console.log("selectionRectangle id:" + id);
					if(widgetLibrary.dimensions[id]["X"])
					{
						console.log("Has a specified width");
						selectionRectangle.style.width = (widgetLibrary.dimensions[id]["X"] + "px");
					}
					else
					{
						selectionRectangle.style.width = "1px";
					}

					if(widgetLibrary.dimensions[id]["Y"])
					{
						console.log("Has a specified height");
						selectionRectangle.style.height = (widgetLibrary.dimensions[id]["Y"] + "px");
					}
					else
					{
						selectionRectangle.style.height = "1px";
					}

					if(widgetLibrary.dimensions[id]["Scale"] != "False")
					{
						console.log("Widget is scalable");
					}	
				}
				else //Default - no aspect ratio, no min size, 
				{
					selectionRectangle.style.height = "1px";
					selectionRectangle.style.width = "1px";
				}

				selectionRectangle.style.display = "block";
			} //end drawSelectionRectangle()


			//=====================================================================================
			function redrawSelectionRectangle(event) 
			{
				var id = setupForDrawingID_;
				//Debug.log("redrawSelectionRectangle() " + id);

				var ghost = document.getElementById("selectionRectangle");

				if(widgetLibrary.dimensions[id] && widgetLibrary.dimensions[id]["Y"] && widgetLibrary.dimensions[id]["X"])
				{
					var aspect_ratio = parseFloat(widgetLibrary.dimensions[id]["X"]) / parseFloat(widgetLibrary.dimensions[id]["Y"]);

					var y_displacement = (event.clientY - yPos_);
					var x_displacement = (event.clientX - xPos_);

					if((y_displacement > widgetLibrary.dimensions[id]["Y"]) || (x_displacement > widgetLibrary.dimensions[id]["X"]))
					{
						var adjusted_y_displacement = y_displacement * aspect_ratio;
						var adjusted_x_displacement = x_displacement;

						if(adjusted_y_displacement >= adjusted_x_displacement)
						{
							ghost.style.width = parseFloat(y_displacement * aspect_ratio) + "px";
							ghost.style.height = (y_displacement) + "px";						
						}
						else
						{							
							ghost.style.width = (x_displacement) + "px";
							ghost.style.height = parseFloat(x_displacement / aspect_ratio) + "px";					
						}
					}
				}
				else
				{
					ghost.style.width = (event.clientX - xPos_) + "px";
					ghost.style.height = (event.clientY - yPos_) + "px";						
				}
			} //end redrawSelectionRectangle()


			//=====================================================================================
			function stopdrawSelectionRectangle(event) 
			{
				var id = setupForDrawingID_;

				Debug.log("stopdrawSelectionRectangle() " + id);

				mainBlock_.el.style.cursor = "default";

				var ghost = document.getElementById("selectionRectangle");

				ghost.style.display = "none";

				console.log((event.clientX - xPos_));
				console.log(ghost.style.width);

				if(widgetLibrary.dimensions[id] && widgetLibrary.dimensions[id]["Scale"] && widgetLibrary.dimensions[id]["Scale"] == "False")
				
					drawWidget(id, true, xPos_ - pageOffSetX_, yPos_ - pageOffSetY_, parseFloat(widgetLibrary.dimensions[id]["X"]), parseFloat(widgetLibrary.dimensions[id]["Y"]));
 				else //Scalable is true which means that the ghost will have a width/height
					drawWidget(id, true, xPos_ - pageOffSetX_, yPos_ - pageOffSetY_, parseFloat(ghost.style.width), parseFloat(ghost.style.height));

				setupForDrawingID_ = undefined;
				drawingSelectionRectangle_  = false;
			} //end stopdrawSelectionRectangle()


			//================================================================================
			function drawWidget(widget, newWidget, xx, yy, width, height, hideFrame)
			{
				var widgetFrame = document.createElement("iframe");
				widgetFrame.scrolling="No";

				var containerDiv;
				var coverDiv;

				var OUTLINE_OFFSET = 15;
				var resizeDiv;
				var resizeDivTop;
				var resizeDivLeft;
				var resizeDivRight;
				var resizeDivBottom;
				var resizeDivTopLeft;
				var resizeDivTopRight;
				var resizeDivBottomRight;
				var resizeDivBottomLeft;

				var windowWidth = DesktopContent.getWindowWidth();
				var windowHeight = DesktopContent.getWindowHeight();

				if(newWidget)
				{
					if(typeof page_.widgets == 'undefined')
					{
						page_.widgets = {};
					}

					widgetFrame.id = "widget" + Object.keys(page_.widgets).length;//page[widget].Display_Name;
					if(typeof page_.widgets[widgetFrame.id] != 'undefined')
					{
						var pos = 0;
						while(typeof page_.widgets[widgetFrame.id] != 'undefined')
						{
							widgetFrame.id = "widget" + (pos++);
						}
					}

					var widgetObject = {};
					widgetObject.type = widget;

					//all x,y,w,h represented as "per thousand" (PAGE_POSITIONS_ positions, integer representation)
					widgetObject.size_x = (PAGE_POSITIONS_*width/windowWidth) | 0;
					widgetObject.size_y = (PAGE_POSITIONS_*height/windowHeight) | 0;
					widgetObject.x = (PAGE_POSITIONS_*xx/windowWidth) | 0;
					widgetObject.y = (PAGE_POSITIONS_*yy/windowHeight) | 0;

					widgetObject.PVList = {};
					widgetObject.attributes = {};
					widgetObject.Display_Name = widgetFrame.id;
					widgetObject.loaded = "false";
					widget = widgetFrame.id;
					page_.widgets[widget] = widgetObject;

					containerDiv = document.createElement("div");
					containerDiv.id = widgetFrame.id + "-container";
					containerDiv.style["background-color"] = "rgba(0,0,0,0.)";
					//containerDiv.innerHTML = "containerDiv";

					coverDiv = document.createElement("div");
					coverDiv.className = "widgetCover";
					coverDiv.id = widgetFrame.id + "-cover";
					//coverDiv.innerHTML = "coverDiv";

					resizeDiv = document.createElement("div");
					resizeDiv.className = "resizeWidgetCover";
					resizeDiv.id = widgetFrame.id + "-resize-cover";

					//To handle the different resize arrows
					//Edges for resize
					resizeDivTop = document.createElement("div");
					resizeDivTop.className = "resizeWidgetCoverTop";
					resizeDivTop.id = widgetFrame.id + "-resize-cover-north";
					resizeDivTop.style.cursor = "ns-resize";

					resizeDivLeft = document.createElement("div");
					resizeDivLeft.className = "resizeWidgetCoverLeft";
					resizeDivLeft.id = widgetFrame.id + "-resize-cover-west";
					resizeDivLeft.style.cursor = "ew-resize";

					resizeDivRight = document.createElement("div");
					resizeDivRight.className = "resizeWidgetCoverRight";
					resizeDivRight.id = widgetFrame.id + "-resize-cover-east";
					resizeDivRight.style.cursor = "ew-resize";

					resizeDivBottom = document.createElement("div");
					resizeDivBottom.className = "resizeWidgetCoverBottom";
					resizeDivBottom.id = widgetFrame.id + "-resize-cover-south";
					resizeDivBottom.style.cursor = "ns-resize";

					//Corners for resize
					resizeDivTopLeft = document.createElement("div");
					resizeDivTopLeft.className = "resizeWidgetCoverTopLeft";
					resizeDivTopLeft.id = widgetFrame.id + "-resize-cover-northwest";
					resizeDivTopLeft.style.cursor = "nwse-resize";

					resizeDivTopRight = document.createElement("div");
					resizeDivTopRight.className = "resizeWidgetCoverTopRight";
					resizeDivTopRight.id = widgetFrame.id + "-resize-cover-northeast";
					resizeDivTopRight.style.cursor = "nesw-resize";

					resizeDivBottomRight = document.createElement("div");
					resizeDivBottomRight.className = "resizeWidgetCoverBottomRight";
					resizeDivBottomRight.id = widgetFrame.id + "-resize-cover-southeast";
					resizeDivBottomRight.style.cursor = "nwse-resize";

					resizeDivBottomLeft = document.createElement("div");
					resizeDivBottomLeft.className = "resizeWidgetCoverBottomLeft";
					resizeDivBottomLeft.id = widgetFrame.id + "-resize-cover-southwest";
					resizeDivBottomLeft.style.cursor = "nesw-resize";

					if(!editBlock_.isHidden) 
					{
						Debug.log("FIXME use edit pencil icon instead of double click",Debug.HIGH_PRIORITY);
						//coverDiv.addEventListener("dblclick", toggleContextMenuCaller(widgetFrame.id));
					}

					coverDiv.addEventListener("mousedown", startWidgetDrag);
					coverDiv.addEventListener("mouseup", endWidgetDrag);	

					resizeDivTop.addEventListener("mousedown", startWidgetResize);
					resizeDivLeft.addEventListener("mousedown", startWidgetResize);
					resizeDivRight.addEventListener("mousedown", startWidgetResize);
					resizeDivBottom.addEventListener("mousedown", startWidgetResize);
					resizeDivTopLeft.addEventListener("mousedown", startWidgetResize);
					resizeDivTopRight.addEventListener("mousedown", startWidgetResize);
					resizeDivBottomRight.addEventListener("mousedown", startWidgetResize);
					resizeDivBottomLeft.addEventListener("mousedown", startWidgetResize);

					resizeDivTop.addEventListener("mouseup", endWidgetResize);
					resizeDivLeft.addEventListener("mouseup", endWidgetResize);
					resizeDivRight.addEventListener("mouseup", endWidgetResize);
					resizeDivBottom.addEventListener("mouseup", endWidgetResize);
					resizeDivTopLeft.addEventListener("mouseup", endWidgetResize);
					resizeDivTopRight.addEventListener("mouseup", endWidgetResize);
					resizeDivBottomRight.addEventListener("mouseup", endWidgetResize);
					resizeDivBottomLeft.addEventListener("mouseup", endWidgetResize);

					resizeDiv.appendChild(resizeDivTop);
					resizeDiv.appendChild(resizeDivLeft);
					resizeDiv.appendChild(resizeDivRight);
					resizeDiv.appendChild(resizeDivBottom);
					resizeDiv.appendChild(resizeDivTopRight);
					resizeDiv.appendChild(resizeDivTopLeft);
					resizeDiv.appendChild(resizeDivBottomRight);
					resizeDiv.appendChild(resizeDivBottomLeft);

					widgetFrame.src = "widgets/" + widgetLibrary.typeToSrc[page_.widgets[widget].type];
					widgetFrame.style.border = "0";
					widgetFrame.innerHTML = page_.widgets[widget].Display_Name;

					containerDiv.appendChild(resizeDiv);
					containerDiv.appendChild(coverDiv);

					page_.widgets[widget].el = widgetFrame;

					containerDiv.appendChild(widgetFrame);
					mainBlock_.el.appendChild(containerDiv);
				}
				else
				{
					widgetFrame = document.getElementById(widget);
				
					containerDiv = document.getElementById(widgetFrame.id + "-container");
					coverDiv = document.getElementById(widgetFrame.id + "-cover");
					resizeDiv = document.getElementById(widgetFrame.id + "-resize-cover");
					resizeDivTop = document.getElementById(widgetFrame.id + "-resize-cover-north");
					resizeDivLeft = document.getElementById(widgetFrame.id + "-resize-cover-west");
					resizeDivRight = document.getElementById(widgetFrame.id + "-resize-cover-east");
					resizeDivBottom = document.getElementById(widgetFrame.id + "-resize-cover-south");

					//Corners for resize
					resizeDivTopLeft = document.getElementById(widgetFrame.id + "-resize-cover-northwest");
					resizeDivTopRight = document.getElementById(widgetFrame.id + "-resize-cover-northeast");
					resizeDivBottomRight = document.getElementById(widgetFrame.id + "-resize-cover-southeast");
					resizeDivBottomLeft = document.getElementById(widgetFrame.id + "-resize-cover-southwest");
				}

				//now widget object has been updated, now apply sizes in pixel units
				var x = (page_.widgets[widget].x * windowWidth / PAGE_POSITIONS_) | 0; //get "pixel units"
				var y = (page_.widgets[widget].y * windowHeight / PAGE_POSITIONS_) | 0; //get "pixel units"
				var w = (page_.widgets[widget].size_x * windowWidth / PAGE_POSITIONS_) | 0; //get "pixel units"
				var h = (page_.widgets[widget].size_y * windowHeight / PAGE_POSITIONS_) | 0; //get "pixel units"

				containerDiv.style.width = w + "px";
				containerDiv.style.height = h + "px";
				containerDiv.style.position = "absolute";
				containerDiv.style.left = x + "px";
				containerDiv.style.top = y + "px";
				containerDiv.style.zIndex = "5";

				coverDiv.style.width = w + "px";
				coverDiv.style.height = h + "px";
				coverDiv.style.position = "absolute";
				coverDiv.style.left = "0px";
				coverDiv.style.top = "0px";
				coverDiv.style.zIndex = "50";

				resizeDiv.style.width = (w + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.height = (h + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.position = "absolute";
				resizeDiv.style.left = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.top = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.zIndex = "49";

				//To handle the different resize arrows
				//Edges for resize
				resizeDivTop.style.width = w + "px";
				resizeDivTop.style.height = OUTLINE_OFFSET + "px";
				resizeDivTop.style.position = "absolute";
				resizeDivTop.style.left = OUTLINE_OFFSET + "px";
				resizeDivTop.style.top = "0px";
				resizeDivTop.style.zIndex = "49";

				resizeDivLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.height = h + "px";
				resizeDivLeft.style.position = "absolute";
				resizeDivLeft.style.left ="0px";
				resizeDivLeft.style.top = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.zIndex = "49";

				resizeDivRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivRight.style.height = h + "px";
				resizeDivRight.style.position = "absolute";
				resizeDivRight.style.right = "0px";
				resizeDivRight.style.top = OUTLINE_OFFSET + "px";
				resizeDivRight.style.zIndex = "49";

				resizeDivBottom.style.width = w + "px";
				resizeDivBottom.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.position = "absolute";
				resizeDivBottom.style.left = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.bottom = "0px";
				resizeDivBottom.style.zIndex = "49";

				//Corners for resize
				resizeDivTopLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.position = "absolute";
				resizeDivTopLeft.style.left = "0px";
				resizeDivTopLeft.style.top = "0px";
				resizeDivTopLeft.style.zIndex = "49";

				resizeDivTopRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.position = "absolute";
				resizeDivTopRight.style.right = "0px";
				resizeDivTopRight.style.top = "0px";
				resizeDivTopRight.style.zIndex = "49";

				resizeDivBottomRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.position = "absolute";
				resizeDivBottomRight.style.right = "0px";
				resizeDivBottomRight.style.bottom = "0px";
				resizeDivBottomRight.style.zIndex = "49";

				resizeDivBottomLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.position = "absolute";
				resizeDivBottomLeft.style.left = "0px";
				resizeDivBottomLeft.style.bottom = "0px";
				resizeDivBottomLeft.style.zIndex = "49";

				if(!hideFrame)
				{
					widgetFrame.style.position = "absolute";
					widgetFrame.width = w + "px";
					widgetFrame.height = h + "px";
					widgetFrame.style.left = 0 + "px";
					widgetFrame.style.top = 0 + "px";
				}

				toggleWidgetSelection(page_.widgets[widget].el);
				widgetFrame.style.display = hideFrame?"none":"block";
			} //end drawWidget()


			//================================================================================
			function drawWidgetFromFile(widget, xx, yy, width, height, hideFrame)
			{
				//newWidget_ = true;
				var widgetFrame = document.createElement("iframe");
				widgetFrame.id = widget;
				widgetFrame.scrolling="No";

				var windowWidth = DesktopContent.getWindowWidth();
				var windowHeight = DesktopContent.getWindowHeight();

				page_.widgets[widget].size_x = (PAGE_POSITIONS_*width/windowWidth) | 0;
				page_.widgets[widget].size_y = (PAGE_POSITIONS_*height/windowHeight) | 0;
				page_.widgets[widget].x = (PAGE_POSITIONS_*xx/windowWidth) | 0;
				page_.widgets[widget].y = (PAGE_POSITIONS_*yy/windowHeight) | 0;

				var containerDiv;
				var coverDiv;

				var OUTLINE_OFFSET = 15;
				var resizeDiv;
				var resizeDivTop;
				var resizeDivLeft;
				var resizeDivRight;
				var resizeDivBottom;
				var resizeDivTopLeft;
				var resizeDivTopRight;
				var resizeDivBottomRight;
				var resizeDivBottomLeft;

				containerDiv = document.createElement("div");
				containerDiv.id = widgetFrame.id + "-container";
				containerDiv.style["background-color"] = "rgba(0,0,0,0.0)";
				//containerDiv.innerHTML = "containerDiv";

				coverDiv = document.createElement("div");
				coverDiv.className = "widgetCover";
				coverDiv.id = widgetFrame.id + "-cover";
				//coverDiv.innerHTML = "coverDiv";

				resizeDiv = document.createElement("div");
				resizeDiv.className = "resizeWidgetCover";
				resizeDiv.id = widgetFrame.id + "-resize-cover";

				//To handle the different resize arrows
				//Edges for resize
				resizeDivTop = document.createElement("div");
				resizeDivTop.className = "resizeWidgetCoverTop";
				resizeDivTop.id = widgetFrame.id + "-resize-cover-north";
				resizeDivTop.style.cursor = "ns-resize";

				resizeDivLeft = document.createElement("div");
				resizeDivLeft.className = "resizeWidgetCoverLeft";
				resizeDivLeft.id = widgetFrame.id + "-resize-cover-west";
				resizeDivLeft.style.cursor = "ew-resize";

				resizeDivRight = document.createElement("div");
				resizeDivRight.className = "resizeWidgetCoverRight";
				resizeDivRight.id = widgetFrame.id + "-resize-cover-east";
				resizeDivRight.style.cursor = "ew-resize";

				resizeDivBottom = document.createElement("div");
				resizeDivBottom.className = "resizeWidgetCoverBottom";
				resizeDivBottom.id = widgetFrame.id + "-resize-cover-south";
				resizeDivBottom.style.cursor = "ns-resize";

				//Corners for resize
				resizeDivTopLeft = document.createElement("div");
				resizeDivTopLeft.className = "resizeWidgetCoverTopLeft";
				resizeDivTopLeft.id = widgetFrame.id + "-resize-cover-northwest";
				resizeDivTopLeft.style.cursor = "nwse-resize";

				resizeDivTopRight = document.createElement("div");
				resizeDivTopRight.className = "resizeWidgetCoverTopRight";
				resizeDivTopRight.id = widgetFrame.id + "-resize-cover-northeast";
				resizeDivTopRight.style.cursor = "nesw-resize";

				resizeDivBottomRight = document.createElement("div");
				resizeDivBottomRight.className = "resizeWidgetCoverBottomRight";
				resizeDivBottomRight.id = widgetFrame.id + "-resize-cover-southeast";
				resizeDivBottomRight.style.cursor = "nwse-resize";

				resizeDivBottomLeft = document.createElement("div");
				resizeDivBottomLeft.className = "resizeWidgetCoverBottomLeft";
				resizeDivBottomLeft.id = widgetFrame.id + "-resize-cover-southwest";
				resizeDivBottomLeft.style.cursor = "nesw-resize";

				widgetFrame.src = "widgets/" + widgetLibrary.typeToSrc[page_.widgets[widget].type];
				widgetFrame.style.border = "0";
				widgetFrame.innerHTML = page_.widgets[widget].Display_Name;

				coverDiv.addEventListener("dblclick", toggleContextMenuCaller(widgetFrame.id));

				coverDiv.addEventListener("mousedown", startWidgetDrag);
				coverDiv.addEventListener("mouseup", endWidgetDrag);	

				resizeDivTop.addEventListener("mousedown", startWidgetResize);
				resizeDivLeft.addEventListener("mousedown", startWidgetResize);
				resizeDivRight.addEventListener("mousedown", startWidgetResize);
				resizeDivBottom.addEventListener("mousedown", startWidgetResize);
				resizeDivTopLeft.addEventListener("mousedown", startWidgetResize);
				resizeDivTopRight.addEventListener("mousedown", startWidgetResize);
				resizeDivBottomRight.addEventListener("mousedown", startWidgetResize);
				resizeDivBottomLeft.addEventListener("mousedown", startWidgetResize);

				resizeDivTop.addEventListener("mouseup", endWidgetResize);
				resizeDivLeft.addEventListener("mouseup", endWidgetResize);
				resizeDivRight.addEventListener("mouseup", endWidgetResize);
				resizeDivBottom.addEventListener("mouseup", endWidgetResize);
				resizeDivTopLeft.addEventListener("mouseup", endWidgetResize);
				resizeDivTopRight.addEventListener("mouseup", endWidgetResize);
				resizeDivBottomRight.addEventListener("mouseup", endWidgetResize);
				resizeDivBottomLeft.addEventListener("mouseup", endWidgetResize);

				resizeDiv.appendChild(resizeDivTop);
				resizeDiv.appendChild(resizeDivLeft);
				resizeDiv.appendChild(resizeDivRight);
				resizeDiv.appendChild(resizeDivBottom);
				resizeDiv.appendChild(resizeDivTopRight);
				resizeDiv.appendChild(resizeDivTopLeft);
				resizeDiv.appendChild(resizeDivBottomRight);
				resizeDiv.appendChild(resizeDivBottomLeft);

				//start resizing
				var x = (page_.widgets[widget].x * windowWidth / PAGE_POSITIONS_) | 0; //get "pixel units"
				var y = (page_.widgets[widget].y * windowHeight / PAGE_POSITIONS_) | 0; //get "pixel units"
				var w = (page_.widgets[widget].size_x * windowWidth / PAGE_POSITIONS_) | 0; //get "pixel units"
				var h = (page_.widgets[widget].size_y * windowHeight / PAGE_POSITIONS_) | 0; //get "pixel units"

				containerDiv.style.width = w + "px";
				containerDiv.style.height = h + "px";
				containerDiv.style.position = "absolute";
				containerDiv.style.left = x + "px";
				containerDiv.style.top = y + "px";
				containerDiv.style.zIndex = "5";

				coverDiv.style.width = w + "px";
				coverDiv.style.height = h + "px";
				coverDiv.style.position = "absolute";
				coverDiv.style.left = "0px";
				coverDiv.style.top = "0px";
				coverDiv.style.zIndex = "50";

				resizeDiv.style.width = (w + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.height = (h + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.position = "absolute";
				resizeDiv.style.left = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.top = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.zIndex = "49";

				//To handle the different resize arrows
				//Edges for resize
				resizeDivTop.style.width = w + "px";
				resizeDivTop.style.height = OUTLINE_OFFSET + "px";
				resizeDivTop.style.position = "absolute";
				resizeDivTop.style.left = OUTLINE_OFFSET + "px";
				resizeDivTop.style.top = "0px";
				resizeDivTop.style.zIndex = "49";

				resizeDivLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.height = h + "px";
				resizeDivLeft.style.position = "absolute";
				resizeDivLeft.style.left ="0px";
				resizeDivLeft.style.top = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.zIndex = "49";

				resizeDivRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivRight.style.height = h + "px";
				resizeDivRight.style.position = "absolute";
				resizeDivRight.style.right = "0px";
				resizeDivRight.style.top = OUTLINE_OFFSET + "px";
				resizeDivRight.style.zIndex = "49";

				resizeDivBottom.style.width = w + "px";
				resizeDivBottom.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.position = "absolute";
				resizeDivBottom.style.left = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.bottom = "0px";
				resizeDivBottom.style.zIndex = "49";

				//Corners for resize
				resizeDivTopLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.position = "absolute";
				resizeDivTopLeft.style.left = "0px";
				resizeDivTopLeft.style.top = "0px";
				resizeDivTopLeft.style.zIndex = "49";

				resizeDivTopRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.position = "absolute";
				resizeDivTopRight.style.right = "0px";
				resizeDivTopRight.style.top = "0px";
				resizeDivTopRight.style.zIndex = "49";

				resizeDivBottomRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.position = "absolute";
				resizeDivBottomRight.style.right = "0px";
				resizeDivBottomRight.style.bottom = "0px";
				resizeDivBottomRight.style.zIndex = "49";

				resizeDivBottomLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.position = "absolute";
				resizeDivBottomLeft.style.left = "0px";
				resizeDivBottomLeft.style.bottom = "0px";
				resizeDivBottomLeft.style.zIndex = "49";

				if(!hideFrame)
				{
					widgetFrame.style.position = "absolute";
					widgetFrame.width = w + "px";
					widgetFrame.height = h + "px";
					widgetFrame.style.left = 0 + "px";
					widgetFrame.style.top = 0 + "px";
				}

				containerDiv.appendChild(resizeDiv);
				containerDiv.appendChild(coverDiv);

				page_.widgets[widget].el = widgetFrame;

				containerDiv.appendChild(widgetFrame);
				mainBlock_.el.appendChild(containerDiv);

				toggleWidgetSelection(page_.widgets[widget].el);
				widgetFrame.style.display = hideFrame?"none":"block";
			} //end drawWidgetFromFile()


			//=====================================================================================
			function mouseoverEditBlock(e)
			{
				Debug.log("mouseoverEditBlock()");
				editBlock_.el.style.marginBottom = (
						EDIT_BLOCK_HEIGHT
						- EDIT_BLOCK_PEEK_HEIGHT) + "px";
				
			} // end mouseoverEditBlock()


			//=====================================================================================
			function mouseoutEditBlock(e)
			{
				Debug.log("mouseoutEditBlock()");
				editBlock_.el.style.marginBottom = 0 + "px";
				
			} //end mouseoutEditBlock()


			//================================================================================
			function toggleEditMode()
			{
				Debug.log("Toggle Edit Mode");

				//mouseoutEditBlock();
				mouseoverEditBlock();
				
				var covers = document.getElementsByClassName("widgetCover");
			    var resize_covers = document.getElementsByClassName("resizeWidgetCover");
				var editButton = document.getElementById("menuli2");

				if(editBlock_.isHidden && !isReadOnly_)
				{
					Debug.log("Edit Mode On");

					//Make sure pv list is up-to-date
					DesktopContent.XMLHttpRequest(
						"Request?RequestType=getList",
						"", 
						pvListReqHandler /*returnHandler*/, 
						0 /*reqParam*/, 
						0 /*progressHandler*/, 
						0 /*callHandlerOnErr*/, 
						false /*doNoShowLoadingOverlay*/);

					UID_ = 0;
					window.clearInterval(timerVariable_);
					editButton.classList.add("navigationMenu--Edit");
					mainBlock_.el.classList.add("editMode");

					
					editBlock_.isHidden = false;

					for(widget in page_.widgets)
					{
						drawWidget(widget, false, page_.widgets[widget].x, page_.widgets[widget].y, page_.widgets[widget].size_x, page_.widgets[widget].size_y);
						page_.widgets[widget].el.style.display = "block";						
					}
					if(covers.length > 0)
					{
						for(var i = 0;i<covers.length;++i)
						{
							covers[i].style.display = "block";
						}

						console.log(resize_covers);
						for(var i = 0;i<resize_covers.length;++i)
						{
							resize_covers[i].style["z-index"] = "8";
						}	
					}
					toggleGrid(true);
					if (editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox") != null)
						editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox").checked = true
				}
				else
				{
					Debug.log("Edit Mode Off");

					UID_ = 0;

					if (page_.widgets != undefined && !isEmpty(page_.widgets))
					{
						var pvListSize = 0;
						for (var widget in page_.widgets)
						{						
							if (!isEmpty(page_.widgets[widget].PVList))
								;//Debug.log("You have no PV selection for " + widget + "!", Debug.HIGH_PRIORITY);
							//else
								pvListSize ++;
						}
						if (pvListSize > 0)
						{
							generateUID();
							timerVariable_ = setInterval(pollServer, refreshRate_);
						}
					}

					mainBlock_.el.classList.remove("editMode");
					editButton.classList.remove("navigationMenu--Edit");
					
					editBlock_.isHidden = true;

					for(var i = 0;i<covers.length;++i)
					{
						covers[i].style.display = "none";	
					}

					toggleWidgetSelection();
					toggleGrid(false);
					if (editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox") != null)
						editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox").checked = false;
				}
			} //end toggleEditMode()


			//=====================================================================================
			function toggleContextMenuCaller(id)
			{
				 return function(event) {

					 if(!editBlock_.isHidden)
					 {
					 	toggleContextMenu(event, id);
					 }
				};
			} //end toggleContextMenuCaller()


			//=====================================================================================
			function toggleContextMenu(e, id)
			{
				if(menuState_ !== 1)
				{
					menu_.style.left = e.clientX + "px";
					menu_.style.top = e.clientY + "px";
					menu_.setAttribute("widgetID", id);
					menuState_ = 1;
					menu_.classList.add(activeMenu_);
				}
			} //end toggleContextMenu()


			//=====================================================================================
			function toggleContextMenuOff(e)
			{
				if(menuState_ !== 0)
				{
					menuState_ = 0;
					menu_.classList.remove(activeMenu_);
				}
			} //end toggleContextMenuOff()


			//=====================================================================================
			function toggleHotkeyMenu()
			{
				var rectangle = document.getElementById("menuli3").getBoundingClientRect();
				if((elPointer_["hotkeyMenuDiv"].style.display).indexOf("block") != -1)
				{
					elPointer_["hotkeyMenuDiv"].style.display = "none";
				}
				else
				{
					elPointer_["hotkeyMenuDiv"].style.display = "block";
					elPointer_["hotkeyMenuDiv"].style.left = rectangle.left + "px";
					elPointer_["hotkeyMenuDiv"].style.top = rectangle.top + "px";
				}
			} //end toggleHotkeyMenu()


			//=====================================================================================
			function toggleAddPV()
			{
				console.log(menu_.getAttribute("widgetID"));
				
				if(elPointer_["addPVMenuDiv"].style.display == "none")
				{
					toggleContextMenuOff();
					elPointer_["addPVMenuDiv"].setAttribute("widgetID", menu_.getAttribute("widgetID"));
					elPointer_["addPVMenuDiv"].style.display = "block";
					elPointer_["addPVMenu"].style.display = "block";
				}
				else
				{
					elPointer_["addPVMenuDiv"].style.display = "none"
					elPointer_["addPVMenu"].style.display = "none";
				}
			} //end toggleAddPV()


			//=====================================================================================
			function toggleFileMenu()
			{
				var coverDiv = document.getElementById("coverDiv")
				var cover = document.getElementById("mainBlockCoverDiv");
				cover.style.width = coverDiv.style.width;
				cover.style.height = coverDiv.style.height;
				cover.style.x = coverDiv.style.x;
				cover.style.y = coverDiv.style.y;
				fileBlock_.el.style.left = ("-" + fileBlock_.el.style.width)

				if(fileBlock_.isHidden)
				{
					nav_.classList.remove("navigationMenu--active");
					nav_.style.display = "none";
					editBlock_.isHidden = true;
					fileBlock_.isHidden = false;
					fileBlock_.el.style.zIndex = "150";
					console.log("Hovering!");
					cover.style.backgroundColor = backgroundCover_;
					cover.style.zIndex = parseInt(fileBlock_.el.style.zIndex) -1;
					editBlock_.el.style.display = "none";
					fileBlock_.el.style.marginLeft = fileBlock_.el.style.width;
				}
				else
				{
					fileBlock_.isHidden = true;
					fileBlock_.el.style.zIndex = "30";
					fileBlock_.el.style.marginLeft = "0px";
					cover.style.backgroundColor = "rgba(0,0,0,0)";
					mainBlock_.el.style.display = "block";
					editBlock_.el.style.display = "block";
					fileBlock_.el.style.zIndex = "-1";
					cover.style.zIndex = parseInt(fileBlock_.el.style.zIndex) -1;
					nav_.classList.add("navigationMenu--active");
					nav_.style.display = "block";
				}
			} //end toggleFileMenu()


			//=====================================================================================
			function editWidgetAttributesOpen()
			{
				document.getElementById("editWidgetAttributesPopup-container").style.display = "block";
				toggleContextMenuOff();

				//BEGIN HEADER
				var header = document.getElementById("editWidgetAttributesPopup-header");
				header.innerHTML = "";
				var title = document.createElement("input");
				title.setAttribute("type", "text")
				title.value = page_.widgets[menu_.getAttribute("widgetID")].Display_Name;
				title.onchange = function(){setWidgetDisplayName(menu_.getAttribute("widgetID"), this.value);};
				title.className = "editableInput";
				header.appendChild(title);
				console.log(header.clientHeight);
				var fontsize = 5;
				while(fontsize < (0.6 * header.clientHeight))
				{
					title.style.fontSize = ++fontsize + "px";
				}
				//END HEADER

				//BEGIN PVTable 
				var popupBody = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				popupBody.innerHTML = "";
				var table = document.createElement("table");
				table.id = "widgetPVTable";
				table.className = "widgetPopupTable";
				table.style.width = "95%";
				table.style.height = "95%";
				table.style.margin = "auto";
				var thead = document.createElement("thead");
				var trhead = document.createElement("tr");
				var thPV = document.createElement("th");
//				thPV.className = "widgetPopupTable";
				thPV.innerHTML = "PV Name";
				thPV.style.width = "60%";
				var thRefresh = document.createElement("th");
//				thRefresh.className = "widgetPopupTable";
				thRefresh.innerHTML = "Refresh Rate (Sec)";
				thRefresh.style.width = "40%";
				trhead.appendChild(thPV);
				trhead.appendChild(thRefresh);
				thead.appendChild(trhead);
				table.appendChild(thead);
				var tbody = document.createElement("tbody");
				tbody.id = "widgetPVTableBody";
				table.appendChild(tbody);
				elPointer_["editWidgetAttributesPopup-body-pvlist"].appendChild(table);

				for(var pv in page_.widgets[menu_.getAttribute("widgetID")].PVList)
				{
					editWidgetAttributesaddRowPVList(pv, page_.widgets[menu_.getAttribute("widgetID")].PVList[pv]/1000, "widgetPVTableBody", "pvDatalist");
				}

				for(var i = 0; i < 15; i++)
				{
					editWidgetAttributesaddRowPVList("", "", "widgetPVTableBody", "pvDatalist");
				}
				//END PVTable

				//BEGIN AttributesTable
				var attributeBody = elPointer_["editWidgetAttributesPopup-body-attributes"];
				attributeBody.innerHTML = "";
				var attributeTable = document.createElement("table");
				attributeTable.id = "widgetAttributesTable";
				attributeTable.className = "widgetPopupTable";
				attributeTable.style.width = "95%";
				attributeTable.style.height = "100%";
				var thead = document.createElement("thead");
				var trhead = document.createElement("tr");
				var thParameter = document.createElement("th");
				thParameter.className = "widgetPVTable";
				thParameter.innerHTML = "Parameter";
				thParameter.style.width = "40%";
				var thParameterValue = document.createElement("th");
				thParameterValue.className = "widgetPopupTable";
				thParameterValue.innerHTML = "Value";
				thParameterValue.style.width = "60%";
				trhead.appendChild(thParameter);
				trhead.appendChild(thParameterValue);
				thead.appendChild(trhead);
				attributeTable.appendChild(thead);
				var tbody = document.createElement("tbody");
				tbody.id = "widgetAttributesTableBody";
				attributeTable.appendChild(tbody);
				elPointer_["editWidgetAttributesPopup-body-attributes"].appendChild(attributeTable);

				console.log(page_.widgets[menu_.getAttribute("widgetID")].attributes);

				for(var attribute in page_.widgets[menu_.getAttribute("widgetID")].attributes)
				{
					console.log(attribute);
					editWidgetAttributesaddRowPVList(attribute, page_.widgets[menu_.getAttribute("widgetID")].attributes[attribute], "widgetAttributesTableBody", "");
				}
				//END   AttributesTableTable

				showeditWidgetAttributesPopupBody("EditPVlist");

				//BEGIN FOOTER
				var footer = document.getElementById("editWidgetAttributesPopup-footer");
				footer.innerHTML = "";
				var closeButton = document.createElement("button");
				closeButton.className = "editPopupButton";
				closeButton.style.left = "55%";
				closeButton.innerHTML = "Cancel";
				closeButton.onclick = function(){editWidgetAttributesClose();};
				footer.appendChild(closeButton);
				var saveButton = document.createElement("button");
				saveButton.className = "editPopupButton";
				saveButton.style.left = "35%";
				saveButton.innerHTML = "Save";
				saveButton.onclick = function(){editWidgetAttributesSave(); editWidgetAttributesClose();};
				footer.appendChild(saveButton);				
				//END FOOTER
			} //end editWidgetAttributesOpen()


			//=====================================================================================
			function editWidgetAttributesClose()
			{
				document.getElementById("editWidgetAttributesPopup-container").style.display = "none";
				//if (isEmpty(page_.widgets[menu_.getAttribute("widgetID")].PVList))
					//Debug.log("You have no PV selection!", Debug.WARN_PRIORITY);
			} //end editWidgetAttributesClose()


			//=====================================================================================
			function editWidgetAttributesSave()
			{
				if(elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display == "table-row"){
					page_.widgets[menu_.getAttribute("widgetID")].PVList = {};
					var table = document.getElementById("widgetPVTable");
					for(var tr = 0; tr < table.getElementsByTagName("tr").length; tr++)
					{
						if(table.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
						{
							var pv = table.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0].value;
							if(pv != "")
							{
								console.log(pv);
								var refreshRate = table.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value*1000;
								console.log("refreshRate (ms): " + refreshRate);
								if(refreshRate == "")
									refreshRate = -1;

								page_.widgets[menu_.getAttribute("widgetID")].PVList[pv] = refreshRate;
								addPVToWidget(pv, refreshRate, menu_.getAttribute("widgetID"));
							}
						}
					}
				}
				else if(elPointer_["editWidgetAttributesPopup-body-attributes"].style.display == "table-row")
				{
					var actionRequired = false;
					page_.widgets[menu_.getAttribute("widgetID")].attributes = {};
					var attributesTable = document.getElementById("widgetAttributesTable");
					console.log(attributesTable);
					for(var tr = 0; tr < attributesTable.getElementsByTagName("tr").length; tr++)
					{
						console.log(tr);
						if(attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
						{
							var parameter = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0].value;
							if(parameter != "")
							{
								var value = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value;							
								console.log(" a: " + parameter, value);
								if(value == 'undefined')
									actionRequired = true;

								page_.widgets[menu_.getAttribute("widgetID")].attributes[parameter] = value;
							}
						}
					}
					page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.setParameters(page_.widgets[menu_.getAttribute("widgetID")].attributes);
					page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.newWidget(page_.widgets[menu_.getAttribute("widgetID")], page_.widgets[menu_.getAttribute("widgetID")].attributes);

//					if(actionRequired)
//						document.getElementById(menu_.getAttribute("widgetID")).className = "action-required";
//					else
//						document.getElementById(menu_.getAttribute("widgetID")).className = "";
				}
			} //end editWidgetAttributesSave()


			//=====================================================================================
			function editWidgetAttributesaddRowPVList(keyParam, valueParam, tablebody, list)
			{
				var tbody = document.getElementById(tablebody);
				var dummytr = document.createElement("tr");
				dummytr.className = "widgetPopupTable";
				var dummyts = document.createElement("td");
				dummyts.className = "widgetPopupTable";
				var keyField = document.createElement("input");
				keyField.setAttribute("type", "text")
				keyField.className = "editableInput";
				keyField.style.color = "black";
				keyField.setAttribute("list", list);
				keyField.value = keyParam;
				keyField.onchange = function(){checkIfMoreRowsNeeded(this); };
				dummyts.appendChild(keyField);
				var dummyts2 = document.createElement("td");
				dummyts2.className = "widgetPopupTable";
				var valueField = document.createElement("input");
				valueField.setAttribute("type", "text")
				valueField.className = "editableInput";
				valueField.style.color = "black";
				valueField.value = valueParam;
				keyField.onchange = function (){setRefreshRate(keyField,valueField)};
				dummyts2.appendChild(valueField);
				dummytr.appendChild(dummyts);
				dummytr.appendChild(dummyts2);
				dummytr.style["max-height"] = "10%";
				tbody.appendChild(dummytr);	
			} //end editWidgetAttributesaddRowPVList()


			//=====================================================================================
			function checkIfMoreRowsNeeded(inputEl)
			{
				console.log(inputEl.parentElement.parentElement.parentElement.lastElementChild);
				if(inputEl.parentElement.parentElement == inputEl.parentElement.parentElement.parentElement.lastElementChild)
				{
					editWidgetAttributesaddRowPVList("", "");
				}
			} //end checkIfMoreRowsNeeded()


			//=====================================================================================
			function setWidgetDisplayName(widget, displayName)
			{
				page_.widgets[widget].Display_Name = displayName;
			} //end setWidgetDisplayName()


			//=====================================================================================
			function showeditWidgetAttributesPopupBody(body)
			{
				editWidgetAttributesSave();

				elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display = "none";
				elPointer_["editWidgetAttributesPopup-body-attributes"].style.display = "none";

				if (body == "EditAttributes")
				{
					console.log("EditAttributes");
					elPointer_["editWidgetAttributesPopup-body-attributes"].style.display = "table-row";
				}
				else if (body == "Macromaker")
				{
					//elPointer_["editWidgetAttributesPopup-body-macromaker"].style.display = "table-row";
				}
				else
				{
					elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display = "table-row";
				}
			} //end showeditWidgetAttributesPopupBody()


			//=====================================================================================
			function sleep(miliseconds) 
			{
				   var currentTime = new Date().getTime();
				   while (currentTime + miliseconds >= new Date().getTime()) {
				   }
			} //end sleep()


			//=====================================================================================
			function clearBlock(el)
			{
				for(var child = 0; child < el.childNodes.length; child++)
				{
					if(child.id == "contextMenuDiv"){}
					else if(child.id == "selectionRectangle"){}
					else 
					{
						el.removeChild(el.childNodes[child]);
					}
				}	
			} //end clearBlock()


			//=====================================================================================
			function toggleGrid(on)
			{
				if(on)
				{
					mainBlock_.el.style["background-image"] = "linear-gradient(to right, " + gridColor_ + " 1px, transparent 1px), linear-gradient(" + gridColor_ + " 1px, transparent 1px)";
					mainBlock_.el.style["background-size"]  =  "10px 10px";
				}
				else
				{
					mainBlock_.el.style["background-image"] = "";
					mainBlock_.el.style["background-size"]  =  "";
				}
			} //end toggleGrid()


			//=====================================================================================
			function setBackgroundColor(color)
			{
				mainBlock_.el.style["background-color"] = color;
			} //end setBackgroundColor()


			//=====================================================================================
			function setGridColor(color, on)
			{
				gridColor_ = color;
				toggleGrid(on);
			} //end setGridColor()


			//=====================================================================================
			function setHotkey(key)
			{
				hotkey_[key] = [pageOffSetX_, pageOffSetY_];
				document.getElementById(("hotkey" + key)).innerHTML = pageOffSetX_ + "x" + pageOffSetY_;
				document.getElementById(("hotkey" + key)).style.color = "#00cc00";
			} //end setHotkey()

			keyMap_ = [];


			//=====================================================================================
			window.onkeyup = window.onkeydown = function(e){
			    //e = e || event; // to deal with IE
				keyMap_[e.keyCode]  = e.type == 'keydown';
				handleKeys(e);
			 }


			//=====================================================================================
			function handleKeys(event)
			{
				event.clientX = 0;
				event.clientY = 0;
				
			    if (event.shiftKey && keyMap_[82])//Shift + r(eset)
			    {
			    	resetToOrigin();
				}
			    else if(event.shiftKey && (keyMap_[48] || keyMap_[49] || keyMap_[50] || keyMap_[51] || keyMap_[52] || keyMap_[53] || keyMap_[54] || keyMap_[55] || keyMap_[56] || keyMap_[57]))
			    {
			    	pageOffSetX_ = hotkey_[event.keyCode][0];
					pageOffSetY_ = hotkey_[event.keyCode][1];
					mainBlock_.el.style["background-position"] =  ("right " + pageOffSetX_ + "px top " + pageOffSetY_ + "px");
					redrawWindow();
			    }
			    else if(event.shiftKey && keyMap_[72]) //Shift + h(otkey)
			    {
			    	toggleHotkeyMenu();
			    }
			    else if(event.shiftKey && keyMap_[88])//Shift Key + X(cut)
			    {
			    	console.log(targetElement_);
			    	cutWidget(targetElement_);
			    }
			    else if(event.shiftKey && keyMap_[86])//Shift Key + v(paste)
			    {
			    	pasteWidget();
			    }
			    else if(event.shiftKey && keyMap_[79])//Shift Key + o(pen)
			    {
			    	toggleFileMenu();
			    }
			    else if(event.shiftKey && keyMap_[69])//Shift Key + e(dit)
			    {
			    	toggleEditMode();
			    }

			    if(keyMap_[38])//up arrow
			    {
			    	if(typeof targetElement_ != 'undefined') {translateWidget(targetElement_, 0, -1);}
			    	else {pageOffSetY_+=3; redrawWindow();}
					
			    }
			    if(keyMap_[40])//down arrow
			    {
			    	if(typeof targetElement_ != 'undefined') {translateWidget(targetElement_, 0, 1);}
			    	else {pageOffSetY_-=3; redrawWindow(); }
						
			    }
			    if(keyMap_[37])//left arrow
			    {
			    	if(typeof targetElement_ != 'undefined') {translateWidget(targetElement_, -1, 0);}
			    	else { pageOffSetX_+=3; redrawWindow(); }
						
			    }
			    if(keyMap_[39])// right arrow
			    {
			    	if(typeof targetElement_ != 'undefined') {translateWidget(targetElement_, 1, 0)}
			    	else { pageOffSetX_-=3; redrawWindow(); }
			    }
			} //end handleKeys()


			//=====================================================================================
			function deleteWidget()
			{
				var widgetCover = document.getElementById(menu_.getAttribute("widgetID") + "-cover")
				delete page_.widgets[widgetCover.parentNode.getElementsByTagName("iframe")[0].id].el
				delete page_.widgets[widgetCover.parentNode.getElementsByTagName("iframe")[0].id];
				mainBlock_.el.removeChild(widgetCover.parentNode);
				toggleContextMenuOff();
			} //end deleteWidget()


			var cutWidget_;
			var cutWidgetName_;

			//=====================================================================================
			function cutWidget(widgetCover)
			{
				var id = widgetCover.id.substring(0, widgetCover.id.indexOf("-cover"));
				console.log(id);
				delete page_.widgets[id].el
				cutWidget_ = page_.widgets[id];
				console.log("here");
				console.log(widgetCover);
				console.log(page_.widgets[widgetCover.parentNode.getElementsByTagName("iframe")[0].id].el);
				console.log(widgetCover.id);
				cutWidgetName_ = id;
				delete page_.widgets[id];
				mainBlock_.el.removeChild(widgetCover.parentNode);
			} //end cutWidget()


			//=====================================================================================
			function pasteWidget()
			{
				if(typeof page_.widgets[cutWidgetName_] == 'undefined')
				{
					console.log("it was undefined");
					cutWidget_.x = parseInt(cutWidget_.x) - pageOffSetX_;
					cutWidget_.y = parseInt(cutWidget_.y) - pageOffSetY_;
					page_.widgets[cutWidgetName_] = cutWidget_;
					console.log(page_.widgets[cutWidgetName_]);
					drawWidget(cutWidgetName_, false);
				}
				else
				{
					console.log("it wasn't undefined");
					var widgetNumber = 0;
					var name = "widget";
					console.log((name + widgetNumber));
					while(typeof page_.widgets[(name + widgetNumber)] != 'undefined')
					{
						widgetNumber++;
					}
					cutWidget_.x = parseInt(cutWidget_.x) + pageOffSetX_;
					cutWidget_.y = parseInt(cutWidget_.y) + pageOffSetY_;

					page_.widgets[(name + widgetNumber)] = cutWidget_;

					drawWidget((name + widgetNumber), false);
				}
				redrawWindow();
			} //end pasteWidget()


			//=====================================================================================
			function toggleWidgetSelection(target)
			{
				if(typeof targetElement_ != 'undefined'  && typeof targetElement_.parentNode != 'undefined')
				{
					targetElement_.parentNode.getElementsByTagName("iframe")[0].style.display = "block";
					targetElement_.parentNode.getElementsByClassName("resizeWidgetCover")[0].style.display = "none";			
				}

				targetElement_ = target;
				if(typeof targetElement_ != 'undefined' && typeof targetElement_.parentNode != 'undefined')
				{
					targetElement_.parentNode.getElementsByTagName("iframe")[0].style.display = "none";
					targetElement_.parentNode.getElementsByClassName("resizeWidgetCover")[0].style.display = "block";
				}	
			} //end toggleWidgetSelection()


			var pageOffSetX_ = 0;
			var pageOffSetY_ = 0;
			var dragLockout_ = false;
			var targetElement_ = undefined;
			var dragTargetElement_ = undefined;

			//=====================================================================================
			function startWidgetDrag(e)
			{
				if(e) e.stopPropagation();

				Debug.log("startWidgetDrag()");			

				//Set Mouse Pointer to Grabbing Hand
				this.style.cursor = "grabbing";

				dragTargetElement_ = e.target;

				x_Pos_forDrag_ = e.clientX;
				y_Pos_forDrag_ = e.clientY;

				if((dragTargetElement_.id).indexOf("mainBlock") != -1 )
				{
					toggleWidgetSelection();

					for(widget in page_.widgets)
					{
						page_.widgets[widget].el.style.display = "none";
					}	
				}
				else if(dragTargetElement_.className.indexOf("widgetCover") != -1 && editBlock_.isHidden == false)
				{
					console.log("editBlock is hidden ", editBlock_.isHidden);
					toggleWidgetSelection(e.target);
					dragTargetElement_.parentNode.style.zIndex ="105";
					dragTargetElement_.parentNode.getElementsByTagName("iframe")[0].style.display = "none";
					dragTargetElement_.parentNode.getElementsByClassName("resizeWidgetCover")[0].style.outline = " thin dashed";			
				}
				else if(dragTargetElement_.className.indexOf("resizeWidgetCover") != -1)
				{
					resizeLockout_ = true;
					resizeId_ = dragTargetElement_.id.substring(0, dragTargetElement_.id.indexOf("-resize-cover"));
					resizeFrom_ = dragTargetElement_.id.substring(dragTargetElement_.id.indexOf("resize-cover") + 13);

					xPos_ = e.clientX;
					yPos_ = e.clientY;
					resizeBeginWidth_ = parseFloat(page_.widgets[resizeId_].size_x);
					resizeBeginHeight_ = parseFloat(page_.widgets[resizeId_].size_y);

					//Blackout the selected widget with a cover
					page_.widgets[resizeId_].el.style.display = "none";
					console.log(resizeId_);
				}

				dragLockout_ = true;
			} //end startWidgetDrag()


			//=====================================================================================
			function endWidgetDrag(e)
			{			
				Debug.log("endWidgetDrag()");		
				this.style.cursor = "grab";

				if(resizeLockout_)
				{
					console.log("Resizing Ended");	
					resizeLockout_ = false;
					drawWidget(resizeId_, false, page_.widgets[resizeId_].x, page_.widgets[resizeId_].y, page_.widgets[resizeId_].size_x, page_.widgets[resizeId_].size_y);

					resizeFrom_ = "";
					resizeId_ = "";
				}

				if(dragLockout_)
				{
					console.log("endDrag");

					//Remove cursor grabbing
					mainBlock_.el.style.cursor = "default";	

					if(dragTargetElement_.className.indexOf("widgetCover") != -1)
					{
						var frame = dragTargetElement_.parentNode.getElementsByTagName("iframe")[0];
						page_.widgets[frame.id].x = parseInt(page_.widgets[frame.id].x) + e.clientX - x_Pos_forDrag_;
						page_.widgets[frame.id].y = parseInt(page_.widgets[frame.id].y) + e.clientY - y_Pos_forDrag_;

						frame.style.display = "block";
						dragTargetElement_.parentNode.style.zIndex = "5";
					}

					x_Pos_forDrag_ = 0;
					y_Pos_forDrag_ = 0;

					dragLockout_ = false;
					dragTargetElement_ = undefined;					
				}
			} //end endWidgetDrag()


			//=====================================================================================
			function startWidgetResize(e)
			{
				Debug.log("startWidgetResize()");			

				dragTargetElement_ = e.target;

				//Set Mouse Pointer to Grabbing Hand
				_saveCursorType = dragTargetElement_.style.cursor;
				dragTargetElement_.style.cursor = "grabbing";

				x_Pos_forDrag_ = e.clientX;
				y_Pos_forDrag_ = e.clientY;

				if((dragTargetElement_.id).indexOf("mainBlock") != -1 )
				{
					toggleWidgetSelection();

					for(widget in page_.widgets)
					{
						page_.widgets[widget].el.style.display = "none";
					}
				}
				else if(dragTargetElement_.className.indexOf("resizeWidgetCover") != -1)
				{
					resizeLockout_ = true;
					resizeId_ = dragTargetElement_.id.substring(0, dragTargetElement_.id.indexOf("-resize-cover"));
					resizeFrom_ = dragTargetElement_.id.substring(dragTargetElement_.id.indexOf("resize-cover") + 13);

					xPos_ = e.clientX;
					yPos_ = e.clientY;
					resizeBeginWidth_ = parseFloat(page_.widgets[resizeId_].size_x);
					resizeBeginHeight_ = parseFloat(page_.widgets[resizeId_].size_y);

					page_.widgets[resizeId_].el.style.display = "none";
					console.log(resizeId_);
				}

				dragLockout_ = true;
			} //end startWidgetResize()


			//=====================================================================================
			function endWidgetResize(e)
			{
				console.log("endWidgetResize()",dragTargetElement_);
				if(dragTargetElement_ === undefined) return;

				dragTargetElement_.style.cursor = _saveCursorType;

				if(resizeLockout_)
				{
					console.log("Resizing Ended");
					resizeLockout_ = false;
					drawWidget(resizeId_, false, page_.widgets[resizeId_].x, page_.widgets[resizeId_].y, page_.widgets[resizeId_].size_x, page_.widgets[resizeId_].size_y);

					resizeFrom_ = "";
					resizeId_ = "";
				}

				if(dragLockout_)
				{
					console.log("endDrag");

					//Remove cursor grabbing
					mainBlock_.el.style.cursor = "default";	

					if(dragTargetElement_.className.indexOf("WidgetCover") != -1)
					{
						var frame = dragTargetElement_.parentNode.parentNode.getElementsByTagName("iframe")[0];
						page_.widgets[frame.id].x = parseInt(page_.widgets[frame.id].x) + e.clientX - x_Pos_forDrag_;
						page_.widgets[frame.id].y = parseInt(page_.widgets[frame.id].y) + e.clientY - y_Pos_forDrag_;						

						frame.style.display = "block";
						dragTargetElement_.parentNode.style.zIndex = "5";
					}

					x_Pos_forDrag_ = 0;
					y_Pos_forDrag_ = 0;

					dragLockout_ = false;
					dragTargetElement_ = undefined;
				}
				redrawWindow();
			} //end endWidgetResize()


			//=====================================================================================
			function translateWidget(widgetId, deltaX, deltaY)
			{
				//console.log("translateWidget");
				var windowWidth = DesktopContent.getWindowWidth();
				var windowHeight = DesktopContent.getWindowHeight();

				deltaX = (PAGE_POSITIONS_*deltaX/windowWidth)|0;
				deltaY = (PAGE_POSITIONS_*deltaY/windowHeight)|0;

				page_.widgets[widgetId].x += deltaX;
				page_.widgets[widgetId].y += deltaY;

				drawWidget(widgetId,false,0,0,0,0, //newWidget, x, y, width, height
					true /*hideFrame*/);
			} //end translateWidget()


			//================================================================================
			// resizeWidget(id, resize_from = "center", new_suggested_width, new_suggested_height)
			function resizeWidget(widgetId, deltaX, deltaY, deltaW, deltaH)
			{			
				var windowWidth = DesktopContent.getWindowWidth();
				var windowHeight = DesktopContent.getWindowHeight();

				deltaX = (PAGE_POSITIONS_*deltaX/windowWidth)|0;
				deltaY = (PAGE_POSITIONS_*deltaY/windowHeight)|0;
				deltaW = (PAGE_POSITIONS_*deltaW/windowWidth)|0;
				deltaH = (PAGE_POSITIONS_*deltaH/windowHeight)|0;

				page_.widgets[widgetId].x += deltaX;
				page_.widgets[widgetId].y += deltaY;

				page_.widgets[widgetId].size_x += deltaW;
				page_.widgets[widgetId].size_y += deltaH;

				drawWidget(widgetId,false,0,0,0,0, //newWidget, x, y, width, height
					true /*hideFrame*/);
			} //end resizeWidget()


			//=====================================================================================
			//redrawTargetWidget ~~
			//	This function handle mouse drag behavior for translating and resizing a widget
			function redrawTargetWidget(e)
			{
				if(resizeLockout_)
				{
					//for resizing widget
					var deltaX = 0;
					var deltaY = 0;
					var deltaW = 0;
					var deltaH = 0;

					//Depending on where we are pulling the resize, which way means "make the widget bigger" is different
					if(resizeFrom_ == "north" || resizeFrom_ == "northeast" ||
						resizeFrom_ == "northwest")
					{						
						deltaY = (e.clientY - yPos_);
						deltaH = -deltaY;						
					}

					if(resizeFrom_ == "east" || resizeFrom_ == "northeast" ||
						resizeFrom_ == "southeast")
					{
						deltaW = (e.clientX - xPos_);
					}

				 	if(resizeFrom_ == "south" || resizeFrom_ == "southeast" ||
				 		resizeFrom_ == "southwest")
					{
						deltaH = (e.clientY - yPos_);						
					}

					if(resizeFrom_ == "west" || resizeFrom_ == "northwest" ||
						resizeFrom_ == "southwest")
					{
						deltaX = (e.clientX - xPos_);
						deltaW = -deltaX;					
					}

					var widgetId;
					try
					{
						widgetId = dragTargetElement_.parentNode.parentNode.getElementsByTagName("iframe")[0].id;
					}
					catch(e)
					{
						Debug.log("Widget ID could not be found!");
						return;
					}

					resizeWidget(widgetId, deltaX, deltaY, deltaW, deltaH);

					xPos_ = e.clientX;
					yPos_ = e.clientY;
				}
				else if(dragTargetElement_.className.indexOf("widgetCover") != -1 && !editBlock_.isHidden)
				{
					var widgetId;
					try
					{
						widgetId = dragTargetElement_.parentNode.getElementsByTagName("iframe")[0].id;
					}
					catch(e)
					{
						Debug.log("Widget ID could not be found!");
						return;
					}

					translateWidget(widgetId, (e.clientX - x_Pos_forDrag_), (e.clientY - y_Pos_forDrag_));
				}

				x_Pos_forDrag_ = e.clientX;
				y_Pos_forDrag_ = e.clientY;
			} //end redrawTargetWidget()


			//=====================================================================================
			function handleMouseDown(e)
			{				
				console.log("handleMouseDown",e.buttons,e.button);
				if(setupForDrawingID_ !== undefined)
				{
					Debug.log("handleMouseDown " + setupForDrawingID_ );	
					drawSelectionRectangle(e);
				}
				
			} //end handleMouseDown()


			//=====================================================================================
			function handleMouseUp(e)
			{
				Debug.log("handleMouseUp");
				if(setupForDrawingID_ !== undefined)
				{
					Debug.log("handleMouseUp " + setupForDrawingID_ );
					stopdrawSelectionRectangle(e);
				}
				else if(dragTargetElement_ !== undefined)
				{			
					endWidgetResize(e);
				}
			} //end handleMouseUp()


			//=====================================================================================
			function handleMouseMove(e)
			{
				//Debug.log("handleMouseMove");
				if(setupForDrawingID_ !== undefined && 
					e.buttons != 0)
				{
					//console.log("handleMouseMove", setupForDrawingID_);
					redrawSelectionRectangle(e);
				}
				else if(dragTargetElement_ !== undefined)
				{
					//console.log("handleMouseMove", dragTargetElement_);
					if(e.buttons != 0)
						redrawTargetWidget(e);
					else //mouse up?!
						endWidgetResize(e);
				}
			} //end handleMouseMove()


			//=====================================================================================
			function drawGrid()
			{
				mainBlock_.el.style["background-position"] =  ("right " + pageOffSetX_ + "px top " + pageOffSetY_ + "px");				
			} //end drawGrid()


			//=====================================================================================
			function redrawWindow(event, hover) 
			{
				Debug.log("redrawWindow() clicked-hover: " + event + "-" + hover
				 	+ " w,h: " + window.innerWidth + "," + window.innerHeight);

				var _MARGIN = 10;
				var _TOPMARGIN = 40;
				var maxWidth = window.innerWidth; // - (2 * _MARGIN);
				var maxHeight = window.innerHeight - (1 * _MARGIN);
				var marginLeft = 0;
				var cover = document.getElementById("coverDiv");
				var editCover = document.getElementById("editCoverDiv");

				hiddenWidth_ = maxWidth * 0.05;
				unhiddenWidth_ = maxWidth * 0.35;

				//DEFAULT VALUES //Sides Hidden
				var fileTop = _MARGIN, fileWidth = unhiddenWidth_, fileHeight = window.innerHeight;
				var editWidth = maxWidth, editHeight = EDIT_BLOCK_HEIGHT;
				var mainLeft = 0, mainTop = 0, mainWidth = maxWidth, mainHeight = window.innerHeight;				

				mainBlock_.el.style.left = mainLeft + "px";
				mainBlock_.el.style.top = "0px";
				mainBlock_.el.style.width =  mainWidth + "px";
				mainBlock_.el.style.height =  mainHeight + "px";
				mainBlock_.el.style.marginLeft = "0px";

				fileBlock_.el.style.top =  0 + "px";
			    fileBlock_.el.style.width =  fileWidth + "px";
				fileBlock_.el.style.height =  fileHeight + "px";

				editBlock_.el.style.width =  editWidth + "px";
				editBlock_.el.style.height =  editHeight + "px";

				cover.style.top			= 	mainTop + "px";
				cover.style.width		= 	(window.innerWidth-mainLeft) + "px";
				cover.style.height	    = 	window.innerHeight + "px";
				cover.style.left		= 	mainLeft + "px";

				editBlock_.el.style.bottom = (						
						EDIT_BLOCK_PEEK_HEIGHT //i.e. document.getElementById("editorPanelTitle").offsetHeight, but it does not exist yet
						- EDIT_BLOCK_HEIGHT) + "px";
				editBlock_.el.style.marginBottom = 0 + "px";

				if(!editBlock_.isHidden)
				{
					console.log("Edit mode");
					UID_ = 0;
					editCover.style.display = "none";
				}
				else
				{
					console.log("Not edit mode");
					editCover.style.display = "block";
				}

				var navBar = document.getElementById("navigationBarDiv");

				if(isReadOnly_)
				{
					navBar.style.display = "none";
					if(!editBlock_.isHidden)
						toggleEditMode();

					console.log(navBar);
				}
				else
				{
					navBar.style.display = "block";
				}

				drawGrid();
			} //end redrawWindow()


			//=====================================================================================
			//evaluateJS ~~
			function evaluateJS(str) 
			{
				Debug.log("evaluateJS = " + str);
				eval(str);
			} //end evaluateJS()


			//=====================================================================================
			function setRefreshRate(keyField,rateField)
			{
				Debug.log("setRefreshRate() reached");
				if(keyField.value != "")
					if(pvList_[keyField.value] != "")
						rateField.value = pvList_[keyField.value];
					else
						rateField.value = 10;
			} //end setRefreshRate()


			//=====================================================================================
			window.onresize = function() {
				console.log("window.onresize!");
				for(widget in page_.widgets)
				{
					drawWidget(widget, false);//, page_.widgets[widget].x, page_.widgets[widget].y, page_.widgets[widget].size_x, page_.widgets[widget].size_y);
				}

				toggleWidgetSelection();
				redrawWindow();
			}; //end onresize()

			//=====================================================================================
			function isEmpty(obj){
				return (Object.getOwnPropertyNames(obj).length === 0);
			} //end isEmpty()

		</script>
	</head>

	<body onload='Javascript:init();'>	
		<div id="navigationBarDiv">	
	    	  <nav>
		    <ul id="navigationMenu">
		      <li><a href="#" title="" id="menuli1" onclick="toggleFileMenu()">File</a></li>
		      <!--<li><a href="#" title="" id="menuli2" onclick="toggleHotkeyMenu()">Hotkeys</a></li>-->
		      <li><a href="#" title="" id="menuli2" onclick="toggleEditMode()">EditMode</a></li>
		      <!--<li><a href="#" title="" id="menuli3" onclick="toggleHotkeyMenu()">Quick Views</a></li>-->
		      <!--<li><a href="https://docs.google.com/document/d/1Mw4HByYfLo1bO5Hy9npDWkD4CFxa9xNsYZ5pJ7qwaTM/edit" target="_blank" title="" id="menuli4" >Help</a></li>-->
		    </ul>
	          </nav>
		</div>
		<div class='mainBlock' 	id='fileBlock'  ></div>
		<div class="cover" 		id="mainBlockCoverDiv"></div>
		<div class="cover"     	id="coverDiv" height="auto" width="auto">
		<div class='mainBlock '	id='mainBlock' > <!-- onclick=redrawWindow("mainBlock") onmouseover="redrawWindow(null, false)"> -->
		<div id="contextMenuDiv">
		<nav id="contextMenu" class="menu ">
		  <ul class="menu__items ">
		    <li class="menu__item ">
		      <a href="#" class="menu__link " onclick="toggleAddPV()">
		        <i class=""></i> Add PV
		      </a>
		    </li>
		    <li class="menu__item">
		      <a href="#" class="menu__link" onclick="editWidgetAttributesOpen()" >
		        <i class=""></i> Edit Attributes
		      </a>
		    </li>
		    <li class="menu__item">
		      <a href="#" class="menu__link" onclick="deleteWidget()">
		        <i class=""></i> Delete Widget
		      </a>
		    </li>
		    <li class="menu__item">
		      <a href="#" class="menu__link" onclick="toggleContextMenuOff()" >
		        <i class=""></i> Close
		      </a>
		    </li>
		  </ul>
		</nav>
		</div>
		<div id="addPVMenuDiv">
		  <nav id="addPVMenu" class="menu ">
		    <ul class="menu__items ">
		      <li class="menu__item ">
			<span class="menu__link">
			  <i class=""></i><input type="text" id="addPVPV" class="editableInput addPVMenuInput" placeholder="PV" list="pvDatalist"></input>
			</span> 		
		      </li>
		      <li class="menu__item">
			<span class="menu__link">
			  <i class=""></i><input type="text" id="addPVRefreshRate" class="editableInput addPVMenuInput" placeholder="Refresh Rate (ms)"></input>
			</span>
		      </li>
		      <li class="menu__item" style="height: auto">
			<span style="width: 100%; height: auto;">
			  <a href="#" onclick="addPVToWidget(document.getElementById('addPVPV').value, document.getElementById('addPVRefreshRate').value, document.getElementById('addPVMenuDiv').getAttribute('widgetID'), true)"><button type="button" class="menu__button" >Add PV </button></a>
			  <a href="#"	onclick="toggleAddPV()"><button type="button" class="menu__button">Close</button></a>
		    	</span>
		      </li>
		    </ul>
		  </nav>
		</div>
		<div class="ghost-select" id="selectionRectangle"><span></span></div>
		</div>
		<div class="cover"     id='editCoverDiv' onclick=toggleEditMode(true)></div>
		<div class='mainBlock' id='editBlock' ></div>
		</div>
		<div id="hotkeyMenuDiv">
		  <nav id="hotkeyMenu" class="menu menu--active">
		    <ul class="menu__items ">
		      <li class="menu__item ">
			<span class="menu__label " >
			  <i class=""></i> &nbsp
			</span>
		      </li>
		      <li class="menu__item ">
			<a href="#" class="menu__link " onclick="setHotkey(49)">
			  <span class="">Shift + 1</span> <span id="hotkey49" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item ">
			<a href="#" class="menu__link " onclick="setHotkey(50)">
			  <span class="">Shift + 2</span> <span id="hotkey50" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item ">
			<a href="#" class="menu__link " onclick="setHotkey(51)">
			  <span class="">Shift + 3</span> <span id="hotkey51" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item ">
			<a href="#" class="menu__link " onclick="setHotkey(52)">
			  <span class="">Shift + 4</span> <span id="hotkey52" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item ">
			<a href="#" class="menu__link " onclick="setHotkey(53)">
			  <span class="">Shift + 5</span> <span id="hotkey53" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item ">
			<a href="#" class="menu__link " onclick="setHotkey(54)">
			  <span class="">Shift + 6</span> <span id="hotkey54" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item">
			<a href="#" class="menu__link" onclick="setHotkey(55)" >
			  <span class="">Shift + 7</span> <span id="hotkey55" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item">
			<a href="#" class="menu__link" onclick="setHotkey(56)">
			  <span class="">Shift + 8</span> <span id="hotkey56" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item">
			<a href="#" class="menu__link" onclick="setHotkey(57)">
			  <span class="">Shift + 9</span> <span id="hotkey57" class="menu__setting">Not Set</span>
			</a>
		      </li>
		      <li class="menu__item">
			<a href="#" class="menu__link" onclick="setHotkey(48)">
			  <span class="">Shift + 0</span> <span id="hotkey48" class="menu__setting">Not Set</span>
			</a>
		      </li>
		    </ul>
		  </nav>
		</div>
		<div id="popupSaveControlsPage" class="popup">
		  <center><h2>Save your Controls Page</h2></center>
		  <div>
		    <p><b>Page Name</b></p>
		    <center><textarea id="controlsPageName" cols="43" rows="1"></textarea></center>
		    <p><b>Controls Page Notes</b></p>
		    <center><textarea id="controlsPageNotes" cols="43" rows="6"></textarea></center>
		    <div id="makeControlsPagePublic">
		      <input type="checkbox" id="isControlsPagePublic"> Make accessible to public</input>
		    </div>
		    <div class="buttongroup">
		      <center>
			<button onclick="hidePopupSaveControlsPage()">Cancel</button>
			<button onclick="savePhoebusPageAs()">Save as Controls Page</button>
		      </center>
		    </div>
		  </div>
		</div>
		<div class="editWidgetAttributesPopup-container" id="editWidgetAttributesPopup-container">
		  <div class="editWidgetAttributesPopup-header" id="editWidgetAttributesPopup-header" ></div>
		  <div class="editWidgetAttributesPopup-menu"   id="editWidgetAttributesPopup-menu">
		    <nav id="editWidgetAttributesPopup-menu-nav">
		      <ul class="menu__items ">
			<li class="menu__item ">
			  <a href="#" class="menu__link " onclick="showeditWidgetAttributesPopupBody('PVList')">
			    <i class=""></i> Edits PVs
			  </a>
			</li>
			<li class="menu__item">
			  <a href="#" class="menu__link" onclick="showeditWidgetAttributesPopupBody('EditAttributes')" >
			    <i class=""></i> Edit Attributes
			  </a>
			</li>
			<!--<li class="menu__item">
			    <a href="#" class="menu__link" onclick="showeditWidgetAttributesPopupBody('Macromaker')">
			      <i class=""></i> Macromaker
			    </a>
			</li>-->
		      </ul>
		    </nav>
		  </div>
		  <div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-pvlist"></div>
		  <div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-attributes"><p>body</p></div>
		  <!--<div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-macromaker"></div>-->
		  <div class="editWidgetAttributesPopup-footer" id="editWidgetAttributesPopup-footer"></div>
		</div>

		<datalist id="pvDatalist"></datalist>
		<p hidden id="mailbox"></p>
	</body>
</html>
