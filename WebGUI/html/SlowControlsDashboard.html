
<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Slow Controls Dashboard</title>

		<link rel="stylesheet" type="text/css" href="/WebPath/css/SlowControlsDashboard.css">

		<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/widgetLibrary.js"></script>
		<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>

		<script>

			//functions:
			//	init()
			//
			//	handleMouseDown(e)
			//	handleMouseUp(e)
			//	handleMouseMove(e)
			//	handleResize(e)
			//	redrawWindow(event, hover)
			//
			//	indicateUserActivityToServer()
			//
			//	--- BEGIN drawing widgets
			//
			//	drawWidget(widgetId, widgetType, xx, yy, width, height, hideFrame, alreadyInPageObject)
			//	toPageXCoordinate(x)
			//	toPageYCoordinate(y)
			//	toScaledXCoordinate(x)
			//	toScaledYCoordinate(y)
			//
			//	setupForDrawSelectionRectangle(id)
			//	drawSelectionRectangle(event)
			//	stopDragAndDrawRectangle(event)
			//
			//	startWidgetDrag(e,id)
			//	startWidgetResize(e,id)
			//	endWidgetDragAndResize(e,id)
			//
			//	redrawTargetWidget(e)
			//			
			//	--- END drawing widgets
			//
			//	checkMailbox()
			//	handleMail(mail)
			//	pagesReqHandler(req)
			//	isUserAdminHandler(req)
			//	pvListReqHandler(req)
			//	loadPageReqHandler(req)
			//	loadPhoebusPageReqHandler(req)
			//	pollServerHandlerFunction(req)
			//	generateUIDHandlerFunction(req)
			//	settingsReqHandler(req, passParams)
			//	historyReqHandler(req, passParams)
			//	savePageReqHandler(req)
			//	createControlsPageHandler(req)
			//	handlerFunction(req)
			//	pollServer()
			//	generateUID()
			//	updateRefreshInterval()
			//	loadPage(page)
			//	loadPhoebusPage(page)
			//	loadPageNewWindow(fullPathToPage)
			//	loadPageNewBrowserTab(fullPathToPage)
			//	createDesktopIcon(fullPathToPage)
			//	savePage()
			//	hidePopupSaveControlsPage()
			//	savePageAs()
			//	savePhoebusPageAs()
			//	setupWidget(id, parameters)
			//	setWidgetToolTip(pvName, pvValue, pvTime, pv_settings_)
			//	getHistory(id, parameters)
			//	addPVToWidget(pv, refreshRate, widgetID, fromAddPV)
			//	compareAttributes(id, parameters)
			//	mouseoverEditBlock(e)
			//	mouseoutEditBlock(e)
			//	toggleEditMode()
			//	makeHandlerWithID(id)
			//	toggleContextMenu(e, id)
			//	toggleContextMenuOff(e)
			//	toggleHotkeyMenu()
			//	toggleAddPV()
			//	toggleFileMenu()
			//	editWidgetAttributesOpen()
			//	editWidgetAttributesClose()
			//	editWidgetAttributesSave()
			//	editWidgetAttributesaddRowPVList(keyParam, valueParam, tablebody, list)
			//	checkIfMoreRowsNeeded(inputEl)
			//	setWidgetDisplayName(widget, displayName)
			//	showeditWidgetAttributesPopupBody(body)
			//	clearBlock(el)
			//	toggleGrid(on)
			//	setBackgroundColor(color)
			//	setGridColor(color, on)
			//	handleKeys(event)
			//	deleteWidget()
			//	cutWidget(widgetCover)
			//	pasteWidget()
			//	setEditModeWidgetTarget(target)	
			//	evaluateJS(str)
			//	setRefreshRate(keyField,rateField)
			//	isEmpty(obj)



			//top-level scope (global) variables:

			var page_ = page_ || {}; 	//define the page object if needed
										//	page_.widgets = {
										//		<widgetID> : <widget object := x, y, 
										//			w, h, pvList{}, attributes{},
										//			displayName, loaded,
										//			el /*iframe element*/
										//	} 

			//====================== start high-level behavior description
			//
			//	High-level description of page-widget interactions:
			//
			//	- widget's init() is called by 2: 
			//		1. widget's own onload() 
			//		2. top-level addPVToWidget()
			//	- In edit mode, user draws a widget square...		
			//		* immediately onload, widget should call init()
			//		* widget should call setupWidget() like this from init: 
			//				function init() { 	
			//					window.parent.setupWidget(window.frameElement.id, 
			//						getAttributes());   
			//				}
			//		* getAttributes() is defined by user widget and
			//			should describe user-editable fields for widget:
			//			- like { "param1" : "DEFAULT_VAL", "param2" : "" }
			//		* calling setupWidget() propagates parameters to the high-level page object
			//	- parent.setupWidget(): 
			//		* Note: this gets called by widget's init() (e.g. from onload)
			//		* setupWidget gives Top-level parameters that become user-editable
			//		* Then top-level gets PV settings (e.g. alarm thresholds) through server request based on widgets pvList
			//			and then propagates settings back to widget by calling... 
			//				- contentWindow.setupPVs(settings)
			//				- contentWindow.drawWidget(object)
			//	
			//
			//	- contentWindow.setupPVs(settings)
			//		* Pass alarm thresholds, etc associated with pvList to widget content
			//	- contentWindow.setAttributes(attributes)
			//		* Notify widget attributes have been changed
			//	- contentWindow.drawWidget(object, attributes)			
			//		* (re)Draw widget elements, based on attributes.
			//		* Note: called by window resize
			//
			//	Once we go Live, all widgets get PV values as available:
			//	- contentWindow.drawNewValue()
			//		* Update widget drawing based on new value (and append to history if needed)
			//
			//====================== end high-level behavior description
			
			var windowWidth_, windowHeight_;

			var pvList_ = {};
			var elPointer_ = {};
			var pagesList_ = [];
			var mainBlock_ = {name:"", isHidden:false, el:""}; // = ["mainBlock", false ];
			
			var PAGE_POSITIONS_ = 1000; //number of allowed integer locations (e.g. x,y,w,h for widgets) 
			var refreshRate_ = 15000; //set default to refresh every 15 seconds (ms)
			var timerVariable_;
			var UID_ = 0;
			var timeToPoll_ = false;
			var hiddenWidth_;
			var unhiddenWidth_;
			var mailbox_;
			var ADMIN_PERMISSION_THRESHOLD = 255;
			var userPermission = 10;
			
			//==== BEGIN file pane:
			var fileBlock_ = {name:"", isHidden:false, el:"", savePopup:""}; // = ["fileBlock", false ];

			var FILE_BLOCK_WIDTH = 300;
			//==== END file pane
			
			
			//==== BEGIN edit pane:
			var editBlock_ = {name:"", isHidden:true, el:""}; // = [false ];
			
			var EDIT_BLOCK_PEEK_HEIGHT = 40;
			var EDIT_BLOCK_HEIGHT = 300;
			//==== END edit pane
			

			//==== BEGIN Context Menu
			var menuState_ = 0;
			var menu_;
			var menuDiv_;
			var activeMenu_ = "menu--active";
			//==== END Context Menu

			var nav_;
			var gridColor_;
			var addPVMenuDiv_;
			var addPVMenu_;
			var isReadOnly_;
			page_.createPage = function(){

				this.name = "MyPage";
				this.widgets = {};
				this.addPV = function(pv){
					console.log("Reached " + pv);
				}
			}

			//==== BEGIN Drag and Resize parameters
			var xPos_;
			var yPos_;
			var drawingSelectionRectangle_ = false;
			var dragAndDrawTargetEl_ = undefined;			
			var dragAndDrawWidgetType_ = undefined;
			
			var resizeLockout_ = false;
			var resizeWidgetId_ = "";
			var resizeFrom_ = "";
			var saveCursorType_;
			
			var dragLockout_ = false;
			var targetElement_ = undefined;
			//==== END Drag and Resize
			
			var cutWidget_;
			var cutWidgetId_;

			
			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////


			//=====================================================================================
			//init called once body has loaded
			function init() 
			{

				Debug.log("init() was called");

				window.onkeyup = handleKeys;
				window.onkeydown = makeHandlerWithID(true/*isKeyDown*/,handleKeys);
				window.onresize = handleResize;
				
				var parameterPageName = DesktopContent.getParameter(0,"page_name");				

				Debug.log("Parameter filename: " + parameterPageName);

				fileBlock_.el = document.getElementById('fileBlock');//red
				fileBlock_.savePopup = document.getElementById('popupSaveControlsPage');
				mainBlock_.el = document.getElementById('mainBlock');//yellow
				editBlock_.el = document.getElementById('editBlock');//green
				page_.createPage;
				widgetLibrary.init;

				fileBlock_.name = fileBlock_.el.id;
				mainBlock_.name = mainBlock_.el.id;
				editBlock_.name = editBlock_.el.id;

				var datalist = document.getElementById("pvDatalist");//document.createElement("datalist");
				isReadOnly_ = false;

				elPointer_["addPVMenu"] = document.getElementById("addPVMenu");
				elPointer_["addPVMenuDiv"] = document.getElementById("addPVMenuDiv");
				elPointer_["editWidgetAttributesPopup-body-pvlist"] = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				elPointer_["editWidgetAttributesPopup-body-attributes"] = document.getElementById("editWidgetAttributesPopup-body-attributes");
			
				menuDiv_ = document.getElementById("contextMenuDiv");
				menu_= document.getElementById("contextMenu");
				mailbox_ = document.getElementById("mailbox");
				var myTimer = setInterval(checkMailbox, 1000);
				dragAndDrawWidgetType_ = undefined;

			 	DesktopContent.XMLHttpRequest(
                                	"Request?RequestType=getPages",
                                         "", 
                                         pagesReqHandler,
                                         0 /*reqParam*/, 
                                         0 /*progressHandler*/, 
                                         0 /*callHandlerOnErr*/, 
                                         true /*doNoShowLoadingOverlay*/);
				pagesList_ = "Loading";
				DesktopContent.XMLHttpRequest(
				                    "Request?RequestType=isUserAdmin",
				                    "",
				                    isUserAdminHandler);

				//get command string if opening a new window
				var cmdStr = DesktopContent.getParameter(2); //from  location.search
				if (cmdStr && cmdStr != "") {
					//do incoming commands!
					Debug.log("cmdStr=" + cmdStr);
					//replace %22 with "
					cmdStr = cmdStr.replace(/%22/g, "\"");
					//evaluateJS(cmdStr);
				}

				//get frame and set some text to loading
				var fileFrame = document.createElement("iframe");
				fileFrame.id = "fileFrame";
				fileFrame.src = "/WebPath/html/SlowControlsDashboardFileTree.html";
				fileFrame.style.height = "inherit";
				fileFrame.style.width = "inherit";
				fileBlock_.el.innerHTML = "";
				fileBlock_.el.style.border = "0";
				fileBlock_.el.appendChild(fileFrame);
				fileBlock_.isHidden = true;

				var editFrame = document.createElement("iframe");
				editFrame.id = "editFrame";
				editFrame.src = "/WebPath/html/SlowControlsDashboardEdit.html";
				editFrame.style.height = "inherit";
				editFrame.style.width = "inherit";
				editBlock_.el.innerHTML = "";
				editBlock_.el.style.border = "0";
				editBlock_.el.appendChild(editFrame);
				
				editBlock_.el.addEventListener("mouseover", mouseoverEditBlock, true);
				editBlock_.el.addEventListener("mouseleave", mouseoutEditBlock, true);

				//BEGIN JS Style
				mainBlock_.el.style["background-color"] = "rgb(255, 255, 255)";
				gridColor_ = "rgba(128, 128, 128, 0.3)"
				toggleGrid(true);
				console.log(("-" + fileBlock_.el.style.width));
				fileBlock_.el.style.left = "-4000px"; //hack because the file tree page probably didnt load by now
				editBlock_.el.style.bottom = "-4000px"; //hack because the edit page probably didnt load by now
				
				nav_ = document.getElementById("navigationMenu");
				nav_.classList.add("navigationMenu--active");
				//END JS Style

				Debug.log(parameterPageName);	

				//mainBlock_.el.removeEventListener("mousedown", startDrag, true);
				document.body.addEventListener("mousedown", handleMouseDown); //drawSelectionRectangle(id), false);
				document.body.addEventListener("mouseup", handleMouseUp);
				document.body.addEventListener("mousemove", handleMouseMove);

                handleResize(); //redraw window for first time
                
				if(parameterPageName == undefined)
			    {
                    toggleEditMode();
                }
                else
                {
                	Debug.log("Loading page from url");
                	//loadPage(parameterPageName);
                	loadPhoebusPage(parameterPageName);
                }
			} //end init()

			//=====================================================================================
			//indicate that login should be kept alive
			//	e.g. user is editing widgets in edit mode
			function indicateUserActivityToServer() 
			{
				Debug.log("indicateUserActivityToServer()");
				DesktopContent.XMLHttpRequest(
						"Request?RequestType=userActivityHeartbeat",
						"", 
						undefined /*returnHandler*/, 
						0 /*reqParam*/, 
						0 /*progressHandler*/, 
						0 /*callHandlerOnErr*/, 
						true /*doNoShowLoadingOverlay*/);	
			} //end indicateUserActivityToServer()

			//=====================================================================================
			function checkMailbox()
			{
				if(mailbox_.innerHTML != "")
				{
					Debug.log("There is new mail: " + mailbox_.innerHTML);
					var msg = mailbox_.innerHTML;
					mailbox_.innerHTML = "";
					handleMail(msg);
				}
			} //end checkMailbox()


			//=====================================================================================
			function handleMail(mail)
			{
                if(mail == "Save") {
                   savePage();
                }
                else
                {
                   Debug.log("Don't know what to do with mail: " + mail);
                }
			} //end  handleMail()


			//=====================================================================================
			function pagesReqHandler(req)
			{

				pagesList_ = []; //overwrite the loading text

				console.log(req.responseText);
				console.log(DesktopContent.getXMLValue(req, "JSON"));
				if(DesktopContent.getXMLValue(req, "JSON") != "[\"None\"]")
				{
					var pagesJSON = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));
					for(var x in pagesJSON)
					{
						//console.log(pagesJSON[x]);
						pagesList_.push(pagesJSON[x]);
					}
				}
				else
				{	
					console.log("No pages found in server!");
				}
			} //end pagesReqHandler()


			//=====================================================================================
			function isUserAdminHandler(req)
			{
				Debug.log("getPermissionHandler() was called. " + req.responseText);//Req: " + req.responseText);

				isAdmin = JSON.parse(decodeURIComponent(DesktopContent.getXMLValue(req, "JSON")))["message"];
				console.log("User Permission: " + isAdmin);
				console.log(isAdmin);

				if(isAdmin == "Yes")
				{
					isReadOnly_ = false;
				}
				else
				{
					isReadOnly_ = true;
				}

				console.log("Interface isReadOnly=" + isReadOnly_);
				redrawWindow();
			} //end isUserAdminHandler()


			//=====================================================================================
			function pvListReqHandler(req)
			{
				console.log("pvListReqHandler: response received!");	
				console.log(req.responseText);
				var datalist = document.getElementById("pvDatalist");
				datalist.innerHTML = "";

				var jsonStr = DesktopContent.getXMLValue(req, "JSON");
				if(!jsonStr || jsonStr == "") return;				
				var pvListJSON;

				//if invalid JSON return
				try {pvListJSON = JSON.parse(jsonStr); }
				catch(e){console.log("Invalid JSON!"); return;}

				console.log(pvListJSON);
				for (var x in pvListJSON)
				{
					pvList_[pvListJSON[x].substring(0,pvListJSON[x].indexOf(":"))] = pvListJSON[x].substring(pvListJSON[x].indexOf(":")+1,pvListJSON[x].length);
					var option = document.createElement("option");
					option.value = pvListJSON[x].substring(0,pvListJSON[x].indexOf(":"));
					datalist.appendChild(option);
				}
			} //end pvListReqHandler()


			//=====================================================================================
			function loadPageReqHandler(req)
			{
				Debug.log("loadPageReqHandler() was called. Req: " + req.responseText);

				for (var widget in page_.widgets)
				{
					delete page_.widgets[widget].el;
					delete page_.widgets[widget];
					var widgetCover = document.getElementById(widget + "-cover");
					mainBlock_.el.removeChild(widgetCover.parentNode);
				}

				clearBlock(mainBlock_.el);
				page_.widgets = {};

				if(!fileBlock_.isHidden)
					toggleFileMenu();

				var time = decodeURIComponent(DesktopContent.getXMLValue(req, "Time"));
				var notes = decodeURIComponent(DesktopContent.getXMLValue(req, "Notes"));
				var page = decodeURIComponent(DesktopContent.getXMLValue(req, "Page"));

				if(notes == "[\"Not Found\"]")
				{
					Debug.log("Page failed to load page(" + decodeURIComponent(page) + ") on server!",
					Debug.HIGH_PRIORITY);
					return;
				}

				if(page.length > 0)
					page_ = JSON.parse(page);

				Debug.log(time);
				Debug.log(notes);
				Debug.log(page);
				console.log(page_);

				for (var widgetId in page_.widgets)
				{
					console.log("Load widget from file: " + 
							widgetId, + " object:" + page_.widgets[widgetId]);
					
					drawWidget(
							widgetId, 
							undefined /*no new type*/, 
							undefined /*no new x*/, 
							undefined /*no new y*/, 
							undefined /*no new w*/, 
							undefined /*no new h*/, 
							true /*hideFrame*/);
				}

				//updateRefreshInterval();
				dragAndDrawWidgetType_ = undefined;
				drawingSelectionRectangle_ = false;

				toggleEditMode();
				redrawWindow();
			} //end loadPageReqHandler()


			//=====================================================================================
			var PHOEBUS_MAP = {"textupdate": 0, "table": 1, "meter": 2, "stripchart": 3, "thermometer": 4, "siren": 5, "label": 6, "led": 7, "picture": 8, "root": 9};
			function loadPhoebusPageReqHandler(req)
			{
				Debug.log("loadPageReqHandler() was called. Req: " + req.responseText);

				for (var widget in page_.widgets)
				{
					delete page_.widgets[widget].el;
					delete page_.widgets[widget];
					var widgetCover = document.getElementById(widget + "-cover");
					mainBlock_.el.removeChild(widgetCover.parentNode);
				}

				clearBlock(mainBlock_.el);
				page_.widgets = {};

				if(!fileBlock_.isHidden)
					toggleFileMenu();

				var phoebus = decodeURIComponent(DesktopContent.getXMLValue(req, "PHOEBUS"));
				var xml = ( new window.DOMParser() ).parseFromString(phoebus, "text/xml");
				console.log("loadPhoebusPageReqHandler(): xml document");
				console.log(xml);

				var widgets = xml.getElementsByTagName("widget");
				var groups = {};

				for(i=0; i<widgets.length; ++i)
				{
					var widgetObject = {};
					widgetObject.pvList = {};
					widgetObject.attributes = {};

					var type = PHOEBUS_MAP[ widgets[i].attributes["type"].nodeValue ];
					var group = -1;
					if (widgets[i].attributes["ots_group"] !== undefined) group = widgets[i].attributes["ots_group"].nodeValue;
					
					var displayName = widgets[i].getElementsByTagName("name")[0];
					var x = widgets[i].getElementsByTagName("x")[0];
					var y = widgets[i].getElementsByTagName("y")[0];
					var w = widgets[i].getElementsByTagName("width")[0];
					var h = widgets[i].getElementsByTagName("height")[0];
					var pv = widgets[i].getElementsByTagName("pv_name")[0];

					if (type !== undefined) widgetObject.type = type; else widgetObject.type = 0;
					if (displayName !== undefined) widgetObject.displayName = displayName.innerHTML; else widgetObject.displayName = "undefined";
					if (x !== undefined) widgetObject.x = x.innerHTML; else widgetObject.x = 10;
					if (y !== undefined) widgetObject.y = y.innerHTML; else widgetObject.y = 10;
					if (w !== undefined) widgetObject.w = w.innerHTML; else widgetObject.w = 50;
					if (h !== undefined) widgetObject.h = h.innerHTML; else widgetObject.h = 50;
					if (pv !== undefined)
					{
						var pv_refresh = pv.attributes["refresh_rate"];
						if (pv_refresh !== undefined) widgetObject.pvList[pv.innerHTML] = pv_refresh.nodeValue; else widgetObject.pvList[pv.innerHTML] = 10000;
					}

					if (type == 3)
					{
						var traces = widgets[i].getElementsByTagName("traces")[0];
						if (traces !== undefined)
						{
							var trace = xml.getElementsByTagName("trace");
							for(j=0; j<trace.length; ++j)
							{
								var y_pv = trace[j].getElementsByTagName("y_pv")[0];
								if (y_pv !== undefined)
								{
									var pv_refresh = y_pv.attributes["refresh_rate"];
									if (pv_refresh !== undefined) widgetObject.pvList[y_pv.innerHTML] = pv_refresh.nodeValue; else widgetObject.pvList[y_pv.innerHTML] = 10000;
								}
							}
						}
					}

					//attribute objects
					var label_class = widgets[i].getElementsByTagName("class")[0];
					var border = widgets[i].getElementsByTagName("border")[0];
					var text = widgets[i].getElementsByTagName("text")[0];
					var text_position = widgets[i].getElementsByTagName("text_position")[0];
					var font = widgets[i].getElementsByTagName("font")[0];
					var foreground_color = widgets[i].getElementsByTagName("foreground_color")[0];
					var transparent = widgets[i].getElementsByTagName("transparent")[0];
					var wrap_words = widgets[i].getElementsByTagName("wrap_words")[0];
					var file = widgets[i].getElementsByTagName("file")[0];

					//set attributes
					if (label_class !== undefined) widgetObject.attributes["class"] = label_class.innerHTML;
					if (border !== undefined) widgetObject.attributes["border"] = border.innerHTML;
					if (text !== undefined) widgetObject.attributes["text"] = text.innerHTML;
					if (text_position !== undefined) widgetObject.attributes["text_position"] = text_position.innerHTML;
					if (font !== undefined) widgetObject.attributes["font"] = font.innerHTML;
					if (foreground_color !== undefined) widgetObject.attributes["foreground_color"] = foreground_color.innerHTML;
					if (transparent !== undefined) widgetObject.attributes["transparent"] = transparent.innerHTML;
					if (wrap_words !== undefined) widgetObject.attributes["wrap_words"] = wrap_words.innerHTML;
					if (file !== undefined) widgetObject.attributes["file"] = file.innerHTML;

					widgetObject.loaded = true;
					widgetObject.el = "";

					if (group !== -1)
					{
						for (j=0; j<i; ++j)
						{
							if (   page_.widgets["widget" + j] !== undefined 
								&& page_.widgets["widget" + j].type == widgetObject.type 
							    && page_.widgets["widget" + j].displayName == widgetObject.displayName
							    && displayName !== undefined
							    && groups["widget" + j] == group)
							{
								if (pv !== undefined) page_.widgets["widget" + j].pvList[pv.innerHTML] = 30000;
								groups["widget" + i] = group;
							}
						}
						if (groups["widget" + i] == undefined)
						{
							page_.widgets["widget" + i] = widgetObject;
							groups["widget" + i] = group;
						}
					}
					else
						page_.widgets["widget" + i] = widgetObject;
				}

				var time =  xml.getElementsByTagName("time");
				var notes = xml.getElementsByTagName("notes");

				if(notes.innerHTML == "[\"Not Found\"]")
				{
					Debug.log("Page failed to load page(" + decodeURIComponent(page) + ") on server!",
					Debug.HIGH_PRIORITY);
					return;
				}

				console.log("loadPhoebusPageReqHandler(): page_.widgets");
				console.log(page_.widgets);
				console.log("loadPhoebusPageReqHandler(): groups");
				console.log(groups);

				for (var widget in page_.widgets)
				{
					console.log(widget + " " + page_.widgets[widget].x + " " + page_.widgets[widget].y + " " + page_.widgets[widget].w + " " + page_.widgets[widget].h);
					drawWidgetFromFile(widget, page_.widgets[widget].x, page_.widgets[widget].y, page_.widgets[widget].w, page_.widgets[widget].h, true);
				}

				//updateRefreshInterval();
				dragAndDrawWidgetType_ = undefined;
				drawingSelectionRectangle_ = false;

				toggleEditMode();
				redrawWindow();
			} //end loadPhoebusPageReqHandler()


			//=====================================================================================
			function pollServerHandlerFunction(req)
			{
				Debug.log("pollServerHandlerFunction() was called. Req: " + req.responseText);

 				var jsonStr = DesktopContent.getXMLValue(req, "JSON");
				jsonStr = jsonStr.replace(/\s/g, ''); //hack for removing whitespace 
    			if(!jsonStr || jsonStr == "") 
					return;

				Debug.log(jsonStr);

				var serverResponse;

				serverResponse = JSON.parse(jsonStr);

				Debug.log(serverResponse);

				if(serverResponse.message == "NOT_FOUND")
				{
					console.log("Have to generate new UID!");
					generateUID();
					timeToPoll_ = true;
				}
				else
				{
					for(var pv in serverResponse)//have to use each pv and then loop through
					{	
						console.log("pollServerHandlerFunction: pv" + pv);						
						for (var widget in page_.widgets)
						{
							console.log("pollServerHandlerFunction: " + page_.widgets[widget]);
							for(var dependendentPV in page_.widgets[widget].pvList)
							{
								console.log("poll: " + dependendentPV);
								if(pv == dependendentPV && page_.widgets[widget].loaded != "false")
								{
									console.log("Widget*************", widget, pv);
									document.getElementById("widget-" + 
										widget).contentWindow.drawNewValue(
											pv, 
											serverResponse[pv].Value, 
											serverResponse[pv].Timestamp, 
											serverResponse[pv].Status, 
											serverResponse[pv].Severity);
								}
							}
						}
					}
				}
			} //end pollServerHandlerFunction()

			//=====================================================================================
			function generateUIDHandlerFunction(req)
			{
				var uid = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));

				if(uid.message != "-1")
					UID_ = uid.message;
				else
				{
					UID_ = "";
					Debug.log("Unable to generate UID!", Debug.HIGH_PRIORITY);
				}

				if(timeToPoll_)
				{
					timeToPoll_ = false;
					pollServer();
				}
			} //end generateUIDHandlerFunction()

			//=====================================================================================
			function settingsReqHandler(req, passParams)
			{
				var settings = JSON.parse(DesktopContent.getXMLValue(req, "JSON"));				
				var id = passParams[0]|0; //force integer
				var attributes = passParams[1];

				console.log("id:",id," attributes:", attributes);

				console.log(req);
				console.log(settings);
				console.log(id);

				page_.widgets[id].el.contentWindow.setupPVs(settings);
				page_.widgets[id].el.contentWindow.drawWidget(page_.widgets[id], attributes);

			} //end settingsReqHandler()

			//=====================================================================================
			function historyReqHandler(req, passParams) 
			{
				var jsonArr = req.responseXML.getElementsByTagName("JSON");
				console.log(jsonArr);

				for (var i = jsonArr.length - 1; i >= 0; i--){
					var history = JSON.parse(DesktopContent.getXMLValue(jsonArr[i]));				
					var id = passParams[0];
					var parameters = passParams[1];
					console.log("id: " + id + " parameter: " + parameters);

					console.log(req);
					console.log(history);
					console.log(id);
					for (var pv in history) {
						console.log(pv);
						console.log(history[pv].Timestamp + " " + history[pv].Value);
						page_.widgets[id].el.contentWindow.drawNewValue(pv, history[pv].Value, history[pv].Timestamp, history[pv].Status, history[pv].Severity);
					}
				}
			} //end historyReqHandler()

			//=====================================================================================
			function savePageReqHandler(req)
			{
				var response = req.responseText;
				Debug.log(response);
			} //end savePageReqHandler()

			//=====================================================================================
			function createControlsPageHandler(req)
			{
				Debug.log("createControlsPageHandler() was called for " + controlsPageName);// Req: " + req.responseText);
				Debug.log("Your page was succesfully saved!",Debug.INFO_PRIORITY);		
			} //end createControlsPageHandler()

			//=====================================================================================
			function handlerFunction(req) 
			{
				var child1data = DesktopContent.getXMLValue(req,"child");
				var child2data = DesktopContent.getXMLValue(req,"child2");
				Debug.log("--child1data:",child1data," --child2data:",child2data);
			} //end handlerFunction()

			//=====================================================================================
			function pollServer()
			{
				timeToPoll_ = false;
				Debug.log("pollServer: polling server!");
				console.log("pollServer(): " + page_.widgets);
				//console.log("UID is ", UID_);
				if(page_.widgets !== undefined)
				{
					DesktopContent.XMLHttpRequest(
					  "Request?RequestType=poll&uid=" + UID_,
					  "", 
					  pollServerHandlerFunction /*returnHandler*/, 
					  0 /*reqParam*/, 
					  0 /*progressHandler*/, 
					  0 /*callHandlerOnErr*/, 
					  true /*doNoShowLoadingOverlay*/);	
				}
			} //end pollServer()

			//=====================================================================================
			function generateUID()
			{
				//BEGIN Put all pvs in a JSON and send to server
				var pvList = "";
				//console.log("page: ", page_);
				for (var widget in page_.widgets)
				{
					console.log("generateUID: " +  page_.widgets[widget] + " " +  page_.widgets[widget].pvList);

					for(var pv in page_.widgets[widget].pvList)
					{
						pvList += pv + ":"  + page_.widgets[widget].pvList.valueOf()[pv] + ",";
					}
				}

				console.log(pvList);

				//END Put all pvs in a JSON and send to server
				DesktopContent.XMLHttpRequest("Request?RequestType=generateUID","pvList=" + pvList, generateUIDHandlerFunction);//, undefined, undefined, "sequence");
			} //end generateUID()

			//=====================================================================================
			function updateRefreshInterval()
			{
				console.log("updateRefreshInterval.refreshRate_ (ms): " + refreshRate_);
				window.clearInterval(timerVariable_);
				timerVariable_ = setInterval(pollServer, refreshRate_);
			} //end updateRefreshInterval()

			//=====================================================================================
			function loadPage(page)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=loadPage&Page=" + page, "", loadPageReqHandler);//, undefined, undefined, "sequence");
			} //end loadPage()

			//=====================================================================================
			function loadPhoebusPage(page)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=loadPhoebusPage&Page=" + page, "", loadPhoebusPageReqHandler);//, undefined, undefined, "sequence");
			} //end loadPhoebusPage()

			//=====================================================================================
			function loadPageNewWindow(fullPathToPage)
			{
				var newWindowStr = location.pathname + location.search
				+ "&page_name=" + fullPathToPage;

				DesktopContent.openNewWindow("Controls Dashboard", "", newWindowStr, false /*unique*/);
			} //end loadPageNewWindow()

			//=====================================================================================
			function loadPageNewBrowserTab(fullPathToPage)
			{
				var newWindowStr = location.pathname + location.search
				+ "&page_name=" + fullPathToPage;

				DesktopContent.openNewBrowserTab("Controls Dashboard","", newWindowStr ,false /*unique*/);
			} //end loadPageNewBrowserTab()

			//=====================================================================================
			//CreateDesktopIcon page loader~~
			function createDesktopIcon(fullPathToPage)
			{
				DesktopContent.addDesktopIcon(
					fullPathToPage
					,"CTRLS","Slow Control Subsets"
					, false /*unique*/
					, 255 /*permissionsString*/
					, "icon-ControlsDashboard.png" /*imageURL*/
					, "SlowControlsDashboard.html?urn=" /*windowContentURL*/
					, "ots::SlowControlsDashboardSupervisor" /*linkedApp*/
					, /*parameters*/
					"page_name=" + fullPathToPage
					);
			} //end CreateDesktopIcon

			//=====================================================================================
			function savePage() 
			{
				//Conditions to stop page saving e.g. blank page, using illegal pvs, etc Or overwrite?
				if(false)
					Debug.log("No reason to save a blank page!");
    			else
    			{
					console.log("Showing save popup");
		       		fileBlock_.savePopup.style.display = "block";
		       		fileBlock_.savePopup.style["z-index"] = "9000";
					if (userPermission == ADMIN_PERMISSION_THRESHOLD)
			       		document.getElementById("makeControlsPagePublic").style.display = "block";
    			}
			} //end savePage()

			//=====================================================================================
			function hidePopupSaveControlsPage()
			{
		        fileBlock_.savePopup.style.display = "none";
		        fileBlock_.savePopup.style["z-index"] = "0";
		        document.getElementById("controlsPageName").value="";
	            document.getElementById("controlsPageNotes").value="";
		        Debug.log("Controls Page successfully saved!");
			} //end hidePopupSaveControlsPage()

			//=====================================================================================
			function savePageAs()
			{
	            var controlsPageName = document.getElementById("controlsPageName").value;
	            console.log("Here is our name: " + controlsPageName);
	            var Regex = /^[a-zA-Z0-9\_]+$/g;
	            if (!Regex.test(controlsPageName)) 
		        	Debug.log("Illegal characters in name. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
	    		else
	    		{
    		        var controlsPageNotes = document.getElementById("controlsPageNotes").value;
    		        Debug.log(controlsPageNotes);

					if(controlsPageNotes.indexOf("@") >= 0 || controlsPageNotes.indexOf("#") >= 0 || controlsPageNotes.indexOf("..") >= 0)
					{
				         Debug.log("Illegal characters in notes. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
				         return;
					}

	    			var controlsPageLibEl = document.getElementById('listOfPrivateControlsPages');
	    			var isControlsPagePublic = document.getElementById("isControlsPagePublic").checked;

					var pagetosave = Object.assign({}, page_)
	    			for (var widget in pagetosave.widgets)
					{
						pagetosave.widgets[widget].x = page_.widgets[widget].x;// * windowWidth_ / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].y = page_.widgets[widget].y;// * windowHeight_ / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].w = page_.widgets[widget].w;// * windowWidth_ / (PAGE_POSITIONS_) | 0;
						pagetosave.widgets[widget].h = page_.widgets[widget].h;// * windowHeight_ / (PAGE_POSITIONS_) | 0;
					}

	    			var pageString = JSON.stringify(pagetosave);

	        		if(pagesList_.indexOf(controlsPageName) !== -1) //duplicate name
	        		{
	    				Debug.log("ControlsPage name already exists!");

	    				document.getElementById('popupControlsPageAlreadyExistsOverwrite').onclick = function(){ //call edit
	    					DesktopContent.XMLHttpRequest("Request?RequestType=editControlsPage",
	    						//post data
	    						"isPublic=" + isControlsPagePublic +
								"&oldControlsPageName=" + controlsPageName +
								"&newControlsPageName=" + controlsPageName +
								"&Page=" + pageString +
								"&Time=" + Date().toString() +
								"&Notes=" + encodeURIComponent(controlsPageNotes),
								saveChangedControlsPageHandler /*handler*/,
								controlsPageName /*parameter*/);};
	        		}
	        		else
	        		{
				        DesktopContent.XMLHttpRequest("Request?RequestType=createControlsPage",
							//post data
							"isPublic=" + isControlsPagePublic +
							"&Name=" + controlsPageName +
							"&Page=" + pageString +
							"&Time=" + Date().toString() +
							"&Notes=" + encodeURIComponent(controlsPageNotes),
							createControlsPageHandler /*handler*/);

						hidePopupSaveControlsPage();
	        		}
    			}
			} //end savePageAs()

			//=====================================================================================
			function savePhoebusPageAs()
			{
	            var controlsPageName = document.getElementById("controlsPageName").value;
	            console.log("Here is our name: " + controlsPageName);
	            var Regex = /^[a-zA-Z0-9\_]+$/g;
	            if (!Regex.test(controlsPageName)) 
		        	Debug.log("Illegal characters in name. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
	    		else
	    		{
    		        var controlsPageNotes = document.getElementById("controlsPageNotes").value;
    		        Debug.log(controlsPageNotes);

					if(controlsPageNotes.indexOf("@") >= 0 || controlsPageNotes.indexOf("#") >= 0 || controlsPageNotes.indexOf("..") >= 0)
					{
				         Debug.log("Illegal characters in notes. Please remove these characters and try again.", Debug.HIGH_PRIORITY);
				         return;
					}

	    			var controlsPageLibEl = document.getElementById('listOfPrivateControlsPages');
	    			var isControlsPagePublic = document.getElementById("isControlsPagePublic").checked;

					var pageString = document.implementation.createDocument("", "", null);
					var display = pageString.createElement("display");
					var nm = pageString.createElement("name");
					nm.innerHTML = "Display";
					display.appendChild(nm);

					var group = 0;
	    			for (var widgetId in page_.widgets)
					{
						if(isEmpty(page_.widgets[widgetId].pvList))
						{
							var widget = pageString.createElement("widget");
							var type = Object.keys(PHOEBUS_MAP).find(key => PHOEBUS_MAP[key] === page_.widgets[widgetId].type);
							widget.setAttribute("type", type);
							widget.setAttribute("version",	"2.0.0");
							var name = pageString.createElement("name");
							var x = pageString.createElement("x");
							var y = pageString.createElement("y");
							var width = pageString.createElement("width");
							var height = pageString.createElement("height");

							name.innerHTML = page_.widgets[widgetId].displayName;
							widget.appendChild(name);

							//attribute objects
							for (var attr in page_.widgets[widgetId].attributes)
							{
								var attribute = pageString.createElement(attr);
								attribute.innerHTML = page_.widgets[widgetId].attributes[attr];
								if (attribute.innerHTML !== "undefined") widget.appendChild(attribute);
							}

							x.innerHTML = toPageXCoordinate(page_.widgets[widgetId].x);//page_.widgets[widgetId].x * windowWidth_ / (PAGE_POSITIONS_) | 0;
							y.innerHTML = toPageYCoordinate(page_.widgets[widgetId].y);//page_.widgets[widgetId].y * windowHeight_ / (PAGE_POSITIONS_) | 0;
							width.innerHTML = toPageXCoordinate(page_.widgets[widgetId].w);//page_.widgets[widgetId].w * windowWidth_ / (PAGE_POSITIONS_) | 0;
							height.innerHTML = toPageYCoordinate(page_.widgets[widgetId].h);//page_.widgets[widgetId].h * windowHeight_ / (PAGE_POSITIONS_) | 0;
							widget.appendChild(x);
							widget.appendChild(y);
							widget.appendChild(width);
							widget.appendChild(height);

							display.appendChild(widget);
						}
						else
						{
							var type = Object.keys(PHOEBUS_MAP).find(key => PHOEBUS_MAP[key] === page_.widgets[widgetId].type);

							if (type =="stripchart")
							{
								var widget = pageString.createElement("widget");
								widget.setAttribute("type", type);
								widget.setAttribute("version",	"2.0.0");

								var name = pageString.createElement("name");
								var x = pageString.createElement("x");
								var y = pageString.createElement("y");
								var width = pageString.createElement("width");
								var height = pageString.createElement("height");
								name.innerHTML = page_.widgets[widgetId].displayName;
								widget.appendChild(name);

								x.innerHTML = toPageXCoordinate(page_.widgets[widgetId].x);//page_.widgets[widgetId].x * windowWidth_ / (PAGE_POSITIONS_) | 0;
								y.innerHTML = toPageYCoordinate(page_.widgets[widgetId].y);//page_.widgets[widgetId].y * windowHeight_ / (PAGE_POSITIONS_) | 0;
								width.innerHTML = toPageXCoordinate(page_.widgets[widgetId].w);//page_.widgets[widgetId].w * windowWidth_ / (PAGE_POSITIONS_) | 0;
								height.innerHTML = toPageYCoordinate(page_.widgets[widgetId].h);//page_.widgets[widgetId].h * windowHeight_ / (PAGE_POSITIONS_) | 0;

								widget.appendChild(x);
								widget.appendChild(y);
								widget.appendChild(width);
								widget.appendChild(height);

								var traces = pageString.createElement("traces");

								for (var pv_name in page_.widgets[widgetId].pvList)
								{
									var trace = pageString.createElement("trace");

									var pv = pageString.createElement("y_pv");
									var pv_refresh = page_.widgets[widgetId].pvList[pv_name];
									pv.setAttribute("refresh_rate", pv_refresh);
									pv.innerHTML = pv_name;
									trace.appendChild(pv);

									//attribute objects
									for (var attr in page_.widgets[widgetId].attributes)
									{
										var attribute = pageString.createElement(attr);
										attribute.innerHTML = page_.widgets[widgetId].attributes[attr];
										if (attribute.innerHTML !== "undefined") trace.appendChild(attribute);
									}

									traces.appendChild(trace);
								}

								widget.appendChild(traces);
								display.appendChild(widget);
							}
							else
							{
							var counter = 0;
							for (var pv_name in page_.widgets[widgetId].pvList)
								{
									var widget = pageString.createElement("widget");
									widget.setAttribute("type", type);
									widget.setAttribute("version",	"2.0.0");
									if (Object.getOwnPropertyNames(page_.widgets[widgetId].pvList).length > 1) widget.setAttribute("ots_group", group);
									var name = pageString.createElement("name");
									var pv = pageString.createElement("pv_name");
									var x = pageString.createElement("x");
									var y = pageString.createElement("y");
									var width = pageString.createElement("width");
									var height = pageString.createElement("height");

									name.innerHTML = page_.widgets[widgetId].displayName;
									widget.appendChild(name);
									var pv_refresh = page_.widgets[widgetId].pvList[pv_name];
									pv.setAttribute("refresh_rate", pv_refresh);
									pv.innerHTML = pv_name;
									widget.appendChild(pv);

									//attribute objects
									for (var attr in page_.widgets[widgetId].attributes)
									{
										var attribute = pageString.createElement(attr);
										attribute.innerHTML = page_.widgets[widgetId].attributes[attr];
										if (attribute.innerHTML !== "undefined") widget.appendChild(attribute);
									}

									x.innerHTML = toPageXCoordinate(page_.widgets[widgetId].x);//page_.widgets[widgetId].x * windowWidth_ / (PAGE_POSITIONS_) | 0;
									y.innerHTML = toPageYCoordinate(page_.widgets[widgetId].y);//page_.widgets[widgetId].y * windowHeight_ / (PAGE_POSITIONS_) | 0;
									width.innerHTML = toPageXCoordinate(page_.widgets[widgetId].w);//page_.widgets[widgetId].w * windowWidth_ / (PAGE_POSITIONS_) | 0;
									height.innerHTML = toPageYCoordinate(page_.widgets[widgetId].h);//page_.widgets[widgetId].h * windowHeight_ / (PAGE_POSITIONS_) | 0;
									x.innerHTML = parseInt(x.innerHTML) + counter *(parseInt(width.innerHTML) + 2);

									widget.appendChild(x);
									widget.appendChild(y);
									widget.appendChild(width);
									widget.appendChild(height);

									display.appendChild(widget);
									counter++;
								}
								if (Object.getOwnPropertyNames(page_.widgets[widgetId].pvList).length > 1) group++;
							}
						}
					}

					var controlsPageNotes = document.getElementById("controlsPageNotes").value;

					pageString.appendChild(display);
					var pheobusXml =  "<?xml version='1.0' encoding='UTF-8'?>\n"
									+ "<display version='2.0.0'>\n"
									+ pageString.firstChild.innerHTML + "\n"
									+ "<notes>\n" + controlsPageNotes + "\n"
									+ "</notes>\n"
									+ "<time>\n"
									+ Date().toString() + "\n"
									+ "</time>\n"
									+ "</display>";
					console.log("savePhoebusPageAs():\n",encodeURIComponent(pheobusXml));

					if(pagesList_.indexOf(controlsPageName) !== -1) //duplicate name
					{
						Debug.log("ControlsPage name already exists!");

						document.getElementById('popupControlsPageAlreadyExistsOverwrite').onclick = function(){ //call edit
						DesktopContent.XMLHttpRequest("Request?RequestType=editControlsPage",
									//post data
									"isPublic=" + isControlsPagePublic +
									"&oldControlsPageName=" + controlsPageName +
									"&newControlsPageName=" + controlsPageName +
									"&Page=" + pheobusXml +
									saveChangedControlsPageHandler /*handler*/,
									controlsPageName /*parameter*/);};
					}
					else
					{
						DesktopContent.XMLHttpRequest("Request?RequestType=createPhoebusControlsPage",
									//post data
									"isPublic=" + isControlsPagePublic +
									"&Name=" + controlsPageName +
									"&Page=" + pheobusXml,
									createControlsPageHandler /*handler*/);

						hidePopupSaveControlsPage();
					}
    			}
			} //end savePhoebusPageAs()

			//=====================================================================================
			//	expecting id as 'widget-#' ..and this function extracts the 
			//	widget UID as integer #
			function setupWidget(id, parameters)
			{
				console.log("setting up widget! " + id);
				id = id.split('-')[1];
				
				if(page_.widgets[id] === undefined)
				{
					Debug.log("Illegal widget UID (not found in widget list) received from child widget frame: " + 
							id, Debug.HIGH_PRIORITY);
					return;
				}
				
				page_.widgets[id].loaded = true;
				//if(page_.widgets[id].attributes === undefined)
				//{
				//	page_.widgets[id].attributes = parameters;
				//}
				//else
				//{
					compareAttributes(id, parameters);
				//}
					
				//now page_.widgets[id].attributes is merged
				console.log("page_.widgets[id].attributes", page_.widgets[id].attributes);
					
				var pvListCSV = "";

				console.log("page_.widgets[id].pvList", page_.widgets[id].pvList);
				for(var pv in page_.widgets[id].pvList)
				{
					pvListCSV += pv + ",";
				}

				var passParams = [id, page_.widgets[id].attributes];	
				DesktopContent.XMLHttpRequest("Request?RequestType=getPVSettings",
							//post data 
    						"pvList=" + pvListCSV + 
							"&id=" + id,
							settingsReqHandler /*handler*/,
							passParams /*parameter*/);

			} //end setupWidget()

			//=====================================================================================
			function setWidgetToolTip(pvName, pvValue, pvTime, pv_settings_)
			{
				var toolTip =
				pvName
				+ "\nlast value: "
				+ pvValue
				+ " "
				+ pv_settings_[pvName].Units
				+ "\ntime: "
				+ ConfigurationAPI.getDateString(new Date((pvTime | 0) * 1000))
				+ "\nLower Warning Limit:  " + Number.parseFloat(pv_settings_[pvName].Lower_Warning_Limit).toExponential(2) + "\n"
			  	+ "Upper Warning Limit:  "   + Number.parseFloat(pv_settings_[pvName].Upper_Warning_Limit).toExponential(2) + "\n"
			  	+ "Lower Alarm Limit:    "   + Number.parseFloat(pv_settings_[pvName].Lower_Alarm_Limit).toExponential(2)   + "\n"
			  	+ "Upper Alarm Limit:    "   + Number.parseFloat(pv_settings_[pvName].Upper_Alarm_Limit).toExponential(2)   + "\n"
			  	+ "Lower Control Limit:   "   + Number.parseFloat(pv_settings_[pvName].Lower_Control_Limit).toExponential(2) + "\n"
			  	+ "Upper Control Limit:   "   + Number.parseFloat(pv_settings_[pvName].Upper_Control_Limit).toExponential(2) + "\n"
			  	+ "Lower Display Limit:   "   + Number.parseFloat(pv_settings_[pvName].Lower_Display_Limit).toExponential(2) + "\n"
			  	+ "Upper Display Limit:   "   + Number.parseFloat(pv_settings_[pvName].Upper_Display_Limit).toExponential(2) + "\n";
			  	return toolTip;
			} //end setWidgetToolTip()

			//=====================================================================================
			function setWidgetPVinfo(pvName, pvValue, pvTime, pvStatus, pvSeverity, showLabel, containers, widgetElement)
			{
				var now = Math.floor(Date.now())/1000;
				var time2compare = pvTime*1. + 240.;

				if (containers !== null && containers[pvName] !== null)
					if (showLabel == "true")
					{
						if(pvSeverity == "MAJOR" )
							containers[pvName].innerHTML = "<center style = 'color: red'>" + pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />") + "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity + "</center>";
						else if(pvSeverity == "MINOR")
							containers[pvName].innerHTML = "<center style = 'color: orange'>" + pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />") + "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity + "</center>";
						else
							if ((pvTime !== undefined) && (time2compare > now))
								containers[pvName].innerHTML = "<center style = 'color: green'>" + pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />") + "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity + "</center>";
							else
								containers[pvName].innerHTML = "<center style = 'color: grey'>"
																+ pvName.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />")
																//+ "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity
																+ "<br>NOT UPDATED FOR MORE THAN " + parseInt((now - pvTime*1.)/60) + " MINUTES</center>";
					}
					else
						containers[pvName].innerHTML = "<center>";

				console.log("thermometer date now: " + now + " pvtime: " + pvTime + " refresh rate: 10 sec");
				if (widgetElement !== null)
					if ((pvTime !== undefined) && (time2compare > now))
						widgetElement.style.backgroundColor = 'white';
					else
						widgetElement.style.backgroundColor = 'lightgrey';
				else
					console.log("setWidgetPVinfo(): Error widgetElement = null");
			} //end setWidgetPVinfo()

			//=====================================================================================
			function getHistory(id, parameters)
			{
				var pvList = "";

				for(var pv in page_.widgets[id].pvList)
				{
					pvList += pv + ",";
				}

				var passParams = [id, parameters];
				DesktopContent.XMLHttpRequest("Request?RequestType=getPVArchiverData",
									//post data 
		    						"pvList=" + pvList + 
									"&id=" + id,
									historyReqHandler /*handler*/,
									 passParams /*parameter*/);
				console.log("get history for widget! pvList: " + pvList);
			} //end getHistory()

			//=====================================================================================
			function addPVToWidget(pv, refreshRate, widgetID, fromAddPV)
			{
				if(fromAddPV){toggleAddPV();}
				page_.widgets[widgetID].pvList[pv] = refreshRate;
				page_.widgets[widgetID].el.contentWindow.init();
				//newWidget_ = true;
			} //end addPVToWidget()

			//=====================================================================================
			function compareAttributes(id, parameters)
			{
				var actionRequired = false;

				for(var attribute = 0; attribute < Object.keys(page_.widgets[id].attributes).length; attribute++)
				{
					if(Object.keys(parameters).indexOf(Object.keys(page_.widgets[id].attributes)[attribute]) == -1)
					{
						//Debug.log("Attribute [" + Object.keys(page_.widgets[id].attributes)[attribute] + "] for " + page_.widgets[id].displayName + " is no longer required. No action required.", Debug.HIGH_PRIORITY);
					}
				}

				var attributesNew = {};

				for(attribute = 0; attribute < Object.keys(parameters).length; attribute++)
				{
					if(Object.keys(page_.widgets[id].attributes).indexOf(Object.keys(parameters)[attribute]) != -1)
					{
						attributesNew[Object.keys(parameters)[attribute]] = page_.widgets[id].attributes[Object.keys(parameters)[attribute]];
					}
					else
					{
						actionRequired = true;

						if (parameters[Object.keys(parameters)[attribute]] == "")
							attributesNew[Object.keys(parameters)[attribute]] = 'undefined';
						else
							attributesNew[Object.keys(parameters)[attribute]] = parameters[Object.keys(parameters)[attribute]];

						//Debug.log("Attribute [" + Object.keys(parameters)[attribute] + "] for " + page_.widgets[id].displayName + " is now a required attribute. Action Required.", Debug.HIGH_PRIORITY);
					}
				}
				page_.widgets[id].attributes = attributesNew;
				//if(actionRequired)
					//document.getElementById(id).className = "action-required";
			} //end compareAttributes()

			//=====================================================================================
			//This function is called by edit pane code when
			//	a widget is selected for edit mode drawing.
			function setupForDrawSelectionRectangle(id)
			{
				Debug.log("parent level setupForDrawSelectionRectangle " + id);

				indicateUserActivityToServer();		
				
				if(id === undefined)
				{
					//treat as clearing drag and draw type mode
					mainBlock_.el.style.cursor = "default"; 
					dragAndDrawWidgetType_ = undefined;
				}
				else //drag-and-draw type was selected
				{
					//crosshair primary indicator to user that draw and drag is active
					mainBlock_.el.style.cursor = "crosshair";								
					dragAndDrawWidgetType_ = id|0; //force integer type id
				}
				
			} //end setupForDrawSelectionRectangle()

			//=====================================================================================
			function drawSelectionRectangle(event)
			{
				if(dragAndDrawWidgetType_  === undefined)
				{
					Debug.log("Impossible undefined widget draw type! Notify admins.", Debug.HIGH_PRIORITY);
					return;
				}
				var type = dragAndDrawWidgetType_;
				drawingSelectionRectangle_  = true;

				Debug.log("drawSelectionRectangle() " + type);

				xPos_ = event.clientX;
				yPos_ = event.clientY;

				var selectionRectangle = document.getElementById("selectionRectangle");
				selectionRectangle.style.top = event.clientY + "px";
				selectionRectangle.style.left = event.clientX + "px";	

				if(widgetLibrary.dimensions[type])
				{
					console.log("selectionRectangle type:" + type);
					if(widgetLibrary.dimensions[type]["X"])
					{
						console.log("Has a specified width");
						selectionRectangle.style.width = (widgetLibrary.dimensions[type]["X"] + "px");
					}
					else
					{
						selectionRectangle.style.width = "1px";
					}

					if(widgetLibrary.dimensions[type]["Y"])
					{
						console.log("Has a specified height");
						selectionRectangle.style.height = (widgetLibrary.dimensions[type]["Y"] + "px");
					}
					else
					{
						selectionRectangle.style.height = "1px";
					}

					if(widgetLibrary.dimensions[type]["Scale"] != "False")
					{
						console.log("Widget is scalable");
					}	
				}
				else //Default - no aspect ratio, no min size, 
				{
					selectionRectangle.style.height = "1px";
					selectionRectangle.style.width = "1px";
				}

				selectionRectangle.style.display = "block";
			} //end drawSelectionRectangle()

			//=====================================================================================
			function redrawSelectionRectangle(event) 
			{
				var type = dragAndDrawWidgetType_;
				//Debug.log("redrawSelectionRectangle() " + type);

				var drawAndDragBox = document.getElementById("selectionRectangle");

				var x = xPos_;
				var y = yPos_;
				var w = (event.clientX - xPos_);
				var h = (event.clientY - yPos_);
				if(w < 0)
				{
					x = event.clientX;
					w *= -1;
				}
				if(h < 0)
				{
					y = event.clientY;
					h *= -1;
				}
					

				drawAndDragBox.style.left = x + "px";
				drawAndDragBox.style.top = y + "px";	
				
				if(widgetLibrary.dimensions[type] && 
						widgetLibrary.dimensions[type]["Y"] && 
						widgetLibrary.dimensions[type]["X"])
				{ //if forced aspect ratio, then maintain aspect ratio
					
					var aspect_ratio = parseFloat(widgetLibrary.dimensions[type]["X"]) /
							parseFloat(widgetLibrary.dimensions[type]["Y"]);


					if((h > widgetLibrary.dimensions[type]["Y"]) ||
							(w > widgetLibrary.dimensions[type]["X"]))
					{
						var adjusted_y_displacement = h * aspect_ratio;

						if(adjusted_y_displacement >= w)
						{
							drawAndDragBox.style.width = parseFloat(y_displacement * aspect_ratio) + "px";
							drawAndDragBox.style.height = h + "px";						
						}
						else
						{							
							drawAndDragBox.style.width = w + "px";
							drawAndDragBox.style.height = parseFloat(x_displacement / aspect_ratio) + "px";					
						}
					}
				}
				else //free draw, no aspect constraint
				{					
					drawAndDragBox.style.width = w + "px";
					drawAndDragBox.style.height = h + "px";						
				}
			} //end redrawSelectionRectangle()

			//=====================================================================================
			function stopDragAndDrawRectangle(event) 
			{
				var type = dragAndDrawWidgetType_;
				Debug.log("stopDragAndDrawRectangle() " + type);
				
				var drawAndDragBox = document.getElementById("selectionRectangle");
			

				//console.log((event.clientX - xPos_));
				//console.log(drawAndDragBox.style.width);
				
				var x,y,w,h;
				x = drawAndDragBox.offsetLeft;
				y = drawAndDragBox.offsetTop;
				
				//if widget attribute Scale is set to false, then always a fixed size
				if(widgetLibrary.dimensions[type] &&
						widgetLibrary.dimensions[type]["Scale"] && 
						widgetLibrary.dimensions[type]["Scale"].toLowerCase() == "false")
				{
					w = widgetLibrary.dimensions[type]["X"]|0;
					h = widgetLibrary.dimensions[type]["Y"]|0;
				}
				else  //else Scale is true which means that the drawAndDragBox from draw-and-drag sets the size
				{
					w = drawAndDragBox.offsetWidth;
					h = drawAndDragBox.offsetHeight;
				}
					
				drawWidget(undefined /*need widget uid assigned*/,
						type,  
						x,y,w,h);

				//clear globals back to not drawing mode
				mainBlock_.el.style.cursor = "default";//"crosshair"; //"default";
				drawAndDragBox.style.display = "none";
				drawingSelectionRectangle_  = false;
				dragAndDrawWidgetType_ = undefined;
				editBlock_.el.firstChild.contentWindow.selectWidgetTile(); //unselect in edit block
			} //end stopDragAndDrawRectangle()

			//================================================================================
			//draws widget based on id
			//	if id === undefined, then creates new uid widget
			//	if new parameters are defined they are placed in widget object
			//	if hideFrame, hides the iframe and widget content (more moving and resizing).
			function drawWidget(id, type, newx, newy, neww,
					newh, hideFrame)
			{			
				//console.log("drawWidget() id=",id,
				//		" type=",type);
				
				var OUTLINE_OFFSET = 15;
				
				var containerDiv;
				var widgetCover;

				var resizeDiv;
				var resizeDivTop;
				var resizeDivLeft;
				var resizeDivRight;
				var resizeDivBottom;
				var resizeDivTopLeft;
				var resizeDivTopRight;
				var resizeDivBottomRight;
				var resizeDivBottomLeft;
				
				var editIcon, otherEditIcon;

				//Steps:
				//	- check page_ object for widget details
				//		* if missing, add to object
				//	- check page for widget elements
				//		* if missing, add to page
			
				if(page_ === undefined)
				{
					Debug.log("Impossible page object missing! Notify admins", Debug.HIGH_PRIORITY);
					return;
				}
				
				if(page_.widgets == undefined)
				{
					page_.widgets = {};
				}
				
				var widgetObject;
				
				if(id === undefined || page_.widgets[id] === undefined)
				{					
					Debug.log("Creating new widget object..");
					
					//start at number of widgets, and then keep adding 1 until no record found in 
					id = Object.keys(page_.widgets).length;
					while(page_.widgets[id] !== undefined)
						++id;
					Debug.log("Found new available widget ID = " + id);
										
					page_.widgets[id] = {}; //start new widget object
					widgetObject = page_.widgets[id];
					
					widgetObject.pvList 		= {};
					widgetObject.attributes 	= {};
					widgetObject.displayName 	= "widget-" + id;
					widgetObject.loaded 		= false;
					//attempt to get element, ok if undefined (will be created)
					widgetObject.el				= document.getElementById("widget-" + id); 
				} //end new widget object handling
				else
					widgetObject = page_.widgets[id];
				
				//console.log("Starting widget object with ID=",id, +
				//			" object:",widgetObject);
				
				
				{ //filling widget object with new parameters				

					//all x,y,w,h represented as "per thousand" (PAGE_POSITIONS_ positions, integer representation)
					if(newx !== undefined)
						widgetObject.x 		= toScaledXCoordinate(newx);
					if(newy !== undefined)
						widgetObject.y 		= toScaledYCoordinate(newy);
					if(neww !== undefined)
						widgetObject.w 		= toScaledXCoordinate(neww);
					if(newh !== undefined)
						widgetObject.h 		= toScaledYCoordinate(newh);

					if(type !== undefined)
						widgetObject.type 	= type | 0; //force integer type
				} //end filling widget object with new parameters
																
				if(!widgetObject.el)
				{
					Debug.log("Creating widget elements for widget" + id);
					
					widgetObject.el = document.createElement("iframe");
					widgetObject.el.scrolling="No";	
					widgetObject.el.id = "widget-" + id;

					containerDiv = document.createElement("div");
					containerDiv.id = "widget-" + id + "-container";
					containerDiv.style["background-color"] = "rgba(0,0,0,0.2)";

					widgetCover = document.createElement("div");
					widgetCover.className = "widgetCover";
					widgetCover.id = "widget-" + id + "-cover";

					resizeDiv = document.createElement("div");
					resizeDiv.className = "resizeWidgetCover";
					resizeDiv.id = "widget-" + id + "-resize-cover";

					//Create elements to handle the different resize arrows
					{ //resize sides
						resizeDivTop = document.createElement("div");
						resizeDivTop.className = "resizeWidgetCoverTop";
						resizeDivTop.id = "widget-" + id + "-resize-cover-north";
						resizeDivTop.style.cursor = "ns-resize";
	
						resizeDivLeft = document.createElement("div");
						resizeDivLeft.className = "resizeWidgetCoverLeft";
						resizeDivLeft.id = "widget-" + id + "-resize-cover-west";
						resizeDivLeft.style.cursor = "ew-resize";
	
						resizeDivRight = document.createElement("div");
						resizeDivRight.className = "resizeWidgetCoverRight";
						resizeDivRight.id = "widget-" + id + "-resize-cover-east";
						resizeDivRight.style.cursor = "ew-resize";
	
						resizeDivBottom = document.createElement("div");
						resizeDivBottom.className = "resizeWidgetCoverBottom";
						resizeDivBottom.id = "widget-" + id + "-resize-cover-south";
						resizeDivBottom.style.cursor = "ns-resize";
					} //end resize sides

					{ //resize corners
						resizeDivTopLeft = document.createElement("div");
						resizeDivTopLeft.className = "resizeWidgetCoverTopLeft";
						resizeDivTopLeft.id = "widget-" + id + "-resize-cover-northwest";
						resizeDivTopLeft.style.cursor = "nwse-resize";
	
						resizeDivTopRight = document.createElement("div");
						resizeDivTopRight.className = "resizeWidgetCoverTopRight";
						resizeDivTopRight.id = "widget-" + id + "-resize-cover-northeast";
						resizeDivTopRight.style.cursor = "nesw-resize";
	
						resizeDivBottomRight = document.createElement("div");
						resizeDivBottomRight.className = "resizeWidgetCoverBottomRight";
						resizeDivBottomRight.id = "widget-" + id + "-resize-cover-southeast";
						resizeDivBottomRight.style.cursor = "nwse-resize";
	
						resizeDivBottomLeft = document.createElement("div");
						resizeDivBottomLeft.className = "resizeWidgetCoverBottomLeft";
						resizeDivBottomLeft.id = "widget-" + id + "-resize-cover-southwest";
						resizeDivBottomLeft.style.cursor = "nesw-resize";
					} //end resize corners
					
					editIcon = document.createElement("div");
					editIcon.className = "widgetEditIcon";
					editIcon.id = "widget-" + id + "-editIcon";
					editIcon.title = "Edit the attributes and PV-list for this widget-" +
						id + ".";
					editIcon.onmouseup = makeHandlerWithID(id,
							toggleContextMenu);
					editIcon.onmousedown = function(e){e.stopPropagation();}
					
					otherEditIcon = document.createElement("div");
					otherEditIcon.className = "widgetEditIcon widgetOtherEditIcon";
					otherEditIcon.id = "widget-" + id + "-otherEditIcon";
					otherEditIcon.title = "Edit the attributes and PV-list for this widget-" + 
						id + ".";
					otherEditIcon.onmouseup = makeHandlerWithID(id,
							toggleContextMenu);
					otherEditIcon.onmousedown = function(e){e.stopPropagation();}					

					//widgetCover.addEventListener("dblclick", 
					//		makeHandlerWithID(id,		toggleContextMenu));
					widgetCover.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetDrag));
					widgetCover.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));	

					resizeDivTop.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivLeft.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivRight.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivBottom.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivTopLeft.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivTopRight.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivBottomRight.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));
					resizeDivBottomLeft.addEventListener("mousedown", 
							makeHandlerWithID(id,		startWidgetResize));

					resizeDivTop.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivLeft.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivRight.addEventListener("mouseup",  
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivBottom.addEventListener("mouseup", 
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivTopLeft.addEventListener("mouseup",  
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivTopRight.addEventListener("mouseup",  
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivBottomRight.addEventListener("mouseup",  
							makeHandlerWithID(id,		endWidgetDragAndResize));
					resizeDivBottomLeft.addEventListener("mouseup",  
							makeHandlerWithID(id,		endWidgetDragAndResize));

					resizeDiv.appendChild(resizeDivTop);
					resizeDiv.appendChild(resizeDivLeft);
					resizeDiv.appendChild(resizeDivRight);
					resizeDiv.appendChild(resizeDivBottom);
					resizeDiv.appendChild(resizeDivTopRight);
					resizeDiv.appendChild(resizeDivTopLeft);
					resizeDiv.appendChild(resizeDivBottomRight);
					resizeDiv.appendChild(resizeDivBottomLeft);

					resizeDiv.appendChild(editIcon);
					resizeDiv.appendChild(otherEditIcon);

					widgetObject.el.src = "widgets/" + 
							widgetLibrary.typeToSrc[widgetObject.type];
					widgetObject.el.style.border = "0";
					widgetObject.el.innerHTML = widgetObject.displayName;

					containerDiv.appendChild(resizeDiv);
					containerDiv.appendChild(widgetCover);
					
					containerDiv.appendChild(widgetObject.el);
					
					
					mainBlock_.el.appendChild(containerDiv);
				}
				else //iframe and elements already exist
				{					
					containerDiv 			= document.getElementById("widget-" + id + "-container");
					widgetCover 			= document.getElementById("widget-" + id + "-cover");

					editIcon 				= document.getElementById("widget-" + id + "-editIcon");
					otherEditIcon 				= document.getElementById("widget-" + id + "-otherEditIcon");					
					
					resizeDiv 				= document.getElementById("widget-" + id + "-resize-cover");
					
					//Sides for resize
					resizeDivTop 			= document.getElementById("widget-" + id + "-resize-cover-north");
					resizeDivLeft 			= document.getElementById("widget-" + id + "-resize-cover-west");
					resizeDivRight 			= document.getElementById("widget-" + id + "-resize-cover-east");
					resizeDivBottom 		= document.getElementById("widget-" + id + "-resize-cover-south");

					//Corners for resize
					resizeDivTopLeft 		= document.getElementById("widget-" + id + "-resize-cover-northwest");
					resizeDivTopRight 		= document.getElementById("widget-" + id + "-resize-cover-northeast");
					resizeDivBottomRight 	= document.getElementById("widget-" + id + "-resize-cover-southeast");
					resizeDivBottomLeft 	= document.getElementById("widget-" + id + "-resize-cover-southwest");
					
				}

				//now type object has been updated, now apply sizes in pixel units
				var x = toPageXCoordinate(widgetObject.x); //get "pixel units"
				var y = toPageYCoordinate(widgetObject.y); //get "pixel units"
				var w = toPageXCoordinate(widgetObject.w); //get "pixel units"
				var h = toPageYCoordinate(widgetObject.h); //get "pixel units"
				var z = 50;
				
				containerDiv.style.width = w + "px";
				containerDiv.style.height = h + "px";
				containerDiv.style.position = "absolute";
				containerDiv.style.left = x + "px";
				containerDiv.style.top = y + "px";
				containerDiv.style.zIndex = "5";

				widgetCover.style.width = w + "px";
				widgetCover.style.height = h + "px";
				widgetCover.style.position = "absolute";
				widgetCover.style.left = "0px";
				widgetCover.style.top = "0px";
				widgetCover.style.zIndex = z;

				resizeDiv.style.width = (w + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.height = (h + (2 * OUTLINE_OFFSET)) + "px";
				resizeDiv.style.position = "absolute";
				resizeDiv.style.left = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.top = -(OUTLINE_OFFSET) + "px";
				resizeDiv.style.zIndex = z-1;

				//To handle the different resize arrows
				//Edges for resize
				resizeDivTop.style.width = w + "px";
				resizeDivTop.style.height = OUTLINE_OFFSET + "px";
				resizeDivTop.style.position = "absolute";
				resizeDivTop.style.left = OUTLINE_OFFSET + "px";
				resizeDivTop.style.top = "0px";
				resizeDivTop.style.zIndex = z-1;

				resizeDivLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.height = h + "px";
				resizeDivLeft.style.position = "absolute";
				resizeDivLeft.style.left ="0px";
				resizeDivLeft.style.top = OUTLINE_OFFSET + "px";
				resizeDivLeft.style.zIndex = z-1;

				resizeDivRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivRight.style.height = h + "px";
				resizeDivRight.style.position = "absolute";
				resizeDivRight.style.right = "0px";
				resizeDivRight.style.top = OUTLINE_OFFSET + "px";
				resizeDivRight.style.zIndex = z-1;

				resizeDivBottom.style.width = w + "px";
				resizeDivBottom.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.position = "absolute";
				resizeDivBottom.style.left = OUTLINE_OFFSET + "px";
				resizeDivBottom.style.bottom = "0px";
				resizeDivBottom.style.zIndex = z-1;

				//Corners for resize
				resizeDivTopLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopLeft.style.position = "absolute";
				resizeDivTopLeft.style.left = "0px";
				resizeDivTopLeft.style.top = "0px";
				resizeDivTopLeft.style.zIndex = z-1;

				resizeDivTopRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivTopRight.style.position = "absolute";
				resizeDivTopRight.style.right = "0px";
				resizeDivTopRight.style.top = "0px";
				resizeDivTopRight.style.zIndex = z-1;

				resizeDivBottomRight.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomRight.style.position = "absolute";
				resizeDivBottomRight.style.right = "0px";
				resizeDivBottomRight.style.bottom = "0px";
				resizeDivBottomRight.style.zIndex = z-1;

				resizeDivBottomLeft.style.width = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.height = OUTLINE_OFFSET + "px";
				resizeDivBottomLeft.style.position = "absolute";
				resizeDivBottomLeft.style.left = "0px";
				resizeDivBottomLeft.style.bottom = "0px";
				resizeDivBottomLeft.style.zIndex = z-1;
				

				editIcon.style.position = "absolute";
				editIcon.style.right = 0 + "px";
				editIcon.style.top = h + "px";
				editIcon.style.zIndex = z-1;
				
				otherEditIcon.style.position = "absolute";
				otherEditIcon.style.left = 0 + "px";
				otherEditIcon.style.top = 0 + "px";
				otherEditIcon.style.zIndex = z-1;
				

				if(!hideFrame)
				{
					widgetObject.el.style.position = "absolute";
					widgetObject.el.style.width = w + "px";
					widgetObject.el.style.height = h + "px";
					widgetObject.el.style.left = 0 + "px";
					widgetObject.el.style.top = 0 + "px";
				}

				setEditModeWidgetTarget(widgetObject.el);
				widgetObject.el.style.display = hideFrame?"none":"block";
			} //end drawWidget()
			
			//================================================================================
			//widget x,y,w,h represented as "per thousand" scaled coordinates
			//	(PAGE_POSITIONS_ positions, integer representation)
			function toPageXCoordinate(x)
			{ return (x * windowWidth_ / PAGE_POSITIONS_) 	| 0; }
			function toPageYCoordinate(y)
			{ return (y * windowHeight_ / PAGE_POSITIONS_) 	| 0; }
			function toScaledXCoordinate(x)
			{ return (PAGE_POSITIONS_ * x / windowWidth_) 	| 0; }
			function toScaledYCoordinate(y)
			{ return (PAGE_POSITIONS_ * y / windowHeight_) 	| 0; }
			//end page and scaled coordinate conversion
			
			//=====================================================================================
			function mouseoverEditBlock(e)
			{
				Debug.log("mouseoverEditBlock()");
				editBlock_.el.style.marginBottom = (
						EDIT_BLOCK_HEIGHT
						- EDIT_BLOCK_PEEK_HEIGHT) + "px";
				
			} // end mouseoverEditBlock()

			//=====================================================================================
			function mouseoutEditBlock(e)
			{
				Debug.log("mouseoutEditBlock()");
				editBlock_.el.style.marginBottom = 0 + "px";
				
			} //end mouseoutEditBlock()

			//================================================================================
			function toggleEditMode()
			{
				Debug.log("Toggle Edit Mode");

				mouseoutEditBlock();
				//mouseoverEditBlock();
				
				var covers = document.getElementsByClassName("widgetCover");
			    var resize_covers = document.getElementsByClassName("resizeWidgetCover");
				var editButton = document.getElementById("menuli2");

				if(editBlock_.isHidden && !isReadOnly_)
				{
					Debug.log("Edit Mode On");

					editBlock_.isHidden = false;
					editBlock_.el.style.display = "block";
					editButton.innerHTML = "Go Live!";

					//Make sure pv list is up-to-date
					DesktopContent.XMLHttpRequest(
						"Request?RequestType=getList",
						"", 
						pvListReqHandler /*returnHandler*/, 
						0 /*reqParam*/, 
						0 /*progressHandler*/, 
						0 /*callHandlerOnErr*/, 
						false /*doNoShowLoadingOverlay*/);

					UID_ = 0;
					window.clearInterval(timerVariable_);
					//editButton.classList.add("navigationMenu--Edit");
					mainBlock_.el.classList.add("editMode");
					
					for(widgetId in page_.widgets)
						drawWidget(widgetId);		
					
					if(covers.length > 0)
					{
						for(var i = 0;i<covers.length;++i)
						{
							covers[i].style.display = "block";
						}

						console.log(resize_covers);
						for(var i = 0;i<resize_covers.length;++i)
						{
							resize_covers[i].style["z-index"] = "8";
						}	
					}
					toggleGrid(true);
					if (editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox") != null)
						editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox").checked = true
				}
				else
				{
					Debug.log("Edit Mode Off");

					editBlock_.isHidden = true;
					editBlock_.el.style.display = "none";
					editButton.innerHTML = "Switch to Edit Mode";

					UID_ = 0;

					if (page_.widgets != undefined && !isEmpty(page_.widgets))
					{
						var pvListSize = 0;
						for (var widget in page_.widgets)
						{						
							if (!isEmpty(page_.widgets[widget].pvList))
								;//Debug.log("You have no PV selection for " + widget + "!", Debug.HIGH_PRIORITY);
							//else
								pvListSize ++;
						}
						if (pvListSize > 0)
						{
							generateUID();
							timerVariable_ = setInterval(pollServer, refreshRate_);
						}
					}

					mainBlock_.el.classList.remove("editMode");
					//editButton.classList.remove("navigationMenu--Edit");
					

					for(var i = 0;i<covers.length;++i)
						covers[i].style.display = "none";

					setEditModeWidgetTarget();
					toggleGrid(false);
					if (editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox") != null)
						editBlock_.el.firstChild.contentWindow.document.getElementById("gridCheckbox").checked = false;
				}
			} //end toggleEditMode()


			//=====================================================================================
			// returns a handler function that can be used to respond 
			//	to event handlers and pass an id parameter
			function makeHandlerWithID(id,handlerFunction)
			{
				 return function(event) {
					 console.log("makeHandlerWithID handlerFunction called id=",id);
					 handlerFunction(event, id);
				};
			} //end makeHandlerWithID()


			//=====================================================================================
			function toggleContextMenu(e, id)
			{
				if(e) e.stopPropagation();
				
				console.log("toggle toggleContextMenu id=",id);
				
				toggleContextMenuOff(); //hide first, so menu always comes up
				if(menuState_ !== 1)
				{
					menuState_ = 1; //set state
					
					//hide lower Edit pane
					mouseoutEditBlock(e); 
					 
					var w = DesktopContent.getWindowWidth();
					var h = DesktopContent.getWindowHeight();
					
					var x = e.clientX;
					var y = e.clientY;
					
					//prevent context menu from being offscreen
					// context menu seems to be 320 x 300
					if(x + 320 > w)
						x = w - 320;
					if(y + 280 > h - EDIT_BLOCK_PEEK_HEIGHT)
						y = h - EDIT_BLOCK_PEEK_HEIGHT - 280;
					
					menu_.style.left = x + "px";
					menu_.style.top = y + "px";
					menu_.setAttribute("widgetID", id);
					menu_.classList.add(activeMenu_);
				}
			} //end toggleContextMenu()


			//=====================================================================================
			function toggleContextMenuOff(e)
			{
				if(e) e.stopPropagation();			
				if(menuState_ !== 0)
				{
					menuState_ = 0;
					menu_.classList.remove(activeMenu_);
				}
			} //end toggleContextMenuOff()


			//=====================================================================================
			function toggleHotkeyMenu()
			{
				var rectangle = document.getElementById("menuli3").getBoundingClientRect();
				if((elPointer_["hotkeyMenuDiv"].style.display).indexOf("block") != -1)
				{
					elPointer_["hotkeyMenuDiv"].style.display = "none";
				}
				else
				{
					elPointer_["hotkeyMenuDiv"].style.display = "block";
					elPointer_["hotkeyMenuDiv"].style.left = rectangle.left + "px";
					elPointer_["hotkeyMenuDiv"].style.top = rectangle.top + "px";
				}
			} //end toggleHotkeyMenu()


			//=====================================================================================
			function toggleAddPV()
			{
				console.log(menu_.getAttribute("widgetID"));
				
				if(elPointer_["addPVMenuDiv"].style.display == "none")
				{
					toggleContextMenuOff();
					elPointer_["addPVMenuDiv"].setAttribute("widgetID", menu_.getAttribute("widgetID"));
					elPointer_["addPVMenuDiv"].style.display = "block";
					elPointer_["addPVMenu"].style.display = "block";
				}
				else
				{
					elPointer_["addPVMenuDiv"].style.display = "none"
					elPointer_["addPVMenu"].style.display = "none";
				}
			} //end toggleAddPV()


			//=====================================================================================
			function toggleFileMenu()
			{
				Debug.log("Toggle File Pane");
				
				var mainBlockContainer = document.getElementById("mainBlockContainer");
				var cover = document.getElementById("grayOutCoverDiv");
				cover.style.width = mainBlockContainer.offsetWidth + "px";
				cover.style.height = mainBlockContainer.offsetHeight + "px";
				
				//file toggle movement approach is always leave left
				//	the same, and change margin-left 
				//	(style transition speed on margin-left property for graceful movement)
				fileBlock_.el.style.left = (- FILE_BLOCK_WIDTH) + "px";
				

				if(fileBlock_.isHidden)
				{
					console.log("Showing file pane!");

					fileBlock_.isHidden = false;
					fileBlock_.el.style.marginLeft = FILE_BLOCK_WIDTH + "px";

					cover.style.display = "block";
					
					editBlock_.isHidden = true;
					editBlock_.el.style.display = "none";
					
					nav_.classList.remove("navigationMenu--active");
					nav_.style.display = "none";
				}
				else
				{
					console.log("Hiding file pane!");
					
					fileBlock_.isHidden = true;
					fileBlock_.el.style.marginLeft = -50 + "px";

					cover.style.display = "none";
					
					//mainBlock_.el.style.display = "block";
					
					editBlock_.el.style.display = "block";
					
					nav_.classList.add("navigationMenu--active");
					nav_.style.display = "block";
				}
			} //end toggleFileMenu()


			//=====================================================================================
			function editWidgetAttributesOpen()
			{
				document.getElementById("editWidgetAttributesPopup-container").style.display = "block";
				toggleContextMenuOff();

				//BEGIN HEADER
				var header = document.getElementById("editWidgetAttributesPopup-header");
				header.innerHTML = "";
				var title = document.createElement("input");
				title.setAttribute("type", "text")
				title.value = page_.widgets[menu_.getAttribute("widgetID")].displayName;
				title.onchange = function(){setWidgetDisplayName(menu_.getAttribute("widgetID"), this.value);};
				title.className = "editableInput";
				header.appendChild(title);
				console.log(header.clientHeight);
				var fontsize = 5;
				while(fontsize < (0.6 * header.clientHeight))
				{
					title.style.fontSize = ++fontsize + "px";
				}
				//END HEADER

				//BEGIN PVTable 
				var popupBody = document.getElementById("editWidgetAttributesPopup-body-pvlist");
				popupBody.innerHTML = "";
				var table = document.createElement("table");
				table.id = "widgetPVTable";
				table.className = "widgetPopupTable";
				table.style.width = "95%";
				table.style.height = "95%";
				table.style.margin = "auto";
				var thead = document.createElement("thead");
				var trhead = document.createElement("tr");
				var thPV = document.createElement("th");
//				thPV.className = "widgetPopupTable";
				thPV.innerHTML = "PV Name";
				thPV.style.width = "60%";
				var thRefresh = document.createElement("th");
//				thRefresh.className = "widgetPopupTable";
				thRefresh.innerHTML = "Refresh Rate (Sec)";
				thRefresh.style.width = "40%";
				trhead.appendChild(thPV);
				trhead.appendChild(thRefresh);
				thead.appendChild(trhead);
				table.appendChild(thead);
				var tbody = document.createElement("tbody");
				tbody.id = "widgetPVTableBody";
				table.appendChild(tbody);
				elPointer_["editWidgetAttributesPopup-body-pvlist"].appendChild(table);

				for(var pv in page_.widgets[menu_.getAttribute("widgetID")].pvList)
				{
					editWidgetAttributesaddRowPVList(pv, page_.widgets[menu_.getAttribute("widgetID")].pvList[pv]/1000, "widgetPVTableBody", "pvDatalist");
				}

				for(var i = 0; i < 15; i++)
				{
					editWidgetAttributesaddRowPVList("", "", "widgetPVTableBody", "pvDatalist");
				}
				//END PVTable

				//BEGIN AttributesTable
				var attributeBody = elPointer_["editWidgetAttributesPopup-body-attributes"];
				attributeBody.innerHTML = "";
				var attributeTable = document.createElement("table");
				attributeTable.id = "widgetAttributesTable";
				attributeTable.className = "widgetPopupTable";
				attributeTable.style.width = "95%";
				attributeTable.style.height = "100%";
				var thead = document.createElement("thead");
				var trhead = document.createElement("tr");
				var thParameter = document.createElement("th");
				thParameter.className = "widgetPVTable";
				thParameter.innerHTML = "Parameter";
				thParameter.style.width = "40%";
				var thParameterValue = document.createElement("th");
				thParameterValue.className = "widgetPopupTable";
				thParameterValue.innerHTML = "Value";
				thParameterValue.style.width = "60%";
				trhead.appendChild(thParameter);
				trhead.appendChild(thParameterValue);
				thead.appendChild(trhead);
				attributeTable.appendChild(thead);
				var tbody = document.createElement("tbody");
				tbody.id = "widgetAttributesTableBody";
				attributeTable.appendChild(tbody);
				elPointer_["editWidgetAttributesPopup-body-attributes"].appendChild(attributeTable);

				console.log(page_.widgets[menu_.getAttribute("widgetID")].attributes);

				for(var attribute in page_.widgets[menu_.getAttribute("widgetID")].attributes)
				{
					console.log(attribute);
					editWidgetAttributesaddRowPVList(attribute, page_.widgets[menu_.getAttribute("widgetID")].attributes[attribute], "widgetAttributesTableBody", "");
				}
				//END   AttributesTableTable

				showeditWidgetAttributesPopupBody("EditPVlist");

				//BEGIN FOOTER
				var footer = document.getElementById("editWidgetAttributesPopup-footer");
				footer.innerHTML = "";
				var closeButton = document.createElement("button");
				closeButton.className = "editPopupButton";
				closeButton.style.left = "55%";
				closeButton.innerHTML = "Cancel";
				closeButton.onclick = function(){editWidgetAttributesClose();};
				footer.appendChild(closeButton);
				var saveButton = document.createElement("button");
				saveButton.className = "editPopupButton";
				saveButton.style.left = "35%";
				saveButton.innerHTML = "Save";
				saveButton.onclick = function(){editWidgetAttributesSave(); editWidgetAttributesClose();};
				footer.appendChild(saveButton);				
				//END FOOTER
			} //end editWidgetAttributesOpen()


			//=====================================================================================
			function editWidgetAttributesClose()
			{
				document.getElementById("editWidgetAttributesPopup-container").style.display = "none";
				//if (isEmpty(page_.widgets[menu_.getAttribute("widgetID")].pvList))
					//Debug.log("You have no PV selection!", Debug.WARN_PRIORITY);
			} //end editWidgetAttributesClose()


			//=====================================================================================
			function editWidgetAttributesSave()
			{
				if(elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display == "table-row"){
					page_.widgets[menu_.getAttribute("widgetID")].pvList = {};
					var table = document.getElementById("widgetPVTable");
					for(var tr = 0; tr < table.getElementsByTagName("tr").length; tr++)
					{
						if(table.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
						{
							var pv = table.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0].value;
							if(pv != "")
							{
								console.log(pv);
								var refreshRate = table.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value*1000;
								console.log("refreshRate (ms): " + refreshRate);
								if(refreshRate == "")
									refreshRate = -1;

								page_.widgets[menu_.getAttribute("widgetID")].pvList[pv] = refreshRate;
								addPVToWidget(pv, refreshRate, menu_.getAttribute("widgetID"));
							}
						}
					}
				}
				else if(elPointer_["editWidgetAttributesPopup-body-attributes"].style.display == "table-row")
				{
					var actionRequired = false;
					page_.widgets[menu_.getAttribute("widgetID")].attributes = {};
					var attributesTable = document.getElementById("widgetAttributesTable");
					console.log(attributesTable);
					for(var tr = 0; tr < attributesTable.getElementsByTagName("tr").length; tr++)
					{
						console.log(tr);
						if(attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td").length > 0)
						{
							var parameter = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[0].getElementsByTagName("input")[0].value;
							if(parameter != "")
							{
								var value = attributesTable.getElementsByTagName("tr")[tr].getElementsByTagName("td")[1].getElementsByTagName("input")[0].value;							
								console.log(" a: " + parameter, value);
								if(value == 'undefined')
									actionRequired = true;

								page_.widgets[menu_.getAttribute("widgetID")].attributes[parameter] = value;
							}
						}
					}
					try
					{
						page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.setAttributes(page_.widgets[menu_.getAttribute("widgetID")].attributes);
					}
					catch(e)
					{
						Debug.log("There are errors when calling setAttributes() of target widget: " + e,
							Debug.WARN_PRIORITY);
					}
					try
					{
						page_.widgets[menu_.getAttribute("widgetID")].el.contentWindow.drawWidget(page_.widgets[menu_.getAttribute("widgetID")], page_.widgets[menu_.getAttribute("widgetID")].attributes);
					}
					catch(e)
					{
						Debug.log("There are errors when calling drawWidget() of target widget: " + e,
							Debug.WARN_PRIORITY);
					}

//					if(actionRequired)
//						document.getElementById(menu_.getAttribute("widgetID")).className = "action-required";
//					else
//						document.getElementById(menu_.getAttribute("widgetID")).className = "";
				}
			} //end editWidgetAttributesSave()


			//=====================================================================================
			function editWidgetAttributesaddRowPVList(keyParam, valueParam, tablebody, list)
			{
				var tbody = document.getElementById(tablebody);
				var dummytr = document.createElement("tr");
				dummytr.className = "widgetPopupTable";
				var dummyts = document.createElement("td");
				dummyts.className = "widgetPopupTable";
				var keyField = document.createElement("input");
				keyField.setAttribute("type", "text")
				keyField.className = "editableInput";
				keyField.style.color = "black";
				keyField.setAttribute("list", list);
				keyField.value = keyParam;
				keyField.onchange = function(){checkIfMoreRowsNeeded(this); };
				dummyts.appendChild(keyField);
				var dummyts2 = document.createElement("td");
				dummyts2.className = "widgetPopupTable";
				var valueField = document.createElement("input");
				valueField.setAttribute("type", "text")
				valueField.className = "editableInput";
				valueField.style.color = "black";
				valueField.value = valueParam;
				keyField.onchange = function (){setRefreshRate(keyField,valueField)};
				dummyts2.appendChild(valueField);
				dummytr.appendChild(dummyts);
				dummytr.appendChild(dummyts2);
				dummytr.style["max-height"] = "10%";
				tbody.appendChild(dummytr);	
			} //end editWidgetAttributesaddRowPVList()


			//=====================================================================================
			function checkIfMoreRowsNeeded(inputEl)
			{
				console.log(inputEl.parentElement.parentElement.parentElement.lastElementChild);
				if(inputEl.parentElement.parentElement == inputEl.parentElement.parentElement.parentElement.lastElementChild)
				{
					editWidgetAttributesaddRowPVList("", "");
				}
			} //end checkIfMoreRowsNeeded()


			//=====================================================================================
			function setWidgetDisplayName(widget, displayName)
			{
				page_.widgets[widget].displayName = displayName;
			} //end setWidgetDisplayName()


			//=====================================================================================
			function showeditWidgetAttributesPopupBody(body)
			{
				editWidgetAttributesSave();

				elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display = "none";
				elPointer_["editWidgetAttributesPopup-body-attributes"].style.display = "none";

				if (body == "EditAttributes")
				{
					console.log("EditAttributes");
					elPointer_["editWidgetAttributesPopup-body-attributes"].style.display = "table-row";
				}
				else if (body == "Macromaker")
				{
					//elPointer_["editWidgetAttributesPopup-body-macromaker"].style.display = "table-row";
				}
				else
				{
					elPointer_["editWidgetAttributesPopup-body-pvlist"].style.display = "table-row";
				}
			} //end showeditWidgetAttributesPopupBody()


			//=====================================================================================
			function clearBlock(el)
			{
				for(var child = 0; child < el.childNodes.length; child++)
				{
					if(child.id == "contextMenuDiv"){}
					else if(child.id == "selectionRectangle"){}
					else 
					{
						el.removeChild(el.childNodes[child]);
					}
				}	
			} //end clearBlock()


			//=====================================================================================
			function toggleGrid(on)
			{
				if(on)
				{
					mainBlock_.el.style["background-image"] = "linear-gradient(to right, " + gridColor_ + " 1px, transparent 1px), linear-gradient(" + gridColor_ + " 1px, transparent 1px)";
					mainBlock_.el.style["background-size"]  =  "10px 10px";
				}
				else
				{
					mainBlock_.el.style["background-image"] = "";
					mainBlock_.el.style["background-size"]  =  "";
				}
			} //end toggleGrid()


			//=====================================================================================
			function setBackgroundColor(color)
			{
				mainBlock_.el.style["background-color"] = color;
			} //end setBackgroundColor()


			//=====================================================================================
			function setGridColor(color, on)
			{
				gridColor_ = color;
				toggleGrid(on);
			} //end setGridColor()
			
			//=====================================================================================
			function handleKeys(e,isKeyDown)
			{	
				var id;
				
				if(e.shiftKey)
				{
					if(isKeyDown) return; //ignore shift keys down (only up)

					var ARROW_SPEED = 30;
					
					switch(e.keyCode)
					{
					case 88: 	//X (cut)
				    	console.log("cut widget",targetElement_);
				    	cutWidget(targetElement_);
				    	break;
					case 86: 	//V (paste)
				    	console.log("paste widget");
				    	pasteWidget();
				    	break;
					case 79: 	//O (open)
				    	console.log("toggle file manager");
				    	toggleFileMenu();
				    	break;
					case 69: 	//E (edit mode)
				    	console.log("toggle edit mode");
				    	toggleEditMode();
				    	break;
					case 38: 	//up arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"up move widget",id);
						page_.widgets[id].y -= ARROW_SPEED;
						drawWidget(id);
						break;
					case 40: 	//down arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"down move widget",id);
						page_.widgets[id].y += ARROW_SPEED;
						drawWidget(id);
						break;
					case 37: 	//left arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"left move widget",id);
						page_.widgets[id].x -= ARROW_SPEED;
						drawWidget(id);
						break;
					case 39: 	//right arrow (move widget)
						id = localGetWidgetId();
						console.log(isKeyDown,"right move widget",id);
						page_.widgets[id].x += ARROW_SPEED;
						drawWidget(id);
						break;
					default:;
					}
				} //end shift key + key handling
				else //no shift key
				{
					if(!isKeyDown) return; //ignore on key up side
					
					var ARROW_SPEED = 1;
					switch(e.keyCode)
					{
					case 38: 	//up arrow (move widget)
						id = localGetWidgetId();
				    	console.log(isKeyDown,"up move widget",id);
				    	page_.widgets[id].y -= ARROW_SPEED;
				    	drawWidget(id);
				    	break;
					case 40: 	//down arrow (move widget)
						id = localGetWidgetId();
				    	console.log(isKeyDown,"down move widget",id);
				    	page_.widgets[id].y += ARROW_SPEED;
				    	drawWidget(id);
				    	break;
					case 37: 	//left arrow (move widget)
						id = localGetWidgetId();
				    	console.log(isKeyDown,"left move widget",id);
				    	page_.widgets[id].x -= ARROW_SPEED;
				    	drawWidget(id);
				    	break;
					case 39: 	//right arrow (move widget)
						id = localGetWidgetId();
				    	console.log(isKeyDown,"right move widget",id);
				    	page_.widgets[id].x += ARROW_SPEED;
				    	drawWidget(id);
				    	break;
					default:;
					}
				} //end no shift key key handling
				
				
				return;
				
				//===============
				function localGetWidgetId()
				{
					var id;
					try
					{
						id = targetElement_.id.split('-')[1] | 0; //force integer
						if(page_.widgets[id] === undefined)
							throw ("Missing id target " + id);
					}
					catch(e)
					{
						Debug.log("Illegal target key element: " + e,
								Debug.HIGH_PRIORITY);
						throw(e);
					}
					return id;
				} //end localGetWidgetId
			} //end handleKeys()

			//=====================================================================================
			function deleteWidget()
			{
				if(!targetElement_)
				{
					Debug.log("Ignoring deleteWidget() with no target element");
					return;
				}
				var id = targetElement_.id.split('-')[1]|0;
				
										
				if(page_.widgets[id] && page_.widgets[id].el)
				{					
					page_.widgets[id].el.parentNode.removeChild(page_.widgets[id].el);
					delete page_.widgets[id].el;
				}
				if(page_.widgets[id])
					delete page_.widgets[id];
				
				var widgetContainer = document.getElementById("widget-" + id + 
					"-container");
				if(widgetContainer)
					widgetContainer.parentNode.removeChild(widgetContainer);
				else
					Debug.log("Could not find widget container to remove");
				
				toggleContextMenuOff();
			} //end deleteWidget()

			//=====================================================================================
			function cutWidget(widgetCover)
			{
				var id = widgetCover.id.substring(0, widgetCover.id.indexOf("-cover"));
				console.log(id);
				delete page_.widgets[id].el
				cutWidget_ = page_.widgets[id];
				console.log("here");
				console.log(widgetCover);
				console.log(page_.widgets[widgetCover.parentNode.getElementsByTagName("iframe")[0].id].el);
				console.log(widgetCover.id);
				cutWidgetId_ = id;
				delete page_.widgets[id];
				mainBlock_.el.removeChild(widgetCover.parentNode);
			} //end cutWidget()

			//=====================================================================================
			function pasteWidget()
			{
				//Steps:
				//	- when cut, the widget is assumed deleted
				//	so must create a new widget object for paste
				
				drawWidget(
						undefined /*create new id*/,
						cutWidget_.type,
						toPageXCoordinate(cutWidget_.x),
						toPageYCoordinate(cutWidget_.y),
						toPageXCoordinate(cutWidget_.w),
						toPageYCoordinate(cutWidget_.h)
						);
				
			} //end pasteWidget()

			//=====================================================================================
			function setEditModeWidgetTarget(target)
			{				
				if(targetElement_ == target) return; //already the target
				
				//unselect previous target, and select parameter target
				
				if(targetElement_ && targetElement_.parentNode)
				{
					var els = targetElement_.parentNode.getElementsByTagName("iframe");
					if(els.length)
						els[0].style.display = "block";
					
					els = targetElement_.parentNode.getElementsByTagName("resizeWidgetCover");
					if(els.length)
						els[0].style.display = "none";			
				}

				targetElement_ = target;
				if(targetElement_ && targetElement_.parentNode)
				{
					var els = targetElement_.parentNode.getElementsByTagName("iframe");
					if(els.length)
						els[0].style.display = "none";
					
					els = targetElement_.parentNode.getElementsByTagName("resizeWidgetCover");
					if(els.length)
						els[0].style.display = "block";					
				}	
				
			} //end setEditModeWidgetTarget()

			//=====================================================================================
			function startWidgetDrag(e,id)
			{
				if(e) e.stopPropagation();
				
				if(editBlock_.isHidden) 
				{
					Debug.log("Ignoring widget drag when not edit mode.");
					return; //ignore drag during edit mode
				}
								
				//validate target
				if(e.target.className.indexOf("widgetCover") < 0)
				{ 	
					Debug.log("Unknown drag target?! Notify admins id=" + id,
							Debug.HIGH_PRIORITY);
					return;
				}	
				//else dragging a widget			
				
				Debug.log("startWidgetDrag() id=" + id);		

				resizeWidgetId_ = id;	
				dragLockout_ = true; //indicate dragging	
				
				redrawTargetWidget(e, 
						false /*doNotRestorePosition*/, 
						true /*isFirstTime*/); //redraw for first time

			} //end startWidgetDrag()

			//=====================================================================================
			function startWidgetResize(e,id)
			{
				if(e) e.stopPropagation();
				
				//verify known target
				if(e.target.className.indexOf("resizeWidgetCover") < 0)
				{
					Debug.log("Unknown resize target?! Notify admins id=" + id,
							Debug.HIGH_PRIORITY);
					return;
				}
				//else valid target

				Debug.log("startWidgetResize() id=" + id);
				
				indicateUserActivityToServer();						

				resizeWidgetId_ = id;	
				resizeLockout_ = true;				
				resizeFrom_ = e.target.id.substring(
						e.target.id.indexOf("resize-cover") + ("resize-cover").length + 1);
				
				redrawTargetWidget(e, 
						false /*doNotRestorePosition*/, 
						true /*isFirstTime*/); //redraw for first time

			} //end startWidgetResize()

			//=====================================================================================
			//Note: one mouseup handler must be the end all
			//	because the user is inaccurate with mouseup elements
			function endWidgetDragAndResize(e,id)
			{						
				if(e) e.stopPropagation();	

				if(!resizeLockout_ && !dragLockout_ && 
						!dragAndDrawTargetEl_)
				{
					Debug.log("Unknown drag/resize end target. Ignoring drag/resize end.");
					return;
					
				}
				if(!dragAndDrawTargetEl_)
				{
					Debug.log("Unknown drag/resize end target?! Notify admins id=" + id,
							Debug.HIGH_PRIORITY);
					return;
				}

				Debug.log("endWidgetDragAndResize() " + id);	
				
				//restore cursor
				dragAndDrawTargetEl_.style.cursor = saveCursorType_;
				
				//redraw target widget one more time and keep final position 
				redrawTargetWidget(e, true /*doNotRestorePosition*/); 												
				
				resizeFrom_ = undefined;
				resizeWidgetId_ = undefined;
				resizeLockout_ = false;
				dragLockout_ = false;
				dragAndDrawTargetEl_ = undefined;
				
			} //end endWidgetDragAndResize()

			//=====================================================================================
			//redrawTargetWidget ~~
			//	handles mouse drag behavior for widget resize/translate
			function redrawTargetWidget(e, doNotRestorePosition, isFirstTime)
			{
				if(e) e.stopPropagation();

				if(isFirstTime)
				{
					indicateUserActivityToServer();	
					dragAndDrawTargetEl_ = e.target;

					//save current cursor and set to grabbing cursor
					saveCursorType_ = dragAndDrawTargetEl_.style.cursor;
					dragAndDrawTargetEl_.style.cursor = "grabbing";
						
					xPos_ = e.clientX;
					yPos_ = e.clientY;			
						
					
					if(resizeLockout_)
						Debug.log("Resizing from " + resizeFrom_);
					else if(dragLockout_)
						setEditModeWidgetTarget(dragAndDrawTargetEl_);
					else
					{
						Debug.log("Impossible resize/translate mode! Notify admins.",
								Debug.HIGH_PRIORITY);
						return;
					}
				} //end first time handling
				
				if(page_.widgets[resizeWidgetId_] === undefined)
				{
					Debug.log("Resize/translate widget target not found " + resizeWidgetId_);
					return; //skip resize/translate if widget does not exist
				}
				

				//save and restore starting x,y,w,h while user playing with size
				// on end resize/translate position will be finalized
				var saveSize = [page_.widgets[resizeWidgetId_].x,
								page_.widgets[resizeWidgetId_].y,
								page_.widgets[resizeWidgetId_].w,
								page_.widgets[resizeWidgetId_].h];
				
				var newx = toPageXCoordinate(page_.widgets[resizeWidgetId_].x);
				var newy = toPageYCoordinate(page_.widgets[resizeWidgetId_].y);
				var neww = toPageXCoordinate(page_.widgets[resizeWidgetId_].w);
				var newh = toPageYCoordinate(page_.widgets[resizeWidgetId_].h);

				var deltaX = e.clientX - xPos_;
				var deltaY = e.clientY - yPos_;
				
				if(resizeLockout_)
				{
					//for resizing widget

					//Depending on where we are pulling the resize, 
					//	which way means "make the widget bigger" is different
					if(resizeFrom_ == "north" || resizeFrom_ == "northeast" ||
						resizeFrom_ == "northwest")
					{		
						if(newh - deltaY < 0) //if passed bottom 
						{
							newy += newh; //top becomes old bottom
							newh = -(newh - deltaY);
						}
						else
						{
							newy += deltaY;
							newh -= deltaY;
						}												
					}

					if(resizeFrom_ == "east" || resizeFrom_ == "northeast" ||
						resizeFrom_ == "southeast")
					{
						if(neww + deltaX < 0) //if passed left 
						{
							newx += neww + deltaX;
							neww = -(neww + deltaX);
						}
						else
						{
							neww += deltaX;
						}			
					}

				 	if(resizeFrom_ == "south" || resizeFrom_ == "southeast" ||
				 		resizeFrom_ == "southwest")
					{
						if(newh + deltaY < 0) //if passed top 
						{
							newy += newh + deltaY;
							newh = -(newh + deltaY);
						}
						else
						{
							newh += deltaY;
						}							
					}

					if(resizeFrom_ == "west" || resizeFrom_ == "northwest" ||
						resizeFrom_ == "southwest")
					{
						if(neww - deltaX < 0) //if passed right 
						{
							newx += neww; //left becomes old right
							neww = -(neww - deltaX);
						}
						else
						{
							newx += deltaX;
							neww -= deltaX;
						}						
					}				
			
				} //end resize handling
				else if(dragLockout_)
				{	//for dragging a widget									
					newx += deltaX;
					newy += deltaY;
				} //end drag handling
				else
				{
					Debug.log("Impossible resize/translate mode! Notify admins.",
							Debug.HIGH_PRIORITY);
					return;
				}
				
				//console.log("resize/translate() resizeFrom_=",
				//		resizeFrom_,"delta-x,y,w,h",deltaX,deltaY,deltaW,deltaH);
				
				
				drawWidget(
						resizeWidgetId_,
						undefined /*type not changed*/,
						newx,
						newy,
						neww,
						newh,
						doNotRestorePosition?false:true /*hideFrame*/);

				//restore starting x,y,w,h while user playing with size
				if(!doNotRestorePosition)
				{
					page_.widgets[resizeWidgetId_].x = saveSize[0];
					page_.widgets[resizeWidgetId_].y = saveSize[1];
					page_.widgets[resizeWidgetId_].w = saveSize[2];
					page_.widgets[resizeWidgetId_].h = saveSize[3];
				}				
				
			} //end redrawTargetWidget()

			//=====================================================================================
			function handleMouseDown(e)
			{				
				console.log("handleMouseDown",e.buttons,e.button);
				if(!drawingSelectionRectangle_ && 
						dragAndDrawWidgetType_ !== undefined)
				{
					Debug.log("handleMouseDown " + dragAndDrawWidgetType_ );	
					drawSelectionRectangle(e);
				}
				
			} //end handleMouseDown()


			//=====================================================================================
			function handleMouseUp(e)
			{	
				Debug.log("handleMouseUp()");
				
				
				if(drawingSelectionRectangle_)
				{
					Debug.log("handleMouseUp finish widget draw type=" + 
							dragAndDrawWidgetType_);
					stopDragAndDrawRectangle(e);
				}
				else if(dragAndDrawTargetEl_ !== undefined)
				{			
					Debug.log("handleMouseUp call finish drag/resize");
					endWidgetDragAndResize(e);
				}
				else if(!fileBlock_.isHidden)
				{
					Debug.log("handleMouseUp hide file menu");
					toggleFileMenu();
				}
				else //default click into nothingness
				{					
					Debug.log("handleMouseUp click nothing handling");
					toggleContextMenuOff(e); //close widget context menu
					setEditModeWidgetTarget(/*no target*/);
				}
				
			} //end handleMouseUp()

			//=====================================================================================
			function handleMouseMove(e)
			{
				//Debug.log("handleMouseMove");
				
				if(drawingSelectionRectangle_)
				{ //drag and draw
					//console.log("handleMouseMove", dragAndDrawWidgetType_);
					if(e.buttons != 0)
						redrawSelectionRectangle(e);
					else //mouse up?! (should really be handled by mouse up, but maybe user went off screen with mouse)
						stopDragAndDrawRectangle(e);
				}
				else if(resizeLockout_ || dragLockout_)
				{ //dragging or resizing					
					//console.log("handleMouseMove", dragAndDrawTargetEl_);
					if(e.buttons != 0)
						redrawTargetWidget(e);
					else //mouse up?! (should really be handled by mouse up, but maybe user went off screen with mouse)
						endWidgetDragAndResize(e);
				}
			} //end handleMouseMove()

			//=====================================================================================
			function handleResize(e) 
			{
				windowWidth_ = DesktopContent.getWindowWidth(); //window.innerWidth
				windowHeight_ = DesktopContent.getWindowHeight(); //window.innerHeight
				
				console.log("handleResize()","windowWidth_",windowWidth_,
						"windowHeight_",windowHeight_);
				
				for(widgetId in page_.widgets)
					drawWidget(widgetId);
				
				setEditModeWidgetTarget(/*no target*/);
				redrawWindow();
			}; //end handleResize()

			//=====================================================================================
			function redrawWindow(event, hover) 
			{
				Debug.log("redrawWindow() clicked-hover: " + event + "-" + hover
				 	+ " w,h: " + windowWidth_+ "," + windowHeight_);

				var _MARGIN = 10;
				var _TOPMARGIN = 40;
				
				var maxWidth = windowWidth_;
				var maxHeight = windowHeight_ - (1 * _MARGIN);
				var marginLeft = 0;
				var cover = document.getElementById("mainBlockContainer");
				var editCover = document.getElementById("editCoverDiv");

				hiddenWidth_ = maxWidth * 0.05;
				unhiddenWidth_ = maxWidth * 0.35;

				//DEFAULT VALUES //Sides Hidden
				var fileTop = _MARGIN, fileWidth = unhiddenWidth_, fileHeight = window.innerHeight;
				var editWidth = maxWidth, editHeight = EDIT_BLOCK_HEIGHT;
				var mainLeft = 0, mainTop = 0, mainWidth = maxWidth, mainHeight = window.innerHeight;				

				mainBlock_.el.style.left = mainLeft + "px";
				mainBlock_.el.style.top = "0px";
				mainBlock_.el.style.width =  mainWidth + "px";
				mainBlock_.el.style.height =  mainHeight + "px";
				mainBlock_.el.style.marginLeft = "0px";

				fileBlock_.el.style.top =  0 + "px";
			    fileBlock_.el.style.width =  fileWidth + "px";
				fileBlock_.el.style.height =  fileHeight + "px";

				editBlock_.el.style.width =  editWidth + "px";
				editBlock_.el.style.height =  editHeight + "px";

				cover.style.top			= 	mainTop + "px";
				cover.style.width		= 	(window.innerWidth-mainLeft) + "px";
				cover.style.height	    = 	window.innerHeight + "px";
				cover.style.left		= 	mainLeft + "px";

				editBlock_.el.style.bottom = (						
						EDIT_BLOCK_PEEK_HEIGHT //i.e. document.getElementById("editorPanelTitle").offsetHeight, but it does not exist yet
						- EDIT_BLOCK_HEIGHT) + "px";
				editBlock_.el.style.marginBottom = 0 + "px";

				if(!editBlock_.isHidden)
				{
					console.log("Edit mode");
					UID_ = 0;
					editCover.style.display = "none";
				}
				else
				{
					console.log("Not edit mode");
					editCover.style.display = "block";
				}

				var navBar = document.getElementById("navigationBarDiv");

				if(isReadOnly_)
				{
					navBar.style.display = "none";
					if(!editBlock_.isHidden)
						toggleEditMode();

					console.log(navBar);
				}
				else
				{
					navBar.style.display = "block";
				}

			} //end redrawWindow()


			//=====================================================================================
			//evaluateJS ~~
			function evaluateJS(str) 
			{
				Debug.log("evaluateJS = " + str);
				eval(str);
			} //end evaluateJS()


			//=====================================================================================
			function setRefreshRate(keyField,rateField)
			{
				console.log("setRefreshRate()",keyField.value,rateField.value);
				if(keyField.value != "")
					if(pvList_[keyField.value] != "")
						rateField.value = pvList_[keyField.value];
					else
						rateField.value = 10;
			} //end setRefreshRate()

			//=====================================================================================
			function isEmpty(obj)
			{
				return (Object.getOwnPropertyNames(obj).length === 0);
			} //end isEmpty()

		</script>
	</head>

	<body onload='Javascript:init();'>	
		<div id="navigationBarDiv">	
	    	  <nav>
		    <ul id="navigationMenu">
		      <li><a href="#" title="" id="menuli1" onclick="toggleFileMenu()">File Manager</a></li>		      
		      <li><a href="#" title="" id="menuli2" onclick="toggleEditMode()">Edit Mode</a></li>		      
		    </ul>
	          </nav>
		</div>
		
		<div class='mainBlock' 	id='fileBlock'  ></div>
		
		<div id="grayOutCoverDiv"></div>
		
		<div id="mainBlockContainer" height="auto" width="auto">
			<div class='mainBlock '	id='mainBlock' > <!-- onclick=redrawWindow("mainBlock") onmouseover="redrawWindow(null, false)"> -->
				<div id="contextMenuDiv">
					<nav id="contextMenu" class="menu ">
					  <ul class="menu__items ">
						<!--li class="menu__item ">
						  <a href="#" class="menu__link " 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); toggleAddPV();">
							<i class=""></i> Add PV
						  </a>
						</li-->
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); editWidgetAttributesOpen()" >
							<i class=""></i> Edit Attributes
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); deleteWidget()">
							<i class=""></i> Delete Widget
						  </a>
						</li>
						<li class="menu__item">
						  <a href="#" class="menu__link" 
						  	onmousedown="event.stopPropagation();"
						  	onmouseup="event.stopPropagation(); toggleContextMenuOff()" >
							<i class=""></i> Close
						  </a>
						</li>
					  </ul>
					</nav>
				</div>
				<div id="addPVMenuDiv">
				  <nav id="addPVMenu" class="menu ">
					<ul class="menu__items ">
					  <li class="menu__item ">
					<span class="menu__link">
					  <i class=""></i><input type="text" id="addPVPV" class="editableInput addPVMenuInput" placeholder="PV" list="pvDatalist"></input>
					</span> 		
					  </li>
					  <li class="menu__item">
					<span class="menu__link">
					  <i class=""></i><input type="text" id="addPVRefreshRate" class="editableInput addPVMenuInput" placeholder="Refresh Rate (ms)"></input>
					</span>
					  </li>
					  <li class="menu__item" style="height: auto">
					<span style="width: 100%; height: auto;">
					  <a href="#" onclick="addPVToWidget(document.getElementById('addPVPV').value, document.getElementById('addPVRefreshRate').value, document.getElementById('addPVMenuDiv').getAttribute('widgetID'), true)"><button type="button" class="menu__button" >Add PV </button></a>
					  <a href="#"	onclick="toggleAddPV()"><button type="button" class="menu__button">Close</button></a>
						</span>
					  </li>
					</ul>
				  </nav>
				</div>
				<div class="drawAndDragBox-select" id="selectionRectangle"><span></span></div>
				</div>
				<div class="cover"     id='editCoverDiv' onclick=toggleEditMode(true)></div>
				<div class='mainBlock' id='editBlock' ></div>
			</div>
			
			<div id="popupSaveControlsPage" class="popup">
			  <center><h2>Save your Controls Page</h2></center>
			  <div>
				<p><b>Page Name</b></p>
				<center><textarea id="controlsPageName" cols="43" rows="1"></textarea></center>
				<p><b>Controls Page Notes</b></p>
				<center><textarea id="controlsPageNotes" cols="43" rows="6"></textarea></center>
				<div id="makeControlsPagePublic">
				  <input type="checkbox" id="isControlsPagePublic"> Make accessible to public</input>
				</div>
				<div class="buttongroup">
				  <center>
				<button onclick="hidePopupSaveControlsPage()">Cancel</button>
				<button onclick="savePhoebusPageAs()">Save as Controls Page</button>
				  </center>
				</div>
			  </div>
			</div>
			<div class="editWidgetAttributesPopup-container" id="editWidgetAttributesPopup-container">
			  <div class="editWidgetAttributesPopup-header" id="editWidgetAttributesPopup-header" ></div>
			  <div class="editWidgetAttributesPopup-menu"   id="editWidgetAttributesPopup-menu">
				<nav id="editWidgetAttributesPopup-menu-nav">
				  <ul class="menu__items ">
				<li class="menu__item ">
				  <a href="#" class="menu__link " onclick="showeditWidgetAttributesPopupBody('pvList')">
					<i class=""></i> Edits PVs
				  </a>
				</li>
				<li class="menu__item">
				  <a href="#" class="menu__link" onclick="showeditWidgetAttributesPopupBody('EditAttributes')" >
					<i class=""></i> Edit Attributes
				  </a>
				</li>
				<!--<li class="menu__item">
					<a href="#" class="menu__link" onclick="showeditWidgetAttributesPopupBody('Macromaker')">
					  <i class=""></i> Macromaker
					</a>
				</li>-->
				  </ul>
				</nav>
			  </div>
			  <div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-pvlist"></div>
			  <div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-attributes"><p>body</p></div>
			  <!--<div class="editWidgetAttributesPopup-body"   id="editWidgetAttributesPopup-body-macromaker"></div>-->
			  <div class="editWidgetAttributesPopup-footer" id="editWidgetAttributesPopup-footer"></div>
			</div> <!-- end main block -->
		</div> <!-- end main block container -->

		<datalist id="pvDatalist"></datalist>
		<p hidden id="mailbox"></p>

		<div class='preloadImage' id='preloadImage-treeEditTrashIconHover'></div>
		<div class='preloadImage' id='preloadImage-treeEditIconHover'></div>
	</body>
</html>
