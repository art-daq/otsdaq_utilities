<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Supervisor</title>

		<link href='/WebPath/css/fonts.css?family=Comfortaa:700,400&subset=latin,greek' rel='stylesheet' type='text/css'>
		<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
				
		<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
		<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
		<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
		

		<style type="text/css">		
			body {
				background-color: transparent;
				font-family: 'Comfortaa', serif;
			}
			
			#clearDiv {
				clear: both;
			}
			
			#consoleInstructions, #consoleConnectionStatus {
				float: left;
				margin: 6px 0 0 6px;
				font-size: 12px;
				color: #4D2600;
			}
			
			#consoleConnectionStatus a {
				color: rgb(255,51,51);
			}
			
			
			#userLink, #clearConsoleLink {
				float: right;
				margin: 2px 2px 2px 20px;
			}
			
			a {
				text-decoration: none;
				color: #4D2600;
				font-weight: 800;
			}
			
			a:hover {
				text-decoration: underline;
			}
						
			.userTitle {
				color: #4D2600;
				font-style: italic;
				text-decoration: underline;
			}
			
			.consoleLink {
				font-size: 12px;
				font-face: arial;	
				font-weight: 400;	
			}
			
			
			.controlsCheckbox {
				float : left;
				margin-left: 0px;
				/*margin-top: -4px;*/
				margin-bottom: -10px;
			}
			
			.controlsCheckbox div { 
				float: left;
				margin: -4px 6px 0 2px;
				
			}
			
			.controlsCheckbox input {
				float: left;
				margin: 0 0 0 0;
			}
			
			#noWrapCheckboxText { /*make sure this checkbox doesnt wrap (haha) to new line*/
				margin-right: -10px;
				margin-bottom: 18px; /*push down 2nd row*/
			}
			
			
			/* ***************** CONSOLE HISTORY ******************************************/
			#consoleHistoryContainer {
				position: absolute;
			
				padding: 15px 2px 15px 15px;
				text-align: left;
				color: #4D2600;
			
				box-shadow: 		inset rgba(255,254,255,0.6) 0 0.3em .3em,
						            inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
						            rgba(200, 200, 200,0.6) 0 .1em 3px,
						            rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
						            rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
				border-radius: 3px;	

				font-family: 'Inconsolata', monospace;	
			}
			
			#consoleHistory {
				overflow-x: auto;		
				overflow-y: scroll;		
			}
			
			#consoleHistory::-webkit-scrollbar 
			{
			    height: 12px;
				width: 12px;
				background: rgba(0,0,0,0);
			}
			
			#consoleHistory::-webkit-scrollbar:hover {
				background: rgba(0,0,0,0.3);	
			}
			
			#consoleHistory::-webkit-scrollbar:vertical:hover {
				border-top: 1px solid #4D2600;		
				border-bottom: 1px solid #4D2600;
			}
			
			#consoleHistory::-webkit-scrollbar:horizontal:hover {
				border-left: 1px solid #4D2600;		
				border-right: 1px solid #4D2600;
			}
			
			#consoleHistory::-webkit-scrollbar-thumb {
			    background: white;
			    -webkit-border-radius: 1ex;
			}			
			
			#consoleHistory::-webkit-scrollbar-corner {
			    display: none;
			}

			/* ***************** USER AREA ******************************************/
					
			#usersContainer {
				position: absolute;
			
				padding: 15px 2px 15px 15px;
				text-align: left;
				color: #4D2600;
			
				box-shadow: 		inset rgba(255,254,255,0.6) 0 0.3em .3em,
						            inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
						            rgba(200, 200, 200,0.6) 0 .1em 3px,
						            rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
						            rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
				border-radius: 3px;	
				
			}

			#usersArea {
				overflow-y: scroll;
				overflow-x: auto;					
			}

			#usersArea::-webkit-scrollbar 
			{
			    height: 12px;
				width: 12px;
				background: rgba(0,0,0,0);
			}
			
			#usersArea::-webkit-scrollbar:hover {
				background: rgba(0,0,0,0.3);	
			}
			
			#usersArea::-webkit-scrollbar:vertical:hover {
				border-top: 1px solid #4D2600;		
				border-bottom: 1px solid #4D2600;
			}
			
			#usersArea::-webkit-scrollbar:horizontal:hover {
				border-left: 1px solid #4D2600;		
				border-right: 1px solid #4D2600;
			}
			
			#usersArea::-webkit-scrollbar-thumb {
			    background: #4D2600;
			    -webkit-border-radius: 1ex;
			}
			#usersArea::-webkit-scrollbar-corner {
			    background: rgba(0,0,0,0.0);
			}
			

			/* ***************** CONTROLS AREA ******************************************/
			#controlsContainer {
				position: absolute;
			
				padding: 15px 2px 15px 15px;
				text-align: left;
				color: #4D2600;
			
				box-shadow: 		inset rgba(255,254,255,0.6) 0 0.3em .3em,
						            inset rgba(0,0,0,0.15) 0 -0.1em .3em, /* inner shadow */
						            rgba(200, 200, 200,0.6) 0 .1em 3px,
						            rgba(200, 200, 200,0.6) 0 .1em 1px,  /* color border */
						            rgba(0,0,0,0.2) 0 .5em 5px;	/* drop shadow */
				border-radius: 3px;	
				
			}
		
			#PauseControlsLink {
				margin-left: 40px;
			}
			
			.countsTable {
				font-size: 12px;
			}
		</style>
				



		<!-- MultiSelectBox: Must include .css style sheet and .js functionality -->
		<link rel="stylesheet" type="text/css" href="/WebPath/css/MultiSelectBox.css">
		<script src="/WebPath/js/js_lib/MultiSelectBox.js"></script>

		<script>		
			
			
			//functions:		
				//init()	
				//redrawConsoleWindow(showSideBar)
				//getConsoleUpdates()
				//handleRefreshConsole(req)
				//updateConsoleHistory()
				//getColorForLevel()
				//formatTime(time_t)
				//convertForClient(str)
				//toggleHideLineNumber(e, setVal, doNotSave)
				//toggleNoWrap(e, setVal, doNotSave)
				//toggleCompactView(e, setVal, doNotSave)
				//toggleColorScheme()
				//setupColorScheme(i)
				//setupCompactView()
				//saveUserPreferences(colorIndex,showSideBar,noWrap,messageOnly,hideLineNumers)
				//handleLoadUserPreferences(req)
				//toggleFilterControls()
				//filterSelectionHandler(el)
				//initSideBar()
				//updateFilterBoxes()
				//updateSideBarCounts()
				//toggleSideBar()
				//handleUserScroll(e)
				//handleUserInputScroll(e)
				//handleMouseMoveScroll(mouseEvent) 
				//clearFilterControls(field)
				//togglePauseControls()
				//clearConsoleMessages()
			
			var _linkEl, _consoleEl, _historyEl, _historyContainerEl, _usersEl, _usersContainerEl;
			var _controlsContainerEl, _controlsEl;
			
			var _MARGIN = 10;
			var _INPUT_HEIGHT = 60;
			var _OFFSET_Y = 20;
			var _USERS_WIDTH = 200;
			
			var _REFRESH_INTERVAL = 2000; //milliseconds
			var _consoleUpdateTimer = 0;
			var _displayName;
			
			var _consoleHistoryFields = ["chat_entry","chat_author","chat_time"];
			var _CONSOLE_HISTORY_MAX_LENGTH = 100000;
			//var _lastTypedChat = "", _lastSentChat = ""; //keep last chats to prevent repeats
			
			var _chatUsersArray; 
			var _chatUsersFields = ["chat_user"];
			
			var _chatUsersTitle = "<div class='userTitle'>Chatting:</div>";
			var _activeUsersTitle = "<div class='userTitle'>Logged In:</div>";
			var _activeUsersStr = "";

			var _displaySidePane = true;
			var _scrollWithNewChats = true; //true if following new chats, false if user has scrolled up into history
			var _userMouseInput = false; //use flag to determine if scrolling is due to user mouse input
			
			
			
			
			
			var _lastUpdateCount = 0; //0 is for initial request
			var _lastUpdateIndex = -1; //-1 is for initial request
			var _consoleMessageFields = [
									"Level",
									"Label",
									//"Source", //not useful (innacurate)
									"Msg",
									"Time",
									//"Count" //not needed
								  ];
			var _MESSAGE_FIELD_LEVEL = _consoleMessageFields.indexOf("Level"),
					_MESSAGE_FIELD_LABEL = _consoleMessageFields.indexOf("Label"), 
					//_MESSAGE_FIELD_SOURCE = 2,
					_MESSAGE_FIELD_MSG = _consoleMessageFields.indexOf("Msg"), 
					_MESSAGE_FIELD_TIME = _consoleMessageFields.indexOf("Time");

			var _consoleMessageArray; 			
			var _compactViewCheckbox, _noWrapCheckbox, _hideLineNumbersCheckbox;
			var _compactStyleEl = 0, _noWrapStyleEl = 0, _hideLineStyleEl = 0,
					_filterStyleEl = {};
			
			var _chosenColorScheme = -1; //(start decremented by 1 from choice)
			var _colorSchemes = [ //background, foreground	
								 ["#000000","#66ff33"],
								 ["#cccccc","#333333"],								 
								 ["transparent",DesktopContent.getDefaultDesktopColor()]
								];
			
			var _FIELDS_TO_OBSERVE = ["Level", "Label"];
			var _observed = {}; 
			for(var f in _FIELDS_TO_OBSERVE) //accumulate field values and their counts
			{
				_observed[_FIELDS_TO_OBSERVE[f]] = {};
				_filterStyleEl[_FIELDS_TO_OBSERVE[f]] = 0;
			}
					
			var _showFilterControls = false;
				
			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////
			
			//init called once body has loaded
			function init() {
				
				var styleEl = document.getElementsByTagName('style')[0];
				var str = styleEl.innerHTML;
				Debug.log("Changing primary foreground color to " + DesktopContent.getDefaultDesktopColor());
				str = str.replace(/#4D2600/g,DesktopContent.getDefaultDesktopColor());
				styleEl.innerHTML = str;		
				
				document.body.style.backgroundColor = DesktopContent.getDefaultWindowColor();
				
				_historyEl = document.getElementById('consoleHistory');
				_historyContainerEl = document.getElementById('consoleHistoryContainer');
				_usersEl = document.getElementById('usersArea');
				_usersContainerEl = document.getElementById('usersContainer');
				_consoleEl = document.getElementById('chatText');
				_linkEl = document.getElementById('userLinkText');
				_controlsContainerEl = document.getElementById('controlsContainer');
				_controlsEl = document.getElementById('controlsArea');
		    	_compactViewCheckbox = document.getElementById('compactView');
		    	_compactViewCheckbox.onmouseup = toggleCompactView;
		    	_noWrapCheckbox = document.getElementById('noWrapCheckbox');
		    	_noWrapCheckbox.onmouseup = toggleNoWrap;
		    	_hideLineNumbersCheckbox = document.getElementById('hideLineNumbersCheckbox');
		    	_hideLineNumbersCheckbox.onmouseup = toggleHideLineNumber;
							
				
			    //init chat history
			    _consoleMessageArray = new Array();
				for(var i=0;i<_consoleHistoryFields.length;++i)
					_consoleMessageArray.push(new Array());
				_consoleEl.innerHTML = "--- Console messages will be displayed here. Old messages will scroll up as new messages are received. ---";
				
				window.onresize = redrawConsoleWindow;
				_historyEl.onmousewheel = handleUserInputScroll;
				_historyEl.onmousedown = handleUserInputScroll;
				_historyEl.onscroll = handleUserScroll;
				_historyEl.onmousemove = handleMouseMoveScroll;
				
				redrawConsoleWindow(); //setup window divs
				initSideBar();
				
			    getConsoleUpdates(); //get initial update			    
			    	
			    _compactViewCheckbox.disabled = false; 	//enable compact view checkbox selection
			    _compactViewCheckbox.checked = true; 	//inverse of default value
			    _noWrapCheckbox.disabled = false; 		//enable checkbox selection
			    _noWrapCheckbox.checked = false;		//inverse of default value
			    _hideLineNumbersCheckbox.disabled = false; 		//enable checkbox selection
			    _hideLineNumbersCheckbox.checked = true;		//inverse of default value

			    toggleNoWrap(undefined,undefined,true /*doNotSave*/); 			//call to setup no wrap first time
			    toggleCompactView(undefined,undefined,true /*doNotSave*/); 		//call to setup compact view first time
			    toggleHideLineNumber(undefined,undefined,true /*doNotSave*/); 	//call to setup hide line numbers first time
			    toggleFilterControls();		//call to initially setup
			    
			    //call to setup colorScheme first time
				DesktopContent.XMLHttpRequest("Request?RequestType=LoadUserPreferences", "",
						handleLoadUserPreferences);
			}

			//toggleNoWrap ~
			// 	toggle no wrap on/off. Use e to determine if function call came from checkbox or link	
			//	Note: when from checkbox, event gives stale value.
			function toggleNoWrap(e, setVal, doNotSave) {	
				
				if(_noWrapCheckbox.disabled) return; //do nothing if disabled

				if(!e) _noWrapCheckbox.checked = !_noWrapCheckbox.checked; //do action if from link
			
				//	Note: when from checkbox, event gives stale value.
				var chk = e?!_noWrapCheckbox.checked:_noWrapCheckbox.checked;	
				
				if(setVal !== undefined)
				{
					//override 
					chk = setVal?true:false;
					_noWrapCheckbox.checked = chk;
				}
				else if(!doNotSave)
					saveUserPreferences(undefined,undefined,chk);
				
				Debug.log("Console _noWrapCheckbox.checked: " + chk);			

				
				//remove _noWrapStyleEl
				if(_noWrapStyleEl && _noWrapStyleEl.parentNode)
				{
					_noWrapStyleEl.parentNode.removeChild(_noWrapStyleEl);
					_noWrapStyleEl = 0;
				}
				
				//hide elaborated text if compact, else delete the extra style
				if(chk) 
				{
					//if compact, add hide style for class 'elaboratedEntry'
					var css = ".consoleEntry " +
							"{" +					
							"white-space: nowrap;" +
							"}\n\n";
					//add style element to HEAD tag
					_noWrapStyleEl = document.createElement('style');

					if (_noWrapStyleEl.styleSheet) {
						_noWrapStyleEl.styleSheet.cssText = css;
					} else {
						_noWrapStyleEl.appendChild(document.createTextNode(css));
					}

					document.getElementsByTagName('head')[0].appendChild(_noWrapStyleEl);
				}
			}
			
			//toggleHideLineNumber ~
			// 	toggle hide line numbers on/off. Use e to determine if function call came from checkbox or link	
			//	Note: when from checkbox, event gives stale value.
			function toggleHideLineNumber(e, setVal, doNotSave) {	
				
				if(_hideLineNumbersCheckbox.disabled) return; //do nothing if disabled

				if(!e) _hideLineNumbersCheckbox.checked = !_hideLineNumbersCheckbox.checked; //do action if from link

				//	Note: when from checkbox, event gives stale value.
				var chk = e?!_hideLineNumbersCheckbox.checked:_hideLineNumbersCheckbox.checked;	

				if(setVal !== undefined)
				{
					//override 
					chk = setVal?true:false;
					_hideLineNumbersCheckbox.checked = chk;
				}
				else if(!doNotSave)
					saveUserPreferences(undefined,undefined,undefined,undefined,chk);
				
				Debug.log("Console _hideLineNumbersCheckbox.checked: " + chk);

				//remove _hideLineStyleEl
				if(_hideLineStyleEl && _hideLineStyleEl.parentNode)
				{
					_hideLineStyleEl.parentNode.removeChild(_hideLineStyleEl);
					_hideLineStyleEl = 0;
				}

				//hide elaborated text if compact, else delete the extra style
				if(chk) 
				{
					//if compact, add hide style for class 'elaboratedEntry'
					var css = ".lineNumberEntry " +
							"{" +					
							"display: none;" +
							"}\n\n";
					//add style element to HEAD tag
					_hideLineStyleEl = document.createElement('style');

					if (_hideLineStyleEl.styleSheet) {
						_hideLineStyleEl.styleSheet.cssText = css;
					} else {
						_hideLineStyleEl.appendChild(document.createTextNode(css));
					}

					document.getElementsByTagName('head')[0].appendChild(_hideLineStyleEl);
				}
			}
			
			//toggleCompactView ~
			// 	toggle compact view on/off. Use e to determine if function call came from checkbox or link	
			//	Note: when from checkbox, event gives stale value.
			function toggleCompactView(e, setVal, doNotSave) {			
				if(_compactViewCheckbox.disabled) return; //do nothing if disabled
								
				if(!e) _compactViewCheckbox.checked = !_compactViewCheckbox.checked; //do action if from link
				

				//	Note: when from checkbox, event gives stale value.
				var chk = e?!_compactViewCheckbox.checked:_compactViewCheckbox.checked;	
				
				if(setVal !== undefined)
				{
					//override 
					chk = setVal?true:false;
					_compactViewCheckbox.checked = chk;
				}
				else if(!doNotSave)
					saveUserPreferences(undefined,undefined,undefined,chk);
				
				Debug.log("Console _compactViewCheckbox.checked: " + chk);				
					

				//remove _compactStyleEl
				if(_compactStyleEl && _compactStyleEl.parentNode)
				{
					_compactStyleEl.parentNode.removeChild(_compactStyleEl);
					_compactStyleEl = 0;
				}
				
				//hide elaborated text if compact, else delete the extra style
				if(chk) 
				{
					//if compact, add hide style for class 'elaboratedEntry'
					var css = ".elaboratedEntry " +
							"{" +					
							"display: none;" +
							"}\n\n";
					//add style element to HEAD tag
					_compactStyleEl = document.createElement('style');

					if (_compactStyleEl.styleSheet) {
						_compactStyleEl.styleSheet.cssText = css;
					} else {
						_compactStyleEl.appendChild(document.createTextNode(css));
					}

					document.getElementsByTagName('head')[0].appendChild(_compactStyleEl);
				}

			}
			
			//redrawConsoleWindow ~
			// 	refreshes chat window, called when window is resized
			function redrawConsoleWindow(showSideBar) {			

			    Debug.log("Chat redrawChat to " + window.innerWidth + " - " + window.innerHeight);
			    
			    var w = window.innerWidth;
			    var h = window.innerHeight;
			    			     
			    if(showSideBar !== undefined) //take input setting if one
			    	_displaySidePane = showSideBar;
			    if(_displaySidePane) 
			    {
			    	_usersContainerEl.style.display = "block";
			    	_usersContainerEl.style.left = (w - _MARGIN - _USERS_WIDTH)  + "px";
			    	_usersContainerEl.style.top = (_MARGIN + _OFFSET_Y) + "px";
			    	_usersEl.style.width = (_USERS_WIDTH - 2 - 2 - 17) + "px";
			    	_usersEl.style.height = (h - _MARGIN - _MARGIN - _MARGIN - _INPUT_HEIGHT - 30 - _OFFSET_Y) + "px";
			    	

			    	_controlsContainerEl.style.display = "block";
			    	_controlsContainerEl.style.left = (w - _MARGIN - _USERS_WIDTH)  + "px";
			    	_controlsContainerEl.style.top = (h - _MARGIN - _INPUT_HEIGHT) + "px";
			    	_controlsEl.style.width = (_USERS_WIDTH - 2 - 2 - 17) + "px";
			    	_controlsEl.style.height = (_INPUT_HEIGHT - 30 - 4) + "px";
			    	
			    	w -= _USERS_WIDTH + _MARGIN + _MARGIN; //alter w for remaining elements
			    	
			    	_linkEl.innerHTML = "Hide Side Bar";			    	
			    }
			    else
			    {
			    	_usersContainerEl.style.display = "none";
			    	_controlsContainerEl.style.display = "none";
			    	_linkEl.innerHTML = "Show Side Bar";
			    }
			    
			    _historyContainerEl.style.left = _MARGIN + 2 + "px";
			    _historyContainerEl.style.top = _MARGIN + _OFFSET_Y + "px";
			    _historyEl.style.width = (w - _MARGIN - _MARGIN - 2 - 2 - 17) + "px";
			    _historyEl.style.height = (h - _MARGIN - _MARGIN - 30 - _OFFSET_Y) + "px";

				if(_scrollWithNewChats)
					_historyEl.scrollTop = _historyEl.scrollHeight;
			}		
			
			//convertForClient ~
			//	replace html/xhtml reserved characters with equivalent for client display.
			//	reserved: ", ', &, <, >, newline, space
			function convertForClient(str) {
				
				//tab &#009; %09 
					//is 8 spaces on linux console - do the same
				var t;
				var s;
				var i,c;
				var tabSz = 8;
				while((t = str.indexOf("\t")) != -1)
				{
					s = ""; //determine the number of spaces to represent the tab as
					c = (tabSz-(t%tabSz)); 
					if(c<=1) c+=tabSz; //make sure tab space is > 1
					for(i=0;i<c;++i)
						s += "&nbsp;";
					str = [str.slice(0, t), s, str.slice(t+1)].join('');
				}
				
				//replace special HTML chars-----------
			    return str
			         .replace(/%26/g, "&amp;")  			//&
			         .replace(/%3C/g, "&lt;") 				//<
			         .replace(/%3E/g, "&gt;")				//>
			         .replace(/%22/g, "&quot;")				//"
			         .replace(/%27/g, "&#039;")				//'
			         .replace(/%0A%0D/g, "<br>")			//newline
			         .replace(/%20%20/g, "&nbsp;&nbsp;");	//space
			    
			 }
			
			//toggleSideBar ~
			// 	send chat to server
			function toggleSideBar() {	
			    redrawConsoleWindow(!_displaySidePane);
			    Debug.log("Chat toggleSideBar now is " + _displaySidePane);	
				saveUserPreferences(undefined,_displaySidePane);
			}
			
			//getConsoleUpdates ~
			// 	get chat updates from server
			//	if _lastUpdateIndex doesn't match server, server will give all new info since
			//	initially _lastUpdateIndex = 0
			function getConsoleUpdates() {		
				
			    if(_consoleUpdateTimer) //only allow one timer for updates at a time
			    	clearTimeout(_consoleUpdateTimer);	
			    
				DesktopContent.XMLHttpRequest("Request?RequestType=GetConsoleMsgs", 
										"lcount="+_lastUpdateCount+"&lindex="+_lastUpdateIndex,
										handleRefreshConsole,
										0, //reqParam
										0, //progressHandler
										true); //callHandlerOnErr);
			}			
			
			//handleRefreshConsole ~
			// 	handle server response, even on error
			function handleRefreshConsole(req) {
				
				if(!req) 
				{
					Debug.log("Console handleRefreshConsole req=0!");// + req.responseText);
					document.getElementById("consoleConnectionStatus").style.display = "block"; //show DISCONNECTED
					return;
				}
				
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err)
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					document.getElementById("consoleConnectionStatus").style.display = "block"; //show DISCONNECTED
					return; //this stops refershing, because no future refresh is schedule
				}

			    var tmp = DesktopContent.getXMLValue(req,"last_update_index");
			    if(tmp) _lastUpdateIndex = tmp;
			    tmp = DesktopContent.getXMLValue(req,"last_update_count");
			    if(tmp) _lastUpdateCount = tmp;
			    
			    //Debug.log("Chat _lastUpdateIndex now is " + _lastUpdateIndex);	
			    
			    var msgs = req.responseXML.getElementsByTagName("messages")[0];
			    if(msgs) //if messages list is present in req
			    {			    
			    	_consoleMessageArray = new Array();
				    
				    //fill _consoleMessageArray for each field
			    	var lengthVerify = -1;			    	
					for(var f in _consoleMessageFields)
					{
						_consoleMessageArray.push(
								msgs.getElementsByTagName("message_" + _consoleMessageFields[f]));
						
						if(lengthVerify == -1)
							lengthVerify = _consoleMessageArray[_consoleMessageArray.length-1].length;
						else if(lengthVerify !=  _consoleMessageArray[_consoleMessageArray.length-1].length)
						{
							Debug.log("Message fields received are incomplete!",Debug.HIGH_PRIORITY);
							document.getElementById("consoleConnectionStatus").style.display = "block"; //show DISCONNECTED
							return; //this stops refershing, because no future refresh is schedule
						}
					}
					
					updateConsoleHistory();	
					updateSideBarCounts(); //must be called after console history update
			    }
			    
			    document.getElementById("consoleConnectionStatus").style.display = "none"; //hide DISCONNECTED
			    _consoleUpdateTimer = window.setTimeout(getConsoleUpdates,_REFRESH_INTERVAL); //schedule next update			    
			}


			//initSideBar ~
			// 	update chat users from _chatUsersArray
			function initSideBar() {
								
				var str = "";
				
				str += "<a id='filterControlsLink' class='consoleLink' " +
						"href='Javascript:toggleFilterControls();' " + 
						"title='Toggle Filter Controls' >Hide Filters</a>";
				str += "<a id='PauseControlsLink' class='consoleLink' " +
						"href='Javascript:togglePauseControls();' " + 
						"title='Toggle Pause and Resume Updates' >Pause</a>";

				str += "<div id='filterContainer'>";
				for(var f in _FIELDS_TO_OBSERVE) //create filter divs for each field's multiselect box
				{
					str += "<div id='" + _FIELDS_TO_OBSERVE[f] + 
							"sFilterSelect' style='display:none'></div>";

					str += "<a id='filterControlsLink' class='consoleLink' " +
							" style='float:right; margin: -10px 50px 0 0;' " +
							"href='Javascript:clearFilterControls(\"" + _FIELDS_TO_OBSERVE[f] +	"\");' " + 
							"title='Clear " + _FIELDS_TO_OBSERVE[f] + " Filter' >Clear</a>";
				}						
				
				str += "</div>"; //close filterContainer
				
				str += "<div id='consoleCounts' style='display:block'>";
				
				str += "</div>"; //close consoleCounts
				
				_usersEl.innerHTML = str;
				
				updateSideBarCounts();
				updateFilterBoxes();
			}
			
			//updateSideBarCounts ~
			function updateSideBarCounts() //must be called after console history update
			{
				var el = document.getElementById('consoleCounts');

				var str = "";
				var fieldStr, countStr;
				for(var f in _FIELDS_TO_OBSERVE) //show accumulated field values and their counts
				{
					str += "<br><u>" + _FIELDS_TO_OBSERVE[f] +
							"s: counts</u><br>";
					fieldStr = ""; countStr = "";
					for(var i in _observed[_FIELDS_TO_OBSERVE[f]])		
					{
						fieldStr += i + ": <br>";
						countStr += _observed[_FIELDS_TO_OBSERVE[f]][i] + "<br>";
						//						str += "<tr><td>";
						//						str += i + ": ";
						//						str += "</td><td>";
						//						str += _observed[_FIELDS_TO_OBSERVE[f]][i];
						//						str += "</td></tr>";
					}

					str += "<table class='countsTable' style='width:" + 
							(_USERS_WIDTH - 2 - 2 - 17) + "px" + ";'>";
					str += "<tr><td style='overflow-x:auto'>" + fieldStr + 
							"</td><td style='width:50px;overflow-x:auto'>" + 
							countStr + "</td></tr>";
					str += "</table>"			
				}			
				el.innerHTML = str;
			}
			
			//updateFilterBoxes ~
			function updateFilterBoxes()
			{
				Debug.log("Draw filter controls");
				
				//do nothing if not currently shown
				if(!_displaySidePane || !_showFilterControls) return;
			
				Debug.log("Draw filter controls true");

				//setup filter box for each field observed
				var el;
				var filterH = 165; //((_usersEl.offsetHeight - 2 - _MARGIN*7)/2)|0; //force as int								
				var keys;
				for(var f in _FIELDS_TO_OBSERVE) //accumulate field values and their counts
				{
					//setup field filter
					el = document.getElementById(_FIELDS_TO_OBSERVE[f] + 'sFilterSelect');
					keys = [];
					for(var label in _observed[_FIELDS_TO_OBSERVE[f]])
						keys.push(label);

					el.style.display = "block";
					el.style.width = (_usersEl.offsetWidth - 2 - 17) + "px"; //-17 for scrollbar
					el.style.height = filterH + "px";
					MultiSelectBox.createSelectBox(el,
							_FIELDS_TO_OBSERVE[f] + "sFilter",
							_FIELDS_TO_OBSERVE[f] + " Filter:",
							keys,0,0,"filterSelectionHandler",false);
				}

				MultiSelectBox.initMySelectBoxes();	            
			}

			//filterSelectionHandler ~
			//	parameter is selected element
			function filterSelectionHandler(el) {
	            var splits = el.id.split('_');
	            var i = splits[splits.length-1] | 0;
	            var selects = MultiSelectBox.mySelects_[el.parentElement.id];
	            Debug.log(el.parentElement.id + " Chosen element index:" + i + 
	            		" key:",el.getAttribute("key-value"));
	            for(var s in selects)
	            	Debug.log(el.parentElement.id + " selected: " + selects[s]);

	            
				var field = el.parentNode.id.slice(7,el.parentNode.id.indexOf("sFilter"));
	            
	            
	            //remove _filterStyleEl
	            if(_filterStyleEl[field] && _filterStyleEl[field].parentNode)
	            {
	            	_filterStyleEl[field].parentNode.removeChild(_filterStyleEl[field]);
	            	_filterStyleEl[field] = 0;
	            }

	            //hide filtered messages	            
				var css = "";
				
				//for current observed field, hide all that aren't selected
					//if none are selected hide none

				for(i=0;i<selects.length;++i)
					if(selects[i])
						break;
				if(i == selects.length) return; //none selected, so hide none
				
				//else some selected, so hide those not selected
				var tmpKeys = Object.keys(_observed[field]);
				for(i=0;i<selects.length;++i)
					if(!selects[i])
					{
						Debug.log("Hiding " + tmpKeys[i]);
						css += "." + tmpKeys[i] + "_" + 
								field + "Entry " +
								"{" +					
								"display: none;" +
								"}\n\n";
					}				
				
				//add style element to HEAD tag
				_filterStyleEl[field] = document.createElement('style');

				if (_filterStyleEl[field].styleSheet) {
					_filterStyleEl[field].styleSheet.cssText = css;
				} else {
					_filterStyleEl[field].appendChild(document.createTextNode(css));
				}

				document.getElementsByTagName('head')[0].appendChild(_filterStyleEl[field]);
	        }
			
			//clearFilterControls ~
			function clearFilterControls(field)
			{
	            var selects = MultiSelectBox.mySelects_["selbox-" + field + "sFilter"];
				for(var s in selects)
					selects[s] = 0;

				MultiSelectBox.initMySelectBoxes();	  //repaint
				
				//remove hiding style css _filterStyleEl
				if(_filterStyleEl[field] && _filterStyleEl[field].parentNode)
				{
					_filterStyleEl[field].parentNode.removeChild(_filterStyleEl[field]);
					_filterStyleEl[field] = 0;
				}
			}
			
			//updateConsoleHistory ~
			// 	add console history from _consoleMessageArray
			function updateConsoleHistory() {
				
				if(!_consoleMessageArray || //if _consoleMessageArray incomplete, do nothing (should never happpen?)
						_consoleMessageArray.length != _consoleMessageFields.length) return;
			    
				var newChatFound = false;
				var str = "";
				var tmp = {};  //tmp holder of values we care to observer
				for(var f in _FIELDS_TO_OBSERVE) 
					tmp[_FIELDS_TO_OBSERVE[f]] = {}; 			
				
				var firstMsg, secondMsg, secondMsgIndex;
				
				var observedSz = {};
				for(var f in _FIELDS_TO_OBSERVE) //accumulate field values and their counts
					observedSz[_FIELDS_TO_OBSERVE[f]] = Object.keys(_observed[_FIELDS_TO_OBSERVE[f]]).length; 
				
				for(var i=0;i<_consoleMessageArray[0].length;++i)  //assume all fields' arrays are same length (checked by req handler)
				{		 			
					tmp.Label = _consoleMessageArray[_MESSAGE_FIELD_LABEL][i].getAttribute('value');
					tmp.Level = _consoleMessageArray[_MESSAGE_FIELD_LEVEL][i].getAttribute('value');
					
					firstMsg = "";
					secondMsg = _consoleMessageArray[_MESSAGE_FIELD_MSG][i].getAttribute('value');
					secondMsgIndex = secondMsg.indexOf(']\t'); //find end of line number display
					if(secondMsgIndex != -1)
					{
						firstMsg = secondMsg.slice(0,secondMsgIndex+2);
						secondMsg = secondMsg.slice(secondMsgIndex+2);
					}
					else
					{						
						//artdaq does one space, then <source>:<line number> then new line (ascii-10)
						secondMsgIndex = secondMsg.indexOf(':'); //find end of line number display (artdaq style)
						if(secondMsgIndex > 0 && // : found
								( 		//before any spaces
										secondMsgIndex < secondMsg.indexOf(' ',1) ||
										secondMsgIndex < secondMsg.indexOf('\n',1) ||
										secondMsgIndex < secondMsg.indexOf('\t',1)) && 
								secondMsgIndex+2 < secondMsg.length && //there is at least the number at the space/newline after
								secondMsg[secondMsgIndex+1] >= '0' &&
								secondMsg[secondMsgIndex+1] <= '9')
						{
							//get space after ':##'
							while(++secondMsgIndex < secondMsg.length &&
									secondMsg[secondMsgIndex] >= '0' &&
									secondMsg[secondMsgIndex] <= '9');
							if(secondMsgIndex != -1)
							{
								firstMsg = secondMsg.slice(0,secondMsgIndex+1);
								secondMsg = secondMsg.slice(secondMsgIndex+1);
							}
						}
											
					}
					firstMsg = convertForClient(firstMsg);
					secondMsg = convertForClient(secondMsg);
					
					//important to only have one /div> per entry for truncate
					str += "<div class='consoleEntry' style='color:" + 
						getColorForLevel(tmp.Level) + "'>" +
						"<span class='" + tmp.Label + "_LabelEntry'>" + 
						"<span class='" + tmp.Level + "_LevelEntry'>" + //open label level span (for filtering)
						"<span class='elaboratedEntry'><b>" +
						tmp.Level + " " +
						"(" + formatTime(_consoleMessageArray[_MESSAGE_FIELD_TIME][i].getAttribute('value')) + ") ";					 
					str += tmp.Label + ":</b> " +
							"</span><span class='lineNumberEntry'>" +
						firstMsg + "</span>" + secondMsg + 
						"</span></span>" + //close label level span (for filtering)
						"</div>"; //important to only have one /div> per entry for truncate
						
					//aggragate stats for each observed field
					for(var f in _FIELDS_TO_OBSERVE) //accumulate field values and their counts
						_observed[_FIELDS_TO_OBSERVE[f]][tmp[_FIELDS_TO_OBSERVE[f]]] = 
								(_observed[_FIELDS_TO_OBSERVE[f]][tmp[_FIELDS_TO_OBSERVE[f]]] | 0) + 1; //this works when undefined also
				}
				
				//check to see if filter boxes need to be updated due to new fields
				for(var f in _FIELDS_TO_OBSERVE) //accumulate field values and their counts
					if(observedSz[_FIELDS_TO_OBSERVE[f]] != Object.keys(_observed[_FIELDS_TO_OBSERVE[f]]).length)
					{
						Debug.log("Filter update needed for " + _FIELDS_TO_OBSERVE[f]);
						updateFilterBoxes();
						break;
					}

				//for debugging:
				//				for(var i in _observedLabels)					
				//					Debug.log(i + ": " + _observedLabels[i]);	
				
				str = _consoleEl.innerHTML + str;	
				var lendiff = str.length - _CONSOLE_HISTORY_MAX_LENGTH;	
				if(lendiff > 0) //truncate chat history at entry div start
					_consoleEl.innerHTML = str.substr(str.indexOf("/div>",lendiff) + 5);
				else
					_consoleEl.innerHTML = str; 
				
				if(_scrollWithNewChats)
					_historyEl.scrollTop = _historyEl.scrollHeight;
			}
			
			//clearConsoleMessages ~
			function clearConsoleMessages() {
				_consoleEl.innerHTML = "";
			}
			
		
			//formatTime ~
			function formatTime(t) {
				var date = new Date(t * 1000);
				var mm = date.getMinutes() < 10?"0"+date.getMinutes():date.getMinutes();
				var ss = date.getSeconds() < 10?"0"+date.getSeconds():date.getSeconds();				
				return date.getHours() + ":" + mm + ":" + ss;
			}
			
			//getColorForLevel ~
			//	generate color based on user index in user list
			function getColorForLevel(lvl) {
				switch(_chosenColorScheme)
				{
				default:
				case 0: //black and green
					if(lvl == "Error")
						return "rgb(255,51,51)";
					if(lvl == "Warning")
						return "rgb(255,150,50)";
					if(lvl == "Info")
						return "rgb(50, 186, 255)";
					
					return "auto";	
				case 1: //white and black
					if(lvl == "Error")
						return "rgb(255,51,51)";
					if(lvl == "Warning")
						return "rgb(214, 128, 46)";
					if(lvl == "Info")
						return "rgb(50, 110, 255)";
					
					return "auto";	
				case 2: //transparent blue
					if(lvl == "Error")
						return "rgb(255,51,51)";
					if(lvl == "Warning")
						return "rgb(214, 128, 46)";
					if(lvl == "Info")
						return "rgb(50, 110, 255)";
					
					return "auto";	
				}	
			}

			//toggleColorScheme ~
			//	cycle through an array of [background,foreground] schemes
			function toggleColorScheme() {
				setupColorScheme(_chosenColorScheme + 1);
				saveUserPreferences(_chosenColorScheme);
			}

			//saveUserPreferences ~
			//	save user preferences to server
			function saveUserPreferences(colorIndex,showSideBar,noWrap,messageOnly,hideLineNumers) {
				
				//take new values from inputs if given, otherwise determine current value
				if(colorIndex === undefined)
					colorIndex = _chosenColorScheme;
				if(showSideBar === undefined)
					showSideBar = _displaySidePane;
				if(noWrap === undefined)
					noWrap = noWrapCheckbox.checked;
				if(messageOnly === undefined)
					messageOnly = _compactViewCheckbox.checked;
				if(hideLineNumers === undefined)
					hideLineNumers = _hideLineNumbersCheckbox.checked;
				
				//force only integer values in request
			    DesktopContent.XMLHttpRequest("Request?RequestType=SaveUserPreferences", 
			    										"colorIndex=" + (colorIndex|0) +
														"&showSideBar=" + (showSideBar?1:0) +
														"&noWrap=" + (noWrap?1:0) +
														"&messageOnly=" + (messageOnly?1:0) +
														"&hideLineNumers=" + (hideLineNumers?1:0));
			}
						
			//handleLoadUserPreferences(req) ~
			function handleLoadUserPreferences(req) {
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err)
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}
				
				Debug.log("handleLoadUserPreferences");
				if(!DesktopContent.getXMLValue(req,"colorIndex") || 
						DesktopContent.getXMLValue(req,"colorIndex") == "")
				{
					Debug.log("handleLoadUserPreferences problem, so ignoring.");
					return;					
				}
				//else trust values
				setupColorScheme(DesktopContent.getXMLValue(req,"colorIndex")|0);				
				redrawConsoleWindow((DesktopContent.getXMLValue(req,"showSideBar")|0)?true:false); //input is showSideBar
				toggleNoWrap(0,(DesktopContent.getXMLValue(req,"noWrap")|0)?true:false);
				toggleCompactView(0,(DesktopContent.getXMLValue(req,"messageOnly")|0)?true:false);
				toggleHideLineNumber(0,(DesktopContent.getXMLValue(req,"hideLineNumers")|0)?true:false);
			}
			
			
			//setupColorScheme(i) ~
			function setupColorScheme(i) {
				_chosenColorScheme = (i|0) % _colorSchemes.length;
				if(_chosenColorScheme < 0) _chosenColorScheme = 0; //mod allows negative.. prevent

			    _historyContainerEl.style.backgroundColor = _colorSchemes[_chosenColorScheme][0];
			    _historyContainerEl.style.color = _colorSchemes[_chosenColorScheme][1];				
			}
			
			
			//toggleFilterControls ~
			//	show/hide filter selection
			function toggleFilterControls() {
				 
				_showFilterControls = !_showFilterControls; //toggle

				var el = document.getElementById("filterControlsLink");
				el.innerHTML = _showFilterControls?"Hide Filters":"Show Filters";
											
				el = document.getElementById('filterContainer');
	            el.style.display = _showFilterControls?"block":"none";
	            updateFilterBoxes(); //update multi select box
			}
			
			//togglePauseControls ~
			function togglePauseControls() {

				var pause = _consoleUpdateTimer?true:false;
				Debug.log("Need to pause: " + pause);
				if(pause)				
				{
					clearTimeout(_consoleUpdateTimer);
					_consoleUpdateTimer = 0;
				}
				else
					_consoleUpdateTimer = window.setTimeout(getConsoleUpdates,_REFRESH_INTERVAL); //schedule next update		

				var el = document.getElementById("PauseControlsLink");
				el.innerHTML = pause?"Resume":"Pause";				
			}


			//handleUserScroll ~
			//	identify when user wants to keep up with live chats
			function handleUserScroll(e) {							    
				if(_userMouseInput) //only mess with scroll if user did something with mouse recently
					_scrollWithNewChats = (_historyEl.scrollTop >=_historyEl.scrollHeight - _historyEl.offsetHeight - 2);	

				DesktopContent.handleScroll(e);
			}
			
			//handleUserInputScroll ~
			//	identify when user used mouse and wants to keep up with live chats
			function handleUserInputScroll(mouseEvent) {
				_userMouseInput = true;
				
				DesktopContent.handleScroll(mouseEvent);
			}

			//handleMouseMoveScroll ~
			//	identify when user released the mouse, to be considerd by scroll handler
			function handleMouseMoveScroll(mouseEvent) {
				if(_userMouseInput && mouseEvent.which == 0) //mouse button released
					_userMouseInput = false;
			}
			
			
		</script>
		
	</head>
	
	
	<body onload='Javascript:init();'>			

		<div id='consoleInstructions'>
			<a href='Javascript:toggleColorScheme();' title='Toggle Color Scheme' class='consoleLink' id='userLinkColor'>Toggle Color Scheme</a>
		</div>
		
		<div id='consoleConnectionStatus'>
			<a href='Javascript:getConsoleUpdates();' title='Attempt to Reconnect Console' class='consoleLink'>*** DISCONNECTED ***</a>
		</div>
		
		<div id='userLink'>
			<a href='Javascript:toggleSideBar();' title='Toggle User Side Pane' class='consoleLink' id='userLinkText'></a>		 
		</div>

		<div id='clearConsoleLink'>
			<a href='Javascript:clearConsoleMessages();' title='Clear Console Messages' class='consoleLink' id='userLinkText'>Clear Console</a>		 
		</div>
						
		<div id='consoleHistoryContainer'>
			<div id='consoleHistory'>
			<table height='100%'><td height='100%' valign='bottom'>
			<div id='chatText'></div>
			</td></table>
			</div>
		</div>

		<div id='usersContainer'>
			<div id='usersArea'>
			</div>
		</div>			
			
		<div id='controlsContainer'>
			<div id='controlsArea'>
				<div class='controlsCheckbox'>
					<input type="checkbox" id="compactView" />
						<div id='compactViewText'>
							<a class="consoleLink"
								href='Javascript:toggleCompactView();' 
								title='Toggle Compact View' >Message Only</a>
						</div>
				</div>
		
				<div class='controlsCheckbox'>
					<input type="checkbox" id="noWrapCheckbox" />
						<div id='noWrapCheckboxText'>
							<a class="consoleLink"
								href='Javascript:toggleNoWrap();' 
								title='Toggle No Wrap' >No Wrap</a>
						</div>
				</div>

				<div class='controlsCheckbox' style='display:block'> <!-- seems that line numbers are not in the default messages anymore? just set display to 'block' to bring this back -->
					<input type="checkbox" id="hideLineNumbersCheckbox" />
						<div id='hideLineNumbersCheckboxText'>
							<a class="consoleLink"
								href='Javascript:toggleHideLineNumber();' 
								title='Toggle Hide Line Numbers' >Hide Line Numbers</a>
						</div>	
				</div>	
			</div>
		</div>
			
	</body>
	
</html>
