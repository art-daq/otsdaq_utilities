<!DOCTYPE HTML>
<html lang="en"> 
	<head>
		<title>ConfigurationGUI</title>
		<style type="text/css">			
			body {
				background-color: rgb(200,200,200);
			}
			
			#clearDiv {
				clear: both;
			}
			
			a {
				color: blue;
			}
			
			#display {
				padding: 20px;
			}
			
		</style>
		
		
		<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
		<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
		<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
		
		<script>		
			
			//Start by offering two views (System Configurations) (Sub-Configurations)
			//	and default to System Configurations
			//
			//High Level Goals:
			//	- Allow to select a System Config to edit or start anew (all sub-config versions are dont cares)
			//		- Be able to edit the versions associated with the System Config while 
			//		viewing other System Configs for inspiration
			//	- Allow to select a sub-configuration to edit or start anew (from mock-up)
			//		- Be able to edit a sub-config, and view others to copy chunks from them
			//
		
		
			//In System Configuration mode:
			//	List the existing configuration aliases
			//		with possibly ability to scroll through associated sub-configs
			//
		
			//In Sub-Configuration mode:
			//	List the existing versions
			//		with possibly scrolling information about the version (# of rows, lastuseddate, etc.)
			//	Some Sub-Configurations will need special views:
			//		ability to add chips (of certain types) to system config...
			//
		
			var _MAX_CHUNK_SIZE = 100; //100 rows per page
		
			var _currentAlias;
			var _editingCell = false;
			var _editingCellEl;
			var _versionIsChanged = false;
			var _version;
			var _dataOffset = 0;
			
			//for tree view
			var treeViewHandlerStr_; //used by recursive function to build html string
			var treeNodeUID_;		//incrementing unique id for nodes
			
		
			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////
		
			//functions:			
				//init()
				//niceName(str)									//removes "Configuration" from name
				//setupSystemViewMode()							//gets global configurations
				//setupSubSystemConfigMode()					//gets configuration tables
				//setupConfigGroup(configGroupName)				//setup editor for specific global configuration
				//setupSpecificConfig(subConfigAlias) 	//setup editor for specific configuration table
				//configRequestHandler(req)
				//subConfigRequestHandler(req)
				//specificConfigRequestHandler(req)
				//specificConfigRequestHandler(req)
				//treeViewHandler(req,parentId,errStr)
				//recursiveDrawTree(parent,depth,path)
				//toggleTreeChildren(depth,uid,nodeName,path)
				//setupConfigGroupTreeView(configGroupName)
				//activateSystemConfig(configGroupName)
				//setupConfigCreator()
				//setupConfigCreatorHandler(req)
				//selectForCreateConfig(i)
				//versionsForCreateConfig(i)
				//createConfigGroup()
				//createConfigGroupHandler(req)
			
				//selectThisCell(r,c,el)
				//editCellCancel()
				//keyHandler(e)
				//editCellOK(r,c)
				//addRow(r)										//add row at destination with default values populated
				//deleteRow(r)									//delete row at destination
				//TODO copyRow(rs,rd)							//copy row from source to destination row
				//TODO moveRow(rs,rd)							//move row from source to destination row
				//saveSubSystemAsNewVersion()
				//saveSubSystemAsNewVersionHandler(req)
		
				//changeKocVersionForSpecificConfig(groupName, configName, newVersion)
		
			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////
							
			
			//init called once body has loaded
			function init() {			
				Debug.log("CfgGUI init");

				//setupConfigGroup("GConfig1");
				setupConfigCreator();
				return;
				
				setupSystemViewMode();
				activateSystemConfig(""); //get active global config
			}	
			
			//return name without "Configuration" unless it is start of the name 
				//or part of the word "Configurations"
			function niceName(str) {	
				var i = str.lastIndexOf("Configuration");
				return str.substr(0,(i>1 && str[i+13] != 's')?i:str.length);
			}
			
			//setupSystemViewMode ~
			function setupSystemViewMode() {

				DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurationGroups", "", configRequestHandler);		
			}
			
			//setupSubSystemConfigMode ~
			function setupSubSystemConfigMode() {

				DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurations", "", subConfigRequestHandler);		
			}

			//setupConfigGroup ~ 
			function setupConfigGroup(configGroupName) {

				DesktopContent.XMLHttpRequest("Request?RequestType=getSpecificConfigurationGroup&alias=" + configGroupName, "", specificConfigRequestHandler);		
			}
			
			//setupSpecificConfig ~
			function setupSpecificConfig(subConfigAlias,version) {
				var v = "";
				if(version) v = "&version="+version;
				DesktopContent.XMLHttpRequest("Request?RequestType=getSpecificConfiguration" + "&dataOffset=0&chunkSize=" + _MAX_CHUNK_SIZE +  
					"&configName=" + subConfigAlias + v, "", specificConfigRequestHandler);		
			}
			
			//configRequestHandler ~
			function configRequestHandler(req) {				
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}
				
				var groupNames = req.responseXML.getElementsByTagName("ConfigurationGroupName");
				var keys = req.responseXML.getElementsByTagName("ConfigurationGroupKey");
				var kocsHdr = req.responseXML.getElementsByTagName("SystemConfigurationKOCs");
						
				var groupName, key;
				
				var el = document.getElementById("display");

				var str = "";
				var configNames, kocVersions;

				str += "<a href='javascript:setupConfigCreator()'>Create a New System Configuration</a>";
				str += "<br><br>";
						
				Debug.log("CfgGUI requestHandler groupNames.length " + groupNames.length);
				if(!groupNames.length)
					str += "No Configuration Groups found.";
				for(var i=0;i<groupNames.length;++i)
				{		
					groupName = groupNames[i].getAttribute("value");
					key = keys[i].getAttribute("value");
					
					//add header
					str += "<a href='javascript:setupConfigGroup(\"" + groupName +
						"\");'>";
					str += groupName + "</a> (" + key +")";
					
					//add tree view link
					str += " <a href='javascript:setupConfigGroupTreeView(\"" + groupName +
						"\",\"" + key + "\");'>";
					str += "Tree-view</a>";										
					
					//add Activate link
					str += " <a href='javascript:activateSystemConfig(\"" + groupName +
							"\",\"" + key + "\");'>";
					str += "Activate</a>";
					
					
					str += "<br><table><tr>";

					configNames = kocsHdr[i].getElementsByTagName("MemberName");
					kocVersions = kocsHdr[i].getElementsByTagName("MemberVersion");
					Debug.log("CfgGUI requestHandler configNames.length " + configNames.length);
					
					for(var j=0;j<configNames.length;++j)
					{
						str += "<td align='center'>";
						str += "<a href='javascript:setupSpecificConfig(\"" + configNames[j].getAttribute("value") +
							"\");'>";
						str += niceName(configNames[j].getAttribute("value")) + "</a><br>" + kocVersions[j].getAttribute("value");
						str += "</td>";
					}
					str += "</tr></table><br>";
				}				
				//Debug.log("CfgGUI requestHandler str " + str);
				el.innerHTML = str;
			}

			function subConfigRequestHandler(req) {					
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}
				
				var aliases = req.responseXML.getElementsByTagName("SystemSubConfigurationAlias");
				var keyHdr = req.responseXML.getElementsByTagName("SystemSubConfigurationVersions");
				
				var el = document.getElementById("display");

				var str = "";
				var configVersions;

				Debug.log("CfgGUI requestHandler aliases.length " + aliases.length);
				for(var i=0;i<aliases.length;++i)
				{					
					str += "<a href='javascript:setupSpecificConfig(\"" + aliases[i].getAttribute("value") +
						"\");'>";
					str += niceName(aliases[i].getAttribute("value"));
					str += "</a><br><table><tr>";

					configVersions = keyHdr[i].getElementsByTagName("VersionKey");
					//Debug.log("CfgGUI requestHandler configNames.length " + configVersions.length);
					
					for(var j=0;j<configVersions.length;++j)
					{
						str += "<td align='center'>";
						str += "version" + "<br>" + configVersions[j].getAttribute("value");
						str += "</td>";
					}
					str += "</tr></table><br>";
				}				
				//Debug.log("CfgGUI requestHandler str " + str);
				el.innerHTML = str;
			}


			function specificConfigRequestHandler(req) {	
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}
				
				var alias = DesktopContent.getXMLValue(req,"ConfigurationGroupName");
				var key = DesktopContent.getXMLValue(req,"ConfigurationGroupKey");
				var historicalKeys = req.responseXML.getElementsByTagName("HistoricalConfigurationGroupKey");

				var configNames = req.responseXML.getElementsByTagName("MemberName");
				var kocVersions = req.responseXML.getElementsByTagName("KOC_currentVersion");
				
				var el = document.getElementById("display");

				var str = "";
				
				var kocExistingVersions;

				str += "<h3><u>Specific System Configuration View</u></h3>";
				str += "<b>" + alias + "</b> (key: " + key + ")<br>";
				
				if(historicalKeys.length)
				{
					str += "View Historical " + alias + " key: ";

					for(var i=0;i<historicalKeys.length;++i)
						str += " " + historicalKeys[i].getAttribute("value");
				}
				else 
					str += "No Historical keys exist for " + alias + ".<br>";
				
				
				str += "<br><a href='javascript:addNewKocForSpecificConfig()'>Add new KOC</a> to "  + alias + "<br><br>";
				//Debug.log("CfgGUI specificConfigRequestHandler KOC length " + configNames.length + " - " + kocVersions.length);
				for(var i=0;i<configNames.length && i<kocVersions.length;++i)
				{
					str += "<b>" + niceName(configNames[i].getAttribute("value")) + "</b> (Current version: " + 
						kocVersions[i].getAttribute("value") +
						")<br>Click below to change "  + niceName(configNames[i].getAttribute("value")) + " Version for " + alias + ":<br>";
						//") <a href='javascript:changeKocVersionForSpecificConfig("+i+")'>Change "  + niceName(configNames[i].getAttribute("value")) + " Version</a> for " + alias + "<br>";
					
					
					str += "Existing versions: " + kocVersions[i].getAttribute("value");

					kocExistingVersions = kocVersions[i].getElementsByTagName("KOC_existingVersion");
					for(var j=0;j<kocExistingVersions.length;++j)
					{
						//str += " " + kocExistingVersions[j].getAttribute("value");
						str += " ";
						str += "<a href='javascript:changeKocVersionForSpecificConfig(\"" +
								alias + "\",\"" + configNames[i].getAttribute("value") + "\"," + 
								kocExistingVersions[j].getAttribute("value");
						str += ")'>" + kocExistingVersions[j].getAttribute("value");
						str += "</a>";
					}				
					
					
					str += "<br><br>";		
				}

				el.innerHTML = str;
			}
			
			function specificConfigRequestHandler(req) {	
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}
				var configName = DesktopContent.getXMLValue(req,"ConfigurationName");
				var version = DesktopContent.getXMLValue(req,"ConfigurationVersion");
				
				
				var kocVersionHdr = req.responseXML.getElementsByTagName("ConfigurationVersions");
				if(!kocVersionHdr.length)
				{	//should never happen (tag can be empty, but must be there)
					Debug.log("Error?! No tag for versions returned for configName: " + configName, Debug.HIGH_PRIORITY);
					return;
				}
				var kocVersions = kocVersionHdr[0].getElementsByTagName("VersionKey");
				
				var rows = req.responseXML.getElementsByTagName("CurrentVersionRows")[0].getElementsByTagName("Row");
				
				var colHdrs = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnHeader");
				var colTypes = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnType");
				
				var el = document.getElementById("display");
				

				//reset globals
				_currentAlias = configName;
				_version = version;
				_editingCell = false;
				_editingCellEl = 0;
				_versionIsChanged = false;
				_dataOffset = rows.length?(rows[0].getAttribute("value") | 0):0;

				var str = "";
				

				str += "<h3><u>Specific Sub-System Configuration View</u></h3>";
				str += "<b>" + configName + "</b> (version: " + (version==-1?"Mockup-View":version) + ")<br>";

				str += "<br>All versions:";
				
				//display mockup link (mockup always present)
				str += " ";
				if(-1 != version)				
					str +=  "<a href='javascript:setupSpecificConfig(\"" + configName +
						"\",\"" + "-1" + "\");'>";
				str += "Mockup-View";
				if(-1 != version)				
					str +=  "</a>";				
				
				//display all other version links
				for(var j=0;j<kocVersions.length;++j)
				{
					str += " ";
					if(kocVersions[j].getAttribute("value") != version)
						str +=  "<a href='javascript:setupSpecificConfig(\"" + configName +
							"\",\"" + kocVersions[j].getAttribute("value") + "\");'>";
					str += kocVersions[j].getAttribute("value");
					if(kocVersions[j].getAttribute("value") != version)
						str += "</a>";
				}
				
				//display table
				str += "<table id='SubSystemTable' border='1' cellspacing='5' cellpadding='1'>";
				str += "<tr>";
				str += "<th>Row</th>"; //insert row index column
				for(var c=0;c<colHdrs.length;++c)
				{
					str += "<th>";
					str += colHdrs[c].getAttribute("value");
					str += "</th>";					
					
				}
				str += "</tr>";
				
				for(var r=0;r<rows.length;++r)
				{
					var rowEntries = rows[r].getElementsByTagName("Entry");
					str += "<tr>";
					str += "<td>" + (_dataOffset + r);	//insert row index column
					
					//add +/- row controls
					str += " <a href='javascript:addRow(" + r + ");'>";
					str += "+";
					str += "</a>";
					str += "/<a href='javascript:deleteRow(" + r + ");'>";
					str += "-";
					str += "</a>";
					
					str += "</td>"; 
					
					for(var c=0;c<colHdrs.length;++c)
					{
						str += "<td onmouseup='selectThisCell("+r+","+c+",this);'>";
						//str += "<input type='text' value='";
						str += rowEntries[c].getAttribute("value");
						//str += "'>";
						str += "</td>";					
						
					}
					str += "</tr>";
				}
					
				str += "</table>";
				
				//add + row controls for new last row
				str += " <a id='lastAddRowLink' href='javascript:addRow(" + r + ");'>";
				str += "+";
				str += "</a>"
				
				
				el.innerHTML = str;
			}
			
			//treeViewHandler ~		
			function treeViewHandler(req,parentId) 
			{				
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}
				
				//draw tree				

				var configGroupName = DesktopContent.getXMLValue(req,"configGroup");
				var configGroupKey = DesktopContent.getXMLValue(req,"configGroupKey");
				var el;
				var depth;
				var parentEl;
				treeViewHandlerStr_ = "";
				
				if(parentId) parentEl = document.getElementById("node-" + parentId);	
				if(parentEl) //then data is being added to an existing node
				{
					//so create children area
					depth = (parentId.split("-")[0] | 0)+1; //parent depth + 1
					Debug.log("Expanding tree for " + parentId + " at depth=" + depth);					
									

					el = document.createElement("div");
					el.setAttribute("id", "children-" + parentId);
					parentEl.appendChild(el);					
				}
				else //this is the initial top level request
				{
					depth = 0;
					treeNodeUID_ = 0; //reset node id
					el = document.getElementById("display");

					//add system config header
					treeViewHandlerStr_ += "<a id='treeView-ConfigGroupLink' " +
						"href='javascript:setupConfigGroup(\"" + configGroupName +
						"\");'>";
					treeViewHandlerStr_ += "<div style='display:none'>" + configGroupName + "</div>";
					treeViewHandlerStr_ += "<div style='display:none'>" + configGroupKey + "</div>";
					treeViewHandlerStr_ += configGroupName + " (" + configGroupKey + ")";
					treeViewHandlerStr_ += "</a><br>";
				}			
				
				//add tree
				var tree = DesktopContent.getXMLNode(req,"tree");
				var preLength = treeViewHandlerStr_.length;
				recursiveDrawTree(tree,depth,tree.getAttribute("value"));
				if(preLength == treeViewHandlerStr_.length)
					treeViewHandlerStr_ += "Empty Tree Found.";
				
				el.innerHTML = treeViewHandlerStr_;
			}

			//recursiveDrawTree ~		
			function recursiveDrawTree(parent,depth,path) 
			{				
				var uid;
				var nodes = parent.children;
				var nodeName;
				var value;
				var i;
				for(i=0;i<nodes.length;++i)
				{
					uid = treeNodeUID_++;
					nodeName = nodes[i].getAttribute("value");
					treeViewHandlerStr_ += "<div id='node-" + depth + "-" + uid + "-" + nodeName + 
							"' style='float:left; margin-left:" + 30*depth + "px'>";
										
					if(nodes[i].children.length && (value = nodes[i].children[0]).nodeName == "value")
					{	//this is a value node!
						treeViewHandlerStr_ += "<b>" + nodeName + "</b>";
						treeViewHandlerStr_ += " : " + value.getAttribute("value");
						treeViewHandlerStr_ += "</div><div id='clearDiv'></div>";
						continue; //so no need to recurse
					}
					
					//not a value node so try to recurse
					treeViewHandlerStr_ += "<a href='javascript:toggleTreeChildren(" + 
							depth + "," +	uid + ",\"" +							
							nodeName + "\",\"" + path +
							"\");'>";					
					treeViewHandlerStr_ += nodes[i].children.length?"-":"+";
					treeViewHandlerStr_ += "</a> ";

					treeViewHandlerStr_ += nodeName;
					treeViewHandlerStr_ += "</div><div id='clearDiv'></div>";	
					
					if(nodes[i].children.length)
					{
						treeViewHandlerStr_ += "<div id='children-" + depth + "-" + uid + "-" + nodeName + "'>";
						recursiveDrawTree(nodes[i],depth+1,path+nodeName+"/");
						treeViewHandlerStr_ += "</div>";
					}
				}
			}
			
			//toggleTreeChildren ~ 
			//	if expanding
			//		if no children div, request new depth
			//		else display children
			//	if minimizing
			//		hide children
			function toggleTreeChildren(depth,uid,nodeName,path) 
			{
				Debug.log("depth: " + depth);
				Debug.log("uid: " + uid);
				Debug.log("nodeName: " + nodeName);
				Debug.log("path: " + path);
				
				var idString = depth + "-" + uid + "-" + nodeName;
				Debug.log("idString: " + idString);
				
				var el = document.getElementById("children-" + idString);
				var configGroupEls = document.getElementById("treeView-ConfigGroupLink").childNodes;
				
				if(el) //if children already exist, then toggle display
					el.style.display = (el.style.display == "none")? "block" : "none";
				else	//if no children div, then request it
					DesktopContent.XMLHttpRequest("Request?RequestType=getTreeView" + 
							"&configGroup=" + configGroupEls[0].innerHTML + 
							"&configGroupKey=" + configGroupEls[1].innerHTML +
							"&depth=1", 
							"startPath="+path+nodeName+"/",treeViewHandler,idString);				
			}
			
			//setupConfigGroupTreeView ~
			function setupConfigGroupTreeView(configGroupName, configGroupKey)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=getTreeView&configGroup=" + 
						configGroupName + "&configGroupKey=" + configGroupKey + "&depth=1", 
						"startPath=/",treeViewHandler);
			}
			
			//activateSystemConfig ~
			function activateSystemConfig(configGroupName)
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=activateGlobalConfig&configGroup=" + 
						configGroupName,"",activateSystemConfigHandler);
			}
			
			//activateSystemConfigHandler ~
			function activateSystemConfigHandler(req,param,errStr)
			{
				//show xml Error if present as popup Debug high priority
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err && err != "") 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;					
				}
				
				var activeConfig = DesktopContent.getXMLValue(req,"activeConfig");
				Debug.log("activeConfig: " + activeConfig);
				
				var str = "";
				str += "Active: ";
				if(!activeConfig || activeConfig == "")
					str += "None";
				else
				{
					str += "<a href='javascript:setupConfigGroup(\"" + activeConfig +
					"\");'>";
					str += activeConfig + "</a>";
				}
				document.getElementById("activeConfig").innerHTML = str;				
			}
			
			//setupConfigCreator ~
			function setupConfigCreator()
			{
				DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurations", "", setupConfigCreatorHandler);
				
			}
			//setupConfigCreatorHandler ~
			function setupConfigCreatorHandler(req)
			{
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}

				var el = document.getElementById("display");
				var str = "";
				
				str += "<div id='createGroupInfo'></div><br>";
				str += "<button type='button' onmouseup='javascript:createConfigGroup()'>" +
						"Create System Config</button>";
				str += "<br><br>";
				str += "System Config Name: <input id='newConfigName'/>";
				str += "<br><br>";
				
				var aliases = req.responseXML.getElementsByTagName("SystemSubConfigurationAlias");
				var keyHdr = req.responseXML.getElementsByTagName("SystemSubConfigurationVersions");
				var alias;
				var version;
			
				Debug.log("aliases.length " + aliases.length);
				
				str += "<table>";
				

				str += "<tr><td>";
				str += "<a href='javascript:selectForCreateConfig(1)'>All</a> | " + 
						"<a href='javascript:selectForCreateConfig(2)'>Context</a> | " +
						"<a href='javascript:selectForCreateConfig(3)'>Detector</a> | " +
						"<a href='javascript:selectForCreateConfig(0)'>None</a><br>";
				str += "</td><td>";

				str += "<a href='javascript:versionsForCreateConfig(0)'>Defaults</a> | " + 
						"<a href='javascript:versionsForCreateConfig(1)'>Latest</a><br>";
				str += "</td>";
				str += "</tr>";
				
				for(var i=0;i<aliases.length;++i)
				{		
					str += "<tr><td>";
					alias = aliases[i].getAttribute("value");
					
					//add link so text toggles checkbox
					str += "<a style='text-decoration:none;color:black;' href='javascript:{" +
							"var el = document.getElementsByClassName(\"subConfigCheckbox\");" +
							"el[" + i + "].checked = !el[" + i + "].checked;" +
							"}'>";
					//add checkbox
					str += "<input type='checkbox' class='subConfigCheckbox' value='" + 
							alias + "'>";
					str += niceName(alias); //can display however
					str += "</input>";
					str += "</a>";

					configVersions = keyHdr[i].getElementsByTagName("VersionKey");
					//Debug.log("CfgGUI requestHandler configNames.length " + configVersions.length);

					str += "</td><td>";
					
					str += "<select id='select-" + alias + "'>";
					for(var j=0;j<configVersions.length;++j)
					{
						version = configVersions[j].getAttribute("value");
						str += "<option value='" + version + "'>";
						str += version;	//can display however
						str += "</option>";
					}
					str += "</select>";
					
					str += "</td>";
					str += "</tr>";
				}	
				str += "</table>";

				str += "<button type='button' onmouseup='javascript:createConfigGroup()'>" +
						"Create System Config</button>";
				el.innerHTML = str;				
			}
			
			//createConfigSelect ~
			//0 is none, 1 is all, 2 is context, 3 is detector			
			function selectForCreateConfig(i)
			{
				var els = document.getElementsByClassName("subConfigCheckbox");
				
				//FIXME .. .get list of context configuration from server
				var context = ["XDAQContextConfiguration", "XDAQApplicationConfiguration"];
				switch(i)
				{
				case 1: //check all
					for(var el=0;el<els.length;++el)
						els[el].checked = true;
					break;			
				case 2: //context	
					for(var el=0;el<els.length;++el)
					{
						Debug.log(els[el].value);
						els[el].checked = false;
						for(var c=0;c<context.length;++c)
							if(els[el].value == context[c])
							{	
								els[el].checked = true;
								break;
							}
					}
					break;		
				case 3: //detector	
					for(var el=0;el<els.length;++el)
					{
						els[el].checked = true;
						for(var c in context)
							if(els[el].value == context[c])
							{	
								els[el].checked = false;
								break;
							}
					}
					break;		
				default:
					//select none
					for(var el=0;el<els.length;++el)
						els[el].checked = false;
				}
			}
			
			//versionsForCreateConfig ~
			//0 is default, 1 is latest
			function versionsForCreateConfig(i)
			{
				var els = document.getElementsByClassName("subConfigCheckbox");
				var sel,options;
				switch(i)
				{
				case 1: //latest
					for(var el=0;el<els.length;++el)
					{
						Debug.log(els[el].value);
						sel = document.getElementById("select-" + els[el].value);
						options = sel.options;
						if(options.length)
							options[options.length-1].selected = true;
					}
					break;
				default: //FIXME -- get defaults from server
					//select defaults
					for(var el=0;el<els.length;++el)
					{
						sel = document.getElementById("select-" + els[el].value);
						options = sel.options;
						if(options.length)
							options[0].selected = true;
					}
				}
			}
			
			//createConfigGroup ~
			function createConfigGroup()
			{
				var config = document.getElementById("newConfigName").value;
				Debug.log("config " + config);
				
				var configMap = "configList=";
				var els = document.getElementsByClassName("subConfigCheckbox");
				var sel;
				for(var el=0;el<els.length;++el)
					if(els[el].checked)
					{
						sel = document.getElementById("select-" + els[el].value);
						if(sel.options.length)
						{
							Debug.log("subconfig=" + els[el].value + " version=" + 
								sel.options[sel.selectedIndex].value);
							configMap += els[el].value + "," + sel.options[sel.selectedIndex].value + ",";
						}
					}
				
				
				DesktopContent.XMLHttpRequest("Request?RequestType=saveNewConfigurationGroup&groupName=" +
						config, configMap,createConfigGroupHandler);
			}

			//createConfigGroupHandler ~
			function createConfigGroupHandler(req)
			{
				var err = DesktopContent.getXMLValue(req,"Error");
				if(err) 
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}
				
				var el = document.getElementById('createGroupInfo');
				var name = DesktopContent.getXMLValue(req,"NewGroupName");
				var key = DesktopContent.getXMLValue(req,"NewGroupKey");
				var str = "";
				
				str += "New Configuration Group Created: " + name + "_v" + key;
				str += "<br>Goto its <a href=''>Member-View</a> or <a href=''>Tree-View</a>";
				
				el.innerHTML = str;
			}
			
			
			function selectThisCell(r,c,el) 
			{	
				
				if(_editingCell) //if(v.indexOf("<input type") != -1) //already have the edit box open
					return;
				
				_editingCell = true;
				_editingCellEl = el;
				
				var v = el.innerHTML;				
				var str = "";
				str += "<input type='text' onkeydown='keyHandler(event)' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value='";
				str += v;
				str += "'>";
				str += "<div style='padding:5px;background-color:#ffffcc;border:1px solid #cc6600;position:relative;" + 
						"width:150px;height:50px;margin:0 -122px -62px 10px;'>";
				str += "<a href='javascript:editCellOK("+r+","+c+");' style='color:green'><b>OK</b></a> | <a href='javascript:editCellCancel();' style='color:red'><b>Cancel</b></a>";
				str += "</div>";
				
				el.innerHTML = str;
			}
			
			function keyHandler(e) 
			{
				var TABKEY = 9;
				var ENTERKEY = 13;
				var UPKEY = 38;
				var DNKEY = 40;
				var ESCKEY = 27;
				//Debug.log("key " + e.keyCode);
				if(e.keyCode == TABKEY) 
				{
					//this.value += "    ";
					if(e.preventDefault) 
					{
						e.preventDefault();
					}
					return false;
				}
			}
			
			function editCellOK(r,c) 
			{	
				
				Debug.log("CfgGUI editCellOK editing r,c:" + r + "," + c + " = " + _editingCellEl.getElementsByTagName("input")[0].value);
				
				var str = "";
				str += _editingCellEl.getElementsByTagName("input")[0].value;
				_editingCellEl.innerHTML = str;

				_editingCell = false;
				_editingCellEl = 0;		
				
				if(!_versionIsChanged)
				{
					_versionIsChanged = true;
					
					//give button for saving changes
	
					var el = document.getElementById("display");
					var dispStr = el.innerHTML;
					str = "";
					str += "<br><div>";
					str += "<input type='button' onmouseup='saveSubSystemAsNewVersion(0)' value='Save Changes as New Version'/>";
					str += " ";
					str += "<input type='button' onmouseup='saveSubSystemAsNewVersion(1)' value='Save Changes as Temporary Version'/>";
					str += "</div>";
					el.innerHTML = str + dispStr + str;
				}
			}
			
			function editCellCancel() 
			{	
				var str = _editingCellEl.innerHTML;
				var i = str.indexOf("value=")+7;
				str = str.substr(i,str.indexOf(">")-1-i);
				
				_editingCellEl.innerHTML = str;
				_editingCell = false;
				_editingCellEl = 0;
			}
			
			//addRow ~~
			// adds row to position r (relative to view on page)
			// absolute row is _dataOffset + r
			function addRow(r) 
			{
				Debug.log("CfgGUI addRow " + r);
				
				var el = document.getElementById("SubSystemTable");
				var rows = el.getElementsByTagName("tr");				

			    var newRow = document.createElement("tr");
			    
			    //create row
			    var str = "";
			    
			    str += "<tr>";
			    str += "<td>" + (_dataOffset + r);	//insert row index column

			    //add +/- row controls
			    str += " <a href='javascript:addRow(" + r + ");'>";
			    str += "+";
			    str += "</a>";
			    str += "/<a href='javascript:deleteRow(" + r + ");'>";
			    str += "-";
			    str += "</a>";
			    str += "</td>"; 

			    //add empty columns
			    for(var c=1;c<rows[0].childNodes.length;++c)
			    {
			    	str += "<td onmouseup='selectThisCell("+r+","+c+",this);'>";			    	
			    	str += "";
			    	str += "</td>";					

			    }
			    str += "</tr>";
			    		
			    newRow.innerHTML = str; 
			    
			    var refNode = (r+1 < rows.length)?rows[r+1]:undefined;
			    //make sure el references the container of rows ("TR")
			    while(el.childNodes[0].tagName != "TR")
			    	el = el.childNodes[0];
				el.insertBefore(newRow, refNode); //row is added!
				
				//update all row numbers after row added
				for(var i=1;i<rows.length;++i)
				{
					if(i < r) continue;
					
					str = (_dataOffset + (i-1));	//insert row index column
					
					//add +/- row controls
					str += " <a href='javascript:addRow(" + (i-1) + ");'>";
					str += "+";
					str += "</a>";
					str += "/<a href='javascript:deleteRow(" + (i-1) + ");'>";
					str += "-";
					str += "</a>";							
					rows[i].childNodes[0].innerHTML = str;
				}
				
				//update last add row link
				document.getElementById("lastAddRowLink").href = "javascript:addRow(" + (rows.length-1) + ");"
			}


			//deleteRow ~~
			// delete row at destination
			function deleteRow(r) 
			{
				Debug.log("CfgGUI deleteRow " + r);
				
				var el = document.getElementById("SubSystemTable");
				var rows = el.getElementsByTagName("tr");
				
				//make sure el references the container of rows ("TR")
				while(el.childNodes[0].tagName != "TR")
					el = el.childNodes[0];
				el.removeChild(rows[r+1]);
				
				//update all row numbers after row added
				for(var i=1;i<rows.length;++i)
				{
					if(i < r) continue;
					
					str = (_dataOffset + (i-1));	//insert row index column
					
					//add +/- row controls
					str += " <a href='javascript:addRow(" + (i-1) + ");'>";
					str += "+";
					str += "</a>";
					str += "/<a href='javascript:deleteRow(" + (i-1) + ");'>";
					str += "-";
					str += "</a>";							
					rows[i].childNodes[0].innerHTML = str;
				}
				
				//update last add row link
				document.getElementById("lastAddRowLink").href = "javascript:addRow(" + (rows.length-1) + ");"				
			}
			
			
			function saveSubSystemAsNewVersion(temporary) 
			{	
				Debug.log("CfgGUI saveSubSystemAsNewVersion temporary=" + temporary);
				
				//create data string from html table
				var dataStr = ""; // semi-colon(;) separated rows.. comma(,) separated entries within row
				var el = document.getElementById("SubSystemTable");
				var rows = el.getElementsByTagName("tr");				
				
				var cells;
				for(var r=1;r<rows.length;++r) //skip header row
				{
					cells = rows[r].getElementsByTagName("td");

					for(var c=1;c<cells.length;++c) //skip row index column
						dataStr += encodeURIComponent(cells[c].innerHTML.trim()) + ","; //replaces all special characters					
					dataStr += ";";
				}
				
				var req = "Request?RequestType=saveSpecificConfiguration" + 
						"&dataOffset=" + _dataOffset + "&chunkSize=" + (rows.length-1) +  
						"&configName=" + _currentAlias + "&version="+_version;
				Debug.log(dataStr);
				Debug.log(req);
				DesktopContent.XMLHttpRequest("Request?RequestType=saveSpecificConfiguration" + 
					"&dataOffset=" + _dataOffset + "&chunkSize=" + (rows.length-1) +  
					"&configName=" + _currentAlias + "&version="+_version +
					"&temporary="+(temporary?1:0), "data=" + dataStr, saveSubSystemAsNewVersionHandler);
			}
			
			function saveSubSystemAsNewVersionHandler(req) 
			{	
				Debug.log("saveSubSystemAsNewVersionHandler requestHandler req " + req.responseText);

				var err = DesktopContent.getXMLValue(req,"Error");
				if(err && err != "")
				{
					Debug.log(err,Debug.HIGH_PRIORITY);
					return;
				}

				var subConfigAlias = DesktopContent.getXMLValue(req,"savedAlias");
				var version = DesktopContent.getXMLValue(req,"savedVersion");

				Debug.log("saveSubSystemAsNewVersionHandler requestHandler subConfigAlias " + subConfigAlias + " version " + version);
				setupSpecificConfig(subConfigAlias,version);
			}
			
			function changeKocVersionForSpecificConfig(groupName, configName, newVersion) 
			{
				//TODO
				Debug.log("CfgGUI changeKocVersionForSpecificConfig");
							
				var req = "Request?RequestType=changeKocVersionForSpecificConfig" + 
										"&groupName=" + groupName +
										"&configName=" + configName + 
										"&version=" + newVersion;
				var dataStr = "";
				Debug.log(dataStr);
				Debug.log(req);
				DesktopContent.XMLHttpRequest(req, "data=" + dataStr, specificConfigRequestHandler);				
			}
			
			function addNewKocForSpecificConfig(req) 
			{
				//TODO
				Debug.log("CfgGUI addNewKocForSpecificConfig");
			}
		</script>
		
	</head>
	
	
	<body onload='Javascript:init();'>	
			
		<h1>Configuration GUI</h1>
		<div id='activeConfig'></div>
		<a href='javascript:setupSystemViewMode()'>System View</a>  <a href='javascript:setupSubSystemConfigMode()'>Sub-System View</a>		
		<div id='display'></div>
		
	</body>
	
</html>
