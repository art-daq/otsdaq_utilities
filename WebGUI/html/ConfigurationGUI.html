<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>ConfigurationGUI</title>

	<link href='../css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>
		
	<style type="text/css">			
		body {
			background-color: rgb(200,200,200);
			font-family: 'Inconsolata', monospace;	
		}
		
		#clearDiv {
			clear: both;
		}
		
		a {
			color: blue;
		}
		
		#display {
			padding: 20px;
		}
		
		#activeConfig {
			font-size: 14px;
			margin: 10px 0 -10px 0;
		}
	</style>
	
	
	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopWindowContentCode.js"></script>
	
	<script>		
		
		//Start by offering two views (System Configurations) (Sub-Configurations)
		//	and default to System Configurations
		//
		//High Level Goals:
		//	- Allow to select a System Config to edit or start anew (all sub-config versions are dont cares)
		//		- Be able to edit the versions associated with the System Config while 
		//		viewing other System Configs for inspiration
		//	- Allow to select a sub-configuration to edit or start anew (from mock-up)
		//		- Be able to edit a sub-config, and view others to copy chunks from them
		//
	
	
		//In System Configuration mode:
		//	List the existing configuration aliases
		//		with possibly ability to scroll through associated sub-configs
		//
	
		//In Sub-Configuration mode:
		//	List the existing versions
		//		with possibly scrolling information about the version (# of rows, lastuseddate, etc.)
		//	Some Sub-Configurations will need special views:
		//		ability to add chips (of certain types) to system config...
		//
	
		var _MAX_CHUNK_SIZE = 100; //100 rows per page
		var _CONFIG_DATA_ROW_OFFSET = 2;
		var _CONFIG_DATA_COL_OFFSET = 1;
	
		var _currentConfigName;
		var _editingCell = false;
		var _editingCellEl, _editingCellElOldValue;
		var _editingCellPos = [-1,-1];
		var _versionIsChanged = false;
		var _version;
		var _dataOffset = 0;
		var _lastFindRow, _lastFindCol;

		var _contextMemberNames = [];
		var _backboneMemberNames = [];
		
		//for tree view
		var treeViewHandlerStr_; //used by recursive function to build html string
		var treeNodeUID_;		//incrementing unique id for nodes
	
		
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
	
		//functions:			
			//init()
			//niceName(str)									//removes "Configuration" from name
			//setupSystemViewMode()							//gets configuration groups aliases
			//groupAliasesRequestHandler()					 
			//setupGroupViewMode()							//gets all configuration groups
			//setupTableViewMode()							//gets configuration tables
			//setupSpecificConfigGroup(groupName, groupKey)	//setup editor for specific configuration group
			//setupSpecificConfig(configName, version)		//setup editor for specific configuration table
			//configGroupsRequestHandler(req)
			//configsRequestHandler(req)
			//specificGroupRequestHandler(req)
			//specificConfigRequestHandler(req)
			//treeViewHandler(req,parentId,errStr)
			//recursiveDrawTree(parent,depth,path)
			//toggleTreeChildren(depth,uid,nodeName,path)
			//setupConfigGroupTreeView(configGroupName)
			//activateSystemConfig(groupName, groupKey)
			//activateSystemConfigHandler(req)
			//setupConfigCreator(preSelectStr)
			//setupConfigCreatorHandler(req,preSelectStr)
			//selectForCreateConfig(i)
			//versionsForCreateConfig(i)
			//createConfigGroup()
			//createConfigGroupHandler(req)
		
			//selectThisCell(r,c,el)
			//setCaretPosition(el,start,stop)
			//editCellCancel()
			//keyHandler(e)
			//editCellOK(r,c)
			//addRow(r)										//add row at destination with default values populated
			//deleteRow(r)									//delete row at destination
			//saveConfigAsNewVersion(temporary)
			//saveConfigAsNewVersionHandler(req)
			//saveConfigGroupAsNewKey()	
			//changeMemberVersionForConfigGroup(groupName, configName, newVersion)
			//addMemberToConfigGroup(groupName) 
			//isTemporary(version)
		
			//setupFindAndReplace()
			//configFind()
			//configReplace() 
			//versionHasChanged()
		
			//setupCopyAndMoveRows()
			//configCopyRow(deleteSrc)					//copy/move row from source to destination row			
		
	
		/////////////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////
						
		
		//init called once body has loaded
		function init() {			
			Debug.log("CfgGUI init");
			
			//setupSpecificConfig("XDAQApplicationConfiguration","2");
			//return;

			//setupSpecificConfigGroup("myContext","0");
			//setupConfigCreator();
			
			setupSystemViewMode();

			//get context and backbone member list 
			DesktopContent.XMLHttpRequest("Request?RequestType=getContextMemberNames", "", 
					function (req) {				
						var err = DesktopContent.getXMLValue(req,"Error");
						if(err) 
						{
							Debug.log(err,Debug.HIGH_PRIORITY);
							return;
						}
						var memberNames = req.responseXML.getElementsByTagName("ContextMember");
						_contextMemberNames = []; //reset
						for(var i=0;i<memberNames.length;++i)
							_contextMemberNames[i] = memberNames[i].getAttribute("value");
						Debug.log(_contextMemberNames);
						if(_contextMemberNames.length == 0) 
							Debug.log("Empty context member list found!",Debug.HIGH_PRIORITY);
					}
				);
			DesktopContent.XMLHttpRequest("Request?RequestType=getBackboneMemberNames", "", 
					function (req) {				
						var err = DesktopContent.getXMLValue(req,"Error");
						if(err) 
						{
							Debug.log(err,Debug.HIGH_PRIORITY);
							return;
						}
						var memberNames = req.responseXML.getElementsByTagName("BackboneMember");
						_backboneMemberNames = []; //reset
						for(var i=0;i<memberNames.length;++i)
							_backboneMemberNames[i] = memberNames[i].getAttribute("value");
						Debug.log(_backboneMemberNames);
						if(_backboneMemberNames.length == 0) 
							Debug.log("Empty backbone member list found!",Debug.HIGH_PRIORITY);
					}
				);
		}	
		
		//return name without "Configuration" unless it is start of the name 
			//or part of the word "Configurations"
		function niceName(str) {	
			var i = str.lastIndexOf("Configuration");
			return str.substr(0,(i>1 && str[i+13] != 's')?i:str.length);
		}

		//setupSystemViewMode ~
		function setupSystemViewMode() {

			DesktopContent.XMLHttpRequest("Request?RequestType=getGroupAliases", "", 
					groupAliasesRequestHandler);		
		}
		
		//setupGroupViewMode ~
		function setupGroupViewMode() {

			DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurationGroups", "", 
					configGroupsRequestHandler);		
		}
		
		//setupTableViewMode ~
		function setupTableViewMode() {

			DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurations", "", 
					configsRequestHandler);		
		}

		//setupSpecificConfigGroup ~ 
		function setupSpecificConfigGroup(groupName, groupKey) {
			
			DesktopContent.XMLHttpRequest("Request?RequestType=getSpecificConfigurationGroup" +
					"&groupName=" + groupName +
					"&groupKey=" + groupKey
					, "", specificGroupRequestHandler);		
		}
		
		//setupSpecificConfig ~
		function setupSpecificConfig(configName,version) {
			var v = "";
			if(version) v = "&version="+version;
			DesktopContent.XMLHttpRequest("Request?RequestType=getSpecificConfiguration" + "&dataOffset=0&chunkSize=" + _MAX_CHUNK_SIZE +  
				"&configName=" + configName + v, "", specificConfigRequestHandler);		
		}
		
		//groupAliasesRequestHandler ~
		functin groupAliasesRequestHandler(req) {
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				
				//attempt to go on, in case error was just associtate with one group
				//return;
			}
			
		}
		
		//configGroupsRequestHandler ~
		function configGroupsRequestHandler(req) {				
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				
				//attempt to go on, in case error was just associtate with one group
				//return;
			}
			
			var groupNames = req.responseXML.getElementsByTagName("ConfigurationGroupName");
			var keys = req.responseXML.getElementsByTagName("ConfigurationGroupKey");
			var kocsHdr = req.responseXML.getElementsByTagName("ConfigurationGroupMembers");
					
			var groupName, key;
			
			var el = document.getElementById("display");

			var str = "";
			var configNames, configVersions;

			str += "<a href='javascript:setupConfigCreator()'>Create a New System Configuration</a>";
			str += "<br><br>";
					
			Debug.log("CfgGUI requestHandler groupNames.length " + groupNames.length);
			if(!groupNames.length)
				str += "No Configuration Groups found.";
			for(var i=0;i<groupNames.length;++i)
			{		
				groupName = groupNames[i].getAttribute("value");
				key = keys[i].getAttribute("value");
				
				//add header
				str += "<a href='javascript:setupSpecificConfigGroup(\"" + groupName +
					"\",\"" + key + "\");'>";
				str += groupName + "</a> (" + key +")";
				
				//add tree view link
				str += " <a href='javascript:setupConfigGroupTreeView(\"" + groupName +
					"\",\"" + key + "\");'>";
				str += "Tree-view</a>";										
				
				//add Activate link
				str += " <a href='javascript:activateSystemConfig(\"" + groupName +
						"\",\"" + key + "\");'>";
				str += "Activate</a>";
				
				
				str += "<br><table><tr>";

				configNames = kocsHdr[i].getElementsByTagName("MemberName");
				configVersions = kocsHdr[i].getElementsByTagName("MemberVersion");
				Debug.log("CfgGUI requestHandler configNames.length " + configNames.length);
				
				for(var j=0;j<configNames.length;++j)
				{
					str += "<td align='center'>";
					str += "<a href='javascript:setupSpecificConfig(\"" + configNames[j].getAttribute("value") +
						"\");'>";
					str += niceName(configNames[j].getAttribute("value")) + "</a><br>" + configVersions[j].getAttribute("value");
					str += "</td>";
				}
				str += "</tr></table><br>";
			}				
			//Debug.log("CfgGUI requestHandler str " + str);
			el.innerHTML = str;
		}

		function configsRequestHandler(req) {					
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;
			}
			
			var configNames = req.responseXML.getElementsByTagName("ConfigurationName");
			var configVersionHdr = req.responseXML.getElementsByTagName("ConfigurationVersions");
			
			var el = document.getElementById("display");

			var str = "";
			var configVersions;
			var configName;

			Debug.log("CfgGUI requestHandler configNames.length " + configNames.length);
			for(var i=0;i<configNames.length;++i)
			{			
				configName = configNames[i].getAttribute("value");
				str += "<a href='javascript:setupSpecificConfig(\"" + configName +
					"\");'>";
				str += niceName(configName);
				str += "</a><br><table><tr>";

				configVersions = configVersionHdr[i].getElementsByTagName("ConfigurationVersion");
				
				Debug.log("CfgGUI requestHandler config= " + configName +
								+ " configNames.length " + configVersions.length);
				
				for(var j=0;j<configVersions.length;++j)
				{
					str += "<td align='center'>";
					str += "version" + "<br>" + configVersions[j].getAttribute("value");
					str += "</td>";
				}
				str += "</tr></table><br>";
			}				
			//Debug.log("CfgGUI requestHandler str " + str);
			el.innerHTML = str;
		}


		//specificGroupRequestHandler
		function specificGroupRequestHandler(req) {	
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;
			}
			
			var groupName = DesktopContent.getXMLValue(req,"ConfigurationGroupName");
			var groupKey = DesktopContent.getXMLValue(req,"ConfigurationGroupKey");
			var historicalKeys = req.responseXML.getElementsByTagName("HistoricalConfigurationGroupKey");

			var configNames = req.responseXML.getElementsByTagName("MemberName");
			var configVersions = req.responseXML.getElementsByTagName("MemberVersion");
			var key,version,configName;
			var el = document.getElementById("display");

			var str = "";
			
			var configExistingVersions;

			str += "<h3><u>Specific Configuration Group View</u></h3>";
			str += "<label id='configGroupModified'></label><b>" + 
					groupName + "</b> (group key: " + groupKey + ") ";

			//add Activate link
			str += " <a href='javascript:activateSystemConfig(\"" + groupName +
					"\",\"" + groupKey + "\");'>";
			str += "Activate</a><br>";
			
			
			if(historicalKeys.length)
			{
				str += "Existing &quot;" + groupName + "&quot; group keys: ";
				str += " " + groupKey;
				
				for(var i=0;i<historicalKeys.length;++i)
				{
					key = historicalKeys[i].getAttribute("value");
					str += " <a href='javascript:setupSpecificConfigGroup(\"" +
								groupName + "\",\"" + key + "\");'>";
					str += key;
					str += "</a>";
				}
			}
			else 
				str += "No Historical keys exist for " + groupName + ".<br>";
			
			
			str += "<br><a href='javascript:addMemberToConfigGroup(\"" + 
					groupName + "\")'>";
			str += "Add new Configuration Member</a> to "  + groupName + "(" + groupKey + ")";
			str += "<br><br>";
			

			str += "<div style='margin-left:30px'>";
			
			var cfgVersionStr;
			var cfgNameStr = "";
			
			//Debug.log("CfgGUI specificConfigRequestHandler Member length " + configNames.length + " - " + configVersions.length);
			for(var i=0;i<configNames.length && i<configVersions.length;++i)
			{
				configName = configNames[i].getAttribute("value");
				version = configVersions[i].getAttribute("value");
			
			
				str += "<b>" + niceName(configName) + "</b> ";
				
				str += "<a href='javascript:setupSpecificConfig(\"" + configName +
									"\",\"" + version + "\");'>";
				str += "(Current version: ";
				str += "<label id='" + configName + "-currentVersion'>";					
				str +=	version;
				str += "</label>";
					
				str += ")";
				str += "</a>";
				str += "<br>Click below to change "  + niceName(configName) + 
					" Version for " + groupName + ":<br>";		
				
				
				str += "Existing versions: ";
				str += "<label id='" + configName + "-existingVersions'>";
				str += version;
				cfgVersionStr = version + ",";
				configExistingVersions = configVersions[i].getElementsByTagName("ConfigurationExistingVersion");
				for(var j=0;j<configExistingVersions.length;++j)
				{
					version = configExistingVersions[j].getAttribute("value");
					str += " ";
					str += "<a href='javascript:changeMemberVersionForConfigGroup(\"" +
							groupName + "\",\"" + configName + "\"," + 
							version;
					str += ")'>" + version;
					str += "</a>";
					cfgVersionStr += version + ",";
				}			
				str += "</label>";	
				
				
				str += "<br><br>";
				
				//add div holding existing versions for modifications
				str += "<div id='" + configName + "-versions' style='display:none'>";
				str += cfgVersionStr;
				str += "</div>";
				cfgNameStr += configName + ",";							
			}
			str += "</div>";
			
			str += "<div id='GroupMember-names' style='display:none'>";
			str += cfgNameStr;
			str += "</div>";
			

			el.innerHTML = str;
		}
		
		//specificConfigRequestHandler
		function specificConfigRequestHandler(req) {	
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;
			}
			
			activateSystemConfigHandler(req); //display active config groups
			
			var configName = DesktopContent.getXMLValue(req,"ConfigurationName");
			var version = DesktopContent.getXMLValue(req,"ConfigurationVersion");
			
			
			var kocVersionHdr = req.responseXML.getElementsByTagName("ConfigurationVersions");
			if(!kocVersionHdr.length)
			{	//should never happen (tag can be empty, but must be there)
				Debug.log("Error?! No tag for versions returned for configName: " + configName, Debug.HIGH_PRIORITY);
				return;
			}
			var configVersions = kocVersionHdr[0].getElementsByTagName("ConfigurationVersion");
			
			var rows = req.responseXML.getElementsByTagName("CurrentVersionRows")[0].getElementsByTagName("Row");
			
			var colHdrs = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnHeader");
			var colTypes = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnType");
			var colDataTypes = req.responseXML.getElementsByTagName("CurrentVersionColumnHeaders")[0].getElementsByTagName("ColumnDataType");
			
			var el = document.getElementById("display");
			

			//reset globals
			_currentConfigName = configName;
			_version = version;
			_editingCell = false;
			_editingCellEl = 0;
			_versionIsChanged = false;
			_dataOffset = rows.length?(rows[0].getAttribute("value") | 0):0;

			var str = "";
			

			str += "<h3><u>Specific Sub-System Configuration View</u></h3>";
			str += "<b>" + configName + "</b> (version: " + (version==-1?"Mockup-View":version) + ")<br>";
			
			str += "<a href='javascript:setupFindAndReplace()'>Find and Replace</a><div id='findAndReplace'></div>";
			str += "<a href='javascript:setupCopyAndMoveRows()'>Copy and Move Rows</a><div id='copyAndMoveRows'></div>";
						
			str += "<br>All versions:";
			
			//display mockup link (mockup always present)
			str += " ";
			if(-1 != version)				
				str +=  "<a href='javascript:setupSpecificConfig(\"" + configName +
					"\",\"" + "-1" + "\");'>";
			str += "Mockup-View";
			if(-1 != version)				
				str +=  "</a>";				
			
			//display all other version links
			for(var j=0;j<configVersions.length;++j)
			{
				str += " ";
				if(configVersions[j].getAttribute("value") != version)
					str +=  "<a href='javascript:setupSpecificConfig(\"" + configName +
						"\",\"" + configVersions[j].getAttribute("value") + "\");'>";
				str += configVersions[j].getAttribute("value");
				if(configVersions[j].getAttribute("value") != version)
					str += "</a>";
			}
			
			//display table
			str += "<table id='SubSystemTable' border='1' cellspacing='5' cellpadding='1'>";
			str += "<tr>";
			str += "<td>"; //row
			str += "</td>";			
			for(var c=0;c<colHdrs.length;++c)
			{
				str += "<td><div style='font-size:12px' title='";		
				str += colTypes[c].getAttribute("value");
				str += " &#60;" + colDataTypes[c].getAttribute("value") + "&#62;";
				str += "'>";
				str += colTypes[c].getAttribute("value");
				str += "<br>&#60;" + colDataTypes[c].getAttribute("value") + "&#62;";
				str += "</div></td>";					
				
			}
			str += "</tr>";
			str += "<tr>";
			str += "<th>Row</th>"; //insert row index column
			for(var c=0;c<colHdrs.length;++c)
			{
				str += "<th>";
				str += colHdrs[c].getAttribute("value");
				str += "</th>";					
				
			}
			str += "</tr>";
			
			for(var r=0;r<rows.length;++r)
			{
				var rowEntries = rows[r].getElementsByTagName("Entry");
				str += "<tr>";
				str += "<td>" + (_dataOffset + r);	//insert row index column
				
				//add +/- row controls
				str += " <a href='javascript:addRow(" + r + ");'>";
				str += "+";
				str += "</a>";
				str += "/<a href='javascript:deleteRow(" + r + ");'>";
				str += "-";
				str += "</a>";
				
				str += "</td>"; 
				
				for(var c=0;c<colHdrs.length;++c)
				{
					str += "<td onmouseup='selectThisCell("+r+","+c+",this);'>";
					//str += "<input type='text' value='";
					str += rowEntries[c].getAttribute("value");
					//str += "'>";
					str += "</td>";					
					
				}
				str += "</tr>";
			}
				
			str += "</table>";
			
			//add + row controls for new last row
			str += " <a id='lastAddRowLink' href='javascript:addRow(" + r + ");'>";
			str += "+";
			str += "</a>"
			
			
			el.innerHTML = str;
			
			if(isTemporary(version)) //if temporary
			{
				//show save button
				var dispStr = el.innerHTML;
				str = "";
				str += "<br><div id='config-firstSaveButton'>";
				str += "<input type='button' onmouseup='saveConfigAsNewVersion(0)' value='Save Changes as New Version'/>";
				str += "</div>";
				el.innerHTML = str + dispStr + "<br>" + str;
			}
		}
		
		//isTemporary
		function isTemporary(version)
		{
			return version < -1;
		}
		
		//treeViewHandler ~		
		function treeViewHandler(req,parentId) 
		{				
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;
			}
			
			//draw tree				

			var configGroupName = DesktopContent.getXMLValue(req,"configGroup");
			var configGroupKey = DesktopContent.getXMLValue(req,"configGroupKey");
			var el;
			var depth;
			var parentEl;
			treeViewHandlerStr_ = "";
			
			if(parentId) parentEl = document.getElementById("node-" + parentId);	
			if(parentEl) //then data is being added to an existing node
			{
				//so create children area
				depth = (parentId.split("-")[0] | 0)+1; //parent depth + 1
				Debug.log("Expanding tree for " + parentId + " at depth=" + depth);					
								

				el = document.createElement("div");
				el.setAttribute("id", "children-" + parentId);
				parentEl.appendChild(el);					
			}
			else //this is the initial top level request
			{
				depth = 0;
				treeNodeUID_ = 0; //reset node id
				el = document.getElementById("display");

				//add system config header
				treeViewHandlerStr_ += "<a id='treeView-ConfigGroupLink' " +
					"href='javascript:setupSpecificConfigGroup(\"" + configGroupName +
					"\",\"" + configGroupKey + "\");'>";
				treeViewHandlerStr_ += "<div style='display:none'>" + configGroupName + "</div>";
				treeViewHandlerStr_ += "<div style='display:none'>" + configGroupKey + "</div>";
				treeViewHandlerStr_ += configGroupName + " (" + configGroupKey + ")";
				treeViewHandlerStr_ += "</a><br>";
			}			
			
			//add tree
			var tree = DesktopContent.getXMLNode(req,"tree");
			var preLength = treeViewHandlerStr_.length;
			recursiveDrawTree(tree,depth,tree.getAttribute("value"));
			if(preLength == treeViewHandlerStr_.length)
				treeViewHandlerStr_ += "Empty Tree Found.";
			
			el.innerHTML = treeViewHandlerStr_;
		}

		//recursiveDrawTree ~		
		function recursiveDrawTree(parent,depth,path) 
		{				
			var uid;
			var nodes = parent.children;
			var nodeName;
			var value;
			var i;
			var childrenLength;
			for(i=0;i<nodes.length;++i)
			{
				uid = treeNodeUID_++;
				nodeName = nodes[i].getAttribute("value");
				
				Debug.log("nodeName=" + nodeName + " depth=" + depth);
				
				treeViewHandlerStr_ += "<div id='node-" + depth + "-" + uid + "-" + nodeName + 
						"' style='float:left; margin-left:" + 30 + "px'>";
				
				childrenLength = nodes[i].children.length
									
				if(childrenLength && (value = nodes[i].children[0]).nodeName == "value")
				{	//this is a value node!
					treeViewHandlerStr_ += "<b>" + nodeName + "</b>";
					treeViewHandlerStr_ += " : " + value.getAttribute("value");
					treeViewHandlerStr_ += "</div><div id='clearDiv'></div>";
					continue; //so no need to recurse
				}
				
				//not a value node so try to recurse
				treeViewHandlerStr_ += "<a href='javascript:toggleTreeChildren(" + 
						depth + "," +	uid + ",\"" +							
						nodeName + "\",\"" + path +
						"\");'>";					

				if(childrenLength && (value = nodes[i].children[0]).nodeName != "value")
				{	
					//this is a link node!
					--childrenLength; //subtract the link ID node from children length
					value = nodeName + " (" + 
							value.nodeName + " = " + value.getAttribute("value") + ")";
				}
				else
					value = nodeName;

				treeViewHandlerStr_ += childrenLength?"-":"+";
				treeViewHandlerStr_ += "</a> ";
				
				treeViewHandlerStr_ += value;
				
				treeViewHandlerStr_ += "</div><div id='clearDiv'></div>";	
				
				if(childrenLength)
				{
					treeViewHandlerStr_ += "<div id='children-" + depth + "-" + uid + "-" + nodeName + "'>";
					recursiveDrawTree(nodes[i],depth+1,path+nodeName+"/");
					treeViewHandlerStr_ += "</div>";
				}
			}
		}
		
		//toggleTreeChildren ~ 
		//	if expanding
		//		if no children div, request new depth
		//		else display children
		//	if minimizing
		//		hide children
		function toggleTreeChildren(depth,uid,nodeName,path) 
		{
			Debug.log("depth: " + depth);
			Debug.log("uid: " + uid);
			Debug.log("nodeName: " + nodeName);
			Debug.log("path: " + path);
			
			var idString = depth + "-" + uid + "-" + nodeName;
			Debug.log("idString: " + idString);
			
			var el = document.getElementById("children-" + idString);
			var configGroupEls = document.getElementById("treeView-ConfigGroupLink").childNodes;
			
			if(el) //if children already exist, then toggle display
				el.style.display = (el.style.display == "none")? "block" : "none";
			else	//if no children div, then request it
				DesktopContent.XMLHttpRequest("Request?RequestType=getTreeView" + 
						"&configGroup=" + configGroupEls[0].innerHTML + 
						"&configGroupKey=" + configGroupEls[1].innerHTML +
						"&depth=1", 
						"startPath="+path+nodeName+"/",treeViewHandler,idString);				
		}
		
		//setupConfigGroupTreeView ~
		function setupConfigGroupTreeView(configGroupName, configGroupKey)
		{
			DesktopContent.XMLHttpRequest("Request?RequestType=getTreeView&configGroup=" + 
					configGroupName + "&configGroupKey=" + configGroupKey + "&depth=1", 
					"startPath=/",treeViewHandler);
		}
		
		//activateSystemConfig ~
		function activateSystemConfig(groupName, groupKey)
		{
			DesktopContent.XMLHttpRequest("Request?RequestType=activateConfigGroup&groupName=" + 
					groupName + "&groupKey=" + groupKey,
					"",activateSystemConfigHandler);
		}
		
		//activateSystemConfigHandler ~
		function activateSystemConfigHandler(req)
		{
			//show xml Error if present as popup Debug high priority
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err && err != "") 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;					
			}
			
			var activeConfigGroups = [
									  DesktopContent.getXMLValue(req,"Context-ActiveGroupName"),
									  DesktopContent.getXMLValue(req,"Context-ActiveGroupKey"),
									  DesktopContent.getXMLValue(req,"Backbone-ActiveGroupName"),
									  DesktopContent.getXMLValue(req,"Backbone-ActiveGroupKey"),
									  DesktopContent.getXMLValue(req,"Configuration-ActiveGroupName"),
									  DesktopContent.getXMLValue(req,"Configuration-ActiveGroupKey")];
									  
			var activeConfigHeaders = ["Context","Backbone","Configuration"];
			Debug.log("activeConfig: " + activeConfig);
			
			var oldStr = document.getElementById("activeConfig").innerHTML;
			var str = "";
			for(var i=0;i<activeConfigHeaders.length;++i)
			{
				str += "Active " + activeConfigHeaders[i] + ": ";
				if(!activeConfigGroups[i*2] || activeConfigGroups[i*2] == "")
					str += "None";
				else
				{
					str += "<a href='javascript:setupSpecificConfigGroup(\"" + activeConfigGroups[i*2] +
					"\",\"" + activeConfigGroups[i*2+1] + "\");'>";
					str += activeConfigGroups[i*2] + " (" + activeConfigGroups[i*2+1] + ")</a>";
				}
				str += "<br>";
			}
			
			if(str != oldStr)
			{
				Debug.log("Note: There was a successful activation of a configuration group (check the top of the page)!", Debug.INFO_PRIORITY);
				document.getElementById("activeConfig").innerHTML = str;
			}				
		}
		
		//setupConfigCreator ~
		function setupConfigCreator(preSelectStr)
		{
			DesktopContent.XMLHttpRequest("Request?RequestType=getConfigurations",
					"", setupConfigCreatorHandler, preSelectStr);			
		}
		
		//setupConfigCreatorHandler ~
		function setupConfigCreatorHandler(req,preSelectStr)
		{
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;
			}
			
			Debug.log("preSelectStr=" + preSelectStr);

			var el = document.getElementById("display");
			var str = "";
			
			if(preSelectStr)
				str += "Choose the versions of configurations you would like to add.<br>";
			
			str += "<div id='createGroupInfo'></div><br>";
			str += "<button type='button' onmouseup='javascript:createConfigGroup()'>" +
					"Create System Config</button>";
			str += "<br><br>";
			str += "System Config Name: <input id='newConfigName'/>";
			str += "<br><br>";
			
			var configNames = req.responseXML.getElementsByTagName("ConfigurationName");
			var configVersionHdr = req.responseXML.getElementsByTagName("ConfigurationVersions");
			var name;
			var configVersions, version;
		
			Debug.log("configNames.length " + configNames.length);
			
			str += "<table>";			

			str += "<tr><td>";
			str += "<a href='javascript:selectForCreateConfig(1)'>All</a> | " +
					"<a href='javascript:selectForCreateConfig(0)'>None</a> | " + 
					"<a href='javascript:selectForCreateConfig(2)'>Context</a> | " +
					"<a href='javascript:selectForCreateConfig(3)'>Backbone</a> | " +
					"<a href='javascript:selectForCreateConfig(4)'>Configuration</a>";
			str += "&nbsp;&nbsp;&nbsp;&nbsp;";
			str += "</td><td>";
			str += "<a href='javascript:versionsForCreateConfig(0)'>Defaults</a> | " + 
					"<a href='javascript:versionsForCreateConfig(1)'>Latest</a>";
			str += "</td><td></td>";
			str += "</tr>";
			
			for(var i=0;i<configNames.length;++i)
			{		
				str += "<tr><td>";
				name = configNames[i].getAttribute("value");
				
				//add link so text toggles checkbox
				str += "<a style='text-decoration:none;color:black;' href='javascript:{" +
						"var el = document.getElementsByClassName(\"memberConfigCheckbox\");" +
						"el[" + i + "].checked = !el[" + i + "].checked;" +
						"}'>";
				//add checkbox
				str += "<input type='checkbox' class='memberConfigCheckbox' value='" + 
						name + "'>";
				str += niceName(name); //can display however
				str += "</input>";
				str += "</a>";

				configVersions = configVersionHdr[i].getElementsByTagName("ConfigurationVersion");
				//Debug.log("CfgGUI requestHandler configNames.length " + configVersions.length);

				str += "</td><td>";
				
				str += "<select id='select-" + name + "'>";
				for(var j=0;j<configVersions.length;++j)
				{
					version = configVersions[j].getAttribute("value");
					str += "<option value='" + version + "'>";
					str += version;	//can display however
					str += "</option>";
				}
				str += "</select>";
				str += "</td>";
				
				str += "<td>";
				str += "<a href='#' onmouseup='" +
						"var sel = document.getElementById(\"select-" + name + "\");" +
						"setupSpecificConfig(\"" + name + "\"," +
						"sel.options[sel.selectedIndex]?sel.options[sel.selectedIndex].value:-1);" + 
						"'>";
				str += "goto</a>";
						//"(configName, version)"
				str += "</td>";
				str += "</tr>";
			}	
			str += "</table>";

			str += "<button type='button' onmouseup='javascript:createConfigGroup()'>" +
					"Create System Config</button>";
			el.innerHTML = str;		
			

			if(preSelectStr)
			{
				//preSelectStr is CSV with groupName followed by member name/version pairs
				//use preset string to fill in preselected config group components
				var preSelectArr = preSelectStr.split(",");
				el = document.getElementById("newConfigName");
				el.value = preSelectArr[0]; //set group name
				var els = document.getElementsByClassName("memberConfigCheckbox");
				var options;
				//set member configs and versions
				for(el=0;el<els.length;++el)
				{
					els[el].checked = false;
					for(var c=1;c<preSelectArr.length-1;c+=2)
						if(els[el].value == preSelectArr[c])
						{	
							//found so check to include
							els[el].checked = true;
							//and set version
							sel = document.getElementById("select-" + els[el].value);
							options = sel.options;
							for(var i=0;i<options.length;++i)
								if(options[i].value == preSelectArr[c+1])
								{
									options[i].selected = true;
									break;
								}
							break;
						}
				}
			}
		}
		
		//createConfigSelect ~
		//0 is none, 1 is all, 2 is context, 3 is backbone, 4 is others (configuration)			
		function selectForCreateConfig(i)
		{
			var els = document.getElementsByClassName("memberConfigCheckbox");
			
			//use list of context/backbone configuration from server
			var context = _contextMemberNames;
			var backbone = _backboneMemberNames
			switch(i)
			{
			case 1: //check all
				for(var el=0;el<els.length;++el)
					els[el].checked = true;
				break;			
			case 2: //context	
				for(var el=0;el<els.length;++el)
				{
					Debug.log(els[el].value);
					els[el].checked = false;
					for(var c=0;c<context.length;++c)
						if(els[el].value == context[c])
						{	
							els[el].checked = true;
							break;
						}
				}
				break;		
			case 3: //backbone	
				for(var el=0;el<els.length;++el)
				{
					Debug.log(els[el].value);
					els[el].checked = false;
					for(var c=0;c<backbone.length;++c)
						if(els[el].value == backbone[c])
						{	
							els[el].checked = true;
							break;
						}
				}
				break;	
			case 4: //configuration	
				for(var el=0;el<els.length;++el)
				{
					els[el].checked = true;
					for(var c in context)
						if(els[el].value == context[c])
						{	
							els[el].checked = false;
							break;
						}
					for(var c in backbone)
						if(els[el].value == backbone[c])
						{	
							els[el].checked = false;
							break;
						}
				}
				break;		
			default:
				//select none
				for(var el=0;el<els.length;++el)
					els[el].checked = false;
			}
		}
		
		//versionsForCreateConfig ~
		//0 is default, 1 is latest
		function versionsForCreateConfig(i)
		{
			var els = document.getElementsByClassName("memberConfigCheckbox");
			var sel,options;
			switch(i)
			{
			case 1: //latest
				for(var el=0;el<els.length;++el)
				{
					Debug.log(els[el].value);
					sel = document.getElementById("select-" + els[el].value);
					options = sel.options;
					if(options.length)
						options[options.length-1].selected = true;
				}
				break;
			default: //FIXME -- get defaults from server
				//select defaults
				for(var el=0;el<els.length;++el)
				{
					sel = document.getElementById("select-" + els[el].value);
					options = sel.options;
					if(options.length)
						options[0].selected = true;
				}
			}
		}
		
		//createConfigGroup ~
		function createConfigGroup()
		{
			var config = document.getElementById("newConfigName").value;
			Debug.log("config " + config);
			
			var configMap = "configList=";
			var els = document.getElementsByClassName("memberConfigCheckbox");
			var sel;
			for(var el=0;el<els.length;++el)
				if(els[el].checked)
				{
					sel = document.getElementById("select-" + els[el].value);
					if(sel.options.length)
					{
						Debug.log("subconfig=" + els[el].value + " version=" + 
							sel.options[sel.selectedIndex].value);
						configMap += els[el].value + "," + sel.options[sel.selectedIndex].value + ",";
					}
				}			
			
			DesktopContent.XMLHttpRequest("Request?RequestType=saveNewConfigurationGroup&groupName=" +
					config, configMap, createConfigGroupHandler);
		}

		//createConfigGroupHandler ~
		function createConfigGroupHandler(req)
		{
			var err = DesktopContent.getXMLValue(req,"Error");
			if(err) 
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;
			}
			
			var el = document.getElementById('createGroupInfo');
			var name = DesktopContent.getXMLValue(req,"ConfigurationGroupName");
			var key = DesktopContent.getXMLValue(req,"ConfigurationGroupKey");
			var str = "";
			
			str += "New Configuration Group Created: " + name + "_v" + key;
			str += "<br>Goto its ";
			str += "<a href='javascript:setupSpecificConfigGroup(\"" + name + 
					"\",\"" + key + "\");'>Member-View</a> or ";
			str += "<a href='javascript:setupConfigGroupTreeView(\"" + name + 
					"\",\"" + key + "\");'>Tree-View</a>";
			
			el.innerHTML = str;
		}
		
		//setupCopyAndMoveRows
		function setupCopyAndMoveRows()
		{
			var el = document.getElementById('copyAndMoveRows'); 
			if(el.innerHTML != "") { el.innerHTML = ""; return; } //hide if already shown
			
			var str = "";
			str += "Source row... ";
			str += "<input type='text' id='copyAndMoveRowsSrc' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value='0'>";
			str += "<br>";
			str += "Destination row (-1 for new last row)... ";
			str += "<input type='text' id='copyAndMoveRowsDest' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value='-1'>";

			//make div for translating innerHTML and value
			str += "<div id='copyAndMoveRowsHTML' style='display:none'></div>";
			
			str += "<br><br>";
			str += "<input type='button' onmouseup='configCopyRow(0)' value='Copy'/>";
			str += " ";
			str += "<input type='button' onmouseup='configCopyRow(1)' value='Move'/>";
			el.innerHTML = str;	
		}	
		
		//configCopyRow
		function configCopyRow(deleteSrc)
		{
			var src = document.getElementById("copyAndMoveRowsSrc").value | 0;
			var dest = document.getElementById("copyAndMoveRowsDest").value | 0;
			
			Debug.log("configCopyRow src=" + src + " dest=" + dest);

			var el = document.getElementById("SubSystemTable");
			var rows = el.getElementsByTagName("tr");
			if(src < 0 || src >= rows.length - _CONFIG_DATA_ROW_OFFSET)
			{
				Debug.log("Error: Illegal source row of '" + src + 
						"' given. Row must be less than " + 
						(rows.length- _CONFIG_DATA_ROW_OFFSET), Debug.HIGH_PRIORITY);
				return;
			}
			if(dest < -1 || dest >= rows.length - _CONFIG_DATA_ROW_OFFSET)
			{
				Debug.log("Error: Illegal destination row of '" + dest + 
						"' given. Use '-1' for a new row, otherwise row must be less than " + 
						(rows.length- _CONFIG_DATA_ROW_OFFSET), Debug.HIGH_PRIORITY);
				return;
			}

			//steps:
			//	- add destination row
			//	- for each src col 
			//		- dest[col] = src[col]

			//if(deleteSrc) --dest;	//when move, add before target row	
			
			if(dest == -1) //new row, so point to last row for addRow use
				dest = rows.length - _CONFIG_DATA_ROW_OFFSET;		

			//get source row before adding row
			var srcCols = rows[_CONFIG_DATA_ROW_OFFSET+src].getElementsByTagName("td");
			
			addRow(dest); 	
			Debug.log("src=" + src + " dest=" + dest);
			
			//get destinat row after add
			el = document.getElementById("SubSystemTable");
			rows = el.getElementsByTagName("tr");
			
			var destCols = rows[_CONFIG_DATA_ROW_OFFSET+dest].getElementsByTagName("td");
			for(var c=1;c<srcCols.length;++c)
			{
				Debug.log("copy c=" + c + " srcHTML=" + srcCols[c].innerHTML);
				destCols[c].innerHTML = srcCols[c].innerHTML;
			}
			
			if(deleteSrc)
			{
				if(dest < src) ++src; //to account for added row
				deleteRow(src);
			}
		}	
		
		//setupFindAndReplace
		function setupFindAndReplace()
		{
			var el = document.getElementById('findAndReplace'); 
			if(el.innerHTML != "") { el.innerHTML = ""; return; } //hide if already shown
			
			_lastFindRow = _lastFindCol = -1; //initialize find location
			var str = "";
			str += "Search in column ('*' for all)... ";
			str += "<input type='text' id='findAndReplaceTarget' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value='*'>";
			str += "<br>";
			str += "For text... ";
			str += "<input type='text' id='findAndReplaceNeedle' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value=''>";
			str += "<br>";
			str += "Replace with... ";
			str += "<input type='text' id='findAndReplaceWith' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value=''>";
			
			//make div for translating innerHTML and value
			str += "<div id='findAndReplaceHTML' style='display:none'></div>";
			
			str += "<br><br>";
			str += "<input type='button' onmouseup='configFind()' value='Find'/>";
			str += " ";
			str += "<input type='button' onmouseup='configReplace()' value='Replace'/>";
			el.innerHTML = str;						
		}
				
		//configFind
		//	use _lastFindRow, _lastFindCol as starting point
		function configFind()
		{
			var target = document.getElementById("findAndReplaceTarget").value;
			var needle = document.getElementById("findAndReplaceNeedle").value;
			var convertEl = document.getElementById("findAndReplaceHTML");
			
			//convert needle to HTML for search
			convertEl.innerHTML = "";
			convertEl.appendChild(document.createTextNode(needle));
			needle = convertEl.innerHTML; //converted text
			Debug.log("configFind '" + needle + "' @ " + target);
						

			Debug.log("_lastFindRow=" + _lastFindRow + " _lastFindCol=" + _lastFindCol);
			
			var el = document.getElementById("SubSystemTable");
			var rows = el.getElementsByTagName("tr");	
			var cells;
			var cols = rows[_CONFIG_DATA_ROW_OFFSET-1].getElementsByTagName("th");
			var cellStr;			
			var svLast = [_lastFindRow-_CONFIG_DATA_ROW_OFFSET,
						  _lastFindCol-_CONFIG_DATA_COL_OFFSET];
			for(var r=_CONFIG_DATA_ROW_OFFSET;r<rows.length;++r) //skip header rows
			{
				if(r < _lastFindRow) continue; //skip rows already looked at 
				
				cells = rows[r].getElementsByTagName("td");
				
				if(r != _lastFindRow)
				{
					_lastFindCol = -1; //reset last col for row
					_lastFindRow = r;
				}

				for(var c=_CONFIG_DATA_COL_OFFSET;c<cells.length;++c) //skip row index column
				{
					if(target != "*" && cols[c].innerHTML != target) continue; //skip if not target column 

					if(c <= _lastFindCol) continue; //skip cols already looked at in this row

					_lastFindCol = c; 
					
					cellStr = cells[c].innerHTML;
					Debug.log("[" + r + "," + c + "]=" + cellStr);
					if(cellStr.indexOf(needle) >= 0)
					{
						Debug.log("FOUND=" + cellStr);
						
						//cancel any other cells and target the found cell
						editCellCancel();
						selectThisCell(r,c,cells[c]);
						return;
					}
					
				}
			}
			Debug.log("Info: Reached end of table and was not able to find '" +
					needle + "' in columns '" + 
					target + "' after row,col = [" + svLast[0] + "," + svLast[1] + 
					"]. Try Find again to wrap around.", 
					Debug.HIGH_PRIORITY);
			_lastFindRow = -1; //reset for next find
		}
		
		//configReplace
		function configReplace()
		{			
			var target = document.getElementById("findAndReplaceTarget").value;
			var needle = document.getElementById("findAndReplaceNeedle").value;
			var convertEl = document.getElementById("findAndReplaceHTML");
			
			//convert needle to HTML for search
			convertEl.innerHTML = "";
			convertEl.appendChild(document.createTextNode(needle));
			needle = convertEl.innerHTML; //converted text
			
			var replaceStr = document.getElementById("findAndReplaceWith").value;
			
			//convert replaceStr to HTML for search
			convertEl.innerHTML = "";
			convertEl.appendChild(document.createTextNode(replaceStr));
			replaceStr = convertEl.innerHTML; //converted text
			
			Debug.log("configReplace '" + needle + "' with '" + replaceStr + "' @ " + target);
			
			var el = document.getElementById("SubSystemTable");
			var rows = el.getElementsByTagName("tr");	
			var cells;
			var cols = rows[_CONFIG_DATA_ROW_OFFSET-1].getElementsByTagName("th");
			var cellStr, tmpStr;
			for(var r=_CONFIG_DATA_ROW_OFFSET;r<rows.length;++r) //skip header rows
			{
				cells = rows[r].getElementsByTagName("td");

				for(var c=_CONFIG_DATA_COL_OFFSET;c<cells.length;++c) //skip row index column
				{
					if(target != "*" && cols[c].innerHTML != target) continue; //skip if not target column 
					
					cellStr = cells[c].innerHTML;
					tmpStr = cellStr;
					Debug.log("[" + r + "," + c + "]=" + cellStr);
					while(cellStr.indexOf(needle) >= 0)
					{
						cellStr = cellStr.replace(needle,replaceStr);
						if(cellStr == tmpStr) break; //in case replace is same as needle
						Debug.log("REPLACED=" + cellStr);						
					}
					cells[c].innerHTML = cellStr;
				}
			}
			
			versionHasChanged();
		}
		
		function versionHasChanged()
		{		
			if(!_versionIsChanged)
			{
				_versionIsChanged = true;
				
				//give button for saving changes

				//get rid of all first save buttons (for temporary views)
				var el = document.getElementById("config-firstSaveButton");
				while(el)
				{				
					el.parentNode.removeChild(el);
					el = document.getElementById("config-firstSaveButton");
				}
				
				
				el = document.getElementById("display");
				var dispStr = el.innerHTML;
				str = "";
				str += "<br><div>";
				str += "<input type='button' onmouseup='saveConfigAsNewVersion(0)' value='Save Changes as New Version'/>";
				str += " ";
				str += "<input type='button' onmouseup='saveConfigAsNewVersion(1)' value='Save Changes as Temporary Version'/>";
				str += "</div>";
				el.innerHTML = str + dispStr + "<br>" + str;
			}			
		}
		
		//selectThisCell
		function selectThisCell(r,c,el) 
		{				
			if(_editingCell) //already have the edit box open, cancel it
			{
				if(_editingCellEl == el) //if same cell do nothing
					return false;
				editCellCancel(); //if new cell cancel
			}
			
			//if column is Author or Timestamp, don't allow select
			var tableEl = document.getElementById("SubSystemTable");
			var rows = tableEl.getElementsByTagName("tr");
			var cols = rows[0].getElementsByTagName("td");
			var colType = cols[_CONFIG_DATA_COL_OFFSET+c].childNodes[0].innerHTML.split('<')[0]; //type text is in a div for smaller font			
			if(colType == "Author" || 
					colType == "Timestamp")
				return false;
			
			
			_editingCell = true;
			_editingCellEl = el;
			_editingCellPos = [r,c];
			
			_editingCellElOldValue = el.innerHTML;
			var str = "";
			str += "<input type='text' onkeydown='keyHandler(event)' style='margin:-4px -2px -4px -1px;width:" + (el.offsetWidth-6) + "px; height:" + (el.offsetHeight-8) + "px' value='";
			str += _editingCellElOldValue;
			str += "'>";
			str += "<div style='padding:5px;background-color:#eeeeee;border:1px solid #555555;position:relative;" + 
					"width:90px;height:20px;margin:0 -122px -32px 10px;'>";
			str += "<a href='javascript:editCellOK("+r+","+c+");' style='color:green'><b>OK</b></a> | <a href='javascript:editCellCancel();' style='color:red'><b>Cancel</b></a>";
			str += "</div>";
			
			el.innerHTML = str;
			
			setCaretPosition(el.getElementsByTagName("input")[0],0,_editingCellElOldValue.length);
			
			return true;
		}
		
		//setCaretPosition
		function setCaretPosition(elem, caretPos, endPos) {
            elem.focus();
            elem.setSelectionRange(caretPos, endPos);
		}
		
		//keyHandler
		function keyHandler(e) 
		{
			var TABKEY = 9;
			var ENTERKEY = 13;
			var UPKEY = 38;
			var DNKEY = 40;
			var ESCKEY = 27;
			//Debug.log("key " + e.keyCode);
			
			var shiftIsDown;
			if (window.event) 
			{
				key = window.event.keyCode;
				shiftIsDown = !!window.event.shiftKey; // typecast to boolean
			} 
			else
			{
				key = e.which;
				shiftIsDown = !!e.shiftKey;	// typecast to boolean
			}
			//Debug.log("shift=" + shiftIsDown);
			
			//tab key jumps to next cell with a CANCEL
			//	(enter key does same except saves/OKs value)
			//	shift is reverse jump
			if(e.keyCode == TABKEY || e.keyCode == ENTERKEY || 
					e.keyCode == UPKEY || e.keyCode == DNKEY) 				
			{
				//this.value += "    ";
				if(e.preventDefault) 
					e.preventDefault();

				if(e.keyCode == ENTERKEY) 
					editCellOK(_editingCellPos[0],_editingCellPos[1]);
				
				//jump forward (tab/enter) or backward (tab/enter+shift)
				//	or up or down.
				//get number of rows and cols
				//	to determine next row and col to jump to
				
				
				var newRow = _editingCellPos[0];
				var newCol = _editingCellPos[1];
				var el = document.getElementById("SubSystemTable");
				var rows = el.getElementsByTagName("tr");
				var numOfRows = rows.length - _CONFIG_DATA_ROW_OFFSET;
				var numOfCols = rows[_CONFIG_DATA_ROW_OFFSET-1].getElementsByTagName("th").length - 
						_CONFIG_DATA_COL_OFFSET;
				do
				{					
					if(e.keyCode == TABKEY || e.keyCode == ENTERKEY)
						newCol += (shiftIsDown?-1:1);
					else if(e.keyCode == UPKEY)
						--newRow;
					else if(e.keyCode == DNKEY)
						++newRow;
					
					//new position is chosen! now make it happen (in a clean way)	
									
					if(newCol == numOfCols)	{ ++newRow; newCol = 0;	}
					if(newRow == numOfRows) newRow = 0;
					if(newCol < 0) {--newRow; newCol = numOfCols-1; }
					if(newRow < 0) newRow = numOfRows-1;					

					el = rows[_CONFIG_DATA_ROW_OFFSET+newRow].getElementsByTagName("td")[_CONFIG_DATA_COL_OFFSET+newCol];			
				
				} while(!selectThisCell(newRow,newCol,el));

				//Debug.log("newRow=" + newRow + " newCol=" + newCol);
				
				return false;
			}
			else if(e.keyCode == ESCKEY) 
			{				
				if(e.preventDefault) 
					e.preventDefault();
				editCellCancel();
				return false;
			}
		}
		
		//editCellOK
		function editCellOK(r,c) 
		{	
			
			Debug.log("CfgGUI editCellOK editing r,c:" + r + "," + c + " = " + _editingCellEl.getElementsByTagName("input")[0].value);
			
			var str = _editingCellEl.getElementsByTagName("input")[0].value;
			_editingCellEl.innerHTML = "";
			_editingCellEl.appendChild(document.createTextNode(str));

			_editingCell = false;
			_editingCellEl = 0;		
			
			versionHasChanged();
		}
		
		//editCellCancel
		function editCellCancel() 
		{	
//			var str = _editingCellEl.innerHTML;
//			var i = str.indexOf("value=")+7;
//			str = str.substr(i,str.indexOf(">")-1-i);
			_editingCellEl.innerHTML = _editingCellElOldValue;
			
			_editingCell = false;
			_editingCellEl = 0;
		}
		
		//addRow ~~
		// adds row to position r (relative to view on page)
		// absolute row is _dataOffset + r
		function addRow(r) 
		{
			Debug.log("CfgGUI addRow " + r);
			
			var el = document.getElementById("SubSystemTable");
			var rows = el.getElementsByTagName("tr");				

			var newRow = document.createElement("tr");
			
			//create row
			var str = "";
			
			str += "<tr>";
			str += "<td>" + (_dataOffset + r);	//insert row index column

			//add +/- row controls
			str += " <a href='javascript:addRow(" + r + ");'>";
			str += "+";
			str += "</a>";
			str += "/<a href='javascript:deleteRow(" + r + ");'>";
			str += "-";
			str += "</a>";
			str += "</td>"; 

			//add empty columns
			for(var c=1;c<rows[0].childNodes.length;++c)
			{
				str += "<td onmouseup='selectThisCell("+r+","+
						(c-_CONFIG_DATA_COL_OFFSET)+",this);'>";			    	
				str += "";
				str += "</td>";					

			}
			str += "</tr>";
					
			newRow.innerHTML = str; 
			
			var refNode = (r+_CONFIG_DATA_ROW_OFFSET < rows.length)?rows[r+_CONFIG_DATA_ROW_OFFSET]:undefined;
			//make sure el references the container of rows ("TR")
			while(el.childNodes[0].tagName != "TR")
				el = el.childNodes[0];
			el.insertBefore(newRow, refNode); //row is added!
			
			//update all row numbers after row added
			for(var i=_CONFIG_DATA_ROW_OFFSET;i<rows.length;++i)
			{
				if(i < r) continue;
				
				str = (_dataOffset + (i-_CONFIG_DATA_ROW_OFFSET));	//insert row index column
				
				//add +/- row controls
				str += " <a href='javascript:addRow(" + (i-_CONFIG_DATA_ROW_OFFSET) + ");'>";
				str += "+";
				str += "</a>";
				str += "/<a href='javascript:deleteRow(" + (i-_CONFIG_DATA_ROW_OFFSET) + ");'>";
				str += "-";
				str += "</a>";							
				rows[i].childNodes[0].innerHTML = str;
			}
			
			//update last add row link
			document.getElementById("lastAddRowLink").href = "javascript:addRow(" + (rows.length-_CONFIG_DATA_ROW_OFFSET) + ");";

			versionHasChanged();					
		}


		//deleteRow ~~
		// delete row at destination
		function deleteRow(r) 
		{
			Debug.log("CfgGUI deleteRow " + r);
			
			var el = document.getElementById("SubSystemTable");
			var rows = el.getElementsByTagName("tr");
			
			//make sure el references the container of rows ("TR")
			while(el.childNodes[0].tagName != "TR")
				el = el.childNodes[0];
			el.removeChild(rows[r+_CONFIG_DATA_ROW_OFFSET]);
			
			//update all row numbers after row added
			for(var i=_CONFIG_DATA_ROW_OFFSET;i<rows.length;++i)
			{
				if(i < r) continue;
				
				str = (_dataOffset + (i-_CONFIG_DATA_ROW_OFFSET));	//insert row index column
				
				//add +/- row controls
				str += " <a href='javascript:addRow(" + (i-_CONFIG_DATA_ROW_OFFSET) + ");'>";
				str += "+";
				str += "</a>";
				str += "/<a href='javascript:deleteRow(" + (i-_CONFIG_DATA_ROW_OFFSET) + ");'>";
				str += "-";
				str += "</a>";							
				rows[i].childNodes[0].innerHTML = str;
			}
			
			//update last add row link
			document.getElementById("lastAddRowLink").href = "javascript:addRow(" + (rows.length-_CONFIG_DATA_ROW_OFFSET) + ");"	

			versionHasChanged();
		}
		
		//saveConfigAsNewVersion
		function saveConfigAsNewVersion(temporary) 
		{	
			editCellCancel();
			Debug.log("CfgGUI saveConfigAsNewVersion temporary=" + temporary);
			
			//create data string from html table
			var dataStr = ""; // semi-colon(;) separated rows.. comma(,) separated entries within row
			var el = document.getElementById("SubSystemTable");
			var rows = el.getElementsByTagName("tr");				
			
			var cells;
			for(var r=_CONFIG_DATA_ROW_OFFSET;r<rows.length;++r) //skip header rows
			{
				cells = rows[r].getElementsByTagName("td");

				for(var c=_CONFIG_DATA_COL_OFFSET;c<cells.length;++c) //skip row index column
					dataStr += encodeURIComponent(cells[c].innerHTML.trim()) + ","; //replaces all special characters					
				dataStr += ";";
			}
			
			var req = "Request?RequestType=saveSpecificConfiguration" + 
					"&dataOffset=" + _dataOffset + "&chunkSize=" + (rows.length-_CONFIG_DATA_ROW_OFFSET) +  
					"&configName=" + _currentConfigName + "&version="+_version;
			Debug.log(dataStr);
			Debug.log(req);
			DesktopContent.XMLHttpRequest("Request?RequestType=saveSpecificConfiguration" + 
				"&dataOffset=" + _dataOffset + "&chunkSize=" + (rows.length-_CONFIG_DATA_ROW_OFFSET) +  
				"&configName=" + _currentConfigName + "&version="+_version +
				"&temporary="+(temporary?1:0), "data=" + dataStr, saveConfigAsNewVersionHandler);
		}
		
		//saveConfigAsNewVersionHandler
		function saveConfigAsNewVersionHandler(req) 
		{	
			Debug.log("saveConfigAsNewVersionHandler requestHandler req " + req.responseText);

			var err = DesktopContent.getXMLValue(req,"Error");
			if(err && err != "")
			{
				Debug.log(err,Debug.HIGH_PRIORITY);
				return;
			}

			var configName = DesktopContent.getXMLValue(req,"savedAlias");
			var version = DesktopContent.getXMLValue(req,"savedVersion");

			Debug.log("saveConfigAsNewVersionHandler requestHandler configName " + configName + " version " + version);
			setupSpecificConfig(configName,version);
		}
		
		//changeMemberVersionForConfigGroup
		function changeMemberVersionForConfigGroup(groupName, configName, newVersion) 
		{
			Debug.log("CfgGUI changeMemberVersionForConfigGroup configName=" + configName +
					" newVersion=" + newVersion);

			//steps:
			//	change current version
			//	update existing versions
			//	add button to save new group

			//change current version
			var el = document.getElementById(configName + "-currentVersion");
			el.innerHTML = newVersion;
			
			//update existing
			el = document.getElementById(configName + "-versions");
			var str = el.innerHTML;
			var configNameArr = str.split(',');
			str = "";
			str += newVersion;
			//for each member configuration					
			for(var i=0;i<configNameArr.length-1;++i) //skip last ',' empty element
			{
				Debug.log(configNameArr[i]);
				if(configNameArr[i] == newVersion) continue;
				str += " ";
				str += "<a href='javascript:changeMemberVersionForConfigGroup(\"" +
						groupName + "\",\"" + configName + "\"," + 
						configNameArr[i];
				str += ")'>" + configNameArr[i];
				str += "</a>";
			}
			
			el = document.getElementById(configName + "-existingVersions");
			el.innerHTML = str;
			
			
			//add button
			var el = document.getElementById("display");
			if(el.getElementsByTagName("div")[0].childNodes[0].tagName == "INPUT")
				return; //only add button once
			
			var dispStr = el.innerHTML;
			str = "";
			str += "<br><div>";
			str += "<input type='button' onmouseup='saveConfigGroupAsNewKey(\"" +
					groupName + "\")' value='Save Changes as New Group'/>";				
			str += "</div>";
			el.innerHTML = str + dispStr + "<br>" + str;
			
			el = document.getElementById("configGroupModified");
			el.innerHTML = "*Modified* "; //mark modified
			
		}
		
		//saveConfigGroupAsNewKey
		function saveConfigGroupAsNewKey(groupName) 
		{
			Debug.log("CfgGUI saveConfigGroupAsNewKey");	
			
			var memberArr = document.getElementById("GroupMember-names").innerHTML.split(",");
			Debug.log("memberArr " + memberArr);
			
			var configMap = "configList=";
			var version;
			for(var i=0;i<memberArr.length-1;++i)
			{
				version = document.getElementById(memberArr[i] + 
						"-currentVersion").innerHTML;
				Debug.log("subconfig=" + memberArr[i] + 
						" version=" + version);
				configMap += memberArr[i] + "," + version + ",";
			}			
			
			DesktopContent.XMLHttpRequest("Request?RequestType=saveNewConfigurationGroup&groupName=" +
					groupName, configMap, specificGroupRequestHandler);
			
		}
		
		//addMemberToConfigGroup
		function addMemberToConfigGroup(groupName) 
		{
			Debug.log("CfgGUI addMemberToConfigGroup " + groupName);
			
			var memberArr = document.getElementById("GroupMember-names").innerHTML.split(",");
			Debug.log("memberArr " + memberArr);
			
			//make special preselectStr CSV string with groupName and then current members
			var preSelectStr = groupName + ",";
			var version;
			for(var i=0;i<memberArr.length-1;++i)
			{
				version = document.getElementById(memberArr[i] + 
						"-currentVersion").innerHTML;
				Debug.log("subconfig=" + memberArr[i] + 
						" version=" + version);
				preSelectStr += memberArr[i] + "," + version + ",";
			}
			setupConfigCreator(preSelectStr);
		}
	</script>
		
</head>
	

<body onload='Javascript:init();'>	
		
	<h1>Configuration GUI</h1>
	<a href='javascript:setupSystemViewMode()'>System View</a> 	&nbsp;&nbsp;
	<a href='javascript:setupGroupViewMode()'>Group View</a>	&nbsp;&nbsp;
	<a href='javascript:setupTableViewMode()'>Table View</a>	&nbsp;&nbsp;
	<hr>
	<div id='activeConfig'></div>
	<div id='display'></div>
	
</body>
	
</html>
