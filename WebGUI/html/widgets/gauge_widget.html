<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  	<head>
    	<meta http-equiv="content-type" content="text/html;charset=utf-8">
    	<title>d3.js gauges</title>

		<style>

			body
			{
			  	font: 10px arial;
			}

			.wrapper {
			  display: grid;
			  grid-template-columns: repeat(2, 1fr);
			  grid-gap: 10px;
			  grid-auto-rows: minmax(100px, auto);
			}

		</style>

		<script type="text/javascript" src="libraries/d3.js"></script>
		<script type="text/javascript" src="libraries/gauge.js"></script>

		<script>
			//functions:			
			//init()					

			var gauges = [];
			var guages_settings = [];

			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////

			//init called once body has loaded
			function init()
			{
				console.log("Gauge init()");
				console.log(window.frameElement.id)
				console.log("Dimensions: " + window.innerWidth + " : " + window.innerHeight);
				window.parent.setupWidget(window.frameElement.id, getParameters());
			}

			function setupPVs(settings)
			{
				console.log("Gauge setupPVs() : " , settings);
				guages_settings = settings;
			}

			var widget_;
			var parameters_;
			function newWidget(widget, parameters) 
			{
				widget_ = widget;
				parameters_ = parameters;
				var olddiv = document.getElementById("dispaly-div");
				if (olddiv != null)
					document.getElementById("display").removeChild(olddiv);

				var div = document.createElement('div');
				div.className="wrapper";
				div.id = "dispaly-div";
				document.getElementById("display").appendChild(div);
				var pv_number = 0;
				for(var pv in widget.PVList)
				{   
					var divtemp = document.createElement('div');
					divtemp.style.color = "white";
					divtemp.style.fontSize = "auto";
					divtemp.innerHTML = "<p id='p-" + pv + "'>" + pv + "</p>";
					divtemp.id = "gauge-div-" + pv_number;
					divtemp.style.width = "100%";
					divtemp.style.height = "100%";
					div.appendChild(divtemp);

					//var max_size = Math.min(window.innerHeight, window.innerWidth) / Math.max(rows, columns);
					var max_size = Math.min(window.innerHeight - 60, window.innerWidth) / Object.keys(widget.PVList).length;

					var label = guages_settings[pv] !== undefined ? guages_settings[pv].Units : "";
					var min   = guages_settings[pv] !== undefined ? guages_settings[pv].Lower_Display_Limit !== "DC'd" ? parseInt(guages_settings[pv].Lower_Display_Limit) : 0 : 0;
					var max   = guages_settings[pv] !== undefined ? guages_settings[pv].Upper_Display_Limit !== "DC'd" ? parseInt(guages_settings[pv].Upper_Display_Limit) : 0 : 0;
					max = max == "DC'd" || max <= min ? 100 : max;

					console.log("Gauge pv: " + guages_settings[pv]);
					console.log("Gauge: " + pv + "(" + pv_number + ") : " + label +"," + min +"," + max + ".");
					console.log("Gauge: " + pv + "(" + pv_number + ") : " + parameters["label_" + pv_number] + "," + parameters["min_" + pv_number] + "," + parameters["max_" + pv_number] + ".");

					createGauge(pv, divtemp.id, label, min, max, max_size);
					pv_number++;
				}
				console.log(document.body);
			}

			function getParameters()
			{
				parameters = [];

				for(var i = 0; i < 15; i++)
				{
					parameters["label_" + i] = "";
					parameters["min_" + i]   = "";
					parameters["max_" + i]   = "";
				}
				console.log(parameters);
				return parameters;
			}

			function newValue(pvName, pvValue, pvTime, pvStatus, pvSeverity)
			{
				console.log("Gauge newValue() reached", pvName, pvValue);
				var pv="p-" + pvName;
				document.getElementById(pv).innerHTML = pvName + "<br>Status: " + pvStatus + "<br>Severity: " + pvSeverity;
				gauges[pvName].redraw(pvValue);

//				document.getElementById(pvName).innerHTML = (pvValue);// + " @ " + pvTime);
//				document.getElementById(pvName).title = pvName + ":" + pvTime;
//				document.getElementById(pvName).parentElement.style.border = pvName + ":" + pvTime;
//				document.getElementById(pvName).parentElement.style["background-color"] = "transparent";
//				if(pvSeverity == "NO_ALARM")
//				{
//					document.getElementById(pvName).parentElement.style.color = "green"
//				}
//				else if(pvSeverity == "MINOR")
//				{
//					document.getElementById(pvName).parentElement.style.color = "yellow"
//				}else if(pvSeverity == "MAJOR")
//				{
//					document.getElementById(pvName).parentElement.style.color = "red"
//				}else if(pvSeverity == "INVALID")
//				{
//					document.getElementById(pvName).parentElement.style.color = "DimGray";
//				}
//				else if(pvSeverity == "DC")
//				{
//					document.getElementById(pvName).parentElement.style.color = "Light Grey";
//				}
//				
//				if(pvStatus == "NO_ALARM")
//				{
//					document.getElementById(pvName).parentElement.style.border = "thin dotted green";
//				}
//				else if(pvStatus == "HIHI")
//				{
//					document.getElementById(pvName).parentElement.style.border = "thick solid red"
//				}else if(pvStatus == "LOLO")
//				{
//					document.getElementById(pvName).parentElement.style.border = "thick solid MediumSlateBlue";
//				}else if(pvStatus == "HIGH")
//				{
//					document.getElementById(pvName).parentElement.style.border = "thin dotted red";
//				}else if(pvStatus == "LOW")
//				{
//					document.getElementById(pvName).parentElement.style.border = "thing dotted blue";
//				}else if(pvStatus == "DC")
//				{
//					document.getElementById(pvName).parentElement.style["background-color"] = "Gainsboro";
//				}else if(pvStatus == "UDF")
//				{
//					document.getElementById(pvName).parentElement.style["background-color"] = "yellow";
//				}
			}
			//End Template

			function createGauge(name, container, label, min, max, size)
			{

				var config = 
				{
					size: undefined != size ? size : 120,
					label: label,
					min: undefined != min ? min : 0,
					max: undefined != max ? max : 100,
					minorTicks: 5
				}

				var range = config.max - config.min;
				config.yellowZones = [{ from: config.min + range*0.75, to: config.min + range*0.9 }];
				config.redZones = [{ from: config.min + range*0.9, to: config.max }];

				gauges[name] = new Gauge(container, config);
				gauges[name].render();
			}

			function createGauges()
			{
				createGauge("memory", "Memory");
				createGauge("cpu", "CPU");
				createGauge("network", "Network");
			}

			function updateGauges()
			{
				for (var key in gauges)
				{
					var value = getRandomValue(gauges[key]);
					gauges[key].redraw(value);
				}
			}

			function getRandomValue(gauge)
			{
				var overflow = 0; //10;
				return gauge.config.min - overflow + (gauge.config.max - gauge.config.min + overflow*2) * Math.random();
			}

			function initialize()
			{
				createGauges();
				//setInterval(updateGauges, 5000);
			}

			window.onresize = function() {
				for(var name in gauges)
				{
					gauges[name].config.size = Math.min(window.innerHeight - 60, window.innerWidth) / Object.keys(gauges).length | 0;
					gauges[name].configure(gauges[name].config);
					//gauges[name].redraw(50);
					newWidget(widget_, parameters_);
				}
				console.log("gauge: window.onresize()");
			};

		</script>

	</head>

	<body onload="Javascript:init()">
		<div id="display" width="100%" height="100%">
	</body>

</html>

