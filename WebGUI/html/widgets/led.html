
<!DOCTYPE HTMnL>
<html lang="en">
	<head>
		<title>LED</title>
		<style type="text/css">	
			body {
				font: 10px arial;
				background-color: rgba(250, 250, 250, 0);
				width: 30;
				height: 30;
				//margin: 0px !important;
			}
			.wrapper {
			  display: grid;
			  //grid-template-columns: repeat(2, 1fr);
			  grid-template-columns: repeat(auto-fill,minmax(30px, 1fr));
			  grid-gap: 0px;
			  flex-direction: row;
			  grid-auto-rows: minmax(10px, auto);
			  //grid-auto-columns: 20px 20px;
			}
		</style>

		<script>

			//functions:
			//init()

			var leds = [];
			var labelContainers = [];
			var pv_settings_ = [];
			var parameters_ = {class: "", "show_labels": "false"};

			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////

			//init called once body has loaded
			function init()
			{
				console.log("LED init()");
				console.log(window.frameElement.id);
				window.parent.setupWidget(window.frameElement.id, getParameters());
			}

			function setupPVs(settings)
			{
				console.log("LED setupPVs() : " , settings);
				pv_settings_ = settings;
			}

			function drawWidget(widget, parameters)
			{
				leds = [];
				containers = [];

				var div = document.getElementById("display")
				for(var pv in widget.PVList)
				{
					var divtemp = document.getElementById('label-div-' + pv)
					if (divtemp == null)
					{
						divtemp = document.createElement('div');
						divtemp.id = "label-div-" + pv;
					}

					if (parameters_["show_labels"] == "true")
						divtemp.innerHTML = "<center>" + pv.replace(/[&\/\\#,+()$~%.:*?<>{}]/g, "<br />") + "<br />WAITING FOR A NEW PV VALUE...";
					else
						divtemp.innerHTML = "";

					div.appendChild(divtemp);
					labelContainers[pv] = divtemp;

					drawLed(divtemp, pv);
				}

			}

			function drawLed(div, pv)
			{
				var canvas = document.getElementById("led-" + pv);
				if (canvas == null)
				{
					canvas = document.createElement('canvas');
					canvas.id = "led-" + pv;
					div.appendChild(canvas);
					leds[pv] = canvas;
				}
				canvas.style.width = Math.min(window.innerWidth, window.innerHeight) - 18 + "px";
				var context = canvas.getContext('2d');
				var centerX = canvas.width / 2;
				var centerY = canvas.height / 2;
				var radius = Math.min(canvas.width/2 - 10, canvas.height/2 - 10);

				context.beginPath();
				context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
				context.fillStyle = 'grey';
				context.fill();
				context.lineWidth = 5;
				context.strokeStyle = '#003300';
				context.stroke();
			}

			function getParameters()
			{
				return parameters_;
			}

			function setParameters(attributes)
			{
				parameters_ = attributes;
				console.log("thermometer: set parameters()");
				console.log(parameters_);
			}

			function newValue(pvName, pvValue, pvTime, pvStatus, pvSeverity)
			{
				console.log("LED newValue() reached", pvName, pvValue);
				var canvas = document.getElementById('led');
				canvas.title =  window.parent.setWidgetToolTip(pvName, pvValue, pvTime, pv_settings_);

				var context = canvas.getContext('2d');
				context.fillStyle = 'green';
				if( pvSeverity == "MAJOR" )
					context.fillStyle = 'red';
				if( isNaN(pvValue) || pvSeverity == "INVALID" )
					context.fillStyle = 'grey';
				context.fill();
			}

			window.onresize = function() {
				for(var name in leds)
				{
					drawLed(labelContainers[name], name);
				}
			}

		</script>

</head>

	<body onload='Javascript:init();'>
		<div class="wrapper" id="display"></div>
	</body>

</html>
