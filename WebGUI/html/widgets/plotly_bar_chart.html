<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  	<head>
    	<meta http-equiv="content-type" content="text/html;charset=utf-8">
    	<title>Plotly chart</title>

		<style>

		    body {
			  font: 10px sans-serif;
			  background: rgba(255, 255, 255, 1);
			  margin: 0px !important;
			}

		</style>
			<script type="text/javascript" src="libraries/plotly-1.27.1.min.js"></script>
			//<script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<script>
			//functions:			
			//init()					

			var pv_settings_ = [];
			//var plot;

			/////////////////////////////////////////////////////////////////////////////////////////
			/////////////////////////////////////////////////////////////////////////////////////////

			//init called once body has loaded

			function init()
			{
				console.log("init()");
				console.log(window.frameElement.id);
				console.log("Dimensions: " + window.innerWidth + " : " + window.innerHeight);
				window.parent.setupWidget(window.frameElement.id, getParameters());
				window.parent.getHistory(window.frameElement.id, getParameters());
			}

			function setupPVs(settings)
			{
				console.log("setupPVs() : " , settings);
				pv_settings_ = settings;
			}

			function newWidget(widget, parameters)
			{
				drawGraph();
			}

			function getParameters()
			{
				parameters = {};

				return parameters;
			}

			var timeData = [];
			var valueData = [];
			var plotData = {};

			function newValue(pvName, pvValue, pvTime, pvStatus, pvSeverity)
			{
				var date = new Date(pvTime*1000);
				if (timeData.length)
					if (date <= timeData[timeData.length-1]) { console.log("return"); return;}

				timeData.push(date);
				valueData.push(pvValue);
				plotData["time"] = timeData;
				plotData["value"] = valueData;

				console.log("newValue() reached", pvName, pvValue);
				console.log(plotData);

				drawGraph(pvName, pvStatus, pvSeverity);
			}

			function drawGraph(pvName, pvStatus, pvSeverity)
			{
				var plot = document.getElementById("display");
			    Plotly.newPlot("display", [
			    { y: [],  type: 'scatter', mode: 'lines' }
			    ], {
			        title: pvName,
			        titlefont: { size: 12 },
			        xaxis: { title: 'time', 'titlefont': { size: 10 }, showticklabels: true },
			        yaxis: { title: 'amplitude', titlefont: { size: 10 }, zeroline: true }
					,margin: { l:45, r: 10, b: 60, t: 20 }
					,legend: {x: 0, y: 1}
	    		}, {responsive: true});

	    		Plotly.relayout(plot, { width: window.innerWidth, height: window.innerHeight });
				Plotly.addTraces(plot, [{ x: plotData.time, y: plotData.value, mode: 'lines', name: pvName }]);

				console.log("DrawGraph pv: " + pvName);
			}

			window.onresize = function() {
				//Plotly.Plots.resize(window.frameElement);
				Plotly.relayout(document.getElementById("display"),
				{
					width: window.innerWidth,
					height: window.innerHeight
				});
					console.log("window.onresize Plotly.relayout");
			};

		</script>

	</head>

	<body onload="Javascript:init()">
		<div id="display" width="100%" height="100%"></div>
	</body>

</html>
