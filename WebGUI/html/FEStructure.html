<!DOCTYPE HTML>
<html lang="en"> 
<head>
	<title>MU2E FRONT END STRUCTURE</title>

	<link href='/WebPath/css/fonts.css?family=Inconsolata:400' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" type="text/css" href="/WebPath/css/FEStructure.css">

	<script type="text/JavaScript" src="/WebPath/js/Globals.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/Debug.js"></script>	
	<script type="text/JavaScript" src="/WebPath/js/DesktopContent.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/SimpleContextMenu.js"></script>
	<script type="text/JavaScript" src="/WebPath/js/js_lib/ConfigurationAPI.js"></script>

	<script>		

		//	Description of Configuration-Subset Functionality/Behavior:
		//	
		//	GET parameters:
		//		<subsetBasePath> = Records at this path are the target of this GUI, e.g. “FEInterfaceConfiguration”
		//		<groupingFieldList> = CSV list of tree paths relative to <baseTable>, e.g. “LinkToFETypeConfiguration,FEInterfacePluginName”
		//									- these are the fields that can be used to filter UID records by (and these will cause grouping in square-view)	
		//		<editableFieldList> = empty string or "DEFAULT" for all, or CSV list of fields to show for editing
		//		<recordPreFilterList> = CSV list (of forced filter) of tree paths relative to <baseTable> and = value, e.g. "LinkToFETypeConfiguration=NIMPlus,FEInterfacePluginName=NIMPlusPlugin"
		//									- this is like a pre-filter (filter on records UID that user can not control)
		//		<recordsAlias> = Records display name, e.g. "Front-ends"


		//global vars for GET params
		var _subsetBasePath;
		var _groupingFieldList;
		var _editableFieldList;
		var _recordPreFilterList;
		var _recordsAlias;

		var _selectedGroupFieldValues;
		var _selectedGroupIDs;
		var _selectedRecords;

		//global vars for saving tables
		var _modifiedTables;

		///////////////////////////////////////////////////////////////////////////////////////
		///////////////////////////////////////////////////////////////////////////////////////

		//functions:
			//init()
			//extractGETParameters()
			//initSubsetGlobalData()
			//paintDtc()
			//paintRoc()


		///////////////////////////////////////////////////////////////////////////////////////
		///////////////////////////////////////////////////////////////////////////////////////


		//=====================================================================================
		//init ~~
		//	init called once body has loaded
		function init()
		{
			Debug.log("FEStructure init ");

			//extract get parameters
			if(!extractGETParameters())
			{
				Debug.log("Illegal GET parameters. Aborting.",
						Debug.HIGH_PRIORITY);
				return;
			}
			var windowTooltip = "Welcome to the FE Structure viewer. " + 
				". Here you can view the FE objects and their status.";
			DesktopContent.tooltip("FE Structure GUI Introduction",
			windowTooltip);
			DesktopContent.setWindowTooltip(windowTooltip);

			//get subset record uids and 
			//	filter values for all possible grouping fields
			initSubsetGlobalData();

		} //end init()


		//=====================================================================================
		//extractGETParameters ~~
		//	return false, if illegal params
		function extractGETParameters()
		{
			//extract get parameters (most optional)
			//		<subsetBasePath> 		= Records at this path are the target of this GUI, e.g. "FEInterfaceConfiguration"
			//		<groupingFieldList> 	= CSV list of tree paths relative to <baseTable>, e.g. "LinkToFETypeConfiguration,FEInterfacePluginName"
			//		<selectedGroupFieldValues>	= Pre-chosen selections for grouping field filters
			//		<editableFieldList> 	= empty string or "DEFAULT" for all, or CSV list of fields to show for editing
			//		<recordPreFilterList> 	= semicolon-separated list (of forced filter) of tree paths relative to <baseTable> and = value (CSV for multiple values), e.g. "LinkToFETypeConfiguration=NIMPlus;FEInterfacePluginName=NIMPlusPlugin,FEOtsUDPTemplateInterface"
			//		<selectedRecords> 		= CSV list of pre-chosen record UID selections (this will override default behavior of selecting the first record,.. if only one record is chosen, that record will be loaded) 
			//		<recordsAlias> 			= PLURAL Records display name, e.g. "Front-ends"
			
			_subsetBasePath		= DesktopContent.getParameter(0,"subsetBasePath");//"FEInterfaceConfiguration"; //DesktopContent.getParameter(0,"subsetBasePath");	
			_groupingFieldList 	= DesktopContent.getParameter(0,"groupingFieldList"); //"LinkToFETypeConfiguration,FEInterfacePluginName"; //DesktopContent.getParameter(0,"groupingFieldList");			
			_editableFieldList	= DesktopContent.getParameter(0,"editableFieldList");//"";//DesktopContent.getParameter(0,"editableFieldList");
			_recordPreFilterList= DesktopContent.getParameter(0,"recordPreFilterList"); //"";//FEInterfacePluginName=myNewInterface";//DesktopContent.getParameter(0,"recordPreFilterList");
			_recordsAlias		= DesktopContent.getParameter(0,"recordAlias"); //"Front-ends"; //default to records
			
			_selectedGroupFieldValues = DesktopContent.getParameter(0,"selectedGroupFieldValues"); //"ParameterGroupID=myNewInterfaceParameters,myNewInterfaceParameters;FEInterfacePluginName=myNewInterface""; 
			_selectedGroupIDs 	= DesktopContent.getParameter(0,"selectedGroupIDs"); //"ParameterGroupID=myNewInterfaceParameters,myNewInterfaceParameters;FEInterfacePluginName=myNewInterface""; 
			_selectedRecords	= DesktopContent.getParameter(0,"selectedRecords"); //"myNewInterface,myNewInterface2";
									
			
			if(!_subsetBasePath)
			{
				Debug.log("Missing required GET parameter 'subsetBasePath.'",
						Debug.HIGH_PRIORITY);
				return false;
			}
			if(!_groupingFieldList) _groupingFieldList = "";
			if(!_editableFieldList) _editableFieldList = "";
			if(!_recordPreFilterList) _recordPreFilterList = "";
			if(!_recordsAlias) _recordsAlias = "Records";
			
			if(!_selectedGroupFieldValues) _selectedGroupFieldValues = "";
			if(!_selectedGroupIDs) _selectedGroupIDs = "";
			if(!_selectedRecords) _selectedRecords = "";

			Debug.logv({_subsetBasePath});
			Debug.logv({_groupingFieldList});
			Debug.logv({_editableFieldList});
			Debug.logv({_recordPreFilterList});
			Debug.logv({_recordsAlias});

			Debug.logv({_selectedGroupFieldValues});
			Debug.logv({_selectedGroupIDs});
			Debug.logv({_selectedRecords});
			
			return true;
		}	//end extractGETParameters()

		function saveAllStatusChanges()
		{
			//proceed to save (quietly) tables, groups, aliases
			ConfigurationAPI.saveModifiedTables(_modifiedTables,
					function(savedTables, savedGroups, savedAliases)
					{
				if(!savedTables.length)
				{
					Debug.log("There was an error while saving the values.",
							Debug.HIGH_PRIORITY);
					return;					
				}
				
				Debug.log("The values for each field were successfully written to the targeted " +
						recordsAlias + " (target count = " + recordArr.length + ")!",
						Debug.INFO_PRIORITY);
				
				_modifiedTables = undefined; //clear after save
				
					}); //end saveModifiedTables handler
			
		} //end saveAllStatusChanges

		function setDTCStatus(dtcName, status)
		{
			Debug.log("setDTCStatus()", dtcName, status);

			var fields = ["Status"];
			var valueArr = [status]; 
			var recordArr = [dtcName];

			Debug.logv({recordArr});
			Debug.logv({valueArr});
			Debug.logv({fields});

			var subsetBasePath = "/DTCInterfaceTable";
			var recordsAlias = "DTC";
						
			ConfigurationAPI.setFieldValuesForRecords(
					subsetBasePath,
					recordArr, 	//recordArr
					fields, 	//fieldArr
					valueArr, 	//valueArr
					function(modifiedTables)
					{
				Debug.log("modifiedTables length " + modifiedTables.length);
								
				if(!modifiedTables.length)
				{
					Debug.log("There was an error while writing the values.",
							Debug.HIGH_PRIORITY);
					return;					
				}
									
				_modifiedTables = modifiedTables;
				
				// //proceed to save (quietly) tables, groups, aliases
				// ConfigurationAPI.saveModifiedTables(_modifiedTables,
				// 		function(savedTables, savedGroups, savedAliases)
				// 		{
				// 	if(!savedTables.length)
				// 	{
				// 		Debug.log("There was an error while saving the values.",
				// 				Debug.HIGH_PRIORITY);
				// 		return;					
				// 	}
					
				// 	Debug.log("The values for each field were successfully written to the targeted " +
				// 			recordsAlias + " (target count = " + recordArr.length + ")!",
				// 			Debug.INFO_PRIORITY);
					
				// 	_modifiedTables = undefined; //clear after save
					
				// 		}); //end saveModifiedTables handler
				
					}, //end setFieldValuesForRecords handler
					 _modifiedTables);	


		} //end setDTCStatus()

		function setROCStatus(rocName, status)
		{
			Debug.log("setROCStatus()", rocName, status);

			var fields = ["Status"];
			var valueArr = [status]; 
			var recordArr = [rocName];

			Debug.logv({recordArr});
			Debug.logv({valueArr});
			Debug.logv({fields});

			var subsetBasePath = "/ROCInterfaceTable";
			var recordsAlias = "ROC";
						
			ConfigurationAPI.setFieldValuesForRecords(
					subsetBasePath,
					recordArr, 	//recordArr
					fields, 	//fieldArr
					valueArr, 	//valueArr
					function(modifiedTables)
					{
				Debug.log("modifiedTables length " + modifiedTables.length);
								
				if(!modifiedTables.length)
				{
					Debug.log("There was an error while writing the values.",
							Debug.HIGH_PRIORITY);
					return;					
				}
									
				_modifiedTables = modifiedTables;
				
				// //proceed to save (quietly) tables, groups, aliases
				// ConfigurationAPI.saveModifiedTables(_modifiedTables,
				// 		function(savedTables, savedGroups, savedAliases)
				// 		{
				// 	if(!savedTables.length)
				// 	{
				// 		Debug.log("There was an error while saving the values.",
				// 				Debug.HIGH_PRIORITY);
				// 		return;					
				// 	}
					
				// 	Debug.log("The values for each field were successfully written to the targeted " +
				// 			recordsAlias + " (target count = " + recordArr.length + ")!",
				// 			Debug.INFO_PRIORITY);
					
				// 	_modifiedTables = undefined; //clear after save
					
				// 		}); //end saveModifiedTables handler
				
					}, //end setFieldValuesForRecords handler
					 _modifiedTables);	


		} //end setROCStatus()

		//=====================================================================================
		//checkForActiveGroupChange ~~
		function checkForActiveGroupChange(doInit)
		{
			//Debug.log("checkForActiveGroupChange() " + doInit);

			if(_checkActiveGroupsTimer)
			{
				window.clearTimeout(_checkActiveGroupsTimer);
				_checkActiveGroupsTimer = 0;
			}

			//get active table groups
			DesktopContent.XMLHttpRequest(
					"Request?RequestType=getActiveTableGroups",
					"", function (req) {

				if(_checkActiveGroupsTimer)
					window.clearTimeout(_checkActiveGroupsTimer);
				_checkActiveGroupsTimer = window.setTimeout(checkForActiveGroupChange,_CHECK_ACTIVE_GROUPS_PERIOD);

				if(!req) return; //ignore disconnected requests

				var activeConfigGroups = [
					DesktopContent.getXMLValue(req, "Context-ActiveGroupName"),
					DesktopContent.getXMLValue(req, "Context-ActiveGroupKey"),
					DesktopContent.getXMLValue(req, "Configuration-ActiveGroupName"),
					DesktopContent.getXMLValue(req, "Configuration-ActiveGroupKey")];

				//console.log("activeConfigGroups",activeConfigGroups);

				//check for changes
				if(doInit || _lastActiveGroups.length != activeConfigGroups.length)
				{
					if(!doInit && _lastActiveGroups.length) //treat as change
					{
						localHandleChange(activeConfigGroups);
						return;
					}
					else //treat as initializing active groups
						_lastActiveGroups = activeConfigGroups;					
				}

				for(var i=0;i<_lastActiveGroups.length && activeConfigGroups.length;++i)
				{
					if(_lastActiveGroups[i] != activeConfigGroups[i])
					{
						localHandleChange(activeConfigGroups);
						return;
					}
				}

			},
			0, 0, true,  //reqParam, progressHandler, callHandlerOnErr
			true /*doNotShowLoadingOverlay*/
			); //end of getActiveTableGroups handler

			return;

			//===========
			function localHandleChange(activeConfigGroups)
			{
				if(_checkActiveGroupsTimer)
				{
					window.clearTimeout(_checkActiveGroupsTimer);
					_checkActiveGroupsTimer = 0;
				}

				console.log("Change detected!... activeConfigGroups",activeConfigGroups,
						"_lastActiveGroups",_lastActiveGroups);

				DesktopContent.popUpVerification(
						"A configuration change was detected! " +
						"Do you want to <b>reload</b> the FE Structure Configuration GUI (any modifications in this window will be lost!)?",
						initSubsetGlobalData /*yes-to-reload handler*/
						,
						0,0,// val [optional], bgColor [optional], 
						0,0,0, //			textColor [optional], borderColor [optional], getUserInput [optional], 
						0, //			dialogWidth [optional], 
						function() /*cancelFunc [optional]*/
						{
							Debug.log("Canceled...");

							if(_checkActiveGroupsTimer)
								window.clearTimeout(_checkActiveGroupsTimer);
							_checkActiveGroupsTimer = window.setTimeout(checkForActiveGroupChange,_CHECK_ACTIVE_GROUPS_PERIOD);

						} //end cancelFunc handler
				);

				//save for next time
				_lastActiveGroups = activeConfigGroups;

			} //end localHandleChange()

		} //end checkForActiveGroupChange()


		//=====================================================================================
		//paintDtc ~~
		function paintDtc (dtci, dtciStatus)
		{
			var el = document.getElementById("mainDiv");
			var dtcDiv = document.createElement('div');
			dtcDiv.classList.add("dtcBlockContainer");
			dtcDiv.id = dtci;

			var dtcBox = document.createElement('button');
			dtcBox.classList.add("dtcBox");
			dtcBox.id = dtci + '-box';
			dtcBox.innerText = dtci;

			if (dtciStatus == '1')
				dtcBox.style.backgroundColor = 'green';
			else
				dtcBox.style.backgroundColor = 'red';

			dtcDiv.appendChild(dtcBox);
			el.appendChild(dtcDiv);
		}	//end paintDtc()


		//=====================================================================================
		//paintRoc ~~
		function paintRoc (dtci, roci, rociStatus)
		{
			var dtcDiv = document.getElementById(dtci);
			var rocBox = document.createElement('button');
			rocBox.classList.add("rocBox");
			rocBox.id = roci + '-' + dtci + '-box';
			rocBox.innerText = roci;

			if (rociStatus == '1')
				rocBox.style.backgroundColor = 'green';
			else
				rocBox.style.backgroundColor = 'red';

			dtcDiv.appendChild(rocBox);
		}	//end paintRoc()


		var FEstructure_;
		var _checkActiveGroupsTimer = 0;
		var _CHECK_ACTIVE_GROUPS_PERIOD = 5000; //ms
		var _lastActiveGroups = [];
		//=====================================================================================
		//initSubsetGlobalData ~~
		function initSubsetGlobalData()
		{
			if(_checkActiveGroupsTimer)
			{
				window.clearTimeout(_checkActiveGroupsTimer);
				_checkActiveGroupsTimer = 0;
			}

			ConfigurationAPI.getStructureStatus("DTCInterfaceTable",
				function(json)
				{
					Debug.logv({json});
					FEstructure_ = JSON.parse(json);
					Debug.logv({FEstructure_});
					for(var i=0; i<FEstructure_.dtcs.length; ++i)
					{
						var dtcName = FEstructure_.dtcs[i].name;
						var dtcStatus = FEstructure_.dtcs[i].enabled;
						paintDtc(dtcName, dtcStatus);

						for(var j=0; j<FEstructure_.dtcs[i].rocs.length; ++j)
						{
							paintRoc(dtcName, FEstructure_.dtcs[i].rocs[j].name, FEstructure_.dtcs[i].rocs[j].enabled);	
						}
					}

					checkForActiveGroupChange(true /*init*/); //force group update

					//return configuration change check
					if(_checkActiveGroupsTimer)
						window.clearTimeout(_checkActiveGroupsTimer);
					_checkActiveGroupsTimer = window.setTimeout(checkForActiveGroupChange,_CHECK_ACTIVE_GROUPS_PERIOD);
					
				}, //end DTC getSubsetRecords() handler
				_modifiedTables);
		}

		</script>
</head>

<body onload='//init() called by DesktopContent.js'>	

	<!-- body content populated by javascript paint(), etc. -->

	<button onclick="setROCStatus('trackerROC3',0)">Write Status For Selected</button>
	<div class='mainBlockContainer' id='mainDiv'></div>
</body>

</html>